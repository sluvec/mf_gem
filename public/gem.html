<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Demo - Portable Version</title>
    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Enhanced Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-message">
        <div class="loading-container">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h2 id="loading-title" class="loading-title">Loading...</h2>
            <p id="loading-message" class="loading-message">Please wait while we prepare your data</p>
            <div class="loading-progress">
                <div class="progress-track">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="progress-text">0%</div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Toast Container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-label="Notifications">
        <!-- Toasts will be dynamically added here -->
    </div>
    
    <header role="banner">
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="nav-left">
                <h1>
                    <button 
                        data-show-page="dashboard" 
                        aria-label="Go to dashboard - CRM Demo homepage"
                        class="logo-btn">
                        🏢 CRM Demo
                    </button>
                </h1>
                
                <!-- Mobile hamburger menu toggle -->
                <button 
                    id="mobile-menu-toggle" 
                    class="mobile-menu-toggle" 
                    aria-expanded="false"
                    aria-controls="main-navigation"
                    aria-label="Toggle main navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <ul id="main-navigation" class="nav-menu nav-grid" role="menubar" aria-label="Main menu">
                    <!-- Row 1: Core Navigation -->
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="dashboard" 
                            class="nav-btn active"
                            role="menuitem"
                            aria-pressed="true"
                            aria-describedby="dashboard-desc">
                            <span class="nav-icon">🏠</span>
                            Dashboard
                        </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="pcnumbers" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="pc-numbers-desc">
                            <span class="nav-icon">📋</span>
                                    PC Numbers
                                </button>
                            </li>
                    
                    <li role="none" class="nav-row-1">
                                <button 
                            data-show-page="activities" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="activities-desc">
                            <span class="nav-icon">📅</span>
                                    Activities
                                </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="quotes" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="quotes-desc">
                            <span class="nav-icon">📝</span>
                                    Quotes
                                </button>
                            </li>
                    
                    <li role="none" class="nav-row-1">
                                <button 
                            data-show-page="pricelists" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="pricelists-desc">
                            <span class="nav-icon">💷</span>
                                    Price Lists
                                </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="resources" 
                            class="nav-btn"
                            role="menuitem"
                            aria-describedby="resources-desc">
                            <span class="nav-icon">🛠️</span>
                            Resources
                        </button>
                    </li>
                </ul>
            </div>
                            <div class="nav-right">

                    

                    <button 
                        onclick="window.resetData()" 
                        class="nav-btn danger"
                        aria-label="Reset all demo data - this will delete all current data">
                        Reset Demo Data
                    </button>
                </div>
        </nav>
    </header>
    
    <!-- Screen reader descriptions for navigation items -->
    <div class="sr-only">
        <div id="dashboard-desc">Overview of key metrics and recent activity</div>
        <div id="pc-numbers-desc">Manage project codes and client information</div>
        <div id="quotes-desc">Create and manage quotes for projects</div>
        <div id="activities-desc">Schedule and track project activities</div>
        <div id="resources-desc">Manage equipment, materials and labor resources</div>
        <div id="pricelists-desc">Manage pricing and rate cards</div>
    </div>



    <main id="main-content" role="main" tabindex="-1">
        <div class="container">
            <div id="dashboard" class="page active">
            <h1>📊 Dashboard</h1>
            <p>Overview of key metrics in the demonstration system.</p>
            

            

            
            <div class="stats">
                <div class="stat-card clickable" data-show-page="pcnumbers">
                    <h3>PC Numbers</h3>
                    <div class="value" id="stat-pc">0</div>
                </div>
                <div class="stat-card clickable" data-show-page="quotes">
                    <h3>Quotes</h3>
                    <div class="value" id="stat-quotes">0</div>
                </div>
                <div class="stat-card clickable" data-show-page="activities">
                    <h3>Activities</h3>
                    <div class="value" id="stat-activities">0</div>
                </div>
                <div class="stat-card">
                    <h3>Quote Value</h3>
                    <div class="value" id="stat-value">£0</div>
                </div>
            </div>

             <div class="card">
                <h2>Recent PC Numbers</h2>
                <table>
                    <thead>
                        <tr><th>PC Number</th><th>Company</th><th>Reference</th></tr>
                    </thead>
                    <tbody id="recent-pc"></tbody>
                </table>
            </div>
        </div>

        <div id="pcnumbers" class="page">
            <h1>🔢 PC Numbers</h1>
            <button data-show-page="new-pc">+ New PC Number</button>
            <div class="card">
                <h2>PC Numbers List</h2>
                <table>
                    <thead><tr><th>PC Number</th><th>Company</th><th>Reference</th><th>Contact</th><th>Actions</th></tr></thead>
                    <tbody id="pc-list"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pc" class="page">
            <h1 id="pc-form-title">New PC Number</h1>
            
            <!-- Progressive Form Wizard -->
            <div class="form-wizard" id="pc-wizard">
                <input type="hidden" id="pc-id">
                
                <!-- Progress Header -->
                <div class="wizard-progress">
                    <h2>Create PC Number</h2>
                    <div class="progress-bar-container">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" id="wizard-progress-bar" style="width: 33%"></div>
                        </div>
                    </div>
                    <ol class="wizard-steps">
                        <li class="wizard-step active" id="step-1-indicator">
                            <div class="step-indicator">1</div>
                            <span class="step-label">Basic Info</span>
                        </li>
                        <li class="wizard-step" id="step-2-indicator">
                            <div class="step-indicator">2</div>
                            <span class="step-label">Client Details</span>
                        </li>
                        <li class="wizard-step" id="step-3-indicator">
                            <div class="step-indicator">3</div>
                            <span class="step-label">Contact Info</span>
                        </li>
                    </ol>
                </div>
                
                <!-- Wizard Content -->
                <div class="wizard-content">
                    <!-- Step 1: Basic Information -->
                    <div class="step-panel active" id="step-1" data-step="1">
                        <div class="step-header">
                            <h3 class="step-title">Let's start with basic project information</h3>
                            <p class="step-description">
                                This information helps us organize and track your project effectively.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-number">
                                    PC Number 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-number" 
                                    class="wizard-field-input"
                                    placeholder="PC-000001"
                                    pattern="^PC-\d{6}$"
                                    required
                                    data-validate="pc-number">
                                <div class="field-help">Format: PC- followed by 6 digits (e.g., PC-000001)</div>
                                <div class="field-error" id="pc-number-error" hidden></div>
                                <div class="field-success" id="pc-number-success" hidden>✓ Valid PC Number format</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-company-name">
                                    Company Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-company-name" 
                                    class="wizard-field-input"
                                    placeholder="Enter company name"
                                    required
                                    data-validate="required">
                                <div class="field-help">The official company name for this project</div>
                                <div class="field-error" id="pc-company-name-error" hidden></div>
                                <div class="field-success" id="pc-company-name-success" hidden>✓ Company name entered</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-project-name">
                                    Project Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-project-name" 
                                    class="wizard-field-input"
                                    placeholder="Enter project name"
                                    required
                                    data-validate="required">
                                <div class="field-help">A descriptive name for the project</div>
                                <div class="field-error" id="pc-project-name-error" hidden></div>
                                <div class="field-success" id="pc-project-name-success" hidden>✓ Project name entered</div>
                            </div>
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    💾 Save Draft
                                </button>
                                <div class="draft-indicator" id="draft-status" hidden>
                                    ⏳ Saving draft...
                                </div>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="cancelWizard()">
                                    Cancel
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-1-next" onclick="nextWizardStep()" disabled>
                                    Next: Client Details →
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Client Details -->
                    <div class="step-panel" id="step-2" data-step="2">
                        <div class="step-header">
                            <h3 class="step-title">Tell us about your client</h3>
                            <p class="step-description">
                                Client information helps us provide better service and track project sources.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-account-manager">
                                    Account Manager 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-account-manager" 
                                    class="wizard-field-input"
                                    placeholder="Account manager name"
                                    required
                                    data-validate="required">
                                <div class="field-help">Person responsible for this account</div>
                                <div class="field-error" id="pc-account-manager-error" hidden></div>
                                <div class="field-success" id="pc-account-manager-success" hidden>✓ Account manager assigned</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-client-industry">
                                    Client Industry 
                                    <span class="field-required">*</span>
                                </label>
                                <select 
                                    id="pc-client-industry" 
                                    class="wizard-field-input"
                                    required
                                    data-validate="required">
                                    <option value="">Select industry...</option>
                                    <option value="Media">Media</option>
                                    <option value="Education">Education</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Government">Government</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="field-help">Primary industry sector of the client</div>
                                <div class="field-error" id="pc-client-industry-error" hidden></div>
                                <div class="field-success" id="pc-client-industry-success" hidden>✓ Industry selected</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-client-source">
                                    Client Source 
                                    <span class="field-required">*</span>
                                </label>
                                <select 
                                    id="pc-client-source" 
                                    class="wizard-field-input"
                                    required
                                    data-validate="required">
                                    <option value="">Select source...</option>
                                    <option value="Web Enquiry">Web Enquiry</option>
                                    <option value="Business Development">Business Development</option>
                                    <option value="Existing Customer">Existing Customer</option>
                                    <option value="Cross Referral">Cross Referral</option>
                                    <option value="Internal (CWS/Crown)">Internal (CWS/Crown)</option>
                                </select>
                                <div class="field-help">How did this client find us?</div>
                                <div class="field-error" id="pc-client-source-error" hidden></div>
                                <div class="field-success" id="pc-client-source-success" hidden>✓ Source recorded</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-quote-limit">
                                    Quote Limit
                                </label>
                                <input 
                                    type="number" 
                                    id="pc-quote-limit" 
                                    class="wizard-field-input"
                                    min="1" 
                                    max="20" 
                                    value="5"
                                    placeholder="5"
                                    data-validate="number">
                                <div class="field-help">Maximum number of quotes for this project (1-20)</div>
                                <div class="field-error" id="pc-quote-limit-error" hidden></div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-status">
                                    Project Status
                                </label>
                                <select id="pc-status" class="wizard-field-input">
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <div class="field-help">Current status of the project</div>
                            </div>
                        </div>
                        
                        <div class="wizard-field-group">
                            <label class="wizard-field-label" for="pc-project-description">
                                Project Description
                            </label>
                            <textarea 
                                id="pc-project-description" 
                                class="wizard-field-input"
                                rows="4" 
                                placeholder="Detailed project description..."
                                style="resize: vertical; min-height: 120px;"></textarea>
                            <div class="field-help">Detailed description of the project requirements and scope</div>
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    💾 Save Draft
                                </button>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">
                                    ← Back
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-2-next" onclick="nextWizardStep()" disabled>
                                    Next: Contact Info →
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Contact Information -->
                    <div class="step-panel" id="step-3" data-step="3">
                        <div class="step-header">
                            <h3 class="step-title">Primary contact information</h3>
                            <p class="step-description">
                                We need at least a contact name and either phone or email to reach your client.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-name">
                                    Contact Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-contact-name" 
                                    class="wizard-field-input"
                                    placeholder="Primary contact person"
                                    required
                                    data-validate="required">
                                <div class="field-help">Name of the main contact person for this project</div>
                                <div class="field-error" id="pc-contact-name-error" hidden></div>
                                <div class="field-success" id="pc-contact-name-success" hidden>✓ Contact name entered</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-phone">
                                    Phone Number
                                </label>
                                <input 
                                    type="tel" 
                                    id="pc-contact-phone" 
                                    class="wizard-field-input"
                                    placeholder="Phone number"
                                    data-validate="phone">
                                <div class="field-help">Contact phone number (mobile or landline)</div>
                                <div class="field-error" id="pc-contact-phone-error" hidden></div>
                                <div class="field-success" id="pc-contact-phone-success" hidden>✓ Valid phone number</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-email">
                                    Email Address
                                </label>
                                <input 
                                    type="email" 
                                    id="pc-contact-email" 
                                    class="wizard-field-input"
                                    placeholder="email@address.com"
                                    data-validate="email">
                                <div class="field-help">Contact email address</div>
                                <div class="field-error" id="pc-contact-email-error" hidden></div>
                                <div class="field-success" id="pc-contact-email-success" hidden>✓ Valid email address</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-postcode">
                                    Postcode
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-postcode" 
                                    class="wizard-field-input"
                                    placeholder="e.g. SW1A 1AA"
                                    data-validate="postcode">
                                <div class="field-help">UK postcode (optional)</div>
                                <div class="field-error" id="pc-postcode-error" hidden></div>
                                <div class="field-success" id="pc-postcode-success" hidden>✓ Valid postcode</div>
                            </div>
                        </div>
                        
                        <div class="field-note" style="margin-top: var(--space-4); padding: var(--space-3); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-md);">
                            📞 <strong>Contact Requirement:</strong> Please provide at least phone OR email for the contact person.
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    💾 Save Draft
                                </button>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">
                                    ← Back
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-3-save" onclick="saveWizardPC()" disabled>
                                    ✓ Create PC Number
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pc-detail" class="page">
            <h1 id="pc-detail-title">PC Details</h1>
            
            <!-- Main Data -->
            <div class="card">
                <h2>Main Project Data</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>PC Number:</strong> <span id="pc-detail-number"></span></div>
                    <div><strong>Company Name:</strong> <span id="pc-detail-company-name"></span></div>
                    <div><strong>Project Name:</strong> <span id="pc-detail-project-name"></span></div>
                    <div><strong>Account Manager:</strong> <span id="pc-detail-account-manager"></span></div>
                    <div><strong>Client Industry:</strong> <span id="pc-detail-client-industry"></span></div>
                    <div><strong>Client Source:</strong> <span id="pc-detail-client-source"></span></div>
                    <div><strong>Quote Limit:</strong> <span id="pc-detail-quote-limit"></span></div>
                    <div><strong>Status:</strong> <span id="pc-detail-status"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Project Description:</strong><br>
                    <span id="pc-detail-project-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editPC(db.currentPC.id)" class="warning">Edit</button>
                    <button onclick="window.createQuote()">Create Quote</button>
                    <button onclick="window.showActivityModal()">Add Activity</button>
                    <button data-show-page="pcnumbers" class="secondary">Back to list</button>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="card">
                <h2>Primary Contact</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Contact Name:</strong> <span id="pc-detail-contact-name"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-contact-phone"></span></div>
                    <div><strong>Email:</strong> <span id="pc-detail-contact-email"></span></div>
                    <div><strong>Postcode:</strong> <span id="pc-detail-postcode"></span></div>
                </div>
                <p class="field-note">Note: Detailed addresses are now managed in individual quotes.</p>
            </div>
            <div class="card">
                <h2>Related Quotes</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>Title</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-quotes"></tbody>
                </table>
            </div>
            <div class="card">
                <h2>Related Activities</h2>
                <table>
                     <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-activities"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quotes" class="page">
            <h1>💰 Quotes</h1>
            <button onclick="window.showNewQuoteModal()">+ New Quote</button>
            <div class="card">
                <h2>Quote List</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>PC Number</th><th>Company</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="quotes-list"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quote-builder" class="page">
            <h1 id="quote-builder-title">New Quote</h1>
            <div class="card" id="price-list-selector">
                <h2>Step 1: Select Price List</h2>
                <label>Available Price Lists *</label>
                <select id="quote-price-list" onchange="window.handlePriceListChange()"></select>
            </div>
            <div class="quote-builder" id="quote-items-section" style="display: none;">
                <div class="card">
                    <h2>Step 2: Build Quote</h2>
                    
                    <!-- NEW Sprint 3: Enhanced Resource Lookup -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">🚀 Enhanced Resource Lookup</h4>
                                <p style="margin: 0; color: #666; font-size: 0.875rem;">Search, filter, and add multiple resources quickly</p>
                            </div>
                            <button onclick="window.showEnhancedResourceModal()" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; font-weight: bold;">
                                🔍 Search & Add Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW Sprint 3.2: Bulk Operations Panel -->
                    <div id="bulk-operations-panel" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">🔧 Bulk Operations</h4>
                                <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
                                    <span id="bulk-selected-count">0</span> line items selected
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="window.bulkUpdateQuantity()" style="background: #3b82f6; color: white;">📊 Update Quantities</button>
                                <button onclick="window.bulkApplyDiscount()" style="background: #10b981; color: white;">💰 Apply Discount</button>
                                <button onclick="window.bulkDeleteItems()" style="background: #ef4444; color: white;">🗑️ Delete Selected</button>
                                <button onclick="window.clearBulkSelection()" class="secondary">Clear Selection</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Category Sections -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Human Resources</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('human')" id="select-all-human"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-human"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('human')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('human')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Vehicles</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('vehicles')" id="select-all-vehicles"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-vehicles"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('vehicles')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('vehicles')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Materials</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('materials')" id="select-all-materials"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-materials"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('materials')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('materials')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                     <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Other</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('other')" id="select-all-other"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-other"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('other')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('other')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                </div>
                <div class="summary">
                    <h3>Quote Summary</h3>
                    <div class="summary-line"><span>Human Resources:</span><span id="sum-human">£0.00</span></div>
                    <div class="summary-line"><span>Vehicles:</span><span id="sum-vehicles">£0.00</span></div>
                    <div class="summary-line"><span>Materials:</span><span id="sum-materials">£0.00</span></div>
                    <div class="summary-line"><span>Other:</span><span id="sum-other">£0.00</span></div>
                    <div class="summary-line"><span>Net Total:</span><span id="sum-subtotal">£0.00</span></div>
                    <div class="summary-line">
                        <span>VAT Rate:</span>
                        <input type="number" id="quote-vat-rate" value="20.00" step="0.01" min="0" max="100" 
                               style="width: 60px; margin: 0; padding: 0.25rem;" onchange="window.calculateTotal()">%
                    </div>
                    <div class="summary-line"><span>VAT Amount:</span><span id="sum-vat">£0.00</span></div>
                    <div class="summary-total"><span>Total (inc VAT):</span><span id="sum-total">£0.00</span></div>
                    
                    <!-- NEW: Move Type & Addresses Section -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">📦 Move Type & Addresses</h3>
                        
                        <!-- Move Type Selection -->
                        <div style="margin-bottom: 1rem;">
                            <label>Move Type *</label>
                            <select id="quote-move-type" onchange="window.toggleAddressSections()" required>
                                <option value="">Select move type...</option>
                                <option value="Collection Only">Collection Only</option>
                                <option value="Delivery Only">Delivery Only</option>
                                <option value="Collection + Delivery">Collection + Delivery</option>
                            </select>
                        </div>
                        
                        <!-- Collection Address Section -->
                        <div id="collection-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">📍 Collection Address</h4>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-collection-name" placeholder="Contact person" required></div>
                                <div><label>Phone</label><input type="tel" id="quote-collection-phone" placeholder="Phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-collection-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-collection-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-collection-address1" placeholder="Street address" required></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-collection-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-collection-city" placeholder="City" required></div>
                                <div><label>County</label><input type="text" id="quote-collection-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-collection-postcode" placeholder="Postcode" required pattern="[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}" title="Please enter a valid UK postcode (e.g., SW1A 1AA)"></div>
                            </div>
                        </div>
                        
                        <!-- Delivery Address Section -->
                        <div id="delivery-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">🚚 Delivery Address</h4>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quote-same-address" onchange="window.copyCollectionToDelivery()" style="margin-right: 0.5rem;">
                                    Same as collection address
                                </label>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-delivery-name" placeholder="Contact person" required></div>
                                <div><label>Phone</label><input type="tel" id="quote-delivery-phone" placeholder="Phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-delivery-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-delivery-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-delivery-address1" placeholder="Street address" required></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-delivery-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-delivery-city" placeholder="City" required></div>
                                <div><label>County</label><input type="text" id="quote-delivery-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-delivery-postcode" placeholder="Postcode" required pattern="[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}" title="Please enter a valid UK postcode (e.g., SW1A 1AA)"></div>
                            </div>
                        </div>
                        
                        <!-- Quoted Activities Section -->
                        <div style="margin-bottom: 1rem;">
                            <label>Quoted Activities (optional)</label>
                            <div id="quote-activities-multiselect" style="border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.375rem; max-height: 120px; overflow-y: auto; background: white;">
                                <p style="margin: 0; color: #666; font-style: italic;">Loading activities for this PC...</p>
                            </div>
                            <p class="field-note">Select activities that are included in this quote pricing</p>
                        </div>
                    </div>
                    
                    <!-- Additional Quote Fields -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Status *</label>
                            <select id="quote-status" onchange="window.handleQuoteStatusChange()" required>
                                <option value="DRAFT">DRAFT - Work in progress (editable)</option>
                                <option value="ISSUED">ISSUED - Sent to client (not editable)</option>
                                <option value="WON">WON - Quote accepted by client</option>
                                <option value="LOST">LOST - Quote lost to competitor</option>
                            </select>
                            <p class="field-note">Note: Once ISSUED, quote cannot be edited. WON/LOST are final states.</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Valid Until *</label>
                            <input type="date" id="quote-valid-until" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Title *</label>
                            <input type="text" id="quote-title" placeholder="Brief quote description" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Description</label>
                            <textarea id="quote-description" rows="2" placeholder="Detailed quote description..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Internal Notes</label>
                            <textarea id="quote-notes" rows="2" placeholder="Internal notes (not visible to client)..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Terms & Conditions</label>
                            <textarea id="quote-terms" rows="3" placeholder="Payment terms, delivery conditions, etc...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="text-align: center;">
                        <button onclick="window.saveQuote()">Save Quote</button>
                        <button onclick="window.saveQuoteAsTemplate()" style="background: #8b5cf6; color: white;">📄 Save as Template</button>
                        <button onclick="window.duplicateCurrentQuote()" style="background: #06b6d4; color: white;">📋 Duplicate Quote</button>
                        <button onclick="window.cancelQuote()" class="secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>





        <div id="activities" class="page">
            <h1>📋 Activities</h1>
            
            <!-- NEW Sprint 4.2: View Toggle and Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="window.showActivityModal()" style="background: #3b82f6; color: white;">+ New Activity</button>
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="activities-list-view-btn" onclick="window.switchActivitiesView('list')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            📋 List View
                        </button>
                        <button id="activities-calendar-view-btn" onclick="window.switchActivitiesView('calendar')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            📅 Calendar View
                        </button>
                        <button id="activities-workflow-view-btn" onclick="window.switchActivitiesView('workflow')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            🔗 Workflow
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Navigation (hidden by default) -->
                <div id="calendar-navigation" style="display: none; align-items: center; gap: 1rem;">
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="calendar-month-btn" onclick="window.setCalendarView('month')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            Month
                        </button>
                        <button id="calendar-week-btn" onclick="window.setCalendarView('week')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            Week
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.navigateCalendar('prev')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">‹</button>
                        <span id="calendar-title" style="min-width: 200px; text-align: center; font-weight: 500;">October 2024</span>
                        <button onclick="window.navigateCalendar('next')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">›</button>
                        <button onclick="window.navigateCalendar('today')" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white;">Today</button>
                    </div>
                </div>
            </div>
            
            <!-- List View (default) -->
            <div id="activities-list-view" class="card">
                <h2>Activity List</h2>
                <table>
                    <thead><tr><th>Title</th><th>PC Number</th><th>Company</th><th>Type</th><th>Scheduled</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="activities-list"></tbody>
                </table>
            </div>
            
            <!-- NEW Sprint 4.2: Calendar View -->
            <div id="activities-calendar-view" style="display: none;">
                <!-- NEW Sprint 4.2.3: Team Filter Bar -->
                <div class="team-filter-bar">
                    <div style="font-weight: 600; color: #374151; margin-right: 0.5rem;">Filter by Team:</div>
                    <div id="team-filter-chips">
                        <!-- Team member chips will be generated here -->
                    </div>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.toggleWorkloadPanel()" 
                                style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            📊 Workload View
                        </button>
                        <button onclick="window.showTeamManagement()" 
                                style="background: #3b82f6; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            👥 Manage Team
                        </button>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Workload Panel -->
                <div id="workload-panel" class="workload-panel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Team Workload Distribution</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="font-size: 0.875rem; color: #6b7280;">Week of: </span>
                            <span id="workload-week-display" style="font-weight: 500;"></span>
                        </div>
                    </div>
                    <div id="workload-summary" class="workload-summary">
                        <!-- Workload cards will be generated here -->
                    </div>
                </div>
                
                <!-- Month View Calendar -->
                <div id="calendar-month-view" class="card">
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Calendar grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Week View Calendar -->
                <div id="calendar-week-view" class="card" style="display: none;">
                    <div style="display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Week view grid will be generated by JavaScript -->
                        <div style="background: white; padding: 0.5rem; font-weight: 500;"></div>
                        <!-- Time slots and days -->
                        <div id="week-grid-content">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Activity Details Sidebar (for calendar view) -->
                <div id="calendar-activity-sidebar" style="display: none; position: fixed; right: 20px; top: 20px; width: 300px; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">Activity Details</h3>
                        <button onclick="window.closeCalendarSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <div id="calendar-activity-content">
                        <!-- Activity details will be populated here -->
                    </div>
                </div>

                <!-- NEW Sprint 4.2.2: Quick Create Activity Overlay -->
                <div id="quick-create-overlay" class="quick-create-overlay">
                    <div class="quick-create-form">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Quick Create Activity</h3>
                            <button onclick="window.closeQuickCreate()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div id="quick-create-time-info" class="time-slot-info">
                            <!-- Time slot info will be populated here -->
                        </div>

                        <form id="quick-create-form" onsubmit="window.submitQuickCreate(event)">
                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Activity Title *</label>
                                <input type="text" id="quick-activity-title" name="title" required 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-pc" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">PC Number</label>
                                <select id="quick-activity-pc" name="pc_id" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Select PC Number</option>
                                    <!-- PC options will be populated -->
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-assignee" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Assign To</label>
                                <select id="quick-activity-assignee" name="assigned_to" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Unassigned</option>
                                    <!-- Team members will be populated -->
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div>
                                    <label for="quick-activity-priority" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                                    <select id="quick-activity-priority" name="priority" 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-activity-duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Duration (hrs)</label>
                                    <input type="number" id="quick-activity-duration" name="estimated_hours" min="0.25" step="0.25" value="1"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label for="quick-activity-description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="quick-activity-description" name="description" rows="3"
                                          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;"></textarea>
                            </div>

                            <!-- NEW Sprint 4.2.4: Recurring Activities Section -->
                            <div class="recurring-section">
                                <div class="recurring-toggle">
                                    <input type="checkbox" id="quick-recurring-enabled" name="recurring_enabled" onchange="window.toggleRecurringOptions(this)">
                                    <label for="quick-recurring-enabled" style="font-weight: 500; color: #374151;">🔄 Make this a recurring activity</label>
                                </div>
                                
                                <div id="quick-recurring-options" class="recurring-options">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Repeat</label>
                                        <select id="quick-recurring-frequency" name="recurring_frequency" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Every</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="number" id="quick-recurring-interval" name="recurring_interval" min="1" max="365" value="1" 
                                                   style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <span id="quick-recurring-unit" style="font-size: 0.875rem; color: #6b7280;">week(s)</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">End Date</label>
                                        <input type="date" id="quick-recurring-end-date" name="recurring_end_date" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Or Max Occurrences</label>
                                        <input type="number" id="quick-recurring-count" name="recurring_count" min="1" max="365" placeholder="e.g., 10" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                </div>
                                
                                <div id="quick-recurring-preview" class="recurring-preview" style="display: none;">
                                    <!-- Preview will be generated here -->
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button type="button" onclick="window.closeQuickCreate()" 
                                        style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Create Activity
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Team Management Modal -->
                <div id="team-management-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">👥 Team Management</h3>
                            <button onclick="window.closeTeamManagement()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <!-- Add New Team Member Form -->
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Add Team Member</h4>
                            <form id="add-team-member-form" onsubmit="window.addTeamMember(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role</label>
                                        <input type="text" name="role" placeholder="e.g., Engineer, Manager" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                        <input type="email" name="email" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max Hours/Week</label>
                                        <input type="number" name="max_hours" min="1" max="60" value="40" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <button type="submit" 
                                        style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    ➕ Add Member
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Team Members -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Current Team</h4>
                            <div id="team-members-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Team members will be listed here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="window.closeTeamManagement()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.4: Recurring Activity Edit Modal -->
                <div id="recurring-edit-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 450px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">🔄 Edit Recurring Activity</h3>
                            <button onclick="window.closeRecurringEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                                <strong>⚠️ This is part of a recurring series.</strong><br>
                                Choose how you want to apply your changes:
                            </p>
                        </div>
                        
                        <div id="recurring-edit-options" class="recurring-series-buttons" style="margin-bottom: 1.5rem;">
                            <button onclick="window.editRecurringActivity('single')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📝 Edit Only This Activity
                            </button>
                            <button onclick="window.editRecurringActivity('future')" 
                                    style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📅 Edit This & Future Activities
                            </button>
                            <button onclick="window.editRecurringActivity('all')" 
                                    style="background: #10b981; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                🔄 Edit Entire Series
                            </button>
                        </div>
                        
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 0.875rem; font-weight: 600;">Activity Details:</h4>
                            <div id="recurring-activity-details" style="font-size: 0.875rem; color: #0c4a6e;">
                                <!-- Activity details will be populated here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button onclick="window.closeRecurringEditModal()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="window.deleteRecurringSeries()" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                🗑️ Delete Series
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW Sprint 4.4: Workflow View -->
            <div id="activities-workflow-view" style="display: none;">
                <!-- Workflow Stats Dashboard -->
                <div class="workflow-stats">
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-total-activities">0</div>
                        <div class="workflow-stat-label">Total Activities</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-in-progress">0</div>
                        <div class="workflow-stat-label">In Progress</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-completed">0</div>
                        <div class="workflow-stat-label">Completed</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-blocked">0</div>
                        <div class="workflow-stat-label">Blocked</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-critical-path">0</div>
                        <div class="workflow-stat-label">Critical Path Days</div>
                    </div>
                </div>

                <!-- Workflow Canvas -->
                <div class="workflow-panel">
                    <div class="workflow-header">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">🔗 Activity Dependencies & Workflow</h2>
                        <div class="workflow-toolbar">
                            <div class="workflow-mode-toggle">
                                <button class="workflow-mode-btn active" onclick="window.setWorkflowMode('view')">👁️ View</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('edit')">✏️ Edit</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('connect')">🔗 Connect</button>
                            </div>
                            <button class="workflow-action-btn" onclick="window.autoLayoutWorkflow()">🔄 Auto Layout</button>
                            <button class="workflow-action-btn" onclick="window.calculateCriticalPath()">🚨 Critical Path</button>
                            <button class="workflow-action-btn primary" onclick="window.optimizeWorkflow()">⚡ Optimize</button>
                        </div>
                    </div>
                    
                    <div id="workflow-canvas" class="workflow-canvas">
                        <!-- Workflow nodes and connections will be generated here -->
                        <svg id="workflow-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                                </marker>
                            </defs>
                        </svg>
                        
                        <div id="workflow-nodes-container">
                            <!-- Workflow nodes will be positioned here -->
                        </div>
                        
                        <!-- Workflow minimap -->
                        <div class="workflow-minimap">
                            <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; font-weight: 600; background: #f8fafc;">
                                Workflow Overview
                            </div>
                            <div id="workflow-minimap-content" style="padding: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                <!-- Minimap content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Legend -->
                <div class="workflow-legend">
                    <div class="legend-item">
                        <div class="legend-indicator pending"></div>
                        <span>Pending</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator in-progress"></div>
                        <span>In Progress</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator completed"></div>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator blocked"></div>
                        <span>Blocked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator critical"></div>
                        <span>Critical Path</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="resources" class="page">
            <h1>🔧 Resources</h1>
            <button onclick="window.showResourceModal()">+ New Resource</button>
            <div class="card">
                <h2>Resource Database</h2>
                <table>
                    <thead><tr><th>Name</th><th>SKU</th><th>Category</th><th>Net Cost</th><th>Supplier</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="resources-list"></tbody>
                </table>
            </div>
        </div>

        <div id="pricelists" class="page">
             <h1>🏷️ Price Lists</h1>
            <button data-show-page="new-pricelist">+ New Price List</button>
            <div class="card">
                <h2>Available Price Lists</h2>
                <table>
                    <thead><tr><th>Name</th><th>Version</th><th>Currency</th><th>Effective Period</th><th>Default</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pricelist" class="page">
            <h1 id="pricelist-form-title">New Price List</h1>
            <div class="card">
                <input type="hidden" id="pricelist-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div><label>Price List Name *</label><input type="text" id="pricelist-name" placeholder="e.g. Standard Commercial Rates 2024" required></div>
                        <div><label>Version *</label><input type="text" id="pricelist-version" placeholder="e.g. v2.1" required></div>
                        <div><label>Currency</label><select id="pricelist-currency">
                            <option value="GBP" selected>GBP (£)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select></div>
                        <div><label>Status</label><select id="pricelist-status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                        </select></div>
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="pricelist-description" rows="2" placeholder="Brief description of this price list..."></textarea>
                    </div>
                </div>
                
                <!-- Pricing Configuration -->
                <div class="form-section">
                    <h3>Pricing Configuration</h3>
                    <div class="form-grid">
                        <div><label>Default Markup (%) *</label><input type="number" id="pricelist-markup" step="0.01" min="0" placeholder="35.00" required></div>
                        <div><label>Discount (%)</label><input type="number" id="pricelist-discount" step="0.01" min="0" max="100" placeholder="0.00"></div>
                        <div><label>Effective From *</label><input type="date" id="pricelist-effective-from" required></div>
                        <div><label>Effective Until</label><input type="date" id="pricelist-effective-to"></div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="pricelist-is-default" style="margin-right: 0.5rem;">
                            Set as default price list
                        </label>
                    </div>
                </div>
                
                <!-- Terms & Conditions -->
                <div class="form-section">
                    <h3>Terms & Conditions</h3>
                    <div>
                        <label>Default Terms</label>
                        <textarea id="pricelist-terms" rows="3" placeholder="Pricing terms, payment conditions, delivery notes...">Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.</textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="window.createPriceList()">Create Price List</button>
                    <button data-show-page="pricelists" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="pricelist-detail" class="page">
            <h1 id="pricelist-title">Price List Details</h1>
             <div class="card">
                <button onclick="window.showAddResourceToPriceList()">+ Add Item to Price List</button>
                <button data-show-page="pricelists" class="secondary">Back to list</button>
            </div>
            <div class="card">
                <h2>Price List Items</h2>
                <table>
                    <thead><tr><th>Resource</th><th>Net Cost</th><th>Client Price</th><th>Margin %</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-items"></tbody>
                </table>
            </div>
        </div>








    </main>

    <div id="quote-modal" class="modal"><div class="modal-content">
        <h2>Select PC Number for new quote</h2>
        <label>PC Number *</label>
        <select id="quote-modal-pc"></select>
        <div class="form-actions">
            <button onclick="window.proceedToQuoteBuilder()">Continue</button>
            <button onclick="window.closeQuoteModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- PC Number Edit Modal -->
    <div id="pc-edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="pc-edit-modal-title">Edit PC Number</h2>
            <form id="pc-edit-form">
                <input type="hidden" id="pc-edit-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div>
                            <label>PC Number *</label>
                            <input type="text" id="pc-edit-number" required 
                                   placeholder="PC-000001" pattern="^PC-\d{6}$">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="pc-edit-status">
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Company & Project -->
                <div class="form-section">
                    <h3>Company & Project</h3>
                    <div>
                        <label>Company Name *</label>
                        <input type="text" id="pc-edit-company" required placeholder="Company name">
                    </div>
                    <div>
                        <label>Project Title *</label>
                        <input type="text" id="pc-edit-title" required placeholder="Project title">
                    </div>
                    <div>
                        <label>Project Description *</label>
                        <textarea id="pc-edit-description" rows="3" required 
                                  placeholder="Brief description of the project..."></textarea>
                    </div>
                    <div>
                        <label>Reference</label>
                        <input type="text" id="pc-edit-reference" placeholder="Project reference">
                    </div>
                </div>

                <!-- Contact & Value -->
                <div class="form-section">
                    <h3>Contact & Value</h3>
                    <div class="form-grid">
                        <div>
                            <label>Contact Name</label>
                            <input type="text" id="pc-edit-contact" placeholder="Contact person">
                        </div>
                        <div>
                            <label>Estimated Value (£)</label>
                            <input type="number" id="pc-edit-value" min="0" step="0.01" 
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="primary">Update PC Number</button>
                    <button type="button" onclick="window.closePcEditModal()" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="activity-modal" class="modal"><div class="modal-content">
        <h2 id="activity-modal-title">New Activity</h2>
        <input type="hidden" id="activity-id">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <h3>Basic Information</h3>
        <div class="form-grid">
                <div><label>PC Number *</label><select id="activity-pc-select"></select></div>
                <div><label>Activity Type *</label><input type="text" id="activity-type" placeholder="e.g. Survey, Delivery, Installation" required></div>
                <div><label>Priority</label><select id="activity-priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select></div>
                <div><label>Status</label><select id="activity-status">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select></div>
        </div>
            <div>
                <label>Activity Title *</label>
                <input type="text" id="activity-title" placeholder="Brief description of the activity" required>
            </div>
            <div>
                <label>Description</label>
                <textarea id="activity-description" rows="2" placeholder="Detailed activity description..."></textarea>
            </div>
        </div>
        
        <!-- Scheduling Section -->
        <div class="form-section">
            <h3>Scheduling</h3>
            <div class="form-grid">
                <div><label>Scheduled Date</label><input type="date" id="activity-scheduled-date"></div>
                <div><label>Scheduled Time</label><input type="time" id="activity-scheduled-time"></div>
                <div><label>Duration (hours)</label><input type="number" id="activity-duration" step="0.5" min="0" placeholder="e.g. 2.5"></div>
                <div><label>Assigned To</label><input type="text" id="activity-assigned-to-name" placeholder="Person responsible"></div>
            </div>
        </div>
        
        <!-- Location & Contact Section -->
        <div class="form-section">
            <h3>Location & Contact</h3>
            <div class="form-grid">
                <div><label>Location</label><input type="text" id="activity-location" placeholder="e.g. Client Site - Birmingham"></div>
                <div><label>Contact Name</label><input type="text" id="activity-contact-name" placeholder="Site contact person"></div>
                <div><label>Contact Phone</label><input type="tel" id="activity-contact-phone" placeholder="Contact phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
            </div>
        </div>
        
        <!-- Completion Section (shown only for completed activities) -->
        <div class="form-section" id="activity-completion-section" style="display: none;">
            <h3>Completion Details</h3>
            <div>
                <label>Completion Notes</label>
                <textarea id="activity-completion-notes" rows="3" placeholder="Notes about the completed activity..."></textarea>
            </div>
        </div>
        
        <!-- NEW Sprint 4.3: Resource Allocation Section -->
        <div class="form-section">
            <h3>Resource Allocation</h3>
            <div style="margin-bottom: 1rem;">
                <label>Required Resources</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showActivityResourceSelector()" class="resource-action-btn primary">
                        🔧 Select Resources
                    </button>
                    <button type="button" onclick="window.checkResourceAvailability()" class="resource-action-btn">
                        ✓ Check Availability
                    </button>
                </div>
            </div>
            <div id="activity-resources-list" style="background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; min-height: 60px;">
                <div id="activity-resources-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                    No resources selected. Click "Select Resources" to add equipment, vehicles, materials, or tools.
                </div>
                <div id="activity-resources-items" style="display: none;">
                    <!-- Selected resources will be populated here -->
                </div>
            </div>
            <div id="activity-resource-conflicts" style="display: none;">
                <!-- Resource conflicts will be shown here -->
            </div>
        </div>
        
        <!-- NEW Sprint 4.4: Dependencies Section -->
        <div class="form-section">
            <h3>Activity Dependencies</h3>
            <div style="margin-bottom: 1rem;">
                <label>Dependencies & Workflow</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showDependencySelector('predecessor')" class="resource-action-btn primary">
                        ⬅️ Add Predecessor
                    </button>
                    <button type="button" onclick="window.showDependencySelector('successor')" class="resource-action-btn">
                        ➡️ Add Successor
                    </button>
                    <button type="button" onclick="window.calculateActivitySchedule()" class="resource-action-btn">
                        📊 Auto Schedule
                    </button>
                </div>
            </div>
            
            <!-- Predecessors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">⬅️ Predecessors (Must complete before this activity)</div>
                <div id="activity-predecessors-list" class="dependency-list">
                    <div id="activity-predecessors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No predecessors defined. This activity can start immediately.
                    </div>
                </div>
            </div>
            
            <!-- Successors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">➡️ Successors (Will start after this activity)</div>
                <div id="activity-successors-list" class="dependency-list">
                    <div id="activity-successors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No successors defined. This activity has no dependent activities.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveActivity()">Save Activity</button>
            <button onclick="window.saveActivityAsTemplate()" style="background: #8b5cf6; color: white;">📋 Save as Template</button>
            <button onclick="window.closeActivityModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <div id="resource-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2 id="resource-modal-title">New Resource</h2>
        <input type="hidden" id="resource-id">
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-grid">
                <div><label>Resource Name *</label><input type="text" id="resource-name" placeholder="e.g. LED Downlight - 10W Cool White" required></div>
                <div><label>SKU</label><input type="text" id="resource-sku" placeholder="e.g. LED-DL-10W-CW" pattern="[A-Z0-9-]+" title="SKU should contain only uppercase letters, numbers, and hyphens"></div>
                <div><label>Category *</label><select id="resource-category" required>
                    <option value="">Select...</option>
                    <option value="lighting">Lighting</option>
                    <option value="electrical">Electrical</option>
                    <option value="labour">Labour</option>
                    <option value="transport">Transport</option>
                    <option value="materials">Materials</option>
                    <option value="other">Other</option>
                </select></div>
                <div><label>Subcategory</label><input type="text" id="resource-subcategory" placeholder="e.g. downlights, cable"></div>
            </div>
            <div>
                <label>Description</label>
                <textarea id="resource-description" rows="2" placeholder="Detailed resource description..."></textarea>
            </div>
        </div>
        
        <!-- Pricing & Units -->
        <div class="form-section">
            <h3>Pricing & Units</h3>
            <div class="form-grid">
                <div><label>Net Cost (£) *</label><input type="number" id="resource-cost" step="0.01" min="0" placeholder="25.00" required></div>
                <div><label>Unit *</label><select id="resource-unit" required>
                    <option value="">Select...</option>
                    <option value="each">Each</option>
                    <option value="metre">Metre</option>
                    <option value="hour">Hour</option>
                    <option value="day">Day</option>
                    <option value="kg">Kilogram</option>
                    <option value="m2">Square Metre</option>
                </select></div>
                <div><label>Min Quantity</label><input type="number" id="resource-min-quantity" min="1" placeholder="10"></div>
                <div><label>Lead Time (days)</label><input type="number" id="resource-lead-time" min="0" placeholder="5"></div>
            </div>
        </div>
        
        <!-- Supplier Information -->
        <div class="form-section">
            <h3>Supplier Information</h3>
            <div class="form-grid">
                <div><label>Supplier</label><input type="text" id="resource-supplier" placeholder="e.g. Electrical Supplies Ltd"></div>
                <div><label>Supplier Code</label><input type="text" id="resource-supplier-code" placeholder="e.g. ESL-LED-001"></div>
                <div><label>Warranty (months)</label><input type="number" id="resource-warranty" min="0" placeholder="24"></div>
                <div><label>Status</label><select id="resource-status">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select></div>
            </div>
        </div>
        
        <!-- Physical Properties -->
        <div class="form-section">
            <h3>Physical Properties</h3>
            <div class="form-grid">
                <div><label>Weight (kg)</label><input type="number" id="resource-weight" step="0.001" min="0" placeholder="0.150"></div>
                <div><label>Dimensions</label><input type="text" id="resource-dimensions" placeholder="e.g. 85mm diameter x 25mm depth"></div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveResource()">Save Resource</button>
            <button onclick="window.closeResourceModal()" class="secondary">Cancel</button>
        </div>
    </div>        </div>

        <!-- NEW Sprint 3: Enhanced Resource Lookup Modal -->
        <div id="enhanced-resource-lookup-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="window.closeEnhancedResourceModal()">&times;</span>
                <h2>🔍 Add Resources to Quote</h2>
                
                <!-- Search & Filter Section -->
                <div style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.75rem; align-items: center;">

                        <div>
                            <label>Category</label>
                            <select id="resource-category-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Categories</option>
                                <option value="human">Human Resources</option>
                                <option value="vehicles">Vehicles</option>
                                <option value="materials">Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="resource-status-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #666;">
                        <span id="resource-count">0</span> resources found
                    </p>
                </div>
                
                <!-- Resources Grid -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Select</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Resource</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">SKU</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Category</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Price</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Qty</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="enhanced-resources-list">
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="selected-count">0</span> resources selected
                            <button onclick="window.selectAllFilteredResources()" style="margin-left: 1rem;" class="secondary">Select All Visible</button>
                            <button onclick="window.clearResourceSelection()" style="margin-left: 0.5rem;" class="secondary">Clear Selection</button>
                        </div>
                        <div>
                            <button onclick="window.addSelectedResourcesToQuote()" disabled id="add-selected-btn">Add Selected to Quote</button>
                            <button onclick="window.closeEnhancedResourceModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.2: Bulk Operations Modals -->
        <div id="bulk-quantity-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkQuantityModal()">&times;</span>
                <h2>📊 Update Quantities</h2>
                <p>Update quantities for <span id="bulk-qty-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Operation:</label>
                    <select id="bulk-qty-operation" style="width: 100%; margin-bottom: 1rem;">
                        <option value="set">Set all to specific value</option>
                        <option value="multiply">Multiply by factor</option>
                        <option value="add">Add to current</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Value:</label>
                    <input type="number" id="bulk-qty-value" min="0" step="1" placeholder="Enter value" style="width: 100%;">
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkQuantityUpdate()" style="background: #3b82f6; color: white;">Apply Changes</button>
                    <button onclick="window.closeBulkQuantityModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <div id="bulk-discount-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkDiscountModal()">&times;</span>
                <h2>💰 Apply Discount</h2>
                <p>Apply discount to <span id="bulk-discount-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Type:</label>
                    <select id="bulk-discount-type" style="width: 100%; margin-bottom: 1rem;">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (£)</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Value:</label>
                    <input type="number" id="bulk-discount-value" min="0" step="0.01" placeholder="Enter discount" style="width: 100%;">
                    
                    <p style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                        Note: Discount will be applied to unit prices
                    </p>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkDiscount()" style="background: #10b981; color: white;">Apply Discount</button>
                    <button onclick="window.closeBulkDiscountModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.3: Template Creation/Edit Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="window.closeTemplateModal()">&times;</span>
                <h2 id="template-modal-title">Create Quote Template</h2>
                
                <input type="hidden" id="template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="template-name" placeholder="e.g. Standard Office Lighting" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="template-category" required>
                                <option value="">Select category...</option>
                                <option value="electrical">Electrical</option>
                                <option value="lighting">Lighting</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="installation">Installation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                            <label>Default VAT Rate (%)</label>
                            <input type="number" id="template-vat-rate" value="20.00" step="0.01" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <!-- Template Default Terms -->
                <div style="margin-bottom: 1.5rem;">
                    <label>Default Terms & Conditions</label>
                    <textarea id="template-terms" rows="3" placeholder="Default terms for quotes created from this template...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                </div>
                
                <!-- Template Items Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Items</h4>
                    <div id="template-items-preview" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                        <p style="margin: 0; color: #666; text-align: center;">Create template from current quote items or add items manually</p>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button onclick="window.addItemsToTemplate()" class="secondary">+ Add Items to Template</button>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveTemplate()">Save Template</button>
                    <button onclick="window.closeTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Template Creation/Edit Modal -->
        <div id="activity-template-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="window.closeActivityTemplateModal()">&times;</span>
                <h2 id="activity-template-modal-title">Create Activity Template</h2>
                
                <input type="hidden" id="activity-template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="activity-template-name" placeholder="e.g. Standard Site Survey" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="activity-template-category" required>
                                <option value="">Select category...</option>
                                <option value="survey">Survey</option>
                                <option value="installation">Installation</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="activity-template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                </div>
                
                <!-- Activity Details -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Activity Configuration</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Priority *</label>
                            <select id="activity-template-priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label>Duration (hours)</label>
                            <input type="number" id="activity-template-duration" step="0.5" min="0.5" placeholder="2.0">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="activity-template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-assignment Rules -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Auto-assignment & Scheduling</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Default Assigned To</label>
                            <input type="text" id="activity-template-assigned-to" placeholder="e.g. Mike Johnson">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">Leave empty for manual assignment</p>
                        </div>
                        <div>
                            <label>Auto-schedule (days from PC creation)</label>
                            <input type="number" id="activity-template-schedule-offset" min="0" placeholder="1">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">0 = same day, 1 = next day, etc.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Template Instructions -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Instructions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Pre-activity Checklist</label>
                            <textarea id="activity-template-checklist" rows="3" placeholder="• Confirm appointment with client
• Prepare tools and equipment
• Review site access instructions"></textarea>
                        </div>
                        <div>
                            <label>Completion Notes Template</label>
                            <textarea id="activity-template-completion-notes" rows="3" placeholder="Activity completed successfully.

Key findings:
•

Next steps:
•"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveActivityTemplate()">Save Template</button>
                    <button onclick="window.closeActivityTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

    <div id="add-resource-modal" class="modal"><div class="modal-content" style="max-width: 500px;">
        <h2>Add item to Price List</h2>
        <label>Select Resource *</label><select id="modal-resource-item-select"></select>
        <div id="resource-info" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa;"></div>
        <label>Client Price (£) *</label><input type="number" id="modal-client-price" step="0.01" min="0" oninput="window.calculateMargin()">
        <div id="margin-info" style="margin-top: 0.5rem;"></div>
        <div class="form-actions">
             <button onclick="window.addResourceToPriceList()">Add to Price List</button>
            <button onclick="window.closeAddResourceModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.3: Activity Resource Selector Modal -->
    <div id="activity-resource-selector-modal" class="modal"><div class="modal-content" style="max-width: 900px;">
        <h2>🔧 Select Resources for Activity</h2>
        
        <!-- Resource Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">

                <select id="resource-selector-type-filter" onchange="window.filterActivityResourceSelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Types</option>
                    <option value="equipment">Equipment</option>
                    <option value="vehicle">Vehicles</option>
                    <option value="material">Materials</option>
                    <option value="tool">Tools</option>
                </select>
            </div>
        </div>

        <!-- Resource Selection Grid -->
        <div id="resource-selector-grid" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Resources will be populated here -->
        </div>

        <!-- Selected Resources Summary -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Selected Resources:</div>
            <div id="resource-selector-summary" style="font-size: 0.875rem; color: #166534;">
                No resources selected
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmActivityResourceSelection()" class="primary">Confirm Selection</button>
            <button onclick="window.closeActivityResourceSelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.4: Dependency Selector Modal -->
    <div id="dependency-selector-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2>🔗 Select Activity Dependencies</h2>
        
        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div id="dependency-selector-info" style="font-size: 0.875rem; color: #0c4a6e;">
                <!-- Information about dependency type will be shown here -->
            </div>
        </div>
        
        <!-- Activity Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">

                <select id="dependency-selector-status-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="dependency-selector-pc-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All PC Numbers</option>
                    <!-- PC options will be populated -->
                </select>
            </div>
        </div>

        <!-- Activity Selection List -->
        <div id="dependency-selector-list" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Activities will be populated here -->
        </div>

        <!-- Dependency Type Options -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Dependency Type:</div>
            <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-start" checked>
                    Finish-to-Start (Default)
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="start-to-start">
                    Start-to-Start
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-finish">
                    Finish-to-Finish
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmDependencySelection()" class="primary">Add Dependency</button>
            <button onclick="window.closeDependencySelector()" class="secondary">Cancel</button>
        </div>
    </div></div>
    <script type="module" src="js/main.js"></script>
</body>
</html>