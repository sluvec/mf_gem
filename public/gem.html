<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Demo - Portable Version</title>
    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Enhanced Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-message">
        <div class="loading-container">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h2 id="loading-title" class="loading-title">Loading...</h2>
            <p id="loading-message" class="loading-message">Please wait while we prepare your data</p>
            <div class="loading-progress">
                <div class="progress-track">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="progress-text">0%</div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Toast Container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-label="Notifications">
        <!-- Toasts will be dynamically added here -->
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay" style="display: block; background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000;">
        <div class="modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; min-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="margin: 0 0 0.5rem 0; color: #1f2937; font-size: 1.5rem;">🔐 Login to CRM Demo</h2>
                <p style="margin: 0; color: #6b7280;">Please select your user account to continue</p>
            </div>
            
            <form id="login-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <label for="user-select" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Select User:</label>
                    <select id="user-select" required style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; background: white;">
                        <option value="">-- Choose User --</option>
                        <option value="Slav">👨‍💼 Slav</option>
                        <option value="Rob">👨‍💻 Rob</option>
                        <option value="Kayleigh">👩‍💼 Kayleigh</option>
                        <option value="Terry">👨‍🔧 Terry</option>
                        <option value="Phil">👨‍📊 Phil</option>
                    </select>
                </div>
                
                <button type="submit" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s;">
                    🚀 Login to System
                </button>
            </form>
        </div>
    </div>
    
    <header role="banner">
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="nav-left">
                <h1>
                    <button 
                        data-show-page="dashboard" 
                        aria-label="Go to dashboard - CRM Demo homepage"
                        class="logo-btn">
                        🏢 CRM Demo
                    </button>
                </h1>
                
                <!-- Mobile hamburger menu toggle -->
                <button 
                    id="mobile-menu-toggle" 
                    class="mobile-menu-toggle" 
                    aria-expanded="false"
                    aria-controls="main-navigation"
                    aria-label="Toggle main navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <ul id="main-navigation" class="nav-menu nav-grid" role="menubar" aria-label="Main menu">
                    <!-- Row 1: Core Navigation -->
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="dashboard" 
                            class="nav-btn active"
                            role="menuitem"
                            aria-pressed="true"
                            aria-describedby="dashboard-desc">
                            <span class="nav-icon">🏠</span>
                            Dashboard
                        </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="pcnumbers" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="pc-numbers-desc">
                            <span class="nav-icon">📋</span>
                                    PC Numbers
                                </button>
                            </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="quotes" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="quotes-desc">
                            <span class="nav-icon">📝</span>
                                    Quotes
                                </button>
                            </li>
                    
                    <li role="none" class="nav-row-1">
                                <button 
                            data-show-page="activities" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="activities-desc">
                            <span class="nav-icon">📅</span>
                                    Activities
                                </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                                <button 
                            data-show-page="pricelists" 
                            class="nav-btn"
                                    role="menuitem"
                                    aria-describedby="pricelists-desc">
                            <span class="nav-icon">💷</span>
                                    Price Lists
                                </button>
                    </li>
                    
                    <li role="none" class="nav-row-1">
                        <button 
                            data-show-page="resources" 
                            class="nav-btn"
                            role="menuitem"
                            aria-describedby="resources-desc">
                            <span class="nav-icon">🛠️</span>
                            Resources
                        </button>
                    </li>
                </ul>
            </div>
                            <div class="nav-right">
                    <!-- User Info Display -->
                    <div id="user-info" style="display: none; align-items: center; gap: 1rem; margin-right: 1rem;">
                        <div style="background: #f3f4f6; padding: 0.5rem 1rem; border-radius: 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.2rem;">👤</span>
                            <span id="current-user-name" style="font-weight: 500; color: #374151;"></span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button 
                                onclick="window.showChangeUserModal()" 
                                class="nav-btn secondary"
                                style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                aria-label="Change current user">
                                🔄 Change User
                            </button>
                            <button 
                                onclick="window.logoutUser()" 
                                class="nav-btn danger"
                                style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                aria-label="Logout current user">
                                🚪 Logout
                            </button>
                        </div>
                    </div>

                    <button 
                        onclick="window.resetData()" 
                        class="nav-btn danger"
                        aria-label="Reset all demo data - this will delete all current data">
                        Reset Demo Data
                    </button>
                </div>
        </nav>
    </header>
    
    <!-- Screen reader descriptions for navigation items -->
    <div class="sr-only">
        <div id="dashboard-desc">Overview of key metrics and recent activity</div>
        <div id="pc-numbers-desc">Manage project codes and client information</div>
        <div id="quotes-desc">Create and manage quotes for projects</div>
        <div id="activities-desc">Schedule and track project activities</div>
        <div id="resources-desc">Manage equipment, materials and labor resources</div>
        <div id="pricelists-desc">Manage pricing and rate cards</div>
    </div>



    <main id="main-content" role="main" tabindex="-1">
        <div class="container">
            <div id="dashboard" class="page active">
            <h1>📊 Dashboard</h1>
            <p>Overview of key metrics in the demonstration system.</p>
            

            

            
            <div class="stats">
                <div class="stat-card clickable" data-show-page="pcnumbers">
                    <h3>PC Numbers</h3>
                    <div class="value" id="stat-pc">0</div>
                </div>
                <div class="stat-card clickable" data-show-page="quotes">
                    <h3>Quotes</h3>
                    <div class="value" id="stat-quotes">0</div>
                </div>
                <div class="stat-card clickable" data-show-page="activities">
                    <h3>Activities</h3>
                    <div class="value" id="stat-activities">0</div>
                </div>
                <div class="stat-card">
                    <h3>Quote Value</h3>
                    <div class="value" id="stat-value">£0</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h2>🚀 Quick Actions</h2>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button 
                        data-show-page="new-pc" 
                        class="button primary" 
                        style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                        📋 New PC Number
                    </button>
                    <button 
                        onclick="window.showNewQuoteModal()" 
                        class="button primary" 
                        style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                        💰 New Quote
                    </button>
                    <button 
                        onclick="window.showActivityModal()" 
                        class="button primary" 
                        style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                        📅 New Activity
                    </button>
                </div>
            </div>

            <!-- Recent Data Tables -->
            <div class="card">
                <h2>Recent PC Numbers</h2>
                <table>
                    <thead>
                        <tr><th>PC Number</th><th>Company</th><th>Reference</th><th>Created</th></tr>
                    </thead>
                    <tbody id="recent-pc"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Recent Quotes</h2>
                <table>
                    <thead>
                        <tr><th>Quote Number</th><th>PC Number</th><th>Client Name</th><th>Value</th><th>Status</th><th>Created</th></tr>
                    </thead>
                    <tbody id="recent-quotes"></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Recent Activities</h2>
                <table>
                    <thead>
                        <tr><th>Title</th><th>Type</th><th>Quote</th><th>Status</th><th>Scheduled Date</th><th>Created</th></tr>
                    </thead>
                    <tbody id="recent-activities"></tbody>
                </table>
            </div>
        </div>

        <div id="pcnumbers" class="page">
            <h1>🔢 PC Numbers</h1>
            <button data-show-page="new-pc">+ New PC Number</button>
            
            <!-- Smart Filter -->
            <div class="card" style="margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.75rem;">🔍 Smart Filter</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label for="pc-filter-company" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Company Name:</label>
                        <input 
                            type="text" 
                            id="pc-filter-company" 
                            placeholder="Start typing company name..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterPcNumbersByCompany(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <label for="pc-filter-account-manager" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Account Manager:</label>
                        <input 
                            type="text" 
                            id="pc-filter-account-manager" 
                            placeholder="Start typing account manager..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterPcNumbersByAccountManager(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="pc-filter-pc-number" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PC Number:</label>
                        <input 
                            type="text" 
                            id="pc-filter-pc-number" 
                            placeholder="Start typing PC number..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterPcNumbersByPcNumber(this.value)"
                        >
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button onclick="window.clearPcFilter()" class="secondary">Clear Filter</button>
                    </div>
                </div>
                <div id="pc-filter-results" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></div>
            </div>
            
            <div class="card">
                <h2>PC Numbers List</h2>
                <table>
                    <thead><tr><th>PC Number</th><th>Company</th><th>Reference</th><th>Contact</th><th>Actions</th></tr></thead>
                    <tbody id="pc-list"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pc" class="page">
            <h1 id="pc-form-title">New PC Number</h1>
            
            <!-- Simple Single-Page Form -->
            <div style="max-width: 800px; margin: 0 auto;">
                <form id="pc-form">
                    <input type="hidden" id="pc-id">
                    
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        <div class="form-grid">
                            <div>
                                <label>PC Number *</label>
                                <input type="text" id="pc-number" required placeholder="PC-000001" pattern="^PC-\d{6}$">
                                <small>Format: PC- followed by 6 digits (e.g., PC-000001)</small>
                            </div>
                            <div>
                                <label>Status *</label>
                                <select id="pc-status" required>
                                    <option value="">Select status...</option>
                                    <option value="draft" selected>Draft</option>
                                    <option value="active">Active</option>
                                    <option value="quoted">Quoted</option>
                                    <option value="won">Won</option>
                                    <option value="lost">Lost</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div>
                                <label>Company Name *</label>
                                <input type="text" id="pc-company-name" required placeholder="Enter company name">
                                <button type="button" onclick="(async () => { const defaults = await app.getSmartPCDefaults(document.getElementById('pc-company-name').value); app.applySmartPCDefaults(defaults); })()" 
                                        style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.25rem;">
                                    ⚡ Apply Smart Defaults
                                </button>
                                <small style="display: block; margin-top: 0.25rem; color: #6b7280;">Auto-fill form based on similar projects for this company</small>
                            </div>
                            <div>
                                <label>Project Name *</label>
                                <input type="text" id="pc-project-name" required placeholder="Enter project name">
                            </div>
                        </div>

                        <div>
                            <label>Project Description</label>
                            <textarea id="pc-project-description" rows="3" placeholder="Describe the project requirements, scope, and any special considerations..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Client Details -->
                    <div class="form-section">
                        <h3>Client Details</h3>
                        <div class="form-grid">
                            <div>
                                <label>Account Manager *</label>
                                <input type="text" id="pc-account-manager" required placeholder="Account manager name">
                            </div>
                            <div>
                                <label>Industry/Sector</label>
                                <select id="pc-client-industry">
                                    <option value="">Select industry...</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Financial Services">Financial Services</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Professional Services">Professional Services</option>
                                    <option value="Construction">Construction</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Media & Creative">Media & Creative</option>
                                    <option value="Education">Education</option>
                                    <option value="Government">Government</option>
                                    <option value="Non-profit">Non-profit</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div>
                                <label>How did they find us?</label>
                                <select id="pc-client-source">
                                    <option value="">Select source...</option>
                                    <option value="Existing client referral">Existing client referral</option>
                                    <option value="Personal network">Personal network</option>
                                    <option value="Website/Online">Website/Online</option>
                                    <option value="Trade directory">Trade directory</option>
                                    <option value="Cold outreach">Cold outreach</option>
                                    <option value="Trade show/Event">Trade show/Event</option>
                                    <option value="Repeat business">Repeat business</option>
                                    <option value="Google/Search">Google/Search</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label>Budget Range (£)</label>
                                <select id="pc-quote-limit">
                                    <option value="">Select budget range...</option>
                                    <option value="Under £5,000">Under £5,000</option>
                                    <option value="£5,000 - £15,000">£5,000 - £15,000</option>
                                    <option value="£15,000 - £30,000">£15,000 - £30,000</option>
                                    <option value="£30,000 - £50,000">£30,000 - £50,000</option>
                                    <option value="£50,000 - £100,000">£50,000 - £100,000</option>
                                    <option value="Over £100,000">Over £100,000</option>
                                    <option value="To be determined">To be determined</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classification & Management -->
                    <div class="form-section">
                        <h3>Classification & Management</h3>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>Client Category</label>
                                <select id="pc-client-category">
                                    <option value="">Select category...</option>
                                    <option value="Corporate">Corporate</option>
                                    <option value="SME">Small/Medium Enterprise</option>
                                    <option value="Individual">Individual</option>
                                    <option value="Government">Government</option>
                                    <option value="Non-Profit">Non-Profit</option>
                                </select>
                            </div>
                            <div>
                                <label>Client Source</label>
                                <select id="pc-client-source">
                                    <option value="">Select source...</option>
                                    <option value="Website Inquiry">Website Inquiry</option>
                                    <option value="Phone Inquiry">Phone Inquiry</option>
                                    <option value="Email">Email</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Repeat Customer">Repeat Customer</option>
                                    <option value="Marketing Campaign">Marketing Campaign</option>
                                </select>
                            </div>
                            <div>
                                <label>Referral Type</label>
                                <select id="pc-referral-type">
                                    <option value="">Select type...</option>
                                    <option value="Direct">Direct</option>
                                    <option value="Partner">Partner</option>
                                    <option value="Customer">Customer Referral</option>
                                    <option value="Agency">Agency</option>
                                    <option value="Online">Online</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Surveyor</label>
                                <input type="text" id="pc-surveyor" placeholder="Assigned surveyor name">
                            </div>
                            <div>
                                <label>Property Type</label>
                                <select id="pc-property-type">
                                    <option value="">Select type...</option>
                                    <option value="Office Building">Office Building</option>
                                    <option value="Retail Space">Retail Space</option>
                                    <option value="Warehouse">Warehouse</option>
                                    <option value="Residential">Residential</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Mixed Use">Mixed Use</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>SIC Code 1</label>
                                <input type="text" id="pc-sic-code-1" placeholder="Primary SIC code">
                                <small>Standard Industrial Classification</small>
                            </div>
                            <div>
                                <label>SIC Code 2</label>
                                <input type="text" id="pc-sic-code-2" placeholder="Secondary SIC code">
                            </div>
                            <div>
                                <label>SIC Code 3</label>
                                <input type="text" id="pc-sic-code-3" placeholder="Tertiary SIC code">
                            </div>
                        </div>
                    </div>

                    <!-- Collection Address -->
                    <div class="form-section">
                        <h3>Collection Address (Current Location)</h3>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>First Name</label>
                                <input type="text" id="pc-collection-first-name" placeholder="Contact first name">
                            </div>
                            <div>
                                <label>Surname</label>
                                <input type="text" id="pc-collection-surname" placeholder="Contact surname">
                            </div>
                            <div>
                                <label>Title</label>
                                <select id="pc-collection-title">
                                    <option value="">Select title...</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Dr">Dr</option>
                                    <option value="Prof">Prof</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Position</label>
                                <input type="text" id="pc-collection-position" placeholder="Job title/position">
                            </div>
                            <div>
                                <label>Collection Date</label>
                                <input type="date" id="pc-collection-date">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>Email</label>
                                <input type="email" id="pc-collection-email" placeholder="contact@company.com">
                            </div>
                            <div>
                                <label>Phone</label>
                                <input type="tel" id="pc-collection-phone" placeholder="+44 20 7123 4567">
                            </div>
                            <div>
                                <label>Mobile</label>
                                <input type="tel" id="pc-collection-mobile" placeholder="+44 7xxx xxxxxx">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Address Line 1</label>
                                <input type="text" id="pc-collection-address-1" placeholder="Building number and street">
                            </div>
                            <div>
                                <label>Address Line 2</label>
                                <input type="text" id="pc-collection-address-2" placeholder="Floor, suite, apartment">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>Address Line 3</label>
                                <input type="text" id="pc-collection-address-3" placeholder="District/area">
                            </div>
                            <div>
                                <label>Address Line 4</label>
                                <input type="text" id="pc-collection-address-4" placeholder="City/town">
                            </div>
                            <div>
                                <label>Postcode</label>
                                <input type="text" id="pc-collection-postcode" placeholder="SW1A 1AA">
                            </div>
                        </div>

                        <div>
                            <label>Country</label>
                            <select id="pc-collection-country">
                                <option value="">Select country...</option>
                                <option value="United Kingdom" selected>United Kingdom</option>
                                <option value="Ireland">Ireland</option>
                                <option value="France">France</option>
                                <option value="Germany">Germany</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Delivery Address -->
                    <div class="form-section">
                        <h3>Delivery Address (New Location)</h3>
                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>First Name</label>
                                <input type="text" id="pc-delivery-first-name" placeholder="Contact first name">
                            </div>
                            <div>
                                <label>Surname</label>
                                <input type="text" id="pc-delivery-surname" placeholder="Contact surname">
                            </div>
                            <div>
                                <label>Title</label>
                                <select id="pc-delivery-title">
                                    <option value="">Select title...</option>
                                    <option value="Mr">Mr</option>
                                    <option value="Ms">Ms</option>
                                    <option value="Mrs">Mrs</option>
                                    <option value="Dr">Dr</option>
                                    <option value="Prof">Prof</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Position</label>
                                <input type="text" id="pc-delivery-position" placeholder="Job title/position">
                            </div>
                            <div>
                                <label>Delivery Date</label>
                                <input type="date" id="pc-delivery-date">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>Email</label>
                                <input type="email" id="pc-delivery-email" placeholder="contact@company.com">
                            </div>
                            <div>
                                <label>Phone</label>
                                <input type="tel" id="pc-delivery-phone" placeholder="+44 20 7123 4567">
                            </div>
                            <div>
                                <label>Mobile</label>
                                <input type="tel" id="pc-delivery-mobile" placeholder="+44 7xxx xxxxxx">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Address Line 1</label>
                                <input type="text" id="pc-delivery-address-1" placeholder="Building number and street">
                            </div>
                            <div>
                                <label>Address Line 2</label>
                                <input type="text" id="pc-delivery-address-2" placeholder="Floor, suite, apartment">
                            </div>
                        </div>

                        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div>
                                <label>Address Line 3</label>
                                <input type="text" id="pc-delivery-address-3" placeholder="District/area">
                            </div>
                            <div>
                                <label>Address Line 4</label>
                                <input type="text" id="pc-delivery-address-4" placeholder="City/town">
                            </div>
                            <div>
                                <label>Postcode</label>
                                <input type="text" id="pc-delivery-postcode" placeholder="SW1A 1AA">
                            </div>
                        </div>

                        <div>
                            <label>Country</label>
                            <select id="pc-delivery-country">
                                <option value="">Select country...</option>
                                <option value="United Kingdom" selected>United Kingdom</option>
                                <option value="Ireland">Ireland</option>
                                <option value="France">France</option>
                                <option value="Germany">Germany</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="form-section">
                        <h3>Contact Information</h3>
                        <div class="form-grid">
                            <div>
                                <label>Contact Name *</label>
                                <input type="text" id="pc-contact-name" required placeholder="Primary contact person">
                            </div>
                            <div>
                                <label>Phone Number</label>
                                <input type="tel" id="pc-contact-phone" placeholder="+44 20 7123 4567">
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div>
                                <label>Email Address</label>
                                <input type="email" id="pc-contact-email" placeholder="email@address.com">
                            </div>
                            <div>
                                <label>Postcode</label>
                                <input type="text" id="pc-postcode" placeholder="e.g. SW1A 1AA">
                            </div>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                            📞 <strong>Note:</strong> Please provide at least phone OR email for the contact person.
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions" style="margin-top: 2rem;">
                        <button type="submit">✓ Create PC Number</button>
                        <button type="button" onclick="window.showPage('pc-numbers')" class="secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="pc-detail" class="page">
            <h1 id="pc-detail-title">PC Details</h1>
            
            <!-- Main Data -->
            <div class="card">
                <h2>Main Project Data</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>PC Number:</strong> <span id="pc-detail-number"></span></div>
                    <div><strong>Company Name:</strong> <span id="pc-detail-company-name"></span></div>
                    <div><strong>Project Name:</strong> <span id="pc-detail-project-name"></span></div>
                    <div><strong>Account Manager:</strong> <span id="pc-detail-account-manager"></span></div>
                    <div><strong>Client Industry:</strong> <span id="pc-detail-client-industry"></span></div>
                    <div><strong>Client Source:</strong> <span id="pc-detail-client-source"></span></div>
                    <div><strong>Quote Limit:</strong> <span id="pc-detail-quote-limit"></span></div>
                    <div><strong>Status:</strong> <span id="pc-detail-status"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Project Description:</strong><br>
                    <span id="pc-detail-project-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editPC(db.currentPC.id)" class="warning">Edit</button>
                    <button onclick="window.createQuote()">Create Quote</button>
                    <button onclick="window.showActivityModal()">Add Activity</button>
                    <button data-show-page="pcnumbers" class="secondary">Back to list</button>
                </div>
            </div>
            
            <!-- Classification & Management -->
            <div class="card">
                <h2>Classification & Management</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Client Category:</strong> <span id="pc-detail-client-category"></span></div>
                    <div><strong>Client Source:</strong> <span id="pc-detail-client-source-new"></span></div>
                    <div><strong>Referral Type:</strong> <span id="pc-detail-referral-type"></span></div>
                    <div><strong>Surveyor:</strong> <span id="pc-detail-surveyor"></span></div>
                    <div><strong>Property Type:</strong> <span id="pc-detail-property-type"></span></div>
                    <div style="grid-column: span 1;"></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>SIC Code 1:</strong> <span id="pc-detail-sic-code-1"></span></div>
                    <div><strong>SIC Code 2:</strong> <span id="pc-detail-sic-code-2"></span></div>
                    <div><strong>SIC Code 3:</strong> <span id="pc-detail-sic-code-3"></span></div>
                </div>
            </div>

            <!-- Collection Address -->
            <div class="card">
                <h2>Collection Address (Current Location)</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Contact:</strong> <span id="pc-detail-collection-title"></span> <span id="pc-detail-collection-first-name"></span> <span id="pc-detail-collection-surname"></span></div>
                    <div><strong>Position:</strong> <span id="pc-detail-collection-position"></span></div>
                    <div><strong>Collection Date:</strong> <span id="pc-detail-collection-date"></span></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>Email:</strong> <span id="pc-detail-collection-email"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-collection-phone"></span></div>
                    <div><strong>Mobile:</strong> <span id="pc-detail-collection-mobile"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Address:</strong><br>
                    <span id="pc-detail-collection-address-1"></span><br>
                    <span id="pc-detail-collection-address-2"></span><br>
                    <span id="pc-detail-collection-address-3"></span><br>
                    <span id="pc-detail-collection-address-4"></span><br>
                    <span id="pc-detail-collection-postcode"></span>, <span id="pc-detail-collection-country"></span>
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="card">
                <h2>Delivery Address (New Location)</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Contact:</strong> <span id="pc-detail-delivery-title"></span> <span id="pc-detail-delivery-first-name"></span> <span id="pc-detail-delivery-surname"></span></div>
                    <div><strong>Position:</strong> <span id="pc-detail-delivery-position"></span></div>
                    <div><strong>Delivery Date:</strong> <span id="pc-detail-delivery-date"></span></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>Email:</strong> <span id="pc-detail-delivery-email"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-delivery-phone"></span></div>
                    <div><strong>Mobile:</strong> <span id="pc-detail-delivery-mobile"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Address:</strong><br>
                    <span id="pc-detail-delivery-address-1"></span><br>
                    <span id="pc-detail-delivery-address-2"></span><br>
                    <span id="pc-detail-delivery-address-3"></span><br>
                    <span id="pc-detail-delivery-address-4"></span><br>
                    <span id="pc-detail-delivery-postcode"></span>, <span id="pc-detail-delivery-country"></span>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card">
                <h2>Primary Contact</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Contact Name:</strong> <span id="pc-detail-contact-name"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-contact-phone"></span></div>
                    <div><strong>Email:</strong> <span id="pc-detail-contact-email"></span></div>
                    <div><strong>Postcode:</strong> <span id="pc-detail-postcode"></span></div>
                </div>
                <p class="field-note">Note: Detailed addresses are now managed in individual quotes.</p>
            </div>
            <div class="card">
                <h2>Related Quotes</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>Title</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-quotes"></tbody>
                </table>
            </div>
            <div class="card">
                <h2>Related Activities</h2>
                <table>
                     <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-activities"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quotes" class="page">
            <h1>💰 Quotes</h1>
            <button onclick="window.showNewQuoteModal()">+ New Quote</button>
            
            <!-- Smart Filter -->
            <div class="card" style="margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.75rem;">🔍 Smart Filter</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label for="quote-filter-company" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Company Name:</label>
                        <input 
                            type="text" 
                            id="quote-filter-company" 
                            placeholder="Start typing company name..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterQuotesByCompany(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <label for="quote-filter-account-manager" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Account Manager:</label>
                        <input 
                            type="text" 
                            id="quote-filter-account-manager" 
                            placeholder="Start typing account manager..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterQuotesByAccountManager(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="quote-filter-pc-number" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PC Number:</label>
                        <input 
                            type="text" 
                            id="quote-filter-pc-number" 
                            placeholder="Start typing PC number..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterQuotesByPcNumber(this.value)"
                        >
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button onclick="window.clearQuoteFilter()" class="secondary">Clear Filter</button>
                    </div>
                </div>
                <div id="quote-filter-results" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></div>
            </div>
            
            <div class="card">
                <h2>Quote List</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>PC Number</th><th>Company</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="quotes-list"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quote-builder" class="page">
            <h1 id="quote-builder-title">New Quote</h1>
            <div class="card" id="price-list-selector">
                <h2>Step 1: Select Price List</h2>
                <label>Available Price Lists *</label>
                <select id="quote-price-list" onchange="window.handlePriceListChange()"></select>
            </div>
            <div class="quote-builder" id="quote-items-section" style="display: none;">
                <div class="card">
                    <h2>Step 2: Build Quote</h2>
                    
                    <!-- NEW Sprint 3: Enhanced Resource Lookup -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">🚀 Enhanced Resource Lookup</h4>
                                <p style="margin: 0; color: #666; font-size: 0.875rem;">Search, filter, and add multiple resources quickly</p>
                            </div>
                            <button onclick="window.showEnhancedResourceModal()" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; font-weight: bold;">
                                🔍 Search & Add Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW Sprint 3.2: Bulk Operations Panel -->
                    <div id="bulk-operations-panel" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">🔧 Bulk Operations</h4>
                                <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
                                    <span id="bulk-selected-count">0</span> line items selected
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="window.bulkUpdateQuantity()" style="background: #3b82f6; color: white;">📊 Update Quantities</button>
                                <button onclick="window.bulkApplyDiscount()" style="background: #10b981; color: white;">💰 Apply Discount</button>
                                <button onclick="window.bulkDeleteItems()" style="background: #ef4444; color: white;">🗑️ Delete Selected</button>
                                <button onclick="window.clearBulkSelection()" class="secondary">Clear Selection</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Category Sections -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Human Resources</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('human')" id="select-all-human"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-human"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('human')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('human')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Vehicles</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('vehicles')" id="select-all-vehicles"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-vehicles"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('vehicles')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('vehicles')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Materials</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('materials')" id="select-all-materials"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-materials"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('materials')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('materials')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                     <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Other</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('other')" id="select-all-other"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-other"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('other')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('other')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                </div>
                <div class="summary">
                    <h3>Quote Summary</h3>
                    <div class="summary-line"><span>Human Resources:</span><span id="sum-human">£0.00</span></div>
                    <div class="summary-line"><span>Vehicles:</span><span id="sum-vehicles">£0.00</span></div>
                    <div class="summary-line"><span>Materials:</span><span id="sum-materials">£0.00</span></div>
                    <div class="summary-line"><span>Other:</span><span id="sum-other">£0.00</span></div>
                    <div class="summary-line"><span>Net Total:</span><span id="sum-subtotal">£0.00</span></div>
                    <div class="summary-line">
                        <span>VAT Rate:</span>
                        <input type="number" id="quote-vat-rate" value="20.00" step="0.01" min="0" max="100" 
                               style="width: 60px; margin: 0; padding: 0.25rem;" onchange="window.calculateTotal()">%
                    </div>
                    <div class="summary-line"><span>VAT Amount:</span><span id="sum-vat">£0.00</span></div>
                    <div class="summary-total"><span>Total (inc VAT):</span><span id="sum-total">£0.00</span></div>
                    
                    <!-- NEW: Move Type & Addresses Section -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">📦 Move Type & Addresses</h3>
                        
                        <!-- Move Type Selection -->
                        <div style="margin-bottom: 1rem;">
                            <label>Move Type *</label>
                            <select id="quote-move-type" onchange="window.toggleAddressSections()" required>
                                <option value="">Select move type...</option>
                                <option value="Collection Only">Collection Only</option>
                                <option value="Delivery Only">Delivery Only</option>
                                <option value="Collection + Delivery">Collection + Delivery</option>
                            </select>
                        </div>
                        
                        <!-- Collection Address Section -->
                        <div id="collection-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">📍 Collection Address</h4>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-collection-name" placeholder="Contact person" required></div>
                                <div><label>Phone</label><input type="tel" id="quote-collection-phone" placeholder="Phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-collection-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-collection-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-collection-address1" placeholder="Street address" required></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-collection-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-collection-city" placeholder="City" required></div>
                                <div><label>County</label><input type="text" id="quote-collection-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-collection-postcode" placeholder="Postcode" required pattern="[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}" title="Please enter a valid UK postcode (e.g., SW1A 1AA)"></div>
                            </div>
                        </div>
                        
                        <!-- Delivery Address Section -->
                        <div id="delivery-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">🚚 Delivery Address</h4>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quote-same-address" onchange="window.copyCollectionToDelivery()" style="margin-right: 0.5rem;">
                                    Same as collection address
                                </label>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-delivery-name" placeholder="Contact person" required></div>
                                <div><label>Phone</label><input type="tel" id="quote-delivery-phone" placeholder="Phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-delivery-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-delivery-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-delivery-address1" placeholder="Street address" required></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-delivery-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-delivery-city" placeholder="City" required></div>
                                <div><label>County</label><input type="text" id="quote-delivery-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-delivery-postcode" placeholder="Postcode" required pattern="[A-Z]{1,2}[0-9]{1,2}[A-Z]?\s?[0-9][A-Z]{2}" title="Please enter a valid UK postcode (e.g., SW1A 1AA)"></div>
                            </div>
                        </div>
                        
                        <!-- Quoted Activities Section -->
                        <div style="margin-bottom: 1rem;">
                            <label>Quoted Activities (optional)</label>
                            <div id="quote-activities-multiselect" style="border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.375rem; max-height: 120px; overflow-y: auto; background: white;">
                                <p style="margin: 0; color: #666; font-style: italic;">Loading activities for this PC...</p>
                            </div>
                            <p class="field-note">Select activities that are included in this quote pricing</p>
                        </div>
                    </div>
                    
                    <!-- Additional Quote Fields -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Status *</label>
                            <select id="quote-status" onchange="window.handleQuoteStatusChange()" required>
                                <option value="DRAFT">DRAFT - Work in progress (editable)</option>
                                <option value="ISSUED">ISSUED - Sent to client (not editable)</option>
                                <option value="WON">WON - Quote accepted by client</option>
                                <option value="LOST">LOST - Quote lost to competitor</option>
                            </select>
                            <p class="field-note">Note: Once ISSUED, quote cannot be edited. WON/LOST are final states.</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Valid Until *</label>
                            <input type="date" id="quote-valid-until" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Title *</label>
                            <input type="text" id="quote-title" placeholder="Brief quote description" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Description</label>
                            <textarea id="quote-description" rows="2" placeholder="Detailed quote description..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Internal Notes</label>
                            <textarea id="quote-notes" rows="2" placeholder="Internal notes (not visible to client)..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Terms & Conditions</label>
                            <textarea id="quote-terms" rows="3" placeholder="Payment terms, delivery conditions, etc...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="text-align: center;">
                        <button onclick="window.saveQuote()">Save Quote</button>
                        <button onclick="window.saveQuoteAsTemplate()" style="background: #8b5cf6; color: white;">📄 Save as Template</button>
                        <button onclick="window.duplicateCurrentQuote()" style="background: #06b6d4; color: white;">📋 Duplicate Quote</button>
                        <button onclick="window.cancelQuote()" class="secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>





        <div id="activities" class="page">
            <h1>📋 Activities</h1>
            
            <!-- NEW Sprint 4.2: View Toggle and Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="window.showActivityModal()" style="background: #3b82f6; color: white;">+ New Activity</button>
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="activities-list-view-btn" onclick="window.switchActivitiesView('list')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            📋 List View
                        </button>
                        <button id="activities-calendar-view-btn" onclick="window.switchActivitiesView('calendar')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            📅 Calendar View
                        </button>
                        <button id="activities-workflow-view-btn" onclick="window.switchActivitiesView('workflow')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            🔗 Workflow
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Navigation (hidden by default) -->
                <div id="calendar-navigation" style="display: none; align-items: center; gap: 1rem;">
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="calendar-month-btn" onclick="window.setCalendarView('month')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            Month
                        </button>
                        <button id="calendar-week-btn" onclick="window.setCalendarView('week')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            Week
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.navigateCalendar('prev')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">‹</button>
                        <span id="calendar-title" style="min-width: 200px; text-align: center; font-weight: 500;">October 2024</span>
                        <button onclick="window.navigateCalendar('next')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">›</button>
                        <button onclick="window.navigateCalendar('today')" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white;">Today</button>
                    </div>
                </div>
            </div>
            
            <!-- Smart Filter for Activities -->
            <div class="card" style="margin-bottom: 1rem;">
                <h3 style="margin-bottom: 0.75rem;">🔍 Smart Filter</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label for="activity-filter-company" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Company Name:</label>
                        <input 
                            type="text" 
                            id="activity-filter-company" 
                            placeholder="Start typing company name..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterActivitiesByCompany(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <label for="activity-filter-account-manager" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Account Manager:</label>
                        <input 
                            type="text" 
                            id="activity-filter-account-manager" 
                            placeholder="Start typing account manager..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterActivitiesByAccountManager(this.value)"
                        >
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="activity-filter-pc-number" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PC Number:</label>
                        <input 
                            type="text" 
                            id="activity-filter-pc-number" 
                            placeholder="Start typing PC number..." 
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                            oninput="window.filterActivitiesByPcNumber(this.value)"
                        >
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button onclick="window.clearActivityFilter()" class="secondary">Clear Filter</button>
                    </div>
                </div>
                <div id="activity-filter-results" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;"></div>
            </div>
            
            <!-- List View (default) -->
            <div id="activities-list-view" class="card">
                <h2>Activity List</h2>
                <table>
                    <thead><tr><th>Title</th><th>PC Number</th><th>Company</th><th>Type</th><th>Scheduled</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="activities-list"></tbody>
                </table>
            </div>
            
            <!-- NEW Sprint 4.2: Calendar View -->
            <div id="activities-calendar-view" style="display: none;">
                <!-- NEW Sprint 4.2.3: Team Filter Bar -->
                <div class="team-filter-bar">
                    <div style="font-weight: 600; color: #374151; margin-right: 0.5rem;">Filter by Team:</div>
                    <div id="team-filter-chips">
                        <!-- Team member chips will be generated here -->
                    </div>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.toggleWorkloadPanel()" 
                                style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            📊 Workload View
                        </button>
                        <button onclick="window.showTeamManagement()" 
                                style="background: #3b82f6; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            👥 Manage Team
                        </button>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Workload Panel -->
                <div id="workload-panel" class="workload-panel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Team Workload Distribution</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="font-size: 0.875rem; color: #6b7280;">Week of: </span>
                            <span id="workload-week-display" style="font-weight: 500;"></span>
                        </div>
                    </div>
                    <div id="workload-summary" class="workload-summary">
                        <!-- Workload cards will be generated here -->
                    </div>
                </div>
                
                <!-- Month View Calendar -->
                <div id="calendar-month-view" class="card">
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Calendar grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Week View Calendar -->
                <div id="calendar-week-view" class="card" style="display: none;">
                    <div style="display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Week view grid will be generated by JavaScript -->
                        <div style="background: white; padding: 0.5rem; font-weight: 500;"></div>
                        <!-- Time slots and days -->
                        <div id="week-grid-content">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Activity Details Sidebar (for calendar view) -->
                <div id="calendar-activity-sidebar" style="display: none; position: fixed; right: 20px; top: 20px; width: 300px; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">Activity Details</h3>
                        <button onclick="window.closeCalendarSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <div id="calendar-activity-content">
                        <!-- Activity details will be populated here -->
                    </div>
                </div>

                <!-- NEW Sprint 4.2.2: Quick Create Activity Overlay -->
                <div id="quick-create-overlay" class="quick-create-overlay">
                    <div class="quick-create-form">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Quick Create Activity</h3>
                            <button onclick="window.closeQuickCreate()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div id="quick-create-time-info" class="time-slot-info">
                            <!-- Time slot info will be populated here -->
                        </div>

                        <form id="quick-create-form" onsubmit="window.submitQuickCreate(event)">
                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Activity Title *</label>
                                <input type="text" id="quick-activity-title" name="title" required 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-pc" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">PC Number</label>
                                <select id="quick-activity-pc" name="pc_id" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Select PC Number</option>
                                    <!-- PC options will be populated -->
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-assignee" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Assign To</label>
                                <select id="quick-activity-assignee" name="assigned_to" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Unassigned</option>
                                    <!-- Team members will be populated -->
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div>
                                    <label for="quick-activity-priority" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                                    <select id="quick-activity-priority" name="priority" 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-activity-duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Duration (hrs)</label>
                                    <input type="number" id="quick-activity-duration" name="estimated_hours" min="0.25" step="0.25" value="1"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label for="quick-activity-description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="quick-activity-description" name="description" rows="3"
                                          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;"></textarea>
                            </div>

                            <!-- NEW Sprint 4.2.4: Recurring Activities Section -->
                            <div class="recurring-section">
                                <div class="recurring-toggle">
                                    <input type="checkbox" id="quick-recurring-enabled" name="recurring_enabled" onchange="window.toggleRecurringOptions(this)">
                                    <label for="quick-recurring-enabled" style="font-weight: 500; color: #374151;">🔄 Make this a recurring activity</label>
                                </div>
                                
                                <div id="quick-recurring-options" class="recurring-options">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Repeat</label>
                                        <select id="quick-recurring-frequency" name="recurring_frequency" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Every</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="number" id="quick-recurring-interval" name="recurring_interval" min="1" max="365" value="1" 
                                                   style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <span id="quick-recurring-unit" style="font-size: 0.875rem; color: #6b7280;">week(s)</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">End Date</label>
                                        <input type="date" id="quick-recurring-end-date" name="recurring_end_date" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Or Max Occurrences</label>
                                        <input type="number" id="quick-recurring-count" name="recurring_count" min="1" max="365" placeholder="e.g., 10" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                </div>
                                
                                <div id="quick-recurring-preview" class="recurring-preview" style="display: none;">
                                    <!-- Preview will be generated here -->
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button type="button" onclick="window.closeQuickCreate()" 
                                        style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Create Activity
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Team Management Modal -->
                <div id="team-management-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">👥 Team Management</h3>
                            <button onclick="window.closeTeamManagement()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <!-- Add New Team Member Form -->
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Add Team Member</h4>
                            <form id="add-team-member-form" onsubmit="window.addTeamMember(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role</label>
                                        <input type="text" name="role" placeholder="e.g., Engineer, Manager" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                        <input type="email" name="email" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max Hours/Week</label>
                                        <input type="number" name="max_hours" min="1" max="60" value="40" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <button type="submit" 
                                        style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    ➕ Add Member
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Team Members -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Current Team</h4>
                            <div id="team-members-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Team members will be listed here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="window.closeTeamManagement()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.4: Recurring Activity Edit Modal -->
                <div id="recurring-edit-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 450px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">🔄 Edit Recurring Activity</h3>
                            <button onclick="window.closeRecurringEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                                <strong>⚠️ This is part of a recurring series.</strong><br>
                                Choose how you want to apply your changes:
                            </p>
                        </div>
                        
                        <div id="recurring-edit-options" class="recurring-series-buttons" style="margin-bottom: 1.5rem;">
                            <button onclick="window.editRecurringActivity('single')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📝 Edit Only This Activity
                            </button>
                            <button onclick="window.editRecurringActivity('future')" 
                                    style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📅 Edit This & Future Activities
                            </button>
                            <button onclick="window.editRecurringActivity('all')" 
                                    style="background: #10b981; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                🔄 Edit Entire Series
                            </button>
                        </div>
                        
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 0.875rem; font-weight: 600;">Activity Details:</h4>
                            <div id="recurring-activity-details" style="font-size: 0.875rem; color: #0c4a6e;">
                                <!-- Activity details will be populated here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button onclick="window.closeRecurringEditModal()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="window.deleteRecurringSeries()" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                🗑️ Delete Series
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW Sprint 4.4: Workflow View -->
            <div id="activities-workflow-view" style="display: none;">
                <!-- Workflow Stats Dashboard -->
                <div class="workflow-stats">
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-total-activities">0</div>
                        <div class="workflow-stat-label">Total Activities</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-in-progress">0</div>
                        <div class="workflow-stat-label">In Progress</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-completed">0</div>
                        <div class="workflow-stat-label">Completed</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-blocked">0</div>
                        <div class="workflow-stat-label">Blocked</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-critical-path">0</div>
                        <div class="workflow-stat-label">Critical Path Days</div>
                    </div>
                </div>

                <!-- Workflow Canvas -->
                <div class="workflow-panel">
                    <div class="workflow-header">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">🔗 Activity Dependencies & Workflow</h2>
                        <div class="workflow-toolbar">
                            <div class="workflow-mode-toggle">
                                <button class="workflow-mode-btn active" onclick="window.setWorkflowMode('view')">👁️ View</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('edit')">✏️ Edit</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('connect')">🔗 Connect</button>
                            </div>
                            <button class="workflow-action-btn" onclick="window.autoLayoutWorkflow()">🔄 Auto Layout</button>
                            <button class="workflow-action-btn" onclick="window.calculateCriticalPath()">🚨 Critical Path</button>
                            <button class="workflow-action-btn primary" onclick="window.optimizeWorkflow()">⚡ Optimize</button>
                        </div>
                    </div>
                    
                    <div id="workflow-canvas" class="workflow-canvas">
                        <!-- Workflow nodes and connections will be generated here -->
                        <svg id="workflow-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                                </marker>
                            </defs>
                        </svg>
                        
                        <div id="workflow-nodes-container">
                            <!-- Workflow nodes will be positioned here -->
                        </div>
                        
                        <!-- Workflow minimap -->
                        <div class="workflow-minimap">
                            <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; font-weight: 600; background: #f8fafc;">
                                Workflow Overview
                            </div>
                            <div id="workflow-minimap-content" style="padding: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                <!-- Minimap content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Legend -->
                <div class="workflow-legend">
                    <div class="legend-item">
                        <div class="legend-indicator pending"></div>
                        <span>Pending</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator in-progress"></div>
                        <span>In Progress</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator completed"></div>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator blocked"></div>
                        <span>Blocked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator critical"></div>
                        <span>Critical Path</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="activity-detail" class="page">
            <h1 id="activity-detail-title">Activity Details</h1>
            
            <!-- Main Activity Data -->
            <div class="card">
                <h2>Activity Information</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>Title:</strong> <span id="activity-detail-title-text"></span></div>
                    <div><strong>Type:</strong> <span id="activity-detail-type"></span></div>
                    <div><strong>PC Number:</strong> <span id="activity-detail-pc-number"></span></div>
                    <div><strong>Status:</strong> <span id="activity-detail-status"></span></div>
                    <div><strong>Priority:</strong> <span id="activity-detail-priority"></span></div>
                    <div><strong>Assigned To:</strong> <span id="activity-detail-assigned-to"></span></div>
                    <div><strong>Scheduled Date:</strong> <span id="activity-detail-scheduled-date"></span></div>
                    <div><strong>Scheduled Time:</strong> <span id="activity-detail-scheduled-time"></span></div>
                    <div><strong>Duration:</strong> <span id="activity-detail-duration"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Description:</strong><br>
                    <span id="activity-detail-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editActivity(window.currentActivity.id)" class="warning">Edit Activity</button>
                    <button onclick="window.showActivityModal()" class="primary">Add New Activity</button>
                    <button data-show-page="activities" class="secondary">Back to Activities</button>
                </div>
            </div>
            
            <!-- Location & Contact Information -->
            <div class="card">
                <h2>Location & Contact</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Location:</strong> <span id="activity-detail-location"></span></div>
                    <div><strong>Contact Name:</strong> <span id="activity-detail-contact-name"></span></div>
                    <div><strong>Contact Phone:</strong> <span id="activity-detail-contact-phone"></span></div>
                </div>
            </div>

            <!-- Management & Timing Information -->
            <div class="card">
                <h2>Management & Timing</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Department:</strong> <span id="activity-detail-department"></span></div>
                    <div><strong>Payment Type:</strong> <span id="activity-detail-payment-type"></span></div>
                    <div><strong>Activity Number:</strong> <span id="activity-detail-activity-number"></span></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>Depot Start:</strong> <span id="activity-detail-time-depot-start"></span></div>
                    <div><strong>Site Start:</strong> <span id="activity-detail-time-site-start"></span></div>
                    <div><strong>Site Finish:</strong> <span id="activity-detail-time-site-finish"></span></div>
                    <div><strong>Depot Finish:</strong> <span id="activity-detail-time-depot-finish"></span></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>Total Hours:</strong> <span id="activity-detail-hours"></span></div>
                    <div><strong>Moveman Job:</strong> <span id="activity-detail-moveman-job"></span></div>
                    <div><strong>CRM ID:</strong> <span id="activity-detail-crm-id"></span></div>
                </div>
            </div>

            <!-- Professional Details -->
            <div class="card" id="activity-detail-instructions-card" style="display: none;">
                <h2>Professional Details</h2>
                <div>
                    <strong>Instructions:</strong><br>
                    <span id="activity-detail-instructions" style="white-space: pre-wrap;"></span>
                </div>
            </div>

            <!-- Logistics & Requirements -->
            <div class="card">
                <h2>Logistics & Requirements</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Parking Required:</strong> <span id="activity-detail-parking-required"></span></div>
                    <div><strong>Confirmed:</strong> <span id="activity-detail-confirmed"></span></div>
                    <div><strong>Risk Assessment Needed:</strong> <span id="activity-detail-risk-assessment-needed"></span></div>
                </div>
            </div>

            <!-- Collection Address -->
            <div class="card" id="activity-detail-collection-card" style="display: none;">
                <h2>Collection Address</h2>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div><strong>Contact:</strong> <span id="activity-detail-collection-contact"></span></div>
                    <div><strong>Phone:</strong> <span id="activity-detail-collection-phone"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Address:</strong><br>
                    <span id="activity-detail-collection-address"></span>
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="card" id="activity-detail-delivery-card" style="display: none;">
                <h2>Delivery Address</h2>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div><strong>Contact:</strong> <span id="activity-detail-delivery-contact"></span></div>
                    <div><strong>Phone:</strong> <span id="activity-detail-delivery-phone"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Address:</strong><br>
                    <span id="activity-detail-delivery-address"></span>
                </div>
            </div>

            <!-- Completion Notes (if completed) -->
            <div class="card" id="activity-detail-completion-card" style="display: none;">
                <h2>Completion Details</h2>
                <div>
                    <strong>Completion Notes:</strong><br>
                    <span id="activity-detail-completion-notes" style="white-space: pre-wrap;"></span>
                </div>
            </div>
        </div>

        <div id="quote-detail" class="page">
            <h1 id="quote-detail-title">Quote Details</h1>
            
            <!-- Main Quote Data -->
            <div class="card">
                <h2>Quote Information</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>Quote Number:</strong> <span id="quote-detail-number"></span></div>
                    <div><strong>PC Number:</strong> <span id="quote-detail-pc-number"></span></div>
                    <div><strong>Client Name:</strong> <span id="quote-detail-client-name"></span></div>
                    <div><strong>Project Title:</strong> <span id="quote-detail-project-title"></span></div>
                    <div><strong>Value:</strong> <span id="quote-detail-value"></span></div>
                    <div><strong>Status:</strong> <span id="quote-detail-status"></span></div>
                    <div><strong>Valid Until:</strong> <span id="quote-detail-valid-until"></span></div>
                    <div><strong>Created:</strong> <span id="quote-detail-created-at"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Description:</strong><br>
                    <span id="quote-detail-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editQuote(window.currentQuote.id)" class="warning">Edit Quote</button>
                    <button onclick="window.showNewQuoteModal()" class="primary">Create New Quote</button>
                    <button data-show-page="quotes" class="secondary">Back to Quotes</button>
                </div>
            </div>

            <!-- Financial Details -->
            <div class="card">
                <h2>Financial Details</h2>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>Version:</strong> <span id="quote-detail-version"></span></div>
                    <div><strong>Net Total:</strong> <span id="quote-detail-net-total"></span></div>
                    <div><strong>VAT Rate:</strong> <span id="quote-detail-vat-rate"></span></div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                    <div><strong>VAT Amount:</strong> <span id="quote-detail-vat-amount"></span></div>
                    <div><strong>Discount:</strong> <span id="quote-detail-discount"></span></div>
                    <div><strong>Total Cost:</strong> <span id="quote-detail-total-cost"></span></div>
                </div>
            </div>

            <!-- Professional Details -->
            <div class="card">
                <h2>Professional Details</h2>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div><strong>Standard Liability:</strong> <span id="quote-detail-standard-liability"></span></div>
                    <div><strong>Declared Value:</strong> <span id="quote-detail-declared-value"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Price List:</strong> <span id="quote-detail-price-list"></span>
                </div>
            </div>

            <!-- Pricing Breakdown -->
            <div class="card">
                <h2>Pricing Breakdown</h2>
                
                <!-- Quote Items -->
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="margin: 0 0 0.75rem 0; color: #374151;">Quote Items</h3>
                    <div id="quote-detail-items" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; min-height: 60px;">
                        <div style="text-align: center; color: #6b7280; font-size: 0.875rem;">
                            No items in this quote
                        </div>
                    </div>
                </div>

                <!-- Additional Costs -->
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong>Recycling Charges:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            <div>Recycling Fee: <span id="quote-detail-recycling-fee"></span></div>
                            <div>Environmental Fee: <span id="quote-detail-environmental-fee"></span></div>
                        </div>
                    </div>
                    <div>
                        <strong>Rebates:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            <div>Volume Rebate: <span id="quote-detail-volume-rebate"></span></div>
                            <div>Loyalty Rebate: <span id="quote-detail-loyalty-rebate"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Other Costs -->
                <div id="quote-detail-other-costs-section" style="display: none;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Other Costs</h4>
                    <div id="quote-detail-other-costs" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem;">
                        <!-- Other costs will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="resources" class="page">
            <h1>🔧 Resources</h1>
            <button onclick="window.showResourceModal()">+ New Resource</button>
            <div class="card">
                <h2>Resource Database</h2>
                <table>
                    <thead><tr><th>Name</th><th>SKU</th><th>Category</th><th>Net Cost</th><th>Supplier</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="resources-list"></tbody>
                </table>
            </div>
        </div>

        <div id="pricelists" class="page">
             <h1>🏷️ Price Lists</h1>
            <button data-show-page="new-pricelist">+ New Price List</button>
            <div class="card">
                <h2>Available Price Lists</h2>
                <table>
                    <thead><tr><th>Name</th><th>Version</th><th>Currency</th><th>Effective Period</th><th>Default</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pricelist" class="page">
            <h1 id="pricelist-form-title">New Price List</h1>
            <div class="card">
                <input type="hidden" id="pricelist-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div><label>Price List Name *</label><input type="text" id="pricelist-name" placeholder="e.g. Standard Commercial Rates 2024" required></div>
                        <div><label>Version *</label><input type="text" id="pricelist-version" placeholder="e.g. v2.1" required></div>
                        <div><label>Currency</label><select id="pricelist-currency">
                            <option value="GBP" selected>GBP (£)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select></div>
                        <div><label>Status</label><select id="pricelist-status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                        </select></div>
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="pricelist-description" rows="2" placeholder="Brief description of this price list..."></textarea>
                    </div>
                </div>
                
                <!-- Pricing Configuration -->
                <div class="form-section">
                    <h3>Pricing Configuration</h3>
                    <div class="form-grid">
                        <div><label>Default Markup (%) *</label><input type="number" id="pricelist-markup" step="0.01" min="0" placeholder="35.00" required></div>
                        <div><label>Discount (%)</label><input type="number" id="pricelist-discount" step="0.01" min="0" max="100" placeholder="0.00"></div>
                        <div><label>Effective From *</label><input type="date" id="pricelist-effective-from" required></div>
                        <div><label>Effective Until</label><input type="date" id="pricelist-effective-to"></div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="pricelist-is-default" style="margin-right: 0.5rem;">
                            Set as default price list
                        </label>
                    </div>
                </div>
                
                <!-- Terms & Conditions -->
                <div class="form-section">
                    <h3>Terms & Conditions</h3>
                    <div>
                        <label>Default Terms</label>
                        <textarea id="pricelist-terms" rows="3" placeholder="Pricing terms, payment conditions, delivery notes...">Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.</textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="window.createPriceList()">Create Price List</button>
                    <button data-show-page="pricelists" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="pricelist-detail" class="page">
            <h1 id="pricelist-title">Price List Details</h1>
             <div class="card">
                <button onclick="window.showAddResourceToPriceList()">+ Add Item to Price List</button>
                <button data-show-page="pricelists" class="secondary">Back to list</button>
            </div>
            <div class="card">
                <h2>Price List Items</h2>
                <table>
                    <thead><tr><th>Resource</th><th>Net Cost</th><th>Client Price</th><th>Margin %</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-items"></tbody>
                </table>
            </div>
        </div>








        <!-- Price List Item Detail Page -->
        <div id="pricelist-item-detail" class="page">
            <h1 id="pricelist-item-title">Price List Item Details</h1>
            
            <div class="card">
                <button onclick="window.editCurrentPriceListItem()" class="button primary">✏️ Edit Item</button>
                <button onclick="window.deleteCurrentPriceListItem()" class="button danger">🗑️ Delete Item</button>
                <button onclick="window.backToPriceListDetail()" class="button secondary">← Back to Price List</button>
            </div>

            <!-- Item Information -->
            <div class="card">
                <h2>Item Information</h2>
                <div class="detail-grid">
                    <div>
                        <label>Description:</label>
                        <span id="pricelist-item-detail-description">-</span>
                    </div>
                    <div>
                        <label>Category:</label>
                        <span id="pricelist-item-detail-category">-</span>
                    </div>
                    <div>
                        <label>Unit:</label>
                        <span id="pricelist-item-detail-unit">-</span>
                    </div>
                </div>
            </div>

            <!-- Pricing Information -->
            <div class="card">
                <h2>Pricing Details</h2>
                <div class="detail-grid">
                    <div>
                        <label>Net Cost:</label>
                        <span id="pricelist-item-detail-price" style="font-weight: 600; color: #059669;">-</span>
                    </div>
                    <div>
                        <label>Margin:</label>
                        <span id="pricelist-item-detail-margin">-</span>
                    </div>
                    <div>
                        <label>Client Price:</label>
                        <span id="pricelist-item-detail-client-price" style="font-weight: 600; color: #dc2626;">-</span>
                    </div>
                    <div>
                        <label>Profit per Unit:</label>
                        <span id="pricelist-item-detail-profit" style="font-weight: 600; color: #0891b2;">-</span>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card" id="pricelist-item-notes-card" style="display: none;">
                <h2>Notes</h2>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                    <span id="pricelist-item-detail-notes">-</span>
                </div>
            </div>

            <!-- Price List Context -->
            <div class="card">
                <h2>Price List Information</h2>
                <div class="detail-grid">
                    <div>
                        <label>Price List:</label>
                        <span id="pricelist-item-detail-pricelist-name">-</span>
                    </div>
                    <div>
                        <label>Region:</label>
                        <span id="pricelist-item-detail-pricelist-region">-</span>
                    </div>
                    <div>
                        <label>Currency:</label>
                        <span id="pricelist-item-detail-pricelist-currency">-</span>
                    </div>
                    <div>
                        <label>Status:</label>
                        <span id="pricelist-item-detail-pricelist-status">-</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="quote-modal" class="modal"><div class="modal-content">
        <h2>Select PC Number for new quote</h2>
        <label>PC Number *</label>
        <select id="quote-modal-pc"></select>
        <div class="form-actions">
            <button onclick="window.proceedToQuoteBuilder()">Continue</button>
            <button onclick="window.closeQuoteModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- Quote Edit Modal -->
    <div id="quote-edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="quote-edit-modal-title">Edit Quote</h2>
            <form id="quote-edit-form">
                <input type="hidden" id="quote-edit-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div>
                            <label>Quote Number *</label>
                            <input type="text" id="quote-edit-number" required placeholder="QT-2024-001">
                        </div>
                        <div>
                            <label>Status *</label>
                            <select id="quote-edit-status" required>
                                <option value="draft">Draft</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="declined">Declined</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div>
                            <label>PC Number *</label>
                            <input type="text" id="quote-edit-pc-number" required placeholder="PC-2024-001">
                        </div>
                        <div>
                            <label>Value (£) *</label>
                            <input type="number" id="quote-edit-value" required min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <!-- Client & Project -->
                <div class="form-section">
                    <h3>Client & Project</h3>
                    <div>
                        <label>Client Name *</label>
                        <input type="text" id="quote-edit-client-name" required placeholder="Client company name">
                    </div>
                    <div>
                        <label>Project Title *</label>
                        <input type="text" id="quote-edit-project-title" required placeholder="Project title">
                    </div>
                    <div>
                        <label>Valid Until</label>
                        <input type="date" id="quote-edit-valid-until">
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="form-section">
                    <h3>Financial Details</h3>
                    <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div>
                            <label>Version</label>
                            <input type="number" id="quote-edit-version" min="1" value="1" placeholder="1">
                            <small>Version number for tracking revisions</small>
                        </div>
                        <div>
                            <label>Net Total (£)</label>
                            <input type="number" id="quote-edit-net-total" min="0" step="0.01" placeholder="0.00">
                            <small>Total before VAT and discount</small>
                        </div>
                        <div>
                            <label>VAT Rate (%)</label>
                            <input type="number" id="quote-edit-vat-rate" min="0" max="100" step="0.01" value="20.00" placeholder="20.00">
                            <small>Standard UK VAT rate</small>
                        </div>
                    </div>
                    <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 1rem;">
                        <div>
                            <label>VAT Amount (£)</label>
                            <input type="number" id="quote-edit-vat-amount" min="0" step="0.01" placeholder="0.00" readonly>
                            <small>Calculated automatically</small>
                        </div>
                        <div>
                            <label>Discount (£)</label>
                            <input type="number" id="quote-edit-discount" min="0" step="0.01" placeholder="0.00">
                            <small>Total discount amount</small>
                        </div>
                        <div>
                            <label>Total Cost (£)</label>
                            <input type="number" id="quote-edit-total-cost" min="0" step="0.01" placeholder="0.00" readonly>
                            <small>Final total after VAT and discount</small>
                        </div>
                    </div>
                </div>

                <!-- Professional Details -->
                <div class="form-section">
                    <h3>Professional Details</h3>
                    <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div>
                            <label>Standard Liability (£)</label>
                            <input type="number" id="quote-edit-standard-liability" min="0" step="0.01" value="100000.00" placeholder="100000.00">
                            <small>Standard liability coverage</small>
                        </div>
                        <div>
                            <label>Declared Value (£)</label>
                            <input type="number" id="quote-edit-declared-value" min="0" step="0.01" placeholder="0.00">
                            <small>Client declared value of goods</small>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label>Price List</label>
                        <select id="quote-edit-price-list-id">
                            <option value="">Select price list...</option>
                            <!-- Price lists will be populated dynamically -->
                        </select>
                        <small>Associated price list for this quote</small>
                    </div>
                </div>

                <!-- Pricing Breakdown -->
                <div class="form-section">
                    <h3>Pricing Breakdown</h3>
                    
                    <!-- Quote Items Summary -->
                    <div style="margin-bottom: 1rem;">
                        <label>Quote Items</label>
                        <div id="quote-edit-items-summary" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; min-height: 60px;">
                            <div style="text-align: center; color: #6b7280; font-size: 0.875rem;">
                                No items added. Use Quote Builder to add detailed items.
                            </div>
                        </div>
                        <small>Detailed quote items managed in Quote Builder</small>
                    </div>

                    <!-- Additional Costs -->
                    <div style="margin-bottom: 1rem;">
                        <label>Other Costs</label>
                        <textarea id="quote-edit-other-costs" rows="2" placeholder="Additional costs not in standard price list (JSON format: [{&quot;description&quot;: &quot;Special transport&quot;, &quot;amount&quot;: 150.00}])"></textarea>
                        <small>JSON array of additional cost items</small>
                    </div>

                    <!-- Recycling & Environmental -->
                    <div style="margin-bottom: 1rem;">
                        <label>Recycling Charges</label>
                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Recycling Fee (£)</label>
                                <input type="number" id="quote-edit-recycling-fee" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div>
                                <label>Environmental Fee (£)</label>
                                <input type="number" id="quote-edit-environmental-fee" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <small>Environmental and recycling charges</small>
                    </div>

                    <!-- Rebates & Discounts -->
                    <div>
                        <label>Rebates</label>
                        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div>
                                <label>Volume Rebate (£)</label>
                                <input type="number" id="quote-edit-volume-rebate" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div>
                                <label>Loyalty Rebate (£)</label>
                                <input type="number" id="quote-edit-loyalty-rebate" min="0" step="0.01" placeholder="0.00">
                            </div>
                        </div>
                        <small>Customer rebates and incentives</small>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-section">
                    <h3>Description</h3>
                    <div>
                        <label>Quote Description</label>
                        <textarea id="quote-edit-description" rows="4" placeholder="Detailed description of the quote..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="primary">Update Quote</button>
                    <button type="button" onclick="window.closeQuoteEditModal()" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PC Number Edit Modal -->
    <div id="pc-edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="pc-edit-modal-title">Edit PC Number</h2>
            <form id="pc-edit-form">
                <input type="hidden" id="pc-edit-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div>
                            <label>PC Number *</label>
                            <input type="text" id="pc-edit-number" required 
                                   placeholder="PC-000001" pattern="^PC-\d{6}$">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="pc-edit-status">
                                <option value="draft">Draft</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Company & Project -->
                <div class="form-section">
                    <h3>Company & Project</h3>
                    <div>
                        <label>Company Name *</label>
                        <input type="text" id="pc-edit-company" required placeholder="Company name">
                    </div>
                    <div>
                        <label>Project Title *</label>
                        <input type="text" id="pc-edit-title" required placeholder="Project title">
                    </div>
                    <div>
                        <label>Project Description *</label>
                        <textarea id="pc-edit-description" rows="3" required 
                                  placeholder="Brief description of the project..."></textarea>
                    </div>
                    <div>
                        <label>Reference</label>
                        <input type="text" id="pc-edit-reference" placeholder="Project reference">
                    </div>
                </div>

                <!-- Contact & Value -->
                <div class="form-section">
                    <h3>Contact & Value</h3>
                    <div class="form-grid">
                        <div>
                            <label>Contact Name</label>
                            <input type="text" id="pc-edit-contact" placeholder="Contact person">
                        </div>
                        <div>
                            <label>Estimated Value (£)</label>
                            <input type="number" id="pc-edit-value" min="0" step="0.01" 
                                   placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="primary">Update PC Number</button>
                    <button type="button" onclick="window.closePcEditModal()" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="activity-modal" class="modal"><div class="modal-content">
        <h2 id="activity-modal-title">New Activity</h2>
        <form id="activity-form">
            <input type="hidden" id="activity-id">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <h3>Basic Information</h3>
        <div class="form-grid">
                <div>
                    <label>Quote *</label>
                    <select id="activity-quote-select"></select>
                    <button type="button" onclick="app.autoFillActivityFromQuote(document.getElementById('activity-quote-select').value)" 
                            style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.25rem;">
                        🔄 Auto-fill from Quote
                    </button>
                </div>
                <div><label>Activity Type *</label><input type="text" id="activity-type" placeholder="e.g. Survey, Delivery, Installation" required></div>
                <div><label>Priority</label><select id="activity-priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select></div>
                <div><label>Status</label><select id="activity-status">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select></div>
        </div>
            <div>
                <label>Activity Title *</label>
                <input type="text" id="activity-title" placeholder="Brief description of the activity" required>
            </div>
            <div>
                <label>Description</label>
                <textarea id="activity-description" rows="2" placeholder="Detailed activity description..."></textarea>
            </div>
        </div>
        
        <!-- Scheduling Section -->
        <div class="form-section">
            <h3>Scheduling</h3>
            <div class="form-grid">
                <div><label>Scheduled Date</label><input type="date" id="activity-scheduled-date"></div>
                <div><label>Scheduled Time</label><input type="time" id="activity-scheduled-time"></div>
                <div><label>Duration (hours)</label><input type="number" id="activity-duration" step="0.5" min="0" placeholder="e.g. 2.5"></div>
                <div><label>Assigned To</label><input type="text" id="activity-assigned-to-name" placeholder="Person responsible"></div>
            </div>
        </div>
        
        <!-- Location & Contact Section -->
        <div class="form-section">
            <h3>Location & Contact</h3>
            <div class="form-grid">
                <div><label>Location</label><input type="text" id="activity-location" placeholder="e.g. Client Site - Birmingham"></div>
                <div><label>Contact Name</label><input type="text" id="activity-contact-name" placeholder="Site contact person"></div>
                <div><label>Contact Phone</label><input type="tel" id="activity-contact-phone" placeholder="Contact phone number" pattern="[0-9\s\+\-\(\)\.]+" title="Please enter a valid phone number"></div>
            </div>
        </div>
        
        <!-- Completion Section (shown only for completed activities) -->
        <div class="form-section" id="activity-completion-section" style="display: none;">
            <h3>Completion Details</h3>
            <div>
                <label>Completion Notes</label>
                <textarea id="activity-completion-notes" rows="3" placeholder="Notes about the completed activity..."></textarea>
            </div>
        </div>
        
        <!-- NEW Sprint 4.3: Resource Allocation Section -->
        <div class="form-section">
            <h3>Resource Allocation</h3>
            <div style="margin-bottom: 1rem;">
                <label>Required Resources</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showActivityResourceSelector()" class="resource-action-btn primary">
                        🔧 Select Resources
                    </button>
                    <button type="button" onclick="window.checkResourceAvailability()" class="resource-action-btn">
                        ✓ Check Availability
                    </button>
                </div>
            </div>
            <div id="activity-resources-list" style="background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; min-height: 60px;">
                <div id="activity-resources-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                    No resources selected. Click "Select Resources" to add equipment, vehicles, materials, or tools.
                </div>
                <div id="activity-resources-items" style="display: none;">
                    <!-- Selected resources will be populated here -->
                </div>
            </div>
            <div id="activity-resource-conflicts" style="display: none;">
                <!-- Resource conflicts will be shown here -->
            </div>
        </div>
        
        <!-- NEW Sprint 4.4: Dependencies Section -->
        <div class="form-section">
            <h3>Activity Dependencies</h3>
            <div style="margin-bottom: 1rem;">
                <label>Dependencies & Workflow</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showDependencySelector('predecessor')" class="resource-action-btn primary">
                        ⬅️ Add Predecessor
                    </button>
                    <button type="button" onclick="window.showDependencySelector('successor')" class="resource-action-btn">
                        ➡️ Add Successor
                    </button>
                    <button type="button" onclick="window.calculateActivitySchedule()" class="resource-action-btn">
                        📊 Auto Schedule
                    </button>
                </div>
            </div>
            
            <!-- Predecessors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">⬅️ Predecessors (Must complete before this activity)</div>
                <div id="activity-predecessors-list" class="dependency-list">
                    <div id="activity-predecessors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No predecessors defined. This activity can start immediately.
                    </div>
                </div>
            </div>
            
            <!-- Successors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">➡️ Successors (Will start after this activity)</div>
                <div id="activity-successors-list" class="dependency-list">
                    <div id="activity-successors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No successors defined. This activity has no dependent activities.
                    </div>
                </div>
            </div>
        </div>

        <!-- Management & Timing Section -->
        <div class="form-section">
            <h3>Management & Timing</h3>
            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div>
                    <label>Department</label>
                    <select id="activity-department">
                        <option value="">Select department...</option>
                        <option value="Survey Team">Survey Team</option>
                        <option value="Operations">Operations</option>
                        <option value="Installation">Installation</option>
                        <option value="Logistics">Logistics</option>
                        <option value="Administration">Administration</option>
                        <option value="Customer Service">Customer Service</option>
                    </select>
                </div>
                <div>
                    <label>Payment Type</label>
                    <select id="activity-payment-type">
                        <option value="">Select payment type...</option>
                        <option value="Standard Rate">Standard Rate</option>
                        <option value="Overtime Rate">Overtime Rate</option>
                        <option value="Weekend Rate">Weekend Rate</option>
                        <option value="Emergency Rate">Emergency Rate</option>
                        <option value="Contract Rate">Contract Rate</option>
                        <option value="Fixed Price">Fixed Price</option>
                    </select>
                </div>
                <div>
                    <label>Activity Number</label>
                    <input type="text" id="activity-number" placeholder="ACT-2024-001">
                </div>
            </div>

            <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); margin-top: 1rem;">
                <div>
                    <label>Depot Start Time</label>
                    <input type="time" id="activity-time-depot-start">
                    <small>Time leaving depot</small>
                </div>
                <div>
                    <label>Site Start Time</label>
                    <input type="time" id="activity-time-site-start">
                    <small>Arrival at site</small>
                </div>
                <div>
                    <label>Site Finish Time</label>
                    <input type="time" id="activity-time-site-finish">
                    <small>Departure from site</small>
                </div>
                <div>
                    <label>Depot Finish Time</label>
                    <input type="time" id="activity-time-depot-finish">
                    <small>Return to depot</small>
                </div>
            </div>

            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 1rem;">
                <div>
                    <label>Total Hours</label>
                    <input type="number" id="activity-hours" step="0.25" min="0" placeholder="8.0">
                    <small>Calculated or manual entry</small>
                </div>
                <div>
                    <label>Moveman Job</label>
                    <input type="text" id="activity-moveman-job" placeholder="MJ-001">
                </div>
                <div>
                    <label>CRM ID</label>
                    <input type="text" id="activity-crm-id" placeholder="CRM-SF-12345">
                </div>
            </div>
        </div>

        <!-- Professional Details Section -->
        <div class="form-section">
            <h3>Professional Details</h3>
            <div>
                <label>Instructions</label>
                <textarea id="activity-instructions" rows="3" placeholder="Special instructions, safety requirements, access details..."></textarea>
            </div>
        </div>

        <!-- Logistics & Requirements Section -->
        <div class="form-section">
            <h3>Logistics & Requirements</h3>
            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="activity-parking-required">
                    <label for="activity-parking-required" style="margin: 0;">Parking Required</label>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="activity-confirmed">
                    <label for="activity-confirmed" style="margin: 0;">Confirmed</label>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="activity-risk-assessment-needed">
                    <label for="activity-risk-assessment-needed" style="margin: 0;">Risk Assessment Needed</label>
                </div>
            </div>
        </div>

        <!-- Address Management Section -->
        <div class="form-section">
            <h3>Address Management</h3>
            
            <!-- Collection Address -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Collection Address</h4>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div>
                        <label>Address Line 1</label>
                        <input type="text" id="activity-collection-address-1" placeholder="Building number and street">
                    </div>
                    <div>
                        <label>Address Line 2</label>
                        <input type="text" id="activity-collection-address-2" placeholder="Floor, suite, apartment">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 0.5rem;">
                    <div>
                        <label>City</label>
                        <input type="text" id="activity-collection-city" placeholder="City/town">
                    </div>
                    <div>
                        <label>Postcode</label>
                        <input type="text" id="activity-collection-postcode" placeholder="SW1A 1AA">
                    </div>
                    <div>
                        <label>Country</label>
                        <select id="activity-collection-country">
                            <option value="">Select country...</option>
                            <option value="United Kingdom" selected>United Kingdom</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 0.5rem;">
                    <div>
                        <label>Contact Name</label>
                        <input type="text" id="activity-collection-contact" placeholder="Collection contact person">
                    </div>
                    <div>
                        <label>Contact Phone</label>
                        <input type="tel" id="activity-collection-phone" placeholder="+44 20 7123 4567">
                    </div>
                </div>
            </div>

            <!-- Delivery Address -->
            <div>
                <h4 style="margin: 0 0 0.75rem 0; color: #374151;">Delivery Address</h4>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div>
                        <label>Address Line 1</label>
                        <input type="text" id="activity-delivery-address-1" placeholder="Building number and street">
                    </div>
                    <div>
                        <label>Address Line 2</label>
                        <input type="text" id="activity-delivery-address-2" placeholder="Floor, suite, apartment">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 0.5rem;">
                    <div>
                        <label>City</label>
                        <input type="text" id="activity-delivery-city" placeholder="City/town">
                    </div>
                    <div>
                        <label>Postcode</label>
                        <input type="text" id="activity-delivery-postcode" placeholder="SW1A 1AA">
                    </div>
                    <div>
                        <label>Country</label>
                        <select id="activity-delivery-country">
                            <option value="">Select country...</option>
                            <option value="United Kingdom" selected>United Kingdom</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 0.5rem;">
                    <div>
                        <label>Contact Name</label>
                        <input type="text" id="activity-delivery-contact" placeholder="Delivery contact person">
                    </div>
                    <div>
                        <label>Contact Phone</label>
                        <input type="tel" id="activity-delivery-phone" placeholder="+44 20 7123 4567">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit">Save Activity</button>
            <button type="button" onclick="window.saveActivityAsTemplate()" style="background: #8b5cf6; color: white;">📋 Save as Template</button>
            <button type="button" onclick="window.closeActivityModal()" class="secondary">Cancel</button>
        </div>
        </form>
    </div></div>

    <div id="resource-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2 id="resource-modal-title">New Resource</h2>
        <form id="resource-form">
            <input type="hidden" id="resource-id">
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-grid">
                <div><label>Resource Name *</label><input type="text" id="resource-name" placeholder="e.g. LED Downlight - 10W Cool White" required></div>
                <div><label>SKU</label><input type="text" id="resource-sku" placeholder="e.g. LED-DL-10W-CW" pattern="[A-Z0-9-]+" title="SKU should contain only uppercase letters, numbers, and hyphens"></div>
                <div><label>Category *</label><select id="resource-category" required>
                    <option value="">Select...</option>
                    <option value="lighting">Lighting</option>
                    <option value="electrical">Electrical</option>
                    <option value="labour">Labour</option>
                    <option value="transport">Transport</option>
                    <option value="materials">Materials</option>
                    <option value="other">Other</option>
                </select></div>
                <div><label>Subcategory</label><input type="text" id="resource-subcategory" placeholder="e.g. downlights, cable"></div>
            </div>
            <div>
                <label>Description</label>
                <textarea id="resource-description" rows="2" placeholder="Detailed resource description..."></textarea>
            </div>
        </div>
        
        <!-- Pricing & Units -->
        <div class="form-section">
            <h3>Pricing & Units</h3>
            <div class="form-grid">
                <div><label>Net Cost (£) *</label><input type="number" id="resource-cost" step="0.01" min="0" placeholder="25.00" required></div>
                <div><label>Unit *</label><select id="resource-unit" required>
                    <option value="">Select...</option>
                    <option value="each">Each</option>
                    <option value="metre">Metre</option>
                    <option value="hour">Hour</option>
                    <option value="day">Day</option>
                    <option value="kg">Kilogram</option>
                    <option value="m2">Square Metre</option>
                </select></div>
                <div><label>Min Quantity</label><input type="number" id="resource-min-quantity" min="1" placeholder="10"></div>
                <div><label>Lead Time (days)</label><input type="number" id="resource-lead-time" min="0" placeholder="5"></div>
            </div>
        </div>
        
        <!-- Supplier Information -->
        <div class="form-section">
            <h3>Supplier Information</h3>
            <div class="form-grid">
                <div><label>Supplier</label><input type="text" id="resource-supplier" placeholder="e.g. Electrical Supplies Ltd"></div>
                <div><label>Supplier Code</label><input type="text" id="resource-supplier-code" placeholder="e.g. ESL-LED-001"></div>
                <div><label>Warranty (months)</label><input type="number" id="resource-warranty" min="0" placeholder="24"></div>
                <div><label>Status</label><select id="resource-status">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select></div>
            </div>
        </div>
        
        <!-- Physical Properties -->
        <div class="form-section">
            <h3>Physical Properties</h3>
            <div class="form-grid">
                <div><label>Weight (kg)</label><input type="number" id="resource-weight" step="0.001" min="0" placeholder="0.150"></div>
                <div><label>Dimensions</label><input type="text" id="resource-dimensions" placeholder="e.g. 85mm diameter x 25mm depth"></div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit">Save Resource</button>
            <button type="button" onclick="window.closeResourceModal()" class="secondary">Cancel</button>
        </div>
        </form>
    </div>        </div>

        <!-- NEW Sprint 3: Enhanced Resource Lookup Modal -->
        <div id="enhanced-resource-lookup-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="window.closeEnhancedResourceModal()">&times;</span>
                <h2>🔍 Add Resources to Quote</h2>
                
                <!-- Search & Filter Section -->
                <div style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.75rem; align-items: center;">

                        <div>
                            <label>Category</label>
                            <select id="resource-category-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Categories</option>
                                <option value="human">Human Resources</option>
                                <option value="vehicles">Vehicles</option>
                                <option value="materials">Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="resource-status-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #666;">
                        <span id="resource-count">0</span> resources found
                    </p>
                </div>
                
                <!-- Resources Grid -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Select</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Resource</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">SKU</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Category</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Price</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Qty</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="enhanced-resources-list">
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="selected-count">0</span> resources selected
                            <button onclick="window.selectAllFilteredResources()" style="margin-left: 1rem;" class="secondary">Select All Visible</button>
                            <button onclick="window.clearResourceSelection()" style="margin-left: 0.5rem;" class="secondary">Clear Selection</button>
                        </div>
                        <div>
                            <button onclick="window.addSelectedResourcesToQuote()" disabled id="add-selected-btn">Add Selected to Quote</button>
                            <button onclick="window.closeEnhancedResourceModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.2: Bulk Operations Modals -->
        <div id="bulk-quantity-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkQuantityModal()">&times;</span>
                <h2>📊 Update Quantities</h2>
                <p>Update quantities for <span id="bulk-qty-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Operation:</label>
                    <select id="bulk-qty-operation" style="width: 100%; margin-bottom: 1rem;">
                        <option value="set">Set all to specific value</option>
                        <option value="multiply">Multiply by factor</option>
                        <option value="add">Add to current</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Value:</label>
                    <input type="number" id="bulk-qty-value" min="0" step="1" placeholder="Enter value" style="width: 100%;">
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkQuantityUpdate()" style="background: #3b82f6; color: white;">Apply Changes</button>
                    <button onclick="window.closeBulkQuantityModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <div id="bulk-discount-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkDiscountModal()">&times;</span>
                <h2>💰 Apply Discount</h2>
                <p>Apply discount to <span id="bulk-discount-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Type:</label>
                    <select id="bulk-discount-type" style="width: 100%; margin-bottom: 1rem;">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (£)</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Value:</label>
                    <input type="number" id="bulk-discount-value" min="0" step="0.01" placeholder="Enter discount" style="width: 100%;">
                    
                    <p style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                        Note: Discount will be applied to unit prices
                    </p>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkDiscount()" style="background: #10b981; color: white;">Apply Discount</button>
                    <button onclick="window.closeBulkDiscountModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.3: Template Creation/Edit Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="window.closeTemplateModal()">&times;</span>
                <h2 id="template-modal-title">Create Quote Template</h2>
                
                <input type="hidden" id="template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="template-name" placeholder="e.g. Standard Office Lighting" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="template-category" required>
                                <option value="">Select category...</option>
                                <option value="electrical">Electrical</option>
                                <option value="lighting">Lighting</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="installation">Installation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                            <label>Default VAT Rate (%)</label>
                            <input type="number" id="template-vat-rate" value="20.00" step="0.01" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <!-- Template Default Terms -->
                <div style="margin-bottom: 1.5rem;">
                    <label>Default Terms & Conditions</label>
                    <textarea id="template-terms" rows="3" placeholder="Default terms for quotes created from this template...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                </div>
                
                <!-- Template Items Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Items</h4>
                    <div id="template-items-preview" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                        <p style="margin: 0; color: #666; text-align: center;">Create template from current quote items or add items manually</p>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button onclick="window.addItemsToTemplate()" class="secondary">+ Add Items to Template</button>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveTemplate()">Save Template</button>
                    <button onclick="window.closeTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Template Creation/Edit Modal -->
        <div id="activity-template-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="window.closeActivityTemplateModal()">&times;</span>
                <h2 id="activity-template-modal-title">Create Activity Template</h2>
                
                <input type="hidden" id="activity-template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="activity-template-name" placeholder="e.g. Standard Site Survey" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="activity-template-category" required>
                                <option value="">Select category...</option>
                                <option value="survey">Survey</option>
                                <option value="installation">Installation</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="activity-template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                </div>
                
                <!-- Activity Details -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Activity Configuration</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Priority *</label>
                            <select id="activity-template-priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label>Duration (hours)</label>
                            <input type="number" id="activity-template-duration" step="0.5" min="0.5" placeholder="2.0">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="activity-template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-assignment Rules -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Auto-assignment & Scheduling</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Default Assigned To</label>
                            <input type="text" id="activity-template-assigned-to" placeholder="e.g. Mike Johnson">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">Leave empty for manual assignment</p>
                        </div>
                        <div>
                            <label>Auto-schedule (days from PC creation)</label>
                            <input type="number" id="activity-template-schedule-offset" min="0" placeholder="1">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">0 = same day, 1 = next day, etc.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Template Instructions -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Instructions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Pre-activity Checklist</label>
                            <textarea id="activity-template-checklist" rows="3" placeholder="• Confirm appointment with client
• Prepare tools and equipment
• Review site access instructions"></textarea>
                        </div>
                        <div>
                            <label>Completion Notes Template</label>
                            <textarea id="activity-template-completion-notes" rows="3" placeholder="Activity completed successfully.

Key findings:
•

Next steps:
•"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveActivityTemplate()">Save Template</button>
                    <button onclick="window.closeActivityTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

    <div id="add-resource-modal" class="modal"><div class="modal-content" style="max-width: 500px;">
        <h2>Add item to Price List</h2>
        <label>Select Resource *</label><select id="modal-resource-item-select"></select>
        <div id="resource-info" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa;"></div>
        <label>Client Price (£) *</label><input type="number" id="modal-client-price" step="0.01" min="0" oninput="window.calculateMargin()">
        <div id="margin-info" style="margin-top: 0.5rem;"></div>
        <div class="form-actions">
             <button onclick="window.addResourceToPriceList()">Add to Price List</button>
            <button onclick="window.closeAddResourceModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.3: Activity Resource Selector Modal -->
    <div id="activity-resource-selector-modal" class="modal"><div class="modal-content" style="max-width: 900px;">
        <h2>🔧 Select Resources for Activity</h2>
        
        <!-- Resource Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">

                <select id="resource-selector-type-filter" onchange="window.filterActivityResourceSelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Types</option>
                    <option value="equipment">Equipment</option>
                    <option value="vehicle">Vehicles</option>
                    <option value="material">Materials</option>
                    <option value="tool">Tools</option>
                </select>
            </div>
        </div>

        <!-- Resource Selection Grid -->
        <div id="resource-selector-grid" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Resources will be populated here -->
        </div>

        <!-- Selected Resources Summary -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Selected Resources:</div>
            <div id="resource-selector-summary" style="font-size: 0.875rem; color: #166534;">
                No resources selected
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmActivityResourceSelection()" class="primary">Confirm Selection</button>
            <button onclick="window.closeActivityResourceSelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.4: Dependency Selector Modal -->
    <div id="dependency-selector-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2>🔗 Select Activity Dependencies</h2>
        
        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div id="dependency-selector-info" style="font-size: 0.875rem; color: #0c4a6e;">
                <!-- Information about dependency type will be shown here -->
            </div>
        </div>
        
        <!-- Activity Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">

                <select id="dependency-selector-status-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="dependency-selector-pc-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All PC Numbers</option>
                    <!-- PC options will be populated -->
                </select>
            </div>
        </div>

        <!-- Activity Selection List -->
        <div id="dependency-selector-list" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Activities will be populated here -->
        </div>

        <!-- Dependency Type Options -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Dependency Type:</div>
            <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-start" checked>
                    Finish-to-Start (Default)
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="start-to-start">
                    Start-to-Start
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-finish">
                    Finish-to-Finish
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmDependencySelection()" class="primary">Add Dependency</button>
            <button onclick="window.closeDependencySelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- Price List Edit Modal -->
    <div id="pricelist-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 id="pricelist-modal-title">Edit Price List</h2>
            <form id="pricelist-form">
                <input type="hidden" id="pricelist-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div>
                            <label>Price List Name *</label>
                            <input type="text" id="pricelist-name" required placeholder="Office Relocation - Small Business">
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="pricelist-category" required>
                                <option value="">Select...</option>
                                <option value="Office Relocation">Office Relocation</option>
                                <option value="Equipment & Materials">Equipment & Materials</option>
                                <option value="Emergency Services">Emergency Services</option>
                                <option value="Specialist Services">Specialist Services</option>
                                <option value="Storage & Logistics">Storage & Logistics</option>
                            </select>
                        </div>
                        <div>
                            <label>Region</label>
                            <select id="pricelist-region">
                                <option value="">Select...</option>
                                <option value="London & M25">London & M25</option>
                                <option value="London & Home Counties">London & Home Counties</option>
                                <option value="UK National">UK National</option>
                                <option value="UK & Europe">UK & Europe</option>
                                <option value="Local Area">Local Area</option>
                            </select>
                        </div>
                        <div>
                            <label>Currency</label>
                            <select id="pricelist-currency">
                                <option value="GBP">GBP (£)</option>
                                <option value="EUR">EUR (€)</option>
                                <option value="USD">USD ($)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="pricelist-description" rows="3" placeholder="Detailed description of this price list and its intended use..."></textarea>
                    </div>
                </div>
                
                <!-- Validity & Status -->
                <div class="form-section">
                    <h3>Validity & Status</h3>
                    <div class="form-grid">
                        <div>
                            <label>Valid From</label>
                            <input type="date" id="pricelist-valid-from">
                        </div>
                        <div>
                            <label>Valid Until</label>
                            <input type="date" id="pricelist-valid-until">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="pricelist-status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Items Section (Read-only for now) -->
                <div class="form-section">
                    <h3>Price List Items</h3>
                    <p style="color: #6b7280; font-style: italic; margin-bottom: 1rem;">
                        Note: Individual item editing will be available in a future update. This form updates the price list metadata only.
                    </p>
                    <div id="pricelist-items-preview" style="background: #f9fafb; border-radius: 0.5rem; padding: 1rem; max-height: 200px; overflow-y: auto;">
                        <!-- Items will be displayed here for preview -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit">Update Price List</button>
                    <button type="button" onclick="window.closePriceListModal()" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Price List Item Edit Modal -->
    <div id="pricelist-item-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="pricelist-item-modal-title">Edit Price List Item</h2>
            <form id="pricelist-item-form">
                <input type="hidden" id="pricelist-item-pricelist-id">
                <input type="hidden" id="pricelist-item-index">
                
                <!-- Item Information -->
                <div class="form-section">
                    <h3>Item Details</h3>
                    <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div style="grid-column: 1 / -1;">
                            <label>Description *</label>
                            <input type="text" id="pricelist-item-description" required placeholder="Office desk relocation">
                        </div>
                        <div>
                            <label>Category</label>
                            <select id="pricelist-item-category">
                                <option value="">Select category...</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Labor">Labor</option>
                                <option value="Transport">Transport</option>
                                <option value="Materials">Materials</option>
                                <option value="Storage">Storage</option>
                                <option value="Services">Services</option>
                            </select>
                        </div>
                        <div>
                            <label>Unit</label>
                            <select id="pricelist-item-unit">
                                <option value="each">Each</option>
                                <option value="hour">Hour</option>
                                <option value="day">Day</option>
                                <option value="m3">Cubic Meter</option>
                                <option value="kg">Kilogram</option>
                                <option value="mile">Mile</option>
                                <option value="set">Set</option>
                                <option value="box">Box</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pricing Information -->
                <div class="form-section">
                    <h3>Pricing</h3>
                    <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div>
                            <label>Net Cost (£) *</label>
                            <input type="number" id="pricelist-item-price" required min="0" step="0.01" placeholder="25.00">
                            <small>Cost per unit (excluding VAT)</small>
                        </div>
                        <div>
                            <label>Margin (%)</label>
                            <input type="number" id="pricelist-item-margin" min="0" max="1000" step="0.1" placeholder="20" value="20">
                            <small>Markup percentage</small>
                        </div>
                        <div>
                            <label>Client Price (£)</label>
                            <input type="number" id="pricelist-item-client-price" readonly step="0.01" style="background: #f3f4f6;">
                            <small>Auto-calculated from cost + margin</small>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h3>Additional Information</h3>
                    <div>
                        <label>Notes</label>
                        <textarea id="pricelist-item-notes" rows="3" placeholder="Special requirements, handling notes, etc."></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit">Save Item</button>
                    <button type="button" onclick="window.closePriceListItemModal()" class="secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
</body>
</html>