
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Demo - Portable Version</title>
    
    <style>
        :root {
            --primary-color: #3b82f6; --primary-50: #eff6ff; --primary-100: #dbeafe; --primary-200: #bfdbfe; --primary-300: #93c5fd; --primary-400: #60a5fa; --primary-500: #3b82f6; --primary-600: #2563eb; --primary-700: #1d4ed8; --primary-800: #1e40af; --primary-900: #1e3a8a;
            --secondary-50: #f8fafc; --secondary-100: #f1f5f9; --secondary-200: #e2e8f0; --secondary-300: #cbd5e1; --secondary-400: #94a3b8; --secondary-500: #64748b; --secondary-600: #475569; --secondary-700: #334155; --secondary-800: #1e293b; --secondary-900: #0f172a;
            --success-50: #f0fdf4; --success-100: #dcfce7; --success-200: #bbf7d0; --success-300: #86efac; --success-400: #4ade80; --success-500: #22c55e; --success-600: #16a34a; --success-700: #15803d; --success-800: #166534; --success-900: #14532d;
            --warning-50: #fffbeb; --warning-100: #fef3c7; --warning-200: #fde68a; --warning-300: #fcd34d; --warning-400: #fbbf24; --warning-500: #f59e0b; --warning-600: #d97706; --warning-700: #b45309; --warning-800: #92400e; --warning-900: #78350f;
            --error-50: #fef2f2; --error-100: #fee2e2; --error-200: #fecaca; --error-300: #fca5a5; --error-400: #f87171; --error-500: #ef4444; --error-600: #dc2626; --error-700: #b91c1c; --error-800: #991b1b; --error-900: #7f1d1d;
            --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-300: #cbd5e1; --neutral-400: #94a3b8; --neutral-500: #64748b; --neutral-600: #475569; --neutral-700: #334155; --neutral-800: #1e293b; --neutral-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem; --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem;
            --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem; --space-lg: 1.5rem; --space-xl: 2rem; --space-2xl: 3rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--secondary-50);
            color: var(--neutral-800);
            line-height: 1.6;
            font-size: 14px;
        }
        .navbar { 
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white; 
            padding: 1rem 2rem;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar .nav-left, .navbar .nav-right { display: flex; align-items: center; }
        .navbar h1 { 
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 2rem;
            cursor: pointer;
        }
        .navbar .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 0.5rem 1rem;
            margin: 0 var(--space-xs);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        .navbar .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .navbar .nav-btn.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .container { max-width: 1400px; margin: var(--space-xl) auto; padding: 0 var(--space-lg); }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card { 
            background: white;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }
        .card h2 { margin-bottom: var(--space-lg); color: var(--neutral-900); font-size: 1.5rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-2xl); }
        .stat-card { 
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stat-card.clickable { cursor: pointer; }
        .stat-card h3 { color: var(--neutral-600); font-size: 0.875rem; margin-bottom: var(--space-sm); font-weight: 600; text-transform: uppercase; }
        .stat-card .value { font-size: 2.2rem; font-weight: 700; color: var(--neutral-900); }
        button { 
            background: var(--primary-500);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            cursor: pointer;
            margin-right: var(--space-sm);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        button:hover { background: var(--primary-600); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        button.secondary { background: var(--neutral-200); color: var(--neutral-700); }
        button.secondary:hover { background: var(--neutral-300); }
        button.danger { background: var(--error-500); }
        button.danger:hover { background: var(--error-600); }
        button.warning { background: var(--warning-500); }
        button.warning:hover { background: var(--warning-600); }
        input, select, textarea { 
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 2px var(--primary-100); }
        label { display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--neutral-700); }
        .input-error { border-color: var(--error-500) !important; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius-lg); overflow: hidden; }
        th, td { padding: var(--space-md); text-align: left; border-bottom: 1px solid var(--neutral-200); }
        th { background: var(--neutral-100); font-weight: 600; color: var(--neutral-700); font-size: 0.875rem; text-transform: uppercase; }
        tr:hover td { background: var(--primary-50); }
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000;
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; padding: var(--space-xl); border-radius: var(--radius-lg);
            width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto;
        }
        .quote-builder { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .line-item { display: grid; grid-template-columns: 3fr 1fr 1.5fr 1fr auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .line-item input, .line-item select { margin-bottom: 0; padding: 0.5rem; }
        .remove-btn { background: var(--error-500); padding: 0.5rem; color: white; border: none; cursor: pointer; }
        .summary { background: var(--neutral-100); padding: 1.5rem; border-radius: 8px; position: sticky; top: 100px; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-total { border-top: 2px solid var(--neutral-300); padding-top: 1rem; margin-top: 1rem; font-weight: bold; font-size: 1.2rem; }
        .activity-status {
            display: inline-block; padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-lg); font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .activity-status.draft { background-color: var(--neutral-200); color: var(--neutral-700); }
        .activity-status.ready { background-color: var(--primary-200); color: var(--primary-800); }
        .activity-status.sent { background-color: var(--success-200); color: var(--success-800); }
        .activity-status.cancelled { background-color: var(--error-200); color: var(--error-800); }
        .activity-status.pending { background-color: var(--neutral-200); color: var(--neutral-700); }
        .activity-status.in_progress { background-color: var(--primary-200); color: var(--primary-800); }
        .activity-status.completed { background-color: var(--success-200); color: var(--success-800); }
        
        .priority-low { background: #e2e8f0; color: #475569; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-medium { background: #fbbf24; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-high { background: #f87171; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-urgent { background: #dc2626; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: bold; }
        
        /* Quote Status Styling */
        .quote-status-draft { background: #f3f4f6; color: #374151; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        .quote-status-issued { background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        .quote-status-won { background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; }
        .quote-status-lost { background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        
        .form-section { border: 1px solid var(--neutral-200); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--radius-lg); }
        .form-section h3 { margin-top: 0; border-bottom: 1px solid var(--neutral-200); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .form-actions { margin-top: 1.5rem; text-align: right; }
        .action-btn-group { display: flex; gap: 0.5rem; align-items: center; }
        .action-btn-group button { margin-right: 0; }
        .field-note { font-size: 0.875rem; color: var(--neutral-600); margin-top: 0.5rem; font-style: italic; }
        
        /* Responsive Table */
        @media (max-width: 768px) {
            .navbar { flex-direction: column; gap: 1rem; padding: 1rem; }
            .quote-builder { grid-template-columns: 1fr; }
            .summary { position: static; margin-top: 2rem; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
        }
        
        /* NEW Sprint 4.2: Calendar Styles */
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day-header {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        
        .calendar-day.today {
            background: #eff6ff;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #2563eb;
        }
        
        .calendar-activity {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem 0;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .calendar-activity:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .calendar-activity.priority-high {
            background: #ef4444;
        }
        
        .calendar-activity.priority-urgent {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .calendar-activity.priority-low {
            background: #6b7280;
        }
        
        .calendar-activity.status-completed {
            background: #10b981;
        }
        
        .calendar-activity.status-cancelled {
            background: #f59e0b;
            text-decoration: line-through;
        }
        
        .week-time-slot {
            background: white;
            border: 1px solid #e5e7eb;
            min-height: 60px;
            padding: 0.25rem;
            position: relative;
        }
        
        .week-time-label {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .week-day-header {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            font-weight: 500;
            color: #374151;
        }
        
        .week-day-header.today {
            background: #eff6ff;
            color: #2563eb;
        }

        /* NEW Sprint 4.2.2: Drag & Drop Time Slot Management */
        .time-slot-drop-zone {
            position: relative;
            transition: all 0.2s ease;
        }

        .time-slot-drop-zone:hover {
            background: #f0fdf4 !important;
            border-color: #22c55e !important;
        }

        .time-slot-drop-zone.drag-over {
            background: #dcfce7 !important;
            border: 2px dashed #22c55e !important;
            transform: scale(1.02);
        }

        .calendar-activity.draggable {
            cursor: grab;
            user-select: none;
        }

        .calendar-activity.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
            z-index: 1000;
        }

        .time-slot-create-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .week-time-slot:hover .time-slot-create-hint {
            opacity: 1;
        }

        .week-time-slot.empty {
            background: #fafafa;
            border: 1px dashed #d1d5db;
        }

        .week-time-slot.empty:hover {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .time-conflict-warning {
            background: #fef2f2 !important;
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }

        .quick-create-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .quick-create-form {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 400px;
            max-width: 90vw;
        }

        .time-slot-info {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        /* NEW Sprint 4.2.3: Workload Balancing & Team Assignment */
        .team-filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .team-member-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .team-member-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .team-member-chip.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .team-member-chip.all {
            background: #f3f4f6;
            color: #374151;
        }

        .workload-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid white;
        }

        .workload-low { background: #10b981; }
        .workload-medium { background: #f59e0b; }
        .workload-high { background: #ef4444; }
        .workload-overloaded { background: #dc2626; animation: pulse 2s infinite; }

        .calendar-activity.assigned {
            position: relative;
            border-left: 3px solid transparent;
        }

        .calendar-activity.assigned::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--assignee-color, #6b7280);
        }

        .assignee-avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            margin-right: 0.25rem;
        }

        .workload-panel {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .workload-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .workload-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--member-color, #6b7280);
        }

        .workload-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .workload-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .workload-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .workload-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .assignment-conflict {
            background: #fef2f2 !important;
            border-color: #ef4444 !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* NEW Sprint 4.2.4: Recurring Activities */
        .recurring-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .recurring-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .recurring-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .recurring-options {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .recurring-options.active {
            display: grid;
        }

        .calendar-activity.recurring {
            position: relative;
            border-radius: 0.375rem;
        }

        .calendar-activity.recurring::after {
            content: '🔄';
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 0.6rem;
            line-height: 1;
        }

        .recurring-badge {
            display: inline-flex;
            align-items: center;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .recurring-series-actions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .recurring-series-actions h4 {
            margin: 0 0 0.5rem 0;
            color: #92400e;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .recurring-series-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .recurring-series-buttons button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .recurring-series-buttons button:hover {
            background: #d97706;
        }

        .recurring-series-buttons button.secondary {
            background: #6b7280;
        }

        .recurring-series-buttons button.secondary:hover {
            background: #4b5563;
        }

        .recurring-preview {
            background: #ecfdf5;
            border: 1px solid #22c55e;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        .recurring-preview h5 {
            margin: 0 0 0.5rem 0;
            color: #15803d;
            font-weight: 600;
        }

        .recurring-preview-dates {
            color: #166534;
            line-height: 1.4;
        }

        /* NEW Sprint 4.2.5: Notifications & Reminders */
        .notification-center {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 600px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .notification-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-item.unread {
            background: #fef7ff;
            border-left-color: #a855f7;
        }

        .notification-item.urgent {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .notification-item.warning {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .notification-item.success {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        .notification-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.875rem;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-bell {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s ease-in-out;
            font-size: 1.125rem;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .notification-bell.has-notifications {
            animation: pulse 2s infinite;
        }

        .dashboard-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .dashboard-alert.urgent {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .dashboard-alert.success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #22c55e;
        }

        .dashboard-alert-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
        }

        .dashboard-alert-content {
            flex: 1;
        }

        .dashboard-alert-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #92400e;
        }

        .dashboard-alert.urgent .dashboard-alert-title {
            color: #991b1b;
        }

        .dashboard-alert.success .dashboard-alert-title {
            color: #166534;
        }

        .dashboard-alert-message {
            font-size: 0.8rem;
            color: #78350f;
            line-height: 1.4;
        }

        .dashboard-alert.urgent .dashboard-alert-message {
            color: #7f1d1d;
        }

        .dashboard-alert.success .dashboard-alert-message {
            color: #14532d;
        }

        .upcoming-activities {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .upcoming-activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .upcoming-activity-item:hover {
            background: #f9fafb;
            border-left-color: #3b82f6;
        }

        .upcoming-activity-item.overdue {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .upcoming-activity-item.today {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        .upcoming-activity-item.tomorrow {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        /* NEW Sprint 4.3: Resource Allocation Tracking */
        .resource-allocation-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .resource-allocation-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .resource-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .resource-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .resource-card.equipment {
            border-left: 4px solid #8b5cf6;
        }

        .resource-card.vehicle {
            border-left: 4px solid #06b6d4;
        }

        .resource-card.material {
            border-left: 4px solid #10b981;
        }

        .resource-card.tool {
            border-left: 4px solid #f59e0b;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .resource-name {
            font-weight: 600;
            font-size: 1rem;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .resource-type {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .resource-type.equipment {
            background: #ede9fe;
            color: #7c3aed;
        }

        .resource-type.vehicle {
            background: #cffafe;
            color: #0891b2;
        }

        .resource-type.material {
            background: #d1fae5;
            color: #059669;
        }

        .resource-type.tool {
            background: #fef3c7;
            color: #d97706;
        }

        .resource-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .resource-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .resource-status-indicator.available {
            background: #22c55e;
        }

        .resource-status-indicator.in-use {
            background: #f59e0b;
        }

        .resource-status-indicator.maintenance {
            background: #ef4444;
        }

        .resource-status-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .resource-status-text.available {
            color: #166534;
        }

        .resource-status-text.in-use {
            color: #92400e;
        }

        .resource-status-text.maintenance {
            color: #991b1b;
        }

        .resource-assignments {
            background: white;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .resource-assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .resource-assignment-item:last-child {
            border-bottom: none;
        }

        .assignment-activity {
            flex: 1;
            min-width: 0;
        }

        .assignment-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #111827;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .assignment-details {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .assignment-period {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .resource-utilization {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        .utilization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .utilization-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
        }

        .utilization-percentage {
            font-size: 0.75rem;
            font-weight: 600;
            color: #111827;
        }

        .utilization-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .utilization-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .utilization-fill.low {
            background: #22c55e;
        }

        .utilization-fill.medium {
            background: #f59e0b;
        }

        .utilization-fill.high {
            background: #ef4444;
        }

        .resource-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .resource-action-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .resource-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .resource-action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .resource-action-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .resource-filter-bar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .resource-filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .resource-type-filter {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .resource-type-filter:hover {
            border-color: #9ca3af;
        }

        .resource-type-filter.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .resource-status-filter {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .resource-status-filter:hover {
            border-color: #9ca3af;
        }

        .resource-status-filter.active {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        .resource-conflict-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .conflict-icon {
            color: #ef4444;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .conflict-content {
            flex: 1;
        }

        .conflict-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #991b1b;
            margin-bottom: 0.25rem;
        }

        .conflict-message {
            font-size: 0.75rem;
            color: #7f1d1d;
            line-height: 1.4;
        }

        .resource-calendar-view {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .resource-calendar-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .resource-timeline {
            padding: 1rem;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: #f9fafb;
        }

        .timeline-resource {
            width: 150px;
            flex-shrink: 0;
            padding-right: 1rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .timeline-slots {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .timeline-day {
            height: 40px;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeline-day.available {
            background: #dcfce7;
            color: #166534;
        }

        .timeline-day.partial {
            background: #fef3c7;
            color: #92400e;
        }

        .timeline-day.busy {
            background: #fecaca;
            color: #991b1b;
        }

        .timeline-day:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* NEW Sprint 4.4: Activity Dependencies & Workflow */
        .workflow-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .workflow-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .workflow-canvas {
            min-height: 400px;
            background: #fafbfc;
            position: relative;
            overflow: auto;
            border-radius: 0 0 0.75rem 0.75rem;
        }

        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            min-width: 180px;
            max-width: 220px;
            cursor: move;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .workflow-node:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .workflow-node.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .workflow-node.pending {
            border-color: #6b7280;
        }

        .workflow-node.in-progress {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .workflow-node.completed {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .workflow-node.blocked {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .workflow-node-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .workflow-node-title {
            font-weight: 600;
            font-size: 0.875rem;
            line-height: 1.2;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .workflow-node-status {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            font-weight: 500;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .workflow-node-status.pending {
            background: #f3f4f6;
            color: #374151;
        }

        .workflow-node-status.in-progress {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .workflow-node-status.completed {
            background: #dcfce7;
            color: #166534;
        }

        .workflow-node-status.blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        .workflow-node-details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.3;
        }

        .workflow-node-dates {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.75rem;
        }

        .workflow-node-date {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .workflow-connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .workflow-connection-line {
            stroke: #6b7280;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .workflow-connection-line.critical-path {
            stroke: #ef4444;
            stroke-width: 3;
        }

        .workflow-connection-line.completed {
            stroke: #22c55e;
        }

        .workflow-connection-line.active {
            stroke: #3b82f6;
            stroke-width: 3;
        }

        .workflow-toolbar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .workflow-mode-toggle {
            display: flex;
            gap: 0.25rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .workflow-mode-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 0.25rem;
            background: transparent;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .workflow-mode-btn.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .workflow-action-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .workflow-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .workflow-action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .workflow-action-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .dependency-section {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .dependency-list {
            margin-top: 0.5rem;
        }

        .dependency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .dependency-info {
            flex: 1;
            min-width: 0;
        }

        .dependency-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #111827;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dependency-type {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .dependency-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .dependency-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dependency-action:hover {
            background: #f3f4f6;
        }

        .dependency-action.remove {
            color: #ef4444;
            border-color: #fecaca;
        }

        .dependency-action.remove:hover {
            background: #fef2f2;
        }

        .critical-path-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .workflow-legend {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .legend-indicator {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-indicator.pending {
            background: #6b7280;
        }

        .legend-indicator.in-progress {
            background: #3b82f6;
        }

        .legend-indicator.completed {
            background: #22c55e;
        }

        .legend-indicator.blocked {
            background: #ef4444;
        }

        .legend-indicator.critical {
            background: #ef4444;
            border: 2px solid #dc2626;
        }

        .workflow-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .workflow-stat {
            text-align: center;
        }

        .workflow-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .workflow-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .workflow-minimap {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 200px;
            height: 120px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            overflow: hidden;
        }

        /* NEW Sprint 4.5: Analytics & Reporting */
        .analytics-dashboard {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .analytics-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .analytics-card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .analytics-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .analytics-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .analytics-period-selector {
            display: flex;
            gap: 0.25rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .analytics-period-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 0.25rem;
            background: transparent;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analytics-period-btn.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .analytics-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .analytics-metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .analytics-metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .analytics-metric-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .analytics-metric-change.positive {
            color: #10b981;
        }

        .analytics-metric-change.negative {
            color: #ef4444;
        }

        .analytics-metric-change.neutral {
            color: #6b7280;
        }

        .analytics-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        .analytics-chart {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: end;
            gap: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #fafbfc;
        }

        .analytics-chart-bar {
            background: #3b82f6;
            border-radius: 0.25rem 0.25rem 0 0;
            transition: all 0.3s ease;
            position: relative;
            min-width: 40px;
            cursor: pointer;
        }

        .analytics-chart-bar:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .analytics-chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }

        .analytics-chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 500;
            color: #111827;
            white-space: nowrap;
        }

        .analytics-donut-chart {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .analytics-donut-svg {
            transform: rotate(-90deg);
        }

        .analytics-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .analytics-donut-center-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }

        .analytics-donut-center-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .analytics-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .analytics-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .analytics-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .analytics-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .analytics-table td {
            font-size: 0.875rem;
            color: #111827;
        }

        .analytics-table tr:hover {
            background: #f9fafb;
        }

        .analytics-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .analytics-progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }

        .analytics-heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin: 1rem 0;
        }

        .analytics-heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background: #f3f4f6;
            position: relative;
            cursor: pointer;
        }

        .analytics-heatmap-cell.low {
            background: #dcfce7;
        }

        .analytics-heatmap-cell.medium {
            background: #86efac;
        }

        .analytics-heatmap-cell.high {
            background: #22c55e;
        }

        .analytics-heatmap-cell.very-high {
            background: #16a34a;
        }

        .analytics-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .analytics-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .analytics-filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .analytics-filter-select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .analytics-export-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .analytics-export-btn:hover {
            background: #059669;
        }

        .analytics-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analytics-summary-subtitle {
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .analytics-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .analytics-summary-stat {
            text-align: center;
        }

        .analytics-summary-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .analytics-summary-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <h1 onclick="window.showPage('dashboard')">🏢 CRM Demo</h1>
            <button onclick="window.showPage('dashboard')" class="nav-btn active">Dashboard</button>
            <button onclick="window.showPage('pcnumbers')" class="nav-btn">PC Numbers</button>
            <button onclick="window.showPage('quotes')" class="nav-btn">Quotes</button>
            <button onclick="window.showPage('templates')" class="nav-btn">📄 Quote Templates</button>
            <button onclick="window.showPage('activities')" class="nav-btn">Activities</button>
            <button onclick="window.showPage('activity-templates')" class="nav-btn">📋 Activity Templates</button>
            <button onclick="window.showPage('resources')" class="nav-btn">Resources</button>
            <button onclick="window.showPage('resource-allocation')" class="nav-btn">🔧 Resource Allocation</button>
            <button onclick="window.showPage('analytics')" class="nav-btn">📊 Analytics</button>
            <button onclick="window.showPage('pricelists')" class="nav-btn">Price Lists</button>
        </div>
        <div class="nav-right">
            <!-- NEW Sprint 4.2.5: Notification Bell -->
            <div style="position: relative; margin-right: 1rem;">
                <button id="notification-bell" class="notification-bell" onclick="window.toggleNotificationCenter()">
                    🔔
                    <div id="notification-badge" class="notification-badge" style="display: none;">0</div>
                </button>
            </div>
            <button onclick="window.resetData()" class="nav-btn danger">🗑️ Reset Demo Data</button>
        </div>
    </nav>

    <!-- NEW Sprint 4.2.5: Notification Center -->
    <div id="notification-center" class="notification-center">
        <div class="notification-header">
            <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">🔔 Notifications</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="window.markAllNotificationsRead()" 
                        style="background: none; border: none; color: #6b7280; font-size: 0.75rem; cursor: pointer;">
                    Mark all read
                </button>
                <button onclick="window.toggleNotificationCenter()" 
                        style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #6b7280;">
                    ×
                </button>
            </div>
        </div>
        <div id="notification-list" class="notification-list">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <div class="container">
        <div id="dashboard" class="page active">
            <h1>📊 Dashboard</h1>
            <p>Overview of key metrics in the demonstration system.</p>
            
            <!-- NEW Sprint 4.2.5: Dashboard Alerts -->
            <div id="dashboard-alerts">
                <!-- Dynamic alerts will be populated here -->
            </div>
            
            <!-- NEW Sprint 4.2.5: Upcoming Activities Widget -->
            <div id="upcoming-activities-widget" class="upcoming-activities" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">📅 Upcoming Activities</h3>
                    <button onclick="window.showPage('activities')" 
                            style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                        View All
                    </button>
                </div>
                <div id="upcoming-activities-list">
                    <!-- Upcoming activities will be populated here -->
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card clickable" onclick="window.showPage('pcnumbers')">
                    <h3>PC Numbers</h3>
                    <div class="value" id="stat-pc">0</div>
                </div>
                <div class="stat-card clickable" onclick="window.showPage('quotes')">
                    <h3>Quotes</h3>
                    <div class="value" id="stat-quotes">0</div>
                </div>
                <div class="stat-card clickable" onclick="window.showPage('activities')">
                    <h3>Activities</h3>
                    <div class="value" id="stat-activities">0</div>
                </div>
                <div class="stat-card">
                    <h3>Quote Value</h3>
                    <div class="value" id="stat-value">£0</div>
                </div>
            </div>

             <div class="card">
                <h2>Recent PC Numbers</h2>
                <table>
                    <thead>
                        <tr><th>PC Number</th><th>Company</th><th>Reference</th></tr>
                    </thead>
                    <tbody id="recent-pc"></tbody>
                </table>
            </div>
        </div>

        <div id="pcnumbers" class="page">
            <h1>🔢 PC Numbers</h1>
            <button onclick="window.showPage('new-pc')">+ New PC Number</button>
            <div class="card">
                <h2>PC Numbers List</h2>
                <table>
                    <thead><tr><th>PC Number</th><th>Company</th><th>Reference</th><th>Contact</th><th>Actions</th></tr></thead>
                    <tbody id="pc-list"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pc" class="page">
            <h1 id="pc-form-title">New PC Number</h1>
            <div class="card">
                <input type="hidden" id="pc-id">
                
                <!-- Main Data Section -->
                <div class="form-section">
                    <h3>Main Data</h3>
                    <div class="form-grid">
                        <div><label>PC Number *</label><input type="text" id="pc-number" placeholder="e.g. PC-000001" required></div>
                        <div><label>Company Name *</label><input type="text" id="pc-company-name" placeholder="Company name" required></div>
                        <div><label>Project Name *</label><input type="text" id="pc-project-name" placeholder="Project name" required></div>
                        <div><label>Account Manager *</label><input type="text" id="pc-account-manager" placeholder="Account manager name" required></div>
                        <div><label>Client Industry *</label><select id="pc-client-industry" required>
                            <option value="">Select industry...</option>
                            <option value="Media">Media</option>
                            <option value="Education">Education</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Finance">Finance</option>
                            <option value="Government">Government</option>
                            <option value="Technology">Technology</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Other">Other</option>
                        </select></div>
                        <div><label>Client Source *</label><select id="pc-client-source" required>
                            <option value="">Select source...</option>
                            <option value="Web Enquiry">Web Enquiry</option>
                            <option value="Business Development">Business Development</option>
                            <option value="Existing Customer">Existing Customer</option>
                            <option value="Cross Referral">Cross Referral</option>
                            <option value="Internal (CWS/Crown)">Internal (CWS/Crown)</option>
                        </select></div>
                        <div><label>Quote Limit</label><input type="number" id="pc-quote-limit" min="1" max="20" placeholder="5" value="5"></div>
                        <div><label>Status</label><select id="pc-status">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select></div>
                    </div>
                    <div><label>Project Description</label><textarea id="pc-project-description" rows="3" placeholder="Detailed project description..."></textarea></div>
                </div>
                                
                <!-- Simplified Contact Section -->
                <div class="form-section">
                    <h3>Primary Contact</h3>
                    <div class="form-grid">
                        <div><label>Contact Name *</label><input type="text" id="pc-contact-name" placeholder="Primary contact person" required></div>
                        <div><label>Phone</label><input type="tel" id="pc-contact-phone" placeholder="Phone number"></div>
                        <div><label>Email</label><input type="email" id="pc-contact-email" placeholder="email@address.com"></div>
                        <div><label>Postcode (optional)</label><input type="text" id="pc-postcode" placeholder="e.g. SW1A 1AA"></div>
                    </div>
                    <p class="field-note">* Minimum requirement: Contact name + (Phone OR Email)</p>
                </div>
                
                <div class="form-actions">
                    <button onclick="window.savePC()">Save PC Number</button>
                    <button onclick="window.showPage('pcnumbers')" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="pc-detail" class="page">
            <h1 id="pc-detail-title">PC Details</h1>
            
            <!-- Main Data -->
            <div class="card">
                <h2>Main Project Data</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>PC Number:</strong> <span id="pc-detail-number"></span></div>
                    <div><strong>Company Name:</strong> <span id="pc-detail-company-name"></span></div>
                    <div><strong>Project Name:</strong> <span id="pc-detail-project-name"></span></div>
                    <div><strong>Account Manager:</strong> <span id="pc-detail-account-manager"></span></div>
                    <div><strong>Client Industry:</strong> <span id="pc-detail-client-industry"></span></div>
                    <div><strong>Client Source:</strong> <span id="pc-detail-client-source"></span></div>
                    <div><strong>Quote Limit:</strong> <span id="pc-detail-quote-limit"></span></div>
                    <div><strong>Status:</strong> <span id="pc-detail-status"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Project Description:</strong><br>
                    <span id="pc-detail-project-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editPC(db.currentPC.id)" class="warning">Edit</button>
                    <button onclick="window.createQuote()">Create Quote</button>
                    <button onclick="window.showActivityModal()">Add Activity</button>
                    <button onclick="window.showPage('pcnumbers')" class="secondary">Back to list</button>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="card">
                <h2>Primary Contact</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Contact Name:</strong> <span id="pc-detail-contact-name"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-contact-phone"></span></div>
                    <div><strong>Email:</strong> <span id="pc-detail-contact-email"></span></div>
                    <div><strong>Postcode:</strong> <span id="pc-detail-postcode"></span></div>
                </div>
                <p class="field-note">Note: Detailed addresses are now managed in individual quotes.</p>
            </div>
            <div class="card">
                <h2>Related Quotes</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>Title</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-quotes"></tbody>
                </table>
            </div>
            <div class="card">
                <h2>Related Activities</h2>
                <table>
                     <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-activities"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quotes" class="page">
            <h1>💰 Quotes</h1>
            <button onclick="window.showNewQuoteModal()">+ New Quote</button>
            <div class="card">
                <h2>Quote List</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>PC Number</th><th>Company</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="quotes-list"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quote-builder" class="page">
            <h1 id="quote-builder-title">New Quote</h1>
            <div class="card" id="price-list-selector">
                <h2>Step 1: Select Price List</h2>
                <label>Available Price Lists *</label>
                <select id="quote-price-list" onchange="window.handlePriceListChange()"></select>
            </div>
            <div class="quote-builder" id="quote-items-section" style="display: none;">
                <div class="card">
                    <h2>Step 2: Build Quote</h2>
                    
                    <!-- NEW Sprint 3: Enhanced Resource Lookup -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">🚀 Enhanced Resource Lookup</h4>
                                <p style="margin: 0; color: #666; font-size: 0.875rem;">Search, filter, and add multiple resources quickly</p>
                            </div>
                            <button onclick="window.showEnhancedResourceModal()" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; font-weight: bold;">
                                🔍 Search & Add Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW Sprint 3.2: Bulk Operations Panel -->
                    <div id="bulk-operations-panel" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">🔧 Bulk Operations</h4>
                                <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
                                    <span id="bulk-selected-count">0</span> line items selected
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="window.bulkUpdateQuantity()" style="background: #3b82f6; color: white;">📊 Update Quantities</button>
                                <button onclick="window.bulkApplyDiscount()" style="background: #10b981; color: white;">💰 Apply Discount</button>
                                <button onclick="window.bulkDeleteItems()" style="background: #ef4444; color: white;">🗑️ Delete Selected</button>
                                <button onclick="window.clearBulkSelection()" class="secondary">Clear Selection</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Category Sections -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Human Resources</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('human')" id="select-all-human"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-human"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('human')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('human')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Vehicles</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('vehicles')" id="select-all-vehicles"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-vehicles"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('vehicles')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('vehicles')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Materials</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('materials')" id="select-all-materials"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-materials"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('materials')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('materials')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                     <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Other</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('other')" id="select-all-other"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-other"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('other')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('other')" style="background: #6366f1; color: white;">🔍 Browse & Add</button>
                        </div>
                    </div>
                </div>
                <div class="summary">
                    <h3>Quote Summary</h3>
                    <div class="summary-line"><span>Human Resources:</span><span id="sum-human">£0.00</span></div>
                    <div class="summary-line"><span>Vehicles:</span><span id="sum-vehicles">£0.00</span></div>
                    <div class="summary-line"><span>Materials:</span><span id="sum-materials">£0.00</span></div>
                    <div class="summary-line"><span>Other:</span><span id="sum-other">£0.00</span></div>
                    <div class="summary-line"><span>Net Total:</span><span id="sum-subtotal">£0.00</span></div>
                    <div class="summary-line">
                        <span>VAT Rate:</span>
                        <input type="number" id="quote-vat-rate" value="20.00" step="0.01" min="0" max="100" 
                               style="width: 60px; margin: 0; padding: 0.25rem;" onchange="window.calculateTotal()">%
                    </div>
                    <div class="summary-line"><span>VAT Amount:</span><span id="sum-vat">£0.00</span></div>
                    <div class="summary-total"><span>Total (inc VAT):</span><span id="sum-total">£0.00</span></div>
                    
                    <!-- NEW: Move Type & Addresses Section -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">📦 Move Type & Addresses</h3>
                        
                        <!-- Move Type Selection -->
                        <div style="margin-bottom: 1rem;">
                            <label>Move Type *</label>
                            <select id="quote-move-type" onchange="window.toggleAddressSections()" required>
                                <option value="">Select move type...</option>
                                <option value="Collection Only">Collection Only</option>
                                <option value="Delivery Only">Delivery Only</option>
                                <option value="Collection + Delivery">Collection + Delivery</option>
                            </select>
                        </div>
                        
                        <!-- Collection Address Section -->
                        <div id="collection-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">📍 Collection Address</h4>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-collection-name" placeholder="Contact person"></div>
                                <div><label>Phone</label><input type="tel" id="quote-collection-phone" placeholder="Phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-collection-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-collection-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-collection-address1" placeholder="Street address"></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-collection-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-collection-city" placeholder="City"></div>
                                <div><label>County</label><input type="text" id="quote-collection-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-collection-postcode" placeholder="Postcode"></div>
                            </div>
                        </div>
                        
                        <!-- Delivery Address Section -->
                        <div id="delivery-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">🚚 Delivery Address</h4>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quote-same-address" onchange="window.copyCollectionToDelivery()" style="margin-right: 0.5rem;">
                                    Same as collection address
                                </label>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-delivery-name" placeholder="Contact person"></div>
                                <div><label>Phone</label><input type="tel" id="quote-delivery-phone" placeholder="Phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-delivery-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-delivery-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-delivery-address1" placeholder="Street address"></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-delivery-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-delivery-city" placeholder="City"></div>
                                <div><label>County</label><input type="text" id="quote-delivery-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-delivery-postcode" placeholder="Postcode"></div>
                            </div>
                        </div>
                        
                        <!-- Quoted Activities Section -->
                        <div style="margin-bottom: 1rem;">
                            <label>Quoted Activities (optional)</label>
                            <div id="quote-activities-multiselect" style="border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.375rem; max-height: 120px; overflow-y: auto; background: white;">
                                <p style="margin: 0; color: #666; font-style: italic;">Loading activities for this PC...</p>
                            </div>
                            <p class="field-note">Select activities that are included in this quote pricing</p>
                        </div>
                    </div>
                    
                    <!-- Additional Quote Fields -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Status *</label>
                            <select id="quote-status" onchange="window.handleQuoteStatusChange()" required>
                                <option value="DRAFT">DRAFT - Work in progress (editable)</option>
                                <option value="ISSUED">ISSUED - Sent to client (not editable)</option>
                                <option value="WON">WON - Quote accepted by client</option>
                                <option value="LOST">LOST - Quote lost to competitor</option>
                            </select>
                            <p class="field-note">Note: Once ISSUED, quote cannot be edited. WON/LOST are final states.</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Valid Until *</label>
                            <input type="date" id="quote-valid-until" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Title *</label>
                            <input type="text" id="quote-title" placeholder="Brief quote description" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Description</label>
                            <textarea id="quote-description" rows="2" placeholder="Detailed quote description..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Internal Notes</label>
                            <textarea id="quote-notes" rows="2" placeholder="Internal notes (not visible to client)..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Terms & Conditions</label>
                            <textarea id="quote-terms" rows="3" placeholder="Payment terms, delivery conditions, etc...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="text-align: center;">
                        <button onclick="window.saveQuote()">Save Quote</button>
                        <button onclick="window.saveQuoteAsTemplate()" style="background: #8b5cf6; color: white;">📄 Save as Template</button>
                        <button onclick="window.duplicateCurrentQuote()" style="background: #06b6d4; color: white;">📋 Duplicate Quote</button>
                        <button onclick="window.cancelQuote()" class="secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 3.3: Templates Page -->
        <div id="templates" class="page">
            <h1>📄 Quote Templates</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <p style="margin: 0; color: #666;">Manage reusable quote templates to speed up quote creation</p>
                </div>
                <div>
                    <button onclick="window.showCreateTemplateFromScratch()" style="background: #8b5cf6; color: white;">+ Create New Template</button>
                </div>
            </div>
            
            <!-- Templates Filter & Search -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label>Search Templates</label>
                        <input type="text" id="template-search" placeholder="Search by name or description..." 
                               oninput="window.filterTemplates()" style="width: 100%; margin-top: 0.25rem;">
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="template-category-filter" onchange="window.filterTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All Categories</option>
                            <option value="electrical">Electrical</option>
                            <option value="lighting">Lighting</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="installation">Installation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="template-status-filter" onchange="window.filterTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Templates List -->
            <div class="card">
                <h2>Templates Library</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Template Name</th>
                            <th>Category</th>
                            <th>Items Count</th>
                            <th>Est. Value</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="templates-list">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Templates Page -->
        <div id="activity-templates" class="page">
            <h1>📋 Activity Templates</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <p style="margin: 0; color: #666;">Create reusable activity templates to streamline workflow and ensure consistency</p>
                </div>
                <div>
                    <button onclick="window.showCreateActivityTemplate()" style="background: #8b5cf6; color: white;">+ Create Activity Template</button>
                </div>
            </div>
            
            <!-- Activity Templates Filter & Search -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label>Search Templates</label>
                        <input type="text" id="activity-template-search" placeholder="Search by name or description..." 
                               oninput="window.filterActivityTemplates()" style="width: 100%; margin-top: 0.25rem;">
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="activity-template-category-filter" onchange="window.filterActivityTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All Categories</option>
                            <option value="survey">Survey</option>
                            <option value="installation">Installation</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="testing">Testing</option>
                            <option value="documentation">Documentation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="activity-template-status-filter" onchange="window.filterActivityTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Activity Templates List -->
            <div class="card">
                <h2>Activity Templates Library</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Template Name</th>
                            <th>Category</th>
                            <th>Duration</th>
                            <th>Priority</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activity-templates-list">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="activities" class="page">
            <h1>📋 Activities</h1>
            
            <!-- NEW Sprint 4.2: View Toggle and Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="window.showActivityModal()" style="background: #3b82f6; color: white;">+ New Activity</button>
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="activities-list-view-btn" onclick="window.switchActivitiesView('list')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            📋 List View
                        </button>
                        <button id="activities-calendar-view-btn" onclick="window.switchActivitiesView('calendar')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            📅 Calendar View
                        </button>
                        <button id="activities-workflow-view-btn" onclick="window.switchActivitiesView('workflow')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            🔗 Workflow
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Navigation (hidden by default) -->
                <div id="calendar-navigation" style="display: none; align-items: center; gap: 1rem;">
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="calendar-month-btn" onclick="window.setCalendarView('month')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            Month
                        </button>
                        <button id="calendar-week-btn" onclick="window.setCalendarView('week')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            Week
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.navigateCalendar('prev')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">‹</button>
                        <span id="calendar-title" style="min-width: 200px; text-align: center; font-weight: 500;">October 2024</span>
                        <button onclick="window.navigateCalendar('next')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">›</button>
                        <button onclick="window.navigateCalendar('today')" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white;">Today</button>
                    </div>
                </div>
            </div>
            
            <!-- List View (default) -->
            <div id="activities-list-view" class="card">
                <h2>Activity List</h2>
                <table>
                    <thead><tr><th>Title</th><th>PC Number</th><th>Company</th><th>Type</th><th>Scheduled</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="activities-list"></tbody>
                </table>
            </div>
            
            <!-- NEW Sprint 4.2: Calendar View -->
            <div id="activities-calendar-view" style="display: none;">
                <!-- NEW Sprint 4.2.3: Team Filter Bar -->
                <div class="team-filter-bar">
                    <div style="font-weight: 600; color: #374151; margin-right: 0.5rem;">Filter by Team:</div>
                    <div id="team-filter-chips">
                        <!-- Team member chips will be generated here -->
                    </div>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.toggleWorkloadPanel()" 
                                style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            📊 Workload View
                        </button>
                        <button onclick="window.showTeamManagement()" 
                                style="background: #3b82f6; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            👥 Manage Team
                        </button>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Workload Panel -->
                <div id="workload-panel" class="workload-panel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Team Workload Distribution</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="font-size: 0.875rem; color: #6b7280;">Week of: </span>
                            <span id="workload-week-display" style="font-weight: 500;"></span>
                        </div>
                    </div>
                    <div id="workload-summary" class="workload-summary">
                        <!-- Workload cards will be generated here -->
                    </div>
                </div>
                
                <!-- Month View Calendar -->
                <div id="calendar-month-view" class="card">
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Calendar grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Week View Calendar -->
                <div id="calendar-week-view" class="card" style="display: none;">
                    <div style="display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Week view grid will be generated by JavaScript -->
                        <div style="background: white; padding: 0.5rem; font-weight: 500;"></div>
                        <!-- Time slots and days -->
                        <div id="week-grid-content">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Activity Details Sidebar (for calendar view) -->
                <div id="calendar-activity-sidebar" style="display: none; position: fixed; right: 20px; top: 20px; width: 300px; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">Activity Details</h3>
                        <button onclick="window.closeCalendarSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <div id="calendar-activity-content">
                        <!-- Activity details will be populated here -->
                    </div>
                </div>

                <!-- NEW Sprint 4.2.2: Quick Create Activity Overlay -->
                <div id="quick-create-overlay" class="quick-create-overlay">
                    <div class="quick-create-form">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Quick Create Activity</h3>
                            <button onclick="window.closeQuickCreate()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div id="quick-create-time-info" class="time-slot-info">
                            <!-- Time slot info will be populated here -->
                        </div>

                        <form id="quick-create-form" onsubmit="window.submitQuickCreate(event)">
                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Activity Title *</label>
                                <input type="text" id="quick-activity-title" name="title" required 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-pc" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">PC Number</label>
                                <select id="quick-activity-pc" name="pc_id" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Select PC Number</option>
                                    <!-- PC options will be populated -->
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-assignee" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Assign To</label>
                                <select id="quick-activity-assignee" name="assigned_to" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Unassigned</option>
                                    <!-- Team members will be populated -->
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div>
                                    <label for="quick-activity-priority" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                                    <select id="quick-activity-priority" name="priority" 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-activity-duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Duration (hrs)</label>
                                    <input type="number" id="quick-activity-duration" name="estimated_hours" min="0.25" step="0.25" value="1"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label for="quick-activity-description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="quick-activity-description" name="description" rows="3"
                                          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;"></textarea>
                            </div>

                            <!-- NEW Sprint 4.2.4: Recurring Activities Section -->
                            <div class="recurring-section">
                                <div class="recurring-toggle">
                                    <input type="checkbox" id="quick-recurring-enabled" name="recurring_enabled" onchange="window.toggleRecurringOptions(this)">
                                    <label for="quick-recurring-enabled" style="font-weight: 500; color: #374151;">🔄 Make this a recurring activity</label>
                                </div>
                                
                                <div id="quick-recurring-options" class="recurring-options">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Repeat</label>
                                        <select id="quick-recurring-frequency" name="recurring_frequency" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Every</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="number" id="quick-recurring-interval" name="recurring_interval" min="1" max="365" value="1" 
                                                   style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <span id="quick-recurring-unit" style="font-size: 0.875rem; color: #6b7280;">week(s)</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">End Date</label>
                                        <input type="date" id="quick-recurring-end-date" name="recurring_end_date" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Or Max Occurrences</label>
                                        <input type="number" id="quick-recurring-count" name="recurring_count" min="1" max="365" placeholder="e.g., 10" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                </div>
                                
                                <div id="quick-recurring-preview" class="recurring-preview" style="display: none;">
                                    <!-- Preview will be generated here -->
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button type="button" onclick="window.closeQuickCreate()" 
                                        style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Create Activity
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Team Management Modal -->
                <div id="team-management-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">👥 Team Management</h3>
                            <button onclick="window.closeTeamManagement()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <!-- Add New Team Member Form -->
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Add Team Member</h4>
                            <form id="add-team-member-form" onsubmit="window.addTeamMember(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role</label>
                                        <input type="text" name="role" placeholder="e.g., Engineer, Manager" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                        <input type="email" name="email" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max Hours/Week</label>
                                        <input type="number" name="max_hours" min="1" max="60" value="40" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <button type="submit" 
                                        style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    ➕ Add Member
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Team Members -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Current Team</h4>
                            <div id="team-members-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Team members will be listed here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="window.closeTeamManagement()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.4: Recurring Activity Edit Modal -->
                <div id="recurring-edit-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 450px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">🔄 Edit Recurring Activity</h3>
                            <button onclick="window.closeRecurringEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                                <strong>⚠️ This is part of a recurring series.</strong><br>
                                Choose how you want to apply your changes:
                            </p>
                        </div>
                        
                        <div id="recurring-edit-options" class="recurring-series-buttons" style="margin-bottom: 1.5rem;">
                            <button onclick="window.editRecurringActivity('single')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📝 Edit Only This Activity
                            </button>
                            <button onclick="window.editRecurringActivity('future')" 
                                    style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                📅 Edit This & Future Activities
                            </button>
                            <button onclick="window.editRecurringActivity('all')" 
                                    style="background: #10b981; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                🔄 Edit Entire Series
                            </button>
                        </div>
                        
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 0.875rem; font-weight: 600;">Activity Details:</h4>
                            <div id="recurring-activity-details" style="font-size: 0.875rem; color: #0c4a6e;">
                                <!-- Activity details will be populated here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button onclick="window.closeRecurringEditModal()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="window.deleteRecurringSeries()" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                🗑️ Delete Series
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW Sprint 4.4: Workflow View -->
            <div id="activities-workflow-view" style="display: none;">
                <!-- Workflow Stats Dashboard -->
                <div class="workflow-stats">
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-total-activities">0</div>
                        <div class="workflow-stat-label">Total Activities</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-in-progress">0</div>
                        <div class="workflow-stat-label">In Progress</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-completed">0</div>
                        <div class="workflow-stat-label">Completed</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-blocked">0</div>
                        <div class="workflow-stat-label">Blocked</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-critical-path">0</div>
                        <div class="workflow-stat-label">Critical Path Days</div>
                    </div>
                </div>

                <!-- Workflow Canvas -->
                <div class="workflow-panel">
                    <div class="workflow-header">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">🔗 Activity Dependencies & Workflow</h2>
                        <div class="workflow-toolbar">
                            <div class="workflow-mode-toggle">
                                <button class="workflow-mode-btn active" onclick="window.setWorkflowMode('view')">👁️ View</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('edit')">✏️ Edit</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('connect')">🔗 Connect</button>
                            </div>
                            <button class="workflow-action-btn" onclick="window.autoLayoutWorkflow()">🔄 Auto Layout</button>
                            <button class="workflow-action-btn" onclick="window.calculateCriticalPath()">🚨 Critical Path</button>
                            <button class="workflow-action-btn primary" onclick="window.optimizeWorkflow()">⚡ Optimize</button>
                        </div>
                    </div>
                    
                    <div id="workflow-canvas" class="workflow-canvas">
                        <!-- Workflow nodes and connections will be generated here -->
                        <svg id="workflow-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                                </marker>
                            </defs>
                        </svg>
                        
                        <div id="workflow-nodes-container">
                            <!-- Workflow nodes will be positioned here -->
                        </div>
                        
                        <!-- Workflow minimap -->
                        <div class="workflow-minimap">
                            <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; font-weight: 600; background: #f8fafc;">
                                Workflow Overview
                            </div>
                            <div id="workflow-minimap-content" style="padding: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                <!-- Minimap content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Legend -->
                <div class="workflow-legend">
                    <div class="legend-item">
                        <div class="legend-indicator pending"></div>
                        <span>Pending</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator in-progress"></div>
                        <span>In Progress</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator completed"></div>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator blocked"></div>
                        <span>Blocked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator critical"></div>
                        <span>Critical Path</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="resources" class="page">
            <h1>🔧 Resources</h1>
            <button onclick="window.showResourceModal()">+ New Resource</button>
            <div class="card">
                <h2>Resource Database</h2>
                <table>
                    <thead><tr><th>Name</th><th>SKU</th><th>Category</th><th>Net Cost</th><th>Supplier</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="resources-list"></tbody>
                </table>
            </div>
        </div>

        <div id="pricelists" class="page">
             <h1>🏷️ Price Lists</h1>
            <button onclick="window.showPage('new-pricelist')">+ New Price List</button>
            <div class="card">
                <h2>Available Price Lists</h2>
                <table>
                    <thead><tr><th>Name</th><th>Version</th><th>Currency</th><th>Effective Period</th><th>Default</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pricelist" class="page">
            <h1 id="pricelist-form-title">New Price List</h1>
            <div class="card">
                <input type="hidden" id="pricelist-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div><label>Price List Name *</label><input type="text" id="pricelist-name" placeholder="e.g. Standard Commercial Rates 2024" required></div>
                        <div><label>Version *</label><input type="text" id="pricelist-version" placeholder="e.g. v2.1" required></div>
                        <div><label>Currency</label><select id="pricelist-currency">
                            <option value="GBP" selected>GBP (£)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select></div>
                        <div><label>Status</label><select id="pricelist-status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                        </select></div>
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="pricelist-description" rows="2" placeholder="Brief description of this price list..."></textarea>
                    </div>
                </div>
                
                <!-- Pricing Configuration -->
                <div class="form-section">
                    <h3>Pricing Configuration</h3>
                    <div class="form-grid">
                        <div><label>Default Markup (%) *</label><input type="number" id="pricelist-markup" step="0.01" min="0" placeholder="35.00" required></div>
                        <div><label>Discount (%)</label><input type="number" id="pricelist-discount" step="0.01" min="0" max="100" placeholder="0.00"></div>
                        <div><label>Effective From *</label><input type="date" id="pricelist-effective-from" required></div>
                        <div><label>Effective Until</label><input type="date" id="pricelist-effective-to"></div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="pricelist-is-default" style="margin-right: 0.5rem;">
                            Set as default price list
                        </label>
                    </div>
                </div>
                
                <!-- Terms & Conditions -->
                <div class="form-section">
                    <h3>Terms & Conditions</h3>
                    <div>
                        <label>Default Terms</label>
                        <textarea id="pricelist-terms" rows="3" placeholder="Pricing terms, payment conditions, delivery notes...">Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.</textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="window.createPriceList()">Create Price List</button>
                    <button onclick="window.showPage('pricelists')" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="pricelist-detail" class="page">
            <h1 id="pricelist-title">Price List Details</h1>
             <div class="card">
                <button onclick="window.showAddResourceToPriceList()">+ Add Item to Price List</button>
                <button onclick="window.showPage('pricelists')" class="secondary">Back to list</button>
            </div>
            <div class="card">
                <h2>Price List Items</h2>
                <table>
                    <thead><tr><th>Resource</th><th>Net Cost</th><th>Client Price</th><th>Margin %</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-items"></tbody>
                </table>
            </div>
        </div>

        <!-- NEW Sprint 4.3: Resource Allocation Tracking Page -->
        <div id="resource-allocation" class="page">
            <h1>🔧 Resource Allocation Tracking</h1>
            <p>Track and manage allocation of equipment, vehicles, materials, and tools across activities.</p>
            
            <!-- Resource Filter Bar -->
            <div class="resource-filter-bar">
                <div class="resource-filter-group">
                    <span class="filter-label">Type:</span>
                    <button class="resource-type-filter active" onclick="window.filterResourcesByType('all')">All</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('equipment')">Equipment</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('vehicle')">Vehicles</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('material')">Materials</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('tool')">Tools</button>
                </div>
                <div class="resource-filter-group">
                    <span class="filter-label">Status:</span>
                    <button class="resource-status-filter active" onclick="window.filterResourcesByStatus('all')">All</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('available')">Available</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('in-use')">In Use</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('maintenance')">Maintenance</button>
                </div>
                <div style="flex: 1;"></div>
                <button onclick="window.showResourceCalendarView()" class="resource-action-btn primary">
                    📅 Calendar View
                </button>
            </div>

            <!-- Resource Allocation Cards -->
            <div class="resource-allocation-panel">
                <div class="resource-allocation-header">
                    <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">📋 Resource Overview</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="resource-count" style="font-size: 0.875rem; color: #6b7280;">0 resources</span>
                        <button onclick="window.refreshResourceAllocation()" class="resource-action-btn">🔄 Refresh</button>
                    </div>
                </div>
                <div id="resource-allocation-grid" class="resource-grid">
                    <!-- Resource cards will be populated here -->
                </div>
            </div>

            <!-- Resource Calendar Timeline View -->
            <div id="resource-calendar-view" class="resource-calendar-view" style="display: none;">
                <div class="resource-calendar-header">
                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">📅 Resource Schedule Timeline</h3>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <button onclick="window.navigateResourceWeek(-1)" class="resource-action-btn">← Previous</button>
                        <span id="resource-week-display" style="font-weight: 500;">Current Week</span>
                        <button onclick="window.navigateResourceWeek(1)" class="resource-action-btn">Next →</button>
                        <button onclick="window.hideResourceCalendarView()" class="resource-action-btn">✕ Close</button>
                    </div>
                </div>
                <div id="resource-timeline" class="resource-timeline">
                    <!-- Timeline rows will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <div id="analytics" class="page">
        <h1>📊 Analytics & Reporting</h1>
        
        <!-- Analytics Summary Card -->
        <div class="analytics-summary-card">
            <div class="analytics-summary-title">Project Performance Overview</div>
            <div class="analytics-summary-subtitle">Real-time insights into your team's performance and project metrics</div>
            <div class="analytics-summary-stats">
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-total-activities">0</div>
                    <div class="analytics-summary-stat-label">Total Activities</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-completion-rate">0%</div>
                    <div class="analytics-summary-stat-label">Completion Rate</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-avg-duration">0h</div>
                    <div class="analytics-summary-stat-label">Avg Duration</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-team-utilization">0%</div>
                    <div class="analytics-summary-stat-label">Team Utilization</div>
                </div>
            </div>
        </div>

        <!-- Analytics Filters -->
        <div class="analytics-filters">
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Time Period</label>
                <select id="analytics-period-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Team Member</label>
                <select id="analytics-team-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="">All Team Members</option>
                    <!-- Options populated by JavaScript -->
                </select>
            </div>
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Activity Type</label>
                <select id="analytics-type-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="">All Types</option>
                    <option value="installation">Installation</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inspection">Inspection</option>
                    <option value="consultation">Consultation</option>
                    <option value="training">Training</option>
                </select>
            </div>
            <div style="margin-left: auto;">
                <button class="analytics-export-btn" onclick="window.exportAnalyticsReport()">📊 Export Report</button>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="analytics-dashboard">
            <!-- Activity Performance Chart -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">📈 Activity Performance</h3>
                    <div class="analytics-period-selector">
                        <button class="analytics-period-btn active" onclick="window.setChartPeriod('week', this)">Week</button>
                        <button class="analytics-period-btn" onclick="window.setChartPeriod('month', this)">Month</button>
                        <button class="analytics-period-btn" onclick="window.setChartPeriod('quarter', this)">Quarter</button>
                    </div>
                </div>
                <div class="analytics-chart-container">
                    <div id="activity-performance-chart" class="analytics-chart">
                        <!-- Chart bars will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Team Performance -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">👥 Team Performance</h3>
                </div>
                <div id="team-performance-metrics" class="analytics-metrics-grid">
                    <!-- Team metrics will be populated here -->
                </div>
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Team Member</th>
                            <th>Activities</th>
                            <th>Completion Rate</th>
                            <th>Avg Duration</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="team-performance-table">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Activity Status Distribution -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">📊 Activity Status Distribution</h3>
                </div>
                <div class="analytics-donut-chart">
                    <svg width="200" height="200" class="analytics-donut-svg">
                        <circle cx="100" cy="100" r="80" stroke="#e5e7eb" stroke-width="20" fill="transparent"/>
                        <circle id="donut-pending" cx="100" cy="100" r="80" stroke="#6b7280" stroke-width="20" fill="transparent"/>
                        <circle id="donut-in-progress" cx="100" cy="100" r="80" stroke="#3b82f6" stroke-width="20" fill="transparent"/>
                        <circle id="donut-completed" cx="100" cy="100" r="80" stroke="#22c55e" stroke-width="20" fill="transparent"/>
                    </svg>
                    <div class="analytics-donut-center">
                        <div class="analytics-donut-center-value" id="donut-total">0</div>
                        <div class="analytics-donut-center-label">Total</div>
                    </div>
                </div>
                <div class="analytics-legend">
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #6b7280;"></div>
                        <span id="legend-pending">Pending (0)</span>
                    </div>
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #3b82f6;"></div>
                        <span id="legend-in-progress">In Progress (0)</span>
                    </div>
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #22c55e;"></div>
                        <span id="legend-completed">Completed (0)</span>
                    </div>
                </div>
            </div>

            <!-- Time Tracking Analytics -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">⏱️ Time Tracking Analytics</h3>
                </div>
                <div class="analytics-metrics-grid">
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="total-hours-logged">0</div>
                        <div class="analytics-metric-label">Hours Logged</div>
                        <div class="analytics-metric-change neutral" id="hours-change">No change</div>
                    </div>
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="avg-activity-duration">0h</div>
                        <div class="analytics-metric-label">Avg Duration</div>
                        <div class="analytics-metric-change neutral" id="duration-change">No change</div>
                    </div>
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="overdue-activities">0</div>
                        <div class="analytics-metric-label">Overdue</div>
                        <div class="analytics-metric-change negative" id="overdue-change">0 overdue</div>
                    </div>
                </div>
            </div>

            <!-- Resource Utilization -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">🔧 Resource Utilization</h3>
                </div>
                <div id="resource-utilization-list">
                    <!-- Resource utilization items will be populated here -->
                </div>
            </div>

            <!-- Activity Heatmap -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">🗓️ Activity Heatmap (Last 30 Days)</h3>
                </div>
                <div id="activity-heatmap" class="analytics-heatmap">
                    <!-- Heatmap cells will be generated here -->
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                    <span>Less</span>
                    <div style="display: flex; gap: 2px;">
                        <div class="analytics-heatmap-cell"></div>
                        <div class="analytics-heatmap-cell low"></div>
                        <div class="analytics-heatmap-cell medium"></div>
                        <div class="analytics-heatmap-cell high"></div>
                        <div class="analytics-heatmap-cell very-high"></div>
                    </div>
                    <span>More</span>
                </div>
            </div>
        </div>
    </div>

    <div id="quote-modal" class="modal"><div class="modal-content">
        <h2>Select PC Number for new quote</h2>
        <label>PC Number *</label>
        <select id="quote-modal-pc"></select>
        <div class="form-actions">
            <button onclick="window.proceedToQuoteBuilder()">Continue</button>
            <button onclick="window.closeQuoteModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <div id="activity-modal" class="modal"><div class="modal-content">
        <h2 id="activity-modal-title">New Activity</h2>
        <input type="hidden" id="activity-id">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <h3>Basic Information</h3>
        <div class="form-grid">
                <div><label>PC Number *</label><select id="activity-pc-select"></select></div>
                <div><label>Activity Type *</label><input type="text" id="activity-type" placeholder="e.g. Survey, Delivery, Installation"></div>
                <div><label>Priority</label><select id="activity-priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select></div>
                <div><label>Status</label><select id="activity-status">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select></div>
        </div>
            <div>
                <label>Activity Title *</label>
                <input type="text" id="activity-title" placeholder="Brief description of the activity" required>
            </div>
            <div>
                <label>Description</label>
                <textarea id="activity-description" rows="2" placeholder="Detailed activity description..."></textarea>
            </div>
        </div>
        
        <!-- Scheduling Section -->
        <div class="form-section">
            <h3>Scheduling</h3>
            <div class="form-grid">
                <div><label>Scheduled Date</label><input type="date" id="activity-scheduled-date"></div>
                <div><label>Scheduled Time</label><input type="time" id="activity-scheduled-time"></div>
                <div><label>Duration (hours)</label><input type="number" id="activity-duration" step="0.5" min="0" placeholder="e.g. 2.5"></div>
                <div><label>Assigned To</label><input type="text" id="activity-assigned-to-name" placeholder="Person responsible"></div>
            </div>
        </div>
        
        <!-- Location & Contact Section -->
        <div class="form-section">
            <h3>Location & Contact</h3>
            <div class="form-grid">
                <div><label>Location</label><input type="text" id="activity-location" placeholder="e.g. Client Site - Birmingham"></div>
                <div><label>Contact Name</label><input type="text" id="activity-contact-name" placeholder="Site contact person"></div>
                <div><label>Contact Phone</label><input type="tel" id="activity-contact-phone" placeholder="Contact phone number"></div>
            </div>
        </div>
        
        <!-- Completion Section (shown only for completed activities) -->
        <div class="form-section" id="activity-completion-section" style="display: none;">
            <h3>Completion Details</h3>
            <div>
                <label>Completion Notes</label>
                <textarea id="activity-completion-notes" rows="3" placeholder="Notes about the completed activity..."></textarea>
            </div>
        </div>
        
        <!-- NEW Sprint 4.3: Resource Allocation Section -->
        <div class="form-section">
            <h3>Resource Allocation</h3>
            <div style="margin-bottom: 1rem;">
                <label>Required Resources</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showActivityResourceSelector()" class="resource-action-btn primary">
                        🔧 Select Resources
                    </button>
                    <button type="button" onclick="window.checkResourceAvailability()" class="resource-action-btn">
                        ✓ Check Availability
                    </button>
                </div>
            </div>
            <div id="activity-resources-list" style="background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; min-height: 60px;">
                <div id="activity-resources-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                    No resources selected. Click "Select Resources" to add equipment, vehicles, materials, or tools.
                </div>
                <div id="activity-resources-items" style="display: none;">
                    <!-- Selected resources will be populated here -->
                </div>
            </div>
            <div id="activity-resource-conflicts" style="display: none;">
                <!-- Resource conflicts will be shown here -->
            </div>
        </div>
        
        <!-- NEW Sprint 4.4: Dependencies Section -->
        <div class="form-section">
            <h3>Activity Dependencies</h3>
            <div style="margin-bottom: 1rem;">
                <label>Dependencies & Workflow</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showDependencySelector('predecessor')" class="resource-action-btn primary">
                        ⬅️ Add Predecessor
                    </button>
                    <button type="button" onclick="window.showDependencySelector('successor')" class="resource-action-btn">
                        ➡️ Add Successor
                    </button>
                    <button type="button" onclick="window.calculateActivitySchedule()" class="resource-action-btn">
                        📊 Auto Schedule
                    </button>
                </div>
            </div>
            
            <!-- Predecessors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">⬅️ Predecessors (Must complete before this activity)</div>
                <div id="activity-predecessors-list" class="dependency-list">
                    <div id="activity-predecessors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No predecessors defined. This activity can start immediately.
                    </div>
                </div>
            </div>
            
            <!-- Successors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">➡️ Successors (Will start after this activity)</div>
                <div id="activity-successors-list" class="dependency-list">
                    <div id="activity-successors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No successors defined. This activity has no dependent activities.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveActivity()">Save Activity</button>
            <button onclick="window.saveActivityAsTemplate()" style="background: #8b5cf6; color: white;">📋 Save as Template</button>
            <button onclick="window.closeActivityModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <div id="resource-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2 id="resource-modal-title">New Resource</h2>
        <input type="hidden" id="resource-id">
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-grid">
                <div><label>Resource Name *</label><input type="text" id="resource-name" placeholder="e.g. LED Downlight - 10W Cool White" required></div>
                <div><label>SKU</label><input type="text" id="resource-sku" placeholder="e.g. LED-DL-10W-CW"></div>
                <div><label>Category *</label><select id="resource-category" required>
                    <option value="">Select...</option>
                    <option value="lighting">Lighting</option>
                    <option value="electrical">Electrical</option>
                    <option value="labour">Labour</option>
                    <option value="transport">Transport</option>
                    <option value="materials">Materials</option>
                    <option value="other">Other</option>
                </select></div>
                <div><label>Subcategory</label><input type="text" id="resource-subcategory" placeholder="e.g. downlights, cable"></div>
            </div>
            <div>
                <label>Description</label>
                <textarea id="resource-description" rows="2" placeholder="Detailed resource description..."></textarea>
            </div>
        </div>
        
        <!-- Pricing & Units -->
        <div class="form-section">
            <h3>Pricing & Units</h3>
            <div class="form-grid">
                <div><label>Net Cost (£) *</label><input type="number" id="resource-cost" step="0.01" min="0" placeholder="25.00" required></div>
                <div><label>Unit *</label><select id="resource-unit" required>
                    <option value="">Select...</option>
                    <option value="each">Each</option>
                    <option value="metre">Metre</option>
                    <option value="hour">Hour</option>
                    <option value="day">Day</option>
                    <option value="kg">Kilogram</option>
                    <option value="m2">Square Metre</option>
                </select></div>
                <div><label>Min Quantity</label><input type="number" id="resource-min-quantity" min="1" placeholder="10"></div>
                <div><label>Lead Time (days)</label><input type="number" id="resource-lead-time" min="0" placeholder="5"></div>
            </div>
        </div>
        
        <!-- Supplier Information -->
        <div class="form-section">
            <h3>Supplier Information</h3>
            <div class="form-grid">
                <div><label>Supplier</label><input type="text" id="resource-supplier" placeholder="e.g. Electrical Supplies Ltd"></div>
                <div><label>Supplier Code</label><input type="text" id="resource-supplier-code" placeholder="e.g. ESL-LED-001"></div>
                <div><label>Warranty (months)</label><input type="number" id="resource-warranty" min="0" placeholder="24"></div>
                <div><label>Status</label><select id="resource-status">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select></div>
            </div>
        </div>
        
        <!-- Physical Properties -->
        <div class="form-section">
            <h3>Physical Properties</h3>
            <div class="form-grid">
                <div><label>Weight (kg)</label><input type="number" id="resource-weight" step="0.001" min="0" placeholder="0.150"></div>
                <div><label>Dimensions</label><input type="text" id="resource-dimensions" placeholder="e.g. 85mm diameter x 25mm depth"></div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveResource()">Save Resource</button>
            <button onclick="window.closeResourceModal()" class="secondary">Cancel</button>
        </div>
    </div>        </div>

        <!-- NEW Sprint 3: Enhanced Resource Lookup Modal -->
        <div id="enhanced-resource-lookup-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="window.closeEnhancedResourceModal()">&times;</span>
                <h2>🔍 Add Resources to Quote</h2>
                
                <!-- Search & Filter Section -->
                <div style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.75rem; align-items: center;">
                        <div>
                            <label>Search Resources</label>
                            <input type="text" id="resource-search" placeholder="Search by name, SKU, or description..." 
                                   oninput="window.filterResources()" style="width: 100%; margin-top: 0.25rem;">
                        </div>
                        <div>
                            <label>Category</label>
                            <select id="resource-category-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Categories</option>
                                <option value="human">Human Resources</option>
                                <option value="vehicles">Vehicles</option>
                                <option value="materials">Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="resource-status-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #666;">
                        <span id="resource-count">0</span> resources found
                    </p>
                </div>
                
                <!-- Resources Grid -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Select</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Resource</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">SKU</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Category</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Price</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Qty</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="enhanced-resources-list">
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="selected-count">0</span> resources selected
                            <button onclick="window.selectAllFilteredResources()" style="margin-left: 1rem;" class="secondary">Select All Visible</button>
                            <button onclick="window.clearResourceSelection()" style="margin-left: 0.5rem;" class="secondary">Clear Selection</button>
                        </div>
                        <div>
                            <button onclick="window.addSelectedResourcesToQuote()" disabled id="add-selected-btn">Add Selected to Quote</button>
                            <button onclick="window.closeEnhancedResourceModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.2: Bulk Operations Modals -->
        <div id="bulk-quantity-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkQuantityModal()">&times;</span>
                <h2>📊 Update Quantities</h2>
                <p>Update quantities for <span id="bulk-qty-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Operation:</label>
                    <select id="bulk-qty-operation" style="width: 100%; margin-bottom: 1rem;">
                        <option value="set">Set all to specific value</option>
                        <option value="multiply">Multiply by factor</option>
                        <option value="add">Add to current</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Value:</label>
                    <input type="number" id="bulk-qty-value" min="0" step="1" placeholder="Enter value" style="width: 100%;">
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkQuantityUpdate()" style="background: #3b82f6; color: white;">Apply Changes</button>
                    <button onclick="window.closeBulkQuantityModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <div id="bulk-discount-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkDiscountModal()">&times;</span>
                <h2>💰 Apply Discount</h2>
                <p>Apply discount to <span id="bulk-discount-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Type:</label>
                    <select id="bulk-discount-type" style="width: 100%; margin-bottom: 1rem;">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (£)</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Value:</label>
                    <input type="number" id="bulk-discount-value" min="0" step="0.01" placeholder="Enter discount" style="width: 100%;">
                    
                    <p style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                        Note: Discount will be applied to unit prices
                    </p>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkDiscount()" style="background: #10b981; color: white;">Apply Discount</button>
                    <button onclick="window.closeBulkDiscountModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.3: Template Creation/Edit Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="window.closeTemplateModal()">&times;</span>
                <h2 id="template-modal-title">Create Quote Template</h2>
                
                <input type="hidden" id="template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="template-name" placeholder="e.g. Standard Office Lighting" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="template-category" required>
                                <option value="">Select category...</option>
                                <option value="electrical">Electrical</option>
                                <option value="lighting">Lighting</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="installation">Installation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                            <label>Default VAT Rate (%)</label>
                            <input type="number" id="template-vat-rate" value="20.00" step="0.01" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <!-- Template Default Terms -->
                <div style="margin-bottom: 1.5rem;">
                    <label>Default Terms & Conditions</label>
                    <textarea id="template-terms" rows="3" placeholder="Default terms for quotes created from this template...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                </div>
                
                <!-- Template Items Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Items</h4>
                    <div id="template-items-preview" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                        <p style="margin: 0; color: #666; text-align: center;">Create template from current quote items or add items manually</p>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button onclick="window.addItemsToTemplate()" class="secondary">+ Add Items to Template</button>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveTemplate()">Save Template</button>
                    <button onclick="window.closeTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Template Creation/Edit Modal -->
        <div id="activity-template-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="window.closeActivityTemplateModal()">&times;</span>
                <h2 id="activity-template-modal-title">Create Activity Template</h2>
                
                <input type="hidden" id="activity-template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="activity-template-name" placeholder="e.g. Standard Site Survey" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="activity-template-category" required>
                                <option value="">Select category...</option>
                                <option value="survey">Survey</option>
                                <option value="installation">Installation</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="activity-template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                </div>
                
                <!-- Activity Details -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Activity Configuration</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Priority *</label>
                            <select id="activity-template-priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label>Duration (hours)</label>
                            <input type="number" id="activity-template-duration" step="0.5" min="0.5" placeholder="2.0">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="activity-template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-assignment Rules -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Auto-assignment & Scheduling</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Default Assigned To</label>
                            <input type="text" id="activity-template-assigned-to" placeholder="e.g. Mike Johnson">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">Leave empty for manual assignment</p>
                        </div>
                        <div>
                            <label>Auto-schedule (days from PC creation)</label>
                            <input type="number" id="activity-template-schedule-offset" min="0" placeholder="1">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">0 = same day, 1 = next day, etc.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Template Instructions -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Instructions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Pre-activity Checklist</label>
                            <textarea id="activity-template-checklist" rows="3" placeholder="• Confirm appointment with client
• Prepare tools and equipment
• Review site access instructions"></textarea>
                        </div>
                        <div>
                            <label>Completion Notes Template</label>
                            <textarea id="activity-template-completion-notes" rows="3" placeholder="Activity completed successfully.

Key findings:
•

Next steps:
•"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveActivityTemplate()">Save Template</button>
                    <button onclick="window.closeActivityTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

    <div id="add-resource-modal" class="modal"><div class="modal-content" style="max-width: 500px;">
        <h2>Add item to Price List</h2>
        <label>Select Resource *</label><select id="modal-resource-item-select"></select>
        <div id="resource-info" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa;"></div>
        <label>Client Price (£) *</label><input type="number" id="modal-client-price" step="0.01" min="0" oninput="window.calculateMargin()">
        <div id="margin-info" style="margin-top: 0.5rem;"></div>
        <div class="form-actions">
             <button onclick="window.addResourceToPriceList()">Add to Price List</button>
            <button onclick="window.closeAddResourceModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.3: Activity Resource Selector Modal -->
    <div id="activity-resource-selector-modal" class="modal"><div class="modal-content" style="max-width: 900px;">
        <h2>🔧 Select Resources for Activity</h2>
        
        <!-- Resource Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <input type="text" id="resource-selector-search" placeholder="Search resources..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                       oninput="window.filterActivityResourceSelector()">
                <select id="resource-selector-type-filter" onchange="window.filterActivityResourceSelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Types</option>
                    <option value="equipment">Equipment</option>
                    <option value="vehicle">Vehicles</option>
                    <option value="material">Materials</option>
                    <option value="tool">Tools</option>
                </select>
            </div>
        </div>

        <!-- Resource Selection Grid -->
        <div id="resource-selector-grid" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Resources will be populated here -->
        </div>

        <!-- Selected Resources Summary -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Selected Resources:</div>
            <div id="resource-selector-summary" style="font-size: 0.875rem; color: #166534;">
                No resources selected
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmActivityResourceSelection()" class="primary">Confirm Selection</button>
            <button onclick="window.closeActivityResourceSelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.4: Dependency Selector Modal -->
    <div id="dependency-selector-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2>🔗 Select Activity Dependencies</h2>
        
        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div id="dependency-selector-info" style="font-size: 0.875rem; color: #0c4a6e;">
                <!-- Information about dependency type will be shown here -->
            </div>
        </div>
        
        <!-- Activity Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <input type="text" id="dependency-selector-search" placeholder="Search activities..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                       oninput="window.filterDependencySelector()">
                <select id="dependency-selector-status-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="dependency-selector-pc-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All PC Numbers</option>
                    <!-- PC options will be populated -->
                </select>
            </div>
        </div>

        <!-- Activity Selection List -->
        <div id="dependency-selector-list" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Activities will be populated here -->
        </div>

        <!-- Dependency Type Options -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Dependency Type:</div>
            <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-start" checked>
                    Finish-to-Start (Default)
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="start-to-start">
                    Start-to-Start
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-finish">
                    Finish-to-Finish
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmDependencySelection()" class="primary">Add Dependency</button>
            <button onclick="window.closeDependencySelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

<script>
// =================================================================
// CRM Demo - Portable Version with IndexedDB
// =================================================================

/**
 * @fileoverview CRM System Configuration & Core Setup
 * @version 2.0.0
 * @author MF CRM Team
 */

// ========================================
// GLOBAL CONFIGURATION
// ========================================

/**
 * @namespace CONFIG
 * @description Centralized configuration for the entire CRM system
 */
const CONFIG = {
    // Database Configuration
    DATABASE: {
        NAME: 'MF_CRM_Database',
        VERSION: 3, // Incremented for activity templates store
        STORES: {
            PCS: 'pcs',
            QUOTES: 'quotes', 
            ACTIVITIES: 'activities',
            RESOURCES: 'resources',
            PRICE_LISTS: 'price_lists',
            TEMPLATES: 'templates',
            ACTIVITY_TEMPLATES: 'activity_templates'
        }
    },

    // Business Rules & Defaults
    BUSINESS: {
        DEFAULT_VAT_RATE: 20.0,
        DEFAULT_MARKUP_PERCENTAGE: 35.00,
        DEFAULT_QUOTE_VALIDITY_DAYS: 30,
        DEFAULT_QUOTE_LIMIT: 5,
        MAX_RECURRING_OCCURRENCES: 365,
        DEFAULT_ACTIVITY_TIME: '9:00 AM',
        DEFAULT_TERMS: 'Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.'
    },

    // UI Configuration
    UI: {
        CALENDAR: {
            DEFAULT_VIEW: 'month', // 'month' or 'week'
            DEFAULT_ACTIVITIES_VIEW: 'list', // 'list' or 'calendar'
        },
        ANALYTICS: {
            DEFAULT_PERIOD_DAYS: 30,
            DEFAULT_CHART_PERIOD: 'month'
        },
        NOTIFICATION: {
            DEFAULT_ICON: '🔔',
            ICONS: {
                'activity': '📋',
                'quote': '💰',
                'deadline': '⏰',
                'reminder': '🔔',
                'warning': '⚠️',
                'success': '✅',
                'error': '❌',
                'overdue': '⏰',
                'due_today': '📅',
                'due_tomorrow': '📋',
                'overloaded': '⚠️',
                'unassigned_urgent': '🚨',
                'default': '🔔'
            }
        }
    },

    // Default Team Members
    TEAM: {
        DEFAULT_MEMBERS: [
            {
                id: 'tm1',
                name: 'John Smith',
                role: 'Senior Engineer',
                email: 'john.smith@company.com',
                max_hours: 40,
                color: '#3b82f6'
            },
            {
                id: 'tm2',
                name: 'Sarah Johnson',
                role: 'Project Manager',
                email: 'sarah.johnson@company.com',
                max_hours: 40,
                color: '#10b981'
            },
            {
                id: 'tm3',
                name: 'Mike Brown',
                role: 'Technician',
                email: 'mike.brown@company.com',
                max_hours: 35,
                color: '#f59e0b'
            }
        ],
        DEFAULT_FILTER: 'all'
    },

    // Workflow & Dependencies
    WORKFLOW: {
        DEFAULT_MODE: 'view', // 'view', 'edit', 'connect'
        DEFAULT_DEPENDENCY_TYPE: 'predecessor',
        DEPENDENCY_TYPES: {
            FINISH_TO_START: 'finish-to-start',
            START_TO_START: 'start-to-start',
            FINISH_TO_FINISH: 'finish-to-finish'
        }
    },

    // System Limits & Validation
    LIMITS: {
        MAX_RETRY_ATTEMPTS: 3,
        RETRY_DELAY_MS: 1000,
        MAX_FILE_SIZE_MB: 10,
        MAX_DESCRIPTION_LENGTH: 1000
    }
};

// Legacy constants for backward compatibility
const DB_NAME = CONFIG.DATABASE.NAME;
const DB_VERSION = CONFIG.DATABASE.VERSION;
const STORES = CONFIG.DATABASE.STORES;

// ========================================
// GLOBAL STATE
// ========================================

/**
 * @description Global database connection and state management
 */
let dbConnection = null;
let db = {}; // In-memory cache for compatibility

// ========================================
// IndexedDB Management
// ========================================

/**
 * @description Generate a UUID v4 using crypto.randomUUID() or fallback method
 * @returns {string} A valid UUID v4 string
 * @example
 * const id = generateUUID(); // "12345678-1234-4xxx-yxxx-123456789abc"
 */
function generateUUID() {
    if (crypto && crypto.randomUUID) {
        return crypto.randomUUID();
    }
    // Fallback UUID generation
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

/**
 * @description Initialize IndexedDB connection and create object stores with indexes
 * @async
 * @returns {Promise<IDBDatabase>} Promise that resolves to the database connection
 * @throws {Error} If IndexedDB is not supported or connection fails
 * @example
 * try {
 *   await initializeIndexedDB();
 *   console.log('Database ready');
 * } catch (error) {
 *   console.error('Database initialization failed:', error);
 * }
 */
async function initializeIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('❌ IndexedDB connection failed:', request.error);
            reject(request.error);
        };
        
        request.onsuccess = () => {
            dbConnection = request.result;
            console.log('✅ IndexedDB connected successfully');
            resolve(dbConnection);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            console.log('🏗️ Setting up IndexedDB schema...');
            
            // Create PCS store
            if (!db.objectStoreNames.contains(STORES.PCS)) {
                const pcsStore = db.createObjectStore(STORES.PCS, { keyPath: 'id' });
                pcsStore.createIndex('pc_number', 'pc_number', { unique: true });
                pcsStore.createIndex('company_name', 'company_name', { unique: false });
                pcsStore.createIndex('account_manager', 'account_manager', { unique: false });
                pcsStore.createIndex('status', 'status', { unique: false });
                pcsStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // Create QUOTES store
            if (!db.objectStoreNames.contains(STORES.QUOTES)) {
                const quotesStore = db.createObjectStore(STORES.QUOTES, { keyPath: 'id' });
                quotesStore.createIndex('quote_number', 'quote_number', { unique: true });
                quotesStore.createIndex('pc_id', 'pc_id', { unique: false });
                quotesStore.createIndex('company_name', 'company_name', { unique: false });
                quotesStore.createIndex('status', 'status', { unique: false });
                quotesStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // Create ACTIVITIES store
            if (!db.objectStoreNames.contains(STORES.ACTIVITIES)) {
                const activitiesStore = db.createObjectStore(STORES.ACTIVITIES, { keyPath: 'id' });
                activitiesStore.createIndex('pc_id', 'pc_id', { unique: false });
                activitiesStore.createIndex('company_name', 'company_name', { unique: false });
                activitiesStore.createIndex('type', 'type', { unique: false });
                activitiesStore.createIndex('status', 'status', { unique: false });
                activitiesStore.createIndex('assigned_to', 'assigned_to', { unique: false });
                activitiesStore.createIndex('scheduled_date', 'scheduled_date', { unique: false });
            }
            
            // Create RESOURCES store
            if (!db.objectStoreNames.contains(STORES.RESOURCES)) {
                const resourcesStore = db.createObjectStore(STORES.RESOURCES, { keyPath: 'id' });
                resourcesStore.createIndex('name', 'name', { unique: false });
                resourcesStore.createIndex('category', 'category', { unique: false });
                resourcesStore.createIndex('sku', 'sku', { unique: false });
                resourcesStore.createIndex('is_active', 'is_active', { unique: false });
                resourcesStore.createIndex('supplier', 'supplier', { unique: false });
            }
            
            // Create PRICE_LISTS store
            if (!db.objectStoreNames.contains(STORES.PRICE_LISTS)) {
                const priceListsStore = db.createObjectStore(STORES.PRICE_LISTS, { keyPath: 'id' });
                priceListsStore.createIndex('name', 'name', { unique: false });
                priceListsStore.createIndex('version', 'version', { unique: false });
                priceListsStore.createIndex('effective_from', 'effective_from', { unique: false });
                priceListsStore.createIndex('is_default', 'is_default', { unique: false });
            }
            
            // NEW Sprint 3.3: Create TEMPLATES store
            if (!db.objectStoreNames.contains(STORES.TEMPLATES)) {
                const templatesStore = db.createObjectStore(STORES.TEMPLATES, { keyPath: 'id' });
                templatesStore.createIndex('name', 'name', { unique: false });
                templatesStore.createIndex('category', 'category', { unique: false });
                templatesStore.createIndex('status', 'status', { unique: false });
                templatesStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // NEW Sprint 4.1: Create ACTIVITY_TEMPLATES store
            if (!db.objectStoreNames.contains(STORES.ACTIVITY_TEMPLATES)) {
                const activityTemplatesStore = db.createObjectStore(STORES.ACTIVITY_TEMPLATES, { keyPath: 'id' });
                activityTemplatesStore.createIndex('name', 'name', { unique: false });
                activityTemplatesStore.createIndex('category', 'category', { unique: false });
                activityTemplatesStore.createIndex('priority', 'priority', { unique: false });
                activityTemplatesStore.createIndex('status', 'status', { unique: false });
                activityTemplatesStore.createIndex('created_at', 'created_at', { unique: false });
            }
        };
    });
}

/**
 * @description Enhanced error handling with retry logic
 * @param {string} storeName - IndexedDB store name
 * @param {Object} data - Data to save
 * @param {number} maxRetries - Maximum retry attempts (defaults to CONFIG)
 * @param {number} delay - Delay between retries in ms (defaults to CONFIG)
 * @returns {Promise<void>}
 */
async function saveWithRetry(storeName, data, maxRetries = CONFIG.LIMITS.MAX_RETRY_ATTEMPTS, delay = CONFIG.LIMITS.RETRY_DELAY_MS) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            await saveToStore(storeName, data);
            return; // Success - exit function
    } catch (error) {
            console.warn(`❌ Save attempt ${attempt}/${maxRetries} failed:`, error.message);
            
            if (attempt === maxRetries) {
                throw new Error(`Failed to save after ${maxRetries} attempts: ${error.message}`);
            }
            
            // Wait before retrying (exponential backoff)
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
        }
    }
}

// ========================================
// Generic CRUD Operations
// ========================================

/**
 * @description Save data to specified IndexedDB store
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @param {Object} data - Data object to save (must have 'id' property)
 * @returns {Promise<void>} Promise that resolves when save is complete
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * await saveToStore('pcs', { id: 'pc-123', company_name: 'Acme Corp' });
 */
async function saveToStore(storeName, data) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

/**
 * @description Load a single record from IndexedDB store by ID
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @param {string} id - Unique identifier for the record
 * @returns {Promise<Object|undefined>} Promise that resolves to the record or undefined if not found
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * const pc = await loadFromStore('pcs', 'pc-123');
 * if (pc) console.log('Found PC:', pc.company_name);
 */
async function loadFromStore(storeName, id) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(id);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

/**
 * @description Load all records from an IndexedDB store
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @returns {Promise<Array>} Promise that resolves to array of all records in the store
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * const allPCs = await loadAllFromStore('pcs');
 * console.log(`Found ${allPCs.length} PC numbers`);
 */
async function loadAllFromStore(storeName) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function deleteFromStore(storeName, id) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Load all data into memory cache for UI compatibility
async function loadDataFromIndexedDB() {
    try {
        const [pcs, quotes, activities, resources, priceLists, templates, activityTemplates] = await Promise.all([
            loadAllFromStore(STORES.PCS),
            loadAllFromStore(STORES.QUOTES),
            loadAllFromStore(STORES.ACTIVITIES), 
            loadAllFromStore(STORES.RESOURCES),
            loadAllFromStore(STORES.PRICE_LISTS),
            loadAllFromStore(STORES.TEMPLATES), // Sprint 3.3: Load templates
            loadAllFromStore(STORES.ACTIVITY_TEMPLATES) // NEW Sprint 4.1: Load activity templates
        ]);
        
        db = {
            pcs: pcs || [],
            quotes: quotes || [],
            activities: activities || [],
            resources: resources || [],
            priceLists: priceLists || [],
            templates: templates || [], // Sprint 3.3: Templates storage
            activityTemplates: activityTemplates || [], // NEW Sprint 4.1: Activity templates storage
            // Compatibility fields
            currentPC: null,
            currentQuote: null,
            currentActivity: null,
            currentPriceList: null,
            currentResource: null,
            editingPC: null,
            editingQuote: null,
            editingActivity: null,
            editingResource: null,
            selectedPriceListId: null,
            quoteItems: { human: [], vehicles: [], materials: [], other: [] }
        };
        
        console.log('📦 Data loaded from IndexedDB:', {
            pcs: db.pcs.length,
            quotes: db.quotes.length,
            activities: db.activities.length,
            resources: db.resources.length,
            priceLists: db.priceLists.length,
            templates: db.templates.length, // Sprint 3.3: Include templates in logging
            activityTemplates: db.activityTemplates.length // NEW Sprint 4.1: Include activity templates in logging
        });
        
        if (db.pcs.length === 0) {
            console.log('🌱 No data found, initializing with demo data.');
            await initializeWithDemoData();
        }
    } catch (error) {
        console.error('❌ Error loading from IndexedDB:', error);
        throw error;
    }
}

// Save data back to IndexedDB
async function saveDataToIndexedDB() {
    try {
        // Save all arrays back to their respective stores
        const savePromises = [
            ...db.pcs.map(pc => saveToStore(STORES.PCS, pc)),
            ...db.quotes.map(quote => saveToStore(STORES.QUOTES, quote)),
            ...db.activities.map(activity => saveToStore(STORES.ACTIVITIES, activity)),
            ...db.resources.map(resource => saveToStore(STORES.RESOURCES, resource)),
            ...db.priceLists.map(priceList => saveToStore(STORES.PRICE_LISTS, priceList)),
            ...db.templates.map(template => saveToStore(STORES.TEMPLATES, template)), // Sprint 3.3: Save templates
            ...db.activityTemplates.map(activityTemplate => saveToStore(STORES.ACTIVITY_TEMPLATES, activityTemplate)) // NEW Sprint 4.1: Save activity templates
        ];
        
        await Promise.all(savePromises);
        console.log('💾 Data saved to IndexedDB successfully');
    } catch (error) {
        console.error('❌ Error saving to IndexedDB:', error);
        throw error;
    }
}

async function initializeWithDemoData() {
    console.log('🌱 Starting demo data initialization...');
    const now = new Date().toISOString();
    const today = new Date().toISOString().split('T')[0];
    
    // Generate UUIDs for demo data
    const demoUUIDs = {
        pc1: generateUUID(),
        pc2: generateUUID(),
        res1: generateUUID(),
        res2: generateUUID(),
        res3: generateUUID(),
        res4: generateUUID(),
        res5: generateUUID(),
        pl1: generateUUID(),
        q1: generateUUID(),
        q2: generateUUID(), // NEW Sprint 2: Second demo quote
        act1: generateUUID(),
        act2: generateUUID()
    };
    
    // Enhanced PC Numbers with full specification fields
    const demoPCs = [
        {
            id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            project_name: 'Office Refurbishment Phase 2',
            project_description: 'Complete electrical rewiring and lighting upgrade for main office building including installation of modern LED systems and emergency lighting.',
            account_manager: 'John Smith',
            // NEW FIELDS according to system_improvements.md:
            client_industry: 'Education', // single-select: Media, Education, Healthcare, etc.
            client_source: 'Business Development', // merged: Web Enquiry, Business Development, Existing Customer, Cross Referral, Internal (CWS/Crown)
            quote_limit: 5, // default quote limit control
            // SIMPLIFIED CONTACT (minimum: phone OR email + contact name):
            contact_name: 'Sarah Williams',
            contact_phone: '01216549870', 
            contact_email: 'sarah.w@acme.com',
            // OPTIONAL POSTCODE (if address needed):
            postcode: 'B1 1AA',
            // NOTE: collection/delivery addresses REMOVED - will be moved to Quote section
            status: 'active',
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Globex Industries Ltd',
            project_name: 'Warehouse Lighting Upgrade',
            project_description: 'Replacement of old fluorescent lighting with energy-efficient LED lighting throughout the main warehouse facility.',
            account_manager: 'Anna Brown',
            // NEW FIELDS according to system_improvements.md:
            client_industry: 'Healthcare', // single-select: Media, Education, Healthcare, etc.
            client_source: 'Existing Customer', // merged field
            quote_limit: 3, // different limit for this client
            // SIMPLIFIED CONTACT (minimum: phone OR email + contact name):
            contact_name: 'James Roberts',
            contact_phone: '01619876543',
            contact_email: 'james.r@globex.com',
            // OPTIONAL POSTCODE:
            postcode: 'M2 3CC',
            // NOTE: collection/delivery addresses REMOVED - will be moved to Quote section
            status: 'active',
            created_at: now,
            updated_at: now
        }
    ];
    
    // Enhanced Resources with supplier information
    const demoResources = [
        {
            id: demoUUIDs.res1,
            name: 'LED Downlight - 10W Cool White',
            description: 'Energy efficient LED downlight with 10W power consumption, cool white temperature (4000K), suitable for commercial installations.',
            category: 'lighting',
            subcategory: 'downlights',
            sku: 'LED-DL-10W-CW',
            unit: 'each',
            net_cost: 25.00,
            supplier: 'Electrical Supplies Ltd',
            supplier_code: 'ESL-LED-001',
            is_active: true,
            min_quantity: 10,
            lead_time_days: 5,
            weight_kg: 0.150,
            dimensions: '85mm diameter x 25mm depth',
            warranty_months: 24,
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.res2,
            name: 'Electrician - Senior Level',
            description: 'Qualified electrician with 5+ years commercial experience',
            category: 'labour',
            subcategory: 'installation',
            sku: 'LAB-ELEC-SR',
            unit: 'hour',
            net_cost: 45.00,
            supplier: 'Internal',
            supplier_code: null,
            is_active: true,
            min_quantity: 1,
            lead_time_days: 0,
            weight_kg: null,
            dimensions: null,
            warranty_months: null,
            created_at: now,
            updated_at: now
        }
    ];
    
    // Enhanced Price Lists with versioning
    const demoPriceLists = [
        {
            id: demoUUIDs.pl1,
            name: 'Standard Commercial Rates 2024',
            version: 'v2.1',
            description: 'Updated rates for commercial electrical projects including new LED technology pricing',
            effective_from: '2024-01-01',
            effective_to: '2024-12-31',
            is_default: true,
            markup_percentage: 35.00,
            discount_percentage: 0.00,
            currency: 'GBP',
            pricing_data: {
                [demoUUIDs.res1]: { price: 35.00, markup_percentage: 40.00, effective_price: 35.00, min_quantity: 10 },
                [demoUUIDs.res2]: { price: 65.00, markup_percentage: 44.44, effective_price: 65.00, min_quantity: 1 }
            },
            terms: 'Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.',
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 3.3: Demo Templates
    const demoTemplates = [
        {
            id: generateUUID(),
            name: 'Standard Office Lighting',
            category: 'lighting',
            description: 'Standard LED lighting package for office environments including downlights and emergency lighting',
            status: 'active',
            vat_rate: 20.00,
            terms_conditions: 'Payment terms: 30 days net. All work carried out to BS 7671 standards. Materials warranty as per manufacturer specifications.',
            items: [
                {
                    resource_id: demoUUIDs.res1,
                    resource_name: 'LED Downlight - 10W Cool White',
                    quantity: 25,
                    unit_price: 35.00,
                    line_total: 875.00,
                    notes: 'Standard office application'
                }
            ],
            estimated_value: 1050.00, // Including VAT
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'Warehouse High Bay Lighting',
            category: 'lighting',
            description: 'High bay LED lighting solution for warehouse and industrial applications',
            status: 'active',
            vat_rate: 20.00,
            terms_conditions: 'Payment terms: 30 days net. Suitable for heights 6-12m. IP65 rated for harsh environments.',
            items: [
                {
                    resource_id: demoUUIDs.res2,
                    resource_name: 'LED High Bay Light - 150W',
                    quantity: 10,
                    unit_price: 42.50,
                    line_total: 425.00,
                    notes: 'Industrial grade for warehouse use'
                }
            ],
            estimated_value: 510.00, // Including VAT
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 4.1: Demo Activity Templates
    const demoActivityTemplates = [
        {
            id: generateUUID(),
            name: 'Standard Site Survey',
            category: 'survey',
            description: 'Comprehensive site survey to assess electrical requirements and plan installation work',
            priority: 'medium',
            duration_hours: 2.0,
            status: 'active',
            assigned_to_default: 'Mike Johnson',
            schedule_offset_days: 1,
            pre_activity_checklist: '• Confirm appointment with client\n• Prepare tools and equipment (multimeter, camera, measuring tape)\n• Review site access instructions\n• Check weather conditions for external work\n• Prepare survey forms and documentation',
            completion_notes_template: 'Site survey completed successfully.\n\nKey findings:\n• Existing electrical infrastructure: [DESCRIBE]\n• Power supply capacity: [CAPACITY]\n• Access arrangements: [ACCESS DETAILS]\n\nRecommendations:\n• [RECOMMENDATION 1]\n• [RECOMMENDATION 2]\n\nNext steps:\n• Prepare detailed quote\n• Schedule installation if approved',
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'LED Installation - Standard',
            category: 'installation',
            description: 'Standard LED lighting installation for offices and commercial spaces',
            priority: 'high',
            duration_hours: 4.0,
            status: 'active',
            assigned_to_default: 'Alex Smith',
            schedule_offset_days: 7,
            pre_activity_checklist: '• Confirm all materials delivered to site\n• Check power isolation arrangements\n• Verify access equipment (ladders, lifts)\n• Review health & safety requirements\n• Contact client 24h before arrival',
            completion_notes_template: 'LED installation completed successfully.\n\nWork completed:\n• Number of fixtures installed: [COUNT]\n• Total power consumption: [WATTS]\n• Testing results: All circuits tested and certified\n\nQuality checks:\n• All connections secure: ✓\n• Light levels measured: ✓\n• Emergency lighting tested: ✓\n• Client handover completed: ✓\n\nCompletion certificate issued: [CERT_NUMBER]',
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'Periodic Testing & Inspection',
            category: 'testing',
            description: 'Regular electrical testing and inspection as per BS 7671 requirements',
            priority: 'medium',
            duration_hours: 3.0,
            status: 'active',
            assigned_to_default: null,
            schedule_offset_days: 0,
            pre_activity_checklist: '• Bring testing equipment (PAT, insulation tester, RCD tester)\n• Prepare inspection forms and certificates\n• Coordinate with client for power isolation\n• Review previous test certificates\n• Plan testing sequence to minimize disruption',
            completion_notes_template: 'Electrical testing and inspection completed.\n\nTests performed:\n• Continuity testing: [RESULT]\n• Insulation resistance: [RESULT]\n• RCD testing: [RESULT]\n• Visual inspection: [RESULT]\n\nIssues identified:\n• [ISSUE 1 - PRIORITY]\n• [ISSUE 2 - PRIORITY]\n\nRecommendations:\n• [RECOMMENDATION 1]\n• [RECOMMENDATION 2]\n\nCertificate issued: [CERT_NUMBER]\nNext test due: [DATE]',
            created_at: now,
            updated_at: now
        }
    ];
    console.log('✅ Activity templates generated successfully');
    
    // Enhanced Quotes with proper structure
    const demoQuotes = [
        {
            id: demoUUIDs.q1,
            quote_number: 'QT-000001',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            title: 'Office Refurbishment - Electrical Works',
            description: 'Supply and installation of LED lighting system including downlights, emergency lighting and associated electrical work.',
            status: 'ISSUED', // NEW Sprint 2: Updated status workflow
            valid_until: '2024-05-15',
            subtotal: 1750.00,
            vat_rate: 20.00,
            vat_amount: 350.00,
            total_cost: 2100.00,
            notes: 'Client requested delivery in phases to minimize disruption to operations.',
            terms_conditions: 'Payment terms: 30 days net. All work carried out to BS 7671 standards. Materials warranty as per manufacturer specifications.',
            line_items: [
                {
                    resource_id: demoUUIDs.res1,
                    resource_name: 'LED Downlight - 10W Cool White',
                    quantity: 50,
                    unit_price: 35.00,
                    line_total: 1750.00,
                    notes: 'Cool white temperature specified by client'
                }
            ],
            
            // NEW Sprint 2: Move Type & Address fields
            move_type: 'Collection + Delivery',
            
            // Collection address
            collection_contact_name: 'Sarah Williams',
            collection_phone: '01216549870',
            collection_email: 'sarah.w@acme.com',
            collection_date: '2024-04-15',
            collection_address_1: '123 High Street',
            collection_address_2: 'Industrial Estate',
            collection_city: 'Birmingham',
            collection_county: 'West Midlands',
            collection_postcode: 'B1 1AA',
            
            // Delivery address
            delivery_contact_name: 'Mark Thompson',
            delivery_phone: '01234567890',
            delivery_email: 'mark.t@newsite.com',
            delivery_date: '2024-04-20',
            delivery_address_1: '456 New Road',
            delivery_address_2: 'Business Park',
            delivery_city: 'Manchester',
            delivery_county: 'Greater Manchester',
            delivery_postcode: 'M1 2BB',
            
            // Quoted Activities (linked to demo activities)
            quoted_activities: [demoUUIDs.act1],
            
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.q2,
            quote_number: 'QT-000002',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Globex Industries Ltd',
            title: 'Warehouse Lighting - Supply Only',
            description: 'Supply of LED high bay lights for warehouse facility. Client to arrange own installation.',
            status: 'DRAFT', // Different status for demonstration
            valid_until: '2024-06-01',
            subtotal: 850.00,
            vat_rate: 20.00,
            vat_amount: 170.00,
            total_cost: 1020.00,
            notes: 'Supply only quote. Client has their own electricians.',
            terms_conditions: 'Payment terms: 30 days net. Collection from our warehouse.',
            line_items: [
                {
                    resource_id: demoUUIDs.res2,
                    resource_name: 'LED High Bay Light - 150W',
                    quantity: 20,
                    unit_price: 42.50,
                    line_total: 850.00,
                    notes: 'Industrial grade for warehouse use'
                }
            ],
            
            // NEW Sprint 2: Different move type example
            move_type: 'Collection Only',
            
            // Collection address only (no delivery)
            collection_contact_name: 'James Roberts',
            collection_phone: '01619876543',
            collection_email: 'james.r@globex.com',
            collection_date: '2024-04-25',
            collection_address_1: '789 Industrial Road',
            collection_address_2: null,
            collection_city: 'Manchester',
            collection_county: 'Greater Manchester',
            collection_postcode: 'M2 3CC',
            
            // No delivery address (Collection Only)
            delivery_contact_name: null,
            delivery_phone: null,
            delivery_email: null,
            delivery_date: null,
            delivery_address_1: null,
            delivery_address_2: null,
            delivery_city: null,
            delivery_county: null,
            delivery_postcode: null,
            
            // Quoted Activities (linked to different activity)
            quoted_activities: [demoUUIDs.act2],
            
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 4.2.4: Helper functions for generating demo dates
    function getTodayString() {
        return new Date().toISOString().split('T')[0];
    }
    
    function getTomorrowString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow.toISOString().split('T')[0];
    }
    
    function getNextWeekdayDate(daysFromToday) {
        const date = new Date();
        date.setDate(date.getDate() + daysFromToday);
        return date.toISOString().split('T')[0];
    }
    
    function getFirstDayOfNextMonth() {
        const date = new Date();
        date.setMonth(date.getMonth() + 1);
        date.setDate(1);
        return date.toISOString().split('T')[0];
    }

    // Enhanced Activities with scheduling
    const demoActivities = [
        {
            id: demoUUIDs.act1,
            title: 'Site Survey - Electrical Assessment',
            description: 'Initial site survey to assess existing electrical infrastructure and plan LED lighting installation.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            type: 'survey',
            status: 'completed',
            priority: 'high',
            scheduled_date: '2024-04-08',
            scheduled_time: '09:30:00',
            estimated_hours: 3.0,
            assigned_to: 'tm1',
            location: 'Client Site - Birmingham',
            contact_name: 'Sarah Williams',
            contact_phone: '07123456789',
            completion_notes: 'Survey completed successfully. Existing electrical infrastructure adequate for LED upgrade. Access arrangements confirmed with site contact.',
            completed_at: '2024-04-08T12:30:00.000Z',
            created_date: '2024-04-08',
            is_recurring: false
        },
        // NEW Sprint 4.2.4: Demo Recurring Activities - Weekly Safety Inspections
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(0), // Monday
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 1,
            recurring_config: {
                frequency: 'weekly',
                interval: 1,
                count: 12
            },
            created_date: getTodayString(),
            is_recurring: true
        },
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(7), // Next Monday
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 2,
            created_date: getTodayString(),
            is_recurring: true
        },
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(14), // Monday after next
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 3,
            created_date: getTodayString(),
            is_recurring: true
        },
        // NEW Sprint 4.2.4: Demo Recurring Activities - Monthly Equipment Maintenance
        {
            id: generateUUID(),
            title: 'Equipment Maintenance Check',
            description: 'Monthly maintenance and calibration of LED installation equipment.',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Tech Solutions Inc',
            status: 'scheduled',
            priority: 'high',
            scheduled_date: getFirstDayOfNextMonth(),
            scheduled_time: '14:00',
            estimated_hours: 4.0,
            assigned_to: 'tm3',
            recurring_series_id: 'series-maintenance-1',
            recurring_sequence: 1,
            recurring_config: {
                frequency: 'monthly',
                interval: 1,
                count: 6
            },
            created_date: getTodayString(),
            is_recurring: true
        },
        // Regular non-recurring activity
        {
            id: generateUUID(),
            title: 'Client Meeting - Project Kickoff',
            description: 'Initial project kickoff meeting to discuss requirements and timeline.',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Tech Solutions Inc',
            status: 'scheduled',
            priority: 'high',
            scheduled_date: getTomorrowString(),
            scheduled_time: '10:30',
            estimated_hours: 1.5,
            assigned_to: 'tm1',
            created_date: getTodayString(),
            is_recurring: false
        }
    ];
    console.log('✅ All demo data structures created successfully');
    
    // Set data in memory cache
    console.log('📦 Assigning demo data to db object...');
    db = {
        pcs: demoPCs,
        quotes: demoQuotes,
        activities: demoActivities,
        resources: demoResources,
        priceLists: demoPriceLists,
        templates: demoTemplates, // Sprint 3.3: Templates demo data
        activityTemplates: demoActivityTemplates, // NEW Sprint 4.1: Activity templates demo data
        // Compatibility fields
        currentPC: null,
        currentQuote: null,
        currentActivity: null,
        currentPriceList: null,
        currentResource: null,
        editingPC: null,
        editingQuote: null,
        editingActivity: null,
        editingResource: null,
        selectedPriceListId: null,
        quoteItems: { human: [], vehicles: [], materials: [], other: [] }
    };
    console.log('✅ Demo data assigned to db object successfully');
    
    // Save to IndexedDB
    console.log('💾 Saving demo data to IndexedDB...');
    await saveDataToIndexedDB();
    console.log('✅ Demo data initialized successfully');
}

async function resetData() {
    if (confirm('Are you sure you want to delete all demo data and start over? This operation is irreversible.')) {
        try {
            // Clear IndexedDB
            if (dbConnection) {
                dbConnection.close();
            }
            await new Promise((resolve, reject) => {
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                deleteRequest.onsuccess = () => resolve();
                deleteRequest.onerror = () => reject(deleteRequest.error);
            });
            console.log('🗑️ IndexedDB cleared successfully');
        location.reload();
        } catch (error) {
            console.error('❌ Error clearing IndexedDB:', error);
            alert('Error clearing database. Please refresh the page manually.');
        }
    }
}

// ========================================
// Nawigacja i UI
// ========================================

/**
 * @description Navigate to a specific page in the SPA, updating navigation and clearing edit states
 * @param {string} pageId - The ID of the page element to display
 * @example
 * showPage('dashboard'); // Shows dashboard page and updates navigation
 * showPage('pcnumbers'); // Shows PC Numbers page
 */
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const pageToNavMap = {
        'dashboard': 'dashboard', 'pcnumbers': 'pcnumbers', 'new-pc': 'pcnumbers', 'pc-detail': 'pcnumbers',
        'quotes': 'quotes', 'quote-builder': 'quotes', 'activities': 'activities', 'resources': 'resources',
        'resource-allocation': 'resource-allocation', 'analytics': 'analytics', 'pricelists': 'pricelists', 'new-pricelist': 'pricelists', 'pricelist-detail': 'pricelists'
    };
    const navButton = document.querySelector(`.nav-btn[onclick="window.showPage('${pageToNavMap[pageId]}')"]`);
    if (navButton) navButton.classList.add('active');

    // Reset stanów edycji przy zmianie strony (chyba, że idziemy do formularza)
    if (pageId !== 'new-pc') db.editingPC = null;
    if (pageId !== 'quote-builder') db.editingQuote = null;
    if (pageId !== 'new-pricelist') db.currentPriceList = null;
    
    // Clear PC form when going to new PC page
    if (pageId === 'new-pc' && !db.editingPC) {
        clearPCForm();
    }
    
    // Clear price list form when going to new price list page
    if (pageId === 'new-pricelist' && !document.getElementById('pricelist-id').value) {
        clearPriceListForm();
        // Set default effective date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pricelist-effective-from').value = today;
    }

    // Odśwież widok
    switch(pageId) {
        case 'dashboard': updateDashboard(); break;
        case 'pcnumbers': renderPCList(); break;
        case 'quotes': renderQuotesList(); break;
        case 'activities': updateActivitiesList(); break;
        case 'resources': updateResourcesList(); break;
        case 'resource-allocation': updateResourceAllocationPage(); break; // NEW Sprint 4.3: Resource allocation page
        case 'analytics': updateAnalytics(); break; // NEW Sprint 4.5: Analytics page
        case 'pricelists': updatePriceListsTable(); break;
        case 'templates': updateTemplatesList(); break; // Sprint 3.3: Templates page
        case 'activity-templates': updateActivityTemplatesList(); break; // NEW Sprint 4.1: Activity templates page
    }
}

function clearPCForm() {
    document.getElementById('pc-form-title').textContent = 'New PC Number';
    document.getElementById('pc-id').value = '';
    
    // Main data fields
    document.getElementById('pc-number').value = '';
    document.getElementById('pc-company-name').value = '';
    document.getElementById('pc-project-name').value = '';
    document.getElementById('pc-project-description').value = '';
    document.getElementById('pc-account-manager').value = '';
    // NEW FIELDS:
    document.getElementById('pc-client-industry').value = '';
    document.getElementById('pc-client-source').value = '';
    document.getElementById('pc-quote-limit').value = '5';
    document.getElementById('pc-status').value = 'active';
    
    // SIMPLIFIED CONTACT FIELDS:
    document.getElementById('pc-contact-name').value = '';
    document.getElementById('pc-contact-phone').value = '';
    document.getElementById('pc-contact-email').value = '';
    document.getElementById('pc-postcode').value = '';
}

// ========================================
// Dashboard
// ========================================

function updateDashboard() {
    document.getElementById('stat-pc').textContent = db.pcs.length;
    document.getElementById('stat-quotes').textContent = db.quotes.length;
    document.getElementById('stat-activities').textContent = db.activities.length;
    const totalValue = db.quotes.reduce((sum, q) => sum + (q.total || 0), 0);
    document.getElementById('stat-value').textContent = '£' + totalValue.toFixed(2);
    
    const recentPCBody = document.getElementById('recent-pc');
    recentPCBody.innerHTML = '';
    db.pcs.slice(-5).reverse().forEach(pc => {
        recentPCBody.innerHTML += `<tr><td>${pc.pc_number || pc.number}</td><td>${pc.company_name || pc.company}</td><td>${pc.project_name || pc.reference || '-'}</td></tr>`;
    });
}

// ========================================
// Numery PC
// ========================================

function renderPCList() {
    const tbody = document.getElementById('pc-list');
    tbody.innerHTML = '';
    db.pcs.forEach(pc => {
        const contact = [pc.collection_first_name, pc.collection_surname].filter(Boolean).join(' ') || pc.contactPerson || '-';
        tbody.innerHTML += `<tr>
            <td>${pc.pc_number || pc.number}</td>
            <td>${pc.company_name || pc.company}</td>
            <td>${pc.project_name || pc.reference || '-'}</td>
            <td>${contact}</td>
            <td><div class="action-btn-group">
                <button onclick="window.viewPC('${pc.id}')" class="secondary">Show</button>
                <button onclick="window.editPC('${pc.id}')" class="warning">Edit</button>
            </div></td>
        </tr>`;
    });
}

/**
 * @description Save or update a PC Number record from form data
 * @async
 * @throws {Error} If form validation fails or database save fails
 * @example
 * // Called when user clicks "Save PC Number" button
 * await savePC(); // Validates form, saves to database, redirects to list
 */
async function savePC() {
    const id = document.getElementById('pc-id').value;
    const now = new Date().toISOString();
    
    const pcData = {
        pc_number: document.getElementById('pc-number').value.trim(),
        company_name: document.getElementById('pc-company-name').value.trim(),
        project_name: document.getElementById('pc-project-name').value.trim(),
        project_description: document.getElementById('pc-project-description').value.trim(),
        account_manager: document.getElementById('pc-account-manager').value.trim(),
        // NEW FIELDS according to system_improvements.md:
        client_industry: document.getElementById('pc-client-industry').value,
        client_source: document.getElementById('pc-client-source').value,
        quote_limit: parseInt(document.getElementById('pc-quote-limit').value) || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT,
        status: document.getElementById('pc-status').value,
        
        // SIMPLIFIED CONTACT FIELDS:
        contact_name: document.getElementById('pc-contact-name').value.trim(),
        contact_phone: document.getElementById('pc-contact-phone').value.trim(),
        contact_email: document.getElementById('pc-contact-email').value.trim(),
        postcode: document.getElementById('pc-postcode').value.trim(),
        
        updated_at: now
    };

    // Enhanced validation according to system_improvements.md:
    // Required: PC Number, Company Name, Project Name, Account Manager, Client Industry, Client Source, Contact Name
    // Contact: minimum phone OR email
    if (!pcData.pc_number || !pcData.company_name || !pcData.project_name || !pcData.account_manager || !pcData.client_industry || !pcData.client_source || !pcData.contact_name) {
        alert('Required fields: PC Number, Company Name, Project Name, Account Manager, Client Industry, Client Source, and Contact Name!');
        return;
    }

    if (!pcData.contact_phone && !pcData.contact_email) {
        alert('Contact requirement: Please provide either Phone OR Email!');
        return;
    }
    
    // Quote limit validation
    const existingQuotes = db.quotes.filter(q => q.pc_id === (id || 'new')).length;
    if (existingQuotes >= pcData.quote_limit && !id) {
        alert(`Quote limit (${pcData.quote_limit}) would be exceeded for this PC Number!`);
        return;
    }

    try {
        if (id) { // Edit
        const index = db.pcs.findIndex(p => p.id === id);
            if (index !== -1) {
        db.pcs[index] = { ...db.pcs[index], ...pcData };
                await saveToStore(STORES.PCS, db.pcs[index]);
            }
        } else { // New
            pcData.id = generateUUID();
            pcData.created_at = now;
        db.pcs.push(pcData);
            await saveToStore(STORES.PCS, pcData);
    }
    
        console.log('✅ PC Number saved successfully');
    showPage('pcnumbers');
    } catch (error) {
        console.error('❌ Error saving PC Number:', error);
        alert('Error saving PC Number. Please try again.');
    }
}

function editPC(id) {
    const pc = db.pcs.find(p => p.id === id);
    if (!pc) return;
    db.editingPC = pc;
    
    document.getElementById('pc-form-title').textContent = 'Edit PC Number';
    document.getElementById('pc-id').value = pc.id;
    
    // Main data fields
    document.getElementById('pc-number').value = pc.pc_number || '';
    document.getElementById('pc-company-name').value = pc.company_name || '';
    document.getElementById('pc-project-name').value = pc.project_name || '';
    document.getElementById('pc-project-description').value = pc.project_description || '';
    document.getElementById('pc-account-manager').value = pc.account_manager || '';
    // NEW FIELDS:
    document.getElementById('pc-client-industry').value = pc.client_industry || '';
    document.getElementById('pc-client-source').value = pc.client_source || '';
    document.getElementById('pc-quote-limit').value = pc.quote_limit || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT;
    document.getElementById('pc-status').value = pc.status || 'active';
    
    // SIMPLIFIED CONTACT FIELDS:
    document.getElementById('pc-contact-name').value = pc.contact_name || '';
    document.getElementById('pc-contact-phone').value = pc.contact_phone || '';
    document.getElementById('pc-contact-email').value = pc.contact_email || '';
    document.getElementById('pc-postcode').value = pc.postcode || '';
    
    showPage('new-pc');
}



function viewPC(id) {
    const pc = db.pcs.find(p => p.id === id);
    if (!pc) return;
    db.currentPC = pc;
    
    document.getElementById('pc-detail-title').textContent = `Details: ${pc.pc_number || pc.number}`;
    
    // Main data
    document.getElementById('pc-detail-number').textContent = pc.pc_number || pc.number || '-';
    document.getElementById('pc-detail-company-name').textContent = pc.company_name || pc.company || '-';
    document.getElementById('pc-detail-project-name').textContent = pc.project_name || pc.reference || '-';
    document.getElementById('pc-detail-account-manager').textContent = pc.account_manager || '-';
    // NEW FIELDS:
    document.getElementById('pc-detail-client-industry').textContent = pc.client_industry || '-';
    document.getElementById('pc-detail-client-source').textContent = pc.client_source || '-';
    document.getElementById('pc-detail-quote-limit').textContent = pc.quote_limit || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT;
    document.getElementById('pc-detail-status').textContent = pc.status || 'active';
    document.getElementById('pc-detail-project-description').textContent = pc.project_description || '-';
    
    // SIMPLIFIED CONTACT:
    document.getElementById('pc-detail-contact-name').textContent = pc.contact_name || pc.contactPerson || '-';
    document.getElementById('pc-detail-contact-phone').textContent = pc.contact_phone || pc.mobilePhone || '-';
    document.getElementById('pc-detail-contact-email').textContent = pc.contact_email || pc.email || '-';
    document.getElementById('pc-detail-postcode').textContent = pc.postcode || '-';

    const quotesTbody = document.getElementById('pc-quotes');
    quotesTbody.innerHTML = '';
    db.quotes.filter(q => (q.pc_id === id || q.pcId === id)).forEach(q => {
        const quoteNumber = q.quote_number || q.number;
        const totalCost = q.total_cost || q.total || 0;
        const validUntil = q.valid_until ? ` (Valid until: ${new Date(q.valid_until).toLocaleDateString()})` : '';
        quotesTbody.innerHTML += `<tr>
            <td>${quoteNumber}</td>
            <td>${q.title || 'v' + (q.version || 1)}</td>
            <td>£${totalCost.toFixed(2)}</td>
            <td>${q.status}${validUntil}</td>
            <td><button onclick="alert('Feature under development')">Show</button></td>
        </tr>`;
    });

    const activitiesTbody = document.getElementById('pc-activities');
    activitiesTbody.innerHTML = '';
    db.activities.filter(a => a.pcId === id).forEach(a => {
        activitiesTbody.innerHTML += `<tr><td>${a.crmId}</td><td>${a.type}</td><td>${new Date(a.date).toLocaleDateString()}</td><td>${a.status}</td>
        <td><button onclick="alert('Feature under development')">Show</button></td></tr>`;
    });

    showPage('pc-detail');
}

// ========================================
// Oferty
// ========================================

/**
 * @description Show the new quote creation modal with PC number selection dropdown
 * @example
 * showNewQuoteModal(); // Opens modal with all PC numbers for selection
 */
function showNewQuoteModal() {
    const pcSelect = document.getElementById('quote-modal-pc');
    pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
    db.pcs.forEach(pc => {
        pcSelect.innerHTML += `<option value="${pc.id}">${pc.pc_number || pc.number} - ${pc.company_name || pc.company}</option>`;
    });
    document.getElementById('quote-modal').classList.add('active');
}

function closeQuoteModal() {
    document.getElementById('quote-modal').classList.remove('active');
}

function proceedToQuoteBuilder() {
    const pcId = document.getElementById('quote-modal-pc').value;
    if (!pcId) {
        alert('Please select PC number!');
        return;
    }
    db.currentPC = db.pcs.find(p => p.id === pcId);
    closeQuoteModal();
    createQuote();
}

function createQuote() {
    if (!db.currentPC) return;
    db.editingQuote = null;
    db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
    
    document.getElementById('quote-builder-title').textContent = `New Quote for: ${db.currentPC.pc_number || db.currentPC.number}`;
    const priceListSelect = document.getElementById('quote-price-list');
    priceListSelect.innerHTML = '<option value="">Select price list...</option>';
    db.priceLists.filter(pl => pl.status === 'active' || pl.is_default).forEach(pl => {
        priceListSelect.innerHTML += `<option value="${pl.id}">${pl.name}</option>`;
    });

    // Initialize quote fields with defaults
    const validUntilDate = new Date();
    validUntilDate.setDate(validUntilDate.getDate() + CONFIG.BUSINESS.DEFAULT_QUOTE_VALIDITY_DAYS);
    document.getElementById('quote-valid-until').value = validUntilDate.toISOString().split('T')[0];
    
    document.getElementById('quote-vat-rate').value = CONFIG.BUSINESS.DEFAULT_VAT_RATE.toFixed(2);
    document.getElementById('quote-title').value = '';
    document.getElementById('quote-description').value = '';
    document.getElementById('quote-notes').value = '';
    document.getElementById('quote-terms').value = CONFIG.BUSINESS.DEFAULT_TERMS;

    // NEW Sprint 2: Initialize status, address and move type fields
    document.getElementById('quote-status').value = 'DRAFT'; // Always start as DRAFT
    document.getElementById('quote-move-type').value = '';
    
    // Clear all address fields
    ['quote-collection-name', 'quote-collection-phone', 'quote-collection-email', 'quote-collection-date',
     'quote-collection-address1', 'quote-collection-address2', 'quote-collection-city', 'quote-collection-county', 'quote-collection-postcode',
     'quote-delivery-name', 'quote-delivery-phone', 'quote-delivery-email', 'quote-delivery-date',
     'quote-delivery-address1', 'quote-delivery-address2', 'quote-delivery-city', 'quote-delivery-county', 'quote-delivery-postcode'
    ].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });
    
    // Uncheck same address checkbox
    document.getElementById('quote-same-address').checked = false;
    
    // Hide address sections initially
    document.getElementById('collection-section').style.display = 'none';
    document.getElementById('delivery-section').style.display = 'none';
    
    // Populate quoted activities for current PC
    populateQuotedActivities();

    document.getElementById('quote-items-section').style.display = 'none';
    document.getElementById('price-list-selector').style.display = 'block';
    showPage('quote-builder');
}

function handlePriceListChange() {
    db.selectedPriceListId = document.getElementById('quote-price-list').value;
    if (db.selectedPriceListId) {
        document.getElementById('quote-items-section').style.display = 'grid';
        // Wyczyść istniejące pozycje przy zmianie cennika
        db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
        document.getElementById('quote-human').innerHTML = '';
        document.getElementById('quote-vehicles').innerHTML = '';
        document.getElementById('quote-materials').innerHTML = '';
        document.getElementById('quote-other').innerHTML = '';
        calculateTotal();
    } else {
        document.getElementById('quote-items-section').style.display = 'none';
    }
}

function addLineItem(category) {
    const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
    if (!priceList) return;

    const categoryItems = priceList.items.filter(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        return resource && resource.category === category;
    });

    if (categoryItems.length === 0) {
        alert(`No resources in category "${category}" in this price list.`);
        return;
    }

    const lineId = 'line_' + Date.now();
    const container = document.getElementById('quote-' + category);
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line-item';
    lineDiv.id = lineId;

    let options = '<option value="">Select...</option>';
    categoryItems.forEach(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        options += `<option value="${resource.id}" data-price="${item.clientPrice}">${resource.name}</option>`;
    });

    lineDiv.innerHTML = `
        <input type="checkbox" class="line-item-checkbox" data-line-id="${lineId}" data-category="${category}" 
               onchange="window.updateBulkSelection()" style="margin-right: 0.5rem; transform: scale(1.2);">
        <select onchange="window.updateLinePrice('${lineId}', '${category}')">${options}</select>
        <input type="number" value="1" min="1" onchange="window.updateLineQty('${lineId}', '${category}')">
        <input type="text" readonly value="£0.00">
        <span class="line-item-total">£0.00</span>
        <button class="remove-btn" onclick="window.removeLine('${lineId}', '${category}')">×</button>
    `;
    container.appendChild(lineDiv);
    db.quoteItems[category].push({ id: lineId, resourceId: '', name: '', qty: 1, rate: 0, total: 0 });
}

function updateLinePrice(lineId, category) {
    const line = document.getElementById(lineId);
    const select = line.querySelector('select');
    const option = select.options[select.selectedIndex];
    const price = parseFloat(option.dataset.price || 0);
    const resourceId = select.value;

    const item = db.quoteItems[category].find(i => i.id === lineId);
    if (item) {
        item.resourceId = resourceId;
        item.name = option.text;
        item.rate = price;
        line.querySelectorAll('input')[1].value = '£' + price.toFixed(2);
        updateLineQty(lineId, category);
    }
}

function updateLineQty(lineId, category) {
    const line = document.getElementById(lineId);
    const qty = parseFloat(line.querySelectorAll('input')[0].value) || 1;
    const item = db.quoteItems[category].find(i => i.id === lineId);
    if(item) {
        item.qty = qty;
        item.total = item.qty * item.rate;
        line.querySelector('.line-item-total').textContent = '£' + item.total.toFixed(2);
    }
    calculateTotal();
}

function removeLine(lineId, category) {
    document.getElementById(lineId).remove();
    db.quoteItems[category] = db.quoteItems[category].filter(i => i.id !== lineId);
    calculateTotal();
}


/**
 * @description Calculate and update quote totals for all categories including VAT
 * @description Updates DOM elements with calculated subtotals, VAT amount, and final total
 * @example
 * calculateTotal(); // Recalculates all quote totals and updates UI display
 */
function calculateTotal() {
    let totals = { human: 0, vehicles: 0, materials: 0, other: 0 };
    for (let cat in db.quoteItems) {
        db.quoteItems[cat].forEach(item => { totals[cat] += item.total; });
    }
    
    document.getElementById('sum-human').textContent = '£' + totals.human.toFixed(2);
    document.getElementById('sum-vehicles').textContent = '£' + totals.vehicles.toFixed(2);
    document.getElementById('sum-materials').textContent = '£' + totals.materials.toFixed(2);
    document.getElementById('sum-other').textContent = '£' + totals.other.toFixed(2);
    
    const subtotal = totals.human + totals.vehicles + totals.materials + totals.other;
    document.getElementById('sum-subtotal').textContent = '£' + subtotal.toFixed(2);
    
    // Get configurable VAT rate
    const vatRateElement = document.getElementById('quote-vat-rate');
    const vatRate = vatRateElement ? parseFloat(vatRateElement.value) || 0 : 20;
    const vatAmount = subtotal * (vatRate / 100);
    const total = subtotal + vatAmount;
    
    // Update VAT amount display
    const vatAmountElement = document.getElementById('sum-vat');
    if (vatAmountElement) {
        vatAmountElement.textContent = '£' + vatAmount.toFixed(2);
    }
    
    document.getElementById('sum-total').textContent = '£' + total.toFixed(2);
}

// NEW Sprint 2 Functions: Address & Move Type handling
function toggleAddressSections() {
    const moveType = document.getElementById('quote-move-type').value;
    const collectionSection = document.getElementById('collection-section');
    const deliverySection = document.getElementById('delivery-section');
    
    // Hide both sections initially
    collectionSection.style.display = 'none';
    deliverySection.style.display = 'none';
    
    // Show sections based on move type
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        collectionSection.style.display = 'block';
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        deliverySection.style.display = 'block';
    }
    
    // Clear validation requirements when sections are hidden
    updateAddressValidation();
}

function copyCollectionToDelivery() {
    const checkbox = document.getElementById('quote-same-address');
    if (checkbox.checked) {
        // Copy collection data to delivery fields
        document.getElementById('quote-delivery-name').value = document.getElementById('quote-collection-name').value;
        document.getElementById('quote-delivery-phone').value = document.getElementById('quote-collection-phone').value;
        document.getElementById('quote-delivery-email').value = document.getElementById('quote-collection-email').value;
        document.getElementById('quote-delivery-date').value = document.getElementById('quote-collection-date').value;
        document.getElementById('quote-delivery-address1').value = document.getElementById('quote-collection-address1').value;
        document.getElementById('quote-delivery-address2').value = document.getElementById('quote-collection-address2').value;
        document.getElementById('quote-delivery-city').value = document.getElementById('quote-collection-city').value;
        document.getElementById('quote-delivery-county').value = document.getElementById('quote-collection-county').value;
        document.getElementById('quote-delivery-postcode').value = document.getElementById('quote-collection-postcode').value;
    }
}

function updateAddressValidation() {
    const moveType = document.getElementById('quote-move-type').value;
    const collectionFields = ['quote-collection-name', 'quote-collection-address1', 'quote-collection-city', 'quote-collection-postcode'];
    const deliveryFields = ['quote-delivery-name', 'quote-delivery-address1', 'quote-delivery-city', 'quote-delivery-postcode'];
    
    // Clear all required attributes first
    [...collectionFields, ...deliveryFields].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.removeAttribute('required');
    });
    
    // Set required based on move type
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        collectionFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.setAttribute('required', 'required');
        });
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        deliveryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.setAttribute('required', 'required');
        });
    }
}

function populateQuotedActivities() {
    const container = document.getElementById('quote-activities-multiselect');
    if (!db.currentPC) {
        container.innerHTML = '<p style="margin: 0; color: #666;">No PC selected</p>';
        return;
    }
    
    // Get activities for current PC
    const pcActivities = db.activities.filter(activity => 
        activity.pc_id === db.currentPC.id && activity.status !== 'cancelled'
    );
    
    if (pcActivities.length === 0) {
        container.innerHTML = '<p style="margin: 0; color: #666;">No activities found for this PC</p>';
        return;
    }
    
    // Create checkboxes for each activity
    container.innerHTML = pcActivities.map(activity => `
        <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
            <input type="checkbox" value="${activity.id}" onchange="window.updateQuotedActivities()" style="margin-right: 0.5rem;">
            <strong>${activity.title || activity.type}</strong> - ${activity.scheduled_date || 'No date'} 
            <span style="color: #666;">(${activity.status})</span>
        </label>
    `).join('');
}

function updateQuotedActivities() {
    // This function will be called when checkboxes change
    // The selected activities will be collected in saveQuote()
}

function handleQuoteStatusChange() {
    const status = document.getElementById('quote-status').value;
    const warningMessages = {
        'ISSUED': 'WARNING: Once marked as ISSUED, this quote cannot be edited!',
        'WON': 'FINAL STATE: Quote will be marked as WON and cannot be changed.',
        'LOST': 'FINAL STATE: Quote will be marked as LOST and cannot be changed.'
    };
    
    if (warningMessages[status]) {
        // Show warning but don't prevent selection
        setTimeout(() => alert(warningMessages[status]), 100);
    }
}

function validateQuoteEditability(quote) {
    // Check if quote can be edited based on status
    if (!quote || !quote.status) return true; // Default to editable for new quotes
    
    const nonEditableStatuses = ['ISSUED', 'WON', 'LOST'];
    return !nonEditableStatuses.includes(quote.status);
}

async function saveQuote() {
    if (!db.currentPC) return;
    
    const now = new Date().toISOString();
    const title = document.getElementById('quote-title').value.trim();
    const validUntil = document.getElementById('quote-valid-until').value;
    
    // NEW Sprint 2: Enhanced validation for move type and addresses
    const moveType = document.getElementById('quote-move-type').value;
    if (!title || !validUntil || !moveType) {
        alert('Quote title, valid until date, and move type are required!');
        return;
    }
    
    // Validate address fields based on move type
    let addressValidationError = '';
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        const collectionName = document.getElementById('quote-collection-name').value.trim();
        const collectionAddress1 = document.getElementById('quote-collection-address1').value.trim();
        const collectionCity = document.getElementById('quote-collection-city').value.trim();
        const collectionPostcode = document.getElementById('quote-collection-postcode').value.trim();
        
        if (!collectionName || !collectionAddress1 || !collectionCity || !collectionPostcode) {
            addressValidationError = 'Collection address: Contact name, address line 1, city, and postcode are required!';
        }
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        const deliveryName = document.getElementById('quote-delivery-name').value.trim();
        const deliveryAddress1 = document.getElementById('quote-delivery-address1').value.trim();
        const deliveryCity = document.getElementById('quote-delivery-city').value.trim();
        const deliveryPostcode = document.getElementById('quote-delivery-postcode').value.trim();
        
        if (!deliveryName || !deliveryAddress1 || !deliveryCity || !deliveryPostcode) {
            addressValidationError = 'Delivery address: Contact name, address line 1, city, and postcode are required!';
        }
    }
    
    if (addressValidationError) {
        alert(addressValidationError);
        return;
    }
    
    const subtotal = parseFloat(document.getElementById('sum-subtotal').textContent.replace('£', ''));
    const vatRate = parseFloat(document.getElementById('quote-vat-rate').value) || 20;
    const vatAmount = subtotal * (vatRate / 100);
    const totalCost = subtotal + vatAmount;
    
    // Convert old-style items to new line_items structure
    const lineItems = [];
    for (let category in db.quoteItems) {
        db.quoteItems[category].forEach(item => {
            if (item.resourceId) {
                lineItems.push({
                    resource_id: item.resourceId,
                    resource_name: item.name,
                    quantity: item.qty,
                    unit_price: item.rate,
                    line_total: item.total,
                    notes: `Category: ${category}`
                });
            }
        });
    }
    
    const pcQuotes = db.quotes.filter(q => q.pc_id === db.currentPC.id || q.pcId === db.currentPC.id);
    const quote = {
        id: generateUUID(),
        quote_number: `QT-${String(db.quotes.length + 1).padStart(6, '0')}`,
        pc_id: db.currentPC.id,
        pc_number: db.currentPC.pc_number || db.currentPC.number,
        company_name: db.currentPC.company_name || db.currentPC.company,
        title: title,
        description: document.getElementById('quote-description').value.trim(),
        status: document.getElementById('quote-status').value, // NEW Sprint 2: Use selected status
        valid_until: validUntil,
        subtotal: subtotal,
        vat_rate: vatRate,
        vat_amount: vatAmount,
        total_cost: totalCost,
        notes: document.getElementById('quote-notes').value.trim(),
        terms_conditions: document.getElementById('quote-terms').value.trim(),
        line_items: lineItems,
        
        // NEW Sprint 2: Move Type & Address fields
        move_type: moveType,
        
        // Collection address (only if applicable)
        collection_contact_name: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-name').value.trim() : null,
        collection_phone: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-phone').value.trim() : null,
        collection_email: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-email').value.trim() : null,
        collection_date: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-date').value : null,
        collection_address_1: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-address1').value.trim() : null,
        collection_address_2: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-address2').value.trim() : null,
        collection_city: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-city').value.trim() : null,
        collection_county: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-county').value.trim() : null,
        collection_postcode: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-postcode').value.trim() : null,
        
        // Delivery address (only if applicable)
        delivery_contact_name: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-name').value.trim() : null,
        delivery_phone: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-phone').value.trim() : null,
        delivery_email: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-email').value.trim() : null,
        delivery_date: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-date').value : null,
        delivery_address_1: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-address1').value.trim() : null,
        delivery_address_2: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-address2').value.trim() : null,
        delivery_city: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-city').value.trim() : null,
        delivery_county: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-county').value.trim() : null,
        delivery_postcode: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-postcode').value.trim() : null,
        
        // Quoted Activities (selected activity IDs)
        quoted_activities: Array.from(document.querySelectorAll('#quote-activities-multiselect input[type="checkbox"]:checked')).map(cb => cb.value),
        
        created_at: now,
        updated_at: now
    };

        try {
        // Add quote to memory first
    db.quotes.push(quote);
        
        // Save to IndexedDB with retry logic
        await saveWithRetry(STORES.QUOTES, quote, 3);
        
        console.log('✅ Quote saved successfully:', quote.quote_number);
        alert('Quote ' + quote.quote_number + ' has been saved!');
    viewPC(db.currentPC.id);
    } catch (error) {
        // Remove from memory if save failed
        db.quotes = db.quotes.filter(q => q.id !== quote.id);
        console.error('❌ Error saving quote after retries:', error);
        alert('Failed to save quote after multiple attempts. Please check your connection and try again.');
    }
}

function cancelQuote() {
    if (confirm('Are you sure you want to cancel quote creation?')) {
        viewPC(db.currentPC.id);
    }
}

function renderQuotesList() {
    const tbody = document.getElementById('quotes-list');
    tbody.innerHTML = '';
    db.quotes.forEach(q => {
        const pc = db.pcs.find(p => p.id === (q.pc_id || q.pcId));
        const quoteNumber = q.quote_number || q.number;
        const pcNumber = pc ? (pc.pc_number || pc.number) : q.pc_number || '-';
        const companyName = pc ? (pc.company_name || pc.company) : q.company_name || '-';
        const totalCost = q.total_cost || q.total || 0;
        tbody.innerHTML += `<tr>
            <td>${quoteNumber}</td><td>${pcNumber}</td><td>${companyName}</td><td>£${totalCost.toFixed(2)}</td><td>${q.status}</td>
            <td><button class="secondary" onclick="alert('Feature under development')">Show</button></td>
        </tr>`;
    });
}

// ========================================
// NEW Sprint 3: Enhanced Resource Lookup
// ========================================

// Global variable to track selected resources in modal
let selectedResources = new Set();
let filteredResourcesList = [];

function showEnhancedResourceModal(category = '') {
    // Initialize modal state
    selectedResources.clear();
    document.getElementById('resource-search').value = '';
    document.getElementById('resource-category-filter').value = category;
    document.getElementById('resource-status-filter').value = '';
    
    // Show modal
    document.getElementById('enhanced-resource-lookup-modal').classList.add('active');
    
    // Load and filter resources
    filterResources();
    
    // Focus on search box for better UX
    setTimeout(() => document.getElementById('resource-search').focus(), 100);
}

function closeEnhancedResourceModal() {
    document.getElementById('enhanced-resource-lookup-modal').classList.remove('active');
    selectedResources.clear();
}

function filterResources() {
    const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
    if (!priceList) {
        document.getElementById('enhanced-resources-list').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">Please select a price list first</td></tr>';
        return;
    }
    
    const searchTerm = document.getElementById('resource-search').value.toLowerCase();
    const categoryFilter = document.getElementById('resource-category-filter').value;
    const statusFilter = document.getElementById('resource-status-filter').value;
    
    // Get all resources with pricing from current price list
    const resourcesWithPricing = priceList.items.map(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        if (!resource) return null;
        
        return {
            ...resource,
            client_price: item.clientPrice,
            price_list_item: item
        };
    }).filter(Boolean);
    
    // Apply filters
    filteredResourcesList = resourcesWithPricing.filter(resource => {
        // Search filter
        const matchesSearch = !searchTerm || 
            resource.name.toLowerCase().includes(searchTerm) ||
            (resource.sku || '').toLowerCase().includes(searchTerm) ||
            (resource.description || '').toLowerCase().includes(searchTerm);
        
        // Category filter  
        const matchesCategory = !categoryFilter || resource.category === categoryFilter;
        
        // Status filter
        const matchesStatus = !statusFilter || resource.is_active.toString() === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    // Update resource count
    document.getElementById('resource-count').textContent = filteredResourcesList.length;
    
    // Render filtered resources
    renderResourcesList();
}

function renderResourcesList() {
    const tbody = document.getElementById('enhanced-resources-list');
    
    if (filteredResourcesList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">No resources found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredResourcesList.map(resource => {
        const isSelected = selectedResources.has(resource.id);
        const statusBadge = resource.is_active ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">INACTIVE</span>';
        
        return `
            <tr style="background: ${isSelected ? '#f0f9ff' : 'white'};" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='${isSelected ? '#f0f9ff' : 'white'}'">
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} 
                           onchange="window.toggleResourceSelection('${resource.id}')" 
                           style="transform: scale(1.2);">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <div style="font-weight: 500;">${resource.name}</div>
                    ${resource.description ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${resource.description}</div>` : ''}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">${resource.sku || 'N/A'}</code>
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; text-transform: capitalize;">
                    ${resource.category}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: 500;">
                    £${resource.client_price.toFixed(2)}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <input type="number" value="1" min="1" max="999" 
                           style="width: 60px; padding: 0.25rem; border: 1px solid #ccc; border-radius: 0.25rem;"
                           id="qty-${resource.id}" onchange="window.updateResourceTotal('${resource.id}')">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: 500;">
                    <span id="total-${resource.id}">£${resource.client_price.toFixed(2)}</span>
                </td>
            </tr>
        `;
    }).join('');
    
    updateSelectionCount();
}

function toggleResourceSelection(resourceId) {
    if (selectedResources.has(resourceId)) {
        selectedResources.delete(resourceId);
    } else {
        selectedResources.add(resourceId);
    }
    
    renderResourcesList();
}

function updateResourceTotal(resourceId) {
    const resource = filteredResourcesList.find(r => r.id === resourceId);
    const qty = parseInt(document.getElementById(`qty-${resourceId}`).value) || 1;
    const total = resource.client_price * qty;
    
    document.getElementById(`total-${resourceId}`).textContent = `£${total.toFixed(2)}`;
}

function selectAllFilteredResources() {
    filteredResourcesList.forEach(resource => {
        selectedResources.add(resource.id);
    });
    renderResourcesList();
}

function clearResourceSelection() {
    selectedResources.clear();
    renderResourcesList();
}

function updateSelectionCount() {
    const count = selectedResources.size;
    document.getElementById('selected-count').textContent = count;
    
    const addButton = document.getElementById('add-selected-btn');
    addButton.disabled = count === 0;
    addButton.textContent = count === 0 ? 'Add Selected to Quote' : `Add ${count} Selected to Quote`;
}

function addSelectedResourcesToQuote() {
    if (selectedResources.size === 0) return;
    
    let addedCount = 0;
    
    selectedResources.forEach(resourceId => {
        const resource = filteredResourcesList.find(r => r.id === resourceId);
        if (!resource) return;
        
        const qty = parseInt(document.getElementById(`qty-${resourceId}`).value) || 1;
        
        // Add to appropriate category
        addResourceToQuoteCategory(resource, qty);
        addedCount++;
    });
    
    // Update totals
    calculateTotal();
    
    // Show success message
    alert(`Successfully added ${addedCount} resource(s) to quote!`);
    
    // Close modal
    closeEnhancedResourceModal();
}

function addResourceToQuoteCategory(resource, qty) {
    const category = resource.category;
    const lineId = 'line_' + Date.now() + '_' + resource.id;
    const container = document.getElementById('quote-' + category);
    
    // Create line item element
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line-item';
    lineDiv.id = lineId;
    
    const total = resource.client_price * qty;
    
    lineDiv.innerHTML = `
        <input type="checkbox" class="line-item-checkbox" data-line-id="${lineId}" data-category="${category}" 
               onchange="window.updateBulkSelection()" style="margin-right: 0.5rem; transform: scale(1.2);">
        <select disabled style="background: #f1f5f9;">
            <option value="${resource.id}" data-price="${resource.client_price}">${resource.name}</option>
        </select>
        <input type="number" value="${qty}" min="1" onchange="window.updateLineQty('${lineId}', '${category}')" style="width: 80px;">
        <input type="text" readonly value="£${resource.client_price.toFixed(2)}" style="background: #f1f5f9;">
        <span class="line-item-total">£${total.toFixed(2)}</span>
        <button class="remove-btn" onclick="window.removeLine('${lineId}', '${category}')">×</button>
    `;
    
    container.appendChild(lineDiv);
    
    // Add to quote items
    db.quoteItems[category].push({
        id: lineId,
        resourceId: resource.id,
        name: resource.name,
        qty: qty,
        rate: resource.client_price,
        total: total
    });
}

// ========================================
// NEW Sprint 3.2: Bulk Operations for Line Items
// ========================================

function updateBulkSelection() {
    const checkboxes = document.querySelectorAll('.line-item-checkbox');
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    // Update bulk selection count
    document.getElementById('bulk-selected-count').textContent = count;
    
    // Show/hide bulk operations panel
    const panel = document.getElementById('bulk-operations-panel');
    panel.style.display = count > 0 ? 'block' : 'none';
    
    // Update category "Select All" checkboxes
    ['human', 'vehicles', 'materials', 'other'].forEach(category => {
        const categoryCheckboxes = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]`);
        const categorySelected = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]:checked`);
        const selectAllCheckbox = document.getElementById(`select-all-${category}`);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.indeterminate = categorySelected.length > 0 && categorySelected.length < categoryCheckboxes.length;
            selectAllCheckbox.checked = categoryCheckboxes.length > 0 && categorySelected.length === categoryCheckboxes.length;
        }
    });
}

function toggleCategorySelection(category) {
    const selectAllCheckbox = document.getElementById(`select-all-${category}`);
    const categoryCheckboxes = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]`);
    
    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkSelection();
}

function clearBulkSelection() {
    document.querySelectorAll('.line-item-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkSelection();
}

function bulkUpdateQuantity() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    document.getElementById('bulk-qty-count').textContent = selectedCheckboxes.length;
    document.getElementById('bulk-quantity-modal').classList.add('active');
    document.getElementById('bulk-qty-value').focus();
}

function closeBulkQuantityModal() {
    document.getElementById('bulk-quantity-modal').classList.remove('active');
    document.getElementById('bulk-qty-value').value = '';
    document.getElementById('bulk-qty-operation').value = 'set';
}

function applyBulkQuantityUpdate() {
    const operation = document.getElementById('bulk-qty-operation').value;
    const value = parseFloat(document.getElementById('bulk-qty-value').value);
    
    if (isNaN(value) || value < 0) {
        alert('Please enter a valid positive number');
        return;
    }
    
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    let updatedCount = 0;
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        const lineDiv = document.getElementById(lineId);
        const qtyInput = lineDiv.querySelector('input[type="number"]');
        const currentQty = parseFloat(qtyInput.value) || 1;
        
        let newQty;
        switch (operation) {
            case 'set':
                newQty = value;
                break;
            case 'multiply':
                newQty = currentQty * value;
                break;
            case 'add':
                newQty = currentQty + value;
                break;
            default:
                newQty = value;
        }
        
        newQty = Math.max(1, Math.round(newQty)); // Minimum 1, round to integer
        qtyInput.value = newQty;
        
        // Update the quote item data and trigger calculation
        updateLineQty(lineId, category);
        updatedCount++;
    });
    
    alert(`Successfully updated quantities for ${updatedCount} line items!`);
    closeBulkQuantityModal();
    clearBulkSelection();
}

function bulkApplyDiscount() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    document.getElementById('bulk-discount-count').textContent = selectedCheckboxes.length;
    document.getElementById('bulk-discount-modal').classList.add('active');
    document.getElementById('bulk-discount-value').focus();
}

function closeBulkDiscountModal() {
    document.getElementById('bulk-discount-modal').classList.remove('active');
    document.getElementById('bulk-discount-value').value = '';
    document.getElementById('bulk-discount-type').value = 'percentage';
}

function applyBulkDiscount() {
    const discountType = document.getElementById('bulk-discount-type').value;
    const discountValue = parseFloat(document.getElementById('bulk-discount-value').value);
    
    if (isNaN(discountValue) || discountValue < 0) {
        alert('Please enter a valid discount value');
        return;
    }
    
    if (discountType === 'percentage' && discountValue > 100) {
        alert('Percentage discount cannot exceed 100%');
        return;
    }
    
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    let updatedCount = 0;
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        const lineDiv = document.getElementById(lineId);
        const priceInput = lineDiv.querySelectorAll('input[type="text"]')[0];
        const currentPriceText = priceInput.value.replace('£', '');
        const currentPrice = parseFloat(currentPriceText) || 0;
        
        let newPrice;
        if (discountType === 'percentage') {
            newPrice = currentPrice * (1 - (discountValue / 100));
        } else {
            newPrice = Math.max(0, currentPrice - discountValue);
        }
        
        newPrice = Math.max(0, newPrice); // Minimum 0
        priceInput.value = '£' + newPrice.toFixed(2);
        
        // Update the quote item data
        const item = db.quoteItems[category].find(i => i.id === lineId);
        if (item) {
            item.rate = newPrice;
            updateLineQty(lineId, category); // This will recalculate totals
        }
        
        updatedCount++;
    });
    
    alert(`Successfully applied discount to ${updatedCount} line items!`);
    closeBulkDiscountModal();
    clearBulkSelection();
}

function bulkDeleteItems() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    const itemCount = selectedCheckboxes.length;
    if (!confirm(`Are you sure you want to delete ${itemCount} selected line items?`)) {
        return;
    }
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        removeLine(lineId, category);
    });
    
    alert(`Successfully deleted ${itemCount} line items!`);
    updateBulkSelection(); // Update the UI
}

// ========================================
// NEW Sprint 3.3: Template Management
// ========================================

function updateTemplatesList() {
    const tbody = document.getElementById('templates-list');
    if (!db.templates) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No templates available</td></tr>';
        return;
    }
    
    // Apply filters
    const searchTerm = document.getElementById('template-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('template-category-filter')?.value || '';
    const statusFilter = document.getElementById('template-status-filter')?.value || '';
    
    let filteredTemplates = db.templates.filter(template => {
        const matchesSearch = !searchTerm || 
            template.name.toLowerCase().includes(searchTerm) ||
            (template.description || '').toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || template.category === categoryFilter;
        const matchesStatus = !statusFilter || template.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    if (filteredTemplates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No templates found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredTemplates.map(template => {
        const itemCount = template.items ? template.items.length : 0;
        const statusBadge = template.status === 'active' ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ARCHIVED</span>';
        
        const lastUpdated = new Date(template.updated_at).toLocaleDateString();
        
        return `
            <tr>
                <td>
                    <div style="font-weight: 500;">${template.name}</div>
                    ${template.description ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${template.description}</div>` : ''}
                </td>
                <td style="text-transform: capitalize;">${template.category}</td>
                <td style="text-align: center;">${itemCount} items</td>
                <td style="font-weight: 500;">£${template.estimated_value.toFixed(2)}</td>
                <td>${lastUpdated}</td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="window.createQuoteFromTemplate('${template.id}')" style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Use Template</button>
                        <button onclick="window.editTemplate('${template.id}')" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                        <button onclick="window.deleteTemplate('${template.id}')" style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterTemplates() {
    updateTemplatesList();
}

function showCreateTemplateFromScratch() {
    // Clear template modal
    document.getElementById('template-modal-title').textContent = 'Create New Template';
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-category').value = '';
    document.getElementById('template-description').value = '';
    document.getElementById('template-status').value = 'active';
    document.getElementById('template-vat-rate').value = '20.00';
    document.getElementById('template-terms').value = 'Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.';
    
    // Clear template items preview
    document.getElementById('template-items-preview').innerHTML = '<p style="margin: 0; color: #666; text-align: center;">No items added yet. Click "Add Items to Template" to add resources.</p>';
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function saveQuoteAsTemplate() {
    // Collect current quote data
    const title = document.getElementById('quote-title').value.trim();
    const description = document.getElementById('quote-description').value.trim();
    const terms = document.getElementById('quote-terms').value.trim();
    const vatRate = parseFloat(document.getElementById('quote-vat-rate').value) || 20;
    
    if (!title) {
        alert('Please enter a quote title first');
        return;
    }
    
    // Convert current quote items to template format
    const templateItems = [];
    let totalValue = 0;
    
    for (let category in db.quoteItems) {
        db.quoteItems[category].forEach(item => {
            if (item.resourceId) {
                templateItems.push({
                    resource_id: item.resourceId,
                    resource_name: item.name,
                    quantity: item.qty,
                    unit_price: item.rate,
                    line_total: item.total,
                    notes: `Category: ${category}`
                });
                totalValue += item.total;
            }
        });
    }
    
    if (templateItems.length === 0) {
        alert('Please add some items to the quote first');
        return;
    }
    
    // Pre-fill template modal with quote data
    document.getElementById('template-modal-title').textContent = 'Save Quote as Template';
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = title + ' Template';
    document.getElementById('template-category').value = '';
    document.getElementById('template-description').value = description || 'Template created from quote: ' + title;
    document.getElementById('template-status').value = 'active';
    document.getElementById('template-vat-rate').value = vatRate.toString();
    document.getElementById('template-terms').value = terms;
    
    // Show template items preview
    const totalWithVat = totalValue * (1 + vatRate / 100);
    document.getElementById('template-items-preview').innerHTML = `
        <div style="margin-bottom: 1rem;">
            <strong>${templateItems.length} items</strong> - Estimated value: <strong>£${totalWithVat.toFixed(2)}</strong> (inc VAT)
        </div>
        ${templateItems.slice(0, 3).map(item => `
            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 0.25rem;">
                <span style="font-weight: 500;">${item.resource_name}</span> x${item.quantity} = £${item.line_total.toFixed(2)}
            </div>
        `).join('')}
        ${templateItems.length > 3 ? `<div style="color: #666; font-style: italic;">... and ${templateItems.length - 3} more items</div>` : ''}
    `;
    
    // Store items in a temporary variable for saving
    window.tempTemplateItems = templateItems;
    window.tempTemplateValue = totalWithVat;
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function duplicateCurrentQuote() {
    const title = document.getElementById('quote-title').value.trim();
    
    if (!title) {
        alert('Please save this quote first before duplicating');
        return;
    }
    
    if (!confirm('This will create a new quote with the same items. Continue?')) {
        return;
    }
    
    // Create new quote with current items but clear other fields
    const newTitle = title + ' (Copy)';
    document.getElementById('quote-title').value = newTitle;
    document.getElementById('quote-description').value = '';
    document.getElementById('quote-notes').value = '';
    
    // Clear address fields
    document.getElementById('quote-move-type').value = '';
    toggleAddressSections();
    
    // Clear quoted activities
    document.querySelectorAll('#quote-activities-multiselect input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    alert('Quote duplicated! Please update the details and save.');
}

function closeTemplateModal() {
    document.getElementById('template-modal').classList.remove('active');
    window.tempTemplateItems = null;
    window.tempTemplateValue = null;
}

function saveTemplate() {
    const id = document.getElementById('template-id').value;
    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const description = document.getElementById('template-description').value.trim();
    const status = document.getElementById('template-status').value;
    const vatRate = parseFloat(document.getElementById('template-vat-rate').value) || 20;
    const terms = document.getElementById('template-terms').value.trim();
    
    if (!name || !category) {
        alert('Template name and category are required!');
        return;
    }
    
    const items = window.tempTemplateItems || [];
    const estimatedValue = window.tempTemplateValue || 0;
    
    if (items.length === 0) {
        alert('Please add some items to the template');
        return;
    }
    
    const now = new Date().toISOString();
    const template = {
        id: id || generateUUID(),
        name,
        category,
        description,
        status,
        vat_rate: vatRate,
        terms_conditions: terms,
        items,
        estimated_value: estimatedValue,
        created_at: id ? db.templates.find(t => t.id === id)?.created_at || now : now,
        updated_at: now
    };
    
    if (id) {
        // Edit existing template
        const index = db.templates.findIndex(t => t.id === id);
        if (index !== -1) {
            db.templates[index] = template;
        }
    } else {
        // Create new template
        db.templates.push(template);
    }
    
    // Save to IndexedDB
    saveDataToIndexedDB().then(() => {
        alert(`Template "${name}" saved successfully!`);
        closeTemplateModal();
        updateTemplatesList();
    }).catch(error => {
        console.error('Error saving template:', error);
        alert('Error saving template. Please try again.');
    });
}

function editTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    // Fill template modal with existing data
    document.getElementById('template-modal-title').textContent = 'Edit Template';
    document.getElementById('template-id').value = template.id;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-category').value = template.category;
    document.getElementById('template-description').value = template.description || '';
    document.getElementById('template-status').value = template.status;
    document.getElementById('template-vat-rate').value = template.vat_rate.toString();
    document.getElementById('template-terms').value = template.terms_conditions || '';
    
    // Show template items
    const items = template.items || [];
    document.getElementById('template-items-preview').innerHTML = `
        <div style="margin-bottom: 1rem;">
            <strong>${items.length} items</strong> - Estimated value: <strong>£${template.estimated_value.toFixed(2)}</strong> (inc VAT)
        </div>
        ${items.slice(0, 5).map(item => `
            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 0.25rem;">
                <span style="font-weight: 500;">${item.resource_name}</span> x${item.quantity} = £${item.line_total.toFixed(2)}
            </div>
        `).join('')}
        ${items.length > 5 ? `<div style="color: #666; font-style: italic;">... and ${items.length - 5} more items</div>` : ''}
    `;
    
    // Store items for editing
    window.tempTemplateItems = items;
    window.tempTemplateValue = template.estimated_value;
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function deleteTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!confirm(`Are you sure you want to delete template "${template.name}"?`)) {
        return;
    }
    
    db.templates = db.templates.filter(t => t.id !== templateId);
    
    saveDataToIndexedDB().then(() => {
        alert('Template deleted successfully!');
        updateTemplatesList();
    }).catch(error => {
        console.error('Error deleting template:', error);
        alert('Error deleting template. Please try again.');
    });
}

function createQuoteFromTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!db.currentPC) {
        alert('Please select a PC Number first');
        return;
    }
    
    if (!confirm(`Create a new quote using template "${template.name}"?`)) {
        return;
    }
    
    // Start fresh quote creation
    createQuote();
    
    // Wait for quote builder to initialize, then populate with template data
    setTimeout(() => {
        // Set quote metadata
        document.getElementById('quote-title').value = template.name;
        document.getElementById('quote-description').value = template.description || '';
        document.getElementById('quote-terms').value = template.terms_conditions || '';
        document.getElementById('quote-vat-rate').value = template.vat_rate.toString();
        
        // Add template items to quote
        template.items.forEach(templateItem => {
            const resource = db.resources.find(r => r.id === templateItem.resource_id);
            if (resource) {
                addResourceToQuoteCategory(resource, templateItem.quantity);
            }
        });
        
        // Recalculate totals
        calculateTotal();
        
        alert(`Quote created from template "${template.name}"! Please review and modify as needed.`);
    }, 500);
}

function addItemsToTemplate() {
    alert('Feature under development: Manual item addition to templates will be available in a future update. For now, create templates from existing quotes.');
}

// ========================================
// NEW Sprint 4.1: Activity Template Management
// ========================================

function updateActivityTemplatesList() {
    const tbody = document.getElementById('activity-templates-list');
    if (!db.activityTemplates) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No activity templates available</td></tr>';
        return;
    }
    
    // Apply filters
    const searchTerm = document.getElementById('activity-template-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('activity-template-category-filter')?.value || '';
    const statusFilter = document.getElementById('activity-template-status-filter')?.value || '';
    
    let filteredTemplates = db.activityTemplates.filter(template => {
        const matchesSearch = !searchTerm || 
            template.name.toLowerCase().includes(searchTerm) ||
            (template.description || '').toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || template.category === categoryFilter;
        const matchesStatus = !statusFilter || template.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    if (filteredTemplates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No activity templates found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredTemplates.map(template => {
        const priorityBadge = {
            'low': '<span style="background: #e5e7eb; color: #374151; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">LOW</span>',
            'medium': '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">MEDIUM</span>',
            'high': '<span style="background: #fecaca; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">HIGH</span>',
            'urgent': '<span style="background: #ef4444; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">URGENT</span>'
        }[template.priority] || template.priority;
        
        const statusBadge = template.status === 'active' ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ARCHIVED</span>';
        
        const lastUpdated = new Date(template.updated_at).toLocaleDateString();
        const duration = template.duration_hours ? `${template.duration_hours}h` : 'Not set';
        
        return `
            <tr>
                <td>
                    <div style="font-weight: 500;">${template.name}</div>
                    ${template.description ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${template.description}</div>` : ''}
                </td>
                <td style="text-transform: capitalize;">${template.category}</td>
                <td style="text-align: center; font-weight: 500;">${duration}</td>
                <td>${priorityBadge}</td>
                <td>${lastUpdated}</td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="window.createActivityFromTemplate('${template.id}')" style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Use Template</button>
                        <button onclick="window.editActivityTemplate('${template.id}')" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                        <button onclick="window.deleteActivityTemplate('${template.id}')" style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterActivityTemplates() {
    updateActivityTemplatesList();
}

function showCreateActivityTemplate() {
    // Clear modal
    document.getElementById('activity-template-modal-title').textContent = 'Create Activity Template';
    document.getElementById('activity-template-id').value = '';
    document.getElementById('activity-template-name').value = '';
    document.getElementById('activity-template-category').value = '';
    document.getElementById('activity-template-description').value = '';
    document.getElementById('activity-template-priority').value = 'medium';
    document.getElementById('activity-template-duration').value = '';
    document.getElementById('activity-template-status').value = 'active';
    document.getElementById('activity-template-assigned-to').value = '';
    document.getElementById('activity-template-schedule-offset').value = '';
    document.getElementById('activity-template-checklist').value = '';
    document.getElementById('activity-template-completion-notes').value = '';
    
    // Show modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
}

function closeActivityTemplateModal() {
    document.getElementById('activity-template-modal').classList.remove('active');
}

function saveActivityTemplate() {
    const id = document.getElementById('activity-template-id').value;
    const name = document.getElementById('activity-template-name').value.trim();
    const category = document.getElementById('activity-template-category').value;
    const description = document.getElementById('activity-template-description').value.trim();
    const priority = document.getElementById('activity-template-priority').value;
    const duration = parseFloat(document.getElementById('activity-template-duration').value);
    const status = document.getElementById('activity-template-status').value;
    const assignedTo = document.getElementById('activity-template-assigned-to').value.trim();
    const scheduleOffset = parseInt(document.getElementById('activity-template-schedule-offset').value);
    const checklist = document.getElementById('activity-template-checklist').value.trim();
    const completionNotes = document.getElementById('activity-template-completion-notes').value.trim();
    
    if (!name || !category || !priority) {
        alert('Template name, category, and priority are required!');
        return;
    }
    
    const now = new Date().toISOString();
    const template = {
        id: id || generateUUID(),
        name,
        category,
        description,
        priority,
        duration_hours: duration || null,
        status,
        assigned_to_default: assignedTo || null,
        schedule_offset_days: scheduleOffset || null,
        pre_activity_checklist: checklist,
        completion_notes_template: completionNotes,
        created_at: id ? db.activityTemplates.find(t => t.id === id)?.created_at || now : now,
        updated_at: now
    };
    
    if (id) {
        // Edit existing template
        const index = db.activityTemplates.findIndex(t => t.id === id);
        if (index !== -1) {
            db.activityTemplates[index] = template;
        }
    } else {
        // Create new template
        db.activityTemplates.push(template);
    }
    
    // Save to IndexedDB
    saveDataToIndexedDB().then(() => {
        alert(`Activity template "${name}" saved successfully!`);
        closeActivityTemplateModal();
        updateActivityTemplatesList();
    }).catch(error => {
        console.error('Error saving activity template:', error);
        alert('Error saving activity template. Please try again.');
    });
}

function editActivityTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    // Fill modal with existing data
    document.getElementById('activity-template-modal-title').textContent = 'Edit Activity Template';
    document.getElementById('activity-template-id').value = template.id;
    document.getElementById('activity-template-name').value = template.name;
    document.getElementById('activity-template-category').value = template.category;
    document.getElementById('activity-template-description').value = template.description || '';
    document.getElementById('activity-template-priority').value = template.priority;
    document.getElementById('activity-template-duration').value = template.duration_hours || '';
    document.getElementById('activity-template-status').value = template.status;
    document.getElementById('activity-template-assigned-to').value = template.assigned_to_default || '';
    document.getElementById('activity-template-schedule-offset').value = template.schedule_offset_days || '';
    document.getElementById('activity-template-checklist').value = template.pre_activity_checklist || '';
    document.getElementById('activity-template-completion-notes').value = template.completion_notes_template || '';
    
    // Show modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
}

function deleteActivityTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!confirm(`Are you sure you want to delete activity template "${template.name}"?`)) {
        return;
    }
    
    db.activityTemplates = db.activityTemplates.filter(t => t.id !== templateId);
    
    saveDataToIndexedDB().then(() => {
        alert('Activity template deleted successfully!');
        updateActivityTemplatesList();
    }).catch(error => {
        console.error('Error deleting activity template:', error);
        alert('Error deleting activity template. Please try again.');
    });
}

function createActivityFromTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!db.currentPC) {
        alert('Please select a PC Number first');
        return;
    }
    
    if (!confirm(`Create a new activity using template "${template.name}"?`)) {
        return;
    }
    
    // Calculate scheduled date based on template offset
    let scheduledDate = new Date();
    if (template.schedule_offset_days) {
        scheduledDate.setDate(scheduledDate.getDate() + template.schedule_offset_days);
    }
    
    // Open activity modal with template data
    showActivityModal();
    
    // Wait for modal to initialize, then populate with template data
    setTimeout(() => {
        document.getElementById('activity-title').value = template.name;
        document.getElementById('activity-description').value = template.description || '';
        document.getElementById('activity-priority').value = template.priority;
        document.getElementById('activity-duration').value = template.duration_hours || '';
        document.getElementById('activity-assigned-to').value = template.assigned_to_default || '';
        
        // Set scheduled date
        const dateString = scheduledDate.toISOString().split('T')[0];
        document.getElementById('activity-date').value = dateString;
        
        // Add checklist to description if provided
        if (template.pre_activity_checklist) {
            const currentDesc = document.getElementById('activity-description').value;
            const newDesc = currentDesc ? 
                `${currentDesc}\n\nPre-activity checklist:\n${template.pre_activity_checklist}` : 
                `Pre-activity checklist:\n${template.pre_activity_checklist}`;
            document.getElementById('activity-description').value = newDesc;
        }
        
        alert(`Activity created from template "${template.name}"! Please review and save.`);
    }, 500);
}

function saveActivityAsTemplate() {
    // Collect current activity data
    const title = document.getElementById('activity-title').value.trim();
    const description = document.getElementById('activity-description').value.trim();
    const priority = document.getElementById('activity-priority').value;
    const duration = parseFloat(document.getElementById('activity-duration').value);
    const assignedTo = document.getElementById('activity-assigned-to').value.trim();
    
    if (!title) {
        alert('Please enter an activity title first');
        return;
    }
    
    // Show activity template modal with pre-filled data
    document.getElementById('activity-template-modal-title').textContent = 'Save Activity as Template';
    document.getElementById('activity-template-id').value = '';
    document.getElementById('activity-template-name').value = title + ' Template';
    document.getElementById('activity-template-category').value = '';
    document.getElementById('activity-template-description').value = description || 'Template created from activity: ' + title;
    document.getElementById('activity-template-priority').value = priority;
    document.getElementById('activity-template-duration').value = duration || '';
    document.getElementById('activity-template-status').value = 'active';
    document.getElementById('activity-template-assigned-to').value = assignedTo;
    document.getElementById('activity-template-schedule-offset').value = '';
    document.getElementById('activity-template-checklist').value = '';
    document.getElementById('activity-template-completion-notes').value = '';
    
    // Show template modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
    
    alert('Activity data has been loaded into template form. Please complete the category and save.');
}

// ========================================
// NEW Sprint 4.2: Calendar Management
// ========================================

// Global calendar state
let currentCalendarDate = new Date();
let currentCalendarView = CONFIG.UI.CALENDAR.DEFAULT_VIEW;
let currentActivitiesView = CONFIG.UI.CALENDAR.DEFAULT_ACTIVITIES_VIEW;

function switchActivitiesView(view) {
    console.log('🔄 Switching activities view to:', view);
    currentActivitiesView = view;
    
    // Update button states
    const listBtn = document.getElementById('activities-list-view-btn');
    const calendarBtn = document.getElementById('activities-calendar-view-btn');
    const workflowBtn = document.getElementById('activities-workflow-view-btn');
    const calendarNav = document.getElementById('calendar-navigation');
    
    console.log('📊 Elements found:', { listBtn, calendarBtn, workflowBtn, calendarNav });
    
    // Update button styles - reset all
    [listBtn, calendarBtn, workflowBtn].forEach(btn => {
        if (btn) {
            btn.style.background = 'transparent';
            btn.style.color = '#374151';
        }
    });
    
    // Hide all views
    document.getElementById('activities-list-view').style.display = 'none';
    document.getElementById('activities-calendar-view').style.display = 'none';
    document.getElementById('activities-workflow-view').style.display = 'none';
    calendarNav.style.display = 'none';
    
    // Show selected view
    switch(view) {
        case 'list':
            document.getElementById('activities-list-view').style.display = 'block';
            listBtn.style.background = '#3b82f6';
            listBtn.style.color = 'white';
            updateActivitiesList();
            break;
        case 'calendar':
            document.getElementById('activities-calendar-view').style.display = 'block';
            calendarNav.style.display = 'flex';
            calendarBtn.style.background = '#3b82f6';
            calendarBtn.style.color = 'white';
            console.log('📅 Initializing calendar view...');
            updateCalendarTitle();
            renderCalendar();
            console.log('✅ Calendar view should be visible now!');
            break;
        case 'workflow':
            document.getElementById('activities-workflow-view').style.display = 'block';
            if (workflowBtn) {
                workflowBtn.style.background = '#3b82f6';
                workflowBtn.style.color = 'white';
            }
            updateWorkflowView();
            break;
    }
}

function setCalendarView(view) {
    currentCalendarView = view;
    
    // Update view button states
    const monthBtn = document.getElementById('calendar-month-btn');
    const weekBtn = document.getElementById('calendar-week-btn');
    
    if (view === 'month') {
        monthBtn.style.background = '#3b82f6';
        monthBtn.style.color = 'white';
        weekBtn.style.background = 'transparent';
        weekBtn.style.color = '#374151';
        
        document.getElementById('calendar-month-view').style.display = 'block';
        document.getElementById('calendar-week-view').style.display = 'none';
    } else {
        weekBtn.style.background = '#3b82f6';
        weekBtn.style.color = 'white';
        monthBtn.style.background = 'transparent';
        monthBtn.style.color = '#374151';
        
        document.getElementById('calendar-month-view').style.display = 'none';
        document.getElementById('calendar-week-view').style.display = 'block';
    }
    
    updateCalendarTitle();
    renderCalendar();
    
    // NEW Sprint 4.2.3: Update workload panel when view changes
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function navigateCalendar(direction) {
    const currentDate = new Date(currentCalendarDate);
    
    if (direction === 'prev') {
        if (currentCalendarView === 'month') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
        }
    } else if (direction === 'next') {
        if (currentCalendarView === 'month') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
        }
    } else if (direction === 'today') {
        currentCalendarDate = new Date();
    }
    
    updateCalendarTitle();
    renderCalendar();
    
    // NEW Sprint 4.2.3: Update workload panel when navigation changes
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function updateCalendarTitle() {
    const titleElement = document.getElementById('calendar-title');
    const options = currentCalendarView === 'month' 
        ? { month: 'long', year: 'numeric' }
        : { month: 'short', day: 'numeric', year: 'numeric' };
    
    if (currentCalendarView === 'week') {
        // For week view, show the week range
        const startOfWeek = getStartOfWeek(currentCalendarDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);
        
        const startStr = startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const endStr = endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        titleElement.textContent = `${startStr} - ${endStr}`;
    } else {
        titleElement.textContent = currentCalendarDate.toLocaleDateString('en-US', options);
    }
}

function getStartOfWeek(date) {
    const result = new Date(date);
    const day = result.getDay();
    const diff = result.getDate() - day; // Adjust for Sunday as first day
    result.setDate(diff);
    return result;
}

function renderCalendar() {
    if (currentCalendarView === 'month') {
        renderMonthView();
    } else {
        renderWeekView();
    }
}

function renderMonthView() {
    const grid = document.getElementById('calendar-grid');
    
    // Clear existing content
    grid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'week-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first and last day of the month view
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    
    // Get the start of the calendar grid (may include previous month days)
    const startDate = getStartOfWeek(firstDay);
    
    // Generate 42 days (6 weeks * 7 days)
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Add classes for styling
        if (date.getMonth() !== currentCalendarDate.getMonth()) {
            dayElement.classList.add('other-month');
        }
        
        if (isToday(date)) {
            dayElement.classList.add('today');
        }
        
        // Add day number
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = date.getDate();
        dayElement.appendChild(dayHeader);
        
        // Add activities for this day
        const dayActivities = getActivitiesForDate(date);
        dayActivities.forEach(activity => {
            const activityElement = document.createElement('div');
            activityElement.className = `calendar-activity priority-${activity.priority} status-${activity.status}`;
            activityElement.textContent = activity.title;
            activityElement.onclick = () => showActivityInSidebar(activity);
            
            // NEW Sprint 4.2.3: Enhance with assignee information
            enhanceActivityWithAssignee(activityElement, activity);
            
            // NEW Sprint 4.2.4: Enhance with recurring information
            enhanceActivityWithRecurring(activityElement, activity);
            
            dayElement.appendChild(activityElement);
        });
        
        grid.appendChild(dayElement);
    }
    
    // NEW Sprint 4.2.2: Enable drag & drop for month view activities
    setTimeout(() => {
        document.querySelectorAll('.calendar-activity').forEach(activity => {
            makeActivityDraggable(activity);
        });
        
        // Make month calendar days droppable
        document.querySelectorAll('.calendar-day').forEach(day => {
            makeMonthDayDroppable(day);
        });
    }, 100);
}

function renderWeekView() {
    const weekGrid = document.getElementById('week-grid-content');
    weekGrid.innerHTML = '';
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const timeSlots = generateTimeSlots();
    
    // Create week view grid: time labels + 7 days
    const grid = weekGrid.parentElement;
    grid.innerHTML = ''; // Clear all content
    
    // Add empty corner cell
    const corner = document.createElement('div');
    corner.className = 'week-time-label';
    grid.appendChild(corner);
    
    // Add day headers
    for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        if (isToday(date)) dayHeader.classList.add('today');
        
        dayHeader.innerHTML = `
            <div style="font-weight: 500;">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
            <div style="font-size: 1.25rem;">${date.getDate()}</div>
        `;
        grid.appendChild(dayHeader);
    }
    
    // Add time slots and day columns
    timeSlots.forEach(time => {
        // Time label
        const timeLabel = document.createElement('div');
        timeLabel.className = 'week-time-label';
        timeLabel.textContent = time;
        grid.appendChild(timeLabel);
        
        // Day columns for this time slot
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            
            const timeSlot = document.createElement('div');
            timeSlot.className = 'week-time-slot';
            
            // Add activities for this time slot
            const slotActivities = getActivitiesForTimeSlot(date, time);
            slotActivities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = `calendar-activity priority-${activity.priority} status-${activity.status}`;
                activityElement.textContent = activity.title;
                activityElement.onclick = () => showActivityInSidebar(activity);
                
                // NEW Sprint 4.2.3: Enhance with assignee information
                enhanceActivityWithAssignee(activityElement, activity);
                
                // NEW Sprint 4.2.4: Enhance with recurring information
                enhanceActivityWithRecurring(activityElement, activity);
                
                timeSlot.appendChild(activityElement);
            });
            
            grid.appendChild(timeSlot);
        }
    });
    
    // NEW Sprint 4.2.2: Enable drag & drop after rendering
    setTimeout(() => {
        enableDragAndDrop();
    }, 100);
}

function generateTimeSlots() {
    const slots = [];
    for (let hour = 8; hour <= 18; hour++) {
        const time12 = hour > 12 ? `${hour - 12}:00 PM` : hour === 12 ? '12:00 PM' : `${hour}:00 AM`;
        slots.push(time12);
    }
    return slots;
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}

function getActivitiesForDate(date) {
    if (!db.activities) return [];
    
    return db.activities.filter(activity => {
        if (!activity.scheduled_date) return false;
        const activityDate = new Date(activity.scheduled_date);
        return activityDate.toDateString() === date.toDateString();
    });
}

function getActivitiesForTimeSlot(date, timeSlot) {
    const dateActivities = getActivitiesForDate(date);
    
    // For now, return all activities for the date
    // In a more advanced version, we could parse scheduled_time and match time slots
    return dateActivities;
}

function showActivityInSidebar(activity) {
    const sidebar = document.getElementById('calendar-activity-sidebar');
    const content = document.getElementById('calendar-activity-content');
    
    const pc = db.pcs.find(p => p.id === activity.pc_id);
    const statusBadge = `<span class="activity-status-${activity.status}">${activity.status.toUpperCase()}</span>`;
    const priorityBadge = `<span class="priority-${activity.priority}">${activity.priority.toUpperCase()}</span>`;
    
    // NEW Sprint 4.2.4: Check if this is a recurring activity
    const isRecurring = isRecurringActivity(activity);
    const recurringInfo = isRecurring ? `
        <div style="background: #e0e7ff; border: 1px solid #c7d2fe; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #3730a3; font-weight: 600; margin-bottom: 0.5rem;">
                🔄 Recurring Activity
            </div>
            <div style="font-size: 0.875rem; color: #3730a3;">
                <strong>Series Position:</strong> ${activity.recurring_sequence || 'N/A'}<br>
                ${activity.recurring_config ? `<strong>Pattern:</strong> ${getRecurringText(activity.recurring_config)}` : ''}
            </div>
        </div>
    ` : '';
    
    const assignedMember = getTeamMemberName(activity.assigned_to);
    
    content.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0;">${activity.title}</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                ${statusBadge}
                ${priorityBadge}
            </div>
        </div>
        
        ${recurringInfo}
        
        <div style="margin-bottom: 1rem;">
            <strong>PC Number:</strong> ${activity.pc_number || 'N/A'}<br>
            <strong>Company:</strong> ${pc ? pc.company_name : 'N/A'}<br>
            <strong>Scheduled:</strong> ${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not scheduled'}<br>
            <strong>Duration:</strong> ${activity.estimated_hours || 'N/A'} hours<br>
            <strong>Assigned to:</strong> ${assignedMember || 'Unassigned'}
        </div>
        
        ${activity.description ? `
            <div style="margin-bottom: 1rem;">
                <strong>Description:</strong><br>
                <div style="background: #f9fafb; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.25rem;">
                    ${activity.description}
                </div>
            </div>
        ` : ''}
        
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button onclick="window.editActivityFromCalendarRecurring('${activity.id}')" style="background: #3b82f6; color: white; padding: 0.5rem 1rem;">
                ${isRecurring ? '🔄 Edit Series' : 'Edit'}
            </button>
            <button onclick="window.closeCalendarSidebar()" class="secondary" style="padding: 0.5rem 1rem;">Close</button>
        </div>
    `;
    
    sidebar.style.display = 'block';
}

function closeCalendarSidebar() {
    document.getElementById('calendar-activity-sidebar').style.display = 'none';
}

function editActivityFromCalendar(activityId) {
    closeCalendarSidebar();
    const activity = db.activities.find(a => a.id === activityId);
    if (activity) {
        // Use existing edit functionality
        editActivity(activityId);
    }
}

// ========================================
// NEW Sprint 4.2.2: Drag & Drop Time Slot Management
// ========================================

let draggedActivity = null;
let dragStartSlot = null;
let quickCreateSlotData = null;

function enableDragAndDrop() {
    console.log('🎯 Enabling drag & drop for calendar activities...');
    
    // Add drag and drop functionality to existing calendar activities
    document.querySelectorAll('.calendar-activity').forEach(activity => {
        makeActivityDraggable(activity);
    });
    
    // Add drop zones and click handlers to time slots
    document.querySelectorAll('.week-time-slot').forEach(slot => {
        makeTimeSlotDroppable(slot);
        addTimeSlotClickHandler(slot);
    });
}

function makeActivityDraggable(activityElement) {
    activityElement.draggable = true;
    activityElement.classList.add('draggable');
    
    activityElement.addEventListener('dragstart', (e) => {
        draggedActivity = activityElement;
        dragStartSlot = activityElement.parentElement;
        activityElement.classList.add('dragging');
        
        // Store activity data for the drag operation
        const activityId = getActivityIdFromElement(activityElement);
        e.dataTransfer.setData('text/plain', activityId);
        e.dataTransfer.effectAllowed = 'move';
        
        console.log('🎯 Drag started for activity:', activityId);
    });
    
    activityElement.addEventListener('dragend', (e) => {
        activityElement.classList.remove('dragging');
        draggedActivity = null;
        dragStartSlot = null;
        
        // Remove drag-over styles from all slots
        document.querySelectorAll('.week-time-slot').forEach(slot => {
            slot.classList.remove('drag-over', 'time-conflict-warning');
        });
    });
}

function makeTimeSlotDroppable(slotElement) {
    slotElement.classList.add('time-slot-drop-zone');
    
    slotElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedActivity) {
            slotElement.classList.add('drag-over');
            
            // Check for time conflicts
            const hasConflict = checkTimeConflict(slotElement, draggedActivity);
            if (hasConflict) {
                slotElement.classList.add('time-conflict-warning');
            }
        }
    });
    
    slotElement.addEventListener('dragleave', (e) => {
        // Only remove styles if we're leaving the slot entirely
        if (!slotElement.contains(e.relatedTarget)) {
            slotElement.classList.remove('drag-over', 'time-conflict-warning');
        }
    });
    
    slotElement.addEventListener('drop', (e) => {
        e.preventDefault();
        slotElement.classList.remove('drag-over', 'time-conflict-warning');
        
        const activityId = e.dataTransfer.getData('text/plain');
        if (activityId && draggedActivity) {
            moveActivityToTimeSlot(activityId, slotElement);
        }
    });
    
    // Add visual hints for empty slots
    if (slotElement.children.length === 0) {
        slotElement.classList.add('empty');
        addTimeSlotHint(slotElement);
    }
}

function addTimeSlotClickHandler(slotElement) {
    slotElement.addEventListener('dblclick', (e) => {
        // Only trigger if we didn't click on an existing activity
        if (e.target === slotElement || e.target.classList.contains('time-slot-create-hint')) {
            const slotData = getTimeSlotData(slotElement);
            showQuickCreateForm(slotData);
        }
    });
}

function addTimeSlotHint(slotElement) {
    const hint = document.createElement('div');
    hint.className = 'time-slot-create-hint';
    hint.textContent = 'Double-click to create activity';
    slotElement.appendChild(hint);
}

function getActivityIdFromElement(activityElement) {
    // Extract activity ID from the activity element's onclick handler or data attribute
    const onclickAttr = activityElement.getAttribute('onclick');
    if (onclickAttr) {
        const match = onclickAttr.match(/showActivityInSidebar\(([^)]+)\)/);
        if (match) {
            // This is a complex object, we need to find the activity by title
            const title = activityElement.textContent;
            const activity = db.activities.find(a => a.title === title);
            return activity ? activity.id : null;
        }
    }
    return null;
}

function getTimeSlotData(slotElement) {
    // Extract date and time information from the slot's position in the grid
    const weekGrid = slotElement.closest('#calendar-week-view');
    const allSlots = Array.from(weekGrid.querySelectorAll('.week-time-slot'));
    const slotIndex = allSlots.indexOf(slotElement);
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const timeSlots = generateTimeSlots();
    
    // Calculate which day and time this slot represents
    const dayIndex = slotIndex % 7;
    const timeIndex = Math.floor(slotIndex / 7);
    
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + dayIndex);
    
            const timeSlot = timeSlots[timeIndex] || CONFIG.BUSINESS.DEFAULT_ACTIVITY_TIME;
    
    return {
        date: date,
        time: timeSlot,
        slotElement: slotElement
    };
}

function checkTimeConflict(targetSlot, draggedActivityElement) {
    // Check if the target slot already has activities
    const existingActivities = targetSlot.querySelectorAll('.calendar-activity');
    
    // For now, we'll warn if there are already activities in the slot
    // In a more sophisticated version, we could check actual time overlaps
    return existingActivities.length > 0;
}

function moveActivityToTimeSlot(activityId, targetSlot) {
    console.log('🎯 Moving activity to new time slot:', activityId);
    
    const activity = db.activities.find(a => a.id === activityId);
    if (!activity) {
        console.error('Activity not found:', activityId);
        return;
    }
    
    const slotData = getTimeSlotData(targetSlot);
    
    // Update the activity's scheduled date and time
    activity.scheduled_date = slotData.date.toISOString().split('T')[0];
    activity.scheduled_time = convertTimeSlotTo24Hour(slotData.time);
    
    // Update in IndexedDB
    saveWithRetry('ACTIVITIES', activity)
        .then(() => {
            console.log('✅ Activity moved successfully');
            // Refresh calendar view
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after moving activities
            setTimeout(checkForNotifications, 1000);
            
            // Show success message
            showNotification('Activity moved successfully!', 'success');
        })
        .catch(error => {
            console.error('Failed to move activity:', error);
            showNotification('Failed to move activity', 'error');
        });
}

function convertTimeSlotTo24Hour(timeSlot) {
    // Convert "9:00 AM" format to "09:00" format
    const [time, period] = timeSlot.split(' ');
    const [hours, minutes] = time.split(':');
    let hour24 = parseInt(hours);
    
    if (period === 'PM' && hour24 !== 12) {
        hour24 += 12;
    } else if (period === 'AM' && hour24 === 12) {
        hour24 = 0;
    }
    
    return `${hour24.toString().padStart(2, '0')}:${minutes}`;
}

function showQuickCreateForm(slotData) {
    console.log('🎯 Showing quick create form for slot:', slotData);
    
    quickCreateSlotData = slotData;
    
    // Populate time slot info
    const timeInfo = document.getElementById('quick-create-time-info');
    timeInfo.innerHTML = `
        <strong>📅 ${slotData.date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })}</strong><br>
        🕐 ${slotData.time}
    `;
    
    // Populate PC numbers dropdown
    populateQuickCreatePCs();
    
    // Populate team members dropdown
    populateAssigneeDropdowns();
    
    // Clear form
    document.getElementById('quick-create-form').reset();
    
    // Show overlay
    const overlay = document.getElementById('quick-create-overlay');
    overlay.style.display = 'flex';
    
    // Focus title field
    setTimeout(() => {
        document.getElementById('quick-activity-title').focus();
    }, 100);
}

function populateQuickCreatePCs() {
    const pcSelect = document.getElementById('quick-activity-pc');
    pcSelect.innerHTML = '<option value="">Select PC Number</option>';
    
    if (db.pcs) {
        db.pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `${pc.pc_number} - ${pc.company_name}`;
            pcSelect.appendChild(option);
        });
    }
}

function closeQuickCreate() {
    document.getElementById('quick-create-overlay').style.display = 'none';
    quickCreateSlotData = null;
}

function submitQuickCreate(event) {
    event.preventDefault();
    
    if (!quickCreateSlotData) {
        console.error('No slot data available');
        return;
    }
    
    const formData = new FormData(event.target);
    const baseActivityData = {
        id: generateUUID(),
        title: formData.get('title'),
        description: formData.get('description') || '',
        pc_id: formData.get('pc_id') || '',
        priority: formData.get('priority') || 'normal',
        status: 'scheduled',
        estimated_hours: parseFloat(formData.get('estimated_hours')) || 1,
        scheduled_date: quickCreateSlotData.date.toISOString().split('T')[0],
        scheduled_time: convertTimeSlotTo24Hour(quickCreateSlotData.time),
        created_date: new Date().toISOString().split('T')[0],
        assigned_to: formData.get('assigned_to') || '',
        completion_notes: '',
        is_recurring: false
    };
    
    let activitiesToCreate = [baseActivityData];
    
    // NEW Sprint 4.2.4: Handle recurring activities
    const isRecurring = formData.get('recurring_enabled') === 'on';
    if (isRecurring) {
        const recurringConfig = {
            frequency: formData.get('recurring_frequency'),
            interval: parseInt(formData.get('recurring_interval')) || 1,
            endDate: formData.get('recurring_end_date') || null,
            count: parseInt(formData.get('recurring_count')) || null
        };
        
        // Create recurring activities
        activitiesToCreate = createRecurringActivities(baseActivityData, recurringConfig);
        console.log(`🔄 Created ${activitiesToCreate.length} recurring activities`);
    }
    
    // Add to database
    if (!db.activities) db.activities = [];
    activitiesToCreate.forEach(activity => {
        db.activities.push(activity);
    });
    
    // Save to IndexedDB
    Promise.all(activitiesToCreate.map(activity => saveWithRetry('ACTIVITIES', activity)))
        .then(() => {
            console.log('✅ Activities created successfully');
            closeQuickCreate();
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after creating activities
            setTimeout(checkForNotifications, 1000);
            
            const message = isRecurring 
                ? `Created ${activitiesToCreate.length} recurring activities successfully!`
                : 'Activity created successfully!';
            showNotification(message, 'success');
        })
        .catch(error => {
            console.error('Failed to create activities:', error);
            showNotification('Failed to create activities', 'error');
        });
}

function makeMonthDayDroppable(dayElement) {
    dayElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedActivity) {
            dayElement.classList.add('drag-over');
        }
    });
    
    dayElement.addEventListener('dragleave', (e) => {
        if (!dayElement.contains(e.relatedTarget)) {
            dayElement.classList.remove('drag-over');
        }
    });
    
    dayElement.addEventListener('drop', (e) => {
        e.preventDefault();
        dayElement.classList.remove('drag-over');
        
        const activityId = e.dataTransfer.getData('text/plain');
        if (activityId && draggedActivity) {
            moveActivityToMonthDay(activityId, dayElement);
        }
    });
    
    // Add double-click handler for quick create in month view
    dayElement.addEventListener('dblclick', (e) => {
        // Only trigger if we didn't click on an existing activity
        if (e.target === dayElement || e.target.classList.contains('calendar-day-header')) {
            const dayDate = getDateFromMonthDay(dayElement);
            const slotData = {
                date: dayDate,
                time: CONFIG.BUSINESS.DEFAULT_ACTIVITY_TIME, // Default time for month view
                slotElement: dayElement
            };
            showQuickCreateForm(slotData);
        }
    });
}

function getDateFromMonthDay(dayElement) {
    // Extract date from the day element's date data or text content
    const dayHeader = dayElement.querySelector('.calendar-day-header');
    if (dayHeader) {
        const dayNumber = parseInt(dayHeader.textContent);
        if (!isNaN(dayNumber)) {
            // Reconstruct the date based on current calendar date and day number
            const monthStart = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const firstDayOfWeek = monthStart.getDay();
            const calendarStart = new Date(monthStart);
            calendarStart.setDate(monthStart.getDate() - firstDayOfWeek);
            
            // Find which calendar day this is
            const allDays = Array.from(dayElement.parentElement.querySelectorAll('.calendar-day'));
            const dayIndex = allDays.indexOf(dayElement);
            
            const targetDate = new Date(calendarStart);
            targetDate.setDate(calendarStart.getDate() + dayIndex);
            
            return targetDate;
        }
    }
    
    // Fallback to current date
    return new Date();
}

function moveActivityToMonthDay(activityId, dayElement) {
    console.log('🎯 Moving activity to month day:', activityId);
    
    const activity = db.activities.find(a => a.id === activityId);
    if (!activity) {
        console.error('Activity not found:', activityId);
        return;
    }
    
    const dayDate = getDateFromMonthDay(dayElement);
    
    // Update the activity's scheduled date (keep existing time if any)
    activity.scheduled_date = dayDate.toISOString().split('T')[0];
    
    // Update in IndexedDB
    saveWithRetry('ACTIVITIES', activity)
        .then(() => {
            console.log('✅ Activity moved successfully');
            // Refresh calendar view
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after moving activities
            setTimeout(checkForNotifications, 1000);
            
            // Show success message
            showNotification('Activity moved successfully!', 'success');
        })
        .catch(error => {
            console.error('Failed to move activity:', error);
            showNotification('Failed to move activity', 'error');
        });
}

function showNotification(message, type = 'info') {
    // Simple notification system - you might want to enhance this
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 3000;
        transition: all 0.3s ease;
        max-width: 300px;
    `;
    
    switch (type) {
        case 'success':
            notification.style.background = '#10b981';
            break;
        case 'error':
            notification.style.background = '#ef4444';
            break;
        default:
            notification.style.background = '#3b82f6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => {
            if (notification.parentElement) {
                notification.parentElement.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ========================================
// NEW Sprint 4.2.3: Team Management & Workload Balancing
// ========================================

// Team members data - loaded from CONFIG
let teamMembers = [...CONFIG.TEAM.DEFAULT_MEMBERS];

let currentTeamFilter = CONFIG.TEAM.DEFAULT_FILTER;
let workloadPanelVisible = false;

function initializeTeamManagement() {
    console.log('🎯 Initializing team management...');
    renderTeamFilterChips();
    populateAssigneeDropdowns();
    updateWorkloadPanel();
}

function renderTeamFilterChips() {
    const container = document.getElementById('team-filter-chips');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Add "All" chip
    const allChip = document.createElement('div');
    allChip.className = `team-member-chip all ${currentTeamFilter === 'all' ? 'active' : ''}`;
    allChip.innerHTML = '👥 All Team';
    allChip.onclick = () => filterByTeamMember('all');
    container.appendChild(allChip);
    
    // Add team member chips
    teamMembers.forEach(member => {
        const chip = document.createElement('div');
        chip.className = `team-member-chip ${currentTeamFilter === member.id ? 'active' : ''}`;
        chip.style.background = member.color;
        chip.style.color = 'white';
        chip.innerHTML = `
            <div class="assignee-avatar" style="background: ${member.color}; margin-right: 0.5rem;">
                ${member.name.split(' ').map(n => n[0]).join('')}
            </div>
            ${member.name}
        `;
        chip.onclick = () => filterByTeamMember(member.id);
        container.appendChild(chip);
    });
}

function populateAssigneeDropdowns() {
    // Populate quick create form
    const quickSelect = document.getElementById('quick-activity-assignee');
    if (quickSelect) {
        quickSelect.innerHTML = '<option value="">Unassigned</option>';
        teamMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.name} (${member.role})`;
            quickSelect.appendChild(option);
        });
    }
    
    // Populate regular activity form if it exists
    const activitySelect = document.getElementById('activity-assigned-to');
    if (activitySelect) {
        activitySelect.innerHTML = '<option value="">Unassigned</option>';
        teamMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.name} (${member.role})`;
            activitySelect.appendChild(option);
        });
    }
}

function filterByTeamMember(memberId) {
    console.log('🎯 Filtering by team member:', memberId);
    
    currentTeamFilter = memberId;
    renderTeamFilterChips();
    
    // Apply filter to calendar view
    const activities = document.querySelectorAll('.calendar-activity');
    activities.forEach(activity => {
        const activityData = getActivityDataFromElement(activity);
        if (memberId === 'all' || !activityData.assigned_to || activityData.assigned_to === memberId) {
            activity.style.display = '';
        } else {
            activity.style.display = 'none';
        }
    });
}

function getActivityDataFromElement(activityElement) {
    // Extract activity data from element (simplified for now)
    const title = activityElement.textContent;
    const activity = db.activities?.find(a => a.title === title);
    return activity || { assigned_to: '' };
}

function toggleWorkloadPanel() {
    const panel = document.getElementById('workload-panel');
    workloadPanelVisible = !workloadPanelVisible;
    
    if (workloadPanelVisible) {
        panel.style.display = 'block';
        updateWorkloadPanel();
    } else {
        panel.style.display = 'none';
    }
}

function updateWorkloadPanel() {
    if (!workloadPanelVisible) return;
    
    const weekDisplay = document.getElementById('workload-week-display');
    const summaryContainer = document.getElementById('workload-summary');
    
    if (!weekDisplay || !summaryContainer) return;
    
    // Get current week
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    weekDisplay.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    
    // Calculate workload for each team member
    const workloadData = calculateTeamWorkload(startOfWeek, endOfWeek);
    
    // Render workload cards
    summaryContainer.innerHTML = '';
    teamMembers.forEach(member => {
        const memberWorkload = workloadData[member.id] || { hours: 0, activities: 0 };
        const workloadCard = createWorkloadCard(member, memberWorkload);
        summaryContainer.appendChild(workloadCard);
    });
}

function calculateTeamWorkload(startDate, endDate) {
    if (!db.activities) return {};
    
    const workload = {};
    
    db.activities.forEach(activity => {
        if (!activity.assigned_to || !activity.scheduled_date) return;
        
        const activityDate = new Date(activity.scheduled_date);
        if (activityDate >= startDate && activityDate <= endDate) {
            if (!workload[activity.assigned_to]) {
                workload[activity.assigned_to] = { hours: 0, activities: 0 };
            }
            
            workload[activity.assigned_to].hours += activity.estimated_hours || 1;
            workload[activity.assigned_to].activities += 1;
        }
    });
    
    return workload;
}

function createWorkloadCard(member, workload) {
    const card = document.createElement('div');
    card.className = 'workload-card';
    card.style.setProperty('--member-color', member.color);
    
    const utilizationPercent = Math.round((workload.hours / member.max_hours) * 100);
    const workloadLevel = getWorkloadLevel(utilizationPercent);
    
    card.innerHTML = `
        <h4>
            <div class="assignee-avatar" style="background: ${member.color}; display: inline-flex; margin-right: 0.5rem;">
                ${member.name.split(' ').map(n => n[0]).join('')}
            </div>
            ${member.name}
        </h4>
        <div class="workload-stats">
            <span>${workload.hours}h / ${member.max_hours}h</span>
            <span>${utilizationPercent}%</span>
        </div>
        <div class="workload-bar">
            <div class="workload-bar-fill ${workloadLevel}" style="width: ${Math.min(utilizationPercent, 100)}%;"></div>
        </div>
        <div class="workload-stats">
            <span>${workload.activities} activities</span>
            <span class="${workloadLevel}">${getWorkloadText(workloadLevel)}</span>
        </div>
    `;
    
    return card;
}

function getWorkloadLevel(percent) {
    if (percent <= 70) return 'workload-low';
    if (percent <= 90) return 'workload-medium';
    if (percent <= 100) return 'workload-high';
    return 'workload-overloaded';
}

function getWorkloadText(level) {
    switch (level) {
        case 'workload-low': return 'Available';
        case 'workload-medium': return 'Busy';
        case 'workload-high': return 'Full';
        case 'workload-overloaded': return 'Overloaded';
        default: return 'Unknown';
    }
}

function showTeamManagement() {
    document.getElementById('team-management-modal').style.display = 'flex';
    renderTeamMembersList();
}

function closeTeamManagement() {
    document.getElementById('team-management-modal').style.display = 'none';
}

function renderTeamMembersList() {
    const container = document.getElementById('team-members-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (teamMembers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No team members yet. Add one above!</div>';
        return;
    }
    
    teamMembers.forEach(member => {
        const memberElement = document.createElement('div');
        memberElement.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        `;
        
        memberElement.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div class="assignee-avatar" style="background: ${member.color}; margin-right: 0.75rem;">
                    ${member.name.split(' ').map(n => n[0]).join('')}
                </div>
                <div>
                    <div style="font-weight: 500;">${member.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">${member.role} • ${member.max_hours}h/week</div>
                    ${member.email ? `<div style="font-size: 0.75rem; color: #9ca3af;">${member.email}</div>` : ''}
                </div>
            </div>
            <button onclick="window.removeTeamMember('${member.id}')" 
                    style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                Remove
            </button>
        `;
        
        container.appendChild(memberElement);
    });
}

function addTeamMember(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const member = {
        id: generateUUID(),
        name: formData.get('name'),
        role: formData.get('role') || 'Team Member',
        email: formData.get('email') || '',
        max_hours: parseInt(formData.get('max_hours')) || 40,
        color: generateTeamMemberColor()
    };
    
    teamMembers.push(member);
    
    // Save to IndexedDB (if we want persistence)
    localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
    
    // Update UI
    renderTeamMembersList();
    renderTeamFilterChips();
    populateAssigneeDropdowns();
    
    // Clear form
    event.target.reset();
    
    showNotification(`Team member ${member.name} added successfully!`, 'success');
}

function removeTeamMember(memberId) {
    if (confirm('Are you sure you want to remove this team member?')) {
        teamMembers = teamMembers.filter(member => member.id !== memberId);
        
        // Save to localStorage
        localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
        
        // Update UI
        renderTeamMembersList();
        renderTeamFilterChips();
        populateAssigneeDropdowns();
        
        showNotification('Team member removed successfully!', 'success');
    }
}

function generateTeamMemberColor() {
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];
    return colors[teamMembers.length % colors.length];
}

function loadTeamMembersFromStorage() {
    const stored = localStorage.getItem('teamMembers');
    if (stored) {
        try {
            teamMembers = JSON.parse(stored);
        } catch (e) {
            console.error('Failed to load team members from storage:', e);
        }
    }
}

// Update activity rendering to show assignee colors
function enhanceActivityWithAssignee(activityElement, activity) {
    if (activity.assigned_to) {
        const member = teamMembers.find(m => m.id === activity.assigned_to);
        if (member) {
            activityElement.classList.add('assigned');
            activityElement.style.setProperty('--assignee-color', member.color);
            
            // Add workload indicator
            const workloadLevel = calculateMemberWorkloadLevel(member.id);
            const indicator = document.createElement('div');
            indicator.className = `workload-indicator ${workloadLevel}`;
            activityElement.appendChild(indicator);
        }
    }
}

function calculateMemberWorkloadLevel(memberId) {
    const member = teamMembers.find(m => m.id === memberId);
    if (!member) return 'workload-low';
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const workload = calculateTeamWorkload(startOfWeek, endOfWeek);
    const memberWorkload = workload[memberId] || { hours: 0 };
    const utilizationPercent = (memberWorkload.hours / member.max_hours) * 100;
    
    return getWorkloadLevel(utilizationPercent);
}

// ========================================
// NEW Sprint 4.2.4: Recurring Activities Management
// ========================================

let currentRecurringActivity = null;

function toggleRecurringOptions(checkbox) {
    const options = document.getElementById('quick-recurring-options');
    const preview = document.getElementById('quick-recurring-preview');
    
    if (checkbox.checked) {
        options.classList.add('active');
        updateRecurringPreview();
        
        // Add event listeners for live preview updates
        document.getElementById('quick-recurring-frequency').addEventListener('change', updateRecurringPreview);
        document.getElementById('quick-recurring-interval').addEventListener('input', updateRecurringPreview);
        document.getElementById('quick-recurring-end-date').addEventListener('change', updateRecurringPreview);
        document.getElementById('quick-recurring-count').addEventListener('input', updateRecurringPreview);
    } else {
        options.classList.remove('active');
        preview.style.display = 'none';
    }
}

function updateRecurringPreview() {
    const frequency = document.getElementById('quick-recurring-frequency').value;
    const interval = parseInt(document.getElementById('quick-recurring-interval').value) || 1;
    const endDate = document.getElementById('quick-recurring-end-date').value;
    const count = parseInt(document.getElementById('quick-recurring-count').value);
    
    // Update unit text
    const unitElement = document.getElementById('quick-recurring-unit');
    const unitMap = {
        'daily': interval === 1 ? 'day' : 'days',
        'weekly': interval === 1 ? 'week' : 'weeks',
        'monthly': interval === 1 ? 'month' : 'months',
        'yearly': interval === 1 ? 'year' : 'years'
    };
    unitElement.textContent = unitMap[frequency] || 'times';
    
    // Generate preview
    const startDate = quickCreateSlotData ? quickCreateSlotData.date : new Date();
    const previewDates = generateRecurringDates(startDate, frequency, interval, endDate, count, 5); // Show max 5 for preview
    
    const preview = document.getElementById('quick-recurring-preview');
    if (previewDates.length > 0) {
        const totalOccurrences = generateRecurringDates(startDate, frequency, interval, endDate, count).length;
        
        preview.innerHTML = `
            <h5>📅 Recurring Schedule Preview (${totalOccurrences} total occurrences)</h5>
            <div class="recurring-preview-dates">
                ${previewDates.map(date => 
                    `• ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}`
                ).join('<br>')}
                ${totalOccurrences > 5 ? '<br>• ... and more' : ''}
            </div>
        `;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function generateRecurringDates(startDate, frequency, interval, endDate, count, maxPreview = null) {
    const dates = [];
    let currentDate = new Date(startDate);
    const endDateTime = endDate ? new Date(endDate) : null;
    const maxOccurrences = count || CONFIG.BUSINESS.MAX_RECURRING_OCCURRENCES; // Default max to prevent infinite loops
    
    let occurrenceCount = 0;
    
    while (occurrenceCount < maxOccurrences) {
        // Add current date
        dates.push(new Date(currentDate));
        occurrenceCount++;
        
        // Check if we've reached the end date
        if (endDateTime && currentDate >= endDateTime) break;
        
        // Check if we've reached preview limit
        if (maxPreview && dates.length >= maxPreview) break;
        
        // Calculate next date based on frequency and interval
        switch (frequency) {
            case 'daily':
                currentDate.setDate(currentDate.getDate() + interval);
                break;
            case 'weekly':
                currentDate.setDate(currentDate.getDate() + (interval * 7));
                break;
            case 'monthly':
                currentDate.setMonth(currentDate.getMonth() + interval);
                break;
            case 'yearly':
                currentDate.setFullYear(currentDate.getFullYear() + interval);
                break;
        }
    }
    
    return dates;
}

function createRecurringActivities(baseActivityData, recurringConfig) {
    console.log('🔄 Creating recurring activities...', recurringConfig);
    
    const { frequency, interval, endDate, count } = recurringConfig;
    const startDate = new Date(baseActivityData.scheduled_date);
    const dates = generateRecurringDates(startDate, frequency, interval, endDate, count);
    
    const activities = [];
    const seriesId = generateUUID(); // Common ID for all activities in this series
    
    dates.forEach((date, index) => {
        const activity = {
            ...baseActivityData,
            id: generateUUID(),
            scheduled_date: date.toISOString().split('T')[0],
            recurring_series_id: seriesId,
            recurring_sequence: index + 1,
            recurring_config: index === 0 ? recurringConfig : null, // Only store config in first activity
            is_recurring: true
        };
        
        activities.push(activity);
    });
    
    return activities;
}

function isRecurringActivity(activity) {
    return activity.recurring_series_id && activity.is_recurring;
}

function getRecurringSeriesActivities(seriesId) {
    if (!db.activities) return [];
    
    return db.activities.filter(activity => 
        activity.recurring_series_id === seriesId
    ).sort((a, b) => a.recurring_sequence - b.recurring_sequence);
}

function showRecurringEditModal(activity) {
    console.log('🔄 Showing recurring edit modal for activity:', activity.id);
    
    currentRecurringActivity = activity;
    
    // Populate activity details
    const detailsContainer = document.getElementById('recurring-activity-details');
    const seriesActivities = getRecurringSeriesActivities(activity.recurring_series_id);
    
    detailsContainer.innerHTML = `
        <div><strong>Title:</strong> ${activity.title}</div>
        <div><strong>Current Date:</strong> ${new Date(activity.scheduled_date).toLocaleDateString()}</div>
        <div><strong>Series Position:</strong> ${activity.recurring_sequence} of ${seriesActivities.length}</div>
        <div><strong>Assigned To:</strong> ${getTeamMemberName(activity.assigned_to) || 'Unassigned'}</div>
    `;
    
    // Show modal
    document.getElementById('recurring-edit-modal').style.display = 'flex';
}

function closeRecurringEditModal() {
    document.getElementById('recurring-edit-modal').style.display = 'none';
    currentRecurringActivity = null;
}

function editRecurringActivity(scope) {
    if (!currentRecurringActivity) return;
    
    console.log('🔄 Editing recurring activity with scope:', scope);
    
    switch (scope) {
        case 'single':
            // Break this activity out of the series and edit normally
            currentRecurringActivity.recurring_series_id = null;
            currentRecurringActivity.is_recurring = false;
            currentRecurringActivity.recurring_sequence = null;
            currentRecurringActivity.recurring_config = null;
            
            // Save the modified activity
            saveWithRetry('ACTIVITIES', currentRecurringActivity)
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification('Activity removed from series and ready for editing', 'success');
                });
            break;
            
        case 'future':
            // Edit this and all future activities in the series
            const seriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
            const futureActivities = seriesActivities.filter(a => 
                a.recurring_sequence >= currentRecurringActivity.recurring_sequence
            );
            
            // For now, just break them out and edit the first one
            futureActivities.forEach(activity => {
                activity.recurring_series_id = null;
                activity.is_recurring = false;
                activity.recurring_sequence = null;
                activity.recurring_config = null;
            });
            
            Promise.all(futureActivities.map(activity => saveWithRetry('ACTIVITIES', activity)))
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification(`${futureActivities.length} activities removed from series and ready for editing`, 'success');
                });
            break;
            
        case 'all':
            // Edit all activities in the series
            const allSeriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
            
            // For now, just break them all out and edit the first one
            allSeriesActivities.forEach(activity => {
                activity.recurring_series_id = null;
                activity.is_recurring = false;
                activity.recurring_sequence = null;
                activity.recurring_config = null;
            });
            
            Promise.all(allSeriesActivities.map(activity => saveWithRetry('ACTIVITIES', activity)))
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification(`Entire series (${allSeriesActivities.length} activities) removed from series and ready for editing`, 'success');
                });
            break;
    }
    
    // Refresh calendar
    renderCalendar();
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function deleteRecurringSeries() {
    if (!currentRecurringActivity) return;
    
    if (confirm('Are you sure you want to delete the entire recurring series? This cannot be undone.')) {
        const seriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
        
        // Remove all activities from the series
        seriesActivities.forEach(activity => {
            const index = db.activities.findIndex(a => a.id === activity.id);
            if (index !== -1) {
                db.activities.splice(index, 1);
            }
        });
        
        // Save changes
        Promise.all(seriesActivities.map(activity => 
            saveWithRetry('ACTIVITIES', activity).catch(() => {
                // Activity might already be deleted, that's ok
            })
        )).then(() => {
            closeRecurringEditModal();
            renderCalendar();
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            showNotification(`Deleted ${seriesActivities.length} activities from recurring series`, 'success');
        });
    }
}

function getTeamMemberName(memberId) {
    if (!memberId) return null;
    const member = teamMembers.find(m => m.id === memberId);
    return member ? member.name : null;
}

function enhanceActivityWithRecurring(activityElement, activity) {
    if (isRecurringActivity(activity)) {
        activityElement.classList.add('recurring');
        
        // Add recurring badge to the text
        const originalText = activityElement.textContent;
        const recurring = activity.recurring_config ? 
            getRecurringText(activity.recurring_config) : 
            `Series ${activity.recurring_sequence}`;
        
        activityElement.innerHTML = `
            ${originalText}
            <span class="recurring-badge">${recurring}</span>
        `;
    }
}

function getRecurringText(config) {
    if (!config) return 'Recurring';
    
    const { frequency, interval } = config;
    const intervalText = interval > 1 ? `${interval} ` : '';
    
    switch (frequency) {
        case 'daily': return `${intervalText}Daily`;
        case 'weekly': return `${intervalText}Weekly`;
        case 'monthly': return `${intervalText}Monthly`;
        case 'yearly': return `${intervalText}Yearly`;
        default: return 'Recurring';
    }
}

// Override editActivityFromCalendar to handle recurring activities
function editActivityFromCalendarRecurring(activityId) {
    closeCalendarSidebar();
    const activity = db.activities.find(a => a.id === activityId);
    
    if (activity) {
        if (isRecurringActivity(activity)) {
            showRecurringEditModal(activity);
        } else {
            editActivity(activityId);
        }
    }
}

// ========================================
// NEW Sprint 4.2.5: Notifications & Reminders System
// ========================================

let notifications = [];
let notificationCenter_visible = false;

function initializeNotificationSystem() {
    console.log('🔔 Initializing notification system...');
    
    // Load notifications from localStorage
    loadNotificationsFromStorage();
    
    // Start notification checking interval
    setInterval(checkForNotifications, 60000); // Check every minute
    
    // Initial check
    checkForNotifications();
    
    // Initialize dashboard alerts
    updateDashboardAlerts();
    updateUpcomingActivitiesWidget();
}

function checkForNotifications() {
    console.log('🔍 Checking for new notifications...');
    
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    if (!db.activities) return;
    
    // Check for overdue activities
    checkOverdueActivities(today);
    
    // Check for activities due today
    checkActivitiesToday(today);
    
    // Check for activities due tomorrow
    checkActivitiesTomorrow(tomorrow);
    
    // Check for team workload issues
    checkWorkloadIssues();
    
    // Check for unassigned urgent activities
    checkUnassignedUrgentActivities();
    
    // Update UI
    updateNotificationBadge();
    updateNotificationList();
    updateDashboardAlerts();
    updateUpcomingActivitiesWidget();
}

function checkOverdueActivities(today) {
    const overdueActivities = db.activities.filter(activity => 
        activity.scheduled_date && 
        activity.scheduled_date < today && 
        activity.status !== 'completed' && 
        activity.status !== 'cancelled'
    );
    
    overdueActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'overdue' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'overdue',
                priority: 'urgent',
                activityId: activity.id,
                title: 'Overdue Activity',
                message: `"${activity.title}" was due on ${new Date(activity.scheduled_date).toLocaleDateString()}`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkActivitiesToday(today) {
    const todayActivities = db.activities.filter(activity => 
        activity.scheduled_date === today && 
        activity.status === 'scheduled'
    );
    
    todayActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'due_today' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'due_today',
                priority: 'warning',
                activityId: activity.id,
                title: 'Activity Due Today',
                message: `"${activity.title}" is scheduled for today`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkActivitiesTomorrow(tomorrow) {
    const tomorrowActivities = db.activities.filter(activity => 
        activity.scheduled_date === tomorrow && 
        activity.status === 'scheduled'
    );
    
    tomorrowActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'due_tomorrow' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'due_tomorrow',
                priority: 'normal',
                activityId: activity.id,
                title: 'Activity Due Tomorrow',
                message: `"${activity.title}" is scheduled for tomorrow`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkWorkloadIssues() {
    if (!teamMembers || teamMembers.length === 0) return;
    
    const startOfWeek = getStartOfWeek(new Date());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const workload = calculateTeamWorkload(startOfWeek, endOfWeek);
    
    teamMembers.forEach(member => {
        const memberWorkload = workload[member.id] || { hours: 0 };
        const utilizationPercent = (memberWorkload.hours / member.max_hours) * 100;
        
        if (utilizationPercent > 100) {
            const existingNotification = notifications.find(n => 
                n.type === 'overloaded' && n.memberId === member.id
            );
            
            if (!existingNotification) {
                addNotification({
                    id: generateUUID(),
                    type: 'overloaded',
                    priority: 'urgent',
                    memberId: member.id,
                    title: 'Team Member Overloaded',
                    message: `${member.name} is overloaded this week (${Math.round(utilizationPercent)}% capacity)`,
                    timestamp: new Date(),
                    read: false,
                    action: 'view_workload'
                });
            }
        }
    });
}

function checkUnassignedUrgentActivities() {
    const unassignedUrgent = db.activities.filter(activity => 
        (!activity.assigned_to || activity.assigned_to === '') &&
        activity.priority === 'urgent' &&
        activity.status === 'scheduled'
    );
    
    unassignedUrgent.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'unassigned_urgent' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'unassigned_urgent',
                priority: 'urgent',
                activityId: activity.id,
                title: 'Urgent Activity Unassigned',
                message: `"${activity.title}" is urgent but not assigned to anyone`,
                timestamp: new Date(),
                read: false,
                action: 'assign_activity'
            });
        }
    });
}

function addNotification(notification) {
    notifications.unshift(notification); // Add to beginning
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    saveNotificationsToStorage();
    console.log('🔔 New notification:', notification.title);
}

function toggleNotificationCenter() {
    const center = document.getElementById('notification-center');
    notificationCenter_visible = !notificationCenter_visible;
    
    if (notificationCenter_visible) {
        center.style.display = 'flex';
        updateNotificationList();
    } else {
        center.style.display = 'none';
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    const bell = document.getElementById('notification-bell');
    const unreadCount = notifications.filter(n => !n.read).length;
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
        badge.style.display = 'flex';
        bell.classList.add('has-notifications');
    } else {
        badge.style.display = 'none';
        bell.classList.remove('has-notifications');
    }
}

function updateNotificationList() {
    const list = document.getElementById('notification-list');
    
    if (notifications.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔔</div>
                <div>No notifications</div>
            </div>
        `;
        return;
    }
    
    list.innerHTML = notifications.map(notification => {
        const timeAgo = getTimeAgo(notification.timestamp);
        const icon = getNotificationIcon(notification.type);
        
        return `
            <div class="notification-item ${notification.read ? '' : 'unread'} ${notification.priority}" 
                 onclick="window.handleNotificationClick('${notification.id}')">
                <div class="notification-icon" style="background: ${getIconBackground(notification.priority)};">
                    ${icon}
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
            </div>
        `;
    }).join('');
}

/**
 * @description Get notification icon for given type
 * @param {string} type - Notification type
 * @returns {string} Emoji icon
 */
function getNotificationIcon(type) {
    return CONFIG.UI.NOTIFICATION.ICONS[type] || CONFIG.UI.NOTIFICATION.DEFAULT_ICON;
}

function getIconBackground(priority) {
    const backgrounds = {
        'urgent': '#ef4444',
        'warning': '#f59e0b',
        'normal': '#3b82f6',
        'success': '#22c55e'
    };
    return backgrounds[priority] || backgrounds.normal;
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diffInMinutes = Math.floor((now - new Date(timestamp)) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours}h ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays}d ago`;
}

function handleNotificationClick(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (!notification) return;
    
    // Mark as read
    notification.read = true;
    saveNotificationsToStorage();
    updateNotificationBadge();
    updateNotificationList();
    
    // Handle action
    switch (notification.action) {
        case 'view_activity':
            if (notification.activityId) {
                toggleNotificationCenter();
                showPage('activities');
                // Could highlight the specific activity
            }
            break;
        case 'view_workload':
            toggleNotificationCenter();
            showPage('activities');
            switchActivitiesView('calendar');
            toggleWorkloadPanel();
            break;
        case 'assign_activity':
            if (notification.activityId) {
                toggleNotificationCenter();
                editActivity(notification.activityId);
            }
            break;
    }
}

function markAllNotificationsRead() {
    notifications.forEach(n => n.read = true);
    saveNotificationsToStorage();
    updateNotificationBadge();
    updateNotificationList();
}

function updateDashboardAlerts() {
    const alertsContainer = document.getElementById('dashboard-alerts');
    const alerts = generateDashboardAlerts();
    
    alertsContainer.innerHTML = alerts.map(alert => `
        <div class="dashboard-alert ${alert.type}">
            <div class="dashboard-alert-icon">${alert.icon}</div>
            <div class="dashboard-alert-content">
                <div class="dashboard-alert-title">${alert.title}</div>
                <div class="dashboard-alert-message">${alert.message}</div>
            </div>
        </div>
    `).join('');
}

function generateDashboardAlerts() {
    const alerts = [];
    const today = new Date().toISOString().split('T')[0];
    
    if (!db.activities) return alerts;
    
    // Overdue activities alert
    const overdueCount = db.activities.filter(a => 
        a.scheduled_date && a.scheduled_date < today && 
        a.status !== 'completed' && a.status !== 'cancelled'
    ).length;
    
    if (overdueCount > 0) {
        alerts.push({
            type: 'urgent',
            icon: '⏰',
            title: `${overdueCount} Overdue Activities`,
            message: `You have ${overdueCount} activities that are past their scheduled date. Please review and reschedule as needed.`
        });
    }
    
    // Today's activities alert
    const todayCount = db.activities.filter(a => 
        a.scheduled_date === today && a.status === 'scheduled'
    ).length;
    
    if (todayCount > 0) {
        alerts.push({
            type: 'warning',
            icon: '📅',
            title: `${todayCount} Activities Today`,
            message: `You have ${todayCount} activities scheduled for today. Make sure your team is prepared.`
        });
    }
    
    // Unassigned urgent activities
    const unassignedUrgentCount = db.activities.filter(a => 
        (!a.assigned_to || a.assigned_to === '') && 
        a.priority === 'urgent' && 
        a.status === 'scheduled'
    ).length;
    
    if (unassignedUrgentCount > 0) {
        alerts.push({
            type: 'urgent',
            icon: '🚨',
            title: `${unassignedUrgentCount} Urgent Activities Unassigned`,
            message: `You have ${unassignedUrgentCount} urgent activities that haven't been assigned to team members yet.`
        });
    }
    
    return alerts;
}

function updateUpcomingActivitiesWidget() {
    const widget = document.getElementById('upcoming-activities-widget');
    const listContainer = document.getElementById('upcoming-activities-list');
    
    const upcomingActivities = getUpcomingActivities();
    
    if (upcomingActivities.length === 0) {
        widget.style.display = 'none';
        return;
    }
    
    widget.style.display = 'block';
    
    listContainer.innerHTML = upcomingActivities.map(activity => {
        const member = teamMembers.find(m => m.id === activity.assigned_to);
        const dateClass = getActivityDateClass(activity.scheduled_date);
        
        return `
            <div class="upcoming-activity-item ${dateClass}" onclick="window.editActivity('${activity.id}')">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${activity.title}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        📅 ${new Date(activity.scheduled_date).toLocaleDateString()} • 
                        ⏱️ ${activity.estimated_hours}h • 
                        👤 ${member ? member.name : 'Unassigned'}
                    </div>
                </div>
                <div style="flex-shrink: 0;">
                    <span class="priority-${activity.priority}" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;">
                        ${activity.priority.toUpperCase()}
                    </span>
                </div>
            </div>
        `;
    }).join('');
}

function getUpcomingActivities() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    if (!db.activities) return [];
    
    return db.activities
        .filter(activity => {
            if (!activity.scheduled_date || activity.status !== 'scheduled') return false;
            const activityDate = new Date(activity.scheduled_date);
            return activityDate >= today && activityDate <= nextWeek;
        })
        .sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date))
        .slice(0, 5); // Show max 5
}

function getActivityDateClass(scheduledDate) {
    const today = new Date().toISOString().split('T')[0];
    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    if (scheduledDate < today) return 'overdue';
    if (scheduledDate === today) return 'today';
    if (scheduledDate === tomorrow) return 'tomorrow';
    return '';
}

function saveNotificationsToStorage() {
    localStorage.setItem('notifications', JSON.stringify(notifications));
}

function loadNotificationsFromStorage() {
    const stored = localStorage.getItem('notifications');
    if (stored) {
        try {
            notifications = JSON.parse(stored);
            // Convert timestamp strings back to Date objects
            notifications.forEach(n => {
                if (typeof n.timestamp === 'string') {
                    n.timestamp = new Date(n.timestamp);
                }
            });
        } catch (e) {
            console.error('Failed to load notifications from storage:', e);
            notifications = [];
        }
    }
}

// ========================================
// NEW Sprint 4.3: Resource Allocation Tracking System
// ========================================

let currentResourceFilters = {
    type: 'all',
    status: 'all'
};

let selectedActivityResources = []; // Resources selected for current activity
let resourceCalendarWeek = new Date(); // Current week for resource calendar

function initializeResourceAllocationSystem() {
    console.log('🔧 Initializing resource allocation system...');
    updateResourceAllocationPage();
}

function updateResourceAllocationPage() {
    if (document.getElementById('resource-allocation').classList.contains('active')) {
        renderResourceAllocationGrid();
        updateResourceCount();
    }
}

function renderResourceAllocationGrid() {
    const grid = document.getElementById('resource-allocation-grid');
    if (!grid) return;
    
    const resources = getFilteredResources();
    
    if (resources.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔧</div>
                <div>No resources found matching current filters</div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = resources.map(resource => createResourceCard(resource)).join('');
}

function getFilteredResources() {
    if (!db.resources) return [];
    
    return db.resources.filter(resource => {
        // Type filter
        if (currentResourceFilters.type !== 'all' && 
            !resource.category?.toLowerCase().includes(currentResourceFilters.type)) {
            return false;
        }
        
        // Status filter - we'll derive status from current allocations
        const status = getResourceStatus(resource);
        if (currentResourceFilters.status !== 'all' && status !== currentResourceFilters.status) {
            return false;
        }
        
        return true;
    });
}

function getResourceStatus(resource) {
    if (!resource.id || !db.activities) return 'available';
    
    // Check if resource is currently allocated to any active activities
    const activeAllocations = db.activities.filter(activity => 
        activity.status === 'scheduled' && 
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id)
    );
    
    if (activeAllocations.length === 0) return 'available';
    
    // Check for conflicts (multiple activities at same time)
    const today = new Date().toISOString().split('T')[0];
    const conflictingActivities = activeAllocations.filter(activity => 
        activity.scheduled_date >= today
    );
    
    if (conflictingActivities.length > 1) return 'maintenance'; // Using maintenance to indicate conflict
    if (conflictingActivities.length === 1) return 'in-use';
    
    return 'available';
}

function createResourceCard(resource) {
    const status = getResourceStatus(resource);
    const assignments = getCurrentResourceAssignments(resource);
    const utilization = calculateResourceUtilization(resource);
    const conflicts = getResourceConflicts(resource);
    
    const typeClass = mapResourceCategoryToType(resource.category);
    
    return `
        <div class="resource-card ${typeClass}">
            <div class="resource-header">
                <div>
                    <div class="resource-name">${resource.name || 'Unnamed Resource'}</div>
                    <div class="resource-type ${typeClass}">${typeClass}</div>
                </div>
                <div class="resource-status">
                    <div class="resource-status-indicator ${status}"></div>
                    <div class="resource-status-text ${status}">${capitalizeFirst(status.replace('-', ' '))}</div>
                </div>
            </div>
            
            ${assignments.length > 0 ? `
                <div class="resource-assignments">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem;">Current Assignments:</div>
                    ${assignments.slice(0, 3).map(assignment => `
                        <div class="resource-assignment-item">
                            <div class="assignment-activity">
                                <div class="assignment-title">${assignment.title}</div>
                                <div class="assignment-details">
                                    PC: ${assignment.pc_number} • ${assignment.assignee || 'Unassigned'}
                                </div>
                            </div>
                            <div class="assignment-period">
                                ${new Date(assignment.scheduled_date).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('')}
                    ${assignments.length > 3 ? `<div style="font-size: 0.75rem; color: #6b7280; text-align: center; margin-top: 0.5rem;">+${assignments.length - 3} more assignments</div>` : ''}
                </div>
            ` : ''}
            
            <div class="resource-utilization">
                <div class="utilization-header">
                    <span class="utilization-label">Week Utilization</span>
                    <span class="utilization-percentage">${Math.round(utilization)}%</span>
                </div>
                <div class="utilization-bar">
                    <div class="utilization-fill ${getUtilizationLevel(utilization)}" style="width: ${Math.min(utilization, 100)}%"></div>
                </div>
            </div>
            
            ${conflicts.length > 0 ? `
                <div class="resource-conflict-warning">
                    <div class="conflict-icon">⚠️</div>
                    <div class="conflict-content">
                        <div class="conflict-title">Scheduling Conflict</div>
                        <div class="conflict-message">
                            ${conflicts.length} overlapping assignments detected. Review schedule.
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="resource-actions">
                <button class="resource-action-btn" onclick="window.viewResourceSchedule('${resource.id}')">
                    📅 Schedule
                </button>
                <button class="resource-action-btn" onclick="window.editResource('${resource.id}')">
                    ✏️ Edit
                </button>
            </div>
        </div>
    `;
}

function mapResourceCategoryToType(category) {
    if (!category) return 'tool';
    
    const categoryLower = category.toLowerCase();
    
    if (categoryLower.includes('equipment') || categoryLower.includes('electrical') || categoryLower.includes('lighting')) {
        return 'equipment';
    }
    if (categoryLower.includes('transport') || categoryLower.includes('vehicle')) {
        return 'vehicle';
    }
    if (categoryLower.includes('material') || categoryLower.includes('cable') || categoryLower.includes('wire')) {
        return 'material';
    }
    
    return 'tool';
}

function getCurrentResourceAssignments(resource) {
    if (!resource.id || !db.activities) return [];
    
    const now = new Date();
    const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    return db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date &&
        new Date(activity.scheduled_date) >= now &&
        new Date(activity.scheduled_date) <= nextWeek
    ).map(activity => ({
        title: activity.title,
        pc_number: activity.pc_number,
        scheduled_date: activity.scheduled_date,
        assignee: activity.assigned_to
    }));
}

function calculateResourceUtilization(resource) {
    if (!resource.id || !db.activities) return 0;
    
    // Calculate utilization based on scheduled activities in current week
    const startOfWeek = getStartOfWeek(new Date());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const weekActivities = db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date &&
        new Date(activity.scheduled_date) >= startOfWeek &&
        new Date(activity.scheduled_date) <= endOfWeek
    );
    
    const totalHours = weekActivities.reduce((sum, activity) => 
        sum + (parseFloat(activity.estimated_hours) || 0), 0
    );
    
    // Assume maximum 40 hours per week for resources
    return Math.min((totalHours / 40) * 100, 200); // Cap at 200% to show overallocation
}

function getUtilizationLevel(utilization) {
    if (utilization <= 70) return 'low';
    if (utilization <= 100) return 'medium';
    return 'high';
}

function getResourceConflicts(resource) {
    if (!resource.id || !db.activities) return [];
    
    const conflicts = [];
    const resourceActivities = db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date
    );
    
    // Group by date and check for overlaps
    const dateGroups = {};
    resourceActivities.forEach(activity => {
        const date = activity.scheduled_date;
        if (!dateGroups[date]) dateGroups[date] = [];
        dateGroups[date].push(activity);
    });
    
    Object.values(dateGroups).forEach(activities => {
        if (activities.length > 1) {
            conflicts.push(...activities);
        }
    });
    
    return conflicts;
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function filterResourcesByType(type) {
    // Update active filter button
    document.querySelectorAll('.resource-type-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentResourceFilters.type = type;
    renderResourceAllocationGrid();
    updateResourceCount();
}

function filterResourcesByStatus(status) {
    // Update active filter button
    document.querySelectorAll('.resource-status-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentResourceFilters.status = status;
    renderResourceAllocationGrid();
    updateResourceCount();
}

function updateResourceCount() {
    const countElement = document.getElementById('resource-count');
    if (countElement) {
        const count = getFilteredResources().length;
        countElement.textContent = `${count} resource${count !== 1 ? 's' : ''}`;
    }
}

function refreshResourceAllocation() {
    renderResourceAllocationGrid();
    updateResourceCount();
    showNotification('Resource allocation data refreshed', 'success');
}

function showResourceCalendarView() {
    const calendarView = document.getElementById('resource-calendar-view');
    if (calendarView) {
        calendarView.style.display = 'block';
        renderResourceTimeline();
        updateResourceWeekDisplay();
    }
}

function hideResourceCalendarView() {
    const calendarView = document.getElementById('resource-calendar-view');
    if (calendarView) {
        calendarView.style.display = 'none';
    }
}

function navigateResourceWeek(direction) {
    resourceCalendarWeek.setDate(resourceCalendarWeek.getDate() + (direction * 7));
    renderResourceTimeline();
    updateResourceWeekDisplay();
}

function updateResourceWeekDisplay() {
    const display = document.getElementById('resource-week-display');
    if (display) {
        const startOfWeek = getStartOfWeek(resourceCalendarWeek);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        display.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    }
}

function renderResourceTimeline() {
    const timeline = document.getElementById('resource-timeline');
    if (!timeline) return;
    
    const resources = getFilteredResources();
    const startOfWeek = getStartOfWeek(resourceCalendarWeek);
    
    // Generate days of the week
    const days = [];
    for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        days.push(day);
    }
    
    timeline.innerHTML = `
        <!-- Header row with days -->
        <div class="timeline-row" style="background: #f3f4f6; font-weight: 600;">
            <div class="timeline-resource">Resource</div>
            <div class="timeline-slots">
                ${days.map(day => `
                    <div style="text-align: center; font-size: 0.75rem; padding: 0.5rem;">
                        ${day.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' })}
                    </div>
                `).join('')}
            </div>
        </div>
        
        ${resources.map(resource => `
            <div class="timeline-row">
                <div class="timeline-resource">${resource.name}</div>
                <div class="timeline-slots">
                    ${days.map(day => {
                        const dayStr = day.toISOString().split('T')[0];
                        const availability = getResourceAvailabilityForDay(resource, dayStr);
                        return `
                            <div class="timeline-day ${availability.status}" 
                                 onclick="window.viewResourceDayDetails('${resource.id}', '${dayStr}')"
                                 title="${availability.tooltip}">
                                ${availability.label}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `).join('')}
    `;
}

function getResourceAvailabilityForDay(resource, dateStr) {
    if (!db.activities) return { status: 'available', label: '✓', tooltip: 'Available' };
    
    const dayActivities = db.activities.filter(activity =>
        activity.status === 'scheduled' &&
        activity.scheduled_date === dateStr &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id)
    );
    
    if (dayActivities.length === 0) {
        return { status: 'available', label: '✓', tooltip: 'Available' };
    } else if (dayActivities.length === 1) {
        return { 
            status: 'partial', 
            label: '1', 
            tooltip: `1 activity: ${dayActivities[0].title}` 
        };
    } else {
        return { 
            status: 'busy', 
            label: dayActivities.length.toString(), 
            tooltip: `${dayActivities.length} activities (potential conflict)` 
        };
    }
}

function viewResourceDayDetails(resourceId, dateStr) {
    const resource = db.resources?.find(r => r.id === resourceId);
    const dayActivities = db.activities?.filter(activity =>
        activity.status === 'scheduled' &&
        activity.scheduled_date === dateStr &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resourceId)
    ) || [];
    
    if (resource && dayActivities.length > 0) {
        const activityList = dayActivities.map(a => `• ${a.title} (${a.pc_number})`).join('\n');
        alert(`${resource.name} - ${new Date(dateStr).toLocaleDateString()}\n\nScheduled activities:\n${activityList}`);
    }
}

function viewResourceSchedule(resourceId) {
    // Show resource calendar view and filter to specific resource
    showResourceCalendarView();
    // Could implement specific resource filtering here
}

// Activity Resource Selection Functions

function showActivityResourceSelector() {
    document.getElementById('activity-resource-selector-modal').classList.add('active');
    renderActivityResourceSelector();
    updateActivityResourceSelectorSummary();
}

function closeActivityResourceSelector() {
    document.getElementById('activity-resource-selector-modal').classList.remove('active');
}

function renderActivityResourceSelector() {
    const grid = document.getElementById('resource-selector-grid');
    if (!grid || !db.resources) return;
    
    const searchTerm = document.getElementById('resource-selector-search')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('resource-selector-type-filter')?.value || '';
    
    const filteredResources = db.resources.filter(resource => {
        const nameMatch = resource.name?.toLowerCase().includes(searchTerm);
        const typeMatch = !typeFilter || mapResourceCategoryToType(resource.category) === typeFilter;
        return nameMatch && typeMatch;
    });
    
    grid.innerHTML = filteredResources.map(resource => {
        const isSelected = selectedActivityResources.some(r => r.resource_id === resource.id);
        const typeClass = mapResourceCategoryToType(resource.category);
        
        return `
            <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; ${isSelected ? 'background: #eff6ff;' : ''}" 
                 onclick="window.toggleActivityResourceSelection('${resource.id}')">
                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                       style="margin-right: 0.75rem;" onclick="event.stopPropagation();">
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 0.25rem;">${resource.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        <span class="resource-type ${typeClass}" style="margin-right: 0.5rem;">${typeClass.toUpperCase()}</span>
                        ${resource.description || 'No description'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; font-weight: 500;">£${resource.cost || '0.00'}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">${resource.unit || 'each'}</div>
                </div>
            </div>
        `;
    }).join('');
    
    if (filteredResources.length === 0) {
        grid.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🔧</div>
                <div>No resources found</div>
            </div>
        `;
    }
}

function filterActivityResourceSelector() {
    renderActivityResourceSelector();
}

function toggleActivityResourceSelection(resourceId) {
    const resource = db.resources?.find(r => r.id === resourceId);
    if (!resource) return;
    
    const existingIndex = selectedActivityResources.findIndex(r => r.resource_id === resourceId);
    
    if (existingIndex >= 0) {
        // Remove from selection
        selectedActivityResources.splice(existingIndex, 1);
    } else {
        // Add to selection
        selectedActivityResources.push({
            resource_id: resourceId,
            resource_name: resource.name,
            quantity: 1,
            unit: resource.unit || 'each'
        });
    }
    
    renderActivityResourceSelector();
    updateActivityResourceSelectorSummary();
}

function updateActivityResourceSelectorSummary() {
    const summary = document.getElementById('resource-selector-summary');
    if (!summary) return;
    
    if (selectedActivityResources.length === 0) {
        summary.textContent = 'No resources selected';
        return;
    }
    
    const resourceNames = selectedActivityResources.map(r => r.resource_name).join(', ');
    summary.textContent = `${selectedActivityResources.length} selected: ${resourceNames}`;
}

function confirmActivityResourceSelection() {
    // Update the activity form with selected resources
    updateActivityResourcesList();
    closeActivityResourceSelector();
    
    // Check for conflicts
    checkResourceAvailability();
}

function updateActivityResourcesList() {
    const emptyDiv = document.getElementById('activity-resources-empty');
    const itemsDiv = document.getElementById('activity-resources-items');
    
    if (selectedActivityResources.length === 0) {
        emptyDiv.style.display = 'block';
        itemsDiv.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    itemsDiv.style.display = 'block';
    
    itemsDiv.innerHTML = selectedActivityResources.map(resource => `
        <div style="display: flex; justify-content: between; align-items: center; padding: 0.5rem; background: white; border-radius: 0.375rem; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
            <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 0.875rem;">${resource.resource_name}</div>
                <div style="font-size: 0.75rem; color: #6b7280;">Quantity: ${resource.quantity} ${resource.unit}</div>
            </div>
            <button onclick="window.removeActivityResource('${resource.resource_id}')" 
                    style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                Remove
            </button>
        </div>
    `).join('');
}

function removeActivityResource(resourceId) {
    selectedActivityResources = selectedActivityResources.filter(r => r.resource_id !== resourceId);
    updateActivityResourcesList();
    checkResourceAvailability();
}

function checkResourceAvailability() {
    const conflictDiv = document.getElementById('activity-resource-conflicts');
    const scheduledDate = document.getElementById('activity-scheduled-date')?.value;
    
    if (!scheduledDate || selectedActivityResources.length === 0) {
        conflictDiv.style.display = 'none';
        return;
    }
    
    const conflicts = [];
    
    selectedActivityResources.forEach(selectedResource => {
        const conflictingActivities = db.activities?.filter(activity =>
            activity.status === 'scheduled' &&
            activity.scheduled_date === scheduledDate &&
            activity.required_resources &&
            activity.required_resources.some(r => r.resource_id === selectedResource.resource_id)
        ) || [];
        
        if (conflictingActivities.length > 0) {
            conflicts.push({
                resource: selectedResource,
                activities: conflictingActivities
            });
        }
    });
    
    if (conflicts.length === 0) {
        conflictDiv.style.display = 'none';
        return;
    }
    
    conflictDiv.style.display = 'block';
    conflictDiv.innerHTML = `
        <div class="resource-conflict-warning">
            <div class="conflict-icon">⚠️</div>
            <div class="conflict-content">
                <div class="conflict-title">Resource Conflicts Detected</div>
                <div class="conflict-message">
                    The following resources are already allocated on ${new Date(scheduledDate).toLocaleDateString()}:
                    <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                        ${conflicts.map(conflict => `
                            <li style="margin-bottom: 0.25rem;">
                                <strong>${conflict.resource.resource_name}</strong> - 
                                ${conflict.activities.map(a => a.title).join(', ')}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
}

// ========================================
// NEW Sprint 4.4: Activity Dependencies & Workflow System
// ========================================

let currentWorkflowMode = CONFIG.WORKFLOW.DEFAULT_MODE;
let selectedActivityForConnection = null;
let currentDependencyType = CONFIG.WORKFLOW.DEFAULT_DEPENDENCY_TYPE;
let selectedDependencyActivity = null;
let activityDependencies = []; // Current activity's dependencies

function initializeWorkflowSystem() {
    console.log('🔗 Initializing workflow system...');
    updateWorkflowView();
}



function updateWorkflowView() {
    if (document.getElementById('activities-workflow-view').style.display === 'none') return;
    
    updateWorkflowStats();
    renderWorkflowCanvas();
    updateWorkflowMinimap();
}

function updateWorkflowStats() {
    if (!db.activities) return;
    
    const total = db.activities.length;
    const inProgress = db.activities.filter(a => a.status === 'in_progress').length;
    const completed = db.activities.filter(a => a.status === 'completed').length;
    const blocked = db.activities.filter(a => getActivityWorkflowStatus(a) === 'blocked').length;
    const criticalPath = calculateCriticalPathLength();
    
    document.getElementById('workflow-total-activities').textContent = total;
    document.getElementById('workflow-in-progress').textContent = inProgress;
    document.getElementById('workflow-completed').textContent = completed;
    document.getElementById('workflow-blocked').textContent = blocked;
    document.getElementById('workflow-critical-path').textContent = criticalPath;
}

function renderWorkflowCanvas() {
    const container = document.getElementById('workflow-nodes-container');
    const connectionsCanvas = document.getElementById('workflow-connections');
    
    if (!container || !db.activities) return;
    
    // Clear existing content
    container.innerHTML = '';
    connectionsCanvas.innerHTML = connectionsCanvas.querySelector('defs').outerHTML;
    
    // Position activities in a grid layout
    const activities = db.activities.slice(); // Copy array
    const columns = Math.ceil(Math.sqrt(activities.length));
    const nodeWidth = 200;
    const nodeHeight = 120;
    const horizontalSpacing = 280;
    const verticalSpacing = 160;
    
    activities.forEach((activity, index) => {
        const col = index % columns;
        const row = Math.floor(index / columns);
        const x = 50 + col * horizontalSpacing;
        const y = 50 + row * verticalSpacing;
        
        const node = createWorkflowNode(activity, x, y);
        container.appendChild(node);
    });
    
    // Draw connections after nodes are positioned
    setTimeout(() => {
        renderWorkflowConnections();
    }, 100);
}

function createWorkflowNode(activity, x, y) {
    const node = document.createElement('div');
    node.className = `workflow-node ${getActivityWorkflowStatus(activity)}`;
    node.style.left = x + 'px';
    node.style.top = y + 'px';
    node.setAttribute('data-activity-id', activity.id);
    
    const isOnCriticalPath = isActivityOnCriticalPath(activity);
    
    node.innerHTML = `
        <div class="workflow-node-header">
            <div class="workflow-node-title">${activity.title || 'Untitled Activity'}</div>
            <div class="workflow-node-status ${getActivityWorkflowStatus(activity)}">${activity.status || 'pending'}</div>
        </div>
        <div class="workflow-node-details">
            <div style="margin-bottom: 0.25rem;">PC: ${activity.pc_number || 'N/A'}</div>
            <div style="margin-bottom: 0.25rem;">Type: ${activity.type || 'N/A'}</div>
            <div>Assigned: ${activity.assigned_to_name || 'Unassigned'}</div>
        </div>
        <div class="workflow-node-dates">
            <div class="workflow-node-date">
                <span>Scheduled:</span>
                <span>${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not set'}</span>
            </div>
            <div class="workflow-node-date">
                <span>Duration:</span>
                <span>${activity.estimated_hours || activity.duration_hours || 0}h</span>
            </div>
        </div>
        ${isOnCriticalPath ? '<div class="critical-path-indicator">!</div>' : ''}
    `;
    
    // Add event listeners
    node.addEventListener('click', () => handleWorkflowNodeClick(activity));
    
    if (currentWorkflowMode === 'edit') {
        makeDraggable(node);
    }
    
    return node;
}

function getActivityWorkflowStatus(activity) {
    if (!activity) return 'pending';
    
    // Check if activity is blocked by dependencies
    if (activity.dependencies && activity.dependencies.length > 0) {
        const blockedByDependencies = activity.dependencies.some(dep => {
            const prerequisite = db.activities.find(a => a.id === dep.activity_id);
            return prerequisite && prerequisite.status !== 'completed';
        });
        
        if (blockedByDependencies && activity.status === 'pending') {
            return 'blocked';
        }
    }
    
    // Map status to workflow status
    switch (activity.status) {
        case 'in_progress': return 'in-progress';
        case 'completed': return 'completed';
        case 'cancelled': return 'blocked';
        default: return 'pending';
    }
}

function renderWorkflowConnections() {
    const canvas = document.getElementById('workflow-connections');
    if (!canvas || !db.activities) return;
    
    const connections = [];
    
    db.activities.forEach(activity => {
        if (activity.dependencies) {
            activity.dependencies.forEach(dep => {
                const fromNode = document.querySelector(`[data-activity-id="${dep.activity_id}"]`);
                const toNode = document.querySelector(`[data-activity-id="${activity.id}"]`);
                
                if (fromNode && toNode) {
                    connections.push({
                        from: fromNode,
                        to: toNode,
                        type: dep.type || 'finish-to-start',
                        isOnCriticalPath: isActivityOnCriticalPath(activity)
                    });
                }
            });
        }
    });
    
    connections.forEach(conn => {
        const line = createConnectionLine(conn.from, conn.to, conn.type, conn.isOnCriticalPath);
        canvas.appendChild(line);
    });
}

function createConnectionLine(fromNode, toNode, type, isOnCriticalPath) {
    const fromRect = fromNode.getBoundingClientRect();
    const toRect = toNode.getBoundingClientRect();
    const canvasRect = document.getElementById('workflow-canvas').getBoundingClientRect();
    
    // Calculate connection points
    const fromX = fromRect.right - canvasRect.left;
    const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
    const toX = toRect.left - canvasRect.left;
    const toY = toRect.top + toRect.height / 2 - canvasRect.top;
    
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    // Create curved path
    const midX = (fromX + toX) / 2;
    const pathData = `M ${fromX} ${fromY} Q ${midX} ${fromY} ${midX} ${(fromY + toY) / 2} Q ${midX} ${toY} ${toX} ${toY}`;
    
    line.setAttribute('d', pathData);
    line.setAttribute('class', `workflow-connection-line ${isOnCriticalPath ? 'critical-path' : ''}`);
    
    return line;
}

function handleWorkflowNodeClick(activity) {
    switch (currentWorkflowMode) {
        case 'view':
            editActivity(activity.id);
            break;
        case 'edit':
            selectWorkflowNode(activity);
            break;
        case 'connect':
            if (!selectedActivityForConnection) {
                selectedActivityForConnection = activity;
                showNotification(`Selected "${activity.title}" as connection source`, 'info');
            } else if (selectedActivityForConnection.id !== activity.id) {
                createActivityConnection(selectedActivityForConnection, activity);
                selectedActivityForConnection = null;
            }
            break;
    }
}

function selectWorkflowNode(activity) {
    // Remove previous selections
    document.querySelectorAll('.workflow-node.selected').forEach(node => {
        node.classList.remove('selected');
    });
    
    // Select current node
    const node = document.querySelector(`[data-activity-id="${activity.id}"]`);
    if (node) {
        node.classList.add('selected');
    }
}

function setWorkflowMode(mode) {
    currentWorkflowMode = mode;
    
    // Update mode buttons
    document.querySelectorAll('.workflow-mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // Update canvas based on mode
    renderWorkflowCanvas();
    
    if (mode === 'connect') {
        selectedActivityForConnection = null;
        showNotification('Connection mode: Click source activity, then target activity', 'info');
    }
}

function autoLayoutWorkflow() {
    // Implement automatic layout algorithm
    if (!db.activities) return;
    
    // Simple hierarchical layout based on dependencies
    const activities = db.activities.slice();
    const positioned = new Set();
    const levels = {};
    
    // Calculate levels for each activity
    activities.forEach(activity => {
        levels[activity.id] = calculateActivityLevel(activity, activities);
    });
    
    // Group activities by level
    const levelGroups = {};
    Object.entries(levels).forEach(([activityId, level]) => {
        if (!levelGroups[level]) levelGroups[level] = [];
        levelGroups[level].push(activityId);
    });
    
    // Position activities
    const horizontalSpacing = 300;
    const verticalSpacing = 180;
    const startX = 50;
    const startY = 50;
    
    Object.entries(levelGroups).forEach(([level, activityIds]) => {
        activityIds.forEach((activityId, index) => {
            const node = document.querySelector(`[data-activity-id="${activityId}"]`);
            if (node) {
                const x = startX + parseInt(level) * horizontalSpacing;
                const y = startY + index * verticalSpacing;
                
                node.style.left = x + 'px';
                node.style.top = y + 'px';
            }
        });
    });
    
    // Redraw connections
    setTimeout(() => {
        renderWorkflowConnections();
    }, 100);
    
    showNotification('Workflow layout optimized', 'success');
}

function calculateActivityLevel(activity, allActivities) {
    if (!activity.dependencies || activity.dependencies.length === 0) {
        return 0;
    }
    
    let maxLevel = 0;
    activity.dependencies.forEach(dep => {
        const predecessor = allActivities.find(a => a.id === dep.activity_id);
        if (predecessor) {
            const predecessorLevel = calculateActivityLevel(predecessor, allActivities);
            maxLevel = Math.max(maxLevel, predecessorLevel + 1);
        }
    });
    
    return maxLevel;
}

function calculateCriticalPath() {
    if (!db.activities) return;
    
    // Simple critical path calculation
    const criticalPath = findCriticalPath(db.activities);
    
    // Highlight critical path activities
    document.querySelectorAll('.workflow-node').forEach(node => {
        const activityId = node.getAttribute('data-activity-id');
        if (criticalPath.includes(activityId)) {
            if (!node.querySelector('.critical-path-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'critical-path-indicator';
                indicator.textContent = '!';
                node.appendChild(indicator);
            }
        } else {
            const indicator = node.querySelector('.critical-path-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    });
    
    // Redraw connections with critical path highlighting
    renderWorkflowConnections();
    
    showNotification(`Critical path calculated: ${criticalPath.length} activities`, 'success');
}

function findCriticalPath(activities) {
    // Simplified critical path finding - longest path through dependencies
    const visited = new Set();
    const criticalPath = [];
    
    function findLongestPath(activity, path) {
        if (visited.has(activity.id)) return path;
        
        visited.add(activity.id);
        let longestPath = [...path, activity.id];
        
        // Find activities that depend on this one
        const successors = activities.filter(a => 
            a.dependencies && a.dependencies.some(dep => dep.activity_id === activity.id)
        );
        
        successors.forEach(successor => {
            const successorPath = findLongestPath(successor, [...path, activity.id]);
            if (successorPath.length > longestPath.length) {
                longestPath = successorPath;
            }
        });
        
        visited.delete(activity.id);
        return longestPath;
    }
    
    // Start from activities with no dependencies
    const startActivities = activities.filter(a => 
        !a.dependencies || a.dependencies.length === 0
    );
    
    let longestOverallPath = [];
    startActivities.forEach(activity => {
        const path = findLongestPath(activity, []);
        if (path.length > longestOverallPath.length) {
            longestOverallPath = path;
        }
    });
    
    return longestOverallPath;
}

function calculateCriticalPathLength() {
    if (!db.activities) return 0;
    
    const criticalPath = findCriticalPath(db.activities);
    
    // Calculate total duration of critical path
    let totalDays = 0;
    criticalPath.forEach(activityId => {
        const activity = db.activities.find(a => a.id === activityId);
        if (activity && activity.estimated_hours) {
            totalDays += Math.ceil(activity.estimated_hours / 8); // Convert hours to days
        }
    });
    
    return totalDays;
}

function isActivityOnCriticalPath(activity) {
    if (!db.activities) return false;
    const criticalPath = findCriticalPath(db.activities);
    return criticalPath.includes(activity.id);
}

function optimizeWorkflow() {
    if (!db.activities) return;
    
    // Auto-schedule activities based on dependencies
    const scheduled = new Set();
    const schedule = {};
    
    function scheduleActivity(activity) {
        if (scheduled.has(activity.id)) return schedule[activity.id];
        
        let earliestStart = new Date();
        
        // Check dependencies
        if (activity.dependencies) {
            activity.dependencies.forEach(dep => {
                const predecessor = db.activities.find(a => a.id === dep.activity_id);
                if (predecessor) {
                    const predecessorEnd = scheduleActivity(predecessor);
                    if (predecessorEnd > earliestStart) {
                        earliestStart = predecessorEnd;
                    }
                }
            });
        }
        
        // Calculate end date
        const duration = activity.estimated_hours || activity.duration_hours || 8;
        const durationDays = Math.ceil(duration / 8);
        const endDate = new Date(earliestStart);
        endDate.setDate(endDate.getDate() + durationDays);
        
        schedule[activity.id] = endDate;
        scheduled.add(activity.id);
        
        return endDate;
    }
    
    // Schedule all activities
    db.activities.forEach(activity => {
        scheduleActivity(activity);
    });
    
    // Update activity scheduled dates
    let updatedCount = 0;
    Object.entries(schedule).forEach(([activityId, scheduledDate]) => {
        const activity = db.activities.find(a => a.id === activityId);
        if (activity) {
            const newDate = scheduledDate.toISOString().split('T')[0];
            if (activity.scheduled_date !== newDate) {
                activity.scheduled_date = newDate;
                updatedCount++;
            }
        }
    });
    
    // Save changes
    if (updatedCount > 0) {
        db.activities.forEach(activity => {
            saveWithRetry(STORES.ACTIVITIES, activity);
        });
        
        renderWorkflowCanvas();
        showNotification(`Optimized workflow: ${updatedCount} activities rescheduled`, 'success');
    } else {
        showNotification('Workflow is already optimized', 'info');
    }
}

function updateWorkflowMinimap() {
    const minimap = document.getElementById('workflow-minimap-content');
    if (!minimap || !db.activities) return;
    
    const totalActivities = db.activities.length;
    const completed = db.activities.filter(a => a.status === 'completed').length;
    const inProgress = db.activities.filter(a => a.status === 'in_progress').length;
    const progress = totalActivities > 0 ? Math.round((completed / totalActivities) * 100) : 0;
    
    minimap.innerHTML = `
        <div style="margin-bottom: 0.5rem;">Progress: ${progress}%</div>
        <div style="margin-bottom: 0.25rem;">✅ Completed: ${completed}</div>
        <div style="margin-bottom: 0.25rem;">🔄 In Progress: ${inProgress}</div>
        <div>⏳ Pending: ${totalActivities - completed - inProgress}</div>
    `;
}

// Dependency Management Functions

function showDependencySelector(type) {
    currentDependencyType = type;
    selectedDependencyActivity = null;
    
    const modal = document.getElementById('dependency-selector-modal');
    const info = document.getElementById('dependency-selector-info');
    
    if (type === 'predecessor') {
        info.innerHTML = `
            <strong>Adding Predecessor:</strong> Select an activity that must be completed before the current activity can start.
            This will create a dependency relationship where the selected activity blocks the current activity until completion.
        `;
    } else {
        info.innerHTML = `
            <strong>Adding Successor:</strong> Select an activity that should start after the current activity is completed.
            This will create a dependency relationship where the current activity blocks the selected activity.
        `;
    }
    
    populateDependencyPCFilters();
    renderDependencySelector();
    modal.classList.add('active');
}

function closeDependencySelector() {
    document.getElementById('dependency-selector-modal').classList.remove('active');
    selectedDependencyActivity = null;
}

function populateDependencyPCFilters() {
    const pcFilter = document.getElementById('dependency-selector-pc-filter');
    pcFilter.innerHTML = '<option value="">All PC Numbers</option>';
    
    if (db.pcs) {
        db.pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `${pc.pc_number || pc.number} - ${pc.company_name || pc.company}`;
            pcFilter.appendChild(option);
        });
    }
}

function renderDependencySelector() {
    const list = document.getElementById('dependency-selector-list');
    const currentActivityId = document.getElementById('activity-id').value;
    
    if (!list || !db.activities) return;
    
    const searchTerm = document.getElementById('dependency-selector-search')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('dependency-selector-status-filter')?.value || '';
    const pcFilter = document.getElementById('dependency-selector-pc-filter')?.value || '';
    
    // Filter activities (exclude current activity and existing dependencies)
    const filteredActivities = db.activities.filter(activity => {
        if (activity.id === currentActivityId) return false;
        
        // Check search term
        if (searchTerm && !activity.title?.toLowerCase().includes(searchTerm)) return false;
        
        // Check status filter
        if (statusFilter && activity.status !== statusFilter) return false;
        
        // Check PC filter
        if (pcFilter && activity.pc_id !== pcFilter) return false;
        
        // Check if already a dependency
        const existingDep = activityDependencies.find(dep => 
            dep.activity_id === activity.id && dep.type === currentDependencyType
        );
        if (existingDep) return false;
        
        return true;
    });
    
    if (filteredActivities.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🔗</div>
                <div>No activities available for dependency</div>
            </div>
        `;
        return;
    }
    
    list.innerHTML = filteredActivities.map(activity => {
        const isSelected = selectedDependencyActivity?.id === activity.id;
        
        return `
            <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; ${isSelected ? 'background: #eff6ff;' : ''} cursor: pointer;" 
                 onclick="window.selectDependencyActivity('${activity.id}')">
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 0.25rem;">${activity.title}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        PC: ${activity.pc_number || 'N/A'} • Status: ${activity.status || 'pending'} • ${activity.estimated_hours || 0}h
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">
                        Scheduled: ${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not scheduled'}
                    </div>
                </div>
                <div style="margin-left: 1rem;">
                    ${isSelected ? '✓' : ''}
                </div>
            </div>
        `;
    }).join('');
}

function filterDependencySelector() {
    renderDependencySelector();
}

function selectDependencyActivity(activityId) {
    const activity = db.activities?.find(a => a.id === activityId);
    if (!activity) return;
    
    selectedDependencyActivity = activity;
    renderDependencySelector();
}

function confirmDependencySelection() {
    if (!selectedDependencyActivity) {
        alert('Please select an activity first');
        return;
    }
    
    const dependencyType = document.querySelector('input[name="dependencyType"]:checked')?.value || 'finish-to-start';
    
    const dependency = {
        id: generateUUID(),
        activity_id: selectedDependencyActivity.id,
        activity_title: selectedDependencyActivity.title,
        type: dependencyType,
        relationship: currentDependencyType // predecessor or successor
    };
    
    activityDependencies.push(dependency);
    updateDependencyLists();
    closeDependencySelector();
    
    showNotification(`${currentDependencyType} added: ${selectedDependencyActivity.title}`, 'success');
}

function updateDependencyLists() {
    updatePredecessorsList();
    updateSuccessorsList();
}

function updatePredecessorsList() {
    const emptyDiv = document.getElementById('activity-predecessors-empty');
    const listDiv = document.getElementById('activity-predecessors-list');
    
    const predecessors = activityDependencies.filter(dep => dep.relationship === 'predecessor');
    
    if (predecessors.length === 0) {
        emptyDiv.style.display = 'block';
        return;
    }
    
    emptyDiv.style.display = 'none';
    
    const predecessorItems = predecessors.map(dep => `
        <div class="dependency-item">
            <div class="dependency-info">
                <div class="dependency-title">${dep.activity_title}</div>
                <div class="dependency-type">${dep.type}</div>
            </div>
            <div class="dependency-actions">
                <button class="dependency-action" onclick="window.editDependency('${dep.id}')">Edit</button>
                <button class="dependency-action remove" onclick="window.removeDependency('${dep.id}')">Remove</button>
            </div>
        </div>
    `).join('');
    
    // Replace the empty div with the list of items
    listDiv.innerHTML = predecessorItems;
}

function updateSuccessorsList() {
    const emptyDiv = document.getElementById('activity-successors-empty');
    const listDiv = document.getElementById('activity-successors-list');
    
    const successors = activityDependencies.filter(dep => dep.relationship === 'successor');
    
    if (successors.length === 0) {
        emptyDiv.style.display = 'block';
        return;
    }
    
    emptyDiv.style.display = 'none';
    
    const successorItems = successors.map(dep => `
        <div class="dependency-item">
            <div class="dependency-info">
                <div class="dependency-title">${dep.activity_title}</div>
                <div class="dependency-type">${dep.type}</div>
            </div>
            <div class="dependency-actions">
                <button class="dependency-action" onclick="window.editDependency('${dep.id}')">Edit</button>
                <button class="dependency-action remove" onclick="window.removeDependency('${dep.id}')">Remove</button>
            </div>
        </div>
    `).join('');
    
    // Replace the empty div with the list of items
    listDiv.innerHTML = successorItems;
}

function removeDependency(dependencyId) {
    activityDependencies = activityDependencies.filter(dep => dep.id !== dependencyId);
    updateDependencyLists();
    showNotification('Dependency removed', 'success');
}

function editDependency(dependencyId) {
    // For now, just show info about the dependency
    const dependency = activityDependencies.find(dep => dep.id === dependencyId);
    if (dependency) {
        alert(`Dependency: ${dependency.activity_title}\nType: ${dependency.type}\nRelationship: ${dependency.relationship}`);
    }
}

function calculateActivitySchedule() {
    const currentActivityId = document.getElementById('activity-id').value;
    const predecessors = activityDependencies.filter(dep => dep.relationship === 'predecessor');
    
    if (predecessors.length === 0) {
        showNotification('No predecessors defined for automatic scheduling', 'info');
        return;
    }
    
    let latestEnd = new Date();
    
    // Find the latest end date among predecessors
    predecessors.forEach(dep => {
        const predecessor = db.activities?.find(a => a.id === dep.activity_id);
        if (predecessor && predecessor.scheduled_date) {
            const predecessorStart = new Date(predecessor.scheduled_date);
            const duration = predecessor.estimated_hours || predecessor.duration_hours || 8;
            const predecessorEnd = new Date(predecessorStart);
            predecessorEnd.setDate(predecessorEnd.getDate() + Math.ceil(duration / 8));
            
            if (predecessorEnd > latestEnd) {
                latestEnd = predecessorEnd;
            }
        }
    });
    
    // Set the calculated date
    const calculatedDate = latestEnd.toISOString().split('T')[0];
    document.getElementById('activity-scheduled-date').value = calculatedDate;
    
    showNotification(`Scheduled date calculated based on dependencies: ${new Date(calculatedDate).toLocaleDateString()}`, 'success');
}

// ========================================
// NEW Sprint 4.5: Analytics & Reporting System
// ========================================

let currentAnalyticsPeriod = CONFIG.UI.ANALYTICS.DEFAULT_PERIOD_DAYS;
let currentChartPeriod = CONFIG.UI.ANALYTICS.DEFAULT_CHART_PERIOD;

function initializeAnalyticsSystem() {
    console.log('📊 Initializing analytics system...');
    if (document.getElementById('analytics').style.display !== 'none') {
        updateAnalytics();
    }
}

function updateAnalytics() {
    console.log('📊 Updating analytics...');
    
    updateAnalyticsSummary();
    updateActivityPerformanceChart();
    updateTeamPerformance();
    updateActivityStatusDistribution();
    updateTimeTrackingAnalytics();
    updateResourceUtilization();
    updateActivityHeatmap();
    populateAnalyticsFilters();
}

function updateAnalyticsSummary() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - period);
    
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    const totalActivities = filteredActivities.length;
    const completedActivities = filteredActivities.filter(a => a.status === 'completed').length;
    const completionRate = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
    
    // Calculate average duration
    const activitiesWithDuration = filteredActivities.filter(a => a.estimated_hours || a.duration_hours);
    const avgDuration = activitiesWithDuration.length > 0 
        ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
        : 0;
    
    // Calculate team utilization
    const teamMembers = getUniqueTeamMembers();
    const assignedActivities = filteredActivities.filter(a => a.assigned_to_name).length;
    const teamUtilization = teamMembers.length > 0 && totalActivities > 0 
        ? Math.round((assignedActivities / totalActivities) * 100) 
        : 0;
    
    document.getElementById('summary-total-activities').textContent = totalActivities;
    document.getElementById('summary-completion-rate').textContent = completionRate + '%';
    document.getElementById('summary-avg-duration').textContent = avgDuration + 'h';
    document.getElementById('summary-team-utilization').textContent = teamUtilization + '%';
}

function updateActivityPerformanceChart() {
    const chart = document.getElementById('activity-performance-chart');
    if (!chart || !db.activities) return;
    
    const period = currentChartPeriod;
    const data = generateChartData(period);
    
    chart.innerHTML = '';
    const maxValue = Math.max(...data.map(d => d.value), 1);
    
    data.forEach((item, index) => {
        const bar = document.createElement('div');
        bar.className = 'analytics-chart-bar';
        bar.style.height = `${(item.value / maxValue) * 100}%`;
        bar.style.flex = '1';
        
        const label = document.createElement('div');
        label.className = 'analytics-chart-bar-label';
        label.textContent = item.label;
        
        const value = document.createElement('div');
        value.className = 'analytics-chart-bar-value';
        value.textContent = item.value;
        
        bar.appendChild(label);
        bar.appendChild(value);
        
        bar.addEventListener('click', () => {
            showNotification(`${item.label}: ${item.value} activities`, 'info');
        });
        
        chart.appendChild(bar);
    });
}

function generateChartData(period) {
    if (!db.activities) return [];
    
    const now = new Date();
    const data = [];
    
    switch (period) {
        case 'week':
            // Last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dayActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate.toDateString() === date.toDateString();
                });
                data.push({
                    label: date.toLocaleDateString('en', { weekday: 'short' }),
                    value: dayActivities.length
                });
            }
            break;
        case 'month':
            // Last 4 weeks
            for (let i = 3; i >= 0; i--) {
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - (i + 1) * 7);
                const endDate = new Date(now);
                endDate.setDate(endDate.getDate() - i * 7);
                
                const weekActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate >= startDate && activityDate < endDate;
                });
                
                data.push({
                    label: `Week ${4 - i}`,
                    value: weekActivities.length
                });
            }
            break;
        case 'quarter':
            // Last 3 months
            for (let i = 2; i >= 0; i--) {
                const date = new Date(now);
                date.setMonth(date.getMonth() - i);
                const monthActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate.getMonth() === date.getMonth() && 
                           activityDate.getFullYear() === date.getFullYear();
                });
                data.push({
                    label: date.toLocaleDateString('en', { month: 'short' }),
                    value: monthActivities.length
                });
            }
            break;
    }
    
    return data;
}

function updateTeamPerformance() {
    const container = document.getElementById('team-performance-metrics');
    const table = document.getElementById('team-performance-table');
    
    if (!container || !table || !db.activities) return;
    
    const teamMembers = getUniqueTeamMembers();
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Generate team metrics cards
    container.innerHTML = '';
    teamMembers.slice(0, 4).forEach(member => {
        const memberActivities = filteredActivities.filter(a => a.assigned_to_name === member);
        const completed = memberActivities.filter(a => a.status === 'completed').length;
        const completionRate = memberActivities.length > 0 ? Math.round((completed / memberActivities.length) * 100) : 0;
        
        const card = document.createElement('div');
        card.className = 'analytics-metric-card';
        card.innerHTML = `
            <div class="analytics-metric-value">${memberActivities.length}</div>
            <div class="analytics-metric-label">${member || 'Unassigned'}</div>
            <div class="analytics-metric-change ${completionRate >= 80 ? 'positive' : completionRate >= 60 ? 'neutral' : 'negative'}">
                ${completionRate}% complete
            </div>
        `;
        container.appendChild(card);
    });
    
    // Generate team performance table
    table.innerHTML = '';
    teamMembers.forEach(member => {
        const memberActivities = filteredActivities.filter(a => a.assigned_to_name === member);
        const completed = memberActivities.filter(a => a.status === 'completed').length;
        const completionRate = memberActivities.length > 0 ? Math.round((completed / memberActivities.length) * 100) : 0;
        
        const activitiesWithDuration = memberActivities.filter(a => a.estimated_hours || a.duration_hours);
        const avgDuration = activitiesWithDuration.length > 0 
            ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
            : 0;
        
        const performance = completionRate >= 80 ? 'Excellent' : completionRate >= 60 ? 'Good' : 'Needs Improvement';
        const performanceClass = completionRate >= 80 ? 'positive' : completionRate >= 60 ? 'neutral' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${member || 'Unassigned'}</td>
            <td>${memberActivities.length}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="analytics-progress-bar" style="flex: 1;">
                        <div class="analytics-progress-fill" style="width: ${completionRate}%;"></div>
                    </div>
                    <span>${completionRate}%</span>
                </div>
            </td>
            <td>${avgDuration}h</td>
            <td><span class="analytics-metric-change ${performanceClass}">${performance}</span></td>
        `;
        table.appendChild(row);
    });
}

function updateActivityStatusDistribution() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    const pending = filteredActivities.filter(a => a.status === 'pending' || !a.status).length;
    const inProgress = filteredActivities.filter(a => a.status === 'in_progress').length;
    const completed = filteredActivities.filter(a => a.status === 'completed').length;
    const total = filteredActivities.length;
    
    document.getElementById('donut-total').textContent = total;
    document.getElementById('legend-pending').textContent = `Pending (${pending})`;
    document.getElementById('legend-in-progress').textContent = `In Progress (${inProgress})`;
    document.getElementById('legend-completed').textContent = `Completed (${completed})`;
    
    // Update donut chart (simplified - just hide/show based on values)
    const pendingCircle = document.getElementById('donut-pending');
    const inProgressCircle = document.getElementById('donut-in-progress');
    const completedCircle = document.getElementById('donut-completed');
    
    if (total === 0) {
        [pendingCircle, inProgressCircle, completedCircle].forEach(circle => {
            circle.style.strokeDasharray = '0 500';
        });
        return;
    }
    
    const circumference = 2 * Math.PI * 80; // radius = 80
    
    // Pending (starts at top)
    const pendingPercent = (pending / total) * circumference;
    pendingCircle.style.strokeDasharray = `${pendingPercent} ${circumference}`;
    pendingCircle.style.strokeDashoffset = '0';
    
    // In Progress (starts after pending)
    const inProgressPercent = (inProgress / total) * circumference;
    inProgressCircle.style.strokeDasharray = `${inProgressPercent} ${circumference}`;
    inProgressCircle.style.strokeDashoffset = `-${pendingPercent}`;
    
    // Completed (starts after in progress)
    const completedPercent = (completed / total) * circumference;
    completedCircle.style.strokeDasharray = `${completedPercent} ${circumference}`;
    completedCircle.style.strokeDashoffset = `-${pendingPercent + inProgressPercent}`;
}

function updateTimeTrackingAnalytics() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Calculate total hours logged
    const totalHours = filteredActivities.reduce((sum, a) => {
        return sum + (a.estimated_hours || a.duration_hours || 0);
    }, 0);
    
    // Calculate average activity duration
    const activitiesWithDuration = filteredActivities.filter(a => a.estimated_hours || a.duration_hours);
    const avgDuration = activitiesWithDuration.length > 0 
        ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
        : 0;
    
    // Calculate overdue activities
    const now = new Date();
    const overdueActivities = filteredActivities.filter(a => {
        if (!a.scheduled_date || a.status === 'completed') return false;
        const scheduledDate = new Date(a.scheduled_date);
        return scheduledDate < now;
    }).length;
    
    document.getElementById('total-hours-logged').textContent = totalHours;
    document.getElementById('avg-activity-duration').textContent = avgDuration + 'h';
    document.getElementById('overdue-activities').textContent = overdueActivities;
    document.getElementById('overdue-change').textContent = overdueActivities === 0 ? 'All on time' : `${overdueActivities} overdue`;
}

function updateResourceUtilization() {
    const container = document.getElementById('resource-utilization-list');
    if (!container || !db.resources) return;
    
    container.innerHTML = '';
    
    db.resources.slice(0, 5).forEach(resource => {
        const utilization = calculateResourceUtilizationPeriod(resource.id);
        const utilizationLevel = utilization >= 80 ? 'high' : utilization >= 50 ? 'medium' : 'low';
        const utilizationColor = utilization >= 80 ? '#ef4444' : utilization >= 50 ? '#f59e0b' : '#22c55e';
        
        const item = document.createElement('div');
        item.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        `;
        
        item.innerHTML = `
            <div>
                <div style="font-weight: 500; margin-bottom: 0.25rem;">${resource.name}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">${resource.category || 'Resource'}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">${utilization}%</div>
                <div class="analytics-progress-bar" style="width: 100px;">
                    <div class="analytics-progress-fill" style="width: ${utilization}%; background: ${utilizationColor};"></div>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function calculateResourceUtilizationPeriod(resourceId) {
    if (!db.activities) return 0;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    const resourceActivities = filteredActivities.filter(a => 
        a.required_resources && a.required_resources.some(r => r.id === resourceId)
    );
    
    const totalPossibleDays = period;
    const utilizationDays = resourceActivities.length; // Simplified calculation
    
    return Math.min(Math.round((utilizationDays / totalPossibleDays) * 100), 100);
}

function updateActivityHeatmap() {
    const container = document.getElementById('activity-heatmap');
    if (!container || !db.activities) return;
    
    container.innerHTML = '';
    
    // Generate last 30 days
    const today = new Date();
    const heatmapData = {};
    
    // Initialize all days with 0
    for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        heatmapData[dateStr] = 0;
    }
    
    // Count activities per day
    db.activities.forEach(activity => {
        if (activity.scheduled_date && heatmapData.hasOwnProperty(activity.scheduled_date)) {
            heatmapData[activity.scheduled_date]++;
        }
    });
    
    // Find max value for scaling
    const maxActivities = Math.max(...Object.values(heatmapData), 1);
    
    // Create heatmap cells
    Object.entries(heatmapData).forEach(([date, count]) => {
        const cell = document.createElement('div');
        cell.className = 'analytics-heatmap-cell';
        
        // Determine intensity
        const intensity = count / maxActivities;
        if (intensity === 0) {
            // Keep default background
        } else if (intensity <= 0.25) {
            cell.classList.add('low');
        } else if (intensity <= 0.5) {
            cell.classList.add('medium');
        } else if (intensity <= 0.75) {
            cell.classList.add('high');
        } else {
            cell.classList.add('very-high');
        }
        
        cell.title = `${new Date(date).toLocaleDateString()}: ${count} activities`;
        cell.addEventListener('click', () => {
            showNotification(`${new Date(date).toLocaleDateString()}: ${count} activities scheduled`, 'info');
        });
        
        container.appendChild(cell);
    });
}

function filterActivitiesByPeriod(activities, days) {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    return activities.filter(activity => {
        if (!activity.created_at && !activity.scheduled_date) return true; // Include if no date info
        
        const activityDate = new Date(activity.scheduled_date || activity.created_at);
        return activityDate >= cutoffDate;
    });
}

function getUniqueTeamMembers() {
    if (!db.activities) return [];
    
    const members = new Set();
    db.activities.forEach(activity => {
        if (activity.assigned_to_name) {
            members.add(activity.assigned_to_name);
        }
    });
    
    return Array.from(members);
}

function populateAnalyticsFilters() {
    const teamFilter = document.getElementById('analytics-team-filter');
    if (!teamFilter) return;
    
    // Clear existing options except "All Team Members"
    teamFilter.innerHTML = '<option value="">All Team Members</option>';
    
    const teamMembers = getUniqueTeamMembers();
    teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member;
        option.textContent = member;
        teamFilter.appendChild(option);
    });
}

function setChartPeriod(period, button) {
    currentChartPeriod = period;
    
    // Update button states
    document.querySelectorAll('.analytics-period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    updateActivityPerformanceChart();
}

function exportAnalyticsReport() {
    if (!db.activities) {
        showNotification('No data available to export', 'warning');
        return;
    }
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Generate CSV data
    const csvData = [
        ['Activity Title', 'PC Number', 'Type', 'Status', 'Assigned To', 'Scheduled Date', 'Duration (hours)', 'Created Date']
    ];
    
    filteredActivities.forEach(activity => {
        csvData.push([
            activity.title || '',
            activity.pc_number || '',
            activity.type || '',
            activity.status || '',
            activity.assigned_to_name || '',
            activity.scheduled_date || '',
            activity.estimated_hours || activity.duration_hours || '',
            activity.created_at || ''
        ]);
    });
    
    // Convert to CSV string
    const csvString = csvData.map(row => 
        row.map(cell => `"${cell}"`).join(',')
    ).join('\n');
    
    // Create and download file
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('Analytics report exported successfully', 'success');
}

// ========================================
// Aktywności
// ========================================

function showActivityModal() {
    db.editingActivity = null;
    document.getElementById('activity-modal-title').textContent = 'New Activity';
    
    // Clear all form fields
    document.getElementById('activity-id').value = '';
    document.getElementById('activity-title').value = '';
    document.getElementById('activity-description').value = '';
    document.getElementById('activity-type').value = '';
    document.getElementById('activity-priority').value = 'medium';
    document.getElementById('activity-status').value = 'pending';
    document.getElementById('activity-scheduled-date').value = '';
    document.getElementById('activity-scheduled-time').value = '';
    document.getElementById('activity-duration').value = '';
    document.getElementById('activity-assigned-to-name').value = '';
    document.getElementById('activity-location').value = '';
    document.getElementById('activity-contact-name').value = '';
    document.getElementById('activity-contact-phone').value = '';
    document.getElementById('activity-completion-notes').value = '';
    
    // NEW Sprint 4.3: Clear selected resources and update display
    selectedActivityResources = [];
    updateActivityResourcesList();
    
    // NEW Sprint 4.4: Clear dependencies
    activityDependencies = [];
    updateDependencyLists();

    const pcSelect = document.getElementById('activity-pc-select');
    pcSelect.innerHTML = '<option value="">Select...</option>';
    db.pcs.forEach(pc => {
        const pcNumber = pc.pc_number || pc.number;
        const companyName = pc.company_name || pc.company;
        pcSelect.innerHTML += `<option value="${pc.id}">${pcNumber} - ${companyName}</option>`;
    });
    if(db.currentPC) pcSelect.value = db.currentPC.id;

    // Hide completion section initially
    document.getElementById('activity-completion-section').style.display = 'none';
    
    // Add event listener for status change
    document.getElementById('activity-status').addEventListener('change', function() {
        const completionSection = document.getElementById('activity-completion-section');
        if (this.value === 'completed') {
            completionSection.style.display = 'block';
        } else {
            completionSection.style.display = 'none';
        }
    });

    document.getElementById('activity-modal').classList.add('active');
}

function closeActivityModal() {
    document.getElementById('activity-modal').classList.remove('active');
}

async function saveActivity() {
    const id = document.getElementById('activity-id').value;
    const now = new Date().toISOString();
    
    const activityData = {
        title: document.getElementById('activity-title').value.trim(),
        description: document.getElementById('activity-description').value.trim(),
        pc_id: document.getElementById('activity-pc-select').value,
        type: document.getElementById('activity-type').value.trim(),
        status: document.getElementById('activity-status').value,
        priority: document.getElementById('activity-priority').value,
        scheduled_date: document.getElementById('activity-scheduled-date').value,
        scheduled_time: document.getElementById('activity-scheduled-time').value,
        duration_hours: parseFloat(document.getElementById('activity-duration').value) || null,
        estimated_hours: parseFloat(document.getElementById('activity-duration').value) || null, // NEW Sprint 4.3: For resource allocation calculations
        assigned_to: null, // UUID would go here if we had user management
        assigned_to_name: document.getElementById('activity-assigned-to-name').value.trim(),
        location: document.getElementById('activity-location').value.trim(),
        contact_name: document.getElementById('activity-contact-name').value.trim(),
        contact_phone: document.getElementById('activity-contact-phone').value.trim(),
        completion_notes: document.getElementById('activity-completion-notes').value.trim(),
        // NEW Sprint 4.3: Resource allocation
        required_resources: selectedActivityResources || [],
        // NEW Sprint 4.4: Dependencies
        dependencies: activityDependencies.filter(dep => dep.relationship === 'predecessor') || [],
        updated_at: now
    };

    // Required fields validation
    if(!activityData.pc_id || !activityData.title || !activityData.type) {
        alert("PC Number, Activity Title, and Activity Type are required!");
        return;
    }

    // Get PC data for denormalization
    const pc = db.pcs.find(p => p.id === activityData.pc_id);
    if (pc) {
        activityData.pc_number = pc.pc_number || pc.number;
        activityData.company_name = pc.company_name || pc.company;
    }
    
    // Set completed_at if status is completed
    if (activityData.status === 'completed' && !id) {
        activityData.completed_at = now;
    }

    try {
        if (id) { // Edit existing
            const index = db.activities.findIndex(a => a.id === id);
            if (index !== -1) {
                db.activities[index] = { ...db.activities[index], ...activityData };
                await saveToStore(STORES.ACTIVITIES, db.activities[index]);
            }
        } else { // Create new
            activityData.id = generateUUID();
            activityData.created_at = now;
    db.activities.push(activityData);
            await saveToStore(STORES.ACTIVITIES, activityData);
        }
    
                console.log('✅ Activity saved successfully');
        // Fix: Keep activity open after saving instead of closing
        if (id) {
            // For edits, stay on the activity (re-populate form)
            alert('Activity updated successfully!');
        } else {
            // For new activities, close modal and refresh list
            // NEW Sprint 4.3: Clear selected resources after saving
            selectedActivityResources = [];
            // NEW Sprint 4.4: Clear dependencies after saving
            activityDependencies = [];
    closeActivityModal();
    updateActivitiesList();
        }
    } catch (error) {
        console.error('❌ Error saving activity:', error);
        alert('Error saving activity. Please try again.');
    }
}

function updateActivitiesList() {
    const tbody = document.getElementById('activities-list');
    tbody.innerHTML = '';
    db.activities.forEach(a => {
        const pc = db.pcs.find(p => p.id === (a.pc_id || a.pcId));
        const pcNumber = pc ? (pc.pc_number || pc.number) : (a.pc_number || '-');
        const companyName = pc ? (pc.company_name || pc.company) : (a.company_name || '-');
        const scheduledDate = a.scheduled_date ? new Date(a.scheduled_date).toLocaleDateString() : (a.date ? new Date(a.date).toLocaleDateString() : '-');
        const title = a.title || a.type || '-';
        const priority = a.priority ? `<span class="priority-${a.priority}">${a.priority.toUpperCase()}</span>` : '-';
        tbody.innerHTML += `<tr>
            <td>${title}</td>
            <td>${pcNumber}</td>
            <td>${companyName}</td>
            <td>${a.type}</td>
            <td>${scheduledDate}</td>
            <td>${priority}</td>
            <td><span class="activity-status ${a.status}">${a.status}</span></td>
            <td><button class="secondary" onclick="alert('Feature under development')">Show</button></td>
        </tr>`;
    });
}


// ========================================
// Zasoby i Cenniki
// ========================================

function updateResourcesList() {
    const tbody = document.getElementById('resources-list');
    tbody.innerHTML = '';
    db.resources.forEach(res => {
        const netCost = res.net_cost || res.netCost || 0;
        const status = res.is_active !== false ? 'Active' : 'Inactive';
        const statusClass = res.is_active !== false ? 'success' : 'secondary';
        tbody.innerHTML += `<tr>
            <td>${res.name}</td>
            <td>${res.sku || '-'}</td>
            <td>${res.category}</td>
            <td>£${netCost.toFixed(2)}</td>
            <td>${res.supplier || '-'}</td>
            <td><span class="${statusClass}">${status}</span></td>
            <td><div class="action-btn-group">
                <button onclick="window.editResource('${res.id}')" class="warning">Edit</button>
                <button onclick="window.deleteResource('${res.id}')" class="danger">Remove</button>
            </div></td>
        </tr>`;
    });
}

function showResourceModal() {
    db.editingResource = null;
    document.getElementById('resource-modal-title').textContent = 'New Resource';
    
    // Clear all form fields
    document.getElementById('resource-id').value = '';
    document.getElementById('resource-name').value = '';
    document.getElementById('resource-description').value = '';
    document.getElementById('resource-category').value = '';
    document.getElementById('resource-subcategory').value = '';
    document.getElementById('resource-sku').value = '';
    document.getElementById('resource-unit').value = '';
    document.getElementById('resource-cost').value = '';
    document.getElementById('resource-supplier').value = '';
    document.getElementById('resource-supplier-code').value = '';
    document.getElementById('resource-status').value = 'true';
    document.getElementById('resource-min-quantity').value = '';
    document.getElementById('resource-lead-time').value = '';
    document.getElementById('resource-weight').value = '';
    document.getElementById('resource-dimensions').value = '';
    document.getElementById('resource-warranty').value = '';
    
    document.getElementById('resource-modal').classList.add('active');
}

function closeResourceModal() {
    document.getElementById('resource-modal').classList.remove('active');
}

async function saveResource() {
    const id = document.getElementById('resource-id').value;
    const now = new Date().toISOString();
    
    const resourceData = {
        name: document.getElementById('resource-name').value.trim(),
        description: document.getElementById('resource-description').value.trim(),
        category: document.getElementById('resource-category').value,
        subcategory: document.getElementById('resource-subcategory').value.trim(),
        sku: document.getElementById('resource-sku').value.trim(),
        unit: document.getElementById('resource-unit').value,
        net_cost: parseFloat(document.getElementById('resource-cost').value),
        supplier: document.getElementById('resource-supplier').value.trim(),
        supplier_code: document.getElementById('resource-supplier-code').value.trim(),
        is_active: document.getElementById('resource-status').value === 'true',
        min_quantity: parseInt(document.getElementById('resource-min-quantity').value) || null,
        lead_time_days: parseInt(document.getElementById('resource-lead-time').value) || null,
        weight_kg: parseFloat(document.getElementById('resource-weight').value) || null,
        dimensions: document.getElementById('resource-dimensions').value.trim(),
        warranty_months: parseInt(document.getElementById('resource-warranty').value) || null,
        updated_at: now
    };

    // Required fields validation
    if(!resourceData.name || !resourceData.category || isNaN(resourceData.net_cost) || !resourceData.unit) {
        alert("Resource Name, Category, Net Cost, and Unit are required!");
        return;
    }

    try {
        if (id) { // Edit existing
            const index = db.resources.findIndex(r => r.id === id);
            if (index !== -1) {
                db.resources[index] = { ...db.resources[index], ...resourceData };
                await saveToStore(STORES.RESOURCES, db.resources[index]);
            }
        } else { // Create new
            resourceData.id = generateUUID();
            resourceData.created_at = now;
        db.resources.push(resourceData);
            await saveToStore(STORES.RESOURCES, resourceData);
    }

        console.log('✅ Resource saved successfully');
    closeResourceModal();
    updateResourcesList();
    } catch (error) {
        console.error('❌ Error saving resource:', error);
        alert('Error saving resource. Please try again.');
    }
}

function editResource(id) {
    const res = db.resources.find(r => r.id === id);
    if (!res) return;
    db.editingResource = res;
    
    document.getElementById('resource-modal-title').textContent = 'Edit Resource';
    document.getElementById('resource-id').value = res.id;
    document.getElementById('resource-name').value = res.name || '';
    document.getElementById('resource-description').value = res.description || '';
    document.getElementById('resource-category').value = res.category || '';
    document.getElementById('resource-subcategory').value = res.subcategory || '';
    document.getElementById('resource-sku').value = res.sku || '';
    document.getElementById('resource-unit').value = res.unit || '';
    document.getElementById('resource-cost').value = res.net_cost || res.netCost || '';
    document.getElementById('resource-supplier').value = res.supplier || '';
    document.getElementById('resource-supplier-code').value = res.supplier_code || '';
    document.getElementById('resource-status').value = res.is_active !== undefined ? res.is_active.toString() : 'true';
    document.getElementById('resource-min-quantity').value = res.min_quantity || '';
    document.getElementById('resource-lead-time').value = res.lead_time_days || '';
    document.getElementById('resource-weight').value = res.weight_kg || '';
    document.getElementById('resource-dimensions').value = res.dimensions || '';
    document.getElementById('resource-warranty').value = res.warranty_months || '';
    
    document.getElementById('resource-modal').classList.add('active');
}

function deleteResource(id) {
    if (confirm('Are you sure you want to delete this resource? It cannot be used in future quotes.')) {
        db.resources = db.resources.filter(r => r.id !== id);
        // Należy też usunąć zasób z cenników
        db.priceLists.forEach(pl => {
            pl.items = pl.items.filter(item => item.resourceId !== id);
        });
        saveDataToIndexedDB();
        updateResourcesList();
    }
}


function updatePriceListsTable() {
    const tbody = document.getElementById('pricelist-table');
    tbody.innerHTML = '';
    db.priceLists.forEach(pl => {
        const effectiveFrom = pl.effective_from ? new Date(pl.effective_from).toLocaleDateString() : '-';
        const effectiveTo = pl.effective_to ? new Date(pl.effective_to).toLocaleDateString() : 'No expiry';
        const effectivePeriod = `${effectiveFrom} - ${effectiveTo}`;
        const isDefault = pl.is_default ? '<span class="success">✓ Default</span>' : '-';
        const statusClass = pl.status === 'active' ? 'success' : (pl.status === 'draft' ? 'warning' : 'secondary');
        
        tbody.innerHTML += `<tr>
            <td>${pl.name}</td>
            <td>${pl.version || '-'}</td>
            <td>${pl.currency || 'GBP'}</td>
            <td>${effectivePeriod}</td>
            <td>${isDefault}</td>
            <td><span class="${statusClass}">${pl.status}</span></td>
            <td><div class="action-btn-group">
                <button class="secondary" onclick="window.viewPriceList('${pl.id}')">Manage</button>
                <button class="warning" onclick="window.editPriceList('${pl.id}')">Edit</button>
            </div></td>
        </tr>`;
    });
}

async function createPriceList() {
    const id = document.getElementById('pricelist-id').value;
    const now = new Date().toISOString();
    
    const priceListData = {
        name: document.getElementById('pricelist-name').value.trim(),
        version: document.getElementById('pricelist-version').value.trim(),
        description: document.getElementById('pricelist-description').value.trim(),
        currency: document.getElementById('pricelist-currency').value,
        status: document.getElementById('pricelist-status').value,
        markup_percentage: parseFloat(document.getElementById('pricelist-markup').value) || 0,
        discount_percentage: parseFloat(document.getElementById('pricelist-discount').value) || 0,
        effective_from: document.getElementById('pricelist-effective-from').value,
        effective_to: document.getElementById('pricelist-effective-to').value,
        is_default: document.getElementById('pricelist-is-default').checked,
        terms: document.getElementById('pricelist-terms').value.trim(),
        updated_at: now
    };

    // Required fields validation
    if (!priceListData.name || !priceListData.version || !priceListData.effective_from) {
        alert('Price List Name, Version, and Effective From date are required!');
        return;
    }

    try {
        if (id) { // Edit existing
            const index = db.priceLists.findIndex(pl => pl.id === id);
            if (index !== -1) {
                // Preserve existing pricing_data
                priceListData.pricing_data = db.priceLists[index].pricing_data || {};
                db.priceLists[index] = { ...db.priceLists[index], ...priceListData };
                await saveToStore(STORES.PRICE_LISTS, db.priceLists[index]);
            }
        } else { // Create new
            priceListData.id = generateUUID();
            priceListData.created_at = now;
            priceListData.pricing_data = {};
            
            // If this is set as default, unset other defaults
            if (priceListData.is_default) {
                db.priceLists.forEach(pl => {
                    if (pl.is_default) {
                        pl.is_default = false;
                        saveToStore(STORES.PRICE_LISTS, pl);
                    }
                });
            }
            
            db.priceLists.push(priceListData);
            await saveToStore(STORES.PRICE_LISTS, priceListData);
        }

        console.log('✅ Price List saved successfully');
    showPage('pricelists');
    } catch (error) {
        console.error('❌ Error saving price list:', error);
        alert('Error saving price list. Please try again.');
    }
}

function clearPriceListForm() {
    document.getElementById('pricelist-form-title').textContent = 'New Price List';
    document.getElementById('pricelist-id').value = '';
    document.getElementById('pricelist-name').value = '';
    document.getElementById('pricelist-version').value = '';
    document.getElementById('pricelist-description').value = '';
    document.getElementById('pricelist-currency').value = 'GBP';
    document.getElementById('pricelist-status').value = 'active';
    document.getElementById('pricelist-markup').value = '';
    document.getElementById('pricelist-discount').value = '';
    document.getElementById('pricelist-effective-from').value = '';
    document.getElementById('pricelist-effective-to').value = '';
    document.getElementById('pricelist-is-default').checked = false;
    document.getElementById('pricelist-terms').value = 'Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.';
}

function editPriceList(id) {
    const pl = db.priceLists.find(p => p.id === id);
    if (!pl) return;
    
    document.getElementById('pricelist-form-title').textContent = 'Edit Price List';
    document.getElementById('pricelist-id').value = pl.id;
    document.getElementById('pricelist-name').value = pl.name || '';
    document.getElementById('pricelist-version').value = pl.version || '';
    document.getElementById('pricelist-description').value = pl.description || '';
    document.getElementById('pricelist-currency').value = pl.currency || 'GBP';
    document.getElementById('pricelist-status').value = pl.status || 'active';
    document.getElementById('pricelist-markup').value = pl.markup_percentage || '';
    document.getElementById('pricelist-discount').value = pl.discount_percentage || '';
    document.getElementById('pricelist-effective-from').value = pl.effective_from || '';
    document.getElementById('pricelist-effective-to').value = pl.effective_to || '';
    document.getElementById('pricelist-is-default').checked = pl.is_default || false;
    document.getElementById('pricelist-terms').value = pl.terms || '';
    
    showPage('new-pricelist');
}

function viewPriceList(id) {
    const pl = db.priceLists.find(p => p.id === id);
    if (!pl) return;
    db.currentPriceList = pl;
    document.getElementById('pricelist-title').textContent = pl.name;
    const tbody = document.getElementById('pricelist-items');
    tbody.innerHTML = '';
    pl.items.forEach(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        if (resource) {
            const margin = item.clientPrice > 0 ? ((item.clientPrice - resource.netCost) / item.clientPrice * 100) : 0;
            tbody.innerHTML += `<tr>
                <td>${resource.name}</td><td>£${resource.netCost.toFixed(2)}</td><td>£${item.clientPrice.toFixed(2)}</td><td>${margin.toFixed(1)}%</td>
                <td><button class="danger" onclick="window.removeResourceFromPriceList('${item.resourceId}')">Remove</button></td>
            </tr>`;
        }
    });
    showPage('pricelist-detail');
}

function showAddResourceToPriceList() {
    const select = document.getElementById('modal-resource-item-select');
    select.innerHTML = '<option value="">Select resource...</option>';
    db.resources.forEach(res => {
        // Nie dodawaj, jeśli już jest na liście
        if (!db.currentPriceList.items.some(item => item.resourceId === res.id)) {
            select.innerHTML += `<option value="${res.id}">${res.name}</option>`;
        }
    });
    document.getElementById('add-resource-modal').classList.add('active');
}

function closeAddResourceModal() {
    document.getElementById('add-resource-modal').classList.remove('active');
}

function updateResourceInfo() {
    const resId = document.getElementById('modal-resource-item-select').value;
    const infoDiv = document.getElementById('resource-info');
    if(resId) {
        const res = db.resources.find(r => r.id === resId);
        infoDiv.innerHTML = `Net Cost: £${res.netCost.toFixed(2)}`;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}
document.getElementById('modal-resource-item-select').addEventListener('change', updateResourceInfo);


function calculateMargin() {
    const resId = document.getElementById('modal-resource-item-select').value;
    const clientPrice = parseFloat(document.getElementById('modal-client-price').value);
    const marginDiv = document.getElementById('margin-info');
    if (resId && clientPrice > 0) {
        const res = db.resources.find(r => r.id === resId);
        const margin = ((clientPrice - res.netCost) / clientPrice * 100).toFixed(1);
        marginDiv.innerHTML = `Margin: ${margin}%`;
    } else {
        marginDiv.innerHTML = '';
    }
}

async function addResourceToPriceList() {
    const resourceId = document.getElementById('modal-resource-item-select').value;
    const clientPrice = parseFloat(document.getElementById('modal-client-price').value);

    if(!resourceId || isNaN(clientPrice)) {
        alert('Select resource and enter price!');
        return;
    }

    const resource = db.resources.find(r => r.id === resourceId);
    if (!resource) return;

    const netCost = resource.net_cost || resource.netCost || 0;
    const calculatedMarkup = netCost > 0 ? ((clientPrice - netCost) / netCost * 100) : 0;

    const pricingItem = {
        price: clientPrice,
        markup_percentage: calculatedMarkup,
        effective_price: clientPrice,
        min_quantity: resource.min_quantity || 1,
        notes: ''
    };

    // Initialize pricing_data if it doesn't exist
    if (!db.currentPriceList.pricing_data) {
        db.currentPriceList.pricing_data = {};
    }
    
    // Add or update resource in pricing_data (JSONB structure)
    db.currentPriceList.pricing_data[resourceId] = pricingItem;

    // Keep backward compatibility with old items structure
    if (!db.currentPriceList.items) db.currentPriceList.items = [];
    const existingIndex = db.currentPriceList.items.findIndex(item => item.resourceId === resourceId);
    if (existingIndex >= 0) {
        db.currentPriceList.items[existingIndex] = { resourceId, clientPrice };
    } else {
    db.currentPriceList.items.push({ resourceId, clientPrice });
    }

    try {
        await saveToStore(STORES.PRICE_LISTS, db.currentPriceList);
        console.log('✅ Resource added to price list successfully');
    closeAddResourceModal();
    viewPriceList(db.currentPriceList.id);
    } catch (error) {
        console.error('❌ Error adding resource to price list:', error);
        alert('Error adding resource to price list. Please try again.');
    }
}

function removeResourceFromPriceList(resourceId) {
    db.currentPriceList.items = db.currentPriceList.items.filter(item => item.resourceId !== resourceId);
    saveDataToIndexedDB();
    viewPriceList(db.currentPriceList.id);
}


// ========================================
// Inicjalizacja Aplikacji
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    // Expose functions to window object
    window.showPage = showPage;
    window.savePC = savePC;
    window.editPC = editPC;
    window.viewPC = viewPC;
    window.createQuote = createQuote;
    window.showNewQuoteModal = showNewQuoteModal;
    window.closeQuoteModal = closeQuoteModal;
    window.proceedToQuoteBuilder = proceedToQuoteBuilder;
    window.onPriceListChange = onPriceListChange;
    window.addLineItem = addLineItem;
    window.updateLinePrice = updateLinePrice;
    window.updateLineQty = updateLineQty;
    window.removeLine = removeLine;
    window.saveQuote = saveQuote;
    window.cancelQuote = cancelQuote;
    window.showActivityModal = showActivityModal;
    window.closeActivityModal = closeActivityModal;
    window.saveActivity = saveActivity;
    window.showResourceModal = showResourceModal;
    window.closeResourceModal = closeResourceModal;
    window.saveResource = saveResource;
    window.editResource = editResource;
    window.deleteResource = deleteResource;
    window.updatePriceListsTable = updatePriceListsTable;
    window.createPriceList = createPriceList;
    window.viewPriceList = viewPriceList;
    window.showAddResourceToPriceList = showAddResourceToPriceList;
    window.closeAddResourceModal = closeAddResourceModal;
    window.calculateMargin = calculateMargin;
    window.addResourceToPriceList = addResourceToPriceList;
    window.removeResourceFromPriceList = removeResourceFromPriceList;
    // NEW Sprint 2: Address & Move Type functions
    window.toggleAddressSections = toggleAddressSections;
    window.copyCollectionToDelivery = copyCollectionToDelivery;
    window.updateAddressValidation = updateAddressValidation;
    window.populateQuotedActivities = populateQuotedActivities;
    window.updateQuotedActivities = updateQuotedActivities;
    window.onQuoteStatusChange = onQuoteStatusChange;
    window.validateQuoteEditability = validateQuoteEditability;
    // NEW Sprint 3: Enhanced Resource Lookup functions
    window.showEnhancedResourceModal = showEnhancedResourceModal;
    window.closeEnhancedResourceModal = closeEnhancedResourceModal;
    window.filterResources = filterResources;
    window.renderResourcesList = renderResourcesList;
    window.toggleResourceSelection = toggleResourceSelection;
    window.updateResourceTotal = updateResourceTotal;
    window.selectAllFilteredResources = selectAllFilteredResources;
    window.clearResourceSelection = clearResourceSelection;
    window.updateSelectionCount = updateSelectionCount;
    window.addSelectedResourcesToQuote = addSelectedResourcesToQuote;
    window.addResourceToQuoteCategory = addResourceToQuoteCategory;
    // NEW Sprint 3.2: Bulk Operations functions
    window.updateBulkSelection = updateBulkSelection;
    window.toggleCategorySelection = toggleCategorySelection;
    window.clearBulkSelection = clearBulkSelection;
    window.bulkUpdateQuantity = bulkUpdateQuantity;
    window.closeBulkQuantityModal = closeBulkQuantityModal;
    window.applyBulkQuantityUpdate = applyBulkQuantityUpdate;
    window.bulkApplyDiscount = bulkApplyDiscount;
    window.closeBulkDiscountModal = closeBulkDiscountModal;
    window.applyBulkDiscount = applyBulkDiscount;
    window.bulkDeleteItems = bulkDeleteItems;
    // NEW Sprint 3.3: Template Management functions
    window.updateTemplatesList = updateTemplatesList;
    window.filterTemplates = filterTemplates;
    window.showCreateTemplateFromScratch = showCreateTemplateFromScratch;
    window.saveQuoteAsTemplate = saveQuoteAsTemplate;
    window.duplicateCurrentQuote = duplicateCurrentQuote;
    window.closeTemplateModal = closeTemplateModal;
    window.saveTemplate = saveTemplate;
    window.editTemplate = editTemplate;
    window.deleteTemplate = deleteTemplate;
    window.createQuoteFromTemplate = createQuoteFromTemplate;
    window.addItemsToTemplate = addItemsToTemplate;
    // NEW Sprint 4.1: Activity Template Management functions
    window.updateActivityTemplatesList = updateActivityTemplatesList;
    window.filterActivityTemplates = filterActivityTemplates;
    window.showCreateActivityTemplate = showCreateActivityTemplate;
    window.closeActivityTemplateModal = closeActivityTemplateModal;
    window.saveActivityTemplate = saveActivityTemplate;
    window.editActivityTemplate = editActivityTemplate;
    window.deleteActivityTemplate = deleteActivityTemplate;
    window.createActivityFromTemplate = createActivityFromTemplate;
    window.saveActivityAsTemplate = saveActivityAsTemplate;
    // NEW Sprint 4.2: Calendar Management functions
    window.switchActivitiesView = switchActivitiesView;
    window.setCalendarView = setCalendarView;
    window.navigateCalendar = navigateCalendar;
    window.renderCalendar = renderCalendar;
    window.renderMonthView = renderMonthView;
    window.renderWeekView = renderWeekView;
    window.showActivityInSidebar = showActivityInSidebar;
    window.closeCalendarSidebar = closeCalendarSidebar;
    window.editActivityFromCalendar = editActivityFromCalendar;
    // NEW Sprint 4.2.2: Drag & Drop Time Slot Management functions
    window.enableDragAndDrop = enableDragAndDrop;
    window.closeQuickCreate = closeQuickCreate;
    window.submitQuickCreate = submitQuickCreate;
    // NEW Sprint 4.2.3: Team Management & Workload Balancing functions
    window.initializeTeamManagement = initializeTeamManagement;
    window.filterByTeamMember = filterByTeamMember;
    window.toggleWorkloadPanel = toggleWorkloadPanel;
    window.showTeamManagement = showTeamManagement;
    window.closeTeamManagement = closeTeamManagement;
    window.addTeamMember = addTeamMember;
    window.removeTeamMember = removeTeamMember;
    // NEW Sprint 4.2.4: Recurring Activities functions
    window.toggleRecurringOptions = toggleRecurringOptions;
    window.updateRecurringPreview = updateRecurringPreview;
    window.showRecurringEditModal = showRecurringEditModal;
    window.closeRecurringEditModal = closeRecurringEditModal;
    window.editRecurringActivity = editRecurringActivity;
    window.deleteRecurringSeries = deleteRecurringSeries;
    window.editActivityFromCalendarRecurring = editActivityFromCalendarRecurring;
    // NEW Sprint 4.2.5: Notifications & Reminders functions
    window.toggleNotificationCenter = toggleNotificationCenter;
    window.markAllNotificationsRead = markAllNotificationsRead;
    window.handleNotificationClick = handleNotificationClick;
    // NEW Sprint 4.3: Resource Allocation functions
    window.filterResourcesByType = filterResourcesByType;
    window.filterResourcesByStatus = filterResourcesByStatus;
    window.refreshResourceAllocation = refreshResourceAllocation;
    window.showResourceCalendarView = showResourceCalendarView;
    window.hideResourceCalendarView = hideResourceCalendarView;
    window.navigateResourceWeek = navigateResourceWeek;
    window.viewResourceSchedule = viewResourceSchedule;
    window.viewResourceDayDetails = viewResourceDayDetails;
    window.showActivityResourceSelector = showActivityResourceSelector;
    window.closeActivityResourceSelector = closeActivityResourceSelector;
    window.filterActivityResourceSelector = filterActivityResourceSelector;
    window.toggleActivityResourceSelection = toggleActivityResourceSelection;
    window.confirmActivityResourceSelection = confirmActivityResourceSelection;
    window.removeActivityResource = removeActivityResource;
    window.checkResourceAvailability = checkResourceAvailability;
    // NEW Sprint 4.4: Workflow & Dependencies functions
    window.setWorkflowMode = setWorkflowMode;
    window.autoLayoutWorkflow = autoLayoutWorkflow;
    window.calculateCriticalPath = calculateCriticalPath;
    window.optimizeWorkflow = optimizeWorkflow;
    window.showDependencySelector = showDependencySelector;
    window.closeDependencySelector = closeDependencySelector;
    window.filterDependencySelector = filterDependencySelector;
    window.selectDependencyActivity = selectDependencyActivity;
    window.confirmDependencySelection = confirmDependencySelection;
    window.removeDependency = removeDependency;
    window.editDependency = editDependency;
    window.calculateActivitySchedule = calculateActivitySchedule;
    // NEW Sprint 4.5: Analytics functions
    window.updateAnalytics = updateAnalytics;
    window.setChartPeriod = setChartPeriod;
    window.exportAnalyticsReport = exportAnalyticsReport;
    window.resetData = resetData;
    window.clearPCForm = clearPCForm;
    window.clearPriceListForm = clearPriceListForm;
    window.editPriceList = editPriceList;

    // Initialize IndexedDB and load data
    console.log('🚀 Starting application initialization...');
    initializeIndexedDB()
        .then(() => {
            console.log('✅ IndexedDB initialized, loading data...');
            return loadDataFromIndexedDB();
        })
        .then(() => {
            console.log('✅ Data loaded, loading team members and initializing systems...');
            loadTeamMembersFromStorage();
            initializeTeamManagement();
            initializeNotificationSystem();
            initializeResourceAllocationSystem();
            initializeWorkflowSystem();
            initializeAnalyticsSystem();
            console.log('✅ All systems initialized, showing dashboard...');
            console.log('📊 Current db state:', {
                pcs: db.pcs?.length || 0,
                quotes: db.quotes?.length || 0,
                activities: db.activities?.length || 0,
                resources: db.resources?.length || 0,
                priceLists: db.priceLists?.length || 0,
                templates: db.templates?.length || 0,
                activityTemplates: db.activityTemplates?.length || 0
            });
            return showPage('dashboard');
        })
        .catch(error => {
            console.error('❌ Failed to initialize application:', error);
            console.error('❌ Error details:', error.stack);
            alert('Failed to initialize database. Please refresh the page and check console for details.');
        });
});

</script>

</body>
</html>
```