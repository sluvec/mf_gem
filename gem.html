<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Demo - Portable Version</title>
    
    <style>
        :root {
            --primary-color: #3b82f6; --primary-50: #eff6ff; --primary-100: #dbeafe; --primary-200: #bfdbfe; --primary-300: #93c5fd; --primary-400: #60a5fa; --primary-500: #3b82f6; --primary-600: #2563eb; --primary-700: #1d4ed8; --primary-800: #1e40af; --primary-900: #1e3a8a;
            --secondary-50: #f8fafc; --secondary-100: #f1f5f9; --secondary-200: #e2e8f0; --secondary-300: #cbd5e1; --secondary-400: #94a3b8; --secondary-500: #64748b; --secondary-600: #475569; --secondary-700: #334155; --secondary-800: #1e293b; --secondary-900: #0f172a;
            --success-50: #f0fdf4; --success-100: #dcfce7; --success-200: #bbf7d0; --success-300: #86efac; --success-400: #4ade80; --success-500: #22c55e; --success-600: #16a34a; --success-700: #15803d; --success-800: #166534; --success-900: #14532d;
            --warning-50: #fffbeb; --warning-100: #fef3c7; --warning-200: #fde68a; --warning-300: #fcd34d; --warning-400: #fbbf24; --warning-500: #f59e0b; --warning-600: #d97706; --warning-700: #b45309; --warning-800: #92400e; --warning-900: #78350f;
            --error-50: #fef2f2; --error-100: #fee2e2; --error-200: #fecaca; --error-300: #fca5a5; --error-400: #f87171; --error-500: #ef4444; --error-600: #dc2626; --error-700: #b91c1c; --error-800: #991b1b; --error-900: #7f1d1d;
            --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-300: #cbd5e1; --neutral-400: #94a3b8; --neutral-500: #64748b; --neutral-600: #475569; --neutral-700: #334155; --neutral-800: #1e293b; --neutral-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem; --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem;
            --space-xs: 0.25rem; --space-sm: 0.5rem; --space-md: 1rem; --space-lg: 1.5rem; --space-xl: 2rem; --space-2xl: 3rem;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--secondary-50);
            color: var(--neutral-800);
            line-height: 1.6;
            font-size: 14px;
        }
        .navbar { 
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white; 
            padding: 1rem 2rem;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar .nav-left, .navbar .nav-right { display: flex; align-items: center; }
        .navbar h1 { 
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 2rem;
            cursor: pointer;
        }
        .navbar .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            padding: 0.5rem 1rem;
            margin: 0 var(--space-xs);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        .navbar .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .navbar .nav-btn.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .container { max-width: 1400px; margin: var(--space-xl) auto; padding: 0 var(--space-lg); }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card { 
            background: white;
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }
        .card h2 { margin-bottom: var(--space-lg); color: var(--neutral-900); font-size: 1.5rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-2xl); }
        .stat-card { 
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--neutral-200);
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stat-card.clickable { cursor: pointer; }
        .stat-card h3 { color: var(--neutral-600); font-size: 0.875rem; margin-bottom: var(--space-sm); font-weight: 600; text-transform: uppercase; }
        .stat-card .value { font-size: 2.2rem; font-weight: 700; color: var(--neutral-900); }
        button { 
            background: var(--primary-500);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            cursor: pointer;
            margin-right: var(--space-sm);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        button:hover { background: var(--primary-600); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        button.secondary { background: var(--neutral-200); color: var(--neutral-700); }
        button.secondary:hover { background: var(--neutral-300); }
        button.danger { background: var(--error-500); }
        button.danger:hover { background: var(--error-600); }
        button.warning { background: var(--warning-500); }
        button.warning:hover { background: var(--warning-600); }
        input, select, textarea { 
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            border: 1px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 2px var(--primary-100); }
        label { display: block; margin-bottom: var(--space-xs); font-weight: 600; color: var(--neutral-700); }
        .input-error { border-color: var(--error-500) !important; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius-lg); overflow: hidden; }
        th, td { padding: var(--space-md); text-align: left; border-bottom: 1px solid var(--neutral-200); }
        th { background: var(--neutral-100); font-weight: 600; color: var(--neutral-700); font-size: 0.875rem; text-transform: uppercase; }
        tr:hover td { background: var(--primary-50); }
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000;
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; padding: var(--space-xl); border-radius: var(--radius-lg);
            width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto;
        }
        .quote-builder { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
        .line-item { display: grid; grid-template-columns: 3fr 1fr 1.5fr 1fr auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .line-item input, .line-item select { margin-bottom: 0; padding: 0.5rem; }
        .remove-btn { background: var(--error-500); padding: 0.5rem; color: white; border: none; cursor: pointer; }
        .summary { background: var(--neutral-100); padding: 1.5rem; border-radius: 8px; position: sticky; top: 100px; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-total { border-top: 2px solid var(--neutral-300); padding-top: 1rem; margin-top: 1rem; font-weight: bold; font-size: 1.2rem; }
        .activity-status {
            display: inline-block; padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-lg); font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .activity-status.draft { background-color: var(--neutral-200); color: var(--neutral-700); }
        .activity-status.ready { background-color: var(--primary-200); color: var(--primary-800); }
        .activity-status.sent { background-color: var(--success-200); color: var(--success-800); }
        .activity-status.cancelled { background-color: var(--error-200); color: var(--error-800); }
        .activity-status.pending { background-color: var(--neutral-200); color: var(--neutral-700); }
        .activity-status.in_progress { background-color: var(--primary-200); color: var(--primary-800); }
        .activity-status.completed { background-color: var(--success-200); color: var(--success-800); }
        
        .priority-low { background: #e2e8f0; color: #475569; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-medium { background: #fbbf24; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-high { background: #f87171; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .priority-urgent { background: #dc2626; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: bold; }
        
        /* Quote Status Styling */
        .quote-status-draft { background: #f3f4f6; color: #374151; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        .quote-status-issued { background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        .quote-status-won { background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; }
        .quote-status-lost { background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; text-transform: uppercase; }
        
        .form-section { border: 1px solid var(--neutral-200); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--radius-lg); }
        .form-section h3 { margin-top: 0; border-bottom: 1px solid var(--neutral-200); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .form-actions { margin-top: 1.5rem; text-align: right; }
        .action-btn-group { display: flex; gap: 0.5rem; align-items: center; }
        .action-btn-group button { margin-right: 0; }
        .field-note { font-size: 0.875rem; color: var(--neutral-600); margin-top: 0.5rem; font-style: italic; }
        
        /* ========================================
           ACCESSIBILITY & MOBILE FIRST STYLES
           ======================================== */
        
        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Skip Links for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 4px;
            z-index: 9999;
            font-weight: 500;
            transition: top 0.2s ease;
        }
        
        .skip-link:focus {
            top: 0;
            outline: 2px solid var(--warning-400);
            outline-offset: 2px;
        }
        
        /* Enhanced Focus Styles */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        .nav-btn:focus,
        .logo-btn:focus {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--primary-100);
        }
        
        /* Logo Button Styling */
        .logo-btn {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        
        /* Mobile Navigation Styles */
        .mobile-menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-md);
            transition: background-color 0.2s ease;
        }
        
        .mobile-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .hamburger-line {
            width: 24px;
            height: 2px;
            background: white;
            transition: all 0.3s ease;
            border-radius: 1px;
        }
        
        .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        /* ========================================
           HIERARCHICAL NAVIGATION STYLES
           ======================================== */
        
        /* Navigation Menu Styles */
        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: var(--space-xs);
            align-items: center;
        }
        
        .nav-menu li {
            display: flex;
            position: relative;
        }
        
        /* Navigation Button Base Styles */
        .nav-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            white-space: nowrap;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .nav-btn.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        /* Icon Styles */
        .nav-icon {
            font-size: 1rem;
            line-height: 1;
        }
        
        /* Dropdown Toggle Styles */
        .dropdown-toggle {
            position: relative;
        }
        
        .dropdown-arrow {
            font-size: 0.75rem;
            transition: transform 0.2s ease;
            margin-left: var(--space-1);
        }
        
        .dropdown-toggle[aria-expanded="true"] .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .dropdown-toggle[aria-expanded="true"] {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Dropdown Menu Styles */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 280px;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--neutral-200);
            list-style: none;
            margin: 0;
            padding: var(--space-2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }
        
        .dropdown-menu[aria-hidden="false"] {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-menu li {
            width: 100%;
        }
        
        /* Dropdown Item Styles */
        .dropdown-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            width: 100%;
            padding: var(--space-3);
            background: none;
            border: none;
            color: var(--neutral-700);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            min-height: auto;
        }
        
        .dropdown-item:hover {
            background: var(--primary-50);
            color: var(--primary-700);
            transform: translateX(2px);
        }
        
        .dropdown-item:focus {
            background: var(--primary-100);
            color: var(--primary-800);
            outline: 2px solid var(--primary-500);
            outline-offset: -2px;
        }
        
        .item-icon {
            flex-shrink: 0;
            font-size: 1.125rem;
            line-height: 1;
            margin-top: 2px;
        }
        
        .dropdown-item .item-content {
            flex: 1;
            min-width: 0;
        }
        
        .dropdown-item .item-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: var(--space-1);
            color: inherit;
        }
        
        .item-description {
            display: block;
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-top: var(--space-1);
            line-height: 1.3;
        }
        
        .dropdown-item:hover .item-description {
            color: var(--primary-600);
        }
        
        /* Dropdown Menu Positioning */
        .nav-dropdown:nth-last-child(-n+2) .dropdown-menu {
            left: auto;
            right: 0;
        }
        
        /* Mobile Navigation Dropdown Adjustments */
        @media (max-width: 767px) {
            .nav-menu.active .dropdown-menu {
                position: static;
                box-shadow: none;
                border: none;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-md);
                margin: var(--space-2) 0;
                opacity: 1;
                visibility: visible;
                transform: none;
            }
            
            .nav-menu.active .dropdown-item {
                color: rgba(255, 255, 255, 0.9);
                padding: var(--space-2) var(--space-4);
            }
            
            .nav-menu.active .dropdown-item:hover {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                transform: none;
            }
            
            .nav-menu.active .item-description {
                color: rgba(255, 255, 255, 0.7);
            }
            
            .nav-menu.active .dropdown-item:hover .item-description {
                color: rgba(255, 255, 255, 0.9);
            }
        }
        
        /* Active Page Highlighting */
        .dropdown-item.active {
            background: var(--primary-100);
            color: var(--primary-800);
        }
        
        .dropdown-item.active .item-description {
            color: var(--primary-600);
        }
        
        /* Keyboard Navigation Enhancements */
        .dropdown-menu[aria-hidden="false"] .dropdown-item:first-child {
            background: var(--primary-50);
        }
        
        /* Animation for Mobile Menu Dropdowns */
        @media (max-width: 767px) {
            .nav-menu.active .dropdown-menu {
                animation: mobile-dropdown-slide 0.3s ease-out;
            }
        }
        
        @keyframes mobile-dropdown-slide {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 300px;
            }
        }
        
        /* Touch-Friendly Button Sizes */
        .nav-btn,
        button,
        .btn {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --neutral-900: #000000;
                --neutral-100: #ffffff;
                --primary-500: #0000ff;
                --success-500: #006600;
                --warning-500: #cc6600;
                --error-500: #cc0000;
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
        
        /* ========================================
           MOBILE FIRST RESPONSIVE DESIGN
           ======================================== */
        
        /* Base Mobile Styles (320px+) */
        @media (max-width: 767px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                position: relative;
            }
            
            .nav-left {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--primary-600);
                flex-direction: column;
                padding: 1rem;
                box-shadow: var(--shadow-lg);
                border-radius: 0 0 var(--radius-lg) var(--radius-lg);
                z-index: 1000;
            }
            
            .nav-menu.active {
                display: flex;
            }
            
            .nav-menu li {
                width: 100%;
            }
            
            .nav-btn {
                width: 100%;
                justify-content: flex-start;
                padding: 1rem;
                text-align: left;
                border-radius: var(--radius-md);
                margin-bottom: var(--space-xs);
            }
            
            .container {
                padding: 0 1rem;
            }
            
            /* Mobile Quote Builder */
            .quote-builder {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .summary {
                position: static;
                margin-top: 1rem;
                order: -1;
            }
            
            /* Mobile Tables - Hide desktop table, show cards */
            .table-responsive {
                display: none;
            }
            
            .mobile-cards {
                display: block;
            }
            
            /* Modal adjustments for mobile */
            .modal-content {
                width: 95vw;
                height: 95vh;
                max-width: none;
                max-height: none;
                margin: 2.5vh auto;
                overflow-y: auto;
            }
            
            /* Form adjustments */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .form-actions {
                text-align: center;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-actions button {
                width: 100%;
            }
        }
        
        /* Tablet Styles (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .mobile-menu-toggle {
                display: none;
            }
            
            .nav-menu {
                display: flex;
                position: static;
                background: transparent;
                flex-direction: row;
                padding: 0;
                box-shadow: none;
            }
            
            .container {
                padding: 0 1.5rem;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quote-builder {
                grid-template-columns: 2fr 1fr;
            }
            
            /* Show desktop table on tablet */
            .table-responsive {
                display: table;
                width: 100%;
                overflow-x: auto;
            }
            
            .mobile-cards {
                display: none;
            }
        }
        
        /* Desktop Styles (1024px+) */
        @media (min-width: 1024px) {
            .navbar {
                padding: 1rem 2rem;
                flex-direction: row;
            }
            
            .nav-left {
                width: auto;
            }
            
            .mobile-menu-toggle {
                display: none;
            }
            
            .nav-menu {
                display: flex;
                position: static;
                background: transparent;
                flex-direction: row;
                padding: 0;
                box-shadow: none;
            }
            
            .nav-menu li {
                width: auto;
            }
            
            .nav-btn {
                width: auto;
                justify-content: center;
                padding: 0.5rem 1rem;
                text-align: center;
                margin-bottom: 0;
            }
            
            .container {
                max-width: 1400px;
                padding: 0 2rem;
            }
            
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .table-responsive {
                display: table;
                overflow: visible;
            }
            
            .mobile-cards {
                display: none;
            }
            
            .form-actions {
                text-align: right;
                display: block;
            }
            
            .form-actions button {
                width: auto;
            }
        }
        
        /* Legacy responsive rules - keep for compatibility */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* NEW Sprint 4.2: Calendar Styles */
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day-header {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .calendar-day.other-month {
            background: #f9fafb;
            color: #9ca3af;
        }
        
        .calendar-day.today {
            background: #eff6ff;
            border-color: #3b82f6;
        }
        
        .calendar-day.selected {
            background: #dbeafe;
            border-color: #2563eb;
        }
        
        .calendar-activity {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem 0;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .calendar-activity:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .calendar-activity.priority-high {
            background: #ef4444;
        }
        
        .calendar-activity.priority-urgent {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .calendar-activity.priority-low {
            background: #6b7280;
        }
        
        .calendar-activity.status-completed {
            background: #10b981;
        }
        
        .calendar-activity.status-cancelled {
            background: #f59e0b;
            text-decoration: line-through;
        }
        
        .week-time-slot {
            background: white;
            border: 1px solid #e5e7eb;
            min-height: 60px;
            padding: 0.25rem;
            position: relative;
        }
        
        .week-time-label {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .week-day-header {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            font-weight: 500;
            color: #374151;
        }
        
        .week-day-header.today {
            background: #eff6ff;
            color: #2563eb;
        }

        /* NEW Sprint 4.2.2: Drag & Drop Time Slot Management */
        .time-slot-drop-zone {
            position: relative;
            transition: all 0.2s ease;
        }

        .time-slot-drop-zone:hover {
            background: #f0fdf4 !important;
            border-color: #22c55e !important;
        }

        .time-slot-drop-zone.drag-over {
            background: #dcfce7 !important;
            border: 2px dashed #22c55e !important;
            transform: scale(1.02);
        }

        .calendar-activity.draggable {
            cursor: grab;
            user-select: none;
        }

        .calendar-activity.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
            z-index: 1000;
        }

        .time-slot-create-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .week-time-slot:hover .time-slot-create-hint {
            opacity: 1;
        }

        .week-time-slot.empty {
            background: #fafafa;
            border: 1px dashed #d1d5db;
        }

        .week-time-slot.empty:hover {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .time-conflict-warning {
            background: #fef2f2 !important;
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }

        .quick-create-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .quick-create-form {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 400px;
            max-width: 90vw;
        }

        .time-slot-info {
            background: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }

        /* NEW Sprint 4.2.3: Workload Balancing & Team Assignment */
        .team-filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .team-member-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .team-member-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .team-member-chip.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .team-member-chip.all {
            background: #f3f4f6;
            color: #374151;
        }

        .workload-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid white;
        }

        .workload-low { background: #10b981; }
        .workload-medium { background: #f59e0b; }
        .workload-high { background: #ef4444; }
        .workload-overloaded { background: #dc2626; animation: pulse 2s infinite; }

        .calendar-activity.assigned {
            position: relative;
            border-left: 3px solid transparent;
        }

        .calendar-activity.assigned::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--assignee-color, #6b7280);
        }

        .assignee-avatar {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            margin-right: 0.25rem;
        }

        .workload-panel {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .workload-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .workload-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--member-color, #6b7280);
        }

        .workload-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .workload-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .workload-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .workload-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .assignment-conflict {
            background: #fef2f2 !important;
            border-color: #ef4444 !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* NEW Sprint 4.2.4: Recurring Activities */
        .recurring-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .recurring-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .recurring-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .recurring-options {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .recurring-options.active {
            display: grid;
        }

        .calendar-activity.recurring {
            position: relative;
            border-radius: 0.375rem;
        }

        .calendar-activity.recurring::after {
            content: 'ðŸ”„';
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 0.6rem;
            line-height: 1;
        }

        .recurring-badge {
            display: inline-flex;
            align-items: center;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .recurring-series-actions {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        .recurring-series-actions h4 {
            margin: 0 0 0.5rem 0;
            color: #92400e;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .recurring-series-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .recurring-series-buttons button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .recurring-series-buttons button:hover {
            background: #d97706;
        }

        .recurring-series-buttons button.secondary {
            background: #6b7280;
        }

        .recurring-series-buttons button.secondary:hover {
            background: #4b5563;
        }

        .recurring-preview {
            background: #ecfdf5;
            border: 1px solid #22c55e;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        .recurring-preview h5 {
            margin: 0 0 0.5rem 0;
            color: #15803d;
            font-weight: 600;
        }

        .recurring-preview-dates {
            color: #166534;
            line-height: 1.4;
        }

        /* NEW Sprint 4.2.5: Notifications & Reminders */
        .notification-center {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 350px;
            max-height: 600px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .notification-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-item.unread {
            background: #fef7ff;
            border-left-color: #a855f7;
        }

        .notification-item.urgent {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .notification-item.warning {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .notification-item.success {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        .notification-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.875rem;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .notification-message {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-bell {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s ease-in-out;
            font-size: 1.125rem;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .notification-bell.has-notifications {
            animation: pulse 2s infinite;
        }

        .dashboard-alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .dashboard-alert.urgent {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .dashboard-alert.success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #22c55e;
        }

        .dashboard-alert-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
        }

        .dashboard-alert-content {
            flex: 1;
        }

        .dashboard-alert-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: #92400e;
        }

        .dashboard-alert.urgent .dashboard-alert-title {
            color: #991b1b;
        }

        .dashboard-alert.success .dashboard-alert-title {
            color: #166534;
        }

        .dashboard-alert-message {
            font-size: 0.8rem;
            color: #78350f;
            line-height: 1.4;
        }

        .dashboard-alert.urgent .dashboard-alert-message {
            color: #7f1d1d;
        }

        .dashboard-alert.success .dashboard-alert-message {
            color: #14532d;
        }

        .upcoming-activities {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .upcoming-activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .upcoming-activity-item:hover {
            background: #f9fafb;
            border-left-color: #3b82f6;
        }

        .upcoming-activity-item.overdue {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .upcoming-activity-item.today {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }

        .upcoming-activity-item.tomorrow {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }

        /* NEW Sprint 4.3: Resource Allocation Tracking */
        .resource-allocation-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .resource-allocation-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        .resource-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .resource-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .resource-card.equipment {
            border-left: 4px solid #8b5cf6;
        }

        .resource-card.vehicle {
            border-left: 4px solid #06b6d4;
        }

        .resource-card.material {
            border-left: 4px solid #10b981;
        }

        .resource-card.tool {
            border-left: 4px solid #f59e0b;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .resource-name {
            font-weight: 600;
            font-size: 1rem;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .resource-type {
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .resource-type.equipment {
            background: #ede9fe;
            color: #7c3aed;
        }

        .resource-type.vehicle {
            background: #cffafe;
            color: #0891b2;
        }

        .resource-type.material {
            background: #d1fae5;
            color: #059669;
        }

        .resource-type.tool {
            background: #fef3c7;
            color: #d97706;
        }

        .resource-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .resource-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .resource-status-indicator.available {
            background: #22c55e;
        }

        .resource-status-indicator.in-use {
            background: #f59e0b;
        }

        .resource-status-indicator.maintenance {
            background: #ef4444;
        }

        .resource-status-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .resource-status-text.available {
            color: #166534;
        }

        .resource-status-text.in-use {
            color: #92400e;
        }

        .resource-status-text.maintenance {
            color: #991b1b;
        }

        .resource-assignments {
            background: white;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .resource-assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .resource-assignment-item:last-child {
            border-bottom: none;
        }

        .assignment-activity {
            flex: 1;
            min-width: 0;
        }

        .assignment-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #111827;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .assignment-details {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .assignment-period {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .resource-utilization {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        .utilization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .utilization-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
        }

        .utilization-percentage {
            font-size: 0.75rem;
            font-weight: 600;
            color: #111827;
        }

        .utilization-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .utilization-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .utilization-fill.low {
            background: #22c55e;
        }

        .utilization-fill.medium {
            background: #f59e0b;
        }

        .utilization-fill.high {
            background: #ef4444;
        }

        .resource-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .resource-action-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .resource-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .resource-action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .resource-action-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .resource-filter-bar {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .resource-filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .resource-type-filter {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .resource-type-filter:hover {
            border-color: #9ca3af;
        }

        .resource-type-filter.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .resource-status-filter {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .resource-status-filter:hover {
            border-color: #9ca3af;
        }

        .resource-status-filter.active {
            background: #22c55e;
            color: white;
            border-color: #22c55e;
        }

        .resource-conflict-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .conflict-icon {
            color: #ef4444;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .conflict-content {
            flex: 1;
        }

        .conflict-title {
            font-weight: 600;
            font-size: 0.875rem;
            color: #991b1b;
            margin-bottom: 0.25rem;
        }

        .conflict-message {
            font-size: 0.75rem;
            color: #7f1d1d;
            line-height: 1.4;
        }

        .resource-calendar-view {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .resource-calendar-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .resource-timeline {
            padding: 1rem;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: #f9fafb;
        }

        .timeline-resource {
            width: 150px;
            flex-shrink: 0;
            padding-right: 1rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .timeline-slots {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .timeline-day {
            height: 40px;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeline-day.available {
            background: #dcfce7;
            color: #166534;
        }

        .timeline-day.partial {
            background: #fef3c7;
            color: #92400e;
        }

        .timeline-day.busy {
            background: #fecaca;
            color: #991b1b;
        }

        .timeline-day:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* NEW Sprint 4.4: Activity Dependencies & Workflow */
        .workflow-panel {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .workflow-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .workflow-canvas {
            min-height: 400px;
            background: #fafbfc;
            position: relative;
            overflow: auto;
            border-radius: 0 0 0.75rem 0.75rem;
        }

        .workflow-node {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            min-width: 180px;
            max-width: 220px;
            cursor: move;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .workflow-node:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .workflow-node.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .workflow-node.pending {
            border-color: #6b7280;
        }

        .workflow-node.in-progress {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .workflow-node.completed {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .workflow-node.blocked {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .workflow-node-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .workflow-node-title {
            font-weight: 600;
            font-size: 0.875rem;
            line-height: 1.2;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .workflow-node-status {
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            font-weight: 500;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .workflow-node-status.pending {
            background: #f3f4f6;
            color: #374151;
        }

        .workflow-node-status.in-progress {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .workflow-node-status.completed {
            background: #dcfce7;
            color: #166534;
        }

        .workflow-node-status.blocked {
            background: #fee2e2;
            color: #991b1b;
        }

        .workflow-node-details {
            font-size: 0.75rem;
            color: #6b7280;
            line-height: 1.3;
        }

        .workflow-node-dates {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
            font-size: 0.75rem;
        }

        .workflow-node-date {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .workflow-connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .workflow-connection-line {
            stroke: #6b7280;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .workflow-connection-line.critical-path {
            stroke: #ef4444;
            stroke-width: 3;
        }

        .workflow-connection-line.completed {
            stroke: #22c55e;
        }

        .workflow-connection-line.active {
            stroke: #3b82f6;
            stroke-width: 3;
        }

        .workflow-toolbar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .workflow-mode-toggle {
            display: flex;
            gap: 0.25rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .workflow-mode-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 0.25rem;
            background: transparent;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .workflow-mode-btn.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .workflow-action-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .workflow-action-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .workflow-action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .workflow-action-btn.primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .dependency-section {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .dependency-list {
            margin-top: 0.5rem;
        }

        .dependency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .dependency-info {
            flex: 1;
            min-width: 0;
        }

        .dependency-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #111827;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dependency-type {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .dependency-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .dependency-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dependency-action:hover {
            background: #f3f4f6;
        }

        .dependency-action.remove {
            color: #ef4444;
            border-color: #fecaca;
        }

        .dependency-action.remove:hover {
            background: #fef2f2;
        }

        .critical-path-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .workflow-legend {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .legend-indicator {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-indicator.pending {
            background: #6b7280;
        }

        .legend-indicator.in-progress {
            background: #3b82f6;
        }

        .legend-indicator.completed {
            background: #22c55e;
        }

        .legend-indicator.blocked {
            background: #ef4444;
        }

        .legend-indicator.critical {
            background: #ef4444;
            border: 2px solid #dc2626;
        }

        .workflow-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .workflow-stat {
            text-align: center;
        }

        .workflow-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .workflow-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .workflow-minimap {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 200px;
            height: 120px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            overflow: hidden;
        }

        /* NEW Sprint 4.5: Analytics & Reporting */
        .analytics-dashboard {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .analytics-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .analytics-card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .analytics-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .analytics-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .analytics-period-selector {
            display: flex;
            gap: 0.25rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 0.25rem;
        }

        .analytics-period-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 0.25rem;
            background: transparent;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analytics-period-btn.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .analytics-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analytics-metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .analytics-metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .analytics-metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .analytics-metric-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .analytics-metric-change.positive {
            color: #10b981;
        }

        .analytics-metric-change.negative {
            color: #ef4444;
        }

        .analytics-metric-change.neutral {
            color: #6b7280;
        }

        .analytics-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        .analytics-chart {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: end;
            gap: 0.5rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #fafbfc;
        }

        .analytics-chart-bar {
            background: #3b82f6;
            border-radius: 0.25rem 0.25rem 0 0;
            transition: all 0.3s ease;
            position: relative;
            min-width: 40px;
            cursor: pointer;
        }

        .analytics-chart-bar:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .analytics-chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }

        .analytics-chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 500;
            color: #111827;
            white-space: nowrap;
        }

        .analytics-donut-chart {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .analytics-donut-svg {
            transform: rotate(-90deg);
        }

        .analytics-donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .analytics-donut-center-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }

        .analytics-donut-center-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .analytics-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .analytics-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .analytics-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .analytics-table th,
        .analytics-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .analytics-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .analytics-table td {
            font-size: 0.875rem;
            color: #111827;
        }

        .analytics-table tr:hover {
            background: #f9fafb;
        }

        .analytics-progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .analytics-progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }

        .analytics-heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin: 1rem 0;
        }

        .analytics-heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background: #f3f4f6;
            position: relative;
            cursor: pointer;
        }

        .analytics-heatmap-cell.low {
            background: #dcfce7;
        }

        .analytics-heatmap-cell.medium {
            background: #86efac;
        }

        .analytics-heatmap-cell.high {
            background: #22c55e;
        }

        .analytics-heatmap-cell.very-high {
            background: #16a34a;
        }

        .analytics-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .analytics-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .analytics-filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .analytics-filter-select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            min-width: 150px;
        }

        .analytics-export-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .analytics-export-btn:hover {
            background: #059669;
        }

        .analytics-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .analytics-summary-subtitle {
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .analytics-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .analytics-summary-stat {
            text-align: center;
        }

        .analytics-summary-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .analytics-summary-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ========================================
           LOADING STATES & PROGRESS INDICATORS
           ======================================== */
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--neutral-200);
            border-top: 4px solid var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: 0.5rem;
        }
        
        .loading-message {
            color: var(--neutral-600);
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }
        
        /* Progress Bar */
        .loading-progress {
            margin-bottom: 1rem;
        }
        
        .progress-track {
            width: 100%;
            height: 6px;
            background: var(--neutral-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            font-size: 0.75rem;
            color: var(--neutral-500);
            text-align: center;
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--neutral-200) 25%,
                var(--neutral-100) 50%,
                var(--neutral-200) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .skeleton-row {
            height: 48px;
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .skeleton-cell {
            padding: var(--space-3);
        }
        
        .skeleton-text {
            height: 1rem;
            border-radius: var(--radius-sm);
        }
        
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }
        
        /* Skeleton Cards for Mobile */
        .skeleton-card {
            padding: var(--space-4);
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            background: white;
        }
        
        .skeleton-card-header {
            height: 1.5rem;
            width: 40%;
            margin-bottom: var(--space-3);
        }
        
        .skeleton-card-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .skeleton-card-line {
            height: 1rem;
            border-radius: var(--radius-sm);
        }
        
        /* Loading Button States */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .btn-loading .btn-text {
            opacity: 0;
        }
        
        /* Inline Loading Indicators */
        .loading-inline {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
        
        .loading-inline .loading-dot {
            width: 4px;
            height: 4px;
            background: var(--primary-500);
            border-radius: 50%;
            animation: loading-dots 1.4s infinite;
        }
        
        .loading-inline .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-inline .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes loading-dots {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Enhanced Toast System */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
            max-width: 400px;
        }
        
        .toast {
            pointer-events: auto;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border-left: 4px solid var(--primary-500);
            padding: var(--space-4);
            animation: toast-slide-in 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .toast.success { border-left-color: var(--success-500); }
        .toast.warning { border-left-color: var(--warning-500); }
        .toast.error { border-left-color: var(--error-500); }
        
        @keyframes toast-slide-in {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes toast-slide-out {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .toast-header {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        
        .toast-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            font-size: 1rem;
        }
        
        .toast-content {
            flex: 1;
            min-width: 0;
        }
        
        .toast-title {
            font-weight: 600;
            color: var(--neutral-900);
            margin-bottom: var(--space-1);
            font-size: 0.875rem;
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: var(--neutral-600);
            line-height: 1.4;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--neutral-400);
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        
        .toast-close:hover {
            background: var(--neutral-100);
            color: var(--neutral-600);
        }
        
        .toast-actions {
            margin-top: var(--space-3);
            display: flex;
            gap: var(--space-2);
        }
        
        .toast-action {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--neutral-300);
            background: white;
            color: var(--neutral-700);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .toast-action:hover {
            background: var(--neutral-50);
        }
        
        .toast-action.primary {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }
        
        .toast-action.primary:hover {
            background: var(--primary-600);
        }
        
        /* ========================================
           PROGRESSIVE FORM WIZARD SYSTEM  
           ======================================== */
        
        /* Form Wizard Container */
        .form-wizard {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        /* Progress Indicator */
        .wizard-progress {
            background: var(--neutral-50);
            padding: var(--space-6) var(--space-8);
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .wizard-progress h2 {
            margin: 0 0 var(--space-4) 0;
            color: var(--neutral-900);
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
        }
        
        .progress-bar-container {
            margin-bottom: var(--space-6);
        }
        
        .progress-bar-track {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
            border-radius: 4px;
            transition: width 0.4s ease;
            position: relative;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progress-shimmer 2s infinite;
        }
        
        @keyframes progress-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Step Indicators */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
        }
        
        .wizard-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex: 1;
            position: relative;
        }
        
        .wizard-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: calc(100% - var(--space-4));
            right: calc(-100% + var(--space-4));
            height: 2px;
            background: var(--neutral-300);
            z-index: 1;
        }
        
        .wizard-step.completed::after {
            background: var(--primary-500);
        }
        
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--neutral-300);
            color: var(--neutral-600);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .wizard-step.active .step-indicator {
            background: var(--primary-500);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 4px var(--primary-100);
        }
        
        .wizard-step.completed .step-indicator {
            background: var(--success-500);
            color: white;
        }
        
        .wizard-step.completed .step-indicator::after {
            content: 'âœ“';
            position: absolute;
        }
        
        .step-label {
            font-weight: var(--font-medium);
            color: var(--neutral-700);
            font-size: var(--text-sm);
        }
        
        .wizard-step.active .step-label {
            color: var(--primary-700);
            font-weight: var(--font-semibold);
        }
        
        .wizard-step.completed .step-label {
            color: var(--success-700);
        }
        
        /* Step Content */
        .wizard-content {
            padding: var(--space-8);
        }
        
        .step-panel {
            display: none;
        }
        
        .step-panel.active {
            display: block;
            animation: step-fade-in 0.3s ease-out;
        }
        
        @keyframes step-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-header {
            margin-bottom: var(--space-6);
        }
        
        .step-title {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--neutral-900);
            margin: 0 0 var(--space-2) 0;
        }
        
        .step-description {
            color: var(--neutral-600);
            font-size: var(--text-base);
            margin: 0;
            line-height: var(--leading-relaxed);
        }
        
        /* Enhanced Form Fields */
        .wizard-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-8);
        }
        
        .wizard-field-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .wizard-field-label {
            font-weight: var(--font-medium);
            color: var(--neutral-700);
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .field-required {
            color: var(--error-500);
            font-weight: var(--font-semibold);
        }
        
        .wizard-field-input {
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            transition: all 0.2s ease;
            background: white;
        }
        
        .wizard-field-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }
        
        .wizard-field-input.error {
            border-color: var(--error-500);
            box-shadow: 0 0 0 3px var(--error-100);
        }
        
        .wizard-field-input.success {
            border-color: var(--success-500);
            box-shadow: 0 0 0 3px var(--success-100);
        }
        
        .field-help {
            font-size: var(--text-xs);
            color: var(--neutral-500);
            margin-top: var(--space-1);
        }
        
        .field-error {
            font-size: var(--text-xs);
            color: var(--error-600);
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .field-success {
            font-size: var(--text-xs);
            color: var(--success-600);
            margin-top: var(--space-1);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        /* Wizard Actions */
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--space-6);
            border-top: 1px solid var(--neutral-200);
            margin-top: var(--space-8);
        }
        
        .wizard-actions-left {
            display: flex;
            gap: var(--space-3);
        }
        
        .wizard-actions-right {
            display: flex;
            gap: var(--space-3);
        }
        
        .wizard-btn {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-lg);
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .wizard-btn-primary {
            background: var(--primary-500);
            color: white;
        }
        
        .wizard-btn-primary:hover:not(:disabled) {
            background: var(--primary-600);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .wizard-btn-primary:disabled {
            background: var(--neutral-300);
            color: var(--neutral-500);
            cursor: not-allowed;
        }
        
        .wizard-btn-secondary {
            background: white;
            color: var(--neutral-700);
            border-color: var(--neutral-300);
        }
        
        .wizard-btn-secondary:hover {
            background: var(--neutral-50);
            border-color: var(--neutral-400);
        }
        
        .wizard-btn-ghost {
            background: transparent;
            color: var(--neutral-600);
        }
        
        .wizard-btn-ghost:hover {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        /* Save Draft Indicator */
        .draft-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--warning-600);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }
        
        .draft-indicator.saved {
            color: var(--success-600);
        }
        
        /* Mobile Wizard Adjustments */
        @media (max-width: 767px) {
            .wizard-content {
                padding: var(--space-6) var(--space-4);
            }
            
            .wizard-progress {
                padding: var(--space-4);
            }
            
            .wizard-form-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }
            
            .wizard-steps {
                display: none;
            }
            
            .wizard-actions {
                flex-direction: column;
                gap: var(--space-3);
            }
            
            .wizard-actions-left,
            .wizard-actions-right {
                width: 100%;
                justify-content: center;
            }
            
            .wizard-btn {
                width: 100%;
            }
        }
        
        /* ========================================
           GLOBAL SEARCH SYSTEM
           ======================================== */
        
        /* Search Container */
        .global-search-container {
            position: relative;
            margin-right: var(--space-4);
        }
        
        .global-search {
            position: relative;
            width: 320px;
        }
        
        /* Search Input */
        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-xl);
            transition: all 0.2s ease;
        }
        
        .search-input-wrapper:focus-within {
            background: white;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px var(--primary-100);
        }
        
        .global-search-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            color: white;
            font-size: var(--text-sm);
            outline: none;
        }
        
        .global-search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-input-wrapper:focus-within .global-search-input {
            color: var(--neutral-700);
        }
        
        .search-input-wrapper:focus-within .global-search-input::placeholder {
            color: var(--neutral-500);
        }
        
        .search-btn {
            padding: var(--space-2);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }
        
        .search-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .search-input-wrapper:focus-within .search-btn {
            color: var(--neutral-600);
        }
        
        .search-input-wrapper:focus-within .search-btn:hover {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        .search-clear {
            padding: var(--space-1);
            background: none;
            border: none;
            color: var(--neutral-500);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            margin-right: var(--space-2);
        }
        
        .search-clear:hover {
            background: var(--neutral-200);
            color: var(--neutral-700);
        }
        
        /* Search Results Container */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--neutral-200);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            max-height: 500px;
            overflow-y: auto;
            margin-top: var(--space-2);
        }
        
        .search-content {
            padding: var(--space-4);
        }
        
        /* Search Sections */
        .search-section {
            margin-bottom: var(--space-6);
        }
        
        .search-section:last-child {
            margin-bottom: 0;
        }
        
        .search-section-title {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--neutral-700);
            margin: 0 0 var(--space-3) 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Recent Searches */
        .recent-searches {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .recent-search-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--neutral-600);
            font-size: var(--text-sm);
        }
        
        .recent-search-item:hover {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        .recent-search-icon {
            color: var(--neutral-500);
            font-size: 0.875rem;
        }
        
        /* Search Tips */
        .search-tips {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .search-tips li {
            padding: var(--space-2) 0;
            font-size: var(--text-sm);
            color: var(--neutral-600);
            line-height: var(--leading-relaxed);
        }
        
        /* Search Results */
        .search-category {
            margin-bottom: var(--space-6);
        }
        
        .search-category:last-child {
            margin-bottom: 0;
        }
        
        .search-category-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--neutral-700);
            margin: 0 0 var(--space-3) 0;
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--neutral-200);
        }
        
        .search-category-count {
            background: var(--neutral-200);
            color: var(--neutral-600);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }
        
        .search-items {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .search-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .search-item:hover {
            background: var(--primary-50);
            border-color: var(--primary-200);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .search-item-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background: var(--neutral-100);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .search-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .search-item-title {
            font-weight: var(--font-semibold);
            color: var(--neutral-900);
            margin: 0 0 var(--space-1) 0;
            font-size: var(--text-sm);
        }
        
        .search-item-subtitle {
            color: var(--neutral-600);
            font-size: var(--text-xs);
            margin: 0 0 var(--space-1) 0;
        }
        
        .search-item-description {
            color: var(--neutral-500);
            font-size: var(--text-xs);
            line-height: var(--leading-relaxed);
            margin: 0;
        }
        
        .search-item-meta {
            flex-shrink: 0;
            text-align: right;
            color: var(--neutral-500);
            font-size: var(--text-xs);
        }
        
        /* Highlighted Search Terms */
        .search-highlight {
            background: var(--warning-200);
            color: var(--warning-800);
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: var(--font-medium);
        }
        
        /* Empty Search State */
        .search-empty {
            text-align: center;
            padding: var(--space-8) var(--space-4);
        }
        
        .empty-icon {
            font-size: 2rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
        
        .search-empty h4 {
            margin: 0 0 var(--space-2) 0;
            color: var(--neutral-700);
            font-size: var(--text-lg);
        }
        
        .search-empty p {
            margin: 0 0 var(--space-4) 0;
            color: var(--neutral-500);
        }
        
        .search-suggestions {
            text-align: left;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .search-suggestions p {
            margin-bottom: var(--space-2);
            font-weight: var(--font-semibold);
        }
        
        .search-suggestions ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .search-suggestions li {
            padding: var(--space-1) 0;
            font-size: var(--text-sm);
            color: var(--neutral-600);
        }
        
        /* Loading State */
        .search-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-6);
            color: var(--neutral-500);
            font-size: var(--text-sm);
        }
        
        .search-loading-dots {
            display: flex;
            gap: var(--space-1);
        }
        
        .search-loading-dot {
            width: 4px;
            height: 4px;
            background: var(--primary-500);
            border-radius: 50%;
            animation: loading-dots 1.4s infinite;
        }
        
        .search-loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .search-loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Mobile Search Adjustments */
        @media (max-width: 767px) {
            .global-search-container {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: var(--primary-600);
                z-index: 3000;
                padding: var(--space-4);
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                display: none;
            }
            
            .global-search-container.active {
                display: block;
                transform: translateY(0);
            }
            
            .global-search {
                width: 100%;
            }
            
            .search-results {
                position: fixed;
                top: 80px;
                left: var(--space-4);
                right: var(--space-4);
                max-height: calc(100vh - 120px);
            }
        }
        
        /* Desktop Search Positioning */
        @media (min-width: 768px) {
            .global-search-container {
                margin-right: var(--space-6);
            }
        }
    </style>
</head>
<body>

    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Enhanced Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-message">
        <div class="loading-container">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h2 id="loading-title" class="loading-title">Loading...</h2>
            <p id="loading-message" class="loading-message">Please wait while we prepare your data</p>
            <div class="loading-progress">
                <div class="progress-track">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-text" class="progress-text">0%</div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Toast Container -->
    <div id="toast-container" class="toast-container" aria-live="polite" aria-label="Notifications">
        <!-- Toasts will be dynamically added here -->
    </div>
    
    <header role="banner">
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="nav-left">
                <h1>
                    <button 
                        onclick="app.showPage('dashboard')" 
                        aria-label="Go to dashboard - CRM Demo homepage"
                        class="logo-btn">
                        ðŸ¢ CRM Demo
                    </button>
                </h1>
                
                <!-- Mobile hamburger menu toggle -->
                <button 
                    id="mobile-menu-toggle" 
                    class="mobile-menu-toggle" 
                    aria-expanded="false"
                    aria-controls="main-navigation"
                    aria-label="Toggle main navigation menu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <ul id="main-navigation" class="nav-menu" role="menubar" aria-label="Main menu">
                    <!-- Dashboard - always visible -->
                    <li role="none">
                        <button 
                            onclick="app.showPage('dashboard')" 
                            class="nav-btn active"
                            role="menuitem"
                            aria-pressed="true"
                            aria-describedby="dashboard-desc">
                            <span class="nav-icon">ðŸ </span>
                            Dashboard
                        </button>
                    </li>
                    
                    <!-- Projects Dropdown -->
                    <li class="nav-dropdown" role="none">
                        <button 
                            class="nav-btn dropdown-toggle"
                            role="menuitem"
                            aria-expanded="false"
                            aria-haspopup="true"
                            aria-controls="projects-menu"
                            onclick="toggleDropdown('projects-menu')">
                            <span class="nav-icon">ðŸ“</span>
                            Projects
                            <span class="dropdown-arrow" aria-hidden="true">â–¼</span>
                        </button>
                        <ul id="projects-menu" class="dropdown-menu" role="menu" aria-label="Projects menu" hidden>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('pcnumbers')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="pc-numbers-desc">
                                    <span class="item-icon">ðŸ“‹</span>
                                    PC Numbers
                                    <span class="item-description">Manage project codes</span>
                                </button>
                            </li>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('activities')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="activities-desc">
                                    <span class="item-icon">ðŸ“…</span>
                                    Activities
                                    <span class="item-description">Schedule and track tasks</span>
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Sales Dropdown -->
                    <li class="nav-dropdown" role="none">
                        <button 
                            class="nav-btn dropdown-toggle"
                            role="menuitem"
                            aria-expanded="false"
                            aria-haspopup="true"
                            aria-controls="sales-menu"
                            onclick="toggleDropdown('sales-menu')">
                            <span class="nav-icon">ðŸ’°</span>
                            Sales
                            <span class="dropdown-arrow" aria-hidden="true">â–¼</span>
                        </button>
                        <ul id="sales-menu" class="dropdown-menu" role="menu" aria-label="Sales menu" hidden>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('quotes')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="quotes-desc">
                                    <span class="item-icon">ðŸ“</span>
                                    Quotes
                                    <span class="item-description">Create and manage quotes</span>
                                </button>
                            </li>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('pricelists')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="pricelists-desc">
                                    <span class="item-icon">ðŸ’·</span>
                                    Price Lists
                                    <span class="item-description">Manage pricing and rates</span>
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Resources Dropdown -->
                    <li class="nav-dropdown" role="none">
                        <button 
                            class="nav-btn dropdown-toggle"
                            role="menuitem"
                            aria-expanded="false"
                            aria-haspopup="true"
                            aria-controls="resources-menu"
                            onclick="toggleDropdown('resources-menu')">
                            <span class="nav-icon">ðŸ”§</span>
                            Resources
                            <span class="dropdown-arrow" aria-hidden="true">â–¼</span>
                        </button>
                        <ul id="resources-menu" class="dropdown-menu" role="menu" aria-label="Resources menu" hidden>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('resources')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="resources-desc">
                                    <span class="item-icon">ðŸ› ï¸</span>
                                    Manage Resources
                                    <span class="item-description">Equipment, materials, labor</span>
                                </button>
                            </li>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('resource-allocation')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="resource-allocation-desc">
                                    <span class="item-icon">ðŸ“Š</span>
                                    Resource Allocation
                                    <span class="item-description">Track allocation and availability</span>
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Templates Dropdown -->
                    <li class="nav-dropdown" role="none">
                        <button 
                            class="nav-btn dropdown-toggle"
                            role="menuitem"
                            aria-expanded="false"
                            aria-haspopup="true"
                            aria-controls="templates-menu"
                            onclick="toggleDropdown('templates-menu')">
                            <span class="nav-icon">ðŸ“„</span>
                            Templates
                            <span class="dropdown-arrow" aria-hidden="true">â–¼</span>
                        </button>
                        <ul id="templates-menu" class="dropdown-menu" role="menu" aria-label="Templates menu" hidden>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('templates')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="templates-desc">
                                    <span class="item-icon">ðŸ“‹</span>
                                    Quote Templates
                                    <span class="item-description">Reusable quote templates</span>
                                </button>
                            </li>
                            <li role="none">
                                <button 
                                    onclick="app.showPage('activity-templates')" 
                                    class="dropdown-item"
                                    role="menuitem"
                                    aria-describedby="activity-templates-desc">
                                    <span class="item-icon">ðŸ“…</span>
                                    Activity Templates
                                    <span class="item-description">Reusable activity templates</span>
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Analytics - standalone -->
                    <li role="none">
                        <button 
                            onclick="app.showPage('analytics')" 
                            class="nav-btn"
                            role="menuitem"
                            aria-describedby="analytics-desc">
                            <span class="nav-icon">ðŸ“ˆ</span>
                            Analytics
                        </button>
                    </li>
                </ul>
            </div>
                            <div class="nav-right">
                    <!-- Global Search -->
                    <div class="global-search-container">
                        <div class="global-search" id="global-search">
                            <div class="search-input-wrapper">
                                <input 
                                    type="search" 
                                    id="global-search-input"
                                    class="global-search-input"
                                    placeholder="Search PC Numbers, Quotes, Activities..."
                                    aria-expanded="false"
                                    aria-controls="search-results"
                                    aria-label="Search across all CRM data"
                                    autocomplete="off"
                                    spellcheck="false">
                                <button class="search-btn" aria-label="Search" onclick="performGlobalSearch()">
                                    <span class="search-icon" aria-hidden="true">ðŸ”</span>
                                </button>
                                <button class="search-clear" id="search-clear" aria-label="Clear search" onclick="clearGlobalSearch()" hidden>
                                    <span aria-hidden="true">âœ•</span>
                                </button>
                            </div>
                            
                            <div id="search-results" class="search-results" hidden role="listbox" aria-label="Search results">
                                <div class="search-content">
                                    <!-- Recent Searches (shown when empty) -->
                                    <div class="search-section" id="recent-section">
                                        <h4 class="search-section-title">Recent Searches</h4>
                                        <ul class="recent-searches" id="recent-searches-list">
                                            <!-- Populated dynamically -->
                                        </ul>
                                    </div>
                                    
                                    <!-- Quick Tips (shown when empty) -->
                                    <div class="search-section" id="tips-section">
                                        <h4 class="search-section-title">Search Tips</h4>
                                        <ul class="search-tips">
                                            <li>ðŸ’¼ <strong>PC Numbers:</strong> "PC-000123" or company name</li>
                                            <li>ðŸ’° <strong>Quotes:</strong> Search by amount, client, or status</li>
                                            <li>ðŸ“… <strong>Activities:</strong> Search by type, date, or description</li>
                                            <li>ðŸ› ï¸ <strong>Resources:</strong> Search by name, type, or category</li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Search Results (shown during search) -->
                                    <div class="search-results-container" id="search-results-container" hidden>
                                        <!-- Results grouped by category -->
                                    </div>
                                    
                                    <!-- No Results -->
                                    <div class="search-empty" id="search-empty" hidden>
                                        <div class="empty-icon">ðŸ”</div>
                                        <h4>No results found</h4>
                                        <p id="empty-message">Try different keywords or check your spelling</p>
                                        <div class="search-suggestions">
                                            <p><strong>Suggestions:</strong></p>
                                            <ul>
                                                <li>Use fewer words</li>
                                                <li>Try broader terms</li>
                                                <li>Check spelling</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW Sprint 4.2.5: Notification Bell -->
                    <div style="position: relative; margin-right: 1rem;">
                        <button 
                            id="notification-bell" 
                            class="notification-bell" 
                            onclick="window.toggleNotificationCenter()"
                            aria-label="Notifications"
                            aria-describedby="notification-count">
                            ðŸ””
                            <div id="notification-badge" class="notification-badge" style="display: none;" aria-live="polite">0</div>
                        </button>
                    </div>
                    <button 
                        onclick="window.resetData()" 
                        class="nav-btn danger"
                        aria-label="Reset all demo data - this will delete all current data">
                        Reset Demo Data
                    </button>
                </div>
        </nav>
    </header>
    
    <!-- Screen reader descriptions for navigation items -->
    <div class="sr-only">
        <div id="dashboard-desc">Overview of key metrics and recent activity</div>
        <div id="pc-numbers-desc">Manage project codes and client information</div>
        <div id="quotes-desc">Create and manage quotes for projects</div>
        <div id="templates-desc">Reusable quote templates</div>
        <div id="activities-desc">Schedule and track project activities</div>
        <div id="activity-templates-desc">Reusable activity templates</div>
        <div id="resources-desc">Manage equipment, materials and labor resources</div>
        <div id="resource-allocation-desc">Track resource allocation and availability</div>
        <div id="analytics-desc">View reports and analytics dashboard</div>
        <div id="pricelists-desc">Manage pricing and rate cards</div>
    </div>

    <!-- NEW Sprint 4.2.5: Notification Center -->
    <div id="notification-center" class="notification-center">
        <div class="notification-header">
            <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">ðŸ”” Notifications</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button onclick="window.markAllNotificationsRead()" 
                        style="background: none; border: none; color: #6b7280; font-size: 0.75rem; cursor: pointer;">
                    Mark all read
                </button>
                <button onclick="window.toggleNotificationCenter()" 
                        style="background: none; border: none; font-size: 1.25rem; cursor: pointer; color: #6b7280;">
                    Ã—
                </button>
            </div>
        </div>
        <div id="notification-list" class="notification-list">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <main id="main-content" role="main" tabindex="-1">
        <div class="container">
            <div id="dashboard" class="page active">
            <h1>ðŸ“Š Dashboard</h1>
            <p>Overview of key metrics in the demonstration system.</p>
            
            <!-- NEW Sprint 4.2.5: Dashboard Alerts -->
            <div id="dashboard-alerts">
                <!-- Dynamic alerts will be populated here -->
            </div>
            
            <!-- NEW Sprint 4.2.5: Upcoming Activities Widget -->
            <div id="upcoming-activities-widget" class="upcoming-activities" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">ðŸ“… Upcoming Activities</h3>
                    <button onclick="app.showPage('activities')" 
                            style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                        View All
                    </button>
                </div>
                <div id="upcoming-activities-list">
                    <!-- Upcoming activities will be populated here -->
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card clickable" onclick="app.showPage('pcnumbers')">
                    <h3>PC Numbers</h3>
                    <div class="value" id="stat-pc">0</div>
                </div>
                <div class="stat-card clickable" onclick="app.showPage('quotes')">
                    <h3>Quotes</h3>
                    <div class="value" id="stat-quotes">0</div>
                </div>
                <div class="stat-card clickable" onclick="app.showPage('activities')">
                    <h3>Activities</h3>
                    <div class="value" id="stat-activities">0</div>
                </div>
                <div class="stat-card">
                    <h3>Quote Value</h3>
                    <div class="value" id="stat-value">Â£0</div>
                </div>
            </div>

             <div class="card">
                <h2>Recent PC Numbers</h2>
                <table>
                    <thead>
                        <tr><th>PC Number</th><th>Company</th><th>Reference</th></tr>
                    </thead>
                    <tbody id="recent-pc"></tbody>
                </table>
            </div>
        </div>

        <div id="pcnumbers" class="page">
            <h1>ðŸ”¢ PC Numbers</h1>
            <button onclick="app.showPage('new-pc')">+ New PC Number</button>
            <div class="card">
                <h2>PC Numbers List</h2>
                <table>
                    <thead><tr><th>PC Number</th><th>Company</th><th>Reference</th><th>Contact</th><th>Actions</th></tr></thead>
                    <tbody id="pc-list"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pc" class="page">
            <h1 id="pc-form-title">New PC Number</h1>
            
            <!-- Progressive Form Wizard -->
            <div class="form-wizard" id="pc-wizard">
                <input type="hidden" id="pc-id">
                
                <!-- Progress Header -->
                <div class="wizard-progress">
                    <h2>Create PC Number</h2>
                    <div class="progress-bar-container">
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" id="wizard-progress-bar" style="width: 33%"></div>
                        </div>
                    </div>
                    <ol class="wizard-steps">
                        <li class="wizard-step active" id="step-1-indicator">
                            <div class="step-indicator">1</div>
                            <span class="step-label">Basic Info</span>
                        </li>
                        <li class="wizard-step" id="step-2-indicator">
                            <div class="step-indicator">2</div>
                            <span class="step-label">Client Details</span>
                        </li>
                        <li class="wizard-step" id="step-3-indicator">
                            <div class="step-indicator">3</div>
                            <span class="step-label">Contact Info</span>
                        </li>
                    </ol>
                </div>
                
                <!-- Wizard Content -->
                <div class="wizard-content">
                    <!-- Step 1: Basic Information -->
                    <div class="step-panel active" id="step-1" data-step="1">
                        <div class="step-header">
                            <h3 class="step-title">Let's start with basic project information</h3>
                            <p class="step-description">
                                This information helps us organize and track your project effectively.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-number">
                                    PC Number 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-number" 
                                    class="wizard-field-input"
                                    placeholder="PC-000001"
                                    pattern="^PC-\d{6}$"
                                    required
                                    data-validate="pc-number">
                                <div class="field-help">Format: PC- followed by 6 digits (e.g., PC-000001)</div>
                                <div class="field-error" id="pc-number-error" hidden></div>
                                <div class="field-success" id="pc-number-success" hidden>âœ“ Valid PC Number format</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-company-name">
                                    Company Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-company-name" 
                                    class="wizard-field-input"
                                    placeholder="Enter company name"
                                    required
                                    data-validate="required">
                                <div class="field-help">The official company name for this project</div>
                                <div class="field-error" id="pc-company-name-error" hidden></div>
                                <div class="field-success" id="pc-company-name-success" hidden>âœ“ Company name entered</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-project-name">
                                    Project Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-project-name" 
                                    class="wizard-field-input"
                                    placeholder="Enter project name"
                                    required
                                    data-validate="required">
                                <div class="field-help">A descriptive name for the project</div>
                                <div class="field-error" id="pc-project-name-error" hidden></div>
                                <div class="field-success" id="pc-project-name-success" hidden>âœ“ Project name entered</div>
                            </div>
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    ðŸ’¾ Save Draft
                                </button>
                                <div class="draft-indicator" id="draft-status" hidden>
                                    â³ Saving draft...
                                </div>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="cancelWizard()">
                                    Cancel
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-1-next" onclick="nextWizardStep()" disabled>
                                    Next: Client Details â†’
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Client Details -->
                    <div class="step-panel" id="step-2" data-step="2">
                        <div class="step-header">
                            <h3 class="step-title">Tell us about your client</h3>
                            <p class="step-description">
                                Client information helps us provide better service and track project sources.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-account-manager">
                                    Account Manager 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-account-manager" 
                                    class="wizard-field-input"
                                    placeholder="Account manager name"
                                    required
                                    data-validate="required">
                                <div class="field-help">Person responsible for this account</div>
                                <div class="field-error" id="pc-account-manager-error" hidden></div>
                                <div class="field-success" id="pc-account-manager-success" hidden>âœ“ Account manager assigned</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-client-industry">
                                    Client Industry 
                                    <span class="field-required">*</span>
                                </label>
                                <select 
                                    id="pc-client-industry" 
                                    class="wizard-field-input"
                                    required
                                    data-validate="required">
                                    <option value="">Select industry...</option>
                                    <option value="Media">Media</option>
                                    <option value="Education">Education</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Government">Government</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="field-help">Primary industry sector of the client</div>
                                <div class="field-error" id="pc-client-industry-error" hidden></div>
                                <div class="field-success" id="pc-client-industry-success" hidden>âœ“ Industry selected</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-client-source">
                                    Client Source 
                                    <span class="field-required">*</span>
                                </label>
                                <select 
                                    id="pc-client-source" 
                                    class="wizard-field-input"
                                    required
                                    data-validate="required">
                                    <option value="">Select source...</option>
                                    <option value="Web Enquiry">Web Enquiry</option>
                                    <option value="Business Development">Business Development</option>
                                    <option value="Existing Customer">Existing Customer</option>
                                    <option value="Cross Referral">Cross Referral</option>
                                    <option value="Internal (CWS/Crown)">Internal (CWS/Crown)</option>
                                </select>
                                <div class="field-help">How did this client find us?</div>
                                <div class="field-error" id="pc-client-source-error" hidden></div>
                                <div class="field-success" id="pc-client-source-success" hidden>âœ“ Source recorded</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-quote-limit">
                                    Quote Limit
                                </label>
                                <input 
                                    type="number" 
                                    id="pc-quote-limit" 
                                    class="wizard-field-input"
                                    min="1" 
                                    max="20" 
                                    value="5"
                                    placeholder="5"
                                    data-validate="number">
                                <div class="field-help">Maximum number of quotes for this project (1-20)</div>
                                <div class="field-error" id="pc-quote-limit-error" hidden></div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-status">
                                    Project Status
                                </label>
                                <select id="pc-status" class="wizard-field-input">
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <div class="field-help">Current status of the project</div>
                            </div>
                        </div>
                        
                        <div class="wizard-field-group">
                            <label class="wizard-field-label" for="pc-project-description">
                                Project Description
                            </label>
                            <textarea 
                                id="pc-project-description" 
                                class="wizard-field-input"
                                rows="4" 
                                placeholder="Detailed project description..."
                                style="resize: vertical; min-height: 120px;"></textarea>
                            <div class="field-help">Detailed description of the project requirements and scope</div>
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    ðŸ’¾ Save Draft
                                </button>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">
                                    â† Back
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-2-next" onclick="nextWizardStep()" disabled>
                                    Next: Contact Info â†’
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Contact Information -->
                    <div class="step-panel" id="step-3" data-step="3">
                        <div class="step-header">
                            <h3 class="step-title">Primary contact information</h3>
                            <p class="step-description">
                                We need at least a contact name and either phone or email to reach your client.
                            </p>
                        </div>
                        
                        <div class="wizard-form-grid">
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-name">
                                    Contact Name 
                                    <span class="field-required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-contact-name" 
                                    class="wizard-field-input"
                                    placeholder="Primary contact person"
                                    required
                                    data-validate="required">
                                <div class="field-help">Name of the main contact person for this project</div>
                                <div class="field-error" id="pc-contact-name-error" hidden></div>
                                <div class="field-success" id="pc-contact-name-success" hidden>âœ“ Contact name entered</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-phone">
                                    Phone Number
                                </label>
                                <input 
                                    type="tel" 
                                    id="pc-contact-phone" 
                                    class="wizard-field-input"
                                    placeholder="Phone number"
                                    data-validate="phone">
                                <div class="field-help">Contact phone number (mobile or landline)</div>
                                <div class="field-error" id="pc-contact-phone-error" hidden></div>
                                <div class="field-success" id="pc-contact-phone-success" hidden>âœ“ Valid phone number</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-contact-email">
                                    Email Address
                                </label>
                                <input 
                                    type="email" 
                                    id="pc-contact-email" 
                                    class="wizard-field-input"
                                    placeholder="email@address.com"
                                    data-validate="email">
                                <div class="field-help">Contact email address</div>
                                <div class="field-error" id="pc-contact-email-error" hidden></div>
                                <div class="field-success" id="pc-contact-email-success" hidden>âœ“ Valid email address</div>
                            </div>
                            
                            <div class="wizard-field-group">
                                <label class="wizard-field-label" for="pc-postcode">
                                    Postcode
                                </label>
                                <input 
                                    type="text" 
                                    id="pc-postcode" 
                                    class="wizard-field-input"
                                    placeholder="e.g. SW1A 1AA"
                                    data-validate="postcode">
                                <div class="field-help">UK postcode (optional)</div>
                                <div class="field-error" id="pc-postcode-error" hidden></div>
                                <div class="field-success" id="pc-postcode-success" hidden>âœ“ Valid postcode</div>
                            </div>
                        </div>
                        
                        <div class="field-note" style="margin-top: var(--space-4); padding: var(--space-3); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-md);">
                            ðŸ“ž <strong>Contact Requirement:</strong> Please provide at least phone OR email for the contact person.
                        </div>
                        
                        <div class="wizard-actions">
                            <div class="wizard-actions-left">
                                <button type="button" class="wizard-btn wizard-btn-ghost" onclick="saveDraft()">
                                    ðŸ’¾ Save Draft
                                </button>
                            </div>
                            <div class="wizard-actions-right">
                                <button type="button" class="wizard-btn wizard-btn-secondary" onclick="prevWizardStep()">
                                    â† Back
                                </button>
                                <button type="button" class="wizard-btn wizard-btn-primary" id="step-3-save" onclick="saveWizardPC()" disabled>
                                    âœ“ Create PC Number
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pc-detail" class="page">
            <h1 id="pc-detail-title">PC Details</h1>
            
            <!-- Main Data -->
            <div class="card">
                <h2>Main Project Data</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <div><strong>PC Number:</strong> <span id="pc-detail-number"></span></div>
                    <div><strong>Company Name:</strong> <span id="pc-detail-company-name"></span></div>
                    <div><strong>Project Name:</strong> <span id="pc-detail-project-name"></span></div>
                    <div><strong>Account Manager:</strong> <span id="pc-detail-account-manager"></span></div>
                    <div><strong>Client Industry:</strong> <span id="pc-detail-client-industry"></span></div>
                    <div><strong>Client Source:</strong> <span id="pc-detail-client-source"></span></div>
                    <div><strong>Quote Limit:</strong> <span id="pc-detail-quote-limit"></span></div>
                    <div><strong>Status:</strong> <span id="pc-detail-status"></span></div>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Project Description:</strong><br>
                    <span id="pc-detail-project-description" style="white-space: pre-wrap;"></span>
                </div>
                <div class="form-actions">
                    <button onclick="window.editPC(db.currentPC.id)" class="warning">Edit</button>
                    <button onclick="window.createQuote()">Create Quote</button>
                    <button onclick="window.showActivityModal()">Add Activity</button>
                    <button onclick="app.showPage('pcnumbers')" class="secondary">Back to list</button>
                </div>
            </div>
            
            <!-- Contact Information -->
            <div class="card">
                <h2>Primary Contact</h2>
                <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div><strong>Contact Name:</strong> <span id="pc-detail-contact-name"></span></div>
                    <div><strong>Phone:</strong> <span id="pc-detail-contact-phone"></span></div>
                    <div><strong>Email:</strong> <span id="pc-detail-contact-email"></span></div>
                    <div><strong>Postcode:</strong> <span id="pc-detail-postcode"></span></div>
                </div>
                <p class="field-note">Note: Detailed addresses are now managed in individual quotes.</p>
            </div>
            <div class="card">
                <h2>Related Quotes</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>Title</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-quotes"></tbody>
                </table>
            </div>
            <div class="card">
                <h2>Related Activities</h2>
                <table>
                     <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pc-activities"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quotes" class="page">
            <h1>ðŸ’° Quotes</h1>
            <button onclick="window.showNewQuoteModal()">+ New Quote</button>
            <div class="card">
                <h2>Quote List</h2>
                <table>
                    <thead><tr><th>Quote Number</th><th>PC Number</th><th>Company</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="quotes-list"></tbody>
                </table>
            </div>
        </div>
        
        <div id="quote-builder" class="page">
            <h1 id="quote-builder-title">New Quote</h1>
            <div class="card" id="price-list-selector">
                <h2>Step 1: Select Price List</h2>
                <label>Available Price Lists *</label>
                <select id="quote-price-list" onchange="window.handlePriceListChange()"></select>
            </div>
            <div class="quote-builder" id="quote-items-section" style="display: none;">
                <div class="card">
                    <h2>Step 2: Build Quote</h2>
                    
                    <!-- NEW Sprint 3: Enhanced Resource Lookup -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">ðŸš€ Enhanced Resource Lookup</h4>
                                <p style="margin: 0; color: #666; font-size: 0.875rem;">Search, filter, and add multiple resources quickly</p>
                            </div>
                            <button onclick="window.showEnhancedResourceModal()" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; font-weight: bold;">
                                ðŸ” Search & Add Resources
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW Sprint 3.2: Bulk Operations Panel -->
                    <div id="bulk-operations-panel" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;">ðŸ”§ Bulk Operations</h4>
                                <p style="margin: 0; color: #92400e; font-size: 0.875rem;">
                                    <span id="bulk-selected-count">0</span> line items selected
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="window.bulkUpdateQuantity()" style="background: #3b82f6; color: white;">ðŸ“Š Update Quantities</button>
                                <button onclick="window.bulkApplyDiscount()" style="background: #10b981; color: white;">ðŸ’° Apply Discount</button>
                                <button onclick="window.bulkDeleteItems()" style="background: #ef4444; color: white;">ðŸ—‘ï¸ Delete Selected</button>
                                <button onclick="window.clearBulkSelection()" class="secondary">Clear Selection</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Category Sections -->
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Human Resources</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('human')" id="select-all-human"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-human"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('human')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('human')" style="background: #6366f1; color: white;">ðŸ” Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Vehicles</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('vehicles')" id="select-all-vehicles"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-vehicles"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('vehicles')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('vehicles')" style="background: #6366f1; color: white;">ðŸ” Browse & Add</button>
                        </div>
                    </div>
                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Materials</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('materials')" id="select-all-materials"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-materials"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('materials')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('materials')" style="background: #6366f1; color: white;">ðŸ” Browse & Add</button>
                        </div>
                    </div>
                     <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Other</h3>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="window.toggleCategorySelection('other')" id="select-all-other"> Select All
                                </label>
                            </div>
                        </div>
                        <div id="quote-other"></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="window.addLineItem('other')" class="secondary">+ Quick Add</button>
                            <button onclick="window.showEnhancedResourceModal('other')" style="background: #6366f1; color: white;">ðŸ” Browse & Add</button>
                        </div>
                    </div>
                </div>
                <div class="summary">
                    <h3>Quote Summary</h3>
                    <div class="summary-line"><span>Human Resources:</span><span id="sum-human">Â£0.00</span></div>
                    <div class="summary-line"><span>Vehicles:</span><span id="sum-vehicles">Â£0.00</span></div>
                    <div class="summary-line"><span>Materials:</span><span id="sum-materials">Â£0.00</span></div>
                    <div class="summary-line"><span>Other:</span><span id="sum-other">Â£0.00</span></div>
                    <div class="summary-line"><span>Net Total:</span><span id="sum-subtotal">Â£0.00</span></div>
                    <div class="summary-line">
                        <span>VAT Rate:</span>
                        <input type="number" id="quote-vat-rate" value="20.00" step="0.01" min="0" max="100" 
                               style="width: 60px; margin: 0; padding: 0.25rem;" onchange="window.calculateTotal()">%
                    </div>
                    <div class="summary-line"><span>VAT Amount:</span><span id="sum-vat">Â£0.00</span></div>
                    <div class="summary-total"><span>Total (inc VAT):</span><span id="sum-total">Â£0.00</span></div>
                    
                    <!-- NEW: Move Type & Addresses Section -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <h3 style="margin-bottom: 1rem;">ðŸ“¦ Move Type & Addresses</h3>
                        
                        <!-- Move Type Selection -->
                        <div style="margin-bottom: 1rem;">
                            <label>Move Type *</label>
                            <select id="quote-move-type" onchange="window.toggleAddressSections()" required>
                                <option value="">Select move type...</option>
                                <option value="Collection Only">Collection Only</option>
                                <option value="Delivery Only">Delivery Only</option>
                                <option value="Collection + Delivery">Collection + Delivery</option>
                            </select>
                        </div>
                        
                        <!-- Collection Address Section -->
                        <div id="collection-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">ðŸ“ Collection Address</h4>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-collection-name" placeholder="Contact person"></div>
                                <div><label>Phone</label><input type="tel" id="quote-collection-phone" placeholder="Phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-collection-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-collection-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-collection-address1" placeholder="Street address"></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-collection-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-collection-city" placeholder="City"></div>
                                <div><label>County</label><input type="text" id="quote-collection-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-collection-postcode" placeholder="Postcode"></div>
                            </div>
                        </div>
                        
                        <!-- Delivery Address Section -->
                        <div id="delivery-section" style="display: none; margin-bottom: 1rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem;">ðŸšš Delivery Address</h4>
                            <div style="margin-bottom: 1rem;">
                                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="quote-same-address" onchange="window.copyCollectionToDelivery()" style="margin-right: 0.5rem;">
                                    Same as collection address
                                </label>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                                <div><label>Contact Name *</label><input type="text" id="quote-delivery-name" placeholder="Contact person"></div>
                                <div><label>Phone</label><input type="tel" id="quote-delivery-phone" placeholder="Phone number"></div>
                                <div><label>Email</label><input type="email" id="quote-delivery-email" placeholder="Email"></div>
                                <div><label>Date</label><input type="date" id="quote-delivery-date"></div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-top: 0.75rem;">
                                <div><label>Address Line 1 *</label><input type="text" id="quote-delivery-address1" placeholder="Street address"></div>
                                <div><label>Address Line 2</label><input type="text" id="quote-delivery-address2" placeholder="Additional info"></div>
                                <div><label>City *</label><input type="text" id="quote-delivery-city" placeholder="City"></div>
                                <div><label>County</label><input type="text" id="quote-delivery-county" placeholder="County"></div>
                                <div><label>Postcode *</label><input type="text" id="quote-delivery-postcode" placeholder="Postcode"></div>
                            </div>
                        </div>
                        
                        <!-- Quoted Activities Section -->
                        <div style="margin-bottom: 1rem;">
                            <label>Quoted Activities (optional)</label>
                            <div id="quote-activities-multiselect" style="border: 1px solid #ccc; padding: 0.75rem; border-radius: 0.375rem; max-height: 120px; overflow-y: auto; background: white;">
                                <p style="margin: 0; color: #666; font-style: italic;">Loading activities for this PC...</p>
                            </div>
                            <p class="field-note">Select activities that are included in this quote pricing</p>
                        </div>
                    </div>
                    
                    <!-- Additional Quote Fields -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Status *</label>
                            <select id="quote-status" onchange="window.handleQuoteStatusChange()" required>
                                <option value="DRAFT">DRAFT - Work in progress (editable)</option>
                                <option value="ISSUED">ISSUED - Sent to client (not editable)</option>
                                <option value="WON">WON - Quote accepted by client</option>
                                <option value="LOST">LOST - Quote lost to competitor</option>
                            </select>
                            <p class="field-note">Note: Once ISSUED, quote cannot be edited. WON/LOST are final states.</p>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Valid Until *</label>
                            <input type="date" id="quote-valid-until" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Quote Title *</label>
                            <input type="text" id="quote-title" placeholder="Brief quote description" required>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Description</label>
                            <textarea id="quote-description" rows="2" placeholder="Detailed quote description..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Internal Notes</label>
                            <textarea id="quote-notes" rows="2" placeholder="Internal notes (not visible to client)..."></textarea>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>Terms & Conditions</label>
                            <textarea id="quote-terms" rows="3" placeholder="Payment terms, delivery conditions, etc...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions" style="text-align: center;">
                        <button onclick="window.saveQuote()">Save Quote</button>
                        <button onclick="window.saveQuoteAsTemplate()" style="background: #8b5cf6; color: white;">ðŸ“„ Save as Template</button>
                        <button onclick="window.duplicateCurrentQuote()" style="background: #06b6d4; color: white;">ðŸ“‹ Duplicate Quote</button>
                        <button onclick="window.cancelQuote()" class="secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 3.3: Templates Page -->
        <div id="templates" class="page">
            <h1>ðŸ“„ Quote Templates</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <p style="margin: 0; color: #666;">Manage reusable quote templates to speed up quote creation</p>
                </div>
                <div>
                    <button onclick="window.showCreateTemplateFromScratch()" style="background: #8b5cf6; color: white;">+ Create New Template</button>
                </div>
            </div>
            
            <!-- Templates Filter & Search -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label>Search Templates</label>
                        <input type="text" id="template-search" placeholder="Search by name or description..." 
                               oninput="window.filterTemplates()" style="width: 100%; margin-top: 0.25rem;">
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="template-category-filter" onchange="window.filterTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All Categories</option>
                            <option value="electrical">Electrical</option>
                            <option value="lighting">Lighting</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="installation">Installation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="template-status-filter" onchange="window.filterTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Templates List -->
            <div class="card">
                <h2>Templates Library</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Template Name</th>
                            <th>Category</th>
                            <th>Items Count</th>
                            <th>Est. Value</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="templates-list">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Templates Page -->
        <div id="activity-templates" class="page">
            <h1>ðŸ“‹ Activity Templates</h1>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <p style="margin: 0; color: #666;">Create reusable activity templates to streamline workflow and ensure consistency</p>
                </div>
                <div>
                    <button onclick="window.showCreateActivityTemplate()" style="background: #8b5cf6; color: white;">+ Create Activity Template</button>
                </div>
            </div>
            
            <!-- Activity Templates Filter & Search -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label>Search Templates</label>
                        <input type="text" id="activity-template-search" placeholder="Search by name or description..." 
                               oninput="window.filterActivityTemplates()" style="width: 100%; margin-top: 0.25rem;">
                    </div>
                    <div>
                        <label>Category</label>
                        <select id="activity-template-category-filter" onchange="window.filterActivityTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All Categories</option>
                            <option value="survey">Survey</option>
                            <option value="installation">Installation</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="testing">Testing</option>
                            <option value="documentation">Documentation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="activity-template-status-filter" onchange="window.filterActivityTemplates()" style="margin-top: 0.25rem;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Activity Templates List -->
            <div class="card">
                <h2>Activity Templates Library</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Template Name</th>
                            <th>Category</th>
                            <th>Duration</th>
                            <th>Priority</th>
                            <th>Last Updated</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activity-templates-list">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="activities" class="page">
            <h1>ðŸ“‹ Activities</h1>
            
            <!-- NEW Sprint 4.2: View Toggle and Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button onclick="window.showActivityModal()" style="background: #3b82f6; color: white;">+ New Activity</button>
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="activities-list-view-btn" onclick="window.switchActivitiesView('list')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            ðŸ“‹ List View
                        </button>
                        <button id="activities-calendar-view-btn" onclick="window.switchActivitiesView('calendar')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            ðŸ“… Calendar View
                        </button>
                        <button id="activities-workflow-view-btn" onclick="window.switchActivitiesView('workflow')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            ðŸ”— Workflow
                        </button>
                    </div>
                </div>
                
                <!-- Calendar Navigation (hidden by default) -->
                <div id="calendar-navigation" style="display: none; align-items: center; gap: 1rem;">
                    <div style="display: flex; background: #f1f5f9; border-radius: 0.5rem; padding: 0.25rem;">
                        <button id="calendar-month-btn" onclick="window.setCalendarView('month')" 
                                style="padding: 0.5rem 1rem; border: none; background: #3b82f6; color: white; border-radius: 0.25rem;">
                            Month
                        </button>
                        <button id="calendar-week-btn" onclick="window.setCalendarView('week')" 
                                style="padding: 0.5rem 1rem; border: none; background: transparent; color: #374151; border-radius: 0.25rem;">
                            Week
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.navigateCalendar('prev')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">â€¹</button>
                        <span id="calendar-title" style="min-width: 200px; text-align: center; font-weight: 500;">October 2024</span>
                        <button onclick="window.navigateCalendar('next')" style="padding: 0.25rem 0.5rem; background: #e5e7eb;">â€º</button>
                        <button onclick="window.navigateCalendar('today')" style="padding: 0.25rem 0.5rem; background: #3b82f6; color: white;">Today</button>
                    </div>
                </div>
            </div>
            
            <!-- List View (default) -->
            <div id="activities-list-view" class="card">
                <h2>Activity List</h2>
                <table>
                    <thead><tr><th>Title</th><th>PC Number</th><th>Company</th><th>Type</th><th>Scheduled</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="activities-list"></tbody>
                </table>
            </div>
            
            <!-- NEW Sprint 4.2: Calendar View -->
            <div id="activities-calendar-view" style="display: none;">
                <!-- NEW Sprint 4.2.3: Team Filter Bar -->
                <div class="team-filter-bar">
                    <div style="font-weight: 600; color: #374151; margin-right: 0.5rem;">Filter by Team:</div>
                    <div id="team-filter-chips">
                        <!-- Team member chips will be generated here -->
                    </div>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem;">
                        <button onclick="window.toggleWorkloadPanel()" 
                                style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            ðŸ“Š Workload View
                        </button>
                        <button onclick="window.showTeamManagement()" 
                                style="background: #3b82f6; color: white; border: none; padding: 0.375rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                            ðŸ‘¥ Manage Team
                        </button>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Workload Panel -->
                <div id="workload-panel" class="workload-panel" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">Team Workload Distribution</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="font-size: 0.875rem; color: #6b7280;">Week of: </span>
                            <span id="workload-week-display" style="font-weight: 500;"></span>
                        </div>
                    </div>
                    <div id="workload-summary" class="workload-summary">
                        <!-- Workload cards will be generated here -->
                    </div>
                </div>
                
                <!-- Month View Calendar -->
                <div id="calendar-month-view" class="card">
                    <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Calendar grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Week View Calendar -->
                <div id="calendar-week-view" class="card" style="display: none;">
                    <div style="display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 1px; background: #e5e7eb;">
                        <!-- Week view grid will be generated by JavaScript -->
                        <div style="background: white; padding: 0.5rem; font-weight: 500;"></div>
                        <!-- Time slots and days -->
                        <div id="week-grid-content">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Activity Details Sidebar (for calendar view) -->
                <div id="calendar-activity-sidebar" style="display: none; position: fixed; right: 20px; top: 20px; width: 300px; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">Activity Details</h3>
                        <button onclick="window.closeCalendarSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                    </div>
                    <div id="calendar-activity-content">
                        <!-- Activity details will be populated here -->
                    </div>
                </div>

                <!-- NEW Sprint 4.2.2: Quick Create Activity Overlay -->
                <div id="quick-create-overlay" class="quick-create-overlay">
                    <div class="quick-create-form">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">Quick Create Activity</h3>
                            <button onclick="window.closeQuickCreate()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        
                        <div id="quick-create-time-info" class="time-slot-info">
                            <!-- Time slot info will be populated here -->
                        </div>

                        <form id="quick-create-form" onsubmit="window.submitQuickCreate(event)">
                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Activity Title *</label>
                                <input type="text" id="quick-activity-title" name="title" required 
                                       style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-pc" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">PC Number</label>
                                <select id="quick-activity-pc" name="pc_id" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Select PC Number</option>
                                    <!-- PC options will be populated -->
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label for="quick-activity-assignee" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Assign To</label>
                                <select id="quick-activity-assignee" name="assigned_to" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="">Unassigned</option>
                                    <!-- Team members will be populated -->
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div>
                                    <label for="quick-activity-priority" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                                    <select id="quick-activity-priority" name="priority" 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="quick-activity-duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Duration (hrs)</label>
                                    <input type="number" id="quick-activity-duration" name="estimated_hours" min="0.25" step="0.25" value="1"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                </div>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label for="quick-activity-description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Description</label>
                                <textarea id="quick-activity-description" name="description" rows="3"
                                          style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;"></textarea>
                            </div>

                            <!-- NEW Sprint 4.2.4: Recurring Activities Section -->
                            <div class="recurring-section">
                                <div class="recurring-toggle">
                                    <input type="checkbox" id="quick-recurring-enabled" name="recurring_enabled" onchange="window.toggleRecurringOptions(this)">
                                    <label for="quick-recurring-enabled" style="font-weight: 500; color: #374151;">ðŸ”„ Make this a recurring activity</label>
                                </div>
                                
                                <div id="quick-recurring-options" class="recurring-options">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Repeat</label>
                                        <select id="quick-recurring-frequency" name="recurring_frequency" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <option value="daily">Daily</option>
                                            <option value="weekly" selected>Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Every</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="number" id="quick-recurring-interval" name="recurring_interval" min="1" max="365" value="1" 
                                                   style="width: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                            <span id="quick-recurring-unit" style="font-size: 0.875rem; color: #6b7280;">week(s)</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">End Date</label>
                                        <input type="date" id="quick-recurring-end-date" name="recurring_end_date" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem;">Or Max Occurrences</label>
                                        <input type="number" id="quick-recurring-count" name="recurring_count" min="1" max="365" placeholder="e.g., 10" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                                    </div>
                                </div>
                                
                                <div id="quick-recurring-preview" class="recurring-preview" style="display: none;">
                                    <!-- Preview will be generated here -->
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button type="button" onclick="window.closeQuickCreate()" 
                                        style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    Create Activity
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.3: Team Management Modal -->
                <div id="team-management-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 500px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">ðŸ‘¥ Team Management</h3>
                            <button onclick="window.closeTeamManagement()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        
                        <!-- Add New Team Member Form -->
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Add Team Member</h4>
                            <form id="add-team-member-form" onsubmit="window.addTeamMember(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name *</label>
                                        <input type="text" name="name" required 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Role</label>
                                        <input type="text" name="role" placeholder="e.g., Engineer, Manager" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                                        <input type="email" name="email" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Max Hours/Week</label>
                                        <input type="number" name="max_hours" min="1" max="60" value="40" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <button type="submit" 
                                        style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                    âž• Add Member
                                </button>
                            </form>
                        </div>
                        
                        <!-- Current Team Members -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">Current Team</h4>
                            <div id="team-members-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Team members will be listed here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="window.closeTeamManagement()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- NEW Sprint 4.2.4: Recurring Activity Edit Modal -->
                <div id="recurring-edit-modal" class="quick-create-overlay" style="display: none;">
                    <div class="quick-create-form" style="width: 450px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">ðŸ”„ Edit Recurring Activity</h3>
                            <button onclick="window.closeRecurringEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                                <strong>âš ï¸ This is part of a recurring series.</strong><br>
                                Choose how you want to apply your changes:
                            </p>
                        </div>
                        
                        <div id="recurring-edit-options" class="recurring-series-buttons" style="margin-bottom: 1.5rem;">
                            <button onclick="window.editRecurringActivity('single')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                ðŸ“ Edit Only This Activity
                            </button>
                            <button onclick="window.editRecurringActivity('future')" 
                                    style="background: #f59e0b; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                ðŸ“… Edit This & Future Activities
                            </button>
                            <button onclick="window.editRecurringActivity('all')" 
                                    style="background: #10b981; color: white; border: none; padding: 0.75rem 1rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; flex: 1;">
                                ðŸ”„ Edit Entire Series
                            </button>
                        </div>
                        
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #0c4a6e; font-size: 0.875rem; font-weight: 600;">Activity Details:</h4>
                            <div id="recurring-activity-details" style="font-size: 0.875rem; color: #0c4a6e;">
                                <!-- Activity details will be populated here -->
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                            <button onclick="window.closeRecurringEditModal()" 
                                    style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="window.deleteRecurringSeries()" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;">
                                ðŸ—‘ï¸ Delete Series
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW Sprint 4.4: Workflow View -->
            <div id="activities-workflow-view" style="display: none;">
                <!-- Workflow Stats Dashboard -->
                <div class="workflow-stats">
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-total-activities">0</div>
                        <div class="workflow-stat-label">Total Activities</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-in-progress">0</div>
                        <div class="workflow-stat-label">In Progress</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-completed">0</div>
                        <div class="workflow-stat-label">Completed</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-blocked">0</div>
                        <div class="workflow-stat-label">Blocked</div>
                    </div>
                    <div class="workflow-stat">
                        <div class="workflow-stat-value" id="workflow-critical-path">0</div>
                        <div class="workflow-stat-label">Critical Path Days</div>
                    </div>
                </div>

                <!-- Workflow Canvas -->
                <div class="workflow-panel">
                    <div class="workflow-header">
                        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">ðŸ”— Activity Dependencies & Workflow</h2>
                        <div class="workflow-toolbar">
                            <div class="workflow-mode-toggle">
                                <button class="workflow-mode-btn active" onclick="window.setWorkflowMode('view')">ðŸ‘ï¸ View</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('edit')">âœï¸ Edit</button>
                                <button class="workflow-mode-btn" onclick="window.setWorkflowMode('connect')">ðŸ”— Connect</button>
                            </div>
                            <button class="workflow-action-btn" onclick="window.autoLayoutWorkflow()">ðŸ”„ Auto Layout</button>
                            <button class="workflow-action-btn" onclick="window.calculateCriticalPath()">ðŸš¨ Critical Path</button>
                            <button class="workflow-action-btn primary" onclick="window.optimizeWorkflow()">âš¡ Optimize</button>
                        </div>
                    </div>
                    
                    <div id="workflow-canvas" class="workflow-canvas">
                        <!-- Workflow nodes and connections will be generated here -->
                        <svg id="workflow-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                                </marker>
                            </defs>
                        </svg>
                        
                        <div id="workflow-nodes-container">
                            <!-- Workflow nodes will be positioned here -->
                        </div>
                        
                        <!-- Workflow minimap -->
                        <div class="workflow-minimap">
                            <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; font-weight: 600; background: #f8fafc;">
                                Workflow Overview
                            </div>
                            <div id="workflow-minimap-content" style="padding: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                                <!-- Minimap content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Legend -->
                <div class="workflow-legend">
                    <div class="legend-item">
                        <div class="legend-indicator pending"></div>
                        <span>Pending</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator in-progress"></div>
                        <span>In Progress</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator completed"></div>
                        <span>Completed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator blocked"></div>
                        <span>Blocked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-indicator critical"></div>
                        <span>Critical Path</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="resources" class="page">
            <h1>ðŸ”§ Resources</h1>
            <button onclick="window.showResourceModal()">+ New Resource</button>
            <div class="card">
                <h2>Resource Database</h2>
                <table>
                    <thead><tr><th>Name</th><th>SKU</th><th>Category</th><th>Net Cost</th><th>Supplier</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="resources-list"></tbody>
                </table>
            </div>
        </div>

        <div id="pricelists" class="page">
             <h1>ðŸ·ï¸ Price Lists</h1>
            <button onclick="app.showPage('new-pricelist')">+ New Price List</button>
            <div class="card">
                <h2>Available Price Lists</h2>
                <table>
                    <thead><tr><th>Name</th><th>Version</th><th>Currency</th><th>Effective Period</th><th>Default</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-table"></tbody>
                </table>
            </div>
        </div>

        <div id="new-pricelist" class="page">
            <h1 id="pricelist-form-title">New Price List</h1>
            <div class="card">
                <input type="hidden" id="pricelist-id">
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-grid">
                        <div><label>Price List Name *</label><input type="text" id="pricelist-name" placeholder="e.g. Standard Commercial Rates 2024" required></div>
                        <div><label>Version *</label><input type="text" id="pricelist-version" placeholder="e.g. v2.1" required></div>
                        <div><label>Currency</label><select id="pricelist-currency">
                            <option value="GBP" selected>GBP (Â£)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (â‚¬)</option>
                        </select></div>
                        <div><label>Status</label><select id="pricelist-status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="inactive">Inactive</option>
                        </select></div>
                    </div>
                    <div>
                        <label>Description</label>
                        <textarea id="pricelist-description" rows="2" placeholder="Brief description of this price list..."></textarea>
                    </div>
                </div>
                
                <!-- Pricing Configuration -->
                <div class="form-section">
                    <h3>Pricing Configuration</h3>
                    <div class="form-grid">
                        <div><label>Default Markup (%) *</label><input type="number" id="pricelist-markup" step="0.01" min="0" placeholder="35.00" required></div>
                        <div><label>Discount (%)</label><input type="number" id="pricelist-discount" step="0.01" min="0" max="100" placeholder="0.00"></div>
                        <div><label>Effective From *</label><input type="date" id="pricelist-effective-from" required></div>
                        <div><label>Effective Until</label><input type="date" id="pricelist-effective-to"></div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="pricelist-is-default" style="margin-right: 0.5rem;">
                            Set as default price list
                        </label>
                    </div>
                </div>
                
                <!-- Terms & Conditions -->
                <div class="form-section">
                    <h3>Terms & Conditions</h3>
                    <div>
                        <label>Default Terms</label>
                        <textarea id="pricelist-terms" rows="3" placeholder="Pricing terms, payment conditions, delivery notes...">Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.</textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="window.createPriceList()">Create Price List</button>
                    <button onclick="app.showPage('pricelists')" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="pricelist-detail" class="page">
            <h1 id="pricelist-title">Price List Details</h1>
             <div class="card">
                <button onclick="window.showAddResourceToPriceList()">+ Add Item to Price List</button>
                <button onclick="app.showPage('pricelists')" class="secondary">Back to list</button>
            </div>
            <div class="card">
                <h2>Price List Items</h2>
                <table>
                    <thead><tr><th>Resource</th><th>Net Cost</th><th>Client Price</th><th>Margin %</th><th>Actions</th></tr></thead>
                    <tbody id="pricelist-items"></tbody>
                </table>
            </div>
        </div>

        <!-- NEW Sprint 4.3: Resource Allocation Tracking Page -->
        <div id="resource-allocation" class="page">
            <h1>ðŸ”§ Resource Allocation Tracking</h1>
            <p>Track and manage allocation of equipment, vehicles, materials, and tools across activities.</p>
            
            <!-- Resource Filter Bar -->
            <div class="resource-filter-bar">
                <div class="resource-filter-group">
                    <span class="filter-label">Type:</span>
                    <button class="resource-type-filter active" onclick="window.filterResourcesByType('all')">All</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('equipment')">Equipment</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('vehicle')">Vehicles</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('material')">Materials</button>
                    <button class="resource-type-filter" onclick="window.filterResourcesByType('tool')">Tools</button>
                </div>
                <div class="resource-filter-group">
                    <span class="filter-label">Status:</span>
                    <button class="resource-status-filter active" onclick="window.filterResourcesByStatus('all')">All</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('available')">Available</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('in-use')">In Use</button>
                    <button class="resource-status-filter" onclick="window.filterResourcesByStatus('maintenance')">Maintenance</button>
                </div>
                <div style="flex: 1;"></div>
                <button onclick="window.showResourceCalendarView()" class="resource-action-btn primary">
                    ðŸ“… Calendar View
                </button>
            </div>

            <!-- Resource Allocation Cards -->
            <div class="resource-allocation-panel">
                <div class="resource-allocation-header">
                    <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">ðŸ“‹ Resource Overview</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="resource-count" style="font-size: 0.875rem; color: #6b7280;">0 resources</span>
                        <button onclick="window.refreshResourceAllocation()" class="resource-action-btn">ðŸ”„ Refresh</button>
                    </div>
                </div>
                <div id="resource-allocation-grid" class="resource-grid">
                    <!-- Resource cards will be populated here -->
                </div>
            </div>

            <!-- Resource Calendar Timeline View -->
            <div id="resource-calendar-view" class="resource-calendar-view" style="display: none;">
                <div class="resource-calendar-header">
                    <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">ðŸ“… Resource Schedule Timeline</h3>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <button onclick="window.navigateResourceWeek(-1)" class="resource-action-btn">â† Previous</button>
                        <span id="resource-week-display" style="font-weight: 500;">Current Week</span>
                        <button onclick="window.navigateResourceWeek(1)" class="resource-action-btn">Next â†’</button>
                        <button onclick="window.hideResourceCalendarView()" class="resource-action-btn">âœ• Close</button>
                    </div>
                </div>
                <div id="resource-timeline" class="resource-timeline">
                    <!-- Timeline rows will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <div id="analytics" class="page">
        <h1>ðŸ“Š Analytics & Reporting</h1>
        
        <!-- Analytics Summary Card -->
        <div class="analytics-summary-card">
            <div class="analytics-summary-title">Project Performance Overview</div>
            <div class="analytics-summary-subtitle">Real-time insights into your team's performance and project metrics</div>
            <div class="analytics-summary-stats">
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-total-activities">0</div>
                    <div class="analytics-summary-stat-label">Total Activities</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-completion-rate">0%</div>
                    <div class="analytics-summary-stat-label">Completion Rate</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-avg-duration">0h</div>
                    <div class="analytics-summary-stat-label">Avg Duration</div>
                </div>
                <div class="analytics-summary-stat">
                    <div class="analytics-summary-stat-value" id="summary-team-utilization">0%</div>
                    <div class="analytics-summary-stat-label">Team Utilization</div>
                </div>
            </div>
        </div>

        <!-- Analytics Filters -->
        <div class="analytics-filters">
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Time Period</label>
                <select id="analytics-period-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Team Member</label>
                <select id="analytics-team-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="">All Team Members</option>
                    <!-- Options populated by JavaScript -->
                </select>
            </div>
            <div class="analytics-filter-group">
                <label class="analytics-filter-label">Activity Type</label>
                <select id="analytics-type-filter" class="analytics-filter-select" onchange="window.updateAnalytics()">
                    <option value="">All Types</option>
                    <option value="installation">Installation</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="inspection">Inspection</option>
                    <option value="consultation">Consultation</option>
                    <option value="training">Training</option>
                </select>
            </div>
            <div style="margin-left: auto;">
                <button class="analytics-export-btn" onclick="window.exportAnalyticsReport()">ðŸ“Š Export Report</button>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="analytics-dashboard">
            <!-- Activity Performance Chart -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">ðŸ“ˆ Activity Performance</h3>
                    <div class="analytics-period-selector">
                        <button class="analytics-period-btn active" onclick="window.setChartPeriod('week', this)">Week</button>
                        <button class="analytics-period-btn" onclick="window.setChartPeriod('month', this)">Month</button>
                        <button class="analytics-period-btn" onclick="window.setChartPeriod('quarter', this)">Quarter</button>
                    </div>
                </div>
                <div class="analytics-chart-container">
                    <div id="activity-performance-chart" class="analytics-chart">
                        <!-- Chart bars will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Team Performance -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">ðŸ‘¥ Team Performance</h3>
                </div>
                <div id="team-performance-metrics" class="analytics-metrics-grid">
                    <!-- Team metrics will be populated here -->
                </div>
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Team Member</th>
                            <th>Activities</th>
                            <th>Completion Rate</th>
                            <th>Avg Duration</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="team-performance-table">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Activity Status Distribution -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">ðŸ“Š Activity Status Distribution</h3>
                </div>
                <div class="analytics-donut-chart">
                    <svg width="200" height="200" class="analytics-donut-svg">
                        <circle cx="100" cy="100" r="80" stroke="#e5e7eb" stroke-width="20" fill="transparent"/>
                        <circle id="donut-pending" cx="100" cy="100" r="80" stroke="#6b7280" stroke-width="20" fill="transparent"/>
                        <circle id="donut-in-progress" cx="100" cy="100" r="80" stroke="#3b82f6" stroke-width="20" fill="transparent"/>
                        <circle id="donut-completed" cx="100" cy="100" r="80" stroke="#22c55e" stroke-width="20" fill="transparent"/>
                    </svg>
                    <div class="analytics-donut-center">
                        <div class="analytics-donut-center-value" id="donut-total">0</div>
                        <div class="analytics-donut-center-label">Total</div>
                    </div>
                </div>
                <div class="analytics-legend">
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #6b7280;"></div>
                        <span id="legend-pending">Pending (0)</span>
                    </div>
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #3b82f6;"></div>
                        <span id="legend-in-progress">In Progress (0)</span>
                    </div>
                    <div class="analytics-legend-item">
                        <div class="analytics-legend-color" style="background: #22c55e;"></div>
                        <span id="legend-completed">Completed (0)</span>
                    </div>
                </div>
            </div>

            <!-- Time Tracking Analytics -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">â±ï¸ Time Tracking Analytics</h3>
                </div>
                <div class="analytics-metrics-grid">
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="total-hours-logged">0</div>
                        <div class="analytics-metric-label">Hours Logged</div>
                        <div class="analytics-metric-change neutral" id="hours-change">No change</div>
                    </div>
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="avg-activity-duration">0h</div>
                        <div class="analytics-metric-label">Avg Duration</div>
                        <div class="analytics-metric-change neutral" id="duration-change">No change</div>
                    </div>
                    <div class="analytics-metric-card">
                        <div class="analytics-metric-value" id="overdue-activities">0</div>
                        <div class="analytics-metric-label">Overdue</div>
                        <div class="analytics-metric-change negative" id="overdue-change">0 overdue</div>
                    </div>
                </div>
            </div>

            <!-- Resource Utilization -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">ðŸ”§ Resource Utilization</h3>
                </div>
                <div id="resource-utilization-list">
                    <!-- Resource utilization items will be populated here -->
                </div>
            </div>

            <!-- Activity Heatmap -->
            <div class="analytics-card">
                <div class="analytics-card-header">
                    <h3 class="analytics-card-title">ðŸ—“ï¸ Activity Heatmap (Last 30 Days)</h3>
                </div>
                <div id="activity-heatmap" class="analytics-heatmap">
                    <!-- Heatmap cells will be generated here -->
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                    <span>Less</span>
                    <div style="display: flex; gap: 2px;">
                        <div class="analytics-heatmap-cell"></div>
                        <div class="analytics-heatmap-cell low"></div>
                        <div class="analytics-heatmap-cell medium"></div>
                        <div class="analytics-heatmap-cell high"></div>
                        <div class="analytics-heatmap-cell very-high"></div>
                    </div>
                    <span>More</span>
                </div>
            </div>
        </div>
                </div>
        </div>
    </main>

    <div id="quote-modal" class="modal"><div class="modal-content">
        <h2>Select PC Number for new quote</h2>
        <label>PC Number *</label>
        <select id="quote-modal-pc"></select>
        <div class="form-actions">
            <button onclick="window.proceedToQuoteBuilder()">Continue</button>
            <button onclick="window.closeQuoteModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <div id="activity-modal" class="modal"><div class="modal-content">
        <h2 id="activity-modal-title">New Activity</h2>
        <input type="hidden" id="activity-id">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <h3>Basic Information</h3>
        <div class="form-grid">
                <div><label>PC Number *</label><select id="activity-pc-select"></select></div>
                <div><label>Activity Type *</label><input type="text" id="activity-type" placeholder="e.g. Survey, Delivery, Installation"></div>
                <div><label>Priority</label><select id="activity-priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select></div>
                <div><label>Status</label><select id="activity-status">
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select></div>
        </div>
            <div>
                <label>Activity Title *</label>
                <input type="text" id="activity-title" placeholder="Brief description of the activity" required>
            </div>
            <div>
                <label>Description</label>
                <textarea id="activity-description" rows="2" placeholder="Detailed activity description..."></textarea>
            </div>
        </div>
        
        <!-- Scheduling Section -->
        <div class="form-section">
            <h3>Scheduling</h3>
            <div class="form-grid">
                <div><label>Scheduled Date</label><input type="date" id="activity-scheduled-date"></div>
                <div><label>Scheduled Time</label><input type="time" id="activity-scheduled-time"></div>
                <div><label>Duration (hours)</label><input type="number" id="activity-duration" step="0.5" min="0" placeholder="e.g. 2.5"></div>
                <div><label>Assigned To</label><input type="text" id="activity-assigned-to-name" placeholder="Person responsible"></div>
            </div>
        </div>
        
        <!-- Location & Contact Section -->
        <div class="form-section">
            <h3>Location & Contact</h3>
            <div class="form-grid">
                <div><label>Location</label><input type="text" id="activity-location" placeholder="e.g. Client Site - Birmingham"></div>
                <div><label>Contact Name</label><input type="text" id="activity-contact-name" placeholder="Site contact person"></div>
                <div><label>Contact Phone</label><input type="tel" id="activity-contact-phone" placeholder="Contact phone number"></div>
            </div>
        </div>
        
        <!-- Completion Section (shown only for completed activities) -->
        <div class="form-section" id="activity-completion-section" style="display: none;">
            <h3>Completion Details</h3>
            <div>
                <label>Completion Notes</label>
                <textarea id="activity-completion-notes" rows="3" placeholder="Notes about the completed activity..."></textarea>
            </div>
        </div>
        
        <!-- NEW Sprint 4.3: Resource Allocation Section -->
        <div class="form-section">
            <h3>Resource Allocation</h3>
            <div style="margin-bottom: 1rem;">
                <label>Required Resources</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showActivityResourceSelector()" class="resource-action-btn primary">
                        ðŸ”§ Select Resources
                    </button>
                    <button type="button" onclick="window.checkResourceAvailability()" class="resource-action-btn">
                        âœ“ Check Availability
                    </button>
                </div>
            </div>
            <div id="activity-resources-list" style="background: #f9fafb; border-radius: 0.5rem; padding: 0.75rem; min-height: 60px;">
                <div id="activity-resources-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                    No resources selected. Click "Select Resources" to add equipment, vehicles, materials, or tools.
                </div>
                <div id="activity-resources-items" style="display: none;">
                    <!-- Selected resources will be populated here -->
                </div>
            </div>
            <div id="activity-resource-conflicts" style="display: none;">
                <!-- Resource conflicts will be shown here -->
            </div>
        </div>
        
        <!-- NEW Sprint 4.4: Dependencies Section -->
        <div class="form-section">
            <h3>Activity Dependencies</h3>
            <div style="margin-bottom: 1rem;">
                <label>Dependencies & Workflow</label>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" onclick="window.showDependencySelector('predecessor')" class="resource-action-btn primary">
                        â¬…ï¸ Add Predecessor
                    </button>
                    <button type="button" onclick="window.showDependencySelector('successor')" class="resource-action-btn">
                        âž¡ï¸ Add Successor
                    </button>
                    <button type="button" onclick="window.calculateActivitySchedule()" class="resource-action-btn">
                        ðŸ“Š Auto Schedule
                    </button>
                </div>
            </div>
            
            <!-- Predecessors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">â¬…ï¸ Predecessors (Must complete before this activity)</div>
                <div id="activity-predecessors-list" class="dependency-list">
                    <div id="activity-predecessors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No predecessors defined. This activity can start immediately.
                    </div>
                </div>
            </div>
            
            <!-- Successors -->
            <div class="dependency-section">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #374151;">âž¡ï¸ Successors (Will start after this activity)</div>
                <div id="activity-successors-list" class="dependency-list">
                    <div id="activity-successors-empty" style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 1rem;">
                        No successors defined. This activity has no dependent activities.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveActivity()">Save Activity</button>
            <button onclick="window.saveActivityAsTemplate()" style="background: #8b5cf6; color: white;">ðŸ“‹ Save as Template</button>
            <button onclick="window.closeActivityModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <div id="resource-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2 id="resource-modal-title">New Resource</h2>
        <input type="hidden" id="resource-id">
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3>Basic Information</h3>
            <div class="form-grid">
                <div><label>Resource Name *</label><input type="text" id="resource-name" placeholder="e.g. LED Downlight - 10W Cool White" required></div>
                <div><label>SKU</label><input type="text" id="resource-sku" placeholder="e.g. LED-DL-10W-CW" pattern="[A-Z0-9-]+" title="SKU should contain only uppercase letters, numbers, and hyphens"></div>
                <div><label>Category *</label><select id="resource-category" required>
                    <option value="">Select...</option>
                    <option value="lighting">Lighting</option>
                    <option value="electrical">Electrical</option>
                    <option value="labour">Labour</option>
                    <option value="transport">Transport</option>
                    <option value="materials">Materials</option>
                    <option value="other">Other</option>
                </select></div>
                <div><label>Subcategory</label><input type="text" id="resource-subcategory" placeholder="e.g. downlights, cable"></div>
            </div>
            <div>
                <label>Description</label>
                <textarea id="resource-description" rows="2" placeholder="Detailed resource description..."></textarea>
            </div>
        </div>
        
        <!-- Pricing & Units -->
        <div class="form-section">
            <h3>Pricing & Units</h3>
            <div class="form-grid">
                <div><label>Net Cost (Â£) *</label><input type="number" id="resource-cost" step="0.01" min="0" placeholder="25.00" required></div>
                <div><label>Unit *</label><select id="resource-unit" required>
                    <option value="">Select...</option>
                    <option value="each">Each</option>
                    <option value="metre">Metre</option>
                    <option value="hour">Hour</option>
                    <option value="day">Day</option>
                    <option value="kg">Kilogram</option>
                    <option value="m2">Square Metre</option>
                </select></div>
                <div><label>Min Quantity</label><input type="number" id="resource-min-quantity" min="1" placeholder="10"></div>
                <div><label>Lead Time (days)</label><input type="number" id="resource-lead-time" min="0" placeholder="5"></div>
            </div>
        </div>
        
        <!-- Supplier Information -->
        <div class="form-section">
            <h3>Supplier Information</h3>
            <div class="form-grid">
                <div><label>Supplier</label><input type="text" id="resource-supplier" placeholder="e.g. Electrical Supplies Ltd"></div>
                <div><label>Supplier Code</label><input type="text" id="resource-supplier-code" placeholder="e.g. ESL-LED-001"></div>
                <div><label>Warranty (months)</label><input type="number" id="resource-warranty" min="0" placeholder="24"></div>
                <div><label>Status</label><select id="resource-status">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select></div>
            </div>
        </div>
        
        <!-- Physical Properties -->
        <div class="form-section">
            <h3>Physical Properties</h3>
            <div class="form-grid">
                <div><label>Weight (kg)</label><input type="number" id="resource-weight" step="0.001" min="0" placeholder="0.150"></div>
                <div><label>Dimensions</label><input type="text" id="resource-dimensions" placeholder="e.g. 85mm diameter x 25mm depth"></div>
            </div>
        </div>
        
        <div class="form-actions">
            <button onclick="window.saveResource()">Save Resource</button>
            <button onclick="window.closeResourceModal()" class="secondary">Cancel</button>
        </div>
    </div>        </div>

        <!-- NEW Sprint 3: Enhanced Resource Lookup Modal -->
        <div id="enhanced-resource-lookup-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="window.closeEnhancedResourceModal()">&times;</span>
                <h2>ðŸ” Add Resources to Quote</h2>
                
                <!-- Search & Filter Section -->
                <div style="margin-bottom: 1.5rem; border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.75rem; align-items: center;">
                        <div>
                            <label>Search Resources</label>
                            <input type="text" id="resource-search" placeholder="Search by name, SKU, or description..." 
                                   oninput="window.filterResources()" style="width: 100%; margin-top: 0.25rem;">
                        </div>
                        <div>
                            <label>Category</label>
                            <select id="resource-category-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Categories</option>
                                <option value="human">Human Resources</option>
                                <option value="vehicles">Vehicles</option>
                                <option value="materials">Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="resource-status-filter" onchange="window.filterResources()" style="margin-top: 0.25rem;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #666;">
                        <span id="resource-count">0</span> resources found
                    </p>
                </div>
                
                <!-- Resources Grid -->
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f8fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Select</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Resource</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">SKU</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Category</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Price</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Qty</th>
                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="enhanced-resources-list">
                            <!-- Dynamic content populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Bulk Actions -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span id="selected-count">0</span> resources selected
                            <button onclick="window.selectAllFilteredResources()" style="margin-left: 1rem;" class="secondary">Select All Visible</button>
                            <button onclick="window.clearResourceSelection()" style="margin-left: 0.5rem;" class="secondary">Clear Selection</button>
                        </div>
                        <div>
                            <button onclick="window.addSelectedResourcesToQuote()" disabled id="add-selected-btn">Add Selected to Quote</button>
                            <button onclick="window.closeEnhancedResourceModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.2: Bulk Operations Modals -->
        <div id="bulk-quantity-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkQuantityModal()">&times;</span>
                <h2>ðŸ“Š Update Quantities</h2>
                <p>Update quantities for <span id="bulk-qty-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Operation:</label>
                    <select id="bulk-qty-operation" style="width: 100%; margin-bottom: 1rem;">
                        <option value="set">Set all to specific value</option>
                        <option value="multiply">Multiply by factor</option>
                        <option value="add">Add to current</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Value:</label>
                    <input type="number" id="bulk-qty-value" min="0" step="1" placeholder="Enter value" style="width: 100%;">
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkQuantityUpdate()" style="background: #3b82f6; color: white;">Apply Changes</button>
                    <button onclick="window.closeBulkQuantityModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <div id="bulk-discount-modal" class="modal">
            <div class="modal-content" style="max-width: 400px;">
                <span class="close" onclick="window.closeBulkDiscountModal()">&times;</span>
                <h2>ðŸ’° Apply Discount</h2>
                <p>Apply discount to <span id="bulk-discount-count">0</span> selected line items</p>
                
                <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Type:</label>
                    <select id="bulk-discount-type" style="width: 100%; margin-bottom: 1rem;">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (Â£)</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 0.5rem;">Discount Value:</label>
                    <input type="number" id="bulk-discount-value" min="0" step="0.01" placeholder="Enter discount" style="width: 100%;">
                    
                    <p style="font-size: 0.875rem; color: #666; margin-top: 0.5rem;">
                        Note: Discount will be applied to unit prices
                    </p>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.applyBulkDiscount()" style="background: #10b981; color: white;">Apply Discount</button>
                    <button onclick="window.closeBulkDiscountModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
                </div>

        <!-- NEW Sprint 3.3: Template Creation/Edit Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="window.closeTemplateModal()">&times;</span>
                <h2 id="template-modal-title">Create Quote Template</h2>
                
                <input type="hidden" id="template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="template-name" placeholder="e.g. Standard Office Lighting" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="template-category" required>
                                <option value="">Select category...</option>
                                <option value="electrical">Electrical</option>
                                <option value="lighting">Lighting</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="installation">Installation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                            <label>Default VAT Rate (%)</label>
                            <input type="number" id="template-vat-rate" value="20.00" step="0.01" min="0" max="100">
                        </div>
                    </div>
                </div>
                
                <!-- Template Default Terms -->
                <div style="margin-bottom: 1.5rem;">
                    <label>Default Terms & Conditions</label>
                    <textarea id="template-terms" rows="3" placeholder="Default terms for quotes created from this template...">Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.</textarea>
                </div>
                
                <!-- Template Items Preview -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Items</h4>
                    <div id="template-items-preview" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;">
                        <p style="margin: 0; color: #666; text-align: center;">Create template from current quote items or add items manually</p>
                    </div>
                    <div style="margin-top: 0.5rem; text-align: center;">
                        <button onclick="window.addItemsToTemplate()" class="secondary">+ Add Items to Template</button>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveTemplate()">Save Template</button>
                    <button onclick="window.closeTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NEW Sprint 4.1: Activity Template Creation/Edit Modal -->
        <div id="activity-template-modal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="window.closeActivityTemplateModal()">&times;</span>
                <h2 id="activity-template-modal-title">Create Activity Template</h2>
                
                <input type="hidden" id="activity-template-id">
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Template Name *</label>
                            <input type="text" id="activity-template-name" placeholder="e.g. Standard Site Survey" required>
                        </div>
                        <div>
                            <label>Category *</label>
                            <select id="activity-template-category" required>
                                <option value="">Select category...</option>
                                <option value="survey">Survey</option>
                                <option value="installation">Installation</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label>Description</label>
                        <textarea id="activity-template-description" rows="2" placeholder="Brief description of when to use this template..."></textarea>
                    </div>
                </div>
                
                <!-- Activity Details -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Activity Configuration</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Priority *</label>
                            <select id="activity-template-priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label>Duration (hours)</label>
                            <input type="number" id="activity-template-duration" step="0.5" min="0.5" placeholder="2.0">
                        </div>
                        <div>
                            <label>Status</label>
                            <select id="activity-template-status">
                                <option value="active">Active</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-assignment Rules -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Auto-assignment & Scheduling</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Default Assigned To</label>
                            <input type="text" id="activity-template-assigned-to" placeholder="e.g. Mike Johnson">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">Leave empty for manual assignment</p>
                        </div>
                        <div>
                            <label>Auto-schedule (days from PC creation)</label>
                            <input type="number" id="activity-template-schedule-offset" min="0" placeholder="1">
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #666;">0 = same day, 1 = next day, etc.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Template Instructions -->
                <div style="margin-bottom: 1.5rem;">
                    <h4>Template Instructions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Pre-activity Checklist</label>
                            <textarea id="activity-template-checklist" rows="3" placeholder="â€¢ Confirm appointment with client
â€¢ Prepare tools and equipment
â€¢ Review site access instructions"></textarea>
                        </div>
                        <div>
                            <label>Completion Notes Template</label>
                            <textarea id="activity-template-completion-notes" rows="3" placeholder="Activity completed successfully.

Key findings:
â€¢

Next steps:
â€¢"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="window.saveActivityTemplate()">Save Template</button>
                    <button onclick="window.closeActivityTemplateModal()" class="secondary" style="margin-left: 0.5rem;">Cancel</button>
                </div>
            </div>
        </div>

    <div id="add-resource-modal" class="modal"><div class="modal-content" style="max-width: 500px;">
        <h2>Add item to Price List</h2>
        <label>Select Resource *</label><select id="modal-resource-item-select"></select>
        <div id="resource-info" style="margin: 1rem 0; padding: 1rem; background: #f8f9fa;"></div>
        <label>Client Price (Â£) *</label><input type="number" id="modal-client-price" step="0.01" min="0" oninput="window.calculateMargin()">
        <div id="margin-info" style="margin-top: 0.5rem;"></div>
        <div class="form-actions">
             <button onclick="window.addResourceToPriceList()">Add to Price List</button>
            <button onclick="window.closeAddResourceModal()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.3: Activity Resource Selector Modal -->
    <div id="activity-resource-selector-modal" class="modal"><div class="modal-content" style="max-width: 900px;">
        <h2>ðŸ”§ Select Resources for Activity</h2>
        
        <!-- Resource Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <input type="text" id="resource-selector-search" placeholder="Search resources..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                       oninput="window.filterActivityResourceSelector()">
                <select id="resource-selector-type-filter" onchange="window.filterActivityResourceSelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Types</option>
                    <option value="equipment">Equipment</option>
                    <option value="vehicle">Vehicles</option>
                    <option value="material">Materials</option>
                    <option value="tool">Tools</option>
                </select>
            </div>
        </div>

        <!-- Resource Selection Grid -->
        <div id="resource-selector-grid" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Resources will be populated here -->
        </div>

        <!-- Selected Resources Summary -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Selected Resources:</div>
            <div id="resource-selector-summary" style="font-size: 0.875rem; color: #166534;">
                No resources selected
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmActivityResourceSelection()" class="primary">Confirm Selection</button>
            <button onclick="window.closeActivityResourceSelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

    <!-- NEW Sprint 4.4: Dependency Selector Modal -->
    <div id="dependency-selector-modal" class="modal"><div class="modal-content" style="max-width: 800px;">
        <h2>ðŸ”— Select Activity Dependencies</h2>
        
        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div id="dependency-selector-info" style="font-size: 0.875rem; color: #0c4a6e;">
                <!-- Information about dependency type will be shown here -->
            </div>
        </div>
        
        <!-- Activity Search and Filter -->
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <input type="text" id="dependency-selector-search" placeholder="Search activities..." 
                       style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                       oninput="window.filterDependencySelector()">
                <select id="dependency-selector-status-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="dependency-selector-pc-filter" onchange="window.filterDependencySelector()"
                        style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                    <option value="">All PC Numbers</option>
                    <!-- PC options will be populated -->
                </select>
            </div>
        </div>

        <!-- Activity Selection List -->
        <div id="dependency-selector-list" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
            <!-- Activities will be populated here -->
        </div>

        <!-- Dependency Type Options -->
        <div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Dependency Type:</div>
            <div style="display: flex; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-start" checked>
                    Finish-to-Start (Default)
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="start-to-start">
                    Start-to-Start
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem;">
                    <input type="radio" name="dependencyType" value="finish-to-finish">
                    Finish-to-Finish
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button onclick="window.confirmDependencySelection()" class="primary">Add Dependency</button>
            <button onclick="window.closeDependencySelector()" class="secondary">Cancel</button>
        </div>
    </div></div>

<script>
// =================================================================
// CRM Demo - Portable Version with IndexedDB
// =================================================================

/**
 * @fileoverview CRM System Configuration & Core Setup
 * @version 2.0.0
 * @author MF CRM Team
 */

// ========================================
// GLOBAL CONFIGURATION
// ========================================

/**
 * @namespace CONFIG
 * @description Centralized configuration for the entire CRM system
 */
const CONFIG = {
    // Database Configuration
    DATABASE: {
        NAME: 'MF_CRM_Database',
        VERSION: 3, // Incremented for activity templates store
        STORES: {
            PCS: 'pcs',
            QUOTES: 'quotes', 
            ACTIVITIES: 'activities',
            RESOURCES: 'resources',
            PRICE_LISTS: 'price_lists',
            TEMPLATES: 'templates',
            ACTIVITY_TEMPLATES: 'activity_templates'
        }
    },

    // Business Rules & Defaults
    BUSINESS: {
        DEFAULT_VAT_RATE: 20.0,
        DEFAULT_MARKUP_PERCENTAGE: 35.00,
        DEFAULT_QUOTE_VALIDITY_DAYS: 30,
        DEFAULT_QUOTE_LIMIT: 5,
        MAX_RECURRING_OCCURRENCES: 365,
        DEFAULT_ACTIVITY_TIME: '9:00 AM',
        DEFAULT_TERMS: 'Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.'
    },

    // UI Configuration
    UI: {
        CALENDAR: {
            DEFAULT_VIEW: 'month', // 'month' or 'week'
            DEFAULT_ACTIVITIES_VIEW: 'list', // 'list' or 'calendar'
        },
        ANALYTICS: {
            DEFAULT_PERIOD_DAYS: 30,
            DEFAULT_CHART_PERIOD: 'month'
        },
        NOTIFICATION: {
            DEFAULT_ICON: 'ðŸ””',
            ICONS: {
                'activity': 'ðŸ“‹',
                'quote': 'ðŸ’°',
                'deadline': 'â°',
                'reminder': 'ðŸ””',
                'warning': 'âš ï¸',
                'success': 'âœ…',
                'error': 'âŒ',
                'overdue': 'â°',
                'due_today': 'ðŸ“…',
                'due_tomorrow': 'ðŸ“‹',
                'overloaded': 'âš ï¸',
                'unassigned_urgent': 'ðŸš¨',
                'default': 'ðŸ””'
            }
        }
    },

    // Default Team Members
    TEAM: {
        DEFAULT_MEMBERS: [
            {
                id: 'tm1',
                name: 'John Smith',
                role: 'Senior Engineer',
                email: 'john.smith@company.com',
                max_hours: 40,
                color: '#3b82f6'
            },
            {
                id: 'tm2',
                name: 'Sarah Johnson',
                role: 'Project Manager',
                email: 'sarah.johnson@company.com',
                max_hours: 40,
                color: '#10b981'
            },
            {
                id: 'tm3',
                name: 'Mike Brown',
                role: 'Technician',
                email: 'mike.brown@company.com',
                max_hours: 35,
                color: '#f59e0b'
            }
        ],
        DEFAULT_FILTER: 'all'
    },

    // Workflow & Dependencies
    WORKFLOW: {
        DEFAULT_MODE: 'view', // 'view', 'edit', 'connect'
        DEFAULT_DEPENDENCY_TYPE: 'predecessor',
        DEPENDENCY_TYPES: {
            FINISH_TO_START: 'finish-to-start',
            START_TO_START: 'start-to-start',
            FINISH_TO_FINISH: 'finish-to-finish'
        }
    },

    // System Limits & Validation
    LIMITS: {
        MAX_RETRY_ATTEMPTS: 3,
        RETRY_DELAY_MS: 1000,
        MAX_FILE_SIZE_MB: 10,
        MAX_DESCRIPTION_LENGTH: 1000
    },
    
    // Debug & Development Settings
    DEBUG: {
        EVENTS: false,  // Set to true to enable detailed event logging
        DATABASE: false, // Set to true to enable database operation logging
        UI: false       // Set to true to enable UI interaction logging
    }
};

// Legacy constants for backward compatibility
const DB_NAME = CONFIG.DATABASE.NAME;
const DB_VERSION = CONFIG.DATABASE.VERSION;
const STORES = CONFIG.DATABASE.STORES;

// ========================================
// GLOBAL STATE
// ========================================

/**
 * @description Global database connection and state management
 */
let dbConnection = null;
let db = {}; // In-memory cache for compatibility

// ========================================
// IndexedDB Management
// ========================================

/**
 * @description Generate a UUID v4 using crypto.randomUUID() or fallback method
 * @returns {string} A valid UUID v4 string
 * @example
 * const id = generateUUID(); // "12345678-1234-4xxx-yxxx-123456789abc"
 */
function generateUUID() {
    if (crypto && crypto.randomUUID) {
        return crypto.randomUUID();
    }
    // Fallback UUID generation
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

/**
 * @description Initialize IndexedDB connection and create object stores with indexes
 * @async
 * @returns {Promise<IDBDatabase>} Promise that resolves to the database connection
 * @throws {Error} If IndexedDB is not supported or connection fails
 * @example
 * try {
 *   await initializeIndexedDB();
 *   console.log('Database ready');
 * } catch (error) {
 *   console.error('Database initialization failed:', error);
 * }
 */
async function initializeIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
            console.error('âŒ IndexedDB connection failed:', request.error);
            reject(request.error);
        };
        
        request.onsuccess = () => {
            dbConnection = request.result;
            console.log('âœ… IndexedDB connected successfully');
            resolve(dbConnection);
        };
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            console.log('ðŸ—ï¸ Setting up IndexedDB schema...');
            
            // Create PCS store
            if (!db.objectStoreNames.contains(STORES.PCS)) {
                const pcsStore = db.createObjectStore(STORES.PCS, { keyPath: 'id' });
                pcsStore.createIndex('pc_number', 'pc_number', { unique: true });
                pcsStore.createIndex('company_name', 'company_name', { unique: false });
                pcsStore.createIndex('account_manager', 'account_manager', { unique: false });
                pcsStore.createIndex('status', 'status', { unique: false });
                pcsStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // Create QUOTES store
            if (!db.objectStoreNames.contains(STORES.QUOTES)) {
                const quotesStore = db.createObjectStore(STORES.QUOTES, { keyPath: 'id' });
                quotesStore.createIndex('quote_number', 'quote_number', { unique: true });
                quotesStore.createIndex('pc_id', 'pc_id', { unique: false });
                quotesStore.createIndex('company_name', 'company_name', { unique: false });
                quotesStore.createIndex('status', 'status', { unique: false });
                quotesStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // Create ACTIVITIES store
            if (!db.objectStoreNames.contains(STORES.ACTIVITIES)) {
                const activitiesStore = db.createObjectStore(STORES.ACTIVITIES, { keyPath: 'id' });
                activitiesStore.createIndex('pc_id', 'pc_id', { unique: false });
                activitiesStore.createIndex('company_name', 'company_name', { unique: false });
                activitiesStore.createIndex('type', 'type', { unique: false });
                activitiesStore.createIndex('status', 'status', { unique: false });
                activitiesStore.createIndex('assigned_to', 'assigned_to', { unique: false });
                activitiesStore.createIndex('scheduled_date', 'scheduled_date', { unique: false });
            }
            
            // Create RESOURCES store
            if (!db.objectStoreNames.contains(STORES.RESOURCES)) {
                const resourcesStore = db.createObjectStore(STORES.RESOURCES, { keyPath: 'id' });
                resourcesStore.createIndex('name', 'name', { unique: false });
                resourcesStore.createIndex('category', 'category', { unique: false });
                resourcesStore.createIndex('sku', 'sku', { unique: false });
                resourcesStore.createIndex('is_active', 'is_active', { unique: false });
                resourcesStore.createIndex('supplier', 'supplier', { unique: false });
            }
            
            // Create PRICE_LISTS store
            if (!db.objectStoreNames.contains(STORES.PRICE_LISTS)) {
                const priceListsStore = db.createObjectStore(STORES.PRICE_LISTS, { keyPath: 'id' });
                priceListsStore.createIndex('name', 'name', { unique: false });
                priceListsStore.createIndex('version', 'version', { unique: false });
                priceListsStore.createIndex('effective_from', 'effective_from', { unique: false });
                priceListsStore.createIndex('is_default', 'is_default', { unique: false });
            }
            
            // NEW Sprint 3.3: Create TEMPLATES store
            if (!db.objectStoreNames.contains(STORES.TEMPLATES)) {
                const templatesStore = db.createObjectStore(STORES.TEMPLATES, { keyPath: 'id' });
                templatesStore.createIndex('name', 'name', { unique: false });
                templatesStore.createIndex('category', 'category', { unique: false });
                templatesStore.createIndex('status', 'status', { unique: false });
                templatesStore.createIndex('created_at', 'created_at', { unique: false });
            }
            
            // NEW Sprint 4.1: Create ACTIVITY_TEMPLATES store
            if (!db.objectStoreNames.contains(STORES.ACTIVITY_TEMPLATES)) {
                const activityTemplatesStore = db.createObjectStore(STORES.ACTIVITY_TEMPLATES, { keyPath: 'id' });
                activityTemplatesStore.createIndex('name', 'name', { unique: false });
                activityTemplatesStore.createIndex('category', 'category', { unique: false });
                activityTemplatesStore.createIndex('priority', 'priority', { unique: false });
                activityTemplatesStore.createIndex('status', 'status', { unique: false });
                activityTemplatesStore.createIndex('created_at', 'created_at', { unique: false });
            }
        };
    });
}

/**
 * @description Enhanced error handling with retry logic
 * @param {string} storeName - IndexedDB store name
 * @param {Object} data - Data to save
 * @param {number} maxRetries - Maximum retry attempts (defaults to CONFIG)
 * @param {number} delay - Delay between retries in ms (defaults to CONFIG)
 * @returns {Promise<void>}
 */
async function saveWithRetry(storeName, data, maxRetries = CONFIG.LIMITS.MAX_RETRY_ATTEMPTS, delay = CONFIG.LIMITS.RETRY_DELAY_MS) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            await saveToStore(storeName, data);
            return; // Success - exit function
    } catch (error) {
            console.warn(`âŒ Save attempt ${attempt}/${maxRetries} failed:`, error.message);
            
            if (attempt === maxRetries) {
                throw new Error(`Failed to save after ${maxRetries} attempts: ${error.message}`);
            }
            
            // Wait before retrying (exponential backoff)
            await new Promise(resolve => setTimeout(resolve, delay * attempt));
        }
    }
}

// ========================================
// Generic CRUD Operations
// ========================================

/**
 * @description Save data to specified IndexedDB store
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @param {Object} data - Data object to save (must have 'id' property)
 * @returns {Promise<void>} Promise that resolves when save is complete
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * await saveToStore('pcs', { id: 'pc-123', company_name: 'Acme Corp' });
 */
async function saveToStore(storeName, data) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

/**
 * @description Load a single record from IndexedDB store by ID
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @param {string} id - Unique identifier for the record
 * @returns {Promise<Object|undefined>} Promise that resolves to the record or undefined if not found
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * const pc = await loadFromStore('pcs', 'pc-123');
 * if (pc) console.log('Found PC:', pc.company_name);
 */
async function loadFromStore(storeName, id) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(id);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

/**
 * @description Load all records from an IndexedDB store
 * @async
 * @param {string} storeName - Name of the IndexedDB store
 * @returns {Promise<Array>} Promise that resolves to array of all records in the store
 * @throws {Error} If transaction fails or store doesn't exist
 * @example
 * const allPCs = await loadAllFromStore('pcs');
 * console.log(`Found ${allPCs.length} PC numbers`);
 */
async function loadAllFromStore(storeName) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

async function deleteFromStore(storeName, id) {
    return new Promise((resolve, reject) => {
        const transaction = dbConnection.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Load all data into memory cache for UI compatibility
async function loadDataFromIndexedDB() {
    try {
        const [pcs, quotes, activities, resources, priceLists, templates, activityTemplates] = await Promise.all([
            loadAllFromStore(STORES.PCS),
            loadAllFromStore(STORES.QUOTES),
            loadAllFromStore(STORES.ACTIVITIES), 
            loadAllFromStore(STORES.RESOURCES),
            loadAllFromStore(STORES.PRICE_LISTS),
            loadAllFromStore(STORES.TEMPLATES), // Sprint 3.3: Load templates
            loadAllFromStore(STORES.ACTIVITY_TEMPLATES) // NEW Sprint 4.1: Load activity templates
        ]);
        
        db = {
            pcs: pcs || [],
            quotes: quotes || [],
            activities: activities || [],
            resources: resources || [],
            priceLists: priceLists || [],
            templates: templates || [], // Sprint 3.3: Templates storage
            activityTemplates: activityTemplates || [], // NEW Sprint 4.1: Activity templates storage
            // Compatibility fields
            currentPC: null,
            currentQuote: null,
            currentActivity: null,
            currentPriceList: null,
            currentResource: null,
            editingPC: null,
            editingQuote: null,
            editingActivity: null,
            editingResource: null,
            selectedPriceListId: null,
            quoteItems: { human: [], vehicles: [], materials: [], other: [] }
        };
        
        console.log('ðŸ“¦ Data loaded from IndexedDB:', {
            pcs: db.pcs.length,
            quotes: db.quotes.length,
            activities: db.activities.length,
            resources: db.resources.length,
            priceLists: db.priceLists.length,
            templates: db.templates.length, // Sprint 3.3: Include templates in logging
            activityTemplates: db.activityTemplates.length // NEW Sprint 4.1: Include activity templates in logging
        });
        
        if (db.pcs.length === 0) {
            console.log('ðŸŒ± No data found, initializing with demo data.');
            await initializeWithDemoData();
        }
        
        // ðŸš€ NEW: Emit data:loaded event for automatic UI updates
        if (typeof CRM !== 'undefined' && CRM.EventBus) {
            await CRM.EventBus.emit('data:loaded', {
                pcs: db.pcs.length,
                quotes: db.quotes.length,
                activities: db.activities.length,
                resources: db.resources.length,
                priceLists: db.priceLists.length,
                templates: db.templates.length,
                activityTemplates: db.activityTemplates.length
            }, { continueOnError: true });
        }
    } catch (error) {
        console.error('âŒ Error loading from IndexedDB:', error);
        throw error;
    }
}

// Save data back to IndexedDB
async function saveDataToIndexedDB() {
    try {
        // Save all arrays back to their respective stores
        const savePromises = [
            ...db.pcs.map(pc => saveToStore(STORES.PCS, pc)),
            ...db.quotes.map(quote => saveToStore(STORES.QUOTES, quote)),
            ...db.activities.map(activity => saveToStore(STORES.ACTIVITIES, activity)),
            ...db.resources.map(resource => saveToStore(STORES.RESOURCES, resource)),
            ...db.priceLists.map(priceList => saveToStore(STORES.PRICE_LISTS, priceList)),
            ...db.templates.map(template => saveToStore(STORES.TEMPLATES, template)), // Sprint 3.3: Save templates
            ...db.activityTemplates.map(activityTemplate => saveToStore(STORES.ACTIVITY_TEMPLATES, activityTemplate)) // NEW Sprint 4.1: Save activity templates
        ];
        
        await Promise.all(savePromises);
        console.log('ðŸ’¾ Data saved to IndexedDB successfully');
    } catch (error) {
        console.error('âŒ Error saving to IndexedDB:', error);
        throw error;
    }
}

async function initializeWithDemoData() {
    console.log('ðŸŒ± Starting demo data initialization...');
    const now = new Date().toISOString();
    const today = new Date().toISOString().split('T')[0];
    
    // Generate UUIDs for demo data
    const demoUUIDs = {
        pc1: generateUUID(),
        pc2: generateUUID(),
        res1: generateUUID(),
        res2: generateUUID(),
        res3: generateUUID(),
        res4: generateUUID(),
        res5: generateUUID(),
        pl1: generateUUID(),
        q1: generateUUID(),
        q2: generateUUID(), // NEW Sprint 2: Second demo quote
        act1: generateUUID(),
        act2: generateUUID()
    };
    
    // Enhanced PC Numbers with full specification fields
    const demoPCs = [
        {
            id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            project_name: 'Office Refurbishment Phase 2',
            project_description: 'Complete electrical rewiring and lighting upgrade for main office building including installation of modern LED systems and emergency lighting.',
            account_manager: 'John Smith',
            // NEW FIELDS according to system_improvements.md:
            client_industry: 'Education', // single-select: Media, Education, Healthcare, etc.
            client_source: 'Business Development', // merged: Web Enquiry, Business Development, Existing Customer, Cross Referral, Internal (CWS/Crown)
            quote_limit: 5, // default quote limit control
            // SIMPLIFIED CONTACT (minimum: phone OR email + contact name):
            contact_name: 'Sarah Williams',
            contact_phone: '01216549870', 
            contact_email: 'sarah.w@acme.com',
            // OPTIONAL POSTCODE (if address needed):
            postcode: 'B1 1AA',
            // NOTE: collection/delivery addresses REMOVED - will be moved to Quote section
            status: 'active',
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Globex Industries Ltd',
            project_name: 'Warehouse Lighting Upgrade',
            project_description: 'Replacement of old fluorescent lighting with energy-efficient LED lighting throughout the main warehouse facility.',
            account_manager: 'Anna Brown',
            // NEW FIELDS according to system_improvements.md:
            client_industry: 'Healthcare', // single-select: Media, Education, Healthcare, etc.
            client_source: 'Existing Customer', // merged field
            quote_limit: 3, // different limit for this client
            // SIMPLIFIED CONTACT (minimum: phone OR email + contact name):
            contact_name: 'James Roberts',
            contact_phone: '01619876543',
            contact_email: 'james.r@globex.com',
            // OPTIONAL POSTCODE:
            postcode: 'M2 3CC',
            // NOTE: collection/delivery addresses REMOVED - will be moved to Quote section
            status: 'active',
            created_at: now,
            updated_at: now
        }
    ];
    
    // Enhanced Resources with supplier information
    const demoResources = [
        {
            id: demoUUIDs.res1,
            name: 'LED Downlight - 10W Cool White',
            description: 'Energy efficient LED downlight with 10W power consumption, cool white temperature (4000K), suitable for commercial installations.',
            category: 'lighting',
            subcategory: 'downlights',
            sku: 'LED-DL-10W-CW',
            unit: 'each',
            net_cost: 25.00,
            supplier: 'Electrical Supplies Ltd',
            supplier_code: 'ESL-LED-001',
            is_active: true,
            min_quantity: 10,
            lead_time_days: 5,
            weight_kg: 0.150,
            dimensions: '85mm diameter x 25mm depth',
            warranty_months: 24,
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.res2,
            name: 'Electrician - Senior Level',
            description: 'Qualified electrician with 5+ years commercial experience',
            category: 'labour',
            subcategory: 'installation',
            sku: 'LAB-ELEC-SR',
            unit: 'hour',
            net_cost: 45.00,
            supplier: 'Internal',
            supplier_code: null,
            is_active: true,
            min_quantity: 1,
            lead_time_days: 0,
            weight_kg: null,
            dimensions: null,
            warranty_months: null,
            created_at: now,
            updated_at: now
        }
    ];
    
    // Enhanced Price Lists with versioning
    const demoPriceLists = [
        {
            id: demoUUIDs.pl1,
            name: 'Standard Commercial Rates 2024',
            version: 'v2.1',
            description: 'Updated rates for commercial electrical projects including new LED technology pricing',
            effective_from: '2024-01-01',
            effective_to: '2024-12-31',
            is_default: true,
            markup_percentage: 35.00,
            discount_percentage: 0.00,
            currency: 'GBP',
            pricing_data: {
                [demoUUIDs.res1]: { price: 35.00, markup_percentage: 40.00, effective_price: 35.00, min_quantity: 10 },
                [demoUUIDs.res2]: { price: 65.00, markup_percentage: 44.44, effective_price: 65.00, min_quantity: 1 }
            },
            terms: 'Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.',
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 3.3: Demo Templates
    const demoTemplates = [
        {
            id: generateUUID(),
            name: 'Standard Office Lighting',
            category: 'lighting',
            description: 'Standard LED lighting package for office environments including downlights and emergency lighting',
            status: 'active',
            vat_rate: 20.00,
            terms_conditions: 'Payment terms: 30 days net. All work carried out to BS 7671 standards. Materials warranty as per manufacturer specifications.',
            items: [
                {
                    resource_id: demoUUIDs.res1,
                    resource_name: 'LED Downlight - 10W Cool White',
                    quantity: 25,
                    unit_price: 35.00,
                    line_total: 875.00,
                    notes: 'Standard office application'
                }
            ],
            estimated_value: 1050.00, // Including VAT
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'Warehouse High Bay Lighting',
            category: 'lighting',
            description: 'High bay LED lighting solution for warehouse and industrial applications',
            status: 'active',
            vat_rate: 20.00,
            terms_conditions: 'Payment terms: 30 days net. Suitable for heights 6-12m. IP65 rated for harsh environments.',
            items: [
                {
                    resource_id: demoUUIDs.res2,
                    resource_name: 'LED High Bay Light - 150W',
                    quantity: 10,
                    unit_price: 42.50,
                    line_total: 425.00,
                    notes: 'Industrial grade for warehouse use'
                }
            ],
            estimated_value: 510.00, // Including VAT
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 4.1: Demo Activity Templates
    const demoActivityTemplates = [
        {
            id: generateUUID(),
            name: 'Standard Site Survey',
            category: 'survey',
            description: 'Comprehensive site survey to assess electrical requirements and plan installation work',
            priority: 'medium',
            duration_hours: 2.0,
            status: 'active',
            assigned_to_default: 'Mike Johnson',
            schedule_offset_days: 1,
            pre_activity_checklist: 'â€¢ Confirm appointment with client\nâ€¢ Prepare tools and equipment (multimeter, camera, measuring tape)\nâ€¢ Review site access instructions\nâ€¢ Check weather conditions for external work\nâ€¢ Prepare survey forms and documentation',
            completion_notes_template: 'Site survey completed successfully.\n\nKey findings:\nâ€¢ Existing electrical infrastructure: [DESCRIBE]\nâ€¢ Power supply capacity: [CAPACITY]\nâ€¢ Access arrangements: [ACCESS DETAILS]\n\nRecommendations:\nâ€¢ [RECOMMENDATION 1]\nâ€¢ [RECOMMENDATION 2]\n\nNext steps:\nâ€¢ Prepare detailed quote\nâ€¢ Schedule installation if approved',
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'LED Installation - Standard',
            category: 'installation',
            description: 'Standard LED lighting installation for offices and commercial spaces',
            priority: 'high',
            duration_hours: 4.0,
            status: 'active',
            assigned_to_default: 'Alex Smith',
            schedule_offset_days: 7,
            pre_activity_checklist: 'â€¢ Confirm all materials delivered to site\nâ€¢ Check power isolation arrangements\nâ€¢ Verify access equipment (ladders, lifts)\nâ€¢ Review health & safety requirements\nâ€¢ Contact client 24h before arrival',
            completion_notes_template: 'LED installation completed successfully.\n\nWork completed:\nâ€¢ Number of fixtures installed: [COUNT]\nâ€¢ Total power consumption: [WATTS]\nâ€¢ Testing results: All circuits tested and certified\n\nQuality checks:\nâ€¢ All connections secure: âœ“\nâ€¢ Light levels measured: âœ“\nâ€¢ Emergency lighting tested: âœ“\nâ€¢ Client handover completed: âœ“\n\nCompletion certificate issued: [CERT_NUMBER]',
            created_at: now,
            updated_at: now
        },
        {
            id: generateUUID(),
            name: 'Periodic Testing & Inspection',
            category: 'testing',
            description: 'Regular electrical testing and inspection as per BS 7671 requirements',
            priority: 'medium',
            duration_hours: 3.0,
            status: 'active',
            assigned_to_default: null,
            schedule_offset_days: 0,
            pre_activity_checklist: 'â€¢ Bring testing equipment (PAT, insulation tester, RCD tester)\nâ€¢ Prepare inspection forms and certificates\nâ€¢ Coordinate with client for power isolation\nâ€¢ Review previous test certificates\nâ€¢ Plan testing sequence to minimize disruption',
            completion_notes_template: 'Electrical testing and inspection completed.\n\nTests performed:\nâ€¢ Continuity testing: [RESULT]\nâ€¢ Insulation resistance: [RESULT]\nâ€¢ RCD testing: [RESULT]\nâ€¢ Visual inspection: [RESULT]\n\nIssues identified:\nâ€¢ [ISSUE 1 - PRIORITY]\nâ€¢ [ISSUE 2 - PRIORITY]\n\nRecommendations:\nâ€¢ [RECOMMENDATION 1]\nâ€¢ [RECOMMENDATION 2]\n\nCertificate issued: [CERT_NUMBER]\nNext test due: [DATE]',
            created_at: now,
            updated_at: now
        }
    ];
    console.log('âœ… Activity templates generated successfully');
    
    // Enhanced Quotes with proper structure
    const demoQuotes = [
        {
            id: demoUUIDs.q1,
            quote_number: 'QT-000001',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            title: 'Office Refurbishment - Electrical Works',
            description: 'Supply and installation of LED lighting system including downlights, emergency lighting and associated electrical work.',
            status: 'ISSUED', // NEW Sprint 2: Updated status workflow
            valid_until: '2024-05-15',
            subtotal: 1750.00,
            vat_rate: 20.00,
            vat_amount: 350.00,
            total_cost: 2100.00,
            notes: 'Client requested delivery in phases to minimize disruption to operations.',
            terms_conditions: 'Payment terms: 30 days net. All work carried out to BS 7671 standards. Materials warranty as per manufacturer specifications.',
            line_items: [
                {
                    resource_id: demoUUIDs.res1,
                    resource_name: 'LED Downlight - 10W Cool White',
                    quantity: 50,
                    unit_price: 35.00,
                    line_total: 1750.00,
                    notes: 'Cool white temperature specified by client'
                }
            ],
            
            // NEW Sprint 2: Move Type & Address fields
            move_type: 'Collection + Delivery',
            
            // Collection address
            collection_contact_name: 'Sarah Williams',
            collection_phone: '01216549870',
            collection_email: 'sarah.w@acme.com',
            collection_date: '2024-04-15',
            collection_address_1: '123 High Street',
            collection_address_2: 'Industrial Estate',
            collection_city: 'Birmingham',
            collection_county: 'West Midlands',
            collection_postcode: 'B1 1AA',
            
            // Delivery address
            delivery_contact_name: 'Mark Thompson',
            delivery_phone: '01234567890',
            delivery_email: 'mark.t@newsite.com',
            delivery_date: '2024-04-20',
            delivery_address_1: '456 New Road',
            delivery_address_2: 'Business Park',
            delivery_city: 'Manchester',
            delivery_county: 'Greater Manchester',
            delivery_postcode: 'M1 2BB',
            
            // Quoted Activities (linked to demo activities)
            quoted_activities: [demoUUIDs.act1],
            
            created_at: now,
            updated_at: now
        },
        {
            id: demoUUIDs.q2,
            quote_number: 'QT-000002',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Globex Industries Ltd',
            title: 'Warehouse Lighting - Supply Only',
            description: 'Supply of LED high bay lights for warehouse facility. Client to arrange own installation.',
            status: 'DRAFT', // Different status for demonstration
            valid_until: '2024-06-01',
            subtotal: 850.00,
            vat_rate: 20.00,
            vat_amount: 170.00,
            total_cost: 1020.00,
            notes: 'Supply only quote. Client has their own electricians.',
            terms_conditions: 'Payment terms: 30 days net. Collection from our warehouse.',
            line_items: [
                {
                    resource_id: demoUUIDs.res2,
                    resource_name: 'LED High Bay Light - 150W',
                    quantity: 20,
                    unit_price: 42.50,
                    line_total: 850.00,
                    notes: 'Industrial grade for warehouse use'
                }
            ],
            
            // NEW Sprint 2: Different move type example
            move_type: 'Collection Only',
            
            // Collection address only (no delivery)
            collection_contact_name: 'James Roberts',
            collection_phone: '01619876543',
            collection_email: 'james.r@globex.com',
            collection_date: '2024-04-25',
            collection_address_1: '789 Industrial Road',
            collection_address_2: null,
            collection_city: 'Manchester',
            collection_county: 'Greater Manchester',
            collection_postcode: 'M2 3CC',
            
            // No delivery address (Collection Only)
            delivery_contact_name: null,
            delivery_phone: null,
            delivery_email: null,
            delivery_date: null,
            delivery_address_1: null,
            delivery_address_2: null,
            delivery_city: null,
            delivery_county: null,
            delivery_postcode: null,
            
            // Quoted Activities (linked to different activity)
            quoted_activities: [demoUUIDs.act2],
            
            created_at: now,
            updated_at: now
        }
    ];
    
    // NEW Sprint 4.2.4: Helper functions for generating demo dates
    function getTodayString() {
        return new Date().toISOString().split('T')[0];
    }
    
    function getTomorrowString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow.toISOString().split('T')[0];
    }
    
    function getNextWeekdayDate(daysFromToday) {
        const date = new Date();
        date.setDate(date.getDate() + daysFromToday);
        return date.toISOString().split('T')[0];
    }
    
    function getFirstDayOfNextMonth() {
        const date = new Date();
        date.setMonth(date.getMonth() + 1);
        date.setDate(1);
        return date.toISOString().split('T')[0];
    }

    // Enhanced Activities with scheduling
    const demoActivities = [
        {
            id: demoUUIDs.act1,
            title: 'Site Survey - Electrical Assessment',
            description: 'Initial site survey to assess existing electrical infrastructure and plan LED lighting installation.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            type: 'survey',
            status: 'completed',
            priority: 'high',
            scheduled_date: '2024-04-08',
            scheduled_time: '09:30:00',
            estimated_hours: 3.0,
            assigned_to: 'tm1',
            location: 'Client Site - Birmingham',
            contact_name: 'Sarah Williams',
            contact_phone: '07123456789',
            completion_notes: 'Survey completed successfully. Existing electrical infrastructure adequate for LED upgrade. Access arrangements confirmed with site contact.',
            completed_at: '2024-04-08T12:30:00.000Z',
            created_date: '2024-04-08',
            is_recurring: false
        },
        // NEW Sprint 4.2.4: Demo Recurring Activities - Weekly Safety Inspections
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(0), // Monday
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 1,
            recurring_config: {
                frequency: 'weekly',
                interval: 1,
                count: 12
            },
            created_date: getTodayString(),
            is_recurring: true
        },
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(7), // Next Monday
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 2,
            created_date: getTodayString(),
            is_recurring: true
        },
        {
            id: generateUUID(),
            title: 'Weekly Safety Inspection',
            description: 'Regular safety inspection of ongoing construction sites to ensure compliance with safety protocols.',
            pc_id: demoUUIDs.pc1,
            pc_number: 'PC-000001',
            company_name: 'Acme Construction Ltd',
            status: 'scheduled',
            priority: 'normal',
            scheduled_date: getNextWeekdayDate(14), // Monday after next
            scheduled_time: '09:00',
            estimated_hours: 2.0,
            assigned_to: 'tm2',
            recurring_series_id: 'series-safety-1',
            recurring_sequence: 3,
            created_date: getTodayString(),
            is_recurring: true
        },
        // NEW Sprint 4.2.4: Demo Recurring Activities - Monthly Equipment Maintenance
        {
            id: generateUUID(),
            title: 'Equipment Maintenance Check',
            description: 'Monthly maintenance and calibration of LED installation equipment.',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Tech Solutions Inc',
            status: 'scheduled',
            priority: 'high',
            scheduled_date: getFirstDayOfNextMonth(),
            scheduled_time: '14:00',
            estimated_hours: 4.0,
            assigned_to: 'tm3',
            recurring_series_id: 'series-maintenance-1',
            recurring_sequence: 1,
            recurring_config: {
                frequency: 'monthly',
                interval: 1,
                count: 6
            },
            created_date: getTodayString(),
            is_recurring: true
        },
        // Regular non-recurring activity
        {
            id: generateUUID(),
            title: 'Client Meeting - Project Kickoff',
            description: 'Initial project kickoff meeting to discuss requirements and timeline.',
            pc_id: demoUUIDs.pc2,
            pc_number: 'PC-000002',
            company_name: 'Tech Solutions Inc',
            status: 'scheduled',
            priority: 'high',
            scheduled_date: getTomorrowString(),
            scheduled_time: '10:30',
            estimated_hours: 1.5,
            assigned_to: 'tm1',
            created_date: getTodayString(),
            is_recurring: false
        }
    ];
    console.log('âœ… All demo data structures created successfully');
    
    // Set data in memory cache
    console.log('ðŸ“¦ Assigning demo data to db object...');
    db = {
        pcs: demoPCs,
        quotes: demoQuotes,
        activities: demoActivities,
        resources: demoResources,
        priceLists: demoPriceLists,
        templates: demoTemplates, // Sprint 3.3: Templates demo data
        activityTemplates: demoActivityTemplates, // NEW Sprint 4.1: Activity templates demo data
        // Compatibility fields
        currentPC: null,
        currentQuote: null,
        currentActivity: null,
        currentPriceList: null,
        currentResource: null,
        editingPC: null,
        editingQuote: null,
        editingActivity: null,
        editingResource: null,
        selectedPriceListId: null,
        quoteItems: { human: [], vehicles: [], materials: [], other: [] }
    };
    console.log('âœ… Demo data assigned to db object successfully');
    
    // Save to IndexedDB
    console.log('ðŸ’¾ Saving demo data to IndexedDB...');
    await saveDataToIndexedDB();
    console.log('âœ… Demo data initialized successfully');
}

async function resetData() {
    if (confirm('Are you sure you want to delete all demo data and start over? This operation is irreversible.')) {
        try {
            // Clear IndexedDB
            if (dbConnection) {
                dbConnection.close();
            }
            await new Promise((resolve, reject) => {
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                deleteRequest.onsuccess = () => resolve();
                deleteRequest.onerror = () => reject(deleteRequest.error);
            });
            console.log('ðŸ—‘ï¸ IndexedDB cleared successfully');
        location.reload();
        } catch (error) {
            console.error('âŒ Error clearing IndexedDB:', error);
            alert('Error clearing database. Please refresh the page manually.');
        }
    }
}

// ========================================
// SECURITY & SANITIZATION
// ========================================

/**
 * @description Escape HTML characters to prevent XSS attacks
 * @param {string} str - Raw string that may contain HTML
 * @returns {string} - HTML-escaped safe string
 * @example
 * sanitizeHTML('<script>alert("xss")<\/script>') // Returns: '&lt;script&gt;alert("xss")&lt;/script&gt;'
 */
function sanitizeHTML(str) {
    if (typeof str !== 'string') return '';
    
    return str
        .replace(/&/g, '&amp;')     // Must be first - escape ampersands
        .replace(/</g, '&lt;')      // Escape less-than signs
        .replace(/>/g, '&gt;')      // Escape greater-than signs
        .replace(/"/g, '&quot;')    // Escape double quotes
        .replace(/'/g, '&#x27;')    // Escape single quotes
        .replace(/\//g, '&#x2F;');  // Escape forward slashes
}

/**
 * @description Safe wrapper for setting innerHTML with HTML escaping
 * @param {HTMLElement} element - Target DOM element
 * @param {string} content - Content to set (will be HTML-escaped)
 */
function setSafeHTML(element, content) {
    if (!element) return;
    element.innerHTML = sanitizeHTML(content);
}

/**
 * @description Safe wrapper for building HTML templates with escaped content
 * @param {TemplateStringsArray} strings - Template literal strings
 * @param {...any} values - Values to be safely inserted
 * @returns {string} - Safe HTML string with escaped values
 */
function safeHTML(strings, ...values) {
    return strings.reduce((result, string, i) => {
        const value = values[i];
        const safeValue = value !== undefined ? sanitizeHTML(String(value)) : '';
        return result + string + safeValue;
    }, '');
}

// ========================================
// Nawigacja i UI
// ========================================

/**
 * @description Navigate to a specific page in the SPA, updating navigation and clearing edit states
 * @param {string} pageId - The ID of the page element to display
 * @example
 * showPage('dashboard'); // Shows dashboard page and updates navigation
 * showPage('pcnumbers'); // Shows PC Numbers page
 */
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const pageToNavMap = {
        'dashboard': 'dashboard', 'pcnumbers': 'pcnumbers', 'new-pc': 'pcnumbers', 'pc-detail': 'pcnumbers',
        'quotes': 'quotes', 'quote-builder': 'quotes', 'activities': 'activities', 'resources': 'resources',
        'resource-allocation': 'resource-allocation', 'analytics': 'analytics', 'pricelists': 'pricelists', 'new-pricelist': 'pricelists', 'pricelist-detail': 'pricelists'
    };
    const navButton = document.querySelector(`.nav-btn[onclick=\"app.showPage('${pageToNavMap[pageId]}')\"], .nav-btn[onclick=\"window.showPage('${pageToNavMap[pageId]}')\"]`);
    if (navButton) navButton.classList.add('active');

    // Reset stanÃ³w edycji przy zmianie strony (chyba, Å¼e idziemy do formularza)
    if (pageId !== 'new-pc') db.editingPC = null;
    if (pageId !== 'quote-builder') db.editingQuote = null;
    if (pageId !== 'new-pricelist') db.currentPriceList = null;
    
    // Clear PC form when going to new PC page
    if (pageId === 'new-pc' && !db.editingPC) {
        clearPCForm();
    }
    
    // Clear price list form when going to new price list page
    if (pageId === 'new-pricelist' && !document.getElementById('pricelist-id').value) {
        clearPriceListForm();
        // Set default effective date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pricelist-effective-from').value = today;
    }

    // OdÅ›wieÅ¼ widok
    switch(pageId) {
        case 'dashboard': updateDashboard(); break;
        case 'pcnumbers': renderPCList(); break;
        case 'quotes': renderQuotesList(); break;
        case 'activities': updateActivitiesList(); break;
        case 'resources': updateResourcesList(); break;
        case 'resource-allocation': updateResourceAllocationPage(); break; // NEW Sprint 4.3: Resource allocation page
        case 'analytics': updateAnalytics(); break; // NEW Sprint 4.5: Analytics page
        case 'pricelists': updatePriceListsTable(); break;
        case 'templates': updateTemplatesList(); break; // Sprint 3.3: Templates page
        case 'activity-templates': updateActivityTemplatesList(); break; // NEW Sprint 4.1: Activity templates page
    }
}

function clearPCForm() {
    document.getElementById('pc-form-title').textContent = 'New PC Number';
    document.getElementById('pc-id').value = '';
    
    // Main data fields
    document.getElementById('pc-number').value = '';
    document.getElementById('pc-company-name').value = '';
    document.getElementById('pc-project-name').value = '';
    document.getElementById('pc-project-description').value = '';
    document.getElementById('pc-account-manager').value = '';
    // NEW FIELDS:
    document.getElementById('pc-client-industry').value = '';
    document.getElementById('pc-client-source').value = '';
    document.getElementById('pc-quote-limit').value = '5';
    document.getElementById('pc-status').value = 'active';
    
    // SIMPLIFIED CONTACT FIELDS:
    document.getElementById('pc-contact-name').value = '';
    document.getElementById('pc-contact-phone').value = '';
    document.getElementById('pc-contact-email').value = '';
    document.getElementById('pc-postcode').value = '';
}

// ========================================
// Dashboard
// ========================================

function updateDashboard() {
    // Guard clause: ensure db is initialized
    if (!db || !db.pcs || !db.quotes || !db.activities) {
        console.warn('âš ï¸ updateDashboard called before db initialization');
        return;
    }
    
    document.getElementById('stat-pc').textContent = db.pcs.length;
    document.getElementById('stat-quotes').textContent = db.quotes.length;
    document.getElementById('stat-activities').textContent = db.activities.length;
    const totalValue = db.quotes.reduce((sum, q) => sum + (q.total || 0), 0);
    document.getElementById('stat-value').textContent = 'Â£' + totalValue.toFixed(2);
    
    const recentPCBody = document.getElementById('recent-pc');
    recentPCBody.innerHTML = '';
    db.pcs.slice(-5).reverse().forEach(pc => {
        const pcNumber = sanitizeHTML(pc.pc_number || pc.number);
        const companyName = sanitizeHTML(pc.company_name || pc.company);
        const projectName = sanitizeHTML(pc.project_name || pc.reference || '-');
        recentPCBody.innerHTML += `<tr><td>${pcNumber}</td><td>${companyName}</td><td>${projectName}</td></tr>`;
    });
}

// ========================================
// Numery PC
// ========================================

function renderPCList() {
    // Guard clause: ensure db is initialized
    if (!db || !db.pcs) {
        console.warn('âš ï¸ renderPCList called before db initialization');
        return;
    }
    
    const tbody = document.getElementById('pc-list');
    tbody.innerHTML = '';
    db.pcs.forEach(pc => {
        const pcNumber   = sanitizeHTML(pc.pc_number || pc.number);
        const companyName = sanitizeHTML(pc.company_name || pc.company);
        const projectName = sanitizeHTML(pc.project_name || pc.reference || '-');
        const contact    = sanitizeHTML([pc.collection_first_name, pc.collection_surname].filter(Boolean).join(' ') || pc.contactPerson || '-');

        tbody.innerHTML += `<tr>
            <td>${pcNumber}</td>
            <td>${companyName}</td>
            <td>${projectName}</td>
            <td>${contact}</td>
            <td><div class="action-btn-group">
                <button onclick="window.viewPC('${pc.id}')" class="secondary">Show</button>
                <button onclick="window.editPC('${pc.id}')" class="warning">Edit</button>
            </div></td>
        </tr>`;
    });
}

/**
 * @description Save or update a PC Number record from form data
 * @async
 * @throws {Error} If form validation fails or database save fails
 * @example
 * // Called when user clicks "Save PC Number" button
 * await savePC(); // Validates form, saves to database, redirects to list
 */
async function savePC() {
    const id = document.getElementById('pc-id').value;
    const now = new Date().toISOString();
    
    const pcData = {
        pc_number: document.getElementById('pc-number').value.trim(),
        company_name: document.getElementById('pc-company-name').value.trim(),
        project_name: document.getElementById('pc-project-name').value.trim(),
        project_description: document.getElementById('pc-project-description').value.trim(),
        account_manager: document.getElementById('pc-account-manager').value.trim(),
        // NEW FIELDS according to system_improvements.md:
        client_industry: document.getElementById('pc-client-industry').value,
        client_source: document.getElementById('pc-client-source').value,
        quote_limit: parseInt(document.getElementById('pc-quote-limit').value) || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT,
        status: document.getElementById('pc-status').value,
        
        // SIMPLIFIED CONTACT FIELDS:
        contact_name: document.getElementById('pc-contact-name').value.trim(),
        contact_phone: document.getElementById('pc-contact-phone').value.trim(),
        contact_email: document.getElementById('pc-contact-email').value.trim(),
        postcode: document.getElementById('pc-postcode').value.trim(),
        
        updated_at: now
    };

    // ðŸš€ NEW: Enhanced validation with ErrorHandler
    // Required: PC Number, Company Name, Project Name, Account Manager, Client Industry, Client Source, Contact Name
    if (!pcData.pc_number || !pcData.company_name || !pcData.project_name || !pcData.account_manager || !pcData.client_industry || !pcData.client_source || !pcData.contact_name) {
        CRM.ErrorHandler.showUserMessage('validation', 
            'Required fields: PC Number, Company Name, Project Name, Account Manager, Client Industry, Client Source, and Contact Name',
            { context: 'PC Creation' }
        );
        return;
    }

    // Contact validation
    if (!pcData.contact_phone && !pcData.contact_email) {
        CRM.ErrorHandler.showUserMessage('validation',
            'Please provide either Phone OR Email for contact information',
            { context: 'PC Creation' }
        );
        return;
    }
    
    // Quote limit validation - business rule
    const existingQuotes = db.quotes.filter(q => q.pc_id === (id || 'new')).length;
    if (existingQuotes >= pcData.quote_limit && !id) {
        CRM.ErrorHandler.showUserMessage('business',
            `Quote limit (${pcData.quote_limit}) would be exceeded for this PC Number`,
            { context: 'PC Creation' }
        );
        return;
    }

        try {
        // ðŸš€ NEW: Use Data Access Layer instead of manual db manipulation
        const savedPC = id ? 
            await CRM.DataAccess.update('pc', id, pcData) :
            await CRM.DataAccess.save('pc', pcData);
        
        // ðŸš€ NEW: Use ErrorHandler for success messages
        CRM.ErrorHandler.showSuccess(
            `PC Number ${savedPC.pc_number} saved successfully!`,
            'PC Management'
        );
        
        showPage('pcnumbers');
    } catch (error) {
        // ðŸš€ NEW: Enhanced error handling with ErrorHandler
        // Note: DAL already handles the error, but we can add context-specific handling
        if (error.message?.includes('required')) {
            CRM.ErrorHandler.showUserMessage('validation', 
                'Please fill in all required fields before saving.',
                { context: 'PC Creation' }
            );
        } else {
            CRM.ErrorHandler.showUserMessage('database',
                'Unable to save PC Number. Please try again.',
                { context: 'PC Creation' }
            );
        }
    }
}

async function editPC(id) {
    // ðŸš€ NEW: Use Data Access Layer for data retrieval
    try {
        const pc = await CRM.DataAccess.findById('pc', id);
        if (!pc) {
            console.warn(`âš ï¸ PC with ID ${id} not found`);
            alert('PC Number not found!');
            return;
        }
        
    db.editingPC = pc;
        
        document.getElementById('pc-form-title').textContent = 'Edit PC Number';
    document.getElementById('pc-id').value = pc.id;
        
        // Main data fields
        document.getElementById('pc-number').value = pc.pc_number || '';
        document.getElementById('pc-company-name').value = pc.company_name || '';
        document.getElementById('pc-project-name').value = pc.project_name || '';
        document.getElementById('pc-project-description').value = pc.project_description || '';
        document.getElementById('pc-account-manager').value = pc.account_manager || '';
        // NEW FIELDS:
        document.getElementById('pc-client-industry').value = pc.client_industry || '';
        document.getElementById('pc-client-source').value = pc.client_source || '';
        document.getElementById('pc-quote-limit').value = pc.quote_limit || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT;
        document.getElementById('pc-status').value = pc.status || 'active';
        
        // SIMPLIFIED CONTACT FIELDS:
        document.getElementById('pc-contact-name').value = pc.contact_name || '';
        document.getElementById('pc-contact-phone').value = pc.contact_phone || '';
        document.getElementById('pc-contact-email').value = pc.contact_email || '';
        document.getElementById('pc-postcode').value = pc.postcode || '';
        
    showPage('new-pc');
    } catch (error) {
        // ðŸš€ NEW: Enhanced error handling from DAL
        console.error('âŒ Error loading PC for edit:', error);
        alert(`Error loading PC: ${error.message}`);
    }
}



function viewPC(id) {
    const pc = db.pcs.find(p => p.id === id);
    if (!pc) return;
    db.currentPC = pc;
    
    document.getElementById('pc-detail-title').textContent = `Details: ${pc.pc_number || pc.number}`;
    
    // Main data
    document.getElementById('pc-detail-number').textContent = pc.pc_number || pc.number || '-';
    document.getElementById('pc-detail-company-name').textContent = pc.company_name || pc.company || '-';
    document.getElementById('pc-detail-project-name').textContent = pc.project_name || pc.reference || '-';
    document.getElementById('pc-detail-account-manager').textContent = pc.account_manager || '-';
    // NEW FIELDS:
    document.getElementById('pc-detail-client-industry').textContent = pc.client_industry || '-';
    document.getElementById('pc-detail-client-source').textContent = pc.client_source || '-';
    document.getElementById('pc-detail-quote-limit').textContent = pc.quote_limit || CONFIG.BUSINESS.DEFAULT_QUOTE_LIMIT;
    document.getElementById('pc-detail-status').textContent = pc.status || 'active';
    document.getElementById('pc-detail-project-description').textContent = pc.project_description || '-';
    
    // SIMPLIFIED CONTACT:
    document.getElementById('pc-detail-contact-name').textContent = pc.contact_name || pc.contactPerson || '-';
    document.getElementById('pc-detail-contact-phone').textContent = pc.contact_phone || pc.mobilePhone || '-';
    document.getElementById('pc-detail-contact-email').textContent = pc.contact_email || pc.email || '-';
    document.getElementById('pc-detail-postcode').textContent = pc.postcode || '-';

    const quotesTbody = document.getElementById('pc-quotes');
    quotesTbody.innerHTML = '';
    db.quotes.filter(q => (q.pc_id === id || q.pcId === id)).forEach(q => {
        const quoteNumber = sanitizeHTML(q.quote_number || q.number);
        const totalCost = q.total_cost || q.total || 0;
        const quoteTitle = sanitizeHTML(q.title || 'v' + (q.version || 1));
        const quoteStatus = sanitizeHTML(q.status);
        const validUntil = q.valid_until ? sanitizeHTML(` (Valid until: ${new Date(q.valid_until).toLocaleDateString()})`) : '';
        
        quotesTbody.innerHTML += `<tr>
            <td>${quoteNumber}</td>
            <td>${quoteTitle}</td>
            <td>Â£${totalCost.toFixed(2)}</td>
            <td>${quoteStatus}${validUntil}</td>
            <td><button onclick="alert('Feature under development')">Show</button></td>
        </tr>`;
    });

    const activitiesTbody = document.getElementById('pc-activities');
    activitiesTbody.innerHTML = '';
    db.activities.filter(a => a.pcId === id).forEach(a => {
        const crmId = sanitizeHTML(String(a.crmId));
        const activityType = sanitizeHTML(a.type);
        const activityDate = sanitizeHTML(new Date(a.date).toLocaleDateString());
        const activityStatus = sanitizeHTML(a.status);
        
        activitiesTbody.innerHTML += `<tr><td>${crmId}</td><td>${activityType}</td><td>${activityDate}</td><td>${activityStatus}</td>
        <td><button onclick="alert('Feature under development')">Show</button></td></tr>`;
    });

    showPage('pc-detail');
}

// ========================================
// Oferty
// ========================================

/**
 * @description Show the new quote creation modal with PC number selection dropdown
 * @example
 * showNewQuoteModal(); // Opens modal with all PC numbers for selection
 */
function showNewQuoteModal() {
    const pcSelect = document.getElementById('quote-modal-pc');
    pcSelect.innerHTML = '<option value="">Select PC Number...</option>';
    db.pcs.forEach(pc => {
        const pcId = sanitizeHTML(String(pc.id));
        const pcNumber = sanitizeHTML(pc.pc_number || pc.number);
        const companyName = sanitizeHTML(pc.company_name || pc.company);
        pcSelect.innerHTML += `<option value="${pcId}">${pcNumber} - ${companyName}</option>`;
    });
    document.getElementById('quote-modal').classList.add('active');
}

function closeQuoteModal() {
    document.getElementById('quote-modal').classList.remove('active');
}

function proceedToQuoteBuilder() {
    const pcId = document.getElementById('quote-modal-pc').value;
    if (!pcId) {
        alert('Please select PC number!');
        return;
    }
    db.currentPC = db.pcs.find(p => p.id === pcId);
    closeQuoteModal();
    createQuote();
}

function createQuote() {
    if (!db.currentPC) return;
    db.editingQuote = null;
    db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
    
    document.getElementById('quote-builder-title').textContent = `New Quote for: ${db.currentPC.pc_number || db.currentPC.number}`;
    const priceListSelect = document.getElementById('quote-price-list');
    priceListSelect.innerHTML = '<option value="">Select price list...</option>';
    db.priceLists.filter(pl => pl.status === 'active' || pl.is_default).forEach(pl => {
        priceListSelect.innerHTML += `<option value="${pl.id}">${pl.name}</option>`;
    });

    // Initialize quote fields with defaults
    const validUntilDate = new Date();
    validUntilDate.setDate(validUntilDate.getDate() + CONFIG.BUSINESS.DEFAULT_QUOTE_VALIDITY_DAYS);
    document.getElementById('quote-valid-until').value = validUntilDate.toISOString().split('T')[0];
    
    document.getElementById('quote-vat-rate').value = CONFIG.BUSINESS.DEFAULT_VAT_RATE.toFixed(2);
    document.getElementById('quote-title').value = '';
    document.getElementById('quote-description').value = '';
    document.getElementById('quote-notes').value = '';
    document.getElementById('quote-terms').value = CONFIG.BUSINESS.DEFAULT_TERMS;

    // NEW Sprint 2: Initialize status, address and move type fields
    document.getElementById('quote-status').value = 'DRAFT'; // Always start as DRAFT
    document.getElementById('quote-move-type').value = '';
    
    // Clear all address fields
    ['quote-collection-name', 'quote-collection-phone', 'quote-collection-email', 'quote-collection-date',
     'quote-collection-address1', 'quote-collection-address2', 'quote-collection-city', 'quote-collection-county', 'quote-collection-postcode',
     'quote-delivery-name', 'quote-delivery-phone', 'quote-delivery-email', 'quote-delivery-date',
     'quote-delivery-address1', 'quote-delivery-address2', 'quote-delivery-city', 'quote-delivery-county', 'quote-delivery-postcode'
    ].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });
    
    // Uncheck same address checkbox
    document.getElementById('quote-same-address').checked = false;
    
    // Hide address sections initially
    document.getElementById('collection-section').style.display = 'none';
    document.getElementById('delivery-section').style.display = 'none';
    
    // Populate quoted activities for current PC
    populateQuotedActivities();

    document.getElementById('quote-items-section').style.display = 'none';
    document.getElementById('price-list-selector').style.display = 'block';
    showPage('quote-builder');
}

function handlePriceListChange() {
    db.selectedPriceListId = document.getElementById('quote-price-list').value;
    if (db.selectedPriceListId) {
        document.getElementById('quote-items-section').style.display = 'grid';
        // WyczyÅ›Ä‡ istniejÄ…ce pozycje przy zmianie cennika
        db.quoteItems = { human: [], vehicles: [], materials: [], other: [] };
        document.getElementById('quote-human').innerHTML = '';
        document.getElementById('quote-vehicles').innerHTML = '';
        document.getElementById('quote-materials').innerHTML = '';
        document.getElementById('quote-other').innerHTML = '';
        calculateTotal();
    } else {
        document.getElementById('quote-items-section').style.display = 'none';
    }
}

function addLineItem(category) {
    const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
    if (!priceList) return;

    const priceListItems = Array.isArray(priceList.items) ? priceList.items : [];
    const categoryItems = priceListItems.filter(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        return resource && resource.category === category;
    });

    if (categoryItems.length === 0) {
        alert(`No resources in category "${category}" in this price list.`);
        return;
    }

    const lineId = 'line_' + Date.now();
    const container = document.getElementById('quote-' + category);
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line-item';
    lineDiv.id = lineId;

    let options = '<option value="">Select...</option>';
    categoryItems.forEach(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        options += `<option value="${resource.id}" data-price="${item.clientPrice}">${resource.name}</option>`;
    });

    lineDiv.innerHTML = `
        <input type="checkbox" class="line-item-checkbox" data-line-id="${lineId}" data-category="${category}" 
               onchange="window.updateBulkSelection()" style="margin-right: 0.5rem; transform: scale(1.2);">
        <select onchange="window.updateLinePrice('${lineId}', '${category}')">${options}</select>
        <input type="number" value="1" min="1" onchange="window.updateLineQty('${lineId}', '${category}')">
        <input type="text" readonly value="Â£0.00">
        <span class="line-item-total">Â£0.00</span>
        <button class="remove-btn" onclick="window.removeLine('${lineId}', '${category}')">Ã—</button>
    `;
    container.appendChild(lineDiv);
    db.quoteItems[category].push({ id: lineId, resourceId: '', name: '', qty: 1, rate: 0, total: 0 });
}

function updateLinePrice(lineId, category) {
    const line = document.getElementById(lineId);
    const select = line.querySelector('select');
    const option = select.options[select.selectedIndex];
    const price = parseFloat(option.dataset.price || 0);
    const resourceId = select.value;

    const item = db.quoteItems[category].find(i => i.id === lineId);
    if (item) {
        item.resourceId = resourceId;
        item.name = option.text;
        item.rate = price;
        line.querySelectorAll('input')[1].value = 'Â£' + price.toFixed(2);
        updateLineQty(lineId, category);
    }
}

function updateLineQty(lineId, category) {
    const line = document.getElementById(lineId);
    const qty = parseFloat(line.querySelectorAll('input')[0].value) || 1;
    const item = db.quoteItems[category].find(i => i.id === lineId);
    if(item) {
        item.qty = qty;
        item.total = item.qty * item.rate;
        line.querySelector('.line-item-total').textContent = 'Â£' + item.total.toFixed(2);
    }
    calculateTotal();
}

function removeLine(lineId, category) {
    document.getElementById(lineId).remove();
    db.quoteItems[category] = db.quoteItems[category].filter(i => i.id !== lineId);
    calculateTotal();
}


/**
 * @description Calculate and update quote totals for all categories including VAT
 * @description Updates DOM elements with calculated subtotals, VAT amount, and final total
 * @example
 * calculateTotal(); // Recalculates all quote totals and updates UI display
 */
function calculateTotal() {
    let totals = { human: 0, vehicles: 0, materials: 0, other: 0 };
    for (let cat in db.quoteItems) {
        db.quoteItems[cat].forEach(item => { totals[cat] += item.total; });
    }
    
    document.getElementById('sum-human').textContent = 'Â£' + totals.human.toFixed(2);
    document.getElementById('sum-vehicles').textContent = 'Â£' + totals.vehicles.toFixed(2);
    document.getElementById('sum-materials').textContent = 'Â£' + totals.materials.toFixed(2);
    document.getElementById('sum-other').textContent = 'Â£' + totals.other.toFixed(2);
    
    const subtotal = totals.human + totals.vehicles + totals.materials + totals.other;
    document.getElementById('sum-subtotal').textContent = 'Â£' + subtotal.toFixed(2);
    
    // Get configurable VAT rate
    const vatRateElement = document.getElementById('quote-vat-rate');
    const vatRate = vatRateElement ? parseFloat(vatRateElement.value) || 0 : 20;
    const vatAmount = subtotal * (vatRate / 100);
    const total = subtotal + vatAmount;
    
    // Update VAT amount display
    const vatAmountElement = document.getElementById('sum-vat');
    if (vatAmountElement) {
        vatAmountElement.textContent = 'Â£' + vatAmount.toFixed(2);
    }
    
    document.getElementById('sum-total').textContent = 'Â£' + total.toFixed(2);
}

// NEW Sprint 2 Functions: Address & Move Type handling
function toggleAddressSections() {
    const moveType = document.getElementById('quote-move-type').value;
    const collectionSection = document.getElementById('collection-section');
    const deliverySection = document.getElementById('delivery-section');
    
    // Hide both sections initially
    collectionSection.style.display = 'none';
    deliverySection.style.display = 'none';
    
    // Show sections based on move type
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        collectionSection.style.display = 'block';
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        deliverySection.style.display = 'block';
    }
    
    // Clear validation requirements when sections are hidden
    updateAddressValidation();
}

function copyCollectionToDelivery() {
    const checkbox = document.getElementById('quote-same-address');
    if (checkbox.checked) {
        // Copy collection data to delivery fields
        document.getElementById('quote-delivery-name').value = document.getElementById('quote-collection-name').value;
        document.getElementById('quote-delivery-phone').value = document.getElementById('quote-collection-phone').value;
        document.getElementById('quote-delivery-email').value = document.getElementById('quote-collection-email').value;
        document.getElementById('quote-delivery-date').value = document.getElementById('quote-collection-date').value;
        document.getElementById('quote-delivery-address1').value = document.getElementById('quote-collection-address1').value;
        document.getElementById('quote-delivery-address2').value = document.getElementById('quote-collection-address2').value;
        document.getElementById('quote-delivery-city').value = document.getElementById('quote-collection-city').value;
        document.getElementById('quote-delivery-county').value = document.getElementById('quote-collection-county').value;
        document.getElementById('quote-delivery-postcode').value = document.getElementById('quote-collection-postcode').value;
    }
}

function updateAddressValidation() {
    const moveType = document.getElementById('quote-move-type').value;
    const collectionFields = ['quote-collection-name', 'quote-collection-address1', 'quote-collection-city', 'quote-collection-postcode'];
    const deliveryFields = ['quote-delivery-name', 'quote-delivery-address1', 'quote-delivery-city', 'quote-delivery-postcode'];
    
    // Clear all required attributes first
    [...collectionFields, ...deliveryFields].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.removeAttribute('required');
    });
    
    // Set required based on move type
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        collectionFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.setAttribute('required', 'required');
        });
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        deliveryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.setAttribute('required', 'required');
        });
    }
}

function populateQuotedActivities() {
    const container = document.getElementById('quote-activities-multiselect');
    if (!db.currentPC) {
        container.innerHTML = '<p style="margin: 0; color: #666;">No PC selected</p>';
        return;
    }
    
    // Get activities for current PC
    const pcActivities = db.activities.filter(activity => 
        activity.pc_id === db.currentPC.id && activity.status !== 'cancelled'
    );
    
    if (pcActivities.length === 0) {
        container.innerHTML = '<p style="margin: 0; color: #666;">No activities found for this PC</p>';
        return;
    }
    
    // Create checkboxes for each activity
    container.innerHTML = pcActivities.map(activity => {
        const activityId = sanitizeHTML(String(activity.id));
        const activityTitle = sanitizeHTML(activity.title || activity.type);
        const activityDate = sanitizeHTML(activity.scheduled_date || 'No date');
        const activityStatus = sanitizeHTML(activity.status);
        
        return `
            <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                <input type="checkbox" value="${activityId}" onchange="window.updateQuotedActivities()" style="margin-right: 0.5rem;">
                <strong>${activityTitle}</strong> - ${activityDate} 
                <span style="color: #666;">(${activityStatus})</span>
            </label>
        `;
    }).join('');
}

function updateQuotedActivities() {
    // This function will be called when checkboxes change
    // The selected activities will be collected in saveQuote()
}

function handleQuoteStatusChange() {
    const status = document.getElementById('quote-status').value;
    const warningMessages = {
        'ISSUED': 'WARNING: Once marked as ISSUED, this quote cannot be edited!',
        'WON': 'FINAL STATE: Quote will be marked as WON and cannot be changed.',
        'LOST': 'FINAL STATE: Quote will be marked as LOST and cannot be changed.'
    };
    
    if (warningMessages[status]) {
        // Show warning but don't prevent selection
        setTimeout(() => alert(warningMessages[status]), 100);
    }
}

function validateQuoteEditability(quote) {
    // Check if quote can be edited based on status
    if (!quote || !quote.status) return true; // Default to editable for new quotes
    
    const nonEditableStatuses = ['ISSUED', 'WON', 'LOST'];
    return !nonEditableStatuses.includes(quote.status);
}

async function saveQuote() {
    if (!db.currentPC) return;
    
    const now = new Date().toISOString();
    const title = document.getElementById('quote-title').value.trim();
    const validUntil = document.getElementById('quote-valid-until').value;
    
    // NEW Sprint 2: Enhanced validation for move type and addresses
    const moveType = document.getElementById('quote-move-type').value;
    if (!title || !validUntil || !moveType) {
        alert('Quote title, valid until date, and move type are required!');
        return;
    }
    
    // Validate address fields based on move type
    let addressValidationError = '';
    if (moveType === 'Collection Only' || moveType === 'Collection + Delivery') {
        const collectionName = document.getElementById('quote-collection-name').value.trim();
        const collectionAddress1 = document.getElementById('quote-collection-address1').value.trim();
        const collectionCity = document.getElementById('quote-collection-city').value.trim();
        const collectionPostcode = document.getElementById('quote-collection-postcode').value.trim();
        
        if (!collectionName || !collectionAddress1 || !collectionCity || !collectionPostcode) {
            addressValidationError = 'Collection address: Contact name, address line 1, city, and postcode are required!';
        }
    }
    
    if (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') {
        const deliveryName = document.getElementById('quote-delivery-name').value.trim();
        const deliveryAddress1 = document.getElementById('quote-delivery-address1').value.trim();
        const deliveryCity = document.getElementById('quote-delivery-city').value.trim();
        const deliveryPostcode = document.getElementById('quote-delivery-postcode').value.trim();
        
        if (!deliveryName || !deliveryAddress1 || !deliveryCity || !deliveryPostcode) {
            addressValidationError = 'Delivery address: Contact name, address line 1, city, and postcode are required!';
        }
    }
    
    if (addressValidationError) {
        alert(addressValidationError);
        return;
    }
    
    const subtotal = parseFloat(document.getElementById('sum-subtotal').textContent.replace('Â£', ''));
    const vatRate = parseFloat(document.getElementById('quote-vat-rate').value) || 20;
    const vatAmount = subtotal * (vatRate / 100);
    const totalCost = subtotal + vatAmount;
    
    // Convert old-style items to new line_items structure
    const lineItems = [];
    for (let category in db.quoteItems) {
        db.quoteItems[category].forEach(item => {
            if (item.resourceId) {
                lineItems.push({
                    resource_id: item.resourceId,
                    resource_name: item.name,
                    quantity: item.qty,
                    unit_price: item.rate,
                    line_total: item.total,
                    notes: `Category: ${category}`
                });
            }
        });
    }
    
    const pcQuotes = db.quotes.filter(q => q.pc_id === db.currentPC.id || q.pcId === db.currentPC.id);
    const quote = {
        id: generateUUID(),
        quote_number: `QT-${String(db.quotes.length + 1).padStart(6, '0')}`,
        pc_id: db.currentPC.id,
        pc_number: db.currentPC.pc_number || db.currentPC.number,
        company_name: db.currentPC.company_name || db.currentPC.company,
        title: title,
        description: document.getElementById('quote-description').value.trim(),
        status: document.getElementById('quote-status').value, // NEW Sprint 2: Use selected status
        valid_until: validUntil,
        subtotal: subtotal,
        vat_rate: vatRate,
        vat_amount: vatAmount,
        total_cost: totalCost,
        notes: document.getElementById('quote-notes').value.trim(),
        terms_conditions: document.getElementById('quote-terms').value.trim(),
        line_items: lineItems,
        
        // NEW Sprint 2: Move Type & Address fields
        move_type: moveType,
        
        // Collection address (only if applicable)
        collection_contact_name: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-name').value.trim() : null,
        collection_phone: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-phone').value.trim() : null,
        collection_email: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-email').value.trim() : null,
        collection_date: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-date').value : null,
        collection_address_1: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-address1').value.trim() : null,
        collection_address_2: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-address2').value.trim() : null,
        collection_city: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-city').value.trim() : null,
        collection_county: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-county').value.trim() : null,
        collection_postcode: (moveType === 'Collection Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-collection-postcode').value.trim() : null,
        
        // Delivery address (only if applicable)
        delivery_contact_name: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-name').value.trim() : null,
        delivery_phone: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-phone').value.trim() : null,
        delivery_email: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-email').value.trim() : null,
        delivery_date: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-date').value : null,
        delivery_address_1: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-address1').value.trim() : null,
        delivery_address_2: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-address2').value.trim() : null,
        delivery_city: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-city').value.trim() : null,
        delivery_county: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-county').value.trim() : null,
        delivery_postcode: (moveType === 'Delivery Only' || moveType === 'Collection + Delivery') ? document.getElementById('quote-delivery-postcode').value.trim() : null,
        
        // Quoted Activities (selected activity IDs)
        quoted_activities: Array.from(document.querySelectorAll('#quote-activities-multiselect input[type="checkbox"]:checked')).map(cb => cb.value),
        
        created_at: now,
        updated_at: now
    };

        try {
        // Add quote to memory first
    db.quotes.push(quote);
        
        // Save to IndexedDB with retry logic
        await saveWithRetry(STORES.QUOTES, quote, 3);
        
        console.log('âœ… Quote saved successfully:', quote.quote_number);
        alert('Quote ' + quote.quote_number + ' has been saved!');
    viewPC(db.currentPC.id);
    } catch (error) {
        // Remove from memory if save failed
        db.quotes = db.quotes.filter(q => q.id !== quote.id);
        console.error('âŒ Error saving quote after retries:', error);
        alert('Failed to save quote after multiple attempts. Please check your connection and try again.');
    }
}

function cancelQuote() {
    if (confirm('Are you sure you want to cancel quote creation?')) {
        viewPC(db.currentPC.id);
    }
}

function renderQuotesList() {
    // Guard clause: ensure db is initialized
    if (!db || !db.quotes || !db.pcs) {
        console.warn('âš ï¸ renderQuotesList called before db initialization');
        return;
    }
    
    const tbody = document.getElementById('quotes-list');
    tbody.innerHTML = '';
    db.quotes.forEach(q => {
        const pc = db.pcs.find(p => p.id === (q.pc_id || q.pcId));
        const quoteNumber  = sanitizeHTML(q.quote_number || q.number);
        const pcNumber     = sanitizeHTML(pc ? (pc.pc_number || pc.number) : (q.pc_number || '-'));
        const companyName  = sanitizeHTML(pc ? (pc.company_name || pc.company) : (q.company_name || '-'));
        const totalCost    = q.total_cost || q.total || 0;
        const status       = sanitizeHTML(q.status || '-');

        tbody.innerHTML += `<tr>
            <td>${quoteNumber}</td>
            <td>${pcNumber}</td>
            <td>${companyName}</td>
            <td>Â£${totalCost.toFixed(2)}</td>
            <td>${status}</td>
            <td><button class="secondary" onclick="alert('Feature under development')">Show</button></td>
        </tr>`;
    });
}

// ========================================
// NEW Sprint 3: Enhanced Resource Lookup
// ========================================

// Global variable to track selected resources in modal
let selectedResources = new Set();
let filteredResourcesList = [];

function showEnhancedResourceModal(category = '') {
    // Initialize modal state
    selectedResources.clear();
    document.getElementById('resource-search').value = '';
    document.getElementById('resource-category-filter').value = category;
    document.getElementById('resource-status-filter').value = '';
    
    // Show modal
    document.getElementById('enhanced-resource-lookup-modal').classList.add('active');
    
    // Load and filter resources
    filterResources();
    
    // Focus on search box for better UX
    setTimeout(() => document.getElementById('resource-search').focus(), 100);
}

function closeEnhancedResourceModal() {
    document.getElementById('enhanced-resource-lookup-modal').classList.remove('active');
    selectedResources.clear();
}

function filterResources() {
    const priceList = db.priceLists.find(p => p.id === db.selectedPriceListId);
    if (!priceList) {
        document.getElementById('enhanced-resources-list').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">Please select a price list first</td></tr>';
        return;
    }
    
    const searchTerm = document.getElementById('resource-search').value.toLowerCase();
    const categoryFilter = document.getElementById('resource-category-filter').value;
    const statusFilter = document.getElementById('resource-status-filter').value;
    
    // Get all resources with pricing from current price list
    const priceListItems = Array.isArray(priceList.items) ? priceList.items : [];
    const resourcesWithPricing = priceListItems.map(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        if (!resource) return null;
        
        return {
            ...resource,
            client_price: item.clientPrice,
            price_list_item: item
        };
    }).filter(Boolean);
    
    // Apply filters
    filteredResourcesList = resourcesWithPricing.filter(resource => {
        // Search filter
        const matchesSearch = !searchTerm || 
            resource.name.toLowerCase().includes(searchTerm) ||
            (resource.sku || '').toLowerCase().includes(searchTerm) ||
            (resource.description || '').toLowerCase().includes(searchTerm);
        
        // Category filter  
        const matchesCategory = !categoryFilter || resource.category === categoryFilter;
        
        // Status filter
        const matchesStatus = !statusFilter || resource.is_active.toString() === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    // Update resource count
    document.getElementById('resource-count').textContent = filteredResourcesList.length;
    
    // Render filtered resources
    renderResourcesList();
}

function renderResourcesList() {
    const tbody = document.getElementById('enhanced-resources-list');
    
    if (filteredResourcesList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #666;">No resources found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredResourcesList.map(resource => {
        const isSelected = selectedResources.has(resource.id);
        const statusBadge = resource.is_active ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">INACTIVE</span>';
        
        // Critical: Sanitize all resource data
        const resourceId = sanitizeHTML(String(resource.id));
        const resourceName = sanitizeHTML(resource.name);
        const resourceDescription = resource.description ? sanitizeHTML(resource.description) : '';
        const resourceSku = sanitizeHTML(resource.sku || 'N/A');
        const resourceCategory = sanitizeHTML(resource.category);
        
        // Fix CSS styling for template literals
        const bgColor = isSelected ? '#f0f9ff' : 'white';
        const hoverOutColor = isSelected ? '#f0f9ff' : 'white';
        
        return `
            <tr style="background: ${bgColor};" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='${hoverOutColor}'">
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} 
                           onchange="window.toggleResourceSelection('${resourceId}')" 
                           style="transform: scale(1.2);">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <div style="font-weight: 500;">${resourceName}</div>
                    ${resourceDescription ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${resourceDescription}</div>` : ''}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">${resourceSku}</code>
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; text-transform: capitalize;">
                    ${resourceCategory}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: 500;">
                    Â£${resource.client_price.toFixed(2)}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                    <input type="number" value="1" min="1" max="999" 
                           style="width: 60px; padding: 0.25rem; border: 1px solid #ccc; border-radius: 0.25rem;"
                           id="qty-${resourceId}" onchange="window.updateResourceTotal('${resourceId}')">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: 500;">
                    <span id="total-${resourceId}">Â£${resource.client_price.toFixed(2)}</span>
                </td>
            </tr>
        `;
    }).join('');
    
    updateSelectionCount();
}

function toggleResourceSelection(resourceId) {
    if (selectedResources.has(resourceId)) {
        selectedResources.delete(resourceId);
    } else {
        selectedResources.add(resourceId);
    }
    
    renderResourcesList();
}

function updateResourceTotal(resourceId) {
    const resource = filteredResourcesList.find(r => r.id === resourceId);
    const qty = parseInt(document.getElementById(`qty-${resourceId}`).value) || 1;
    const total = resource.client_price * qty;
    
    document.getElementById(`total-${resourceId}`).textContent = `Â£${total.toFixed(2)}`;
}

function selectAllFilteredResources() {
    filteredResourcesList.forEach(resource => {
        selectedResources.add(resource.id);
    });
    renderResourcesList();
}

function clearResourceSelection() {
    selectedResources.clear();
    renderResourcesList();
}

function updateSelectionCount() {
    const count = selectedResources.size;
    document.getElementById('selected-count').textContent = count;
    
    const addButton = document.getElementById('add-selected-btn');
    addButton.disabled = count === 0;
    addButton.textContent = count === 0 ? 'Add Selected to Quote' : `Add ${count} Selected to Quote`;
}

function addSelectedResourcesToQuote() {
    if (selectedResources.size === 0) return;
    
    let addedCount = 0;
    
    selectedResources.forEach(resourceId => {
        const resource = filteredResourcesList.find(r => r.id === resourceId);
        if (!resource) return;
        
        const qty = parseInt(document.getElementById(`qty-${resourceId}`).value) || 1;
        
        // Add to appropriate category
        addResourceToQuoteCategory(resource, qty);
        addedCount++;
    });
    
    // Update totals
    calculateTotal();
    
    // Show success message
    alert(`Successfully added ${addedCount} resource(s) to quote!`);
    
    // Close modal
    closeEnhancedResourceModal();
}

function addResourceToQuoteCategory(resource, qty) {
    const category = resource.category;
    const lineId = 'line_' + Date.now() + '_' + resource.id;
    const container = document.getElementById('quote-' + category);
    
    // Create line item element
    const lineDiv = document.createElement('div');
    lineDiv.className = 'line-item';
    lineDiv.id = lineId;
    
    const total = resource.client_price * qty;
    
    // Sanitize all values for safe HTML injection
    const safeLineId = sanitizeHTML(lineId);
    const safeCategory = sanitizeHTML(category);
    const safeResourceId = sanitizeHTML(String(resource.id));
    const safeResourceName = sanitizeHTML(resource.name);
    const safeQty = sanitizeHTML(String(qty));
    
    lineDiv.innerHTML = `
        <input type="checkbox" class="line-item-checkbox" data-line-id="${safeLineId}" data-category="${safeCategory}" 
               onchange="window.updateBulkSelection()" style="margin-right: 0.5rem; transform: scale(1.2);">
        <select disabled style="background: #f1f5f9;">
            <option value="${safeResourceId}" data-price="${resource.client_price}">${safeResourceName}</option>
        </select>
        <input type="number" value="${qty}" min="1" onchange="window.updateLineQty('${safeLineId}', '${safeCategory}')" style="width: 80px;">
        <input type="text" readonly value="Â£${resource.client_price.toFixed(2)}" style="background: #f1f5f9;">
        <span class="line-item-total">Â£${total.toFixed(2)}</span>
        <button class="remove-btn" onclick="window.removeLine('${safeLineId}', '${safeCategory}')">Ã—</button>
    `;
    
    container.appendChild(lineDiv);
    
    // Add to quote items
    db.quoteItems[category].push({
        id: lineId,
        resourceId: resource.id,
        name: resource.name,
        qty: qty,
        rate: resource.client_price,
        total: total
    });
}

// ========================================
// NEW Sprint 3.2: Bulk Operations for Line Items
// ========================================

function updateBulkSelection() {
    const checkboxes = document.querySelectorAll('.line-item-checkbox');
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    // Update bulk selection count
    document.getElementById('bulk-selected-count').textContent = count;
    
    // Show/hide bulk operations panel
    const panel = document.getElementById('bulk-operations-panel');
    panel.style.display = count > 0 ? 'block' : 'none';
    
    // Update category "Select All" checkboxes
    ['human', 'vehicles', 'materials', 'other'].forEach(category => {
        const categoryCheckboxes = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]`);
        const categorySelected = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]:checked`);
        const selectAllCheckbox = document.getElementById(`select-all-${category}`);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.indeterminate = categorySelected.length > 0 && categorySelected.length < categoryCheckboxes.length;
            selectAllCheckbox.checked = categoryCheckboxes.length > 0 && categorySelected.length === categoryCheckboxes.length;
        }
    });
}

function toggleCategorySelection(category) {
    const selectAllCheckbox = document.getElementById(`select-all-${category}`);
    const categoryCheckboxes = document.querySelectorAll(`.line-item-checkbox[data-category="${category}"]`);
    
    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkSelection();
}

function clearBulkSelection() {
    document.querySelectorAll('.line-item-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkSelection();
}

function bulkUpdateQuantity() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    document.getElementById('bulk-qty-count').textContent = selectedCheckboxes.length;
    document.getElementById('bulk-quantity-modal').classList.add('active');
    document.getElementById('bulk-qty-value').focus();
}

function closeBulkQuantityModal() {
    document.getElementById('bulk-quantity-modal').classList.remove('active');
    document.getElementById('bulk-qty-value').value = '';
    document.getElementById('bulk-qty-operation').value = 'set';
}

function applyBulkQuantityUpdate() {
    const operation = document.getElementById('bulk-qty-operation').value;
    const value = parseFloat(document.getElementById('bulk-qty-value').value);
    
    if (isNaN(value) || value < 0) {
        alert('Please enter a valid positive number');
        return;
    }
    
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    let updatedCount = 0;
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        const lineDiv = document.getElementById(lineId);
        const qtyInput = lineDiv.querySelector('input[type="number"]');
        const currentQty = parseFloat(qtyInput.value) || 1;
        
        let newQty;
        switch (operation) {
            case 'set':
                newQty = value;
                break;
            case 'multiply':
                newQty = currentQty * value;
                break;
            case 'add':
                newQty = currentQty + value;
                break;
            default:
                newQty = value;
        }
        
        newQty = Math.max(1, Math.round(newQty)); // Minimum 1, round to integer
        qtyInput.value = newQty;
        
        // Update the quote item data and trigger calculation
        updateLineQty(lineId, category);
        updatedCount++;
    });
    
    alert(`Successfully updated quantities for ${updatedCount} line items!`);
    closeBulkQuantityModal();
    clearBulkSelection();
}

function bulkApplyDiscount() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    document.getElementById('bulk-discount-count').textContent = selectedCheckboxes.length;
    document.getElementById('bulk-discount-modal').classList.add('active');
    document.getElementById('bulk-discount-value').focus();
}

function closeBulkDiscountModal() {
    document.getElementById('bulk-discount-modal').classList.remove('active');
    document.getElementById('bulk-discount-value').value = '';
    document.getElementById('bulk-discount-type').value = 'percentage';
}

function applyBulkDiscount() {
    const discountType = document.getElementById('bulk-discount-type').value;
    const discountValue = parseFloat(document.getElementById('bulk-discount-value').value);
    
    if (isNaN(discountValue) || discountValue < 0) {
        alert('Please enter a valid discount value');
        return;
    }
    
    if (discountType === 'percentage' && discountValue > 100) {
        alert('Percentage discount cannot exceed 100%');
        return;
    }
    
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    let updatedCount = 0;
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        const lineDiv = document.getElementById(lineId);
        const priceInput = lineDiv.querySelectorAll('input[type="text"]')[0];
        const currentPriceText = priceInput.value.replace('Â£', '');
        const currentPrice = parseFloat(currentPriceText) || 0;
        
        let newPrice;
        if (discountType === 'percentage') {
            newPrice = currentPrice * (1 - (discountValue / 100));
        } else {
            newPrice = Math.max(0, currentPrice - discountValue);
        }
        
        newPrice = Math.max(0, newPrice); // Minimum 0
        priceInput.value = 'Â£' + newPrice.toFixed(2);
        
        // Update the quote item data
        const item = db.quoteItems[category].find(i => i.id === lineId);
        if (item) {
            item.rate = newPrice;
            updateLineQty(lineId, category); // This will recalculate totals
        }
        
        updatedCount++;
    });
    
    alert(`Successfully applied discount to ${updatedCount} line items!`);
    closeBulkDiscountModal();
    clearBulkSelection();
}

function bulkDeleteItems() {
    const selectedCheckboxes = document.querySelectorAll('.line-item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select line items first');
        return;
    }
    
    const itemCount = selectedCheckboxes.length;
    if (!confirm(`Are you sure you want to delete ${itemCount} selected line items?`)) {
        return;
    }
    
    selectedCheckboxes.forEach(checkbox => {
        const lineId = checkbox.getAttribute('data-line-id');
        const category = checkbox.getAttribute('data-category');
        removeLine(lineId, category);
    });
    
    alert(`Successfully deleted ${itemCount} line items!`);
    updateBulkSelection(); // Update the UI
}

// ========================================
// NEW Sprint 3.3: Template Management
// ========================================

function updateTemplatesList() {
    const tbody = document.getElementById('templates-list');
    if (!db.templates) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No templates available</td></tr>';
        return;
    }
    
    // Apply filters
    const searchTerm = document.getElementById('template-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('template-category-filter')?.value || '';
    const statusFilter = document.getElementById('template-status-filter')?.value || '';
    
    let filteredTemplates = db.templates.filter(template => {
        const matchesSearch = !searchTerm || 
            template.name.toLowerCase().includes(searchTerm) ||
            (template.description || '').toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || template.category === categoryFilter;
        const matchesStatus = !statusFilter || template.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    if (filteredTemplates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No templates found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredTemplates.map(template => {
        const itemCount = template.items ? template.items.length : 0;
        const statusBadge = template.status === 'active' ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ARCHIVED</span>';
        
        const lastUpdated = new Date(template.updated_at).toLocaleDateString();
        
        return `
            <tr>
                <td>
                    <div style="font-weight: 500;">${template.name}</div>
                    ${template.description ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${template.description}</div>` : ''}
                </td>
                <td style="text-transform: capitalize;">${template.category}</td>
                <td style="text-align: center;">${itemCount} items</td>
                <td style="font-weight: 500;">Â£${template.estimated_value.toFixed(2)}</td>
                <td>${lastUpdated}</td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="window.createQuoteFromTemplate('${template.id}')" style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Use Template</button>
                        <button onclick="window.editTemplate('${template.id}')" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                        <button onclick="window.deleteTemplate('${template.id}')" style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterTemplates() {
    updateTemplatesList();
}

function showCreateTemplateFromScratch() {
    // Clear template modal
    document.getElementById('template-modal-title').textContent = 'Create New Template';
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = '';
    document.getElementById('template-category').value = '';
    document.getElementById('template-description').value = '';
    document.getElementById('template-status').value = 'active';
    document.getElementById('template-vat-rate').value = '20.00';
    document.getElementById('template-terms').value = 'Payment terms: 30 days net. All work carried out to current industry standards. Materials warranty as per manufacturer specifications.';
    
    // Clear template items preview
    document.getElementById('template-items-preview').innerHTML = '<p style="margin: 0; color: #666; text-align: center;">No items added yet. Click "Add Items to Template" to add resources.</p>';
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function saveQuoteAsTemplate() {
    // Collect current quote data
    const title = document.getElementById('quote-title').value.trim();
    const description = document.getElementById('quote-description').value.trim();
    const terms = document.getElementById('quote-terms').value.trim();
    const vatRate = parseFloat(document.getElementById('quote-vat-rate').value) || 20;
    
    if (!title) {
        alert('Please enter a quote title first');
        return;
    }
    
    // Convert current quote items to template format
    const templateItems = [];
    let totalValue = 0;
    
    for (let category in db.quoteItems) {
        db.quoteItems[category].forEach(item => {
            if (item.resourceId) {
                templateItems.push({
                    resource_id: item.resourceId,
                    resource_name: item.name,
                    quantity: item.qty,
                    unit_price: item.rate,
                    line_total: item.total,
                    notes: `Category: ${category}`
                });
                totalValue += item.total;
            }
        });
    }
    
    if (templateItems.length === 0) {
        alert('Please add some items to the quote first');
        return;
    }
    
    // Pre-fill template modal with quote data
    document.getElementById('template-modal-title').textContent = 'Save Quote as Template';
    document.getElementById('template-id').value = '';
    document.getElementById('template-name').value = title + ' Template';
    document.getElementById('template-category').value = '';
    document.getElementById('template-description').value = description || 'Template created from quote: ' + title;
    document.getElementById('template-status').value = 'active';
    document.getElementById('template-vat-rate').value = vatRate.toString();
    document.getElementById('template-terms').value = terms;
    
    // Show template items preview
    const totalWithVat = totalValue * (1 + vatRate / 100);
    document.getElementById('template-items-preview').innerHTML = `
        <div style="margin-bottom: 1rem;">
            <strong>${templateItems.length} items</strong> - Estimated value: <strong>Â£${totalWithVat.toFixed(2)}</strong> (inc VAT)
        </div>
        ${templateItems.slice(0, 3).map(item => `
            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 0.25rem;">
                <span style="font-weight: 500;">${item.resource_name}</span> x${item.quantity} = Â£${item.line_total.toFixed(2)}
            </div>
        `).join('')}
        ${templateItems.length > 3 ? `<div style="color: #666; font-style: italic;">... and ${templateItems.length - 3} more items</div>` : ''}
    `;
    
    // Store items in a temporary variable for saving
    window.tempTemplateItems = templateItems;
    window.tempTemplateValue = totalWithVat;
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function duplicateCurrentQuote() {
    const title = document.getElementById('quote-title').value.trim();
    
    if (!title) {
        alert('Please save this quote first before duplicating');
        return;
    }
    
    if (!confirm('This will create a new quote with the same items. Continue?')) {
        return;
    }
    
    // Create new quote with current items but clear other fields
    const newTitle = title + ' (Copy)';
    document.getElementById('quote-title').value = newTitle;
    document.getElementById('quote-description').value = '';
    document.getElementById('quote-notes').value = '';
    
    // Clear address fields
    document.getElementById('quote-move-type').value = '';
    toggleAddressSections();
    
    // Clear quoted activities
    document.querySelectorAll('#quote-activities-multiselect input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    alert('Quote duplicated! Please update the details and save.');
}

function closeTemplateModal() {
    document.getElementById('template-modal').classList.remove('active');
    window.tempTemplateItems = null;
    window.tempTemplateValue = null;
}

function saveTemplate() {
    const id = document.getElementById('template-id').value;
    const name = document.getElementById('template-name').value.trim();
    const category = document.getElementById('template-category').value;
    const description = document.getElementById('template-description').value.trim();
    const status = document.getElementById('template-status').value;
    const vatRate = parseFloat(document.getElementById('template-vat-rate').value) || 20;
    const terms = document.getElementById('template-terms').value.trim();
    
    if (!name || !category) {
        alert('Template name and category are required!');
        return;
    }
    
    const items = window.tempTemplateItems || [];
    const estimatedValue = window.tempTemplateValue || 0;
    
    if (items.length === 0) {
        alert('Please add some items to the template');
        return;
    }
    
    const now = new Date().toISOString();
    const template = {
        id: id || generateUUID(),
        name,
        category,
        description,
        status,
        vat_rate: vatRate,
        terms_conditions: terms,
        items,
        estimated_value: estimatedValue,
        created_at: id ? db.templates.find(t => t.id === id)?.created_at || now : now,
        updated_at: now
    };
    
    if (id) {
        // Edit existing template
        const index = db.templates.findIndex(t => t.id === id);
        if (index !== -1) {
            db.templates[index] = template;
        }
    } else {
        // Create new template
        db.templates.push(template);
    }
    
    // Save to IndexedDB
    saveDataToIndexedDB().then(() => {
        alert(`Template "${name}" saved successfully!`);
        closeTemplateModal();
        updateTemplatesList();
    }).catch(error => {
        console.error('Error saving template:', error);
        alert('Error saving template. Please try again.');
    });
}

function editTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    // Fill template modal with existing data
    document.getElementById('template-modal-title').textContent = 'Edit Template';
    document.getElementById('template-id').value = template.id;
    document.getElementById('template-name').value = template.name;
    document.getElementById('template-category').value = template.category;
    document.getElementById('template-description').value = template.description || '';
    document.getElementById('template-status').value = template.status;
    document.getElementById('template-vat-rate').value = template.vat_rate.toString();
    document.getElementById('template-terms').value = template.terms_conditions || '';
    
    // Show template items
    const items = template.items || [];
    document.getElementById('template-items-preview').innerHTML = `
        <div style="margin-bottom: 1rem;">
            <strong>${items.length} items</strong> - Estimated value: <strong>Â£${template.estimated_value.toFixed(2)}</strong> (inc VAT)
        </div>
        ${items.slice(0, 5).map(item => `
            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 0.25rem;">
                <span style="font-weight: 500;">${item.resource_name}</span> x${item.quantity} = Â£${item.line_total.toFixed(2)}
            </div>
        `).join('')}
        ${items.length > 5 ? `<div style="color: #666; font-style: italic;">... and ${items.length - 5} more items</div>` : ''}
    `;
    
    // Store items for editing
    window.tempTemplateItems = items;
    window.tempTemplateValue = template.estimated_value;
    
    // Show modal
    document.getElementById('template-modal').classList.add('active');
    document.getElementById('template-name').focus();
}

function deleteTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!confirm(`Are you sure you want to delete template "${template.name}"?`)) {
        return;
    }
    
    db.templates = db.templates.filter(t => t.id !== templateId);
    
    saveDataToIndexedDB().then(() => {
        alert('Template deleted successfully!');
        updateTemplatesList();
    }).catch(error => {
        console.error('Error deleting template:', error);
        alert('Error deleting template. Please try again.');
    });
}

function createQuoteFromTemplate(templateId) {
    const template = db.templates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!db.currentPC) {
        alert('Please select a PC Number first');
        return;
    }
    
    if (!confirm(`Create a new quote using template "${template.name}"?`)) {
        return;
    }
    
    // Start fresh quote creation
    createQuote();
    
    // Wait for quote builder to initialize, then populate with template data
    setTimeout(() => {
        // Set quote metadata
        document.getElementById('quote-title').value = template.name;
        document.getElementById('quote-description').value = template.description || '';
        document.getElementById('quote-terms').value = template.terms_conditions || '';
        document.getElementById('quote-vat-rate').value = template.vat_rate.toString();
        
        // Add template items to quote
        template.items.forEach(templateItem => {
            const resource = db.resources.find(r => r.id === templateItem.resource_id);
            if (resource) {
                addResourceToQuoteCategory(resource, templateItem.quantity);
            }
        });
        
        // Recalculate totals
        calculateTotal();
        
        alert(`Quote created from template "${template.name}"! Please review and modify as needed.`);
    }, 500);
}

function addItemsToTemplate() {
    alert('Feature under development: Manual item addition to templates will be available in a future update. For now, create templates from existing quotes.');
}

// ========================================
// NEW Sprint 4.1: Activity Template Management
// ========================================

function updateActivityTemplatesList() {
    const tbody = document.getElementById('activity-templates-list');
    if (!db.activityTemplates) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No activity templates available</td></tr>';
        return;
    }
    
    // Apply filters
    const searchTerm = document.getElementById('activity-template-search')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('activity-template-category-filter')?.value || '';
    const statusFilter = document.getElementById('activity-template-status-filter')?.value || '';
    
    let filteredTemplates = db.activityTemplates.filter(template => {
        const matchesSearch = !searchTerm || 
            template.name.toLowerCase().includes(searchTerm) ||
            (template.description || '').toLowerCase().includes(searchTerm);
        
        const matchesCategory = !categoryFilter || template.category === categoryFilter;
        const matchesStatus = !statusFilter || template.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
    
    if (filteredTemplates.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No activity templates found matching your criteria</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredTemplates.map(template => {
        const priorityBadge = {
            'low': '<span style="background: #e5e7eb; color: #374151; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">LOW</span>',
            'medium': '<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">MEDIUM</span>',
            'high': '<span style="background: #fecaca; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">HIGH</span>',
            'urgent': '<span style="background: #ef4444; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">URGENT</span>'
        }[template.priority] || template.priority;
        
        const statusBadge = template.status === 'active' ? 
            '<span style="background: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ACTIVE</span>' :
            '<span style="background: #fee2e2; color: #991b1b; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">ARCHIVED</span>';
        
        const lastUpdated = new Date(template.updated_at).toLocaleDateString();
        const duration = template.duration_hours ? `${template.duration_hours}h` : 'Not set';
        
        return `
            <tr>
                <td>
                    <div style="font-weight: 500;">${template.name}</div>
                    ${template.description ? `<div style="font-size: 0.875rem; color: #666; margin-top: 0.25rem;">${template.description}</div>` : ''}
                </td>
                <td style="text-transform: capitalize;">${template.category}</td>
                <td style="text-align: center; font-weight: 500;">${duration}</td>
                <td>${priorityBadge}</td>
                <td>${lastUpdated}</td>
                <td>${statusBadge}</td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="window.createActivityFromTemplate('${template.id}')" style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Use Template</button>
                        <button onclick="window.editActivityTemplate('${template.id}')" style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Edit</button>
                        <button onclick="window.deleteActivityTemplate('${template.id}')" style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function filterActivityTemplates() {
    updateActivityTemplatesList();
}

function showCreateActivityTemplate() {
    // Clear modal
    document.getElementById('activity-template-modal-title').textContent = 'Create Activity Template';
    document.getElementById('activity-template-id').value = '';
    document.getElementById('activity-template-name').value = '';
    document.getElementById('activity-template-category').value = '';
    document.getElementById('activity-template-description').value = '';
    document.getElementById('activity-template-priority').value = 'medium';
    document.getElementById('activity-template-duration').value = '';
    document.getElementById('activity-template-status').value = 'active';
    document.getElementById('activity-template-assigned-to').value = '';
    document.getElementById('activity-template-schedule-offset').value = '';
    document.getElementById('activity-template-checklist').value = '';
    document.getElementById('activity-template-completion-notes').value = '';
    
    // Show modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
}

function closeActivityTemplateModal() {
    document.getElementById('activity-template-modal').classList.remove('active');
}

function saveActivityTemplate() {
    const id = document.getElementById('activity-template-id').value;
    const name = document.getElementById('activity-template-name').value.trim();
    const category = document.getElementById('activity-template-category').value;
    const description = document.getElementById('activity-template-description').value.trim();
    const priority = document.getElementById('activity-template-priority').value;
    const duration = parseFloat(document.getElementById('activity-template-duration').value);
    const status = document.getElementById('activity-template-status').value;
    const assignedTo = document.getElementById('activity-template-assigned-to').value.trim();
    const scheduleOffset = parseInt(document.getElementById('activity-template-schedule-offset').value);
    const checklist = document.getElementById('activity-template-checklist').value.trim();
    const completionNotes = document.getElementById('activity-template-completion-notes').value.trim();
    
    if (!name || !category || !priority) {
        alert('Template name, category, and priority are required!');
        return;
    }
    
    const now = new Date().toISOString();
    const template = {
        id: id || generateUUID(),
        name,
        category,
        description,
        priority,
        duration_hours: duration || null,
        status,
        assigned_to_default: assignedTo || null,
        schedule_offset_days: scheduleOffset || null,
        pre_activity_checklist: checklist,
        completion_notes_template: completionNotes,
        created_at: id ? db.activityTemplates.find(t => t.id === id)?.created_at || now : now,
        updated_at: now
    };
    
    if (id) {
        // Edit existing template
        const index = db.activityTemplates.findIndex(t => t.id === id);
        if (index !== -1) {
            db.activityTemplates[index] = template;
        }
    } else {
        // Create new template
        db.activityTemplates.push(template);
    }
    
    // Save to IndexedDB
    saveDataToIndexedDB().then(() => {
        alert(`Activity template "${name}" saved successfully!`);
        closeActivityTemplateModal();
        updateActivityTemplatesList();
    }).catch(error => {
        console.error('Error saving activity template:', error);
        alert('Error saving activity template. Please try again.');
    });
}

function editActivityTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    // Fill modal with existing data
    document.getElementById('activity-template-modal-title').textContent = 'Edit Activity Template';
    document.getElementById('activity-template-id').value = template.id;
    document.getElementById('activity-template-name').value = template.name;
    document.getElementById('activity-template-category').value = template.category;
    document.getElementById('activity-template-description').value = template.description || '';
    document.getElementById('activity-template-priority').value = template.priority;
    document.getElementById('activity-template-duration').value = template.duration_hours || '';
    document.getElementById('activity-template-status').value = template.status;
    document.getElementById('activity-template-assigned-to').value = template.assigned_to_default || '';
    document.getElementById('activity-template-schedule-offset').value = template.schedule_offset_days || '';
    document.getElementById('activity-template-checklist').value = template.pre_activity_checklist || '';
    document.getElementById('activity-template-completion-notes').value = template.completion_notes_template || '';
    
    // Show modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
}

function deleteActivityTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!confirm(`Are you sure you want to delete activity template "${template.name}"?`)) {
        return;
    }
    
    db.activityTemplates = db.activityTemplates.filter(t => t.id !== templateId);
    
    saveDataToIndexedDB().then(() => {
        alert('Activity template deleted successfully!');
        updateActivityTemplatesList();
    }).catch(error => {
        console.error('Error deleting activity template:', error);
        alert('Error deleting activity template. Please try again.');
    });
}

function createActivityFromTemplate(templateId) {
    const template = db.activityTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    if (!db.currentPC) {
        alert('Please select a PC Number first');
        return;
    }
    
    if (!confirm(`Create a new activity using template "${template.name}"?`)) {
        return;
    }
    
    // Calculate scheduled date based on template offset
    let scheduledDate = new Date();
    if (template.schedule_offset_days) {
        scheduledDate.setDate(scheduledDate.getDate() + template.schedule_offset_days);
    }
    
    // Open activity modal with template data
    showActivityModal();
    
    // Wait for modal to initialize, then populate with template data
    setTimeout(() => {
        document.getElementById('activity-title').value = template.name;
        document.getElementById('activity-description').value = template.description || '';
        document.getElementById('activity-priority').value = template.priority;
        document.getElementById('activity-duration').value = template.duration_hours || '';
        document.getElementById('activity-assigned-to').value = template.assigned_to_default || '';
        
        // Set scheduled date
        const dateString = scheduledDate.toISOString().split('T')[0];
        document.getElementById('activity-date').value = dateString;
        
        // Add checklist to description if provided
        if (template.pre_activity_checklist) {
            const currentDesc = document.getElementById('activity-description').value;
            const newDesc = currentDesc ? 
                `${currentDesc}\n\nPre-activity checklist:\n${template.pre_activity_checklist}` : 
                `Pre-activity checklist:\n${template.pre_activity_checklist}`;
            document.getElementById('activity-description').value = newDesc;
        }
        
        alert(`Activity created from template "${template.name}"! Please review and save.`);
    }, 500);
}

function saveActivityAsTemplate() {
    // Collect current activity data
    const title = document.getElementById('activity-title').value.trim();
    const description = document.getElementById('activity-description').value.trim();
    const priority = document.getElementById('activity-priority').value;
    const duration = parseFloat(document.getElementById('activity-duration').value);
    const assignedTo = document.getElementById('activity-assigned-to').value.trim();
    
    if (!title) {
        alert('Please enter an activity title first');
        return;
    }
    
    // Show activity template modal with pre-filled data
    document.getElementById('activity-template-modal-title').textContent = 'Save Activity as Template';
    document.getElementById('activity-template-id').value = '';
    document.getElementById('activity-template-name').value = title + ' Template';
    document.getElementById('activity-template-category').value = '';
    document.getElementById('activity-template-description').value = description || 'Template created from activity: ' + title;
    document.getElementById('activity-template-priority').value = priority;
    document.getElementById('activity-template-duration').value = duration || '';
    document.getElementById('activity-template-status').value = 'active';
    document.getElementById('activity-template-assigned-to').value = assignedTo;
    document.getElementById('activity-template-schedule-offset').value = '';
    document.getElementById('activity-template-checklist').value = '';
    document.getElementById('activity-template-completion-notes').value = '';
    
    // Show template modal
    document.getElementById('activity-template-modal').classList.add('active');
    document.getElementById('activity-template-name').focus();
    
    alert('Activity data has been loaded into template form. Please complete the category and save.');
}

// ========================================
// NEW Sprint 4.2: Calendar Management
// ========================================

// Global calendar state
let currentCalendarDate = new Date();
let currentCalendarView = CONFIG.UI.CALENDAR.DEFAULT_VIEW;
let currentActivitiesView = CONFIG.UI.CALENDAR.DEFAULT_ACTIVITIES_VIEW;

function switchActivitiesView(view) {
    console.log('ðŸ”„ Switching activities view to:', view);
    currentActivitiesView = view;
    
    // Update button states
    const listBtn = document.getElementById('activities-list-view-btn');
    const calendarBtn = document.getElementById('activities-calendar-view-btn');
    const workflowBtn = document.getElementById('activities-workflow-view-btn');
    const calendarNav = document.getElementById('calendar-navigation');
    
    console.log('ðŸ“Š Elements found:', { listBtn, calendarBtn, workflowBtn, calendarNav });
    
    // Update button styles - reset all
    [listBtn, calendarBtn, workflowBtn].forEach(btn => {
        if (btn) {
            btn.style.background = 'transparent';
            btn.style.color = '#374151';
        }
    });
    
    // Hide all views
    document.getElementById('activities-list-view').style.display = 'none';
    document.getElementById('activities-calendar-view').style.display = 'none';
    document.getElementById('activities-workflow-view').style.display = 'none';
    calendarNav.style.display = 'none';
    
    // Show selected view
    switch(view) {
        case 'list':
            document.getElementById('activities-list-view').style.display = 'block';
            listBtn.style.background = '#3b82f6';
            listBtn.style.color = 'white';
            updateActivitiesList();
            break;
        case 'calendar':
            document.getElementById('activities-calendar-view').style.display = 'block';
            calendarNav.style.display = 'flex';
            calendarBtn.style.background = '#3b82f6';
            calendarBtn.style.color = 'white';
            console.log('ðŸ“… Initializing calendar view...');
            updateCalendarTitle();
            renderCalendar();
            console.log('âœ… Calendar view should be visible now!');
            break;
        case 'workflow':
            document.getElementById('activities-workflow-view').style.display = 'block';
            if (workflowBtn) {
                workflowBtn.style.background = '#3b82f6';
                workflowBtn.style.color = 'white';
            }
            updateWorkflowView();
            break;
    }
}

function setCalendarView(view) {
    currentCalendarView = view;
    
    // Update view button states
    const monthBtn = document.getElementById('calendar-month-btn');
    const weekBtn = document.getElementById('calendar-week-btn');
    
    if (view === 'month') {
        monthBtn.style.background = '#3b82f6';
        monthBtn.style.color = 'white';
        weekBtn.style.background = 'transparent';
        weekBtn.style.color = '#374151';
        
        document.getElementById('calendar-month-view').style.display = 'block';
        document.getElementById('calendar-week-view').style.display = 'none';
    } else {
        weekBtn.style.background = '#3b82f6';
        weekBtn.style.color = 'white';
        monthBtn.style.background = 'transparent';
        monthBtn.style.color = '#374151';
        
        document.getElementById('calendar-month-view').style.display = 'none';
        document.getElementById('calendar-week-view').style.display = 'block';
    }
    
    updateCalendarTitle();
    renderCalendar();
    
    // NEW Sprint 4.2.3: Update workload panel when view changes
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function navigateCalendar(direction) {
    const currentDate = new Date(currentCalendarDate);
    
    if (direction === 'prev') {
        if (currentCalendarView === 'month') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
        }
    } else if (direction === 'next') {
        if (currentCalendarView === 'month') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
        }
    } else if (direction === 'today') {
        currentCalendarDate = new Date();
    }
    
    updateCalendarTitle();
    renderCalendar();
    
    // NEW Sprint 4.2.3: Update workload panel when navigation changes
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function updateCalendarTitle() {
    const titleElement = document.getElementById('calendar-title');
    const options = currentCalendarView === 'month' 
        ? { month: 'long', year: 'numeric' }
        : { month: 'short', day: 'numeric', year: 'numeric' };
    
    if (currentCalendarView === 'week') {
        // For week view, show the week range
        const startOfWeek = getStartOfWeek(currentCalendarDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(endOfWeek.getDate() + 6);
        
        const startStr = startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const endStr = endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        titleElement.textContent = `${startStr} - ${endStr}`;
    } else {
        titleElement.textContent = currentCalendarDate.toLocaleDateString('en-US', options);
    }
}

function getStartOfWeek(date) {
    const result = new Date(date);
    const day = result.getDay();
    const diff = result.getDate() - day; // Adjust for Sunday as first day
    result.setDate(diff);
    return result;
}

function renderCalendar() {
    if (currentCalendarView === 'month') {
        renderMonthView();
    } else {
        renderWeekView();
    }
}

function renderMonthView() {
    const grid = document.getElementById('calendar-grid');
    
    // Clear existing content
    grid.innerHTML = '';
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'week-day-header';
        header.textContent = day;
        grid.appendChild(header);
    });
    
    // Get first and last day of the month view
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    
    // Get the start of the calendar grid (may include previous month days)
    const startDate = getStartOfWeek(firstDay);
    
    // Generate 42 days (6 weeks * 7 days)
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Add classes for styling
        if (date.getMonth() !== currentCalendarDate.getMonth()) {
            dayElement.classList.add('other-month');
        }
        
        if (isToday(date)) {
            dayElement.classList.add('today');
        }
        
        // Add day number
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = date.getDate();
        dayElement.appendChild(dayHeader);
        
        // Add activities for this day
        const dayActivities = getActivitiesForDate(date);
        dayActivities.forEach(activity => {
            const activityElement = document.createElement('div');
            activityElement.className = `calendar-activity priority-${activity.priority} status-${activity.status}`;
            activityElement.textContent = activity.title;
            activityElement.onclick = () => showActivityInSidebar(activity);
            
            // NEW Sprint 4.2.3: Enhance with assignee information
            enhanceActivityWithAssignee(activityElement, activity);
            
            // NEW Sprint 4.2.4: Enhance with recurring information
            enhanceActivityWithRecurring(activityElement, activity);
            
            dayElement.appendChild(activityElement);
        });
        
        grid.appendChild(dayElement);
    }
    
    // NEW Sprint 4.2.2: Enable drag & drop for month view activities
    setTimeout(() => {
        document.querySelectorAll('.calendar-activity').forEach(activity => {
            makeActivityDraggable(activity);
        });
        
        // Make month calendar days droppable
        document.querySelectorAll('.calendar-day').forEach(day => {
            makeMonthDayDroppable(day);
        });
    }, 100);
}

function renderWeekView() {
    const weekGrid = document.getElementById('week-grid-content');
    weekGrid.innerHTML = '';
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const timeSlots = generateTimeSlots();
    
    // Create week view grid: time labels + 7 days
    const grid = weekGrid.parentElement;
    grid.innerHTML = ''; // Clear all content
    
    // Add empty corner cell
    const corner = document.createElement('div');
    corner.className = 'week-time-label';
    grid.appendChild(corner);
    
    // Add day headers
    for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'week-day-header';
        if (isToday(date)) dayHeader.classList.add('today');
        
        dayHeader.innerHTML = `
            <div style="font-weight: 500;">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
            <div style="font-size: 1.25rem;">${date.getDate()}</div>
        `;
        grid.appendChild(dayHeader);
    }
    
    // Add time slots and day columns
    timeSlots.forEach(time => {
        // Time label
        const timeLabel = document.createElement('div');
        timeLabel.className = 'week-time-label';
        timeLabel.textContent = time;
        grid.appendChild(timeLabel);
        
        // Day columns for this time slot
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            
            const timeSlot = document.createElement('div');
            timeSlot.className = 'week-time-slot';
            
            // Add activities for this time slot
            const slotActivities = getActivitiesForTimeSlot(date, time);
            slotActivities.forEach(activity => {
                const activityElement = document.createElement('div');
                activityElement.className = `calendar-activity priority-${activity.priority} status-${activity.status}`;
                activityElement.textContent = activity.title;
                activityElement.onclick = () => showActivityInSidebar(activity);
                
                // NEW Sprint 4.2.3: Enhance with assignee information
                enhanceActivityWithAssignee(activityElement, activity);
                
                // NEW Sprint 4.2.4: Enhance with recurring information
                enhanceActivityWithRecurring(activityElement, activity);
                
                timeSlot.appendChild(activityElement);
            });
            
            grid.appendChild(timeSlot);
        }
    });
    
    // NEW Sprint 4.2.2: Enable drag & drop after rendering
    setTimeout(() => {
        enableDragAndDrop();
    }, 100);
}

function generateTimeSlots() {
    const slots = [];
    for (let hour = 8; hour <= 18; hour++) {
        const time12 = hour > 12 ? `${hour - 12}:00 PM` : hour === 12 ? '12:00 PM' : `${hour}:00 AM`;
        slots.push(time12);
    }
    return slots;
}

function isToday(date) {
    const today = new Date();
    return date.toDateString() === today.toDateString();
}

function getActivitiesForDate(date) {
    if (!db.activities) return [];
    
    return db.activities.filter(activity => {
        if (!activity.scheduled_date) return false;
        const activityDate = new Date(activity.scheduled_date);
        return activityDate.toDateString() === date.toDateString();
    });
}

function getActivitiesForTimeSlot(date, timeSlot) {
    const dateActivities = getActivitiesForDate(date);
    
    // For now, return all activities for the date
    // In a more advanced version, we could parse scheduled_time and match time slots
    return dateActivities;
}

function showActivityInSidebar(activity) {
    const sidebar = document.getElementById('calendar-activity-sidebar');
    const content = document.getElementById('calendar-activity-content');
    
    const pc = db.pcs.find(p => p.id === activity.pc_id);
    const statusBadge = `<span class="activity-status-${activity.status}">${activity.status.toUpperCase()}</span>`;
    const priorityBadge = `<span class="priority-${activity.priority}">${activity.priority.toUpperCase()}</span>`;
    
    // NEW Sprint 4.2.4: Check if this is a recurring activity
    const isRecurring = isRecurringActivity(activity);
    const recurringInfo = isRecurring ? `
        <div style="background: #e0e7ff; border: 1px solid #c7d2fe; border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: #3730a3; font-weight: 600; margin-bottom: 0.5rem;">
                ðŸ”„ Recurring Activity
            </div>
            <div style="font-size: 0.875rem; color: #3730a3;">
                <strong>Series Position:</strong> ${activity.recurring_sequence || 'N/A'}<br>
                ${activity.recurring_config ? `<strong>Pattern:</strong> ${getRecurringText(activity.recurring_config)}` : ''}
            </div>
        </div>
    ` : '';
    
    const assignedMember = getTeamMemberName(activity.assigned_to);
    
    content.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0;">${activity.title}</h4>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                ${statusBadge}
                ${priorityBadge}
            </div>
        </div>
        
        ${recurringInfo}
        
        <div style="margin-bottom: 1rem;">
            <strong>PC Number:</strong> ${activity.pc_number || 'N/A'}<br>
            <strong>Company:</strong> ${pc ? pc.company_name : 'N/A'}<br>
            <strong>Scheduled:</strong> ${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not scheduled'}<br>
            <strong>Duration:</strong> ${activity.estimated_hours || 'N/A'} hours<br>
            <strong>Assigned to:</strong> ${assignedMember || 'Unassigned'}
        </div>
        
        ${activity.description ? `
            <div style="margin-bottom: 1rem;">
                <strong>Description:</strong><br>
                <div style="background: #f9fafb; padding: 0.5rem; border-radius: 0.25rem; margin-top: 0.25rem;">
                    ${activity.description}
                </div>
            </div>
        ` : ''}
        
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button onclick="window.editActivityFromCalendarRecurring('${activity.id}')" style="background: #3b82f6; color: white; padding: 0.5rem 1rem;">
                ${isRecurring ? 'ðŸ”„ Edit Series' : 'Edit'}
            </button>
            <button onclick="window.closeCalendarSidebar()" class="secondary" style="padding: 0.5rem 1rem;">Close</button>
        </div>
    `;
    
    sidebar.style.display = 'block';
}

function closeCalendarSidebar() {
    document.getElementById('calendar-activity-sidebar').style.display = 'none';
}

function editActivityFromCalendar(activityId) {
    closeCalendarSidebar();
    const activity = db.activities.find(a => a.id === activityId);
    if (activity) {
        // Use existing edit functionality
        editActivity(activityId);
    }
}

// ========================================
// NEW Sprint 4.2.2: Drag & Drop Time Slot Management
// ========================================

let draggedActivity = null;
let dragStartSlot = null;
let quickCreateSlotData = null;

function enableDragAndDrop() {
    console.log('ðŸŽ¯ Enabling drag & drop for calendar activities...');
    
    // Add drag and drop functionality to existing calendar activities
    document.querySelectorAll('.calendar-activity').forEach(activity => {
        makeActivityDraggable(activity);
    });
    
    // Add drop zones and click handlers to time slots
    document.querySelectorAll('.week-time-slot').forEach(slot => {
        makeTimeSlotDroppable(slot);
        addTimeSlotClickHandler(slot);
    });
}

function makeActivityDraggable(activityElement) {
    activityElement.draggable = true;
    activityElement.classList.add('draggable');
    
    activityElement.addEventListener('dragstart', (e) => {
        draggedActivity = activityElement;
        dragStartSlot = activityElement.parentElement;
        activityElement.classList.add('dragging');
        
        // Store activity data for the drag operation
        const activityId = getActivityIdFromElement(activityElement);
        e.dataTransfer.setData('text/plain', activityId);
        e.dataTransfer.effectAllowed = 'move';
        
        console.log('ðŸŽ¯ Drag started for activity:', activityId);
    });
    
    activityElement.addEventListener('dragend', (e) => {
        activityElement.classList.remove('dragging');
        draggedActivity = null;
        dragStartSlot = null;
        
        // Remove drag-over styles from all slots
        document.querySelectorAll('.week-time-slot').forEach(slot => {
            slot.classList.remove('drag-over', 'time-conflict-warning');
        });
    });
}

function makeTimeSlotDroppable(slotElement) {
    slotElement.classList.add('time-slot-drop-zone');
    
    slotElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedActivity) {
            slotElement.classList.add('drag-over');
            
            // Check for time conflicts
            const hasConflict = checkTimeConflict(slotElement, draggedActivity);
            if (hasConflict) {
                slotElement.classList.add('time-conflict-warning');
            }
        }
    });
    
    slotElement.addEventListener('dragleave', (e) => {
        // Only remove styles if we're leaving the slot entirely
        if (!slotElement.contains(e.relatedTarget)) {
            slotElement.classList.remove('drag-over', 'time-conflict-warning');
        }
    });
    
    slotElement.addEventListener('drop', (e) => {
        e.preventDefault();
        slotElement.classList.remove('drag-over', 'time-conflict-warning');
        
        const activityId = e.dataTransfer.getData('text/plain');
        if (activityId && draggedActivity) {
            moveActivityToTimeSlot(activityId, slotElement);
        }
    });
    
    // Add visual hints for empty slots
    if (slotElement.children.length === 0) {
        slotElement.classList.add('empty');
        addTimeSlotHint(slotElement);
    }
}

function addTimeSlotClickHandler(slotElement) {
    slotElement.addEventListener('dblclick', (e) => {
        // Only trigger if we didn't click on an existing activity
        if (e.target === slotElement || e.target.classList.contains('time-slot-create-hint')) {
            const slotData = getTimeSlotData(slotElement);
            showQuickCreateForm(slotData);
        }
    });
}

function addTimeSlotHint(slotElement) {
    const hint = document.createElement('div');
    hint.className = 'time-slot-create-hint';
    hint.textContent = 'Double-click to create activity';
    slotElement.appendChild(hint);
}

function getActivityIdFromElement(activityElement) {
    // Extract activity ID from the activity element's onclick handler or data attribute
    const onclickAttr = activityElement.getAttribute('onclick');
    if (onclickAttr) {
        const match = onclickAttr.match(/showActivityInSidebar\(([^)]+)\)/);
        if (match) {
            // This is a complex object, we need to find the activity by title
            const title = activityElement.textContent;
            const activity = db.activities.find(a => a.title === title);
            return activity ? activity.id : null;
        }
    }
    return null;
}

function getTimeSlotData(slotElement) {
    // Extract date and time information from the slot's position in the grid
    const weekGrid = slotElement.closest('#calendar-week-view');
    const allSlots = Array.from(weekGrid.querySelectorAll('.week-time-slot'));
    const slotIndex = allSlots.indexOf(slotElement);
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const timeSlots = generateTimeSlots();
    
    // Calculate which day and time this slot represents
    const dayIndex = slotIndex % 7;
    const timeIndex = Math.floor(slotIndex / 7);
    
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + dayIndex);
    
            const timeSlot = timeSlots[timeIndex] || CONFIG.BUSINESS.DEFAULT_ACTIVITY_TIME;
    
    return {
        date: date,
        time: timeSlot,
        slotElement: slotElement
    };
}

function checkTimeConflict(targetSlot, draggedActivityElement) {
    // Check if the target slot already has activities
    const existingActivities = targetSlot.querySelectorAll('.calendar-activity');
    
    // For now, we'll warn if there are already activities in the slot
    // In a more sophisticated version, we could check actual time overlaps
    return existingActivities.length > 0;
}

function moveActivityToTimeSlot(activityId, targetSlot) {
    console.log('ðŸŽ¯ Moving activity to new time slot:', activityId);
    
    const activity = db.activities.find(a => a.id === activityId);
    if (!activity) {
        console.error('Activity not found:', activityId);
        return;
    }
    
    const slotData = getTimeSlotData(targetSlot);
    
    // Update the activity's scheduled date and time
    activity.scheduled_date = slotData.date.toISOString().split('T')[0];
    activity.scheduled_time = convertTimeSlotTo24Hour(slotData.time);
    
    // Update in IndexedDB
    saveWithRetry('ACTIVITIES', activity)
        .then(() => {
            console.log('âœ… Activity moved successfully');
            // Refresh calendar view
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after moving activities
            setTimeout(checkForNotifications, 1000);
            
            // Show success message
            showNotification('Activity moved successfully!', 'success');
        })
        .catch(error => {
            console.error('Failed to move activity:', error);
            showNotification('Failed to move activity', 'error');
        });
}

function convertTimeSlotTo24Hour(timeSlot) {
    // Convert "9:00 AM" format to "09:00" format
    const [time, period] = timeSlot.split(' ');
    const [hours, minutes] = time.split(':');
    let hour24 = parseInt(hours);
    
    if (period === 'PM' && hour24 !== 12) {
        hour24 += 12;
    } else if (period === 'AM' && hour24 === 12) {
        hour24 = 0;
    }
    
    return `${hour24.toString().padStart(2, '0')}:${minutes}`;
}

function showQuickCreateForm(slotData) {
    console.log('ðŸŽ¯ Showing quick create form for slot:', slotData);
    
    quickCreateSlotData = slotData;
    
    // Populate time slot info
    const timeInfo = document.getElementById('quick-create-time-info');
    timeInfo.innerHTML = `
        <strong>ðŸ“… ${slotData.date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        })}</strong><br>
        ðŸ• ${slotData.time}
    `;
    
    // Populate PC numbers dropdown
    populateQuickCreatePCs();
    
    // Populate team members dropdown
    populateAssigneeDropdowns();
    
    // Clear form
    document.getElementById('quick-create-form').reset();
    
    // Show overlay
    const overlay = document.getElementById('quick-create-overlay');
    overlay.style.display = 'flex';
    
    // Focus title field
    setTimeout(() => {
        document.getElementById('quick-activity-title').focus();
    }, 100);
}

function populateQuickCreatePCs() {
    const pcSelect = document.getElementById('quick-activity-pc');
    pcSelect.innerHTML = '<option value="">Select PC Number</option>';
    
    if (db.pcs) {
        db.pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `${pc.pc_number} - ${pc.company_name}`;
            pcSelect.appendChild(option);
        });
    }
}

function closeQuickCreate() {
    document.getElementById('quick-create-overlay').style.display = 'none';
    quickCreateSlotData = null;
}

function submitQuickCreate(event) {
    event.preventDefault();
    
    if (!quickCreateSlotData) {
        console.error('No slot data available');
        return;
    }
    
    const formData = new FormData(event.target);
    const baseActivityData = {
        id: generateUUID(),
        title: formData.get('title'),
        description: formData.get('description') || '',
        pc_id: formData.get('pc_id') || '',
        priority: formData.get('priority') || 'normal',
        status: 'scheduled',
        estimated_hours: parseFloat(formData.get('estimated_hours')) || 1,
        scheduled_date: quickCreateSlotData.date.toISOString().split('T')[0],
        scheduled_time: convertTimeSlotTo24Hour(quickCreateSlotData.time),
        created_date: new Date().toISOString().split('T')[0],
        assigned_to: formData.get('assigned_to') || '',
        completion_notes: '',
        is_recurring: false
    };
    
    let activitiesToCreate = [baseActivityData];
    
    // NEW Sprint 4.2.4: Handle recurring activities
    const isRecurring = formData.get('recurring_enabled') === 'on';
    if (isRecurring) {
        const recurringConfig = {
            frequency: formData.get('recurring_frequency'),
            interval: parseInt(formData.get('recurring_interval')) || 1,
            endDate: formData.get('recurring_end_date') || null,
            count: parseInt(formData.get('recurring_count')) || null
        };
        
        // Create recurring activities
        activitiesToCreate = createRecurringActivities(baseActivityData, recurringConfig);
        console.log(`ðŸ”„ Created ${activitiesToCreate.length} recurring activities`);
    }
    
    // Add to database
    if (!db.activities) db.activities = [];
    activitiesToCreate.forEach(activity => {
        db.activities.push(activity);
    });
    
    // Save to IndexedDB
    Promise.all(activitiesToCreate.map(activity => saveWithRetry('ACTIVITIES', activity)))
        .then(() => {
            console.log('âœ… Activities created successfully');
            closeQuickCreate();
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after creating activities
            setTimeout(checkForNotifications, 1000);
            
            const message = isRecurring 
                ? `Created ${activitiesToCreate.length} recurring activities successfully!`
                : 'Activity created successfully!';
            showNotification(message, 'success');
        })
        .catch(error => {
            console.error('Failed to create activities:', error);
            showNotification('Failed to create activities', 'error');
        });
}

function makeMonthDayDroppable(dayElement) {
    dayElement.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedActivity) {
            dayElement.classList.add('drag-over');
        }
    });
    
    dayElement.addEventListener('dragleave', (e) => {
        if (!dayElement.contains(e.relatedTarget)) {
            dayElement.classList.remove('drag-over');
        }
    });
    
    dayElement.addEventListener('drop', (e) => {
        e.preventDefault();
        dayElement.classList.remove('drag-over');
        
        const activityId = e.dataTransfer.getData('text/plain');
        if (activityId && draggedActivity) {
            moveActivityToMonthDay(activityId, dayElement);
        }
    });
    
    // Add double-click handler for quick create in month view
    dayElement.addEventListener('dblclick', (e) => {
        // Only trigger if we didn't click on an existing activity
        if (e.target === dayElement || e.target.classList.contains('calendar-day-header')) {
            const dayDate = getDateFromMonthDay(dayElement);
            const slotData = {
                date: dayDate,
                time: CONFIG.BUSINESS.DEFAULT_ACTIVITY_TIME, // Default time for month view
                slotElement: dayElement
            };
            showQuickCreateForm(slotData);
        }
    });
}

function getDateFromMonthDay(dayElement) {
    // Extract date from the day element's date data or text content
    const dayHeader = dayElement.querySelector('.calendar-day-header');
    if (dayHeader) {
        const dayNumber = parseInt(dayHeader.textContent);
        if (!isNaN(dayNumber)) {
            // Reconstruct the date based on current calendar date and day number
            const monthStart = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const firstDayOfWeek = monthStart.getDay();
            const calendarStart = new Date(monthStart);
            calendarStart.setDate(monthStart.getDate() - firstDayOfWeek);
            
            // Find which calendar day this is
            const allDays = Array.from(dayElement.parentElement.querySelectorAll('.calendar-day'));
            const dayIndex = allDays.indexOf(dayElement);
            
            const targetDate = new Date(calendarStart);
            targetDate.setDate(calendarStart.getDate() + dayIndex);
            
            return targetDate;
        }
    }
    
    // Fallback to current date
    return new Date();
}

function moveActivityToMonthDay(activityId, dayElement) {
    console.log('ðŸŽ¯ Moving activity to month day:', activityId);
    
    const activity = db.activities.find(a => a.id === activityId);
    if (!activity) {
        console.error('Activity not found:', activityId);
        return;
    }
    
    const dayDate = getDateFromMonthDay(dayElement);
    
    // Update the activity's scheduled date (keep existing time if any)
    activity.scheduled_date = dayDate.toISOString().split('T')[0];
    
    // Update in IndexedDB
    saveWithRetry('ACTIVITIES', activity)
        .then(() => {
            console.log('âœ… Activity moved successfully');
            // Refresh calendar view
            renderCalendar();
            
            // Update workload panel if visible
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            
            // NEW Sprint 4.2.5: Update notifications after moving activities
            setTimeout(checkForNotifications, 1000);
            
            // Show success message
            showNotification('Activity moved successfully!', 'success');
        })
        .catch(error => {
            console.error('Failed to move activity:', error);
            showNotification('Failed to move activity', 'error');
        });
}

function showNotification(message, type = 'info') {
    // Simple notification system - you might want to enhance this
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 3000;
        transition: all 0.3s ease;
        max-width: 300px;
    `;
    
    switch (type) {
        case 'success':
            notification.style.background = '#10b981';
            break;
        case 'error':
            notification.style.background = '#ef4444';
            break;
        default:
            notification.style.background = '#3b82f6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => {
            if (notification.parentElement) {
                notification.parentElement.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ========================================
// NEW Sprint 4.2.3: Team Management & Workload Balancing
// ========================================

// Team members data - loaded from CONFIG
let teamMembers = [...CONFIG.TEAM.DEFAULT_MEMBERS];

let currentTeamFilter = CONFIG.TEAM.DEFAULT_FILTER;
let workloadPanelVisible = false;

function initializeTeamManagement() {
    console.log('ðŸŽ¯ Initializing team management...');
    renderTeamFilterChips();
    populateAssigneeDropdowns();
    updateWorkloadPanel();
}

function renderTeamFilterChips() {
    const container = document.getElementById('team-filter-chips');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Add "All" chip
    const allChip = document.createElement('div');
    allChip.className = `team-member-chip all ${currentTeamFilter === 'all' ? 'active' : ''}`;
    allChip.innerHTML = 'ðŸ‘¥ All Team';
    allChip.onclick = () => filterByTeamMember('all');
    container.appendChild(allChip);
    
    // Add team member chips
    teamMembers.forEach(member => {
        const chip = document.createElement('div');
        const chipClass = currentTeamFilter === member.id ? 'active' : '';
        chip.className = `team-member-chip ${chipClass}`;
        chip.style.background = member.color;
        chip.style.color = 'white';
        chip.innerHTML = `
            <div class="assignee-avatar" style="background: ${member.color}; margin-right: 0.5rem;">
                ${member.name.split(' ').map(n => n[0]).join('')}
            </div>
            ${member.name}
        `;
        chip.onclick = () => filterByTeamMember(member.id);
        container.appendChild(chip);
    });
}

function populateAssigneeDropdowns() {
    // Populate quick create form
    const quickSelect = document.getElementById('quick-activity-assignee');
    if (quickSelect) {
        quickSelect.innerHTML = '<option value="">Unassigned</option>';
        teamMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.name} (${member.role})`;
            quickSelect.appendChild(option);
        });
    }
    
    // Populate regular activity form if it exists
    const activitySelect = document.getElementById('activity-assigned-to');
    if (activitySelect) {
        activitySelect.innerHTML = '<option value="">Unassigned</option>';
        teamMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = `${member.name} (${member.role})`;
            activitySelect.appendChild(option);
        });
    }
}

function filterByTeamMember(memberId) {
    console.log('ðŸŽ¯ Filtering by team member:', memberId);
    
    currentTeamFilter = memberId;
    renderTeamFilterChips();
    
    // Apply filter to calendar view
    const activities = document.querySelectorAll('.calendar-activity');
    activities.forEach(activity => {
        const activityData = getActivityDataFromElement(activity);
        if (memberId === 'all' || !activityData.assigned_to || activityData.assigned_to === memberId) {
            activity.style.display = '';
        } else {
            activity.style.display = 'none';
        }
    });
}

function getActivityDataFromElement(activityElement) {
    // Extract activity data from element (simplified for now)
    const title = activityElement.textContent;
    const activity = db.activities?.find(a => a.title === title);
    return activity || { assigned_to: '' };
}

function toggleWorkloadPanel() {
    const panel = document.getElementById('workload-panel');
    workloadPanelVisible = !workloadPanelVisible;
    
    if (workloadPanelVisible) {
        panel.style.display = 'block';
        updateWorkloadPanel();
    } else {
        panel.style.display = 'none';
    }
}

function updateWorkloadPanel() {
    if (!workloadPanelVisible) return;
    
    const weekDisplay = document.getElementById('workload-week-display');
    const summaryContainer = document.getElementById('workload-summary');
    
    if (!weekDisplay || !summaryContainer) return;
    
    // Get current week
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    weekDisplay.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    
    // Calculate workload for each team member
    const workloadData = calculateTeamWorkload(startOfWeek, endOfWeek);
    
    // Render workload cards
    summaryContainer.innerHTML = '';
    teamMembers.forEach(member => {
        const memberWorkload = workloadData[member.id] || { hours: 0, activities: 0 };
        const workloadCard = createWorkloadCard(member, memberWorkload);
        summaryContainer.appendChild(workloadCard);
    });
}

function calculateTeamWorkload(startDate, endDate) {
    if (!db.activities) return {};
    
    const workload = {};
    
    db.activities.forEach(activity => {
        if (!activity.assigned_to || !activity.scheduled_date) return;
        
        const activityDate = new Date(activity.scheduled_date);
        if (activityDate >= startDate && activityDate <= endDate) {
            if (!workload[activity.assigned_to]) {
                workload[activity.assigned_to] = { hours: 0, activities: 0 };
            }
            
            workload[activity.assigned_to].hours += activity.estimated_hours || 1;
            workload[activity.assigned_to].activities += 1;
        }
    });
    
    return workload;
}

function createWorkloadCard(member, workload) {
    const card = document.createElement('div');
    card.className = 'workload-card';
    card.style.setProperty('--member-color', member.color);
    
    const utilizationPercent = Math.round((workload.hours / member.max_hours) * 100);
    const workloadLevel = getWorkloadLevel(utilizationPercent);
    
    card.innerHTML = `
        <h4>
            <div class="assignee-avatar" style="background: ${member.color}; display: inline-flex; margin-right: 0.5rem;">
                ${member.name.split(' ').map(n => n[0]).join('')}
            </div>
            ${member.name}
        </h4>
        <div class="workload-stats">
            <span>${workload.hours}h / ${member.max_hours}h</span>
            <span>${utilizationPercent}%</span>
        </div>
        <div class="workload-bar">
            <div class="workload-bar-fill ${workloadLevel}" style="width: ${Math.min(utilizationPercent, 100)}%;"></div>
        </div>
        <div class="workload-stats">
            <span>${workload.activities} activities</span>
            <span class="${workloadLevel}">${getWorkloadText(workloadLevel)}</span>
        </div>
    `;
    
    return card;
}

function getWorkloadLevel(percent) {
    if (percent <= 70) return 'workload-low';
    if (percent <= 90) return 'workload-medium';
    if (percent <= 100) return 'workload-high';
    return 'workload-overloaded';
}

function getWorkloadText(level) {
    switch (level) {
        case 'workload-low': return 'Available';
        case 'workload-medium': return 'Busy';
        case 'workload-high': return 'Full';
        case 'workload-overloaded': return 'Overloaded';
        default: return 'Unknown';
    }
}

function showTeamManagement() {
    document.getElementById('team-management-modal').style.display = 'flex';
    renderTeamMembersList();
}

function closeTeamManagement() {
    document.getElementById('team-management-modal').style.display = 'none';
}

function renderTeamMembersList() {
    const container = document.getElementById('team-members-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (teamMembers.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No team members yet. Add one above!</div>';
        return;
    }
    
    teamMembers.forEach(member => {
        const memberElement = document.createElement('div');
        memberElement.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        `;
        
        memberElement.innerHTML = `
            <div style="display: flex; align-items: center;">
                <div class="assignee-avatar" style="background: ${member.color}; margin-right: 0.75rem;">
                    ${member.name.split(' ').map(n => n[0]).join('')}
                </div>
                <div>
                    <div style="font-weight: 500;">${member.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">${member.role} â€¢ ${member.max_hours}h/week</div>
                    ${member.email ? `<div style="font-size: 0.75rem; color: #9ca3af;">${member.email}</div>` : ''}
                </div>
            </div>
            <button onclick="window.removeTeamMember('${member.id}')" 
                    style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">
                Remove
            </button>
        `;
        
        container.appendChild(memberElement);
    });
}

function addTeamMember(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const member = {
        id: generateUUID(),
        name: formData.get('name'),
        role: formData.get('role') || 'Team Member',
        email: formData.get('email') || '',
        max_hours: parseInt(formData.get('max_hours')) || 40,
        color: generateTeamMemberColor()
    };
    
    teamMembers.push(member);
    
    // Save to IndexedDB (if we want persistence)
    localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
    
    // Update UI
    renderTeamMembersList();
    renderTeamFilterChips();
    populateAssigneeDropdowns();
    
    // Clear form
    event.target.reset();
    
    showNotification(`Team member ${member.name} added successfully!`, 'success');
}

function removeTeamMember(memberId) {
    if (confirm('Are you sure you want to remove this team member?')) {
        teamMembers = teamMembers.filter(member => member.id !== memberId);
        
        // Save to localStorage
        localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
        
        // Update UI
        renderTeamMembersList();
        renderTeamFilterChips();
        populateAssigneeDropdowns();
        
        showNotification('Team member removed successfully!', 'success');
    }
}

function generateTeamMemberColor() {
    const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'];
    return colors[teamMembers.length % colors.length];
}

function loadTeamMembersFromStorage() {
    const stored = localStorage.getItem('teamMembers');
    if (stored) {
        try {
            teamMembers = JSON.parse(stored);
        } catch (e) {
            console.error('Failed to load team members from storage:', e);
        }
    }
}

// Update activity rendering to show assignee colors
function enhanceActivityWithAssignee(activityElement, activity) {
    if (activity.assigned_to) {
        const member = teamMembers.find(m => m.id === activity.assigned_to);
        if (member) {
            activityElement.classList.add('assigned');
            activityElement.style.setProperty('--assignee-color', member.color);
            
            // Add workload indicator
            const workloadLevel = calculateMemberWorkloadLevel(member.id);
            const indicator = document.createElement('div');
            indicator.className = `workload-indicator ${workloadLevel}`;
            activityElement.appendChild(indicator);
        }
    }
}

function calculateMemberWorkloadLevel(memberId) {
    const member = teamMembers.find(m => m.id === memberId);
    if (!member) return 'workload-low';
    
    const startOfWeek = getStartOfWeek(currentCalendarDate);
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const workload = calculateTeamWorkload(startOfWeek, endOfWeek);
    const memberWorkload = workload[memberId] || { hours: 0 };
    const utilizationPercent = (memberWorkload.hours / member.max_hours) * 100;
    
    return getWorkloadLevel(utilizationPercent);
}

// ========================================
// NEW Sprint 4.2.4: Recurring Activities Management
// ========================================

let currentRecurringActivity = null;

function toggleRecurringOptions(checkbox) {
    const options = document.getElementById('quick-recurring-options');
    const preview = document.getElementById('quick-recurring-preview');
    
    if (checkbox.checked) {
        options.classList.add('active');
        updateRecurringPreview();
        
        // Add event listeners for live preview updates
        document.getElementById('quick-recurring-frequency').addEventListener('change', updateRecurringPreview);
        document.getElementById('quick-recurring-interval').addEventListener('input', updateRecurringPreview);
        document.getElementById('quick-recurring-end-date').addEventListener('change', updateRecurringPreview);
        document.getElementById('quick-recurring-count').addEventListener('input', updateRecurringPreview);
    } else {
        options.classList.remove('active');
        preview.style.display = 'none';
    }
}

function updateRecurringPreview() {
    const frequency = document.getElementById('quick-recurring-frequency').value;
    const interval = parseInt(document.getElementById('quick-recurring-interval').value) || 1;
    const endDate = document.getElementById('quick-recurring-end-date').value;
    const count = parseInt(document.getElementById('quick-recurring-count').value);
    
    // Update unit text
    const unitElement = document.getElementById('quick-recurring-unit');
    const unitMap = {
        'daily': interval === 1 ? 'day' : 'days',
        'weekly': interval === 1 ? 'week' : 'weeks',
        'monthly': interval === 1 ? 'month' : 'months',
        'yearly': interval === 1 ? 'year' : 'years'
    };
    unitElement.textContent = unitMap[frequency] || 'times';
    
    // Generate preview
    const startDate = quickCreateSlotData ? quickCreateSlotData.date : new Date();
    const previewDates = generateRecurringDates(startDate, frequency, interval, endDate, count, 5); // Show max 5 for preview
    
    const preview = document.getElementById('quick-recurring-preview');
    if (previewDates.length > 0) {
        const totalOccurrences = generateRecurringDates(startDate, frequency, interval, endDate, count).length;
        
        preview.innerHTML = `
            <h5>ðŸ“… Recurring Schedule Preview (${totalOccurrences} total occurrences)</h5>
            <div class="recurring-preview-dates">
                ${previewDates.map(date => 
                    `â€¢ ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}`
                ).join('<br>')}
                ${totalOccurrences > 5 ? '<br>â€¢ ... and more' : ''}
            </div>
        `;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function generateRecurringDates(startDate, frequency, interval, endDate, count, maxPreview = null) {
    const dates = [];
    let currentDate = new Date(startDate);
    const endDateTime = endDate ? new Date(endDate) : null;
    const maxOccurrences = count || CONFIG.BUSINESS.MAX_RECURRING_OCCURRENCES; // Default max to prevent infinite loops
    
    let occurrenceCount = 0;
    
    while (occurrenceCount < maxOccurrences) {
        // Add current date
        dates.push(new Date(currentDate));
        occurrenceCount++;
        
        // Check if we've reached the end date
        if (endDateTime && currentDate >= endDateTime) break;
        
        // Check if we've reached preview limit
        if (maxPreview && dates.length >= maxPreview) break;
        
        // Calculate next date based on frequency and interval
        switch (frequency) {
            case 'daily':
                currentDate.setDate(currentDate.getDate() + interval);
                break;
            case 'weekly':
                currentDate.setDate(currentDate.getDate() + (interval * 7));
                break;
            case 'monthly':
                currentDate.setMonth(currentDate.getMonth() + interval);
                break;
            case 'yearly':
                currentDate.setFullYear(currentDate.getFullYear() + interval);
                break;
        }
    }
    
    return dates;
}

function createRecurringActivities(baseActivityData, recurringConfig) {
    console.log('ðŸ”„ Creating recurring activities...', recurringConfig);
    
    const { frequency, interval, endDate, count } = recurringConfig;
    const startDate = new Date(baseActivityData.scheduled_date);
    const dates = generateRecurringDates(startDate, frequency, interval, endDate, count);
    
    const activities = [];
    const seriesId = generateUUID(); // Common ID for all activities in this series
    
    dates.forEach((date, index) => {
        const activity = {
            ...baseActivityData,
            id: generateUUID(),
            scheduled_date: date.toISOString().split('T')[0],
            recurring_series_id: seriesId,
            recurring_sequence: index + 1,
            recurring_config: index === 0 ? recurringConfig : null, // Only store config in first activity
            is_recurring: true
        };
        
        activities.push(activity);
    });
    
    return activities;
}

function isRecurringActivity(activity) {
    return activity.recurring_series_id && activity.is_recurring;
}

function getRecurringSeriesActivities(seriesId) {
    if (!db.activities) return [];
    
    return db.activities.filter(activity => 
        activity.recurring_series_id === seriesId
    ).sort((a, b) => a.recurring_sequence - b.recurring_sequence);
}

function showRecurringEditModal(activity) {
    console.log('ðŸ”„ Showing recurring edit modal for activity:', activity.id);
    
    currentRecurringActivity = activity;
    
    // Populate activity details
    const detailsContainer = document.getElementById('recurring-activity-details');
    const seriesActivities = getRecurringSeriesActivities(activity.recurring_series_id);
    
    detailsContainer.innerHTML = `
        <div><strong>Title:</strong> ${activity.title}</div>
        <div><strong>Current Date:</strong> ${new Date(activity.scheduled_date).toLocaleDateString()}</div>
        <div><strong>Series Position:</strong> ${activity.recurring_sequence} of ${seriesActivities.length}</div>
        <div><strong>Assigned To:</strong> ${getTeamMemberName(activity.assigned_to) || 'Unassigned'}</div>
    `;
    
    // Show modal
    document.getElementById('recurring-edit-modal').style.display = 'flex';
}

function closeRecurringEditModal() {
    document.getElementById('recurring-edit-modal').style.display = 'none';
    currentRecurringActivity = null;
}

function editRecurringActivity(scope) {
    if (!currentRecurringActivity) return;
    
    console.log('ðŸ”„ Editing recurring activity with scope:', scope);
    
    switch (scope) {
        case 'single':
            // Break this activity out of the series and edit normally
            currentRecurringActivity.recurring_series_id = null;
            currentRecurringActivity.is_recurring = false;
            currentRecurringActivity.recurring_sequence = null;
            currentRecurringActivity.recurring_config = null;
            
            // Save the modified activity
            saveWithRetry('ACTIVITIES', currentRecurringActivity)
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification('Activity removed from series and ready for editing', 'success');
                });
            break;
            
        case 'future':
            // Edit this and all future activities in the series
            const seriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
            const futureActivities = seriesActivities.filter(a => 
                a.recurring_sequence >= currentRecurringActivity.recurring_sequence
            );
            
            // For now, just break them out and edit the first one
            futureActivities.forEach(activity => {
                activity.recurring_series_id = null;
                activity.is_recurring = false;
                activity.recurring_sequence = null;
                activity.recurring_config = null;
            });
            
            Promise.all(futureActivities.map(activity => saveWithRetry('ACTIVITIES', activity)))
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification(`${futureActivities.length} activities removed from series and ready for editing`, 'success');
                });
            break;
            
        case 'all':
            // Edit all activities in the series
            const allSeriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
            
            // For now, just break them all out and edit the first one
            allSeriesActivities.forEach(activity => {
                activity.recurring_series_id = null;
                activity.is_recurring = false;
                activity.recurring_sequence = null;
                activity.recurring_config = null;
            });
            
            Promise.all(allSeriesActivities.map(activity => saveWithRetry('ACTIVITIES', activity)))
                .then(() => {
                    closeRecurringEditModal();
                    editActivity(currentRecurringActivity.id);
                    showNotification(`Entire series (${allSeriesActivities.length} activities) removed from series and ready for editing`, 'success');
                });
            break;
    }
    
    // Refresh calendar
    renderCalendar();
    if (workloadPanelVisible) {
        updateWorkloadPanel();
    }
}

function deleteRecurringSeries() {
    if (!currentRecurringActivity) return;
    
    if (confirm('Are you sure you want to delete the entire recurring series? This cannot be undone.')) {
        const seriesActivities = getRecurringSeriesActivities(currentRecurringActivity.recurring_series_id);
        
        // Remove all activities from the series
        seriesActivities.forEach(activity => {
            const index = db.activities.findIndex(a => a.id === activity.id);
            if (index !== -1) {
                db.activities.splice(index, 1);
            }
        });
        
        // Save changes
        Promise.all(seriesActivities.map(activity => 
            saveWithRetry('ACTIVITIES', activity).catch(() => {
                // Activity might already be deleted, that's ok
            })
        )).then(() => {
            closeRecurringEditModal();
            renderCalendar();
            if (workloadPanelVisible) {
                updateWorkloadPanel();
            }
            showNotification(`Deleted ${seriesActivities.length} activities from recurring series`, 'success');
        });
    }
}

function getTeamMemberName(memberId) {
    if (!memberId) return null;
    const member = teamMembers.find(m => m.id === memberId);
    return member ? member.name : null;
}

function enhanceActivityWithRecurring(activityElement, activity) {
    if (isRecurringActivity(activity)) {
        activityElement.classList.add('recurring');
        
        // Add recurring badge to the text
        const originalText = activityElement.textContent;
        const recurring = activity.recurring_config ? 
            getRecurringText(activity.recurring_config) : 
            `Series ${activity.recurring_sequence}`;
        
        activityElement.innerHTML = `
            ${originalText}
            <span class="recurring-badge">${recurring}</span>
        `;
    }
}

function getRecurringText(config) {
    if (!config) return 'Recurring';
    
    const { frequency, interval } = config;
    const intervalText = interval > 1 ? `${interval} ` : '';
    
    switch (frequency) {
        case 'daily': return `${intervalText}Daily`;
        case 'weekly': return `${intervalText}Weekly`;
        case 'monthly': return `${intervalText}Monthly`;
        case 'yearly': return `${intervalText}Yearly`;
        default: return 'Recurring';
    }
}

// Override editActivityFromCalendar to handle recurring activities
function editActivityFromCalendarRecurring(activityId) {
    closeCalendarSidebar();
    const activity = db.activities.find(a => a.id === activityId);
    
    if (activity) {
        if (isRecurringActivity(activity)) {
            showRecurringEditModal(activity);
        } else {
            editActivity(activityId);
        }
    }
}

// ========================================
// NEW Sprint 4.2.5: Notifications & Reminders System
// ========================================

let notifications = [];
let notificationCenter_visible = false;

function initializeNotificationSystem() {
    console.log('ðŸ”” Initializing notification system...');
    
    // Load notifications from localStorage
    loadNotificationsFromStorage();
    
    // Start notification checking interval
    setInterval(checkForNotifications, 60000); // Check every minute
    
    // Initial check
    checkForNotifications();
    
    // Initialize dashboard alerts
    updateDashboardAlerts();
    updateUpcomingActivitiesWidget();
}

function checkForNotifications() {
    console.log('ðŸ” Checking for new notifications...');
    
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    if (!db.activities) return;
    
    // Check for overdue activities
    checkOverdueActivities(today);
    
    // Check for activities due today
    checkActivitiesToday(today);
    
    // Check for activities due tomorrow
    checkActivitiesTomorrow(tomorrow);
    
    // Check for team workload issues
    checkWorkloadIssues();
    
    // Check for unassigned urgent activities
    checkUnassignedUrgentActivities();
    
    // Update UI
    updateNotificationBadge();
    updateNotificationList();
    updateDashboardAlerts();
    updateUpcomingActivitiesWidget();
}

// Alias function for event handlers
function updateNotificationSystem() {
    console.log('ðŸ”” Updating notification system...');
    if (typeof checkForNotifications === 'function') {
        checkForNotifications();
    }
}

function checkOverdueActivities(today) {
    const overdueActivities = db.activities.filter(activity => 
        activity.scheduled_date && 
        activity.scheduled_date < today && 
        activity.status !== 'completed' && 
        activity.status !== 'cancelled'
    );
    
    overdueActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'overdue' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'overdue',
                priority: 'urgent',
                activityId: activity.id,
                title: 'Overdue Activity',
                message: `"${activity.title}" was due on ${new Date(activity.scheduled_date).toLocaleDateString()}`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkActivitiesToday(today) {
    const todayActivities = db.activities.filter(activity => 
        activity.scheduled_date === today && 
        activity.status === 'scheduled'
    );
    
    todayActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'due_today' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'due_today',
                priority: 'warning',
                activityId: activity.id,
                title: 'Activity Due Today',
                message: `"${activity.title}" is scheduled for today`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkActivitiesTomorrow(tomorrow) {
    const tomorrowActivities = db.activities.filter(activity => 
        activity.scheduled_date === tomorrow && 
        activity.status === 'scheduled'
    );
    
    tomorrowActivities.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'due_tomorrow' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'due_tomorrow',
                priority: 'normal',
                activityId: activity.id,
                title: 'Activity Due Tomorrow',
                message: `"${activity.title}" is scheduled for tomorrow`,
                timestamp: new Date(),
                read: false,
                action: 'view_activity'
            });
        }
    });
}

function checkWorkloadIssues() {
    if (!teamMembers || teamMembers.length === 0) return;
    
    const startOfWeek = getStartOfWeek(new Date());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const workload = calculateTeamWorkload(startOfWeek, endOfWeek);
    
    teamMembers.forEach(member => {
        const memberWorkload = workload[member.id] || { hours: 0 };
        const utilizationPercent = (memberWorkload.hours / member.max_hours) * 100;
        
        if (utilizationPercent > 100) {
            const existingNotification = notifications.find(n => 
                n.type === 'overloaded' && n.memberId === member.id
            );
            
            if (!existingNotification) {
                addNotification({
                    id: generateUUID(),
                    type: 'overloaded',
                    priority: 'urgent',
                    memberId: member.id,
                    title: 'Team Member Overloaded',
                    message: `${member.name} is overloaded this week (${Math.round(utilizationPercent)}% capacity)`,
                    timestamp: new Date(),
                    read: false,
                    action: 'view_workload'
                });
            }
        }
    });
}

function checkUnassignedUrgentActivities() {
    const unassignedUrgent = db.activities.filter(activity => 
        (!activity.assigned_to || activity.assigned_to === '') &&
        activity.priority === 'urgent' &&
        activity.status === 'scheduled'
    );
    
    unassignedUrgent.forEach(activity => {
        const existingNotification = notifications.find(n => 
            n.type === 'unassigned_urgent' && n.activityId === activity.id
        );
        
        if (!existingNotification) {
            addNotification({
                id: generateUUID(),
                type: 'unassigned_urgent',
                priority: 'urgent',
                activityId: activity.id,
                title: 'Urgent Activity Unassigned',
                message: `"${activity.title}" is urgent but not assigned to anyone`,
                timestamp: new Date(),
                read: false,
                action: 'assign_activity'
            });
        }
    });
}

function addNotification(notification) {
    notifications.unshift(notification); // Add to beginning
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    saveNotificationsToStorage();
    console.log('ðŸ”” New notification:', notification.title);
}

function toggleNotificationCenter() {
    const center = document.getElementById('notification-center');
    notificationCenter_visible = !notificationCenter_visible;
    
    if (notificationCenter_visible) {
        center.style.display = 'flex';
        updateNotificationList();
    } else {
        center.style.display = 'none';
    }
}

function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    const bell = document.getElementById('notification-bell');
    const unreadCount = notifications.filter(n => !n.read).length;
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
        badge.style.display = 'flex';
        bell.classList.add('has-notifications');
    } else {
        badge.style.display = 'none';
        bell.classList.remove('has-notifications');
    }
}

function updateNotificationList() {
    const list = document.getElementById('notification-list');
    
    if (notifications.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ””</div>
                <div>No notifications</div>
            </div>
        `;
        return;
    }
    
    list.innerHTML = notifications.map(notification => {
        const timeAgo = sanitizeHTML(getTimeAgo(notification.timestamp));
        const icon = sanitizeHTML(getNotificationIcon(notification.type));
        
        // Critical: Sanitize data used in attributes and content
        const notificationId = sanitizeHTML(String(notification.id));
        const readStatus = notification.read ? '' : 'unread';
        const priority = sanitizeHTML(notification.priority);
        const priorityBg = sanitizeHTML(getIconBackground(notification.priority));
        const title = sanitizeHTML(notification.title);
        const message = sanitizeHTML(notification.message);
        
        return `
            <div class="notification-item ${readStatus} ${priority}" 
                 onclick="window.handleNotificationClick('${notificationId}')">
                <div class="notification-icon" style="background: ${priorityBg};">
                    ${icon}
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                    <div class="notification-time">${timeAgo}</div>
                </div>
            </div>
        `;
    }).join('');
}

/**
 * @description Get notification icon for given type
 * @param {string} type - Notification type
 * @returns {string} Emoji icon
 */
function getNotificationIcon(type) {
    return CONFIG.UI.NOTIFICATION.ICONS[type] || CONFIG.UI.NOTIFICATION.DEFAULT_ICON;
}

function getIconBackground(priority) {
    const backgrounds = {
        'urgent': '#ef4444',
        'warning': '#f59e0b',
        'normal': '#3b82f6',
        'success': '#22c55e'
    };
    return backgrounds[priority] || backgrounds.normal;
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const diffInMinutes = Math.floor((now - new Date(timestamp)) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Just now';
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours}h ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays}d ago`;
}

function handleNotificationClick(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (!notification) return;
    
    // Mark as read
    notification.read = true;
    saveNotificationsToStorage();
    updateNotificationBadge();
    updateNotificationList();
    
    // Handle action
    switch (notification.action) {
        case 'view_activity':
            if (notification.activityId) {
                toggleNotificationCenter();
                showPage('activities');
                // Could highlight the specific activity
            }
            break;
        case 'view_workload':
            toggleNotificationCenter();
            showPage('activities');
            switchActivitiesView('calendar');
            toggleWorkloadPanel();
            break;
        case 'assign_activity':
            if (notification.activityId) {
                toggleNotificationCenter();
                editActivity(notification.activityId);
            }
            break;
    }
}

function markAllNotificationsRead() {
    notifications.forEach(n => n.read = true);
    saveNotificationsToStorage();
    updateNotificationBadge();
    updateNotificationList();
}

function updateDashboardAlerts() {
    const alertsContainer = document.getElementById('dashboard-alerts');
    const alerts = generateDashboardAlerts();
    
    alertsContainer.innerHTML = alerts.map(alert => {
        const alertType = sanitizeHTML(alert.type);
        const alertIcon = sanitizeHTML(alert.icon);
        const alertTitle = sanitizeHTML(alert.title);
        const alertMessage = sanitizeHTML(alert.message);
        
        return `
            <div class="dashboard-alert ${alertType}">
                <div class="dashboard-alert-icon">${alertIcon}</div>
                <div class="dashboard-alert-content">
                    <div class="dashboard-alert-title">${alertTitle}</div>
                    <div class="dashboard-alert-message">${alertMessage}</div>
                </div>
            </div>
        `;
    }).join('');
}

function generateDashboardAlerts() {
    const alerts = [];
    const today = new Date().toISOString().split('T')[0];
    
    if (!db.activities) return alerts;
    
    // Overdue activities alert
    const overdueCount = db.activities.filter(a => 
        a.scheduled_date && a.scheduled_date < today && 
        a.status !== 'completed' && a.status !== 'cancelled'
    ).length;
    
    if (overdueCount > 0) {
        alerts.push({
            type: 'urgent',
            icon: 'â°',
            title: `${overdueCount} Overdue Activities`,
            message: `You have ${overdueCount} activities that are past their scheduled date. Please review and reschedule as needed.`
        });
    }
    
    // Today's activities alert
    const todayCount = db.activities.filter(a => 
        a.scheduled_date === today && a.status === 'scheduled'
    ).length;
    
    if (todayCount > 0) {
        alerts.push({
            type: 'warning',
            icon: 'ðŸ“…',
            title: `${todayCount} Activities Today`,
            message: `You have ${todayCount} activities scheduled for today. Make sure your team is prepared.`
        });
    }
    
    // Unassigned urgent activities
    const unassignedUrgentCount = db.activities.filter(a => 
        (!a.assigned_to || a.assigned_to === '') && 
        a.priority === 'urgent' && 
        a.status === 'scheduled'
    ).length;
    
    if (unassignedUrgentCount > 0) {
        alerts.push({
            type: 'urgent',
            icon: 'ðŸš¨',
            title: `${unassignedUrgentCount} Urgent Activities Unassigned`,
            message: `You have ${unassignedUrgentCount} urgent activities that haven't been assigned to team members yet.`
        });
    }
    
    return alerts;
}

function updateUpcomingActivitiesWidget() {
    const widget = document.getElementById('upcoming-activities-widget');
    const listContainer = document.getElementById('upcoming-activities-list');
    
    const upcomingActivities = getUpcomingActivities();
    
    if (upcomingActivities.length === 0) {
        widget.style.display = 'none';
        return;
    }
    
    widget.style.display = 'block';
    
    listContainer.innerHTML = upcomingActivities.map(activity => {
        const member = teamMembers.find(m => m.id === activity.assigned_to);
        const dateClass = getActivityDateClass(activity.scheduled_date);
        
        return `
            <div class="upcoming-activity-item ${dateClass}" onclick="window.editActivity('${activity.id}')">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${activity.title}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        ðŸ“… ${new Date(activity.scheduled_date).toLocaleDateString()} â€¢ 
                        â±ï¸ ${activity.estimated_hours}h â€¢ 
                        ðŸ‘¤ ${member ? member.name : 'Unassigned'}
                    </div>
                </div>
                <div style="flex-shrink: 0;">
                    <span class="priority-${activity.priority}" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;">
                        ${activity.priority.toUpperCase()}
                    </span>
                </div>
            </div>
        `;
    }).join('');
}

function getUpcomingActivities() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    if (!db.activities) return [];
    
    return db.activities
        .filter(activity => {
            if (!activity.scheduled_date || activity.status !== 'scheduled') return false;
            const activityDate = new Date(activity.scheduled_date);
            return activityDate >= today && activityDate <= nextWeek;
        })
        .sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date))
        .slice(0, 5); // Show max 5
}

function getActivityDateClass(scheduledDate) {
    const today = new Date().toISOString().split('T')[0];
    const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    if (scheduledDate < today) return 'overdue';
    if (scheduledDate === today) return 'today';
    if (scheduledDate === tomorrow) return 'tomorrow';
    return '';
}

function saveNotificationsToStorage() {
    localStorage.setItem('notifications', JSON.stringify(notifications));
}

function loadNotificationsFromStorage() {
    const stored = localStorage.getItem('notifications');
    if (stored) {
        try {
            notifications = JSON.parse(stored);
            // Convert timestamp strings back to Date objects
            notifications.forEach(n => {
                if (typeof n.timestamp === 'string') {
                    n.timestamp = new Date(n.timestamp);
                }
            });
        } catch (e) {
            console.error('Failed to load notifications from storage:', e);
            notifications = [];
        }
    }
}

// ========================================
// NEW Sprint 4.3: Resource Allocation Tracking System
// ========================================

let currentResourceFilters = {
    type: 'all',
    status: 'all'
};

let selectedActivityResources = []; // Resources selected for current activity
let resourceCalendarWeek = new Date(); // Current week for resource calendar

function initializeResourceAllocationSystem() {
    console.log('ðŸ”§ Initializing resource allocation system...');
    updateResourceAllocationPage();
}

function updateResourceAllocationPage() {
    if (document.getElementById('resource-allocation').classList.contains('active')) {
        renderResourceAllocationGrid();
        updateResourceCount();
    }
}

function renderResourceAllocationGrid() {
    const grid = document.getElementById('resource-allocation-grid');
    if (!grid) return;
    
    const resources = getFilteredResources();
    
    if (resources.length === 0) {
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ”§</div>
                <div>No resources found matching current filters</div>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = resources.map(resource => createResourceCard(resource)).join('');
}

function getFilteredResources() {
    if (!db.resources) return [];
    
    return db.resources.filter(resource => {
        // Type filter
        if (currentResourceFilters.type !== 'all' && 
            !resource.category?.toLowerCase().includes(currentResourceFilters.type)) {
            return false;
        }
        
        // Status filter - we'll derive status from current allocations
        const status = getResourceStatus(resource);
        if (currentResourceFilters.status !== 'all' && status !== currentResourceFilters.status) {
            return false;
        }
        
        return true;
    });
}

function getResourceStatus(resource) {
    if (!resource.id || !db.activities) return 'available';
    
    // Check if resource is currently allocated to any active activities
    const activeAllocations = db.activities.filter(activity => 
        activity.status === 'scheduled' && 
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id)
    );
    
    if (activeAllocations.length === 0) return 'available';
    
    // Check for conflicts (multiple activities at same time)
    const today = new Date().toISOString().split('T')[0];
    const conflictingActivities = activeAllocations.filter(activity => 
        activity.scheduled_date >= today
    );
    
    if (conflictingActivities.length > 1) return 'maintenance'; // Using maintenance to indicate conflict
    if (conflictingActivities.length === 1) return 'in-use';
    
    return 'available';
}

function createResourceCard(resource) {
    const status = getResourceStatus(resource);
    const assignments = getCurrentResourceAssignments(resource);
    const utilization = calculateResourceUtilization(resource);
    const conflicts = getResourceConflicts(resource);
    
    const typeClass = mapResourceCategoryToType(resource.category);
    
    return `
        <div class="resource-card ${typeClass}">
            <div class="resource-header">
                <div>
                    <div class="resource-name">${resource.name || 'Unnamed Resource'}</div>
                    <div class="resource-type ${typeClass}">${typeClass}</div>
                </div>
                <div class="resource-status">
                    <div class="resource-status-indicator ${status}"></div>
                    <div class="resource-status-text ${status}">${capitalizeFirst(status.replace('-', ' '))}</div>
                </div>
            </div>
            
            ${assignments.length > 0 ? `
                <div class="resource-assignments">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem;">Current Assignments:</div>
                    ${assignments.slice(0, 3).map(assignment => `
                        <div class="resource-assignment-item">
                            <div class="assignment-activity">
                                <div class="assignment-title">${assignment.title}</div>
                                <div class="assignment-details">
                                    PC: ${assignment.pc_number} â€¢ ${assignment.assignee || 'Unassigned'}
                                </div>
                            </div>
                            <div class="assignment-period">
                                ${new Date(assignment.scheduled_date).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('')}
                    ${assignments.length > 3 ? `<div style="font-size: 0.75rem; color: #6b7280; text-align: center; margin-top: 0.5rem;">+${assignments.length - 3} more assignments</div>` : ''}
                </div>
            ` : ''}
            
            <div class="resource-utilization">
                <div class="utilization-header">
                    <span class="utilization-label">Week Utilization</span>
                    <span class="utilization-percentage">${Math.round(utilization)}%</span>
                </div>
                <div class="utilization-bar">
                    <div class="utilization-fill ${getUtilizationLevel(utilization)}" style="width: ${Math.min(utilization, 100)}%"></div>
                </div>
            </div>
            
            ${conflicts.length > 0 ? `
                <div class="resource-conflict-warning">
                    <div class="conflict-icon">âš ï¸</div>
                    <div class="conflict-content">
                        <div class="conflict-title">Scheduling Conflict</div>
                        <div class="conflict-message">
                            ${conflicts.length} overlapping assignments detected. Review schedule.
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div class="resource-actions">
                <button class="resource-action-btn" onclick="window.viewResourceSchedule('${resource.id}')">
                    ðŸ“… Schedule
                </button>
                <button class="resource-action-btn" onclick="window.editResource('${resource.id}')">
                    âœï¸ Edit
                </button>
            </div>
        </div>
    `;
}

function mapResourceCategoryToType(category) {
    if (!category) return 'tool';
    
    const categoryLower = category.toLowerCase();
    
    if (categoryLower.includes('equipment') || categoryLower.includes('electrical') || categoryLower.includes('lighting')) {
        return 'equipment';
    }
    if (categoryLower.includes('transport') || categoryLower.includes('vehicle')) {
        return 'vehicle';
    }
    if (categoryLower.includes('material') || categoryLower.includes('cable') || categoryLower.includes('wire')) {
        return 'material';
    }
    
    return 'tool';
}

function getCurrentResourceAssignments(resource) {
    if (!resource.id || !db.activities) return [];
    
    const now = new Date();
    const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    return db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date &&
        new Date(activity.scheduled_date) >= now &&
        new Date(activity.scheduled_date) <= nextWeek
    ).map(activity => ({
        title: activity.title,
        pc_number: activity.pc_number,
        scheduled_date: activity.scheduled_date,
        assignee: activity.assigned_to
    }));
}

function calculateResourceUtilization(resource) {
    if (!resource.id || !db.activities) return 0;
    
    // Calculate utilization based on scheduled activities in current week
    const startOfWeek = getStartOfWeek(new Date());
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    const weekActivities = db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date &&
        new Date(activity.scheduled_date) >= startOfWeek &&
        new Date(activity.scheduled_date) <= endOfWeek
    );
    
    const totalHours = weekActivities.reduce((sum, activity) => 
        sum + (parseFloat(activity.estimated_hours) || 0), 0
    );
    
    // Assume maximum 40 hours per week for resources
    return Math.min((totalHours / 40) * 100, 200); // Cap at 200% to show overallocation
}

function getUtilizationLevel(utilization) {
    if (utilization <= 70) return 'low';
    if (utilization <= 100) return 'medium';
    return 'high';
}

function getResourceConflicts(resource) {
    if (!resource.id || !db.activities) return [];
    
    const conflicts = [];
    const resourceActivities = db.activities.filter(activity => 
        activity.status === 'scheduled' &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id) &&
        activity.scheduled_date
    );
    
    // Group by date and check for overlaps
    const dateGroups = {};
    resourceActivities.forEach(activity => {
        const date = activity.scheduled_date;
        if (!dateGroups[date]) dateGroups[date] = [];
        dateGroups[date].push(activity);
    });
    
    Object.values(dateGroups).forEach(activities => {
        if (activities.length > 1) {
            conflicts.push(...activities);
        }
    });
    
    return conflicts;
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function filterResourcesByType(type) {
    // Update active filter button
    document.querySelectorAll('.resource-type-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentResourceFilters.type = type;
    renderResourceAllocationGrid();
    updateResourceCount();
}

function filterResourcesByStatus(status) {
    // Update active filter button
    document.querySelectorAll('.resource-status-filter').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentResourceFilters.status = status;
    renderResourceAllocationGrid();
    updateResourceCount();
}

function updateResourceCount() {
    const countElement = document.getElementById('resource-count');
    if (countElement) {
        const count = getFilteredResources().length;
        countElement.textContent = `${count} resource${count !== 1 ? 's' : ''}`;
    }
}

function refreshResourceAllocation() {
    renderResourceAllocationGrid();
    updateResourceCount();
    showNotification('Resource allocation data refreshed', 'success');
}

function showResourceCalendarView() {
    const calendarView = document.getElementById('resource-calendar-view');
    if (calendarView) {
        calendarView.style.display = 'block';
        renderResourceTimeline();
        updateResourceWeekDisplay();
    }
}

function hideResourceCalendarView() {
    const calendarView = document.getElementById('resource-calendar-view');
    if (calendarView) {
        calendarView.style.display = 'none';
    }
}

function navigateResourceWeek(direction) {
    resourceCalendarWeek.setDate(resourceCalendarWeek.getDate() + (direction * 7));
    renderResourceTimeline();
    updateResourceWeekDisplay();
}

function updateResourceWeekDisplay() {
    const display = document.getElementById('resource-week-display');
    if (display) {
        const startOfWeek = getStartOfWeek(resourceCalendarWeek);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        display.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    }
}

function renderResourceTimeline() {
    const timeline = document.getElementById('resource-timeline');
    if (!timeline) return;
    
    const resources = getFilteredResources();
    const startOfWeek = getStartOfWeek(resourceCalendarWeek);
    
    // Generate days of the week
    const days = [];
    for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        days.push(day);
    }
    
    timeline.innerHTML = `
        <!-- Header row with days -->
        <div class="timeline-row" style="background: #f3f4f6; font-weight: 600;">
            <div class="timeline-resource">Resource</div>
            <div class="timeline-slots">
                ${days.map(day => `
                    <div style="text-align: center; font-size: 0.75rem; padding: 0.5rem;">
                        ${day.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' })}
                    </div>
                `).join('')}
            </div>
        </div>
        
        ${resources.map(resource => `
            <div class="timeline-row">
                <div class="timeline-resource">${resource.name}</div>
                <div class="timeline-slots">
                    ${days.map(day => {
                        const dayStr = day.toISOString().split('T')[0];
                        const availability = getResourceAvailabilityForDay(resource, dayStr);
                        return `
                            <div class="timeline-day ${availability.status}" 
                                 onclick="window.viewResourceDayDetails('${resource.id}', '${dayStr}')"
                                 title="${availability.tooltip}">
                                ${availability.label}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `).join('')}
    `;
}

function getResourceAvailabilityForDay(resource, dateStr) {
    if (!db.activities) return { status: 'available', label: 'âœ“', tooltip: 'Available' };
    
    const dayActivities = db.activities.filter(activity =>
        activity.status === 'scheduled' &&
        activity.scheduled_date === dateStr &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resource.id)
    );
    
    if (dayActivities.length === 0) {
        return { status: 'available', label: 'âœ“', tooltip: 'Available' };
    } else if (dayActivities.length === 1) {
        return { 
            status: 'partial', 
            label: '1', 
            tooltip: `1 activity: ${dayActivities[0].title}` 
        };
    } else {
        return { 
            status: 'busy', 
            label: dayActivities.length.toString(), 
            tooltip: `${dayActivities.length} activities (potential conflict)` 
        };
    }
}

function viewResourceDayDetails(resourceId, dateStr) {
    const resource = db.resources?.find(r => r.id === resourceId);
    const dayActivities = db.activities?.filter(activity =>
        activity.status === 'scheduled' &&
        activity.scheduled_date === dateStr &&
        activity.required_resources &&
        activity.required_resources.some(r => r.resource_id === resourceId)
    ) || [];
    
    if (resource && dayActivities.length > 0) {
        const activityList = dayActivities.map(a => `â€¢ ${a.title} (${a.pc_number})`).join('\n');
        alert(`${resource.name} - ${new Date(dateStr).toLocaleDateString()}\n\nScheduled activities:\n${activityList}`);
    }
}

function viewResourceSchedule(resourceId) {
    // Show resource calendar view and filter to specific resource
    showResourceCalendarView();
    // Could implement specific resource filtering here
}

// Activity Resource Selection Functions

function showActivityResourceSelector() {
    document.getElementById('activity-resource-selector-modal').classList.add('active');
    renderActivityResourceSelector();
    updateActivityResourceSelectorSummary();
}

function closeActivityResourceSelector() {
    document.getElementById('activity-resource-selector-modal').classList.remove('active');
}

function renderActivityResourceSelector() {
    const grid = document.getElementById('resource-selector-grid');
    if (!grid || !db.resources) return;
    
    const searchTerm = document.getElementById('resource-selector-search')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('resource-selector-type-filter')?.value || '';
    
    const filteredResources = db.resources.filter(resource => {
        const nameMatch = resource.name?.toLowerCase().includes(searchTerm);
        const typeMatch = !typeFilter || mapResourceCategoryToType(resource.category) === typeFilter;
        return nameMatch && typeMatch;
    });
    
    grid.innerHTML = filteredResources.map(resource => {
        const isSelected = selectedActivityResources.some(r => r.resource_id === resource.id);
        const typeClass = mapResourceCategoryToType(resource.category);
        
        return `
            <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; ${isSelected ? 'background: #eff6ff;' : ''}" 
                 onclick="window.toggleActivityResourceSelection('${resource.id}')">
                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                       style="margin-right: 0.75rem;" onclick="event.stopPropagation();">
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 0.25rem;">${resource.name}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        <span class="resource-type ${typeClass}" style="margin-right: 0.5rem;">${typeClass.toUpperCase()}</span>
                        ${resource.description || 'No description'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; font-weight: 500;">Â£${resource.cost || '0.00'}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">${resource.unit || 'each'}</div>
                </div>
            </div>
        `;
    }).join('');
    
    if (filteredResources.length === 0) {
        grid.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”§</div>
                <div>No resources found</div>
            </div>
        `;
    }
}

function filterActivityResourceSelector() {
    renderActivityResourceSelector();
}

function toggleActivityResourceSelection(resourceId) {
    const resource = db.resources?.find(r => r.id === resourceId);
    if (!resource) return;
    
    const existingIndex = selectedActivityResources.findIndex(r => r.resource_id === resourceId);
    
    if (existingIndex >= 0) {
        // Remove from selection
        selectedActivityResources.splice(existingIndex, 1);
    } else {
        // Add to selection
        selectedActivityResources.push({
            resource_id: resourceId,
            resource_name: resource.name,
            quantity: 1,
            unit: resource.unit || 'each'
        });
    }
    
    renderActivityResourceSelector();
    updateActivityResourceSelectorSummary();
}

function updateActivityResourceSelectorSummary() {
    const summary = document.getElementById('resource-selector-summary');
    if (!summary) return;
    
    if (selectedActivityResources.length === 0) {
        summary.textContent = 'No resources selected';
        return;
    }
    
    const resourceNames = selectedActivityResources.map(r => r.resource_name).join(', ');
    summary.textContent = `${selectedActivityResources.length} selected: ${resourceNames}`;
}

function confirmActivityResourceSelection() {
    // Update the activity form with selected resources
    updateActivityResourcesList();
    closeActivityResourceSelector();
    
    // Check for conflicts
    checkResourceAvailability();
}

function updateActivityResourcesList() {
    const emptyDiv = document.getElementById('activity-resources-empty');
    const itemsDiv = document.getElementById('activity-resources-items');
    
    if (selectedActivityResources.length === 0) {
        emptyDiv.style.display = 'block';
        itemsDiv.style.display = 'none';
        return;
    }
    
    emptyDiv.style.display = 'none';
    itemsDiv.style.display = 'block';
    
    itemsDiv.innerHTML = selectedActivityResources.map(resource => `
        <div style="display: flex; justify-content: between; align-items: center; padding: 0.5rem; background: white; border-radius: 0.375rem; margin-bottom: 0.5rem; border: 1px solid #e5e7eb;">
            <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 0.875rem;">${resource.resource_name}</div>
                <div style="font-size: 0.75rem; color: #6b7280;">Quantity: ${resource.quantity} ${resource.unit}</div>
            </div>
            <button onclick="window.removeActivityResource('${resource.resource_id}')" 
                    style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">
                Remove
            </button>
        </div>
    `).join('');
}

function removeActivityResource(resourceId) {
    selectedActivityResources = selectedActivityResources.filter(r => r.resource_id !== resourceId);
    updateActivityResourcesList();
    checkResourceAvailability();
}

function checkResourceAvailability() {
    const conflictDiv = document.getElementById('activity-resource-conflicts');
    const scheduledDate = document.getElementById('activity-scheduled-date')?.value;
    
    if (!scheduledDate || selectedActivityResources.length === 0) {
        conflictDiv.style.display = 'none';
        return;
    }
    
    const conflicts = [];
    
    selectedActivityResources.forEach(selectedResource => {
        const conflictingActivities = db.activities?.filter(activity =>
            activity.status === 'scheduled' &&
            activity.scheduled_date === scheduledDate &&
            activity.required_resources &&
            activity.required_resources.some(r => r.resource_id === selectedResource.resource_id)
        ) || [];
        
        if (conflictingActivities.length > 0) {
            conflicts.push({
                resource: selectedResource,
                activities: conflictingActivities
            });
        }
    });
    
    if (conflicts.length === 0) {
        conflictDiv.style.display = 'none';
        return;
    }
    
    conflictDiv.style.display = 'block';
    conflictDiv.innerHTML = `
        <div class="resource-conflict-warning">
            <div class="conflict-icon">âš ï¸</div>
            <div class="conflict-content">
                <div class="conflict-title">Resource Conflicts Detected</div>
                <div class="conflict-message">
                    The following resources are already allocated on ${new Date(scheduledDate).toLocaleDateString()}:
                    <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                        ${conflicts.map(conflict => `
                            <li style="margin-bottom: 0.25rem;">
                                <strong>${conflict.resource.resource_name}</strong> - 
                                ${conflict.activities.map(a => a.title).join(', ')}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
}

// ========================================
// NEW Sprint 4.4: Activity Dependencies & Workflow System
// ========================================

let currentWorkflowMode = CONFIG.WORKFLOW.DEFAULT_MODE;
let selectedActivityForConnection = null;
let currentDependencyType = CONFIG.WORKFLOW.DEFAULT_DEPENDENCY_TYPE;
let selectedDependencyActivity = null;
let activityDependencies = []; // Current activity's dependencies

function initializeWorkflowSystem() {
    console.log('ðŸ”— Initializing workflow system...');
    updateWorkflowView();
}



function updateWorkflowView() {
    if (document.getElementById('activities-workflow-view').style.display === 'none') return;
    
    updateWorkflowStats();
    renderWorkflowCanvas();
    updateWorkflowMinimap();
}

function updateWorkflowStats() {
    if (!db.activities) return;
    
    const total = db.activities.length;
    const inProgress = db.activities.filter(a => a.status === 'in_progress').length;
    const completed = db.activities.filter(a => a.status === 'completed').length;
    const blocked = db.activities.filter(a => getActivityWorkflowStatus(a) === 'blocked').length;
    const criticalPath = calculateCriticalPathLength();
    
    document.getElementById('workflow-total-activities').textContent = total;
    document.getElementById('workflow-in-progress').textContent = inProgress;
    document.getElementById('workflow-completed').textContent = completed;
    document.getElementById('workflow-blocked').textContent = blocked;
    document.getElementById('workflow-critical-path').textContent = criticalPath;
}

function renderWorkflowCanvas() {
    const container = document.getElementById('workflow-nodes-container');
    const connectionsCanvas = document.getElementById('workflow-connections');
    
    if (!container || !db.activities) return;
    
    // Clear existing content
    container.innerHTML = '';
    connectionsCanvas.innerHTML = connectionsCanvas.querySelector('defs').outerHTML;
    
    // Position activities in a grid layout
    const activities = db.activities.slice(); // Copy array
    const columns = Math.ceil(Math.sqrt(activities.length));
    const nodeWidth = 200;
    const nodeHeight = 120;
    const horizontalSpacing = 280;
    const verticalSpacing = 160;
    
    activities.forEach((activity, index) => {
        const col = index % columns;
        const row = Math.floor(index / columns);
        const x = 50 + col * horizontalSpacing;
        const y = 50 + row * verticalSpacing;
        
        const node = createWorkflowNode(activity, x, y);
        container.appendChild(node);
    });
    
    // Draw connections after nodes are positioned
    setTimeout(() => {
        renderWorkflowConnections();
    }, 100);
}

function createWorkflowNode(activity, x, y) {
    const node = document.createElement('div');
    node.className = `workflow-node ${getActivityWorkflowStatus(activity)}`;
    node.style.left = x + 'px';
    node.style.top = y + 'px';
    node.setAttribute('data-activity-id', activity.id);
    
    const isOnCriticalPath = isActivityOnCriticalPath(activity);
    
    node.innerHTML = `
        <div class="workflow-node-header">
            <div class="workflow-node-title">${activity.title || 'Untitled Activity'}</div>
            <div class="workflow-node-status ${getActivityWorkflowStatus(activity)}">${activity.status || 'pending'}</div>
        </div>
        <div class="workflow-node-details">
            <div style="margin-bottom: 0.25rem;">PC: ${activity.pc_number || 'N/A'}</div>
            <div style="margin-bottom: 0.25rem;">Type: ${activity.type || 'N/A'}</div>
            <div>Assigned: ${activity.assigned_to_name || 'Unassigned'}</div>
        </div>
        <div class="workflow-node-dates">
            <div class="workflow-node-date">
                <span>Scheduled:</span>
                <span>${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not set'}</span>
            </div>
            <div class="workflow-node-date">
                <span>Duration:</span>
                <span>${activity.estimated_hours || activity.duration_hours || 0}h</span>
            </div>
        </div>
        ${isOnCriticalPath ? '<div class="critical-path-indicator">!</div>' : ''}
    `;
    
    // Add event listeners
    node.addEventListener('click', () => handleWorkflowNodeClick(activity));
    
    if (currentWorkflowMode === 'edit') {
        makeDraggable(node);
    }
    
    return node;
}

function getActivityWorkflowStatus(activity) {
    if (!activity) return 'pending';
    
    // Check if activity is blocked by dependencies
    if (activity.dependencies && activity.dependencies.length > 0) {
        const blockedByDependencies = activity.dependencies.some(dep => {
            const prerequisite = db.activities.find(a => a.id === dep.activity_id);
            return prerequisite && prerequisite.status !== 'completed';
        });
        
        if (blockedByDependencies && activity.status === 'pending') {
            return 'blocked';
        }
    }
    
    // Map status to workflow status
    switch (activity.status) {
        case 'in_progress': return 'in-progress';
        case 'completed': return 'completed';
        case 'cancelled': return 'blocked';
        default: return 'pending';
    }
}

function renderWorkflowConnections() {
    const canvas = document.getElementById('workflow-connections');
    if (!canvas || !db.activities) return;
    
    const connections = [];
    
    db.activities.forEach(activity => {
        if (activity.dependencies) {
            activity.dependencies.forEach(dep => {
                const fromNode = document.querySelector(`[data-activity-id="${dep.activity_id}"]`);
                const toNode = document.querySelector(`[data-activity-id="${activity.id}"]`);
                
                if (fromNode && toNode) {
                    connections.push({
                        from: fromNode,
                        to: toNode,
                        type: dep.type || 'finish-to-start',
                        isOnCriticalPath: isActivityOnCriticalPath(activity)
                    });
                }
            });
        }
    });
    
    connections.forEach(conn => {
        const line = createConnectionLine(conn.from, conn.to, conn.type, conn.isOnCriticalPath);
        canvas.appendChild(line);
    });
}

function createConnectionLine(fromNode, toNode, type, isOnCriticalPath) {
    const fromRect = fromNode.getBoundingClientRect();
    const toRect = toNode.getBoundingClientRect();
    const canvasRect = document.getElementById('workflow-canvas').getBoundingClientRect();
    
    // Calculate connection points
    const fromX = fromRect.right - canvasRect.left;
    const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
    const toX = toRect.left - canvasRect.left;
    const toY = toRect.top + toRect.height / 2 - canvasRect.top;
    
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    // Create curved path
    const midX = (fromX + toX) / 2;
    const pathData = `M ${fromX} ${fromY} Q ${midX} ${fromY} ${midX} ${(fromY + toY) / 2} Q ${midX} ${toY} ${toX} ${toY}`;
    
    line.setAttribute('d', pathData);
    line.setAttribute('class', `workflow-connection-line ${isOnCriticalPath ? 'critical-path' : ''}`);
    
    return line;
}

function handleWorkflowNodeClick(activity) {
    switch (currentWorkflowMode) {
        case 'view':
            editActivity(activity.id);
            break;
        case 'edit':
            selectWorkflowNode(activity);
            break;
        case 'connect':
            if (!selectedActivityForConnection) {
                selectedActivityForConnection = activity;
                showNotification(`Selected "${activity.title}" as connection source`, 'info');
            } else if (selectedActivityForConnection.id !== activity.id) {
                createActivityConnection(selectedActivityForConnection, activity);
                selectedActivityForConnection = null;
            }
            break;
    }
}

function selectWorkflowNode(activity) {
    // Remove previous selections
    document.querySelectorAll('.workflow-node.selected').forEach(node => {
        node.classList.remove('selected');
    });
    
    // Select current node
    const node = document.querySelector(`[data-activity-id="${activity.id}"]`);
    if (node) {
        node.classList.add('selected');
    }
}

function setWorkflowMode(mode) {
    currentWorkflowMode = mode;
    
    // Update mode buttons
    document.querySelectorAll('.workflow-mode-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // Update canvas based on mode
    renderWorkflowCanvas();
    
    if (mode === 'connect') {
        selectedActivityForConnection = null;
        showNotification('Connection mode: Click source activity, then target activity', 'info');
    }
}

function autoLayoutWorkflow() {
    // Implement automatic layout algorithm
    if (!db.activities) return;
    
    // Simple hierarchical layout based on dependencies
    const activities = db.activities.slice();
    const positioned = new Set();
    const levels = {};
    
    // Calculate levels for each activity
    activities.forEach(activity => {
        levels[activity.id] = calculateActivityLevel(activity, activities);
    });
    
    // Group activities by level
    const levelGroups = {};
    Object.entries(levels).forEach(([activityId, level]) => {
        if (!levelGroups[level]) levelGroups[level] = [];
        levelGroups[level].push(activityId);
    });
    
    // Position activities
    const horizontalSpacing = 300;
    const verticalSpacing = 180;
    const startX = 50;
    const startY = 50;
    
    Object.entries(levelGroups).forEach(([level, activityIds]) => {
        activityIds.forEach((activityId, index) => {
            const node = document.querySelector(`[data-activity-id="${activityId}"]`);
            if (node) {
                const x = startX + parseInt(level) * horizontalSpacing;
                const y = startY + index * verticalSpacing;
                
                node.style.left = x + 'px';
                node.style.top = y + 'px';
            }
        });
    });
    
    // Redraw connections
    setTimeout(() => {
        renderWorkflowConnections();
    }, 100);
    
    showNotification('Workflow layout optimized', 'success');
}

function calculateActivityLevel(activity, allActivities) {
    if (!activity.dependencies || activity.dependencies.length === 0) {
        return 0;
    }
    
    let maxLevel = 0;
    activity.dependencies.forEach(dep => {
        const predecessor = allActivities.find(a => a.id === dep.activity_id);
        if (predecessor) {
            const predecessorLevel = calculateActivityLevel(predecessor, allActivities);
            maxLevel = Math.max(maxLevel, predecessorLevel + 1);
        }
    });
    
    return maxLevel;
}

function calculateCriticalPath() {
    if (!db.activities) return;
    
    // Simple critical path calculation
    const criticalPath = findCriticalPath(db.activities);
    
    // Highlight critical path activities
    document.querySelectorAll('.workflow-node').forEach(node => {
        const activityId = node.getAttribute('data-activity-id');
        if (criticalPath.includes(activityId)) {
            if (!node.querySelector('.critical-path-indicator')) {
                const indicator = document.createElement('div');
                indicator.className = 'critical-path-indicator';
                indicator.textContent = '!';
                node.appendChild(indicator);
            }
        } else {
            const indicator = node.querySelector('.critical-path-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
    });
    
    // Redraw connections with critical path highlighting
    renderWorkflowConnections();
    
    showNotification(`Critical path calculated: ${criticalPath.length} activities`, 'success');
}

function findCriticalPath(activities) {
    // Simplified critical path finding - longest path through dependencies
    const visited = new Set();
    const criticalPath = [];
    
    function findLongestPath(activity, path) {
        if (visited.has(activity.id)) return path;
        
        visited.add(activity.id);
        let longestPath = [...path, activity.id];
        
        // Find activities that depend on this one
        const successors = activities.filter(a => 
            a.dependencies && a.dependencies.some(dep => dep.activity_id === activity.id)
        );
        
        successors.forEach(successor => {
            const successorPath = findLongestPath(successor, [...path, activity.id]);
            if (successorPath.length > longestPath.length) {
                longestPath = successorPath;
            }
        });
        
        visited.delete(activity.id);
        return longestPath;
    }
    
    // Start from activities with no dependencies
    const startActivities = activities.filter(a => 
        !a.dependencies || a.dependencies.length === 0
    );
    
    let longestOverallPath = [];
    startActivities.forEach(activity => {
        const path = findLongestPath(activity, []);
        if (path.length > longestOverallPath.length) {
            longestOverallPath = path;
        }
    });
    
    return longestOverallPath;
}

function calculateCriticalPathLength() {
    if (!db.activities) return 0;
    
    const criticalPath = findCriticalPath(db.activities);
    
    // Calculate total duration of critical path
    let totalDays = 0;
    criticalPath.forEach(activityId => {
        const activity = db.activities.find(a => a.id === activityId);
        if (activity && activity.estimated_hours) {
            totalDays += Math.ceil(activity.estimated_hours / 8); // Convert hours to days
        }
    });
    
    return totalDays;
}

function isActivityOnCriticalPath(activity) {
    if (!db.activities) return false;
    const criticalPath = findCriticalPath(db.activities);
    return criticalPath.includes(activity.id);
}

function optimizeWorkflow() {
    if (!db.activities) return;
    
    // Auto-schedule activities based on dependencies
    const scheduled = new Set();
    const schedule = {};
    
    function scheduleActivity(activity) {
        if (scheduled.has(activity.id)) return schedule[activity.id];
        
        let earliestStart = new Date();
        
        // Check dependencies
        if (activity.dependencies) {
            activity.dependencies.forEach(dep => {
                const predecessor = db.activities.find(a => a.id === dep.activity_id);
                if (predecessor) {
                    const predecessorEnd = scheduleActivity(predecessor);
                    if (predecessorEnd > earliestStart) {
                        earliestStart = predecessorEnd;
                    }
                }
            });
        }
        
        // Calculate end date
        const duration = activity.estimated_hours || activity.duration_hours || 8;
        const durationDays = Math.ceil(duration / 8);
        const endDate = new Date(earliestStart);
        endDate.setDate(endDate.getDate() + durationDays);
        
        schedule[activity.id] = endDate;
        scheduled.add(activity.id);
        
        return endDate;
    }
    
    // Schedule all activities
    db.activities.forEach(activity => {
        scheduleActivity(activity);
    });
    
    // Update activity scheduled dates
    let updatedCount = 0;
    Object.entries(schedule).forEach(([activityId, scheduledDate]) => {
        const activity = db.activities.find(a => a.id === activityId);
        if (activity) {
            const newDate = scheduledDate.toISOString().split('T')[0];
            if (activity.scheduled_date !== newDate) {
                activity.scheduled_date = newDate;
                updatedCount++;
            }
        }
    });
    
    // Save changes
    if (updatedCount > 0) {
        db.activities.forEach(activity => {
            saveWithRetry(STORES.ACTIVITIES, activity);
        });
        
        renderWorkflowCanvas();
        showNotification(`Optimized workflow: ${updatedCount} activities rescheduled`, 'success');
    } else {
        showNotification('Workflow is already optimized', 'info');
    }
}

function updateWorkflowMinimap() {
    const minimap = document.getElementById('workflow-minimap-content');
    if (!minimap || !db.activities) return;
    
    const totalActivities = db.activities.length;
    const completed = db.activities.filter(a => a.status === 'completed').length;
    const inProgress = db.activities.filter(a => a.status === 'in_progress').length;
    const progress = totalActivities > 0 ? Math.round((completed / totalActivities) * 100) : 0;
    
    minimap.innerHTML = `
        <div style="margin-bottom: 0.5rem;">Progress: ${progress}%</div>
        <div style="margin-bottom: 0.25rem;">âœ… Completed: ${completed}</div>
        <div style="margin-bottom: 0.25rem;">ðŸ”„ In Progress: ${inProgress}</div>
        <div>â³ Pending: ${totalActivities - completed - inProgress}</div>
    `;
}

// Dependency Management Functions

function showDependencySelector(type) {
    currentDependencyType = type;
    selectedDependencyActivity = null;
    
    const modal = document.getElementById('dependency-selector-modal');
    const info = document.getElementById('dependency-selector-info');
    
    if (type === 'predecessor') {
        info.innerHTML = `
            <strong>Adding Predecessor:</strong> Select an activity that must be completed before the current activity can start.
            This will create a dependency relationship where the selected activity blocks the current activity until completion.
        `;
    } else {
        info.innerHTML = `
            <strong>Adding Successor:</strong> Select an activity that should start after the current activity is completed.
            This will create a dependency relationship where the current activity blocks the selected activity.
        `;
    }
    
    populateDependencyPCFilters();
    renderDependencySelector();
    modal.classList.add('active');
}

function closeDependencySelector() {
    document.getElementById('dependency-selector-modal').classList.remove('active');
    selectedDependencyActivity = null;
}

function populateDependencyPCFilters() {
    const pcFilter = document.getElementById('dependency-selector-pc-filter');
    pcFilter.innerHTML = '<option value="">All PC Numbers</option>';
    
    if (db.pcs) {
        db.pcs.forEach(pc => {
            const option = document.createElement('option');
            option.value = pc.id;
            option.textContent = `${pc.pc_number || pc.number} - ${pc.company_name || pc.company}`;
            pcFilter.appendChild(option);
        });
    }
}

function renderDependencySelector() {
    const list = document.getElementById('dependency-selector-list');
    const currentActivityId = document.getElementById('activity-id').value;
    
    if (!list || !db.activities) return;
    
    const searchTerm = document.getElementById('dependency-selector-search')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('dependency-selector-status-filter')?.value || '';
    const pcFilter = document.getElementById('dependency-selector-pc-filter')?.value || '';
    
    // Filter activities (exclude current activity and existing dependencies)
    const filteredActivities = db.activities.filter(activity => {
        if (activity.id === currentActivityId) return false;
        
        // Check search term
        if (searchTerm && !activity.title?.toLowerCase().includes(searchTerm)) return false;
        
        // Check status filter
        if (statusFilter && activity.status !== statusFilter) return false;
        
        // Check PC filter
        if (pcFilter && activity.pc_id !== pcFilter) return false;
        
        // Check if already a dependency
        const existingDep = activityDependencies.find(dep => 
            dep.activity_id === activity.id && dep.type === currentDependencyType
        );
        if (existingDep) return false;
        
        return true;
    });
    
    if (filteredActivities.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6b7280;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ðŸ”—</div>
                <div>No activities available for dependency</div>
            </div>
        `;
        return;
    }
    
    list.innerHTML = filteredActivities.map(activity => {
        const isSelected = selectedDependencyActivity?.id === activity.id;
        
        return `
            <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; ${isSelected ? 'background: #eff6ff;' : ''} cursor: pointer;" 
                 onclick="window.selectDependencyActivity('${activity.id}')">
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 0.25rem;">${activity.title}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        PC: ${activity.pc_number || 'N/A'} â€¢ Status: ${activity.status || 'pending'} â€¢ ${activity.estimated_hours || 0}h
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">
                        Scheduled: ${activity.scheduled_date ? new Date(activity.scheduled_date).toLocaleDateString() : 'Not scheduled'}
                    </div>
                </div>
                <div style="margin-left: 1rem;">
                    ${isSelected ? 'âœ“' : ''}
                </div>
            </div>
        `;
    }).join('');
}

function filterDependencySelector() {
    renderDependencySelector();
}

function selectDependencyActivity(activityId) {
    const activity = db.activities?.find(a => a.id === activityId);
    if (!activity) return;
    
    selectedDependencyActivity = activity;
    renderDependencySelector();
}

function confirmDependencySelection() {
    if (!selectedDependencyActivity) {
        alert('Please select an activity first');
        return;
    }
    
    const dependencyType = document.querySelector('input[name="dependencyType"]:checked')?.value || 'finish-to-start';
    
    const dependency = {
        id: generateUUID(),
        activity_id: selectedDependencyActivity.id,
        activity_title: selectedDependencyActivity.title,
        type: dependencyType,
        relationship: currentDependencyType // predecessor or successor
    };
    
    activityDependencies.push(dependency);
    updateDependencyLists();
    closeDependencySelector();
    
    showNotification(`${currentDependencyType} added: ${selectedDependencyActivity.title}`, 'success');
}

function updateDependencyLists() {
    updatePredecessorsList();
    updateSuccessorsList();
}

function updatePredecessorsList() {
    const emptyDiv = document.getElementById('activity-predecessors-empty');
    const listDiv = document.getElementById('activity-predecessors-list');
    
    const predecessors = activityDependencies.filter(dep => dep.relationship === 'predecessor');
    
    if (predecessors.length === 0) {
        emptyDiv.style.display = 'block';
        return;
    }
    
    emptyDiv.style.display = 'none';
    
    const predecessorItems = predecessors.map(dep => `
        <div class="dependency-item">
            <div class="dependency-info">
                <div class="dependency-title">${dep.activity_title}</div>
                <div class="dependency-type">${dep.type}</div>
            </div>
            <div class="dependency-actions">
                <button class="dependency-action" onclick="window.editDependency('${dep.id}')">Edit</button>
                <button class="dependency-action remove" onclick="window.removeDependency('${dep.id}')">Remove</button>
            </div>
        </div>
    `).join('');
    
    // Replace the empty div with the list of items
    listDiv.innerHTML = predecessorItems;
}

function updateSuccessorsList() {
    const emptyDiv = document.getElementById('activity-successors-empty');
    const listDiv = document.getElementById('activity-successors-list');
    
    const successors = activityDependencies.filter(dep => dep.relationship === 'successor');
    
    if (successors.length === 0) {
        emptyDiv.style.display = 'block';
        return;
    }
    
    emptyDiv.style.display = 'none';
    
    const successorItems = successors.map(dep => `
        <div class="dependency-item">
            <div class="dependency-info">
                <div class="dependency-title">${dep.activity_title}</div>
                <div class="dependency-type">${dep.type}</div>
            </div>
            <div class="dependency-actions">
                <button class="dependency-action" onclick="window.editDependency('${dep.id}')">Edit</button>
                <button class="dependency-action remove" onclick="window.removeDependency('${dep.id}')">Remove</button>
            </div>
        </div>
    `).join('');
    
    // Replace the empty div with the list of items
    listDiv.innerHTML = successorItems;
}

function removeDependency(dependencyId) {
    activityDependencies = activityDependencies.filter(dep => dep.id !== dependencyId);
    updateDependencyLists();
    showNotification('Dependency removed', 'success');
}

function editDependency(dependencyId) {
    // For now, just show info about the dependency
    const dependency = activityDependencies.find(dep => dep.id === dependencyId);
    if (dependency) {
        alert(`Dependency: ${dependency.activity_title}\nType: ${dependency.type}\nRelationship: ${dependency.relationship}`);
    }
}

function calculateActivitySchedule() {
    const currentActivityId = document.getElementById('activity-id').value;
    const predecessors = activityDependencies.filter(dep => dep.relationship === 'predecessor');
    
    if (predecessors.length === 0) {
        showNotification('No predecessors defined for automatic scheduling', 'info');
        return;
    }
    
    let latestEnd = new Date();
    
    // Find the latest end date among predecessors
    predecessors.forEach(dep => {
        const predecessor = db.activities?.find(a => a.id === dep.activity_id);
        if (predecessor && predecessor.scheduled_date) {
            const predecessorStart = new Date(predecessor.scheduled_date);
            const duration = predecessor.estimated_hours || predecessor.duration_hours || 8;
            const predecessorEnd = new Date(predecessorStart);
            predecessorEnd.setDate(predecessorEnd.getDate() + Math.ceil(duration / 8));
            
            if (predecessorEnd > latestEnd) {
                latestEnd = predecessorEnd;
            }
        }
    });
    
    // Set the calculated date
    const calculatedDate = latestEnd.toISOString().split('T')[0];
    document.getElementById('activity-scheduled-date').value = calculatedDate;
    
    showNotification(`Scheduled date calculated based on dependencies: ${new Date(calculatedDate).toLocaleDateString()}`, 'success');
}

// ========================================
// NEW Sprint 4.5: Analytics & Reporting System
// ========================================

let currentAnalyticsPeriod = CONFIG.UI.ANALYTICS.DEFAULT_PERIOD_DAYS;
let currentChartPeriod = CONFIG.UI.ANALYTICS.DEFAULT_CHART_PERIOD;

function initializeAnalyticsSystem() {
    console.log('ðŸ“Š Initializing analytics system...');
    if (document.getElementById('analytics').style.display !== 'none') {
        updateAnalytics();
    }
}

function updateAnalytics() {
    console.log('ðŸ“Š Updating analytics...');
    
    updateAnalyticsSummary();
    updateActivityPerformanceChart();
    updateTeamPerformance();
    updateActivityStatusDistribution();
    updateTimeTrackingAnalytics();
    updateResourceUtilization();
    updateActivityHeatmap();
    populateAnalyticsFilters();
}

function updateAnalyticsSummary() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - period);
    
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    const totalActivities = filteredActivities.length;
    const completedActivities = filteredActivities.filter(a => a.status === 'completed').length;
    const completionRate = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
    
    // Calculate average duration
    const activitiesWithDuration = filteredActivities.filter(a => a.estimated_hours || a.duration_hours);
    const avgDuration = activitiesWithDuration.length > 0 
        ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
        : 0;
    
    // Calculate team utilization
    const teamMembers = getUniqueTeamMembers();
    const assignedActivities = filteredActivities.filter(a => a.assigned_to_name).length;
    const teamUtilization = teamMembers.length > 0 && totalActivities > 0 
        ? Math.round((assignedActivities / totalActivities) * 100) 
        : 0;
    
    document.getElementById('summary-total-activities').textContent = totalActivities;
    document.getElementById('summary-completion-rate').textContent = completionRate + '%';
    document.getElementById('summary-avg-duration').textContent = avgDuration + 'h';
    document.getElementById('summary-team-utilization').textContent = teamUtilization + '%';
}

function updateActivityPerformanceChart() {
    const chart = document.getElementById('activity-performance-chart');
    if (!chart || !db.activities) return;
    
    const period = currentChartPeriod;
    const data = generateChartData(period);
    
    chart.innerHTML = '';
    const maxValue = Math.max(...data.map(d => d.value), 1);
    
    data.forEach((item, index) => {
        const bar = document.createElement('div');
        bar.className = 'analytics-chart-bar';
        bar.style.height = `${(item.value / maxValue) * 100}%`;
        bar.style.flex = '1';
        
        const label = document.createElement('div');
        label.className = 'analytics-chart-bar-label';
        label.textContent = item.label;
        
        const value = document.createElement('div');
        value.className = 'analytics-chart-bar-value';
        value.textContent = item.value;
        
        bar.appendChild(label);
        bar.appendChild(value);
        
        bar.addEventListener('click', () => {
            showNotification(`${item.label}: ${item.value} activities`, 'info');
        });
        
        chart.appendChild(bar);
    });
}

function generateChartData(period) {
    if (!db.activities) return [];
    
    const now = new Date();
    const data = [];
    
    switch (period) {
        case 'week':
            // Last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dayActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate.toDateString() === date.toDateString();
                });
                data.push({
                    label: date.toLocaleDateString('en', { weekday: 'short' }),
                    value: dayActivities.length
                });
            }
            break;
        case 'month':
            // Last 4 weeks
            for (let i = 3; i >= 0; i--) {
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - (i + 1) * 7);
                const endDate = new Date(now);
                endDate.setDate(endDate.getDate() - i * 7);
                
                const weekActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate >= startDate && activityDate < endDate;
                });
                
                data.push({
                    label: `Week ${4 - i}`,
                    value: weekActivities.length
                });
            }
            break;
        case 'quarter':
            // Last 3 months
            for (let i = 2; i >= 0; i--) {
                const date = new Date(now);
                date.setMonth(date.getMonth() - i);
                const monthActivities = db.activities.filter(a => {
                    if (!a.scheduled_date) return false;
                    const activityDate = new Date(a.scheduled_date);
                    return activityDate.getMonth() === date.getMonth() && 
                           activityDate.getFullYear() === date.getFullYear();
                });
                data.push({
                    label: date.toLocaleDateString('en', { month: 'short' }),
                    value: monthActivities.length
                });
            }
            break;
    }
    
    return data;
}

function updateTeamPerformance() {
    const container = document.getElementById('team-performance-metrics');
    const table = document.getElementById('team-performance-table');
    
    if (!container || !table || !db.activities) return;
    
    const teamMembers = getUniqueTeamMembers();
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Generate team metrics cards
    container.innerHTML = '';
    teamMembers.slice(0, 4).forEach(member => {
        const memberActivities = filteredActivities.filter(a => a.assigned_to_name === member);
        const completed = memberActivities.filter(a => a.status === 'completed').length;
        const completionRate = memberActivities.length > 0 ? Math.round((completed / memberActivities.length) * 100) : 0;
        
        const card = document.createElement('div');
        card.className = 'analytics-metric-card';
        card.innerHTML = `
            <div class="analytics-metric-value">${memberActivities.length}</div>
            <div class="analytics-metric-label">${member || 'Unassigned'}</div>
            <div class="analytics-metric-change ${completionRate >= 80 ? 'positive' : completionRate >= 60 ? 'neutral' : 'negative'}">
                ${completionRate}% complete
            </div>
        `;
        container.appendChild(card);
    });
    
    // Generate team performance table
    table.innerHTML = '';
    teamMembers.forEach(member => {
        const memberActivities = filteredActivities.filter(a => a.assigned_to_name === member);
        const completed = memberActivities.filter(a => a.status === 'completed').length;
        const completionRate = memberActivities.length > 0 ? Math.round((completed / memberActivities.length) * 100) : 0;
        
        const activitiesWithDuration = memberActivities.filter(a => a.estimated_hours || a.duration_hours);
        const avgDuration = activitiesWithDuration.length > 0 
            ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
            : 0;
        
        const performance = completionRate >= 80 ? 'Excellent' : completionRate >= 60 ? 'Good' : 'Needs Improvement';
        const performanceClass = completionRate >= 80 ? 'positive' : completionRate >= 60 ? 'neutral' : 'negative';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${member || 'Unassigned'}</td>
            <td>${memberActivities.length}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div class="analytics-progress-bar" style="flex: 1;">
                        <div class="analytics-progress-fill" style="width: ${completionRate}%;"></div>
                    </div>
                    <span>${completionRate}%</span>
                </div>
            </td>
            <td>${avgDuration}h</td>
            <td><span class="analytics-metric-change ${performanceClass}">${performance}</span></td>
        `;
        table.appendChild(row);
    });
}

function updateActivityStatusDistribution() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    const pending = filteredActivities.filter(a => a.status === 'pending' || !a.status).length;
    const inProgress = filteredActivities.filter(a => a.status === 'in_progress').length;
    const completed = filteredActivities.filter(a => a.status === 'completed').length;
    const total = filteredActivities.length;
    
    document.getElementById('donut-total').textContent = total;
    document.getElementById('legend-pending').textContent = `Pending (${pending})`;
    document.getElementById('legend-in-progress').textContent = `In Progress (${inProgress})`;
    document.getElementById('legend-completed').textContent = `Completed (${completed})`;
    
    // Update donut chart (simplified - just hide/show based on values)
    const pendingCircle = document.getElementById('donut-pending');
    const inProgressCircle = document.getElementById('donut-in-progress');
    const completedCircle = document.getElementById('donut-completed');
    
    if (total === 0) {
        [pendingCircle, inProgressCircle, completedCircle].forEach(circle => {
            circle.style.strokeDasharray = '0 500';
        });
        return;
    }
    
    const circumference = 2 * Math.PI * 80; // radius = 80
    
    // Pending (starts at top)
    const pendingPercent = (pending / total) * circumference;
    pendingCircle.style.strokeDasharray = `${pendingPercent} ${circumference}`;
    pendingCircle.style.strokeDashoffset = '0';
    
    // In Progress (starts after pending)
    const inProgressPercent = (inProgress / total) * circumference;
    inProgressCircle.style.strokeDasharray = `${inProgressPercent} ${circumference}`;
    inProgressCircle.style.strokeDashoffset = `-${pendingPercent}`;
    
    // Completed (starts after in progress)
    const completedPercent = (completed / total) * circumference;
    completedCircle.style.strokeDasharray = `${completedPercent} ${circumference}`;
    completedCircle.style.strokeDashoffset = `-${pendingPercent + inProgressPercent}`;
}

function updateTimeTrackingAnalytics() {
    if (!db.activities) return;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Calculate total hours logged
    const totalHours = filteredActivities.reduce((sum, a) => {
        return sum + (a.estimated_hours || a.duration_hours || 0);
    }, 0);
    
    // Calculate average activity duration
    const activitiesWithDuration = filteredActivities.filter(a => a.estimated_hours || a.duration_hours);
    const avgDuration = activitiesWithDuration.length > 0 
        ? Math.round(activitiesWithDuration.reduce((sum, a) => sum + (a.estimated_hours || a.duration_hours || 0), 0) / activitiesWithDuration.length)
        : 0;
    
    // Calculate overdue activities
    const now = new Date();
    const overdueActivities = filteredActivities.filter(a => {
        if (!a.scheduled_date || a.status === 'completed') return false;
        const scheduledDate = new Date(a.scheduled_date);
        return scheduledDate < now;
    }).length;
    
    document.getElementById('total-hours-logged').textContent = totalHours;
    document.getElementById('avg-activity-duration').textContent = avgDuration + 'h';
    document.getElementById('overdue-activities').textContent = overdueActivities;
    document.getElementById('overdue-change').textContent = overdueActivities === 0 ? 'All on time' : `${overdueActivities} overdue`;
}

function updateResourceUtilization() {
    const container = document.getElementById('resource-utilization-list');
    if (!container || !db.resources) return;
    
    container.innerHTML = '';
    
    db.resources.slice(0, 5).forEach(resource => {
        const utilization = calculateResourceUtilizationPeriod(resource.id);
        const utilizationLevel = utilization >= 80 ? 'high' : utilization >= 50 ? 'medium' : 'low';
        const utilizationColor = utilization >= 80 ? '#ef4444' : utilization >= 50 ? '#f59e0b' : '#22c55e';
        
        const item = document.createElement('div');
        item.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        `;
        
        item.innerHTML = `
            <div>
                <div style="font-weight: 500; margin-bottom: 0.25rem;">${resource.name}</div>
                <div style="font-size: 0.875rem; color: #6b7280;">${resource.category || 'Resource'}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">${utilization}%</div>
                <div class="analytics-progress-bar" style="width: 100px;">
                    <div class="analytics-progress-fill" style="width: ${utilization}%; background: ${utilizationColor};"></div>
                </div>
            </div>
        `;
        
        container.appendChild(item);
    });
}

function calculateResourceUtilizationPeriod(resourceId) {
    if (!db.activities) return 0;
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    const resourceActivities = filteredActivities.filter(a => 
        a.required_resources && a.required_resources.some(r => r.id === resourceId)
    );
    
    const totalPossibleDays = period;
    const utilizationDays = resourceActivities.length; // Simplified calculation
    
    return Math.min(Math.round((utilizationDays / totalPossibleDays) * 100), 100);
}

function updateActivityHeatmap() {
    const container = document.getElementById('activity-heatmap');
    if (!container || !db.activities) return;
    
    container.innerHTML = '';
    
    // Generate last 30 days
    const today = new Date();
    const heatmapData = {};
    
    // Initialize all days with 0
    for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        heatmapData[dateStr] = 0;
    }
    
    // Count activities per day
    db.activities.forEach(activity => {
        if (activity.scheduled_date && heatmapData.hasOwnProperty(activity.scheduled_date)) {
            heatmapData[activity.scheduled_date]++;
        }
    });
    
    // Find max value for scaling
    const maxActivities = Math.max(...Object.values(heatmapData), 1);
    
    // Create heatmap cells
    Object.entries(heatmapData).forEach(([date, count]) => {
        const cell = document.createElement('div');
        cell.className = 'analytics-heatmap-cell';
        
        // Determine intensity
        const intensity = count / maxActivities;
        if (intensity === 0) {
            // Keep default background
        } else if (intensity <= 0.25) {
            cell.classList.add('low');
        } else if (intensity <= 0.5) {
            cell.classList.add('medium');
        } else if (intensity <= 0.75) {
            cell.classList.add('high');
        } else {
            cell.classList.add('very-high');
        }
        
        cell.title = `${new Date(date).toLocaleDateString()}: ${count} activities`;
        cell.addEventListener('click', () => {
            showNotification(`${new Date(date).toLocaleDateString()}: ${count} activities scheduled`, 'info');
        });
        
        container.appendChild(cell);
    });
}

function filterActivitiesByPeriod(activities, days) {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    return activities.filter(activity => {
        if (!activity.created_at && !activity.scheduled_date) return true; // Include if no date info
        
        const activityDate = new Date(activity.scheduled_date || activity.created_at);
        return activityDate >= cutoffDate;
    });
}

function getUniqueTeamMembers() {
    if (!db.activities) return [];
    
    const members = new Set();
    db.activities.forEach(activity => {
        if (activity.assigned_to_name) {
            members.add(activity.assigned_to_name);
        }
    });
    
    return Array.from(members);
}

function populateAnalyticsFilters() {
    const teamFilter = document.getElementById('analytics-team-filter');
    if (!teamFilter) return;
    
    // Clear existing options except "All Team Members"
    teamFilter.innerHTML = '<option value="">All Team Members</option>';
    
    const teamMembers = getUniqueTeamMembers();
    teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member;
        option.textContent = member;
        teamFilter.appendChild(option);
    });
}

function setChartPeriod(period, button) {
    currentChartPeriod = period;
    
    // Update button states
    document.querySelectorAll('.analytics-period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    updateActivityPerformanceChart();
}

function exportAnalyticsReport() {
    if (!db.activities) {
        showNotification('No data available to export', 'warning');
        return;
    }
    
    const period = parseInt(document.getElementById('analytics-period-filter')?.value || 30);
    const filteredActivities = filterActivitiesByPeriod(db.activities, period);
    
    // Generate CSV data
    const csvData = [
        ['Activity Title', 'PC Number', 'Type', 'Status', 'Assigned To', 'Scheduled Date', 'Duration (hours)', 'Created Date']
    ];
    
    filteredActivities.forEach(activity => {
        csvData.push([
            activity.title || '',
            activity.pc_number || '',
            activity.type || '',
            activity.status || '',
            activity.assigned_to_name || '',
            activity.scheduled_date || '',
            activity.estimated_hours || activity.duration_hours || '',
            activity.created_at || ''
        ]);
    });
    
    // Convert to CSV string
    const csvString = csvData.map(row => 
        row.map(cell => `"${cell}"`).join(',')
    ).join('\n');
    
    // Create and download file
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotification('Analytics report exported successfully', 'success');
}

// ========================================
// AktywnoÅ›ci
// ========================================

function showActivityModal() {
    db.editingActivity = null;
    document.getElementById('activity-modal-title').textContent = 'New Activity';
    
    // Clear all form fields
    document.getElementById('activity-id').value = '';
    document.getElementById('activity-title').value = '';
    document.getElementById('activity-description').value = '';
    document.getElementById('activity-type').value = '';
    document.getElementById('activity-priority').value = 'medium';
    document.getElementById('activity-status').value = 'pending';
    document.getElementById('activity-scheduled-date').value = '';
    document.getElementById('activity-scheduled-time').value = '';
    document.getElementById('activity-duration').value = '';
    document.getElementById('activity-assigned-to-name').value = '';
    document.getElementById('activity-location').value = '';
    document.getElementById('activity-contact-name').value = '';
    document.getElementById('activity-contact-phone').value = '';
    document.getElementById('activity-completion-notes').value = '';
    
    // NEW Sprint 4.3: Clear selected resources and update display
    selectedActivityResources = [];
    updateActivityResourcesList();
    
    // NEW Sprint 4.4: Clear dependencies
    activityDependencies = [];
    updateDependencyLists();

    const pcSelect = document.getElementById('activity-pc-select');
    pcSelect.innerHTML = '<option value="">Select...</option>';
    db.pcs.forEach(pc => {
        const pcNumber = pc.pc_number || pc.number;
        const companyName = pc.company_name || pc.company;
        pcSelect.innerHTML += `<option value="${pc.id}">${pcNumber} - ${companyName}</option>`;
    });
    if(db.currentPC) pcSelect.value = db.currentPC.id;

    // Hide completion section initially
    document.getElementById('activity-completion-section').style.display = 'none';
    
    // Add event listener for status change
    document.getElementById('activity-status').addEventListener('change', function() {
        const completionSection = document.getElementById('activity-completion-section');
        if (this.value === 'completed') {
            completionSection.style.display = 'block';
        } else {
            completionSection.style.display = 'none';
        }
    });

    document.getElementById('activity-modal').classList.add('active');
}

function closeActivityModal() {
    document.getElementById('activity-modal').classList.remove('active');
}

async function saveActivity() {
    const id = document.getElementById('activity-id').value;
    const now = new Date().toISOString();
    
    const activityData = {
        title: document.getElementById('activity-title').value.trim(),
        description: document.getElementById('activity-description').value.trim(),
        pc_id: document.getElementById('activity-pc-select').value,
        type: document.getElementById('activity-type').value.trim(),
        status: document.getElementById('activity-status').value,
        priority: document.getElementById('activity-priority').value,
        scheduled_date: document.getElementById('activity-scheduled-date').value,
        scheduled_time: document.getElementById('activity-scheduled-time').value,
        duration_hours: parseFloat(document.getElementById('activity-duration').value) || null,
        estimated_hours: parseFloat(document.getElementById('activity-duration').value) || null, // NEW Sprint 4.3: For resource allocation calculations
        assigned_to: null, // UUID would go here if we had user management
        assigned_to_name: document.getElementById('activity-assigned-to-name').value.trim(),
        location: document.getElementById('activity-location').value.trim(),
        contact_name: document.getElementById('activity-contact-name').value.trim(),
        contact_phone: document.getElementById('activity-contact-phone').value.trim(),
        completion_notes: document.getElementById('activity-completion-notes').value.trim(),
        // NEW Sprint 4.3: Resource allocation
        required_resources: selectedActivityResources || [],
        // NEW Sprint 4.4: Dependencies
        dependencies: activityDependencies.filter(dep => dep.relationship === 'predecessor') || [],
        updated_at: now
    };

    // Required fields validation
    if(!activityData.pc_id || !activityData.title || !activityData.type) {
        alert("PC Number, Activity Title, and Activity Type are required!");
        return;
    }

    // Get PC data for denormalization
    const pc = db.pcs.find(p => p.id === activityData.pc_id);
    if (pc) {
        activityData.pc_number = pc.pc_number || pc.number;
        activityData.company_name = pc.company_name || pc.company;
    }
    
    // Set completed_at if status is completed
    if (activityData.status === 'completed' && !id) {
        activityData.completed_at = now;
    }

    try {
        if (id) { // Edit existing
            const index = db.activities.findIndex(a => a.id === id);
            if (index !== -1) {
                db.activities[index] = { ...db.activities[index], ...activityData };
                await saveToStore(STORES.ACTIVITIES, db.activities[index]);
            }
        } else { // Create new
            activityData.id = generateUUID();
            activityData.created_at = now;
    db.activities.push(activityData);
            await saveToStore(STORES.ACTIVITIES, activityData);
        }
    
                console.log('âœ… Activity saved successfully');
        // Fix: Keep activity open after saving instead of closing
        if (id) {
            // For edits, stay on the activity (re-populate form)
            alert('Activity updated successfully!');
        } else {
            // For new activities, close modal and refresh list
            // NEW Sprint 4.3: Clear selected resources after saving
            selectedActivityResources = [];
            // NEW Sprint 4.4: Clear dependencies after saving
            activityDependencies = [];
    closeActivityModal();
    updateActivitiesList();
        }
    } catch (error) {
        console.error('âŒ Error saving activity:', error);
        alert('Error saving activity. Please try again.');
    }
}

function updateActivitiesList() {
    // Guard clause: ensure db is initialized
    if (!db || !db.activities || !db.pcs) {
        console.warn('âš ï¸ updateActivitiesList called before db initialization');
        return;
    }
    
    const tbody = document.getElementById('activities-list');
    tbody.innerHTML = '';
    db.activities.forEach(a => {
        const pc = db.pcs.find(p => p.id === (a.pc_id || a.pcId));
        const pcNumber    = sanitizeHTML(pc ? (pc.pc_number || pc.number) : (a.pc_number || '-'));
        const companyName = sanitizeHTML(pc ? (pc.company_name || pc.company) : (a.company_name || '-'));
        const scheduledDate = a.scheduled_date ? new Date(a.scheduled_date).toLocaleDateString() : (a.date ? new Date(a.date).toLocaleDateString() : '-');
        const title       = sanitizeHTML(a.title || a.type || '-');
        const type        = sanitizeHTML(a.type);
        const priority    = a.priority ? `<span class=\"priority-${a.priority}\">${a.priority.toUpperCase()}</span>` : '-';
        const status      = sanitizeHTML(a.status);

        tbody.innerHTML += `<tr>
            <td>${title}</td>
            <td>${pcNumber}</td>
            <td>${companyName}</td>
            <td>${type}</td>
            <td>${scheduledDate}</td>
            <td>${priority}</td>
            <td><span class=\"activity-status ${status}\">${status}</span></td>
            <td><button class=\"secondary\" onclick=\"alert('Feature under development')\">Show</button></td>
        </tr>`;
    });
}


// ========================================
// Zasoby i Cenniki
// ========================================

function updateResourcesList() {
    const tbody = document.getElementById('resources-list');
    tbody.innerHTML = '';
    db.resources.forEach(res => {
        const name        = sanitizeHTML(res.name);
        const sku         = sanitizeHTML(res.sku || '-');
        const category    = sanitizeHTML(res.category);
        const supplier    = sanitizeHTML(res.supplier || '-');
        const netCost     = res.net_cost || res.netCost || 0;
        const status      = res.is_active !== false ? 'Active' : 'Inactive';
        const statusClass = res.is_active !== false ? 'success' : 'secondary';

        tbody.innerHTML += `<tr>
            <td>${name}</td>
            <td>${sku}</td>
            <td>${category}</td>
            <td>Â£${netCost.toFixed(2)}</td>
            <td>${supplier}</td>
            <td><span class="${statusClass}">${status}</span></td>
            <td><div class="action-btn-group">
                <button onclick="window.editResource('${res.id}')" class="warning">Edit</button>
                <button onclick="window.deleteResource('${res.id}')" class="danger">Remove</button>
            </div></td>
        </tr>`;
    });
}

function showResourceModal() {
    db.editingResource = null;
    document.getElementById('resource-modal-title').textContent = 'New Resource';
    
    // Clear all form fields
    document.getElementById('resource-id').value = '';
    document.getElementById('resource-name').value = '';
    document.getElementById('resource-description').value = '';
    document.getElementById('resource-category').value = '';
    document.getElementById('resource-subcategory').value = '';
    document.getElementById('resource-sku').value = '';
    document.getElementById('resource-unit').value = '';
    document.getElementById('resource-cost').value = '';
    document.getElementById('resource-supplier').value = '';
    document.getElementById('resource-supplier-code').value = '';
    document.getElementById('resource-status').value = 'true';
    document.getElementById('resource-min-quantity').value = '';
    document.getElementById('resource-lead-time').value = '';
    document.getElementById('resource-weight').value = '';
    document.getElementById('resource-dimensions').value = '';
    document.getElementById('resource-warranty').value = '';
    
    document.getElementById('resource-modal').classList.add('active');
}

function closeResourceModal() {
    document.getElementById('resource-modal').classList.remove('active');
}

async function saveResource() {
    const id = document.getElementById('resource-id').value;
    const now = new Date().toISOString();
    
    const resourceData = {
        name: document.getElementById('resource-name').value.trim(),
        description: document.getElementById('resource-description').value.trim(),
        category: document.getElementById('resource-category').value,
        subcategory: document.getElementById('resource-subcategory').value.trim(),
        sku: document.getElementById('resource-sku').value.trim(),
        unit: document.getElementById('resource-unit').value,
        net_cost: parseFloat(document.getElementById('resource-cost').value),
        supplier: document.getElementById('resource-supplier').value.trim(),
        supplier_code: document.getElementById('resource-supplier-code').value.trim(),
        is_active: document.getElementById('resource-status').value === 'true',
        min_quantity: parseInt(document.getElementById('resource-min-quantity').value) || null,
        lead_time_days: parseInt(document.getElementById('resource-lead-time').value) || null,
        weight_kg: parseFloat(document.getElementById('resource-weight').value) || null,
        dimensions: document.getElementById('resource-dimensions').value.trim(),
        warranty_months: parseInt(document.getElementById('resource-warranty').value) || null,
        updated_at: now
    };

    // Required fields validation
    if(!resourceData.name || !resourceData.category || isNaN(resourceData.net_cost) || !resourceData.unit) {
        alert("Resource Name, Category, Net Cost, and Unit are required!");
        return;
    }

    try {
        if (id) { // Edit existing
            const index = db.resources.findIndex(r => r.id === id);
            if (index !== -1) {
                db.resources[index] = { ...db.resources[index], ...resourceData };
                await saveToStore(STORES.RESOURCES, db.resources[index]);
            }
        } else { // Create new
            resourceData.id = generateUUID();
            resourceData.created_at = now;
        db.resources.push(resourceData);
            await saveToStore(STORES.RESOURCES, resourceData);
    }

        console.log('âœ… Resource saved successfully');
    closeResourceModal();
    updateResourcesList();
    } catch (error) {
        console.error('âŒ Error saving resource:', error);
        alert('Error saving resource. Please try again.');
    }
}

function editResource(id) {
    const res = db.resources.find(r => r.id === id);
    if (!res) return;
    db.editingResource = res;
    
    document.getElementById('resource-modal-title').textContent = 'Edit Resource';
    document.getElementById('resource-id').value = res.id;
    document.getElementById('resource-name').value = res.name || '';
    document.getElementById('resource-description').value = res.description || '';
    document.getElementById('resource-category').value = res.category || '';
    document.getElementById('resource-subcategory').value = res.subcategory || '';
    document.getElementById('resource-sku').value = res.sku || '';
    document.getElementById('resource-unit').value = res.unit || '';
    document.getElementById('resource-cost').value = res.net_cost || res.netCost || '';
    document.getElementById('resource-supplier').value = res.supplier || '';
    document.getElementById('resource-supplier-code').value = res.supplier_code || '';
    document.getElementById('resource-status').value = res.is_active !== undefined ? res.is_active.toString() : 'true';
    document.getElementById('resource-min-quantity').value = res.min_quantity || '';
    document.getElementById('resource-lead-time').value = res.lead_time_days || '';
    document.getElementById('resource-weight').value = res.weight_kg || '';
    document.getElementById('resource-dimensions').value = res.dimensions || '';
    document.getElementById('resource-warranty').value = res.warranty_months || '';
    
    document.getElementById('resource-modal').classList.add('active');
}

function deleteResource(id) {
    if (confirm('Are you sure you want to delete this resource? It cannot be used in future quotes.')) {
        db.resources = db.resources.filter(r => r.id !== id);
        // NaleÅ¼y teÅ¼ usunÄ…Ä‡ zasÃ³b z cennikÃ³w
        db.priceLists.forEach(pl => {
            pl.items = pl.items.filter(item => item.resourceId !== id);
        });
        saveDataToIndexedDB();
        updateResourcesList();
    }
}


function updatePriceListsTable() {
    const tbody = document.getElementById('pricelist-table');
    tbody.innerHTML = '';
    db.priceLists.forEach(pl => {
        const effectiveFrom = pl.effective_from ? new Date(pl.effective_from).toLocaleDateString() : '-';
        const effectiveTo = pl.effective_to ? new Date(pl.effective_to).toLocaleDateString() : 'No expiry';
        const effectivePeriod = `${effectiveFrom} - ${effectiveTo}`;
        const isDefault = pl.is_default ? '<span class="success">âœ“ Default</span>' : '-';
        const statusClass = pl.status === 'active' ? 'success' : (pl.status === 'draft' ? 'warning' : 'secondary');
        
        tbody.innerHTML += `<tr>
            <td>${pl.name}</td>
            <td>${pl.version || '-'}</td>
            <td>${pl.currency || 'GBP'}</td>
            <td>${effectivePeriod}</td>
            <td>${isDefault}</td>
            <td><span class="${statusClass}">${pl.status}</span></td>
            <td><div class="action-btn-group">
                <button class="secondary" onclick="window.viewPriceList('${pl.id}')">Manage</button>
                <button class="warning" onclick="window.editPriceList('${pl.id}')">Edit</button>
            </div></td>
        </tr>`;
    });
}

async function createPriceList() {
    const id = document.getElementById('pricelist-id').value;
    const now = new Date().toISOString();
    
    const priceListData = {
        name: document.getElementById('pricelist-name').value.trim(),
        version: document.getElementById('pricelist-version').value.trim(),
        description: document.getElementById('pricelist-description').value.trim(),
        currency: document.getElementById('pricelist-currency').value,
        status: document.getElementById('pricelist-status').value,
        markup_percentage: parseFloat(document.getElementById('pricelist-markup').value) || 0,
        discount_percentage: parseFloat(document.getElementById('pricelist-discount').value) || 0,
        effective_from: document.getElementById('pricelist-effective-from').value,
        effective_to: document.getElementById('pricelist-effective-to').value,
        is_default: document.getElementById('pricelist-is-default').checked,
        terms: document.getElementById('pricelist-terms').value.trim(),
        updated_at: now
    };

    // Required fields validation
    if (!priceListData.name || !priceListData.version || !priceListData.effective_from) {
        alert('Price List Name, Version, and Effective From date are required!');
        return;
    }

    try {
        if (id) { // Edit existing
            const index = db.priceLists.findIndex(pl => pl.id === id);
            if (index !== -1) {
                // Preserve existing pricing_data
                priceListData.pricing_data = db.priceLists[index].pricing_data || {};
                db.priceLists[index] = { ...db.priceLists[index], ...priceListData };
                await saveToStore(STORES.PRICE_LISTS, db.priceLists[index]);
            }
        } else { // Create new
            priceListData.id = generateUUID();
            priceListData.created_at = now;
            priceListData.pricing_data = {};
            
            // If this is set as default, unset other defaults
            if (priceListData.is_default) {
                db.priceLists.forEach(pl => {
                    if (pl.is_default) {
                        pl.is_default = false;
                        saveToStore(STORES.PRICE_LISTS, pl);
                    }
                });
            }
            
            db.priceLists.push(priceListData);
            await saveToStore(STORES.PRICE_LISTS, priceListData);
        }

        console.log('âœ… Price List saved successfully');
    showPage('pricelists');
    } catch (error) {
        console.error('âŒ Error saving price list:', error);
        alert('Error saving price list. Please try again.');
    }
}

function clearPriceListForm() {
    document.getElementById('pricelist-form-title').textContent = 'New Price List';
    document.getElementById('pricelist-id').value = '';
    document.getElementById('pricelist-name').value = '';
    document.getElementById('pricelist-version').value = '';
    document.getElementById('pricelist-description').value = '';
    document.getElementById('pricelist-currency').value = 'GBP';
    document.getElementById('pricelist-status').value = 'active';
    document.getElementById('pricelist-markup').value = '';
    document.getElementById('pricelist-discount').value = '';
    document.getElementById('pricelist-effective-from').value = '';
    document.getElementById('pricelist-effective-to').value = '';
    document.getElementById('pricelist-is-default').checked = false;
    document.getElementById('pricelist-terms').value = 'Prices valid for 30 days from quote date. Payment terms: 30 days net. Delivery charges may apply.';
}

function editPriceList(id) {
    const pl = db.priceLists.find(p => p.id === id);
    if (!pl) return;
    
    document.getElementById('pricelist-form-title').textContent = 'Edit Price List';
    document.getElementById('pricelist-id').value = pl.id;
    document.getElementById('pricelist-name').value = pl.name || '';
    document.getElementById('pricelist-version').value = pl.version || '';
    document.getElementById('pricelist-description').value = pl.description || '';
    document.getElementById('pricelist-currency').value = pl.currency || 'GBP';
    document.getElementById('pricelist-status').value = pl.status || 'active';
    document.getElementById('pricelist-markup').value = pl.markup_percentage || '';
    document.getElementById('pricelist-discount').value = pl.discount_percentage || '';
    document.getElementById('pricelist-effective-from').value = pl.effective_from || '';
    document.getElementById('pricelist-effective-to').value = pl.effective_to || '';
    document.getElementById('pricelist-is-default').checked = pl.is_default || false;
    document.getElementById('pricelist-terms').value = pl.terms || '';
    
    showPage('new-pricelist');
}

function viewPriceList(id) {
    const pl = db.priceLists.find(p => p.id === id);
    if (!pl) return;
    db.currentPriceList = pl;
    document.getElementById('pricelist-title').textContent = pl.name;
    const tbody = document.getElementById('pricelist-items');
    tbody.innerHTML = '';
    pl.items.forEach(item => {
        const resource = db.resources.find(r => r.id === item.resourceId);
        if (resource) {
            const margin = item.clientPrice > 0 ? ((item.clientPrice - resource.netCost) / item.clientPrice * 100) : 0;
            tbody.innerHTML += `<tr>
                <td>${resource.name}</td><td>Â£${resource.netCost.toFixed(2)}</td><td>Â£${item.clientPrice.toFixed(2)}</td><td>${margin.toFixed(1)}%</td>
                <td><button class="danger" onclick="window.removeResourceFromPriceList('${item.resourceId}')">Remove</button></td>
            </tr>`;
        }
    });
    showPage('pricelist-detail');
}

function showAddResourceToPriceList() {
    const select = document.getElementById('modal-resource-item-select');
    select.innerHTML = '<option value="">Select resource...</option>';
    db.resources.forEach(res => {
        // Nie dodawaj, jeÅ›li juÅ¼ jest na liÅ›cie
        if (!db.currentPriceList.items.some(item => item.resourceId === res.id)) {
            select.innerHTML += `<option value="${res.id}">${res.name}</option>`;
        }
    });
    document.getElementById('add-resource-modal').classList.add('active');
}

function closeAddResourceModal() {
    document.getElementById('add-resource-modal').classList.remove('active');
}

function updateResourceInfo() {
    const resId = document.getElementById('modal-resource-item-select').value;
    const infoDiv = document.getElementById('resource-info');
    if(resId) {
        const res = db.resources.find(r => r.id === resId);
        infoDiv.innerHTML = `Net Cost: Â£${res.netCost.toFixed(2)}`;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}
document.getElementById('modal-resource-item-select').addEventListener('change', updateResourceInfo);


function calculateMargin() {
    const resId = document.getElementById('modal-resource-item-select').value;
    const clientPrice = parseFloat(document.getElementById('modal-client-price').value);
    const marginDiv = document.getElementById('margin-info');
    if (resId && clientPrice > 0) {
        const res = db.resources.find(r => r.id === resId);
        const margin = ((clientPrice - res.netCost) / clientPrice * 100).toFixed(1);
        marginDiv.innerHTML = `Margin: ${margin}%`;
    } else {
        marginDiv.innerHTML = '';
    }
}

async function addResourceToPriceList() {
    const resourceId = document.getElementById('modal-resource-item-select').value;
    const clientPrice = parseFloat(document.getElementById('modal-client-price').value);

    if(!resourceId || isNaN(clientPrice)) {
        alert('Select resource and enter price!');
        return;
    }

    const resource = db.resources.find(r => r.id === resourceId);
    if (!resource) return;

    const netCost = resource.net_cost || resource.netCost || 0;
    const calculatedMarkup = netCost > 0 ? ((clientPrice - netCost) / netCost * 100) : 0;

    const pricingItem = {
        price: clientPrice,
        markup_percentage: calculatedMarkup,
        effective_price: clientPrice,
        min_quantity: resource.min_quantity || 1,
        notes: ''
    };

    // Initialize pricing_data if it doesn't exist
    if (!db.currentPriceList.pricing_data) {
        db.currentPriceList.pricing_data = {};
    }
    
    // Add or update resource in pricing_data (JSONB structure)
    db.currentPriceList.pricing_data[resourceId] = pricingItem;

    // Keep backward compatibility with old items structure
    if (!db.currentPriceList.items) db.currentPriceList.items = [];
    const existingIndex = db.currentPriceList.items.findIndex(item => item.resourceId === resourceId);
    if (existingIndex >= 0) {
        db.currentPriceList.items[existingIndex] = { resourceId, clientPrice };
    } else {
    db.currentPriceList.items.push({ resourceId, clientPrice });
    }

    try {
        await saveToStore(STORES.PRICE_LISTS, db.currentPriceList);
        console.log('âœ… Resource added to price list successfully');
    closeAddResourceModal();
    viewPriceList(db.currentPriceList.id);
    } catch (error) {
        console.error('âŒ Error adding resource to price list:', error);
        alert('Error adding resource to price list. Please try again.');
    }
}

function removeResourceFromPriceList(resourceId) {
    db.currentPriceList.items = db.currentPriceList.items.filter(item => item.resourceId !== resourceId);
    saveDataToIndexedDB();
    viewPriceList(db.currentPriceList.id);
}


// ========================================
// MODULE ORGANIZATION
// ========================================

/**
 * @namespace CRM
 * @description Main application namespace organizing all functionality into logical modules
 */
const CRM = {
    
    /**
     * @namespace CRM.Database
     * @description Low-level IndexedDB operations
     */
    Database: {
        generateUUID,
        initialize: initializeIndexedDB,
        saveWithRetry,
        save: saveToStore,
        load: loadFromStore,
        loadAll: loadAllFromStore,
        delete: deleteFromStore,
        loadData: loadDataFromIndexedDB,
        saveData: saveDataToIndexedDB,
        reset: resetData,
        initializeDemo: initializeWithDemoData
    },

    /**
     * @namespace CRM.DataAccess
     * @description Centralized Data Access Layer with validation, caching, and error handling
     */
    DataAccess: {
        // Core CRUD Operations
        async findById(entity, id) {
            try {
                if (!id) throw new Error('ID is required');
                
                // Try cache first
                const cached = db[this.getEntityStore(entity)]?.find(item => item.id === id);
                if (cached) return cached;
                
                // Load from IndexedDB if not in cache
                const result = await loadFromStore(this.getStoreKey(entity), id);
                if (result && db[this.getEntityStore(entity)]) {
                    // Update cache
                    const index = db[this.getEntityStore(entity)].findIndex(item => item.id === id);
                    if (index === -1) {
                        db[this.getEntityStore(entity)].push(result);
                    }
                }
                return result;
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling
                await CRM.ErrorHandler.handle(error, `Finding ${entity} by ID`, {
                    showUser: false, // Don't show user message for data retrieval
                    category: 'database'
                });
                throw error; // Re-throw for caller handling
            }
        },

        async findByField(entity, field, value) {
            try {
                if (!field || value === undefined) throw new Error('Field and value are required');
                
                // Search in cache
                const entityStore = this.getEntityStore(entity);
                if (db[entityStore]) {
                    return db[entityStore].filter(item => item[field] === value);
                }
                
                // If cache empty, load all and filter
                await this.loadEntity(entity);
                return db[entityStore]?.filter(item => item[field] === value) || [];
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling
                await CRM.ErrorHandler.handle(error, `Finding ${entity} by ${field}`, {
                    showUser: false,
                    category: 'database'
                });
                throw error;
            }
        },

        async save(entity, data, options = {}) {
            try {
                // Validate data
                this.validateEntity(entity, data);
                
                // Add metadata
                const now = new Date().toISOString();
                const enrichedData = {
                    ...data,
                    id: data.id || generateUUID(),
                    updated_at: now,
                    created_at: data.created_at || now
                };
                
                // Save to IndexedDB with retry
                await saveWithRetry(this.getStoreKey(entity), enrichedData);
                
                // Update cache
                const entityStore = this.getEntityStore(entity);
                if (db[entityStore]) {
                    const index = db[entityStore].findIndex(item => item.id === enrichedData.id);
                    if (index !== -1) {
                        db[entityStore][index] = enrichedData;
                    } else {
                        db[entityStore].push(enrichedData);
                    }
                }
                
                console.log(`âœ… ${entity} saved successfully:`, enrichedData.id);
                
                // ðŸš€ NEW: Emit event for loose coupling
                const eventName = `${entity}:${data.id ? 'updated' : 'created'}`;
                await CRM.EventBus.emit(eventName, enrichedData, { continueOnError: true });
                
                return enrichedData;
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling with user notification
                await CRM.ErrorHandler.handle(error, `Saving ${entity}`, {
                    showUser: true, // Show user message for save operations
                    category: error.message?.includes('required') ? 'validation' : 'database',
                    retry: true,
                    retryOperation: () => saveWithRetry(this.getStoreKey(entity), enrichedData || data)
                });
                throw error;
            }
        },

        async update(entity, id, updates) {
            try {
                const existing = await this.findById(entity, id);
                if (!existing) throw new Error(`${entity} with ID ${id} not found`);
                
                const updatedData = {
                    ...existing,
                    ...updates,
                    id: existing.id, // Preserve ID
                    created_at: existing.created_at, // Preserve creation date
                    updated_at: new Date().toISOString()
                };
                
                const result = await this.save(entity, updatedData);
                // Note: save() already emits the 'updated' event
                return result;
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling
                await CRM.ErrorHandler.handle(error, `Updating ${entity}`, {
                    showUser: true,
                    category: 'database'
                });
                throw error;
            }
        },

        async delete(entity, id) {
            try {
                if (!id) throw new Error('ID is required');
                
                // Delete from IndexedDB
                await deleteFromStore(this.getStoreKey(entity), id);
                
                // Remove from cache
                const entityStore = this.getEntityStore(entity);
                if (db[entityStore]) {
                    db[entityStore] = db[entityStore].filter(item => item.id !== id);
                }
                
                console.log(`âœ… ${entity} deleted successfully:`, id);
                
                // ðŸš€ NEW: Emit event for loose coupling
                await CRM.EventBus.emit(`${entity}:deleted`, { id, entity }, { continueOnError: true });
                
                return true;
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling
                await CRM.ErrorHandler.handle(error, `Deleting ${entity}`, {
                    showUser: true,
                    category: 'database'
                });
                throw error;
            }
        },

        async loadEntity(entity) {
            try {
                const data = await loadAllFromStore(this.getStoreKey(entity));
                const entityStore = this.getEntityStore(entity);
                if (db[entityStore] !== undefined) {
                    db[entityStore] = data || [];
                }
                return data || [];
            } catch (error) {
                // ðŸš€ NEW: Use centralized error handling
                await CRM.ErrorHandler.handle(error, `Loading ${entity} data`, {
                    showUser: false, // Silent for background loading
                    category: 'database'
                });
                throw error;
            }
        },

        // Utility methods
        getStoreKey(entity) {
            const storeMap = {
                'pc': STORES.PCS,
                'pcs': STORES.PCS,
                'quote': STORES.QUOTES,
                'quotes': STORES.QUOTES,
                'activity': STORES.ACTIVITIES,
                'activities': STORES.ACTIVITIES,
                'resource': STORES.RESOURCES,
                'resources': STORES.RESOURCES,
                'priceList': STORES.PRICE_LISTS,
                'priceLists': STORES.PRICE_LISTS,
                'template': STORES.TEMPLATES,
                'templates': STORES.TEMPLATES,
                'activityTemplate': STORES.ACTIVITY_TEMPLATES,
                'activityTemplates': STORES.ACTIVITY_TEMPLATES
            };
            return storeMap[entity] || entity;
        },

        getEntityStore(entity) {
            const entityMap = {
                'pc': 'pcs',
                'pcs': 'pcs',
                'quote': 'quotes',
                'quotes': 'quotes',
                'activity': 'activities',
                'activities': 'activities',
                'resource': 'resources',
                'resources': 'resources',
                'priceList': 'priceLists',
                'priceLists': 'priceLists',
                'template': 'templates',
                'templates': 'templates',
                'activityTemplate': 'activityTemplates',
                'activityTemplates': 'activityTemplates'
            };
            return entityMap[entity] || entity;
        },

        validateEntity(entity, data) {
            if (!data) throw new Error('Data is required');
            
            // Entity-specific validation
            switch (entity) {
                case 'pc':
                case 'pcs':
                    if (!data.pc_number?.trim()) throw new Error('PC number is required');
                    if (!data.company_name?.trim()) throw new Error('Company name is required');
                    break;
                case 'quote':
                case 'quotes':
                    if (!data.pc_id) throw new Error('PC ID is required for quote');
                    if (!data.quote_number?.trim()) throw new Error('Quote number is required');
                    break;
                case 'activity':
                case 'activities':
                    if (!data.title?.trim()) throw new Error('Activity title is required');
                    if (!data.pc_id) throw new Error('PC ID is required for activity');
                    break;
                case 'resource':
                case 'resources':
                    if (!data.name?.trim()) throw new Error('Resource name is required');
                    if (!data.category?.trim()) throw new Error('Resource category is required');
                    break;
            }
            
            return true;
        }
    },

    /**
     * @namespace CRM.EventBus
     * @description Event-driven communication system for loose coupling between modules
     * @example
     * // Subscribe to events
     * CRM.EventBus.on('pc:created', updateDashboard);
     * CRM.EventBus.on('pc:created', refreshDropdowns);
     * 
     * // Emit events
     * CRM.EventBus.emit('pc:created', pcData);
     * 
     * // One-time subscription
     * CRM.EventBus.once('data:loaded', initializeUI);
     */
    EventBus: {
        // Internal event storage
        _events: {},

        /**
         * Subscribe to an event
         * @param {string} event - Event name (e.g., 'pc:created', 'quote:updated')
         * @param {Function} callback - Function to call when event is emitted
         * @param {Object} options - Optional configuration
         * @returns {Function} Unsubscribe function
         */
        on(event, callback, options = {}) {
            if (typeof callback !== 'function') {
                console.error('âŒ EventBus.on: Callback must be a function');
                return () => {};
            }

            if (!this._events[event]) {
                this._events[event] = [];
            }

            const listener = {
                callback,
                once: options.once || false,
                priority: options.priority || 0
            };

            this._events[event].push(listener);

            // Sort by priority (higher first)
            this._events[event].sort((a, b) => b.priority - a.priority);

            console.log(`ðŸ“¡ EventBus: Subscribed to '${event}'`);

            // Return unsubscribe function
            return () => this.off(event, callback);
        },

        /**
         * Subscribe to an event only once
         * @param {string} event - Event name
         * @param {Function} callback - Function to call when event is emitted
         * @returns {Function} Unsubscribe function
         */
        once(event, callback) {
            return this.on(event, callback, { once: true });
        },

        /**
         * Unsubscribe from an event
         * @param {string} event - Event name
         * @param {Function} callback - Callback function to remove
         */
        off(event, callback) {
            if (!this._events[event]) return;

            this._events[event] = this._events[event].filter(
                listener => listener.callback !== callback
            );

            if (this._events[event].length === 0) {
                delete this._events[event];
            }

            console.log(`ðŸ“¡ EventBus: Unsubscribed from '${event}'`);
        },

        /**
         * Emit an event to all subscribers
         * @param {string} event - Event name
         * @param {*} data - Data to pass to event handlers
         * @param {Object} options - Optional configuration
         */
        async emit(event, data = null, options = {}) {
            if (!this._events[event] || this._events[event].length === 0) {
                console.log(`ðŸ“¡ EventBus: No listeners for '${event}'`);
                return;
            }

            console.log(`ðŸ“¡ EventBus: Emitting '${event}' to ${this._events[event].length} listeners`);

            const listeners = [...this._events[event]]; // Copy to avoid modification during iteration
            const results = [];

            for (const listener of listeners) {
                try {
                    // Execute callback
                    const result = await listener.callback(data, event);
                    results.push({ success: true, result });

                    // Remove one-time listeners
                    if (listener.once) {
                        this.off(event, listener.callback);
                    }
                } catch (error) {
                    console.error(`âŒ EventBus: Error in '${event}' listener:`, error);
                    results.push({ success: false, error });
                    
                    if (!options.continueOnError) {
                        throw error;
                    }
                }
            }

            return results;
        },

        /**
         * Remove all listeners for an event or all events
         * @param {string} [event] - Specific event to clear, or omit to clear all
         */
        clear(event = null) {
            if (event) {
                delete this._events[event];
                console.log(`ðŸ“¡ EventBus: Cleared all listeners for '${event}'`);
            } else {
                this._events = {};
                console.log('ðŸ“¡ EventBus: Cleared all event listeners');
            }
        },

        /**
         * Get information about current subscriptions
         * @returns {Object} Event subscription statistics
         */
        getStats() {
            const stats = {
                totalEvents: Object.keys(this._events).length,
                totalListeners: 0,
                events: {}
            };

            for (const [event, listeners] of Object.entries(this._events)) {
                stats.events[event] = listeners.length;
                stats.totalListeners += listeners.length;
            }

            return stats;
        },

        /**
         * Debug: Log all current subscriptions
         */
        debug() {
            console.log('ðŸ“¡ EventBus Debug:', this.getStats());
            for (const [event, listeners] of Object.entries(this._events)) {
                console.log(`  ${event}: ${listeners.length} listeners`);
            }
        }
    },

    /**
     * @namespace CRM.ErrorHandler
     * @description Centralized error handling system with user-friendly messages and recovery strategies
     * @example
     * // Handle errors with context
     * await CRM.ErrorHandler.handle(error, 'PC Creation', { showUser: true, retry: true });
     * 
     * // Show user-friendly messages
     * CRM.ErrorHandler.showUserMessage('validation', 'PC number is required');
     * CRM.ErrorHandler.showToast('Data saved successfully!', 'success');
     * 
     * // Retry operations with backoff
     * const result = await CRM.ErrorHandler.retry(() => saveToStore(store, data), 3);
     */
    ErrorHandler: {
        // Error categories with user-friendly messages
        ERROR_CATEGORIES: {
            VALIDATION: {
                type: 'validation',
                userTitle: 'Input Error',
                defaultMessage: 'Please check your input and try again.',
                icon: 'âš ï¸',
                level: 'warn'
            },
            DATABASE: {
                type: 'database',
                userTitle: 'Data Error',
                defaultMessage: 'Unable to save or load data. Please try again.',
                icon: 'ðŸ’¾',
                level: 'error'
            },
            NETWORK: {
                type: 'network',
                userTitle: 'Connection Error',
                defaultMessage: 'Please check your internet connection and try again.',
                icon: 'ðŸŒ',
                level: 'error'
            },
            UI: {
                type: 'ui',
                userTitle: 'Display Error',
                defaultMessage: 'Something went wrong with the display. Please refresh the page.',
                icon: 'ðŸ–¥ï¸',
                level: 'warn'
            },
            BUSINESS: {
                type: 'business',
                userTitle: 'Operation Error',
                defaultMessage: 'This operation cannot be completed due to business rules.',
                icon: 'ðŸ“‹',
                level: 'info'
            },
            SYSTEM: {
                type: 'system',
                userTitle: 'System Error',
                defaultMessage: 'An unexpected error occurred. Please contact support if this continues.',
                icon: 'âš¡',
                level: 'error'
            }
        },

        // Toast notification queue
        _toastQueue: [],
        _toastContainer: null,

        /**
         * Main error handling method
         * @param {Error|string} error - Error object or message
         * @param {string} context - Context where error occurred (e.g., 'PC Creation', 'Data Loading')
         * @param {Object} options - Handling options
         * @param {boolean} options.showUser - Show user-friendly message (default: true)
         * @param {boolean} options.logError - Log to console (default: true)
         * @param {string} options.category - Error category override
         * @param {boolean} options.retry - Enable automatic retry (default: false)
         * @param {Function} options.retryOperation - Operation to retry
         * @param {number} options.maxRetries - Maximum retry attempts (default: 3)
         * @param {boolean} options.emitEvent - Emit error event (default: true)
         * @returns {Promise<boolean>} Success status after handling
         */
        async handle(error, context = 'Unknown Operation', options = {}) {
            const {
                showUser = true,
                logError = true,
                category = null,
                retry = false,
                retryOperation = null,
                maxRetries = CONFIG.LIMITS.MAX_RETRY_ATTEMPTS,
                emitEvent = true
            } = options;

            try {
                // Categorize error
                const errorCategory = category ? this.ERROR_CATEGORIES[category.toUpperCase()] : this.categorize(error);
                
                // Create standardized error object
                const standardError = {
                    originalError: error,
                    message: error?.message || error?.toString() || 'Unknown error',
                    context,
                    category: errorCategory,
                    timestamp: new Date().toISOString(),
                    stack: error?.stack
                };

                // Log error if requested
                if (logError) {
                    this.logError(standardError);
                }

                // Show user message if requested
                if (showUser) {
                    this.showUserMessage(errorCategory.type, standardError.message, {
                        title: `${errorCategory.userTitle} in ${context}`,
                        context: context
                    });
                }

                // Emit error event for monitoring
                if (emitEvent && typeof CRM.EventBus !== 'undefined') {
                    await CRM.EventBus.emit('error:occurred', standardError, { continueOnError: true });
                }

                // Handle retry if requested
                if (retry && retryOperation && typeof retryOperation === 'function') {
                    try {
                        console.log(`ðŸ”„ Retrying operation: ${context}`);
                        const result = await this.retry(retryOperation, maxRetries);
                        this.showToast(`${context} completed after retry`, 'success');
                        return true;
                    } catch (retryError) {
                        console.error(`âŒ Retry failed for ${context}:`, retryError);
                        this.showUserMessage('system', `${context} failed after ${maxRetries} attempts`, {
                            title: 'Operation Failed'
                        });
                        return false;
                    }
                }

                return false;
            } catch (handlingError) {
                // Fallback error handling to prevent infinite loops
                console.error('âŒ Error in error handler:', handlingError);
                console.error('âŒ Original error:', error);
                alert(`System Error: Unable to handle error properly. Context: ${context}`);
                return false;
            }
        },

        /**
         * Categorize an error based on its properties
         * @param {Error|string} error - Error to categorize
         * @returns {Object} Error category configuration
         */
        categorize(error) {
            if (!error) return this.ERROR_CATEGORIES.SYSTEM;

            const errorMsg = (error.message || error.toString()).toLowerCase();
            
            // Validation errors
            if (errorMsg.includes('required') || errorMsg.includes('invalid') || 
                errorMsg.includes('validation') || errorMsg.includes('format')) {
                return this.ERROR_CATEGORIES.VALIDATION;
            }
            
            // Database errors
            if (errorMsg.includes('database') || errorMsg.includes('indexeddb') || 
                errorMsg.includes('store') || errorMsg.includes('transaction')) {
                return this.ERROR_CATEGORIES.DATABASE;
            }
            
            // Network errors
            if (errorMsg.includes('network') || errorMsg.includes('fetch') || 
                errorMsg.includes('connection') || errorMsg.includes('timeout')) {
                return this.ERROR_CATEGORIES.NETWORK;
            }
            
            // UI errors
            if (errorMsg.includes('element') || errorMsg.includes('dom') || 
                errorMsg.includes('render') || errorMsg.includes('display')) {
                return this.ERROR_CATEGORIES.UI;
            }
            
            // Business logic errors
            if (errorMsg.includes('limit') || errorMsg.includes('rule') || 
                errorMsg.includes('permission') || errorMsg.includes('policy')) {
                return this.ERROR_CATEGORIES.BUSINESS;
            }
            
            // Default to system error
            return this.ERROR_CATEGORIES.SYSTEM;
        },

        /**
         * Log error with standardized format
         * @param {Object} errorObj - Standardized error object
         */
        logError(errorObj) {
            const { category, context, message, timestamp } = errorObj;
            const logMethod = category.level === 'error' ? 'error' : 
                            category.level === 'warn' ? 'warn' : 'log';
            
            console[logMethod](
                `${category.icon} [${category.type.toUpperCase()}] ${context}: ${message}`,
                `\nðŸ“… ${timestamp}`,
                errorObj.originalError
            );
            
            // Enhanced logging for database operations
            if (CONFIG.DEBUG.DATABASE && category.type === 'database') {
                console.group(`ðŸ’¾ Database Error Details`);
                console.log('Context:', context);
                console.log('Message:', message);
                console.log('Stack:', errorObj.stack);
                console.groupEnd();
            }
        },

        /**
         * Show user-friendly message
         * @param {string} categoryType - Error category type
         * @param {string} message - Specific message
         * @param {Object} options - Display options
         */
        showUserMessage(categoryType, message = null, options = {}) {
            const category = this.ERROR_CATEGORIES[categoryType.toUpperCase()] || this.ERROR_CATEGORIES.SYSTEM;
            const { title = category.userTitle, context = null } = options;
            
            const userMessage = message || category.defaultMessage;
            const fullTitle = context ? `${title} in ${context}` : title;
            
            // Use toast for better UX instead of alert
            this.showToast(`${category.icon} ${fullTitle}: ${userMessage}`, 'error', 5000);
        },

        /**
         * Display toast notification
         * @param {string} message - Message to display
         * @param {string} type - Toast type: success, error, warning, info
         * @param {number} duration - Duration in milliseconds (default: 3000)
         */
        showToast(message, type = 'info', duration = 3000) {
            // Create toast container if it doesn't exist
            if (!this._toastContainer) {
                this._toastContainer = document.createElement('div');
                this._toastContainer.id = 'error-toast-container';
                this._toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(this._toastContainer);
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${this.getToastColor(type)};
                color: white;
                padding: 12px 16px;
                margin-bottom: 8px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease-out;
                font-size: 14px;
                line-height: 1.4;
                max-width: 100%;
                word-wrap: break-word;
            `;
            toast.textContent = message;

            // Add to container
            this._toastContainer.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            });

            // Auto-remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);

            // Add click to dismiss
            toast.addEventListener('click', () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
        },

        /**
         * Get color for toast type
         * @param {string} type - Toast type
         * @returns {string} CSS color
         */
        getToastColor(type) {
            const colors = {
                success: '#28a745',
                error: '#dc3545', 
                warning: '#ffc107',
                info: '#17a2b8'
            };
            return colors[type] || colors.info;
        },

        /**
         * Retry an operation with exponential backoff
         * @param {Function} operation - Function to retry
         * @param {number} maxAttempts - Maximum retry attempts
         * @param {number} baseDelay - Base delay in milliseconds
         * @returns {Promise} Result of successful operation
         */
        async retry(operation, maxAttempts = CONFIG.LIMITS.MAX_RETRY_ATTEMPTS, baseDelay = CONFIG.LIMITS.RETRY_DELAY_MS) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    console.log(`ðŸ”„ Attempt ${attempt}/${maxAttempts}`);
                    return await operation();
                } catch (error) {
                    lastError = error;
                    console.warn(`âš ï¸ Attempt ${attempt} failed:`, error.message);
                    
                    if (attempt < maxAttempts) {
                        const delay = baseDelay * Math.pow(2, attempt - 1); // Exponential backoff
                        console.log(`â³ Waiting ${delay}ms before retry...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw new Error(`Operation failed after ${maxAttempts} attempts. Last error: ${lastError.message}`);
        },

        /**
         * Show success message
         * @param {string} message - Success message
         * @param {string} context - Operation context
         */
        showSuccess(message, context = null) {
            const fullMessage = context ? `${context}: ${message}` : message;
            this.showToast(`âœ… ${fullMessage}`, 'success');
        },

        /**
         * Show warning message
         * @param {string} message - Warning message
         * @param {string} context - Operation context
         */
        showWarning(message, context = null) {
            const fullMessage = context ? `${context}: ${message}` : message;
            this.showToast(`âš ï¸ ${fullMessage}`, 'warning');
        }
    },

    /**
     * @namespace CRM.Testing
     * @description Comprehensive testing framework for code quality assurance and developer experience
     * @example
     * // Run all tests
     * await CRM.Testing.runAllTests();
     * 
     * // Run specific test suite
     * await CRM.Testing.runTestSuite('DataAccess');
     * 
     * // Add custom test
     * CRM.Testing.addTest('MyModule', 'should do something', async () => {
     *     const result = await myFunction();
     *     CRM.Testing.assert(result === expected, 'Result should match expected');
     * });
     * 
     * // Performance benchmark
     * const metrics = await CRM.Testing.benchmark('savePC', () => CRM.DataAccess.save('pc', testData));
     */
    Testing: {
        // Test results storage
        _testResults: {},
        _performanceMetrics: {},
        _coverageData: {},
        
        // Test configuration
        config: {
            verbose: true,
            stopOnError: false,
            runPerformanceTests: true,
            trackCoverage: false,
            timeout: 5000 // 5 seconds default timeout
        },

        /**
         * Assertion library for tests
         * @param {boolean} condition - Condition to assert
         * @param {string} message - Error message if assertion fails
         * @throws {Error} If assertion fails
         */
        assert(condition, message = 'Assertion failed') {
            if (!condition) {
                throw new Error(`âŒ ASSERTION FAILED: ${message}`);
            }
        },

        /**
         * Assert equality with detailed comparison
         * @param {*} actual - Actual value
         * @param {*} expected - Expected value
         * @param {string} message - Custom message
         */
        assertEqual(actual, expected, message = null) {
            const defaultMessage = `Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`;
            this.assert(actual === expected, message || defaultMessage);
        },

        /**
         * Assert deep equality for objects
         * @param {*} actual - Actual value
         * @param {*} expected - Expected value
         * @param {string} message - Custom message
         */
        assertDeepEqual(actual, expected, message = null) {
            const defaultMessage = `Deep equality failed: expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`;
            this.assert(JSON.stringify(actual) === JSON.stringify(expected), message || defaultMessage);
        },

        /**
         * Assert that a value is truthy
         * @param {*} value - Value to check
         * @param {string} message - Custom message
         */
        assertTruthy(value, message = null) {
            this.assert(!!value, message || `Expected truthy value, got ${value}`);
        },

        /**
         * Assert that a function throws an error
         * @param {Function} fn - Function that should throw
         * @param {string} message - Custom message
         */
        async assertThrows(fn, message = null) {
            let thrown = false;
            try {
                await fn();
            } catch (error) {
                thrown = true;
            }
            this.assert(thrown, message || 'Expected function to throw an error');
        },

        /**
         * Add a test to a test suite
         * @param {string} suiteName - Name of the test suite
         * @param {string} testName - Name of the test
         * @param {Function} testFn - Test function (async supported)
         */
        addTest(suiteName, testName, testFn) {
            if (!this._testResults[suiteName]) {
                this._testResults[suiteName] = {
                    tests: {},
                    passed: 0,
                    failed: 0,
                    total: 0
                };
            }
            
            this._testResults[suiteName].tests[testName] = {
                fn: testFn,
                status: 'pending',
                error: null,
                duration: 0
            };
            
            this._testResults[suiteName].total++;
        },

        /**
         * Run a single test with timeout and error handling
         * @param {string} suiteName - Test suite name
         * @param {string} testName - Test name
         * @param {Function} testFn - Test function
         * @returns {Promise<Object>} Test result
         */
        async runSingleTest(suiteName, testName, testFn) {
            const startTime = performance.now();
            const test = this._testResults[suiteName].tests[testName];
            
            try {
                // Run test with timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Test timeout')), this.config.timeout)
                );
                
                await Promise.race([testFn(), timeoutPromise]);
                
                test.status = 'passed';
                test.duration = performance.now() - startTime;
                this._testResults[suiteName].passed++;
                
                if (this.config.verbose) {
                    console.log(`âœ… ${suiteName} â†’ ${testName} (${test.duration.toFixed(2)}ms)`);
                }
                
                return { passed: true, duration: test.duration };
            } catch (error) {
                test.status = 'failed';
                test.error = error.message;
                test.duration = performance.now() - startTime;
                this._testResults[suiteName].failed++;
                
                console.error(`âŒ ${suiteName} â†’ ${testName}: ${error.message}`);
                
                if (this.config.stopOnError) {
                    throw error;
                }
                
                return { passed: false, error: error.message, duration: test.duration };
            }
        },

        /**
         * Run all tests in a specific test suite
         * @param {string} suiteName - Name of the test suite
         * @returns {Promise<Object>} Suite results
         */
        async runTestSuite(suiteName) {
            if (!this._testResults[suiteName]) {
                console.warn(`âš ï¸ Test suite '${suiteName}' not found`);
                return { passed: 0, failed: 0, total: 0 };
            }

            console.log(`ðŸ§ª Running test suite: ${suiteName}`);
            const suite = this._testResults[suiteName];
            const startTime = performance.now();
            
            suite.passed = 0;
            suite.failed = 0;
            
            for (const [testName, test] of Object.entries(suite.tests)) {
                await this.runSingleTest(suiteName, testName, test.fn);
            }
            
            const duration = performance.now() - startTime;
            
            console.log(`ðŸ“Š ${suiteName} Results: ${suite.passed}/${suite.total} passed (${duration.toFixed(2)}ms)`);
            
            return {
                suiteName,
                passed: suite.passed,
                failed: suite.failed,
                total: suite.total,
                duration
            };
        },

        /**
         * Run all registered test suites
         * @returns {Promise<Object>} Complete test results
         */
        async runAllTests() {
            console.log('ðŸš€ Starting comprehensive test suite...');
            const overallStart = performance.now();
            
            const results = {
                suites: {},
                totalPassed: 0,
                totalFailed: 0,
                totalTests: 0,
                duration: 0
            };
            
            for (const suiteName of Object.keys(this._testResults)) {
                const suiteResult = await this.runTestSuite(suiteName);
                results.suites[suiteName] = suiteResult;
                results.totalPassed += suiteResult.passed;
                results.totalFailed += suiteResult.failed;
                results.totalTests += suiteResult.total;
            }
            
            results.duration = performance.now() - overallStart;
            
            // Summary report
            console.log('\nðŸ“‹ TEST SUMMARY REPORT');
            console.log('â•'.repeat(50));
            console.log(`Total Tests: ${results.totalTests}`);
            console.log(`âœ… Passed: ${results.totalPassed}`);
            console.log(`âŒ Failed: ${results.totalFailed}`);
            console.log(`â±ï¸ Duration: ${results.duration.toFixed(2)}ms`);
            console.log(`ðŸ“ˆ Success Rate: ${((results.totalPassed / results.totalTests) * 100).toFixed(1)}%`);
            
            if (results.totalFailed > 0) {
                console.log('\nâŒ FAILED TESTS:');
                for (const [suiteName, suite] of Object.entries(this._testResults)) {
                    for (const [testName, test] of Object.entries(suite.tests)) {
                        if (test.status === 'failed') {
                            console.log(`  ${suiteName} â†’ ${testName}: ${test.error}`);
                        }
                    }
                }
            }
            
            return results;
        },

        /**
         * Performance benchmark utility
         * @param {string} name - Benchmark name
         * @param {Function} fn - Function to benchmark
         * @param {number} iterations - Number of iterations (default: 1000)
         * @returns {Promise<Object>} Performance metrics
         */
        async benchmark(name, fn, iterations = 1000) {
            console.log(`âš¡ Running benchmark: ${name} (${iterations} iterations)`);
            
            const results = [];
            const startTime = performance.now();
            
            for (let i = 0; i < iterations; i++) {
                const iterStart = performance.now();
                await fn();
                results.push(performance.now() - iterStart);
            }
            
            const totalTime = performance.now() - startTime;
            const avgTime = results.reduce((a, b) => a + b, 0) / results.length;
            const minTime = Math.min(...results);
            const maxTime = Math.max(...results);
            
            const metrics = {
                name,
                iterations,
                totalTime: totalTime.toFixed(2),
                avgTime: avgTime.toFixed(4),
                minTime: minTime.toFixed(4),
                maxTime: maxTime.toFixed(4),
                opsPerSecond: (1000 / avgTime).toFixed(0)
            };
            
            this._performanceMetrics[name] = metrics;
            
            console.log(`ðŸ“Š ${name} Benchmark Results:`);
            console.log(`  Average: ${metrics.avgTime}ms`);
            console.log(`  Min: ${metrics.minTime}ms`);
            console.log(`  Max: ${metrics.maxTime}ms`);
            console.log(`  Ops/sec: ${metrics.opsPerSecond}`);
            
            return metrics;
        },

        /**
         * Memory usage analysis
         * @returns {Object} Memory metrics
         */
        getMemoryMetrics() {
            if (performance.memory) {
                return {
                    usedJSHeapSize: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    totalJSHeapSize: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    jsHeapSizeLimit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                };
            }
            return { message: 'Memory metrics not available in this browser' };
        },

        /**
         * Initialize built-in test suites
         */
        initializeTestSuites() {
            this.setupDataAccessTests();
            this.setupEventBusTests();
            this.setupErrorHandlerTests();
            this.setupPerformanceTests();
            this.setupIntegrationTests();
        },

        /**
         * Setup Data Access Layer tests
         */
        setupDataAccessTests() {
            // Test data generation
            const generateTestPC = () => ({
                pc_number: `TEST-${Date.now()}`,
                company_name: 'Test Company',
                project_name: 'Test Project',
                account_manager: 'Test Manager',
                client_industry: 'technology',
                client_source: 'website',
                contact_name: 'Test Contact',
                contact_email: 'test@example.com'
            });

            this.addTest('DataAccess', 'should save and retrieve PC data', async () => {
                const testData = generateTestPC();
                const saved = await CRM.DataAccess.save('pc', testData);
                
                this.assertTruthy(saved.id, 'Saved PC should have ID');
                this.assertEqual(saved.pc_number, testData.pc_number, 'PC number should match');
                this.assertTruthy(saved.created_at, 'Should have created_at timestamp');
                this.assertTruthy(saved.updated_at, 'Should have updated_at timestamp');
                
                const retrieved = await CRM.DataAccess.findById('pc', saved.id);
                this.assertDeepEqual(retrieved, saved, 'Retrieved data should match saved data');
            });

            this.addTest('DataAccess', 'should update existing data', async () => {
                const testData = generateTestPC();
                const saved = await CRM.DataAccess.save('pc', testData);
                
                const updates = { company_name: 'Updated Company' };
                const updated = await CRM.DataAccess.update('pc', saved.id, updates);
                
                this.assertEqual(updated.company_name, 'Updated Company', 'Company name should be updated');
                this.assertEqual(updated.id, saved.id, 'ID should remain the same');
                this.assertEqual(updated.created_at, saved.created_at, 'Created date should be preserved');
                this.assert(updated.updated_at > saved.updated_at, 'Updated timestamp should be newer');
            });

            this.addTest('DataAccess', 'should handle validation errors', async () => {
                await this.assertThrows(async () => {
                    await CRM.DataAccess.save('pc', { pc_number: '' }); // Invalid data
                }, 'Should throw validation error for empty PC number');
            });

            this.addTest('DataAccess', 'should delete data correctly', async () => {
                const testData = generateTestPC();
                const saved = await CRM.DataAccess.save('pc', testData);
                
                const deleted = await CRM.DataAccess.delete('pc', saved.id);
                this.assert(deleted === true, 'Delete should return true');
                
                const retrieved = await CRM.DataAccess.findById('pc', saved.id);
                this.assert(retrieved === null || retrieved === undefined, 'Deleted data should not be retrievable');
            });
        },

        /**
         * Setup Event Bus tests
         */
        setupEventBusTests() {
            this.addTest('EventBus', 'should register and emit events', async () => {
                let receivedData = null;
                let callCount = 0;
                
                const unsubscribe = CRM.EventBus.on('test:event', (data) => {
                    receivedData = data;
                    callCount++;
                });
                
                await CRM.EventBus.emit('test:event', { test: 'data' });
                
                this.assertEqual(callCount, 1, 'Event handler should be called once');
                this.assertDeepEqual(receivedData, { test: 'data' }, 'Should receive correct data');
                
                unsubscribe();
            });

            this.addTest('EventBus', 'should handle event priorities', async () => {
                const callOrder = [];
                
                CRM.EventBus.on('priority:test', () => callOrder.push('low'), { priority: 1 });
                CRM.EventBus.on('priority:test', () => callOrder.push('high'), { priority: 10 });
                CRM.EventBus.on('priority:test', () => callOrder.push('medium'), { priority: 5 });
                
                await CRM.EventBus.emit('priority:test');
                
                this.assertDeepEqual(callOrder, ['high', 'medium', 'low'], 'Events should execute in priority order');
                
                CRM.EventBus.clear('priority:test');
            });

            this.addTest('EventBus', 'should handle once() listeners', async () => {
                let callCount = 0;
                
                CRM.EventBus.once('once:test', () => callCount++);
                
                await CRM.EventBus.emit('once:test');
                await CRM.EventBus.emit('once:test');
                
                this.assertEqual(callCount, 1, 'Once listener should only be called once');
            });
        },

        /**
         * Setup Error Handler tests
         */
        setupErrorHandlerTests() {
            this.addTest('ErrorHandler', 'should categorize errors correctly', () => {
                const validationError = new Error('PC number is required');
                const category = CRM.ErrorHandler.categorize(validationError);
                
                this.assertEqual(category.type, 'validation', 'Should categorize as validation error');
                this.assertEqual(category.icon, 'âš ï¸', 'Should have correct icon');
            });

            this.addTest('ErrorHandler', 'should handle errors with context', async () => {
                let toastShown = false;
                const originalShowToast = CRM.ErrorHandler.showToast;
                
                CRM.ErrorHandler.showToast = () => { toastShown = true; };
                
                try {
                    await CRM.ErrorHandler.handle(new Error('Test error'), 'Test Context', {
                        showUser: true,
                        logError: false,
                        emitEvent: false
                    });
                    
                    this.assert(toastShown, 'Should show toast notification');
                } finally {
                    CRM.ErrorHandler.showToast = originalShowToast;
                }
            });
        },

        /**
         * Setup performance tests
         */
        setupPerformanceTests() {
            this.addTest('Performance', 'should measure DAL operations', async () => {
                const testData = {
                    pc_number: `PERF-${Date.now()}`,
                    company_name: 'Performance Test',
                    project_name: 'Performance Project',
                    account_manager: 'Performance Manager',
                    client_industry: 'technology',
                    client_source: 'website',
                    contact_name: 'Performance Contact',
                    contact_email: 'perf@example.com'
                };
                
                const startTime = performance.now();
                const saved = await CRM.DataAccess.save('pc', testData);
                const saveTime = performance.now() - startTime;
                
                this.assert(saveTime < 100, `Save operation should be fast (${saveTime.toFixed(2)}ms)`);
                
                const retrieveStart = performance.now();
                await CRM.DataAccess.findById('pc', saved.id);
                const retrieveTime = performance.now() - retrieveStart;
                
                this.assert(retrieveTime < 50, `Retrieve operation should be fast (${retrieveTime.toFixed(2)}ms)`);
            });
        },

        /**
         * Setup integration tests
         */
        setupIntegrationTests() {
            this.addTest('Integration', 'should integrate DAL with EventBus', async () => {
                let eventReceived = false;
                let eventData = null;
                
                const unsubscribe = CRM.EventBus.on('pc:created', (data) => {
                    eventReceived = true;
                    eventData = data;
                });
                
                const testData = {
                    pc_number: `INT-${Date.now()}`,
                    company_name: 'Integration Test',
                    project_name: 'Integration Project',
                    account_manager: 'Integration Manager',
                    client_industry: 'technology',
                    client_source: 'website',
                    contact_name: 'Integration Contact',
                    contact_email: 'int@example.com'
                };
                
                const saved = await CRM.DataAccess.save('pc', testData);
                
                // Wait a bit for event to be processed
                await new Promise(resolve => setTimeout(resolve, 100));
                
                this.assert(eventReceived, 'Should receive pc:created event');
                this.assertEqual(eventData.id, saved.id, 'Event data should match saved data');
                
                unsubscribe();
            });
        }
    },

    /**
     * @namespace CRM.CodeQuality
     * @description Static analysis and code quality validation system for maintaining high code standards
     * @example
     * // Run full code quality analysis
     * const report = await CRM.CodeQuality.analyzeCodebase();
     * 
     * // Check specific aspects
     * const complexity = CRM.CodeQuality.analyzeFunctionComplexity();
     * const duplicates = CRM.CodeQuality.detectCodeDuplication();
     * const naming = CRM.CodeQuality.validateNamingConventions();
     * const docs = CRM.CodeQuality.checkDocumentationCoverage();
     * const security = CRM.CodeQuality.scanSecurityVulnerabilities();
     * 
     * // Generate quality score
     * const score = CRM.CodeQuality.calculateQualityScore();
     */
    CodeQuality: {
        // Quality metrics storage
        _metrics: {
            complexity: {},
            duplication: {},
            naming: {},
            documentation: {},
            security: {},
            overallScore: 0
        },

        // Quality thresholds and standards
        standards: {
            maxFunctionComplexity: 10,
            maxFunctionLength: 50,
            minDocumentationCoverage: 80,
            maxCodeDuplication: 5,
            requiredNamingPatterns: {
                functions: /^[a-z][a-zA-Z0-9]*$/,
                constants: /^[A-Z][A-Z0-9_]*$/,
                classes: /^[A-Z][a-zA-Z0-9]*$/,
                variables: /^[a-z][a-zA-Z0-9]*$/
            }
        },

        /**
         * Analyze function complexity (cyclomatic complexity approximation)
         * @returns {Object} Complexity analysis results
         */
        analyzeFunctionComplexity() {
            console.log('ðŸ” Analyzing function complexity...');
            const results = {
                functions: [],
                violations: [],
                averageComplexity: 0,
                maxComplexity: 0
            };

            try {
                // Get all function definitions from the current script
                const scriptContent = document.documentElement.outerHTML;
                const functionRegex = /(?:function\s+(\w+)|(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?(?:function|\(.*?\)\s*=>))\s*\([^)]*\)\s*\{/g;
                
                let match;
                while ((match = functionRegex.exec(scriptContent)) !== null) {
                    const functionName = match[1] || match[2];
                    if (!functionName) continue;

                    // Find function body and analyze complexity
                    const functionStartIndex = match.index;
                    const functionBody = this.extractFunctionBody(scriptContent, functionStartIndex);
                    const complexity = this.calculateCyclomaticComplexity(functionBody);
                    const lineCount = functionBody.split('\n').length;

                    const analysis = {
                        name: functionName,
                        complexity,
                        lineCount,
                        startIndex: functionStartIndex,
                        violatesComplexity: complexity > this.standards.maxFunctionComplexity,
                        violatesLength: lineCount > this.standards.maxFunctionLength
                    };

                    results.functions.push(analysis);

                    if (analysis.violatesComplexity || analysis.violatesLength) {
                        results.violations.push({
                            function: functionName,
                            issues: [
                                ...(analysis.violatesComplexity ? [`High complexity: ${complexity} (max: ${this.standards.maxFunctionComplexity})`] : []),
                                ...(analysis.violatesLength ? [`Long function: ${lineCount} lines (max: ${this.standards.maxFunctionLength})`] : [])
                            ]
                        });
                    }

                    results.maxComplexity = Math.max(results.maxComplexity, complexity);
                }

                results.averageComplexity = results.functions.length > 0 
                    ? (results.functions.reduce((sum, f) => sum + f.complexity, 0) / results.functions.length).toFixed(2)
                    : 0;

                this._metrics.complexity = results;

                console.log(`ðŸ“Š Complexity Analysis Complete:`);
                console.log(`  Functions analyzed: ${results.functions.length}`);
                console.log(`  Average complexity: ${results.averageComplexity}`);
                console.log(`  Max complexity: ${results.maxComplexity}`);
                console.log(`  Violations: ${results.violations.length}`);

                return results;
            } catch (error) {
                console.error('âŒ Error in complexity analysis:', error);
                return results;
            }
        },

        /**
         * Extract function body from script content
         * @param {string} content - Script content
         * @param {number} startIndex - Function start index
         * @returns {string} Function body
         */
        extractFunctionBody(content, startIndex) {
            let braceCount = 0;
            let i = startIndex;
            let functionStart = -1;
            
            // Find opening brace
            while (i < content.length) {
                if (content[i] === '{') {
                    if (functionStart === -1) functionStart = i;
                    braceCount++;
                } else if (content[i] === '}') {
                    braceCount--;
                    if (braceCount === 0) {
                        return content.substring(functionStart + 1, i);
                    }
                }
                i++;
            }
            
            return content.substring(functionStart + 1, Math.min(i, startIndex + 2000)); // Limit to prevent infinite parsing
        },

        /**
         * Calculate approximate cyclomatic complexity
         * @param {string} functionBody - Function body code
         * @returns {number} Complexity score
         */
        calculateCyclomaticComplexity(functionBody) {
            // Base complexity is 1
            let complexity = 1;
            
            // Count decision points that increase complexity
            const complexityPatterns = [
                /\bif\s*\(/g,           // if statements
                /\belse\s+if\b/g,       // else if statements
                /\bwhile\s*\(/g,        // while loops
                /\bfor\s*\(/g,          // for loops
                /\bdo\s*\{/g,           // do-while loops
                /\bswitch\s*\(/g,       // switch statements
                /\bcase\s+/g,           // case statements
                /\bcatch\s*\(/g,        // catch blocks
                /\?\s*.*?\s*:/g,        // ternary operators
                /&&/g,                  // logical AND
                /\|\|/g                 // logical OR
            ];

            complexityPatterns.forEach(pattern => {
                const matches = functionBody.match(pattern);
                if (matches) {
                    complexity += matches.length;
                }
            });

            return complexity;
        },

        /**
         * Detect code duplication patterns
         * @returns {Object} Duplication analysis results
         */
        detectCodeDuplication() {
            console.log('ðŸ” Detecting code duplication...');
            const results = {
                duplicates: [],
                duplicatedLines: 0,
                totalLines: 0,
                duplicationPercentage: 0
            };

            try {
                const scriptContent = document.documentElement.outerHTML;
                const lines = scriptContent.split('\n');
                results.totalLines = lines.length;

                // Analyze code blocks for duplication (minimum 3 lines)
                const codeBlocks = this.extractCodeBlocks(lines);
                const duplicateGroups = this.findDuplicateBlocks(codeBlocks);

                duplicateGroups.forEach(group => {
                    if (group.blocks.length > 1) {
                        results.duplicates.push({
                            pattern: group.pattern,
                            locations: group.blocks.map(block => ({
                                startLine: block.startLine,
                                endLine: block.endLine,
                                lineCount: block.lines.length
                            })),
                            duplicateCount: group.blocks.length,
                            linesPerDuplicate: group.blocks[0].lines.length
                        });

                        results.duplicatedLines += group.blocks[0].lines.length * (group.blocks.length - 1);
                    }
                });

                results.duplicationPercentage = results.totalLines > 0 
                    ? ((results.duplicatedLines / results.totalLines) * 100).toFixed(2)
                    : 0;

                this._metrics.duplication = results;

                console.log(`ðŸ“Š Duplication Analysis Complete:`);
                console.log(`  Total lines: ${results.totalLines}`);
                console.log(`  Duplicated lines: ${results.duplicatedLines}`);
                console.log(`  Duplication percentage: ${results.duplicationPercentage}%`);
                console.log(`  Duplicate patterns found: ${results.duplicates.length}`);

                return results;
            } catch (error) {
                console.error('âŒ Error in duplication analysis:', error);
                return results;
            }
        },

        /**
         * Extract meaningful code blocks for duplication analysis
         * @param {string[]} lines - Source code lines
         * @returns {Array} Code blocks
         */
        extractCodeBlocks(lines) {
            const blocks = [];
            const minBlockSize = 3;
            
            for (let i = 0; i <= lines.length - minBlockSize; i++) {
                const block = {
                    startLine: i + 1,
                    endLine: i + minBlockSize,
                    lines: lines.slice(i, i + minBlockSize)
                        .map(line => line.trim())
                        .filter(line => line.length > 0 && !line.startsWith('//') && !line.startsWith('*'))
                };
                
                if (block.lines.length >= minBlockSize) {
                    blocks.push(block);
                }
            }
            
            return blocks;
        },

        /**
         * Find duplicate code blocks
         * @param {Array} blocks - Code blocks to analyze
         * @returns {Array} Groups of duplicate blocks
         */
        findDuplicateBlocks(blocks) {
            const groups = [];
            const processed = new Set();

            blocks.forEach((block, index) => {
                if (processed.has(index)) return;

                const pattern = block.lines.join('\n');
                const duplicates = [block];

                blocks.slice(index + 1).forEach((otherBlock, otherIndex) => {
                    const otherPattern = otherBlock.lines.join('\n');
                    if (pattern === otherPattern && !processed.has(index + 1 + otherIndex)) {
                        duplicates.push(otherBlock);
                        processed.add(index + 1 + otherIndex);
                    }
                });

                if (duplicates.length > 1) {
                    groups.push({
                        pattern,
                        blocks: duplicates
                    });
                }

                processed.add(index);
            });

            return groups;
        },

        /**
         * Validate naming conventions across the codebase
         * @returns {Object} Naming validation results
         */
        validateNamingConventions() {
            console.log('ðŸ” Validating naming conventions...');
            const results = {
                functions: { valid: [], invalid: [] },
                variables: { valid: [], invalid: [] },
                constants: { valid: [], invalid: [] },
                violations: [],
                compliancePercentage: 0
            };

            try {
                const scriptContent = document.documentElement.outerHTML;

                // Analyze function names
                const functionMatches = scriptContent.matchAll(/(?:function\s+(\w+)|(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?(?:function|\())/g);
                for (const match of functionMatches) {
                    const functionName = match[1] || match[2];
                    if (functionName && !functionName.startsWith('_')) {
                        if (this.standards.requiredNamingPatterns.functions.test(functionName)) {
                            results.functions.valid.push(functionName);
                        } else {
                            results.functions.invalid.push(functionName);
                            results.violations.push({
                                type: 'function',
                                name: functionName,
                                issue: 'Should use camelCase pattern (e.g., myFunction)'
                            });
                        }
                    }
                }

                // Analyze variable/constant names
                const variableMatches = scriptContent.matchAll(/(?:const|let|var)\s+([A-Z_][A-Z0-9_]*|[a-z][a-zA-Z0-9]*)\s*=/g);
                for (const match of variableMatches) {
                    const varName = match[1];
                    if (varName) {
                        // Check if it's a constant (all caps)
                        if (/^[A-Z][A-Z0-9_]*$/.test(varName)) {
                            if (this.standards.requiredNamingPatterns.constants.test(varName)) {
                                results.constants.valid.push(varName);
                            } else {
                                results.constants.invalid.push(varName);
                                results.violations.push({
                                    type: 'constant',
                                    name: varName,
                                    issue: 'Should use UPPER_SNAKE_CASE pattern (e.g., MY_CONSTANT)'
                                });
                            }
                        } else {
                            // Regular variable
                            if (this.standards.requiredNamingPatterns.variables.test(varName)) {
                                results.variables.valid.push(varName);
                            } else {
                                results.variables.invalid.push(varName);
                                results.violations.push({
                                    type: 'variable',
                                    name: varName,
                                    issue: 'Should use camelCase pattern (e.g., myVariable)'
                                });
                            }
                        }
                    }
                }

                // Calculate compliance
                const totalItems = results.functions.valid.length + results.functions.invalid.length +
                                 results.variables.valid.length + results.variables.invalid.length +
                                 results.constants.valid.length + results.constants.invalid.length;
                
                const validItems = results.functions.valid.length + results.variables.valid.length + results.constants.valid.length;
                
                results.compliancePercentage = totalItems > 0 ? ((validItems / totalItems) * 100).toFixed(2) : 100;

                this._metrics.naming = results;

                console.log(`ðŸ“Š Naming Convention Analysis Complete:`);
                console.log(`  Functions: ${results.functions.valid.length} valid, ${results.functions.invalid.length} invalid`);
                console.log(`  Variables: ${results.variables.valid.length} valid, ${results.variables.invalid.length} invalid`);
                console.log(`  Constants: ${results.constants.valid.length} valid, ${results.constants.invalid.length} invalid`);
                console.log(`  Compliance: ${results.compliancePercentage}%`);

                return results;
            } catch (error) {
                console.error('âŒ Error in naming convention analysis:', error);
                return results;
            }
        },

        /**
         * Check documentation coverage (JSDoc comments)
         * @returns {Object} Documentation coverage results
         */
        checkDocumentationCoverage() {
            console.log('ðŸ” Checking documentation coverage...');
            const results = {
                functions: { documented: [], undocumented: [] },
                coverage: 0,
                missingDocs: [],
                qualityScore: 0
            };

            try {
                const scriptContent = document.documentElement.outerHTML;

                // Find all function definitions
                const functionMatches = [...scriptContent.matchAll(/(?:function\s+(\w+)|(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?(?:function|\())/g)];
                
                functionMatches.forEach(match => {
                    const functionName = match[1] || match[2];
                    if (!functionName || functionName.startsWith('_')) return;

                    const functionIndex = match.index;
                    const beforeFunction = scriptContent.substring(Math.max(0, functionIndex - 500), functionIndex);
                    
                    // Check for JSDoc comment before function
                    const hasJSDoc = /\/\*\*[\s\S]*?\*\/\s*$/.test(beforeFunction);
                    
                    if (hasJSDoc) {
                        results.functions.documented.push(functionName);
                    } else {
                        results.functions.undocumented.push(functionName);
                        results.missingDocs.push({
                            function: functionName,
                            issue: 'Missing JSDoc documentation'
                        });
                    }
                });

                const totalFunctions = results.functions.documented.length + results.functions.undocumented.length;
                results.coverage = totalFunctions > 0 
                    ? ((results.functions.documented.length / totalFunctions) * 100).toFixed(2)
                    : 100;

                // Calculate quality score based on coverage
                results.qualityScore = Math.min(100, Math.max(0, results.coverage));

                this._metrics.documentation = results;

                console.log(`ðŸ“Š Documentation Coverage Analysis Complete:`);
                console.log(`  Total functions: ${totalFunctions}`);
                console.log(`  Documented: ${results.functions.documented.length}`);
                console.log(`  Undocumented: ${results.functions.undocumented.length}`);
                console.log(`  Coverage: ${results.coverage}%`);

                return results;
            } catch (error) {
                console.error('âŒ Error in documentation analysis:', error);
                return results;
            }
        },

        /**
         * Scan for common security vulnerabilities
         * @returns {Object} Security analysis results
         */
        scanSecurityVulnerabilities() {
            console.log('ðŸ” Scanning for security vulnerabilities...');
            const results = {
                vulnerabilities: [],
                riskLevel: 'LOW',
                recommendations: []
            };

            try {
                const scriptContent = document.documentElement.outerHTML;

                // Common security anti-patterns
                const securityChecks = [
                    {
                        pattern: /innerHTML\s*=\s*[^;]*\+/g,
                        risk: 'HIGH',
                        issue: 'Potential XSS vulnerability with innerHTML concatenation',
                        recommendation: 'Use textContent or properly sanitize HTML'
                    },
                    {
                        pattern: /eval\s*\(/g,
                        risk: 'CRITICAL',
                        issue: 'Use of eval() function',
                        recommendation: 'Avoid eval() - use JSON.parse() or other safe alternatives'
                    },
                    {
                        pattern: /document\.write\s*\(/g,
                        risk: 'MEDIUM',
                        issue: 'Use of document.write()',
                        recommendation: 'Use modern DOM manipulation methods'
                    },
                    {
                        pattern: /localStorage\.setItem\s*\([^,]*,\s*[^)]*password[^)]*\)/gi,
                        risk: 'HIGH',
                        issue: 'Storing password in localStorage',
                        recommendation: 'Never store passwords in localStorage'
                    },
                    {
                        pattern: /console\.log\s*\([^)]*password[^)]*\)/gi,
                        risk: 'MEDIUM',
                        issue: 'Logging sensitive information',
                        recommendation: 'Remove console.log statements with sensitive data'
                    }
                ];

                securityChecks.forEach(check => {
                    const matches = scriptContent.match(check.pattern);
                    if (matches) {
                        matches.forEach(match => {
                            results.vulnerabilities.push({
                                type: check.issue,
                                risk: check.risk,
                                recommendation: check.recommendation,
                                pattern: match,
                                count: matches.length
                            });
                        });
                    }
                });

                // Determine overall risk level
                if (results.vulnerabilities.some(v => v.risk === 'CRITICAL')) {
                    results.riskLevel = 'CRITICAL';
                } else if (results.vulnerabilities.some(v => v.risk === 'HIGH')) {
                    results.riskLevel = 'HIGH';
                } else if (results.vulnerabilities.some(v => v.risk === 'MEDIUM')) {
                    results.riskLevel = 'MEDIUM';
                } else {
                    results.riskLevel = 'LOW';
                }

                // Generate recommendations
                results.recommendations = [
                    'Implement Content Security Policy (CSP) headers',
                    'Validate and sanitize all user inputs',
                    'Use HTTPS for all communications',
                    'Implement proper authentication and authorization',
                    'Regularly update dependencies and libraries'
                ];

                this._metrics.security = results;

                console.log(`ðŸ“Š Security Analysis Complete:`);
                console.log(`  Vulnerabilities found: ${results.vulnerabilities.length}`);
                console.log(`  Risk level: ${results.riskLevel}`);

                return results;
            } catch (error) {
                console.error('âŒ Error in security analysis:', error);
                return results;
            }
        },

        /**
         * Calculate overall code quality score
         * @returns {Object} Quality score and breakdown
         */
        calculateQualityScore() {
            const complexity = this._metrics.complexity;
            const duplication = this._metrics.duplication;
            const naming = this._metrics.naming;
            const documentation = this._metrics.documentation;
            const security = this._metrics.security;

            // Calculate component scores (0-100)
            const complexityScore = complexity.violations ? 
                Math.max(0, 100 - (complexity.violations.length * 10)) : 100;
            
            const duplicationScore = duplication.duplicationPercentage ? 
                Math.max(0, 100 - (parseFloat(duplication.duplicationPercentage) * 2)) : 100;
            
            const namingScore = parseFloat(naming.compliancePercentage) || 100;
            
            const documentationScore = parseFloat(documentation.coverage) || 0;
            
            const securityScore = security.riskLevel === 'CRITICAL' ? 0 :
                                security.riskLevel === 'HIGH' ? 25 :
                                security.riskLevel === 'MEDIUM' ? 50 : 100;

            // Weighted overall score
            const weights = {
                complexity: 0.25,
                duplication: 0.15,
                naming: 0.20,
                documentation: 0.25,
                security: 0.15
            };

            const overallScore = (
                complexityScore * weights.complexity +
                duplicationScore * weights.duplication +
                namingScore * weights.naming +
                documentationScore * weights.documentation +
                securityScore * weights.security
            ).toFixed(1);

            const breakdown = {
                overall: parseFloat(overallScore),
                components: {
                    complexity: complexityScore,
                    duplication: duplicationScore,
                    naming: namingScore,
                    documentation: documentationScore,
                    security: securityScore
                },
                grade: this.getGrade(overallScore),
                recommendations: this.getRecommendations()
            };

            this._metrics.overallScore = breakdown;

            return breakdown;
        },

        /**
         * Get letter grade based on score
         * @param {number} score - Quality score
         * @returns {string} Letter grade
         */
        getGrade(score) {
            if (score >= 90) return 'A';
            if (score >= 80) return 'B';
            if (score >= 70) return 'C';
            if (score >= 60) return 'D';
            return 'F';
        },

        /**
         * Get improvement recommendations
         * @returns {Array} List of recommendations
         */
        getRecommendations() {
            const recommendations = [];
            
            if (this._metrics.complexity.violations?.length > 0) {
                recommendations.push('Reduce function complexity by breaking down large functions');
            }
            
            if (parseFloat(this._metrics.duplication.duplicationPercentage) > 5) {
                recommendations.push('Eliminate code duplication by extracting common functionality');
            }
            
            if (parseFloat(this._metrics.naming.compliancePercentage) < 90) {
                recommendations.push('Improve naming conventions to follow camelCase/UPPER_SNAKE_CASE standards');
            }
            
            if (parseFloat(this._metrics.documentation.coverage) < 80) {
                recommendations.push('Add JSDoc documentation to improve code maintainability');
            }
            
            if (this._metrics.security.vulnerabilities?.length > 0) {
                recommendations.push('Address security vulnerabilities to improve application safety');
            }

            return recommendations;
        },

        /**
         * Run comprehensive codebase analysis
         * @returns {Promise<Object>} Complete analysis results
         */
        async analyzeCodebase() {
            console.log('ðŸš€ Starting comprehensive code quality analysis...');
            const startTime = performance.now();

            try {
                // Run all analyses
                const complexity = this.analyzeFunctionComplexity();
                await new Promise(resolve => setTimeout(resolve, 100)); // Brief pause for UI

                const duplication = this.detectCodeDuplication();
                await new Promise(resolve => setTimeout(resolve, 100));

                const naming = this.validateNamingConventions();
                await new Promise(resolve => setTimeout(resolve, 100));

                const documentation = this.checkDocumentationCoverage();
                await new Promise(resolve => setTimeout(resolve, 100));

                const security = this.scanSecurityVulnerabilities();
                await new Promise(resolve => setTimeout(resolve, 100));

                const qualityScore = this.calculateQualityScore();

                const duration = performance.now() - startTime;

                const report = {
                    timestamp: new Date().toISOString(),
                    duration: duration.toFixed(2),
                    complexity,
                    duplication,
                    naming,
                    documentation,
                    security,
                    qualityScore
                };

                // Generate summary report
                console.log('\nðŸ“‹ CODE QUALITY ANALYSIS REPORT');
                console.log('â•'.repeat(50));
                console.log(`ðŸ† Overall Score: ${qualityScore.overall}/100 (Grade: ${qualityScore.grade})`);
                console.log(`â±ï¸ Analysis Duration: ${duration.toFixed(2)}ms`);
                console.log('\nðŸ“Š Component Scores:');
                console.log(`  ðŸ”§ Complexity: ${qualityScore.components.complexity}/100`);
                console.log(`  ðŸ“‹ Duplication: ${qualityScore.components.duplication}/100`);
                console.log(`  ðŸ·ï¸ Naming: ${qualityScore.components.naming}/100`);
                console.log(`  ðŸ“š Documentation: ${qualityScore.components.documentation}/100`);
                console.log(`  ðŸ”’ Security: ${qualityScore.components.security}/100`);

                if (qualityScore.recommendations.length > 0) {
                    console.log('\nðŸ’¡ Recommendations:');
                    qualityScore.recommendations.forEach((rec, i) => {
                        console.log(`  ${i + 1}. ${rec}`);
                    });
                }

                return report;
            } catch (error) {
                console.error('âŒ Error in codebase analysis:', error);
                throw error;
            }
        }
    },

    /**
     * @namespace CRM.Navigation
     * @description Page navigation and UI routing
     */
    Navigation: {
        showPage,
        updateDashboard
    },

    /**
     * @namespace CRM.PCNumbers
     * @description PC Number management functionality
     */
    PCNumbers: {
        render: renderPCList,
        save: savePC,
        edit: editPC,
        view: viewPC,
        clear: clearPCForm
    },

    /**
     * @namespace CRM.Quotes
     * @description Quote creation and management
     */
    Quotes: {
        render: renderQuotesList,
        create: createQuote,
        save: saveQuote,
        cancel: cancelQuote,
        calculate: calculateTotal,
        showModal: showNewQuoteModal,
        closeModal: closeQuoteModal,
        proceedToBuilder: proceedToQuoteBuilder,
        handlePriceListChange,
        handleStatusChange: handleQuoteStatusChange,
        validateEditability: validateQuoteEditability,
        toggleAddressSections,
        copyCollectionToDelivery,
        updateAddressValidation,
        populateActivities: populateQuotedActivities,
        updateActivities: updateQuotedActivities,
        addLineItem,
        updateLinePrice,
        updateLineQty,
        removeLine
    },

    /**
     * @namespace CRM.Activities
     * @description Activity management and calendar functionality
     */
    Activities: {
        render: updateActivitiesList,
        showModal: showActivityModal,
        closeModal: closeActivityModal,
        save: saveActivity,
        switchView: switchActivitiesView,
        Calendar: {
            setView: setCalendarView,
            navigate: navigateCalendar,
            render: renderCalendar,
            renderMonth: renderMonthView,
            renderWeek: renderWeekView,
            updateTitle: updateCalendarTitle,
            showSidebar: showActivityInSidebar,
            closeSidebar: closeCalendarSidebar,
            editFromCalendar: editActivityFromCalendar
        }
    },

    /**
     * @namespace CRM.Resources
     * @description Resource and price list management
     */
    Resources: {
        render: updateResourcesList,
        showModal: showResourceModal,
        closeModal: closeResourceModal,
        save: saveResource,
        edit: editResource,
        delete: deleteResource,
        PriceLists: {
            render: updatePriceListsTable,
            create: createPriceList,
            view: viewPriceList,
            showAddModal: showAddResourceToPriceList,
            closeAddModal: closeAddResourceModal,
            calculateMargin,
            addResource: addResourceToPriceList,
            removeResource: removeResourceFromPriceList
        }
    },

    /**
     * @namespace CRM.Templates
     * @description Quote template management
     */
    Templates: {
        render: updateTemplatesList,
        filter: filterTemplates,
        showCreateModal: showCreateTemplateFromScratch,
        closeModal: closeTemplateModal,
        save: saveTemplate,
        edit: editTemplate,
        delete: deleteTemplate,
        createFromTemplate: createQuoteFromTemplate,
        saveFromQuote: saveQuoteAsTemplate,
        duplicate: duplicateCurrentQuote,
        addItems: addItemsToTemplate
    },

    /**
     * @namespace CRM.ActivityTemplates  
     * @description Activity template management
     */
    ActivityTemplates: {
        render: updateActivityTemplatesList,
        filter: filterActivityTemplates,
        showCreateModal: showCreateActivityTemplate,
        closeModal: closeActivityTemplateModal,
        save: saveActivityTemplate,
        edit: editActivityTemplate,
        delete: deleteActivityTemplate,
        createFromTemplate: createActivityFromTemplate,
        saveFromActivity: saveActivityAsTemplate
    },

    /**
     * @namespace CRM.EnhancedResources
     * @description Enhanced resource lookup and bulk operations  
     */
    EnhancedResources: {
        showModal: showEnhancedResourceModal,
        closeModal: closeEnhancedResourceModal,
        filter: filterResources,
        render: renderResourcesList,
        toggleSelection: toggleResourceSelection,
        updateTotal: updateResourceTotal,
        selectAllFiltered: selectAllFilteredResources,
        clearSelection: clearResourceSelection,
        updateCount: updateSelectionCount,
        addToQuote: addSelectedResourcesToQuote,
        Bulk: {
            updateSelection: updateBulkSelection,
            toggleCategorySelection,
            clearSelection: clearBulkSelection,
            updateQuantity: bulkUpdateQuantity,
            applyDiscount: bulkApplyDiscount,
            deleteItems: bulkDeleteItems,
            closeQuantityModal: closeBulkQuantityModal,
            applyQuantityUpdate: applyBulkQuantityUpdate,
            closeDiscountModal: closeBulkDiscountModal
        }
    },

    /**
     * @namespace CRM.UI
     * @description UI utilities and common interface functions
     */
    UI: {
        getNotificationIcon,
        clearPCForm,
        clearPriceListForm
    }
};

// ========================================
// Inicjalizacja Aplikacji
// ========================================
document.addEventListener('DOMContentLoaded', () => {
    // ========================================
    // EXPOSE CRM MODULES TO WINDOW OBJECT
    // ========================================
    
    // Expose main CRM namespace
    window.CRM = CRM;
    
    // Navigation & Core
    window.showPage = showPage;
    window.resetData = CRM.Database.reset;
    
    // Data Access Layer - expose for easy access
    window.DataAccess = CRM.DataAccess;
    
    // Event System - expose for cross-module communication
    window.EventBus = CRM.EventBus;
    
    // Error Handler - expose for centralized error management
    window.ErrorHandler = CRM.ErrorHandler;
    
    // Testing Framework - expose for quality assurance and development
    window.Testing = CRM.Testing;
    
    // Code Quality - expose for static analysis and quality validation
    window.CodeQuality = CRM.CodeQuality;
    
    // PC Numbers Module
    window.savePC = CRM.PCNumbers.save;
    window.editPC = CRM.PCNumbers.edit;
    window.viewPC = CRM.PCNumbers.view;
    
    // Quotes Module  
    window.createQuote = CRM.Quotes.create;
    window.showNewQuoteModal = CRM.Quotes.showModal;
    window.closeQuoteModal = CRM.Quotes.closeModal;
    window.proceedToQuoteBuilder = CRM.Quotes.proceedToBuilder;
    window.handlePriceListChange = CRM.Quotes.handlePriceListChange;
    window.addLineItem = CRM.Quotes.addLineItem;
    window.updateLinePrice = CRM.Quotes.updateLinePrice;
    window.updateLineQty = CRM.Quotes.updateLineQty;
    window.removeLine = CRM.Quotes.removeLine;
    window.saveQuote = CRM.Quotes.save;
    window.calculateTotal = CRM.Quotes.calculate;
    window.cancelQuote = CRM.Quotes.cancel;
    window.toggleAddressSections = CRM.Quotes.toggleAddressSections;
    window.copyCollectionToDelivery = CRM.Quotes.copyCollectionToDelivery;
    window.handleQuoteStatusChange = CRM.Quotes.handleStatusChange;
    window.populateQuotedActivities = CRM.Quotes.populateActivities;
    window.updateQuotedActivities = CRM.Quotes.updateActivities;
    
    // Activities Module
    window.showActivityModal = CRM.Activities.showModal;
    window.closeActivityModal = CRM.Activities.closeModal;
    window.saveActivity = CRM.Activities.save;
    window.switchActivitiesView = CRM.Activities.switchView;
    window.setCalendarView = CRM.Activities.Calendar.setView;
    window.navigateCalendar = CRM.Activities.Calendar.navigate;
    window.closeCalendarSidebar = CRM.Activities.Calendar.closeSidebar;
    
    // Templates Module
    window.filterTemplates = CRM.Templates.filter;
    window.showCreateTemplateFromScratch = CRM.Templates.showCreateModal;
    window.saveQuoteAsTemplate = CRM.Templates.saveFromQuote;
    window.duplicateCurrentQuote = CRM.Templates.duplicate;
    window.createQuoteFromTemplate = CRM.Templates.createFromTemplate;
    window.editTemplate = CRM.Templates.edit;
    window.deleteTemplate = CRM.Templates.delete;
    
    // Enhanced Resources & Bulk Operations
    window.showEnhancedResourceModal = CRM.EnhancedResources.showModal;
    window.closeEnhancedResourceModal = CRM.EnhancedResources.closeModal;
    window.filterResources = CRM.EnhancedResources.filter;
    window.selectAllFilteredResources = CRM.EnhancedResources.selectAllFiltered;
    window.clearResourceSelection = CRM.EnhancedResources.clearSelection;
    window.addSelectedResourcesToQuote = CRM.EnhancedResources.addToQuote;
    window.bulkUpdateQuantity = CRM.EnhancedResources.Bulk.updateQuantity;
    window.bulkApplyDiscount = CRM.EnhancedResources.Bulk.applyDiscount;
    window.bulkDeleteItems = CRM.EnhancedResources.Bulk.deleteItems;
    window.toggleCategorySelection = CRM.EnhancedResources.Bulk.toggleCategorySelection;
    window.clearBulkSelection = CRM.EnhancedResources.Bulk.clearSelection;
    window.updateBulkSelection = CRM.EnhancedResources.Bulk.updateSelection;
    
    // Resources Module  
    window.showResourceModal = CRM.Resources.showModal;
    window.closeResourceModal = CRM.Resources.closeModal;
    window.saveResource = CRM.Resources.save;
    window.editResource = CRM.Resources.edit;
    window.deleteResource = CRM.Resources.delete;
    
    // Price Lists Module
    window.updatePriceListsTable = CRM.Resources.PriceLists.render;
    window.createPriceList = CRM.Resources.PriceLists.create;
    window.viewPriceList = CRM.Resources.PriceLists.view;
    window.showAddResourceToPriceList = CRM.Resources.PriceLists.showAddModal;
    window.closeAddResourceModal = CRM.Resources.PriceLists.closeAddModal;
    window.calculateMargin = CRM.Resources.PriceLists.calculateMargin;
    window.addResourceToPriceList = CRM.Resources.PriceLists.addResource;
    window.removeResourceFromPriceList = CRM.Resources.PriceLists.removeResource;
    
    // Activity Templates Module
    window.filterActivityTemplates = CRM.ActivityTemplates.filter;
    window.showCreateActivityTemplate = CRM.ActivityTemplates.showCreateModal;
    window.saveActivityAsTemplate = CRM.ActivityTemplates.saveFromActivity;
    
    // ========================================
    // LEGACY FUNCTIONS NOT YET IN CRM MODULES  
    // ========================================
    
    // Advanced Functions (Sprint 4.2+) - need to be added to CRM modules later
    window.closeQuickCreate = closeQuickCreate;
    window.submitQuickCreate = submitQuickCreate;
    window.initializeTeamManagement = initializeTeamManagement;
    window.filterByTeamMember = filterByTeamMember;
    window.toggleWorkloadPanel = toggleWorkloadPanel;
    window.showTeamManagement = showTeamManagement;
    window.closeTeamManagement = closeTeamManagement;
    window.addTeamMember = addTeamMember;
    window.removeTeamMember = removeTeamMember;
    window.toggleRecurringOptions = toggleRecurringOptions;
    window.updateRecurringPreview = updateRecurringPreview;
    window.showRecurringEditModal = showRecurringEditModal;
    window.closeRecurringEditModal = closeRecurringEditModal;
    window.editRecurringActivity = editRecurringActivity;
    window.deleteRecurringSeries = deleteRecurringSeries;
    window.editActivityFromCalendarRecurring = editActivityFromCalendarRecurring;
    window.toggleNotificationCenter = toggleNotificationCenter;
    window.markAllNotificationsRead = markAllNotificationsRead;
    window.handleNotificationClick = handleNotificationClick;
    window.filterResourcesByType = filterResourcesByType;
    window.filterResourcesByStatus = filterResourcesByStatus;
    window.refreshResourceAllocation = refreshResourceAllocation;
    window.showResourceCalendarView = showResourceCalendarView;
    window.hideResourceCalendarView = hideResourceCalendarView;
    window.navigateResourceWeek = navigateResourceWeek;
    window.viewResourceSchedule = viewResourceSchedule;
    window.viewResourceDayDetails = viewResourceDayDetails;
    window.showActivityResourceSelector = showActivityResourceSelector;
    window.closeActivityResourceSelector = closeActivityResourceSelector;
    window.filterActivityResourceSelector = filterActivityResourceSelector;
    window.toggleActivityResourceSelection = toggleActivityResourceSelection;
    window.confirmActivityResourceSelection = confirmActivityResourceSelection;
    window.removeActivityResource = removeActivityResource;
    window.checkResourceAvailability = checkResourceAvailability;
    window.setWorkflowMode = setWorkflowMode;
    window.autoLayoutWorkflow = autoLayoutWorkflow;
    window.calculateCriticalPath = calculateCriticalPath;
    window.optimizeWorkflow = optimizeWorkflow;
    window.showDependencySelector = showDependencySelector;
    window.closeDependencySelector = closeDependencySelector;
    window.filterDependencySelector = filterDependencySelector;
    window.selectDependencyActivity = selectDependencyActivity;
    window.confirmDependencySelection = confirmDependencySelection;
    window.removeDependency = removeDependency;
    window.editDependency = editDependency;
    window.calculateActivitySchedule = calculateActivitySchedule;
    window.updateAnalytics = updateAnalytics;
    window.setChartPeriod = setChartPeriod;
    window.exportAnalyticsReport = exportAnalyticsReport;
    window.clearPCForm = clearPCForm;
    window.clearPriceListForm = clearPriceListForm;
    window.editPriceList = editPriceList;
    
    // Direct function exposures (to be cleaned up)
    window.enableDragAndDrop = enableDragAndDrop;
    window.renderResourcesList = renderResourcesList;
    window.toggleResourceSelection = toggleResourceSelection;
    window.updateResourceTotal = updateResourceTotal;
    window.updateSelectionCount = updateSelectionCount;
    window.addResourceToQuoteCategory = addResourceToQuoteCategory;

    // ========================================
    // EVENT SYSTEM SETUP - AUTOMATIC LISTENERS
    // ========================================
    console.log('ðŸŽ¯ Setting up Event System listeners...');
    
    // PC Number Events - when PC is created/updated/deleted
    CRM.EventBus.on('pc:created', (pcData) => {
        console.log('ðŸ“¡ Event: PC created, updating dashboard and lists...', pcData.pc_number);
        updateDashboard();
        renderPCList();
    }, { priority: 10 });
    
    CRM.EventBus.on('pc:updated', (pcData) => {
        console.log('ðŸ“¡ Event: PC updated, refreshing UI...', pcData.pc_number);
        updateDashboard();
        renderPCList();
        // Update any open quote dropdowns that might reference this PC
        const pcSelect = document.getElementById('quote-pc-id');
        if (pcSelect) {
            const selectedId = pcSelect.value;
            showNewQuoteModal(); // This refreshes the PC dropdown
            pcSelect.value = selectedId; // Restore selection
        }
    }, { priority: 10 });
    
    CRM.EventBus.on('pc:deleted', (data) => {
        console.log('ðŸ“¡ Event: PC deleted, updating lists...', data.id);
        updateDashboard();
        renderPCList();
    }, { priority: 10 });
    
    // Quote Events - when quote is created/updated/deleted  
    CRM.EventBus.on('quote:created', (quoteData) => {
        console.log('ðŸ“¡ Event: Quote created, updating dashboard...', quoteData.quote_number);
        updateDashboard();
        renderQuotesList();
    });
    
    CRM.EventBus.on('quote:updated', (quoteData) => {
        console.log('ðŸ“¡ Event: Quote updated, refreshing UI...', quoteData.quote_number);
        updateDashboard();
        renderQuotesList();
    });
    
    CRM.EventBus.on('quote:deleted', (data) => {
        console.log('ðŸ“¡ Event: Quote deleted, updating lists...', data.id);
        updateDashboard();
        renderQuotesList();
    });
    
    // Activity Events - when activity is created/updated/deleted
    CRM.EventBus.on('activity:created', (activityData) => {
        console.log('ðŸ“¡ Event: Activity created, updating dashboard and calendar...', activityData.title);
        updateDashboard();
        updateActivitiesList();
        // Refresh calendar if visible
        if (currentActivitiesView === 'calendar') {
            renderCalendar();
        }
        // Update notifications for new activities
        updateNotificationSystem();
    });
    
    CRM.EventBus.on('activity:updated', (activityData) => {
        console.log('ðŸ“¡ Event: Activity updated, refreshing views...', activityData.title);
        updateDashboard();
        updateActivitiesList();
        if (currentActivitiesView === 'calendar') {
            renderCalendar();
        }
        updateNotificationSystem();
    });
    
    CRM.EventBus.on('activity:deleted', (data) => {
        console.log('ðŸ“¡ Event: Activity deleted, updating views...', data.id);
        updateDashboard();
        updateActivitiesList();
        if (currentActivitiesView === 'calendar') {
            renderCalendar();
        }
        updateNotificationSystem();
    });
    
    // Resource Events - when resource is created/updated/deleted
    CRM.EventBus.on('resource:created', (resourceData) => {
        console.log('ðŸ“¡ Event: Resource created, updating lists...', resourceData.name);
        renderResourcesList();
        // Refresh resource allocation if visible
        if (document.getElementById('resource-allocation').style.display !== 'none') {
            refreshResourceAllocation();
        }
    });
    
    CRM.EventBus.on('resource:updated', (resourceData) => {
        console.log('ðŸ“¡ Event: Resource updated, refreshing views...', resourceData.name);
        renderResourcesList();
        if (document.getElementById('resource-allocation').style.display !== 'none') {
            refreshResourceAllocation();
        }
    });
    
    CRM.EventBus.on('resource:deleted', (data) => {
        console.log('ðŸ“¡ Event: Resource deleted, updating lists...', data.id);
        renderResourcesList();
        if (document.getElementById('resource-allocation').style.display !== 'none') {
            refreshResourceAllocation();
        }
    });
    
    // Global Events - system-wide events
    CRM.EventBus.on('data:loaded', () => {
        console.log('ðŸ“¡ Event: Data loaded, updating all UI components...');
        updateDashboard();
        renderPCList();
        renderQuotesList();
        updateActivitiesList();
        renderResourcesList();
        updateNotificationSystem();
    }, { priority: 5 });
    
    // Error Events - centralized error monitoring and reporting
    CRM.EventBus.on('error:occurred', (errorData) => {
        console.log('ðŸ“¡ Event: Error occurred, logging to error tracking...', {
            context: errorData.context,
            category: errorData.category.type,
            message: errorData.message
        });
        
        // Future: Send to error tracking service
        // analytics.trackError(errorData);
        
        // Update error dashboard (if exists)
        // updateErrorDashboard(errorData);
    });
    
    // Debug event for monitoring
    CRM.EventBus.on('*', (data, eventName) => {
        if (CONFIG.DEBUG?.EVENTS) {
            console.log(`ðŸ” Event Debug: ${eventName}`, data);
        }
    }, { priority: -10 }); // Low priority, runs last
    
    console.log('âœ… Event System listeners configured:', CRM.EventBus.getStats());

    // ========================================
    // TESTING SYSTEM SETUP
    // ========================================
    console.log('ðŸ§ª Setting up Testing Framework...');
    
    // Initialize test suites
    CRM.Testing.initializeTestSuites();
    
    // Development helper function for running tests in console
    window.runTests = async () => {
        console.log('\nðŸš€ RUNNING COMPREHENSIVE TEST SUITE...');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        const results = await CRM.Testing.runAllTests();
        
        // Show memory metrics
        const memory = CRM.Testing.getMemoryMetrics();
        console.log('\nðŸ’¾ MEMORY METRICS:');
        if (memory.message) {
            console.log(`  ${memory.message}`);
        } else {
            console.log(`  Used: ${memory.usedJSHeapSize}MB`);
            console.log(`  Total: ${memory.totalJSHeapSize}MB`);
            console.log(`  Limit: ${memory.jsHeapSizeLimit}MB`);
        }
        
        // Performance summary
        console.log('\nâš¡ QUICK PERFORMANCE COMMANDS:');
        console.log('  CRM.Testing.benchmark("save-pc", () => CRM.DataAccess.save("pc", testData))');
        console.log('  CRM.Testing.runTestSuite("DataAccess")');
        console.log('  CRM.Testing.runTestSuite("EventBus")');
        console.log('  CRM.Testing.getMemoryMetrics()');
        
        return results;
    };
    
    // Developer shortcuts
    window.testDAL = () => CRM.Testing.runTestSuite('DataAccess');
    window.testEvents = () => CRM.Testing.runTestSuite('EventBus');
    window.testErrors = () => CRM.Testing.runTestSuite('ErrorHandler');
    window.testPerf = () => CRM.Testing.runTestSuite('Performance');
    window.testIntegration = () => CRM.Testing.runTestSuite('Integration');
    
    console.log('âœ… Testing Framework initialized');
    console.log('ðŸ’¡ Run tests with: runTests() or individual suites with testDAL(), testEvents(), etc.');

    // ========================================
    // CODE QUALITY SYSTEM SETUP
    // ========================================
    console.log('ðŸ” Setting up Code Quality Analysis...');
    
    // Development helper function for code quality analysis
    window.analyzeCode = async () => {
        console.log('\nðŸ” RUNNING COMPREHENSIVE CODE QUALITY ANALYSIS...');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        const report = await CRM.CodeQuality.analyzeCodebase();
        
        // Additional quality insights
        console.log('\nðŸ“ˆ QUALITY INSIGHTS:');
        if (report.qualityScore.grade === 'A') {
            console.log('ðŸ† Excellent code quality! Keep up the great work!');
        } else if (report.qualityScore.grade === 'B') {
            console.log('ðŸ‘ Good code quality with room for improvement');
        } else if (report.qualityScore.grade === 'C') {
            console.log('âš ï¸ Average code quality - consider refactoring priorities');
        } else {
            console.log('ðŸš¨ Code quality needs immediate attention');
        }
        
        // Quality commands
        console.log('\nâš¡ QUALITY ANALYSIS COMMANDS:');
        console.log('  CRM.CodeQuality.analyzeFunctionComplexity() - Check function complexity');
        console.log('  CRM.CodeQuality.detectCodeDuplication() - Find duplicate code');
        console.log('  CRM.CodeQuality.validateNamingConventions() - Check naming standards');
        console.log('  CRM.CodeQuality.checkDocumentationCoverage() - Verify JSDoc coverage');
        console.log('  CRM.CodeQuality.scanSecurityVulnerabilities() - Security audit');
        console.log('  CRM.CodeQuality.calculateQualityScore() - Overall quality metrics');
        
        return report;
    };
    
    // Quality analysis shortcuts
    window.checkComplexity = () => CRM.CodeQuality.analyzeFunctionComplexity();
    window.findDuplicates = () => CRM.CodeQuality.detectCodeDuplication();
    window.checkNaming = () => CRM.CodeQuality.validateNamingConventions();
    window.checkDocs = () => CRM.CodeQuality.checkDocumentationCoverage();
    window.scanSecurity = () => CRM.CodeQuality.scanSecurityVulnerabilities();
    window.qualityScore = () => CRM.CodeQuality.calculateQualityScore();
    
    console.log('âœ… Code Quality System initialized');
    console.log('ðŸ” Analyze code quality with: analyzeCode() or individual checks with checkComplexity(), findDuplicates(), etc.');

    // ========================================
    // LOADING STATES & PROGRESS INDICATORS
    // ========================================
    
    // Enhanced Loading State Manager
    class LoadingStateManager {
        constructor() {
            this.activeLoaders = new Map();
            this.overlay = document.getElementById('loading-overlay');
            this.titleEl = document.getElementById('loading-title');
            this.messageEl = document.getElementById('loading-message');
            this.progressBar = document.getElementById('progress-bar');
            this.progressText = document.getElementById('progress-text');
        }
        
        show(id, title, message = '') {
            this.titleEl.textContent = title;
            this.messageEl.textContent = message;
            
            this.overlay.classList.add('active');
            this.overlay.setAttribute('aria-hidden', 'false');
            
            // Focus management for accessibility
            this.overlay.focus();
            
            this.activeLoaders.set(id, { title, message, progress: 0 });
            
            console.log(`ðŸ”„ Loading: ${title} - ${message}`);
        }
        
        updateProgress(id, progress, message = '') {
            if (!this.activeLoaders.has(id)) return;
            
            const clampedProgress = Math.max(0, Math.min(100, progress));
            
            this.progressBar.style.width = `${clampedProgress}%`;
            this.progressText.textContent = `${Math.round(clampedProgress)}%`;
            
            if (message) {
                this.messageEl.textContent = message;
            }
            
            const loader = this.activeLoaders.get(id);
            loader.progress = clampedProgress;
            loader.message = message || loader.message;
            
            // Announce progress to screen readers at intervals
            if (clampedProgress % 25 === 0) {
                this.announceProgress(clampedProgress, message);
            }
        }
        
        hide(id) {
            if (!this.activeLoaders.has(id)) return;
            
            this.activeLoaders.delete(id);
            
            if (this.activeLoaders.size === 0) {
                this.overlay.classList.remove('active');
                this.overlay.setAttribute('aria-hidden', 'true');
                
                // Return focus to main content
                const mainContent = document.getElementById('main-content');
                if (mainContent) {
                    mainContent.focus();
                }
                
                console.log('âœ… Loading complete');
            }
        }
        
        announceProgress(progress, message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            announcement.textContent = `Loading ${progress}% complete. ${message}`;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                if (announcement.parentNode) {
                    announcement.parentNode.removeChild(announcement);
                }
            }, 1000);
        }
        
        // Button loading states
        setButtonLoading(button, loading = true) {
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
                
                // Wrap existing text
                const text = button.textContent;
                button.innerHTML = `<span class="btn-text">${text}</span>`;
                
                button.setAttribute('aria-label', `${text} - Loading`);
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                
                const textSpan = button.querySelector('.btn-text');
                if (textSpan) {
                    button.textContent = textSpan.textContent;
                    button.removeAttribute('aria-label');
                }
            }
        }
    }
    
    // Enhanced Toast Notification System
    class ToastManager {
        constructor() {
            this.toasts = [];
            this.container = document.getElementById('toast-container');
            this.maxToasts = 5;
        }
        
        show(options) {
            const {
                type = 'info',
                title,
                message,
                duration = 5000,
                actions = [],
                persistent = false,
                undoAction = null
            } = options;
            
            // Remove oldest toast if at limit
            if (this.toasts.length >= this.maxToasts) {
                this.removeToast(this.toasts[0]);
            }
            
            const toast = this.createToast({
                type,
                title,
                message,
                actions,
                undoAction,
                persistent
            });
            
            this.container.appendChild(toast);
            this.toasts.push(toast);
            
            // Auto-remove after duration (unless persistent)
            if (!persistent && duration > 0) {
                setTimeout(() => {
                    this.removeToast(toast);
                }, duration);
            }
            
            return toast;
        }
        
        createToast({ type, title, message, actions, undoAction, persistent }) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
            
            const icon = this.getIcon(type);
            
            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-icon" aria-hidden="true">${icon}</div>
                    <div class="toast-content">
                        ${title ? `<div class="toast-title">${title}</div>` : ''}
                        <div class="toast-message">${message}</div>
                    </div>
                    ${!persistent ? `
                        <button class="toast-close" aria-label="Close notification" onclick="this.closest('.toast').remove()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    ` : ''}
                </div>
                ${actions.length > 0 || undoAction ? `
                    <div class="toast-actions">
                        ${undoAction ? `
                            <button class="toast-action" onclick="${undoAction}; this.closest('.toast').remove();">
                                Undo
                            </button>
                        ` : ''}
                        ${actions.map(action => `
                            <button class="toast-action ${action.style || ''}" onclick="${action.onclick || ''}">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            
            return toast;
        }
        
        getIcon(type) {
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            return icons[type] || icons.info;
        }
        
        removeToast(toast) {
            if (!toast || !toast.parentNode) return;
            
            toast.style.animation = 'toast-slide-out 0.3s ease-in forwards';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
                this.toasts = this.toasts.filter(t => t !== toast);
            }, 300);
        }
        
        // Contextual error handling
        showError(operation, error, options = {}) {
            const errorConfigs = {
                'pc-save': {
                    title: 'Failed to Save PC Number',
                    getMessage: (error) => `Your PC Number could not be saved: ${error.message || 'Unknown error'}`,
                    actions: [
                        { label: 'Try Again', style: 'primary', onclick: 'retryLastOperation()' },
                        { label: 'Save Draft', style: '', onclick: 'saveDraft()' }
                    ]
                },
                'quote-calculate': {
                    title: 'Calculation Error',
                    getMessage: (error) => 'Unable to calculate quote totals. Please check your line items.',
                    actions: [
                        { label: 'Recalculate', style: 'primary', onclick: 'calculateTotal()' }
                    ]
                },
                'data-load': {
                    title: 'Loading Failed',
                    getMessage: (error) => 'Failed to load data from the database.',
                    actions: [
                        { label: 'Retry', style: 'primary', onclick: 'location.reload()' },
                        { label: 'Load Demo Data', style: '', onclick: 'initializeWithDemoData()' }
                    ]
                }
            };
            
            const config = errorConfigs[operation] || {
                title: 'Error',
                getMessage: (error) => error.message || 'An unexpected error occurred',
                actions: []
            };
            
            this.show({
                type: 'error',
                title: config.title,
                message: config.getMessage(error),
                actions: config.actions,
                persistent: true,
                ...options
            });
        }
        
        // Success with undo functionality
        showSuccessWithUndo(message, undoAction, options = {}) {
            return this.show({
                type: 'success',
                message,
                undoAction,
                duration: 8000, // Longer duration for undo
                ...options
            });
        }
        
        // Show loading inline indicator
        showInlineLoading(element, text = 'Loading') {
            const loadingHtml = `
                <div class="loading-inline">
                    <span>${text}</span>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            element.innerHTML = loadingHtml;
        }
        
        hideInlineLoading(element, originalContent) {
            element.innerHTML = originalContent;
        }
    }
    
    // Skeleton Loading Utilities
    class SkeletonLoader {
        static createTableSkeleton(rows = 5, columns = 4) {
            const skeleton = document.createElement('table');
            skeleton.className = 'skeleton-table';
            skeleton.setAttribute('aria-hidden', 'true');
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            for (let i = 0; i < columns; i++) {
                const th = document.createElement('th');
                th.innerHTML = '<div class="skeleton skeleton-text medium"></div>';
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            skeleton.appendChild(thead);
            
            // Create body rows
            const tbody = document.createElement('tbody');
            for (let i = 0; i < rows; i++) {
                const row = document.createElement('tr');
                row.className = 'skeleton-row';
                
                for (let j = 0; j < columns; j++) {
                    const cell = document.createElement('td');
                    cell.className = 'skeleton-cell';
                    const textClass = j === 0 ? 'long' : (j === columns - 1 ? 'short' : 'medium');
                    cell.innerHTML = `<div class="skeleton skeleton-text ${textClass}"></div>`;
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
            skeleton.appendChild(tbody);
            
            return skeleton;
        }
        
        static createCardSkeleton() {
            const card = document.createElement('div');
            card.className = 'skeleton-card';
            card.setAttribute('aria-hidden', 'true');
            
            card.innerHTML = `
                <div class="skeleton-card-header skeleton"></div>
                <div class="skeleton-card-content">
                    <div class="skeleton-card-line skeleton long"></div>
                    <div class="skeleton-card-line skeleton medium"></div>
                    <div class="skeleton-card-line skeleton short"></div>
                </div>
            `;
            
            return card;
        }
        
        static showTableSkeleton(container, rows = 5, columns = 4) {
            const skeleton = this.createTableSkeleton(rows, columns);
            container.innerHTML = '';
            container.appendChild(skeleton);
        }
        
        static showCardsSkeleton(container, count = 3) {
            container.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const card = this.createCardSkeleton();
                container.appendChild(card);
            }
        }
    }
    
    // Global instances
    const loadingManager = new LoadingStateManager();
    const toastManager = new ToastManager();
    
    // Expose to window for easy access
    window.loadingManager = loadingManager;
    window.toastManager = toastManager;
    window.SkeletonLoader = SkeletonLoader;
    
    console.log('âœ… Loading states and enhanced error handling initialized');
    
    // ========================================
    // HIERARCHICAL DROPDOWN NAVIGATION
    // ========================================
    
    // Dropdown Navigation Manager
    class DropdownNavigationManager {
        constructor() {
            this.activeDropdown = null;
            this.dropdowns = new Map();
            this.initializeDropdowns();
            this.bindEventListeners();
        }
        
        initializeDropdowns() {
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            
            dropdownToggles.forEach(toggle => {
                const dropdownId = toggle.getAttribute('aria-controls');
                const menu = document.getElementById(dropdownId);
                
                if (menu) {
                    this.dropdowns.set(dropdownId, {
                        toggle,
                        menu,
                        isOpen: false
                    });
                }
            });
        }
        
        bindEventListeners() {
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-dropdown')) {
                    this.closeAllDropdowns();
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.activeDropdown) {
                    this.closeDropdown(this.activeDropdown);
                    this.dropdowns.get(this.activeDropdown).toggle.focus();
                }
                
                // Arrow key navigation within dropdowns
                if (this.activeDropdown && ['ArrowDown', 'ArrowUp'].includes(e.key)) {
                    e.preventDefault();
                    this.handleArrowNavigation(e.key);
                }
            });
        }
        
        toggleDropdown(dropdownId) {
            const dropdown = this.dropdowns.get(dropdownId);
            if (!dropdown) return;
            
            if (dropdown.isOpen) {
                this.closeDropdown(dropdownId);
            } else {
                this.closeAllDropdowns();
                this.openDropdown(dropdownId);
            }
        }
        
        openDropdown(dropdownId) {
            const dropdown = this.dropdowns.get(dropdownId);
            if (!dropdown) return;
            
            // Update states
            dropdown.isOpen = true;
            this.activeDropdown = dropdownId;
            
            // Update ARIA attributes
            dropdown.toggle.setAttribute('aria-expanded', 'true');
            dropdown.menu.setAttribute('aria-hidden', 'false');
            dropdown.menu.hidden = false;
            
            // Focus first item
            const firstItem = dropdown.menu.querySelector('.dropdown-item');
            if (firstItem) {
                setTimeout(() => firstItem.focus(), 100);
            }
            
            // Announce to screen readers
            this.announceDropdownState(dropdownId, true);
        }
        
        closeDropdown(dropdownId) {
            const dropdown = this.dropdowns.get(dropdownId);
            if (!dropdown) return;
            
            // Update states
            dropdown.isOpen = false;
            if (this.activeDropdown === dropdownId) {
                this.activeDropdown = null;
            }
            
            // Update ARIA attributes
            dropdown.toggle.setAttribute('aria-expanded', 'false');
            dropdown.menu.setAttribute('aria-hidden', 'true');
            dropdown.menu.hidden = true;
            
            // Announce to screen readers
            this.announceDropdownState(dropdownId, false);
        }
        
        closeAllDropdowns() {
            this.dropdowns.forEach((dropdown, id) => {
                if (dropdown.isOpen) {
                    this.closeDropdown(id);
                }
            });
        }
        
        handleArrowNavigation(direction) {
            if (!this.activeDropdown) return;
            
            const dropdown = this.dropdowns.get(this.activeDropdown);
            const items = Array.from(dropdown.menu.querySelectorAll('.dropdown-item'));
            const currentIndex = items.findIndex(item => item === document.activeElement);
            
            let nextIndex;
            if (direction === 'ArrowDown') {
                nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
            } else {
                nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
            }
            
            items[nextIndex].focus();
        }
        
        announceDropdownState(dropdownId, isOpen) {
            const dropdown = this.dropdowns.get(dropdownId);
            if (!dropdown) return;
            
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            
            const menuLabel = dropdown.menu.getAttribute('aria-label') || 'menu';
            announcement.textContent = isOpen ? 
                `${menuLabel} opened` : 
                `${menuLabel} closed`;
            
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                if (announcement.parentNode) {
                    announcement.parentNode.removeChild(announcement);
                }
            }, 1000);
        }
        
        // Update active page highlighting
        updateActivePageHighlighting(pageId) {
            // Clear all active states
            document.querySelectorAll('.nav-btn, .dropdown-item').forEach(btn => {
                btn.classList.remove('active');
                btn.removeAttribute('aria-current');
            });
            
            // Set active state for current page
            const pageToDropdownItem = {
                'dashboard': null,
                'pcnumbers': '#projects-menu .dropdown-item[onclick*="pcnumbers"]',
                'activities': '#projects-menu .dropdown-item[onclick*="activities"]',
                'quotes': '#sales-menu .dropdown-item[onclick*="quotes"]',
                'pricelists': '#sales-menu .dropdown-item[onclick*="pricelists"]',
                'resources': '#resources-menu .dropdown-item[onclick*="resources"]',
                'resource-allocation': '#resources-menu .dropdown-item[onclick*="resource-allocation"]',
                'templates': '#templates-menu .dropdown-item[onclick*="templates"]',
                'activity-templates': '#templates-menu .dropdown-item[onclick*="activity-templates"]',
                'analytics': '.nav-btn[onclick*="analytics"]'
            };
            
            if (pageId === 'dashboard') {
                const dashboardBtn = document.querySelector('.nav-btn[onclick*="dashboard"]');
                if (dashboardBtn) {
                    dashboardBtn.classList.add('active');
                    dashboardBtn.setAttribute('aria-current', 'page');
                }
            } else {
                const selector = pageToDropdownItem[pageId];
                if (selector) {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.classList.add('active');
                        element.setAttribute('aria-current', 'page');
                    }
                }
            }
        }
    }
    
    // MOVED TO DOMContentLoaded - will be defined there
    
    // Enhanced navigation state management
    function updateHierarchicalNavigationState(activePageId) {
        // Update traditional navigation states
        updateNavigationState(activePageId);
        
        // Update hierarchical dropdown highlighting
        dropdownNavigation.updateActivePageHighlighting(activePageId);
    }
    
    console.log('âœ… Hierarchical dropdown navigation initialized');
    console.log('ðŸ“ Navigation organized into logical groups: Projects, Sales, Resources, Templates');
    
    // ========================================
    // PROGRESSIVE FORM WIZARD SYSTEM
    // ========================================
    
    // Form Wizard Manager
    class FormWizardManager {
        constructor() {
            this.currentStep = 1;
            this.totalSteps = 3;
            this.formData = {};
            this.stepValidation = {
                1: false,
                2: false,
                3: false
            };
            this.draftSaveTimeout = null;
            this.initializeWizard();
        }
        
        initializeWizard() {
            this.setupValidation();
            this.setupAutoSave();
            this.restoreDraft();
        }
        
        setupValidation() {
            const inputs = document.querySelectorAll('.wizard-field-input[data-validate]');
            
            inputs.forEach(input => {
                // Live validation on input with debouncing
                let timeout;
                input.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        this.validateField(input);
                        this.updateStepValidation();
                    }, 500);
                });
                
                // Immediate validation on blur
                input.addEventListener('blur', () => {
                    clearTimeout(timeout);
                    this.validateField(input);
                    this.updateStepValidation();
                });
            });
        }
        
        validateField(input) {
            const value = input.value.trim();
            const validationType = input.getAttribute('data-validate');
            const fieldId = input.id;
            
            this.clearFieldState(input);
            
            let isValid = true;
            let errorMessage = '';
            
            // Required field validation
            if (input.required && !value) {
                isValid = false;
                errorMessage = `${this.getFieldLabel(input)} is required`;
            }
            // Specific validation types
            else if (value && validationType) {
                const validation = this.getValidationResult(validationType, value);
                isValid = validation.isValid;
                errorMessage = validation.message;
            }
            
            // Special case: contact validation (phone OR email required)
            if (fieldId === 'pc-contact-phone' || fieldId === 'pc-contact-email') {
                const phoneValue = document.getElementById('pc-contact-phone').value.trim();
                const emailValue = document.getElementById('pc-contact-email').value.trim();
                
                if (!phoneValue && !emailValue) {
                    // Show validation message only after user interacts with both fields
                    const phoneTouched = document.getElementById('pc-contact-phone').hasAttribute('data-touched');
                    const emailTouched = document.getElementById('pc-contact-email').hasAttribute('data-touched');
                    
                    if (phoneTouched && emailTouched) {
                        isValid = false;
                        errorMessage = 'Please provide either phone or email';
                    }
                }
            }
            
            // Mark field as touched
            input.setAttribute('data-touched', 'true');
            
            // Update UI
            if (isValid && value) {
                this.showFieldSuccess(input);
            } else if (!isValid) {
                this.showFieldError(input, errorMessage);
            }
            
            return isValid;
        }
        
        getValidationResult(type, value) {
            const validators = {
                'pc-number': {
                    test: (val) => /^PC-\d{6}$/.test(val),
                    message: 'PC Number must be in format PC-000001'
                },
                'email': {
                    test: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val),
                    message: 'Please enter a valid email address'
                },
                'phone': {
                    test: (val) => /^[\+]?[0-9\s\-\(\)]{10,}$/.test(val),
                    message: 'Please enter a valid phone number'
                },
                'postcode': {
                    test: (val) => /^[A-Z]{1,2}\d[A-Z\d]?\s?\d[A-Z]{2}$/i.test(val),
                    message: 'Please enter a valid UK postcode'
                },
                'number': {
                    test: (val) => !isNaN(val) && val >= 1 && val <= 20,
                    message: 'Please enter a number between 1 and 20'
                },
                'required': {
                    test: (val) => val.length > 0,
                    message: 'This field is required'
                }
            };
            
            const validator = validators[type];
            if (validator) {
                return {
                    isValid: validator.test(value),
                    message: validator.message
                };
            }
            
            return { isValid: true, message: '' };
        }
        
        clearFieldState(input) {
            input.classList.remove('error', 'success');
            const errorEl = document.getElementById(`${input.id}-error`);
            const successEl = document.getElementById(`${input.id}-success`);
            
            if (errorEl) {
                errorEl.hidden = true;
                errorEl.textContent = '';
            }
            if (successEl) {
                successEl.hidden = true;
            }
        }
        
        showFieldError(input, message) {
            input.classList.add('error');
            const errorEl = document.getElementById(`${input.id}-error`);
            if (errorEl) {
                errorEl.textContent = `âš  ${message}`;
                errorEl.hidden = false;
            }
        }
        
        showFieldSuccess(input) {
            input.classList.add('success');
            const successEl = document.getElementById(`${input.id}-success`);
            if (successEl) {
                successEl.hidden = false;
            }
        }
        
        getFieldLabel(input) {
            const label = document.querySelector(`label[for="${input.id}"]`);
            return label ? label.textContent.replace('*', '').trim() : 'This field';
        }
        
        updateStepValidation() {
            const stepValidation = {
                1: this.validateStep1(),
                2: this.validateStep2(), 
                3: this.validateStep3()
            };
            
            this.stepValidation = stepValidation;
            
            // Update next/save button states
            const step1Next = document.getElementById('step-1-next');
            const step2Next = document.getElementById('step-2-next');
            const step3Save = document.getElementById('step-3-save');
            
            if (step1Next) step1Next.disabled = !stepValidation[1];
            if (step2Next) step2Next.disabled = !stepValidation[2];
            if (step3Save) step3Save.disabled = !stepValidation[3];
        }
        
        validateStep1() {
            const requiredFields = ['pc-number', 'pc-company-name', 'pc-project-name'];
            return requiredFields.every(fieldId => {
                const input = document.getElementById(fieldId);
                return input && input.value.trim() && this.validateField(input);
            });
        }
        
        validateStep2() {
            const requiredFields = ['pc-account-manager', 'pc-client-industry', 'pc-client-source'];
            return requiredFields.every(fieldId => {
                const input = document.getElementById(fieldId);
                return input && input.value.trim();
            });
        }
        
        validateStep3() {
            const contactName = document.getElementById('pc-contact-name').value.trim();
            const phone = document.getElementById('pc-contact-phone').value.trim();
            const email = document.getElementById('pc-contact-email').value.trim();
            
            // Contact name is required, and either phone OR email
            return contactName && (phone || email);
        }
        
        nextStep() {
            if (this.currentStep < this.totalSteps && this.stepValidation[this.currentStep]) {
                this.goToStep(this.currentStep + 1);
            }
        }
        
        prevStep() {
            if (this.currentStep > 1) {
                this.goToStep(this.currentStep - 1);
            }
        }
        
        goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > this.totalSteps) return;
            
            // Hide current step
            document.querySelector(`#step-${this.currentStep}`).classList.remove('active');
            document.querySelector(`#step-${this.currentStep}-indicator`).classList.remove('active');
            
            // Mark completed steps
            if (stepNumber > this.currentStep) {
                document.querySelector(`#step-${this.currentStep}-indicator`).classList.add('completed');
            } else {
                // Remove completed state when going backwards
                for (let i = stepNumber; i <= this.totalSteps; i++) {
                    document.querySelector(`#step-${i}-indicator`).classList.remove('completed');
                }
            }
            
            // Show new step
            document.querySelector(`#step-${stepNumber}`).classList.add('active');
            document.querySelector(`#step-${stepNumber}-indicator`).classList.add('active');
            
            // Update progress bar
            const progress = (stepNumber / this.totalSteps) * 100;
            document.getElementById('wizard-progress-bar').style.width = `${progress}%`;
            
            this.currentStep = stepNumber;
            
            // Auto-save when moving between steps
            this.saveDraft();
            
            // Focus first input in new step
            const firstInput = document.querySelector(`#step-${stepNumber} .wizard-field-input`);
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 300);
            }
        }
        
        setupAutoSave() {
            const inputs = document.querySelectorAll('.wizard-field-input');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(this.draftSaveTimeout);
                    this.draftSaveTimeout = setTimeout(() => {
                        this.saveDraft();
                    }, 2000);
                });
            });
        }
        
        saveDraft() {
            const formData = this.collectFormData();
            localStorage.setItem('pc-wizard-draft', JSON.stringify({
                data: formData,
                step: this.currentStep,
                timestamp: new Date().toISOString()
            }));
            
            // Show draft saved indicator
            const draftStatus = document.getElementById('draft-status');
            if (draftStatus) {
                draftStatus.className = 'draft-indicator saved';
                draftStatus.textContent = 'âœ“ Draft saved';
                draftStatus.hidden = false;
                
                setTimeout(() => {
                    draftStatus.hidden = true;
                }, 2000);
            }
        }
        
        restoreDraft() {
            const draftData = localStorage.getItem('pc-wizard-draft');
            if (draftData) {
                try {
                    const draft = JSON.parse(draftData);
                    
                    // Check if draft is recent (within 24 hours)
                    const draftAge = Date.now() - new Date(draft.timestamp).getTime();
                    if (draftAge < 24 * 60 * 60 * 1000) {
                        
                        // Show restore option
                        toastManager.show({
                            type: 'info',
                            title: 'Draft Found',
                            message: 'We found a saved draft from your previous session.',
                            actions: [
                                { 
                                    label: 'Restore Draft', 
                                    style: 'primary', 
                                    onclick: `pcWizard.loadDraft('${draftData}')` 
                                },
                                { 
                                    label: 'Start Fresh', 
                                    style: '', 
                                    onclick: `localStorage.removeItem('pc-wizard-draft')` 
                                }
                            ],
                            duration: 8000
                        });
                    }
                } catch (error) {
                    console.error('Error restoring draft:', error);
                }
            }
        }
        
        loadDraft(draftData) {
            try {
                const draft = JSON.parse(draftData);
                
                // Populate form fields
                Object.entries(draft.data).forEach(([fieldId, value]) => {
                    const input = document.getElementById(fieldId);
                    if (input) {
                        input.value = value;
                        // Trigger validation
                        this.validateField(input);
                    }
                });
                
                // Go to saved step
                this.goToStep(draft.step);
                this.updateStepValidation();
                
                toastManager.show({
                    type: 'success',
                    message: 'Draft restored successfully',
                    duration: 3000
                });
                
            } catch (error) {
                toastManager.show({
                    type: 'error',
                    message: 'Failed to restore draft',
                    duration: 3000
                });
            }
        }
        
        collectFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('.wizard-field-input');
            
            inputs.forEach(input => {
                if (input.type !== 'hidden') {
                    formData[input.id] = input.value;
                }
            });
            
            return formData;
        }
        
        cancel() {
            // Clear draft
            localStorage.removeItem('pc-wizard-draft');
            
            // Reset form
            this.resetWizard();
            
            // Navigate back
            window.showPage('pcnumbers');
        }
        
        resetWizard() {
            // Reset to step 1
            this.goToStep(1);
            
            // Clear all form fields
            const inputs = document.querySelectorAll('.wizard-field-input');
            inputs.forEach(input => {
                input.value = '';
                this.clearFieldState(input);
            });
            
            // Reset validation states
            this.stepValidation = { 1: false, 2: false, 3: false };
            this.updateStepValidation();
        }
        
        async savePC() {
            try {
                // Show loading on save button
                const saveButton = document.getElementById('step-3-save');
                loadingManager.setButtonLoading(saveButton, true);
                
                // Collect and validate all form data
                const formData = this.collectFormData();
                
                // Final validation
                if (!this.validateStep1() || !this.validateStep2() || !this.validateStep3()) {
                    throw new Error('Please complete all required fields');
                }
                
                // Create PC object (using existing savePC logic)
                const pcData = {
                    pc_number: formData['pc-number'],
                    company_name: formData['pc-company-name'],
                    project_name: formData['pc-project-name'],
                    account_manager: formData['pc-account-manager'],
                    client_industry: formData['pc-client-industry'],
                    client_source: formData['pc-client-source'],
                    quote_limit: parseInt(formData['pc-quote-limit']) || 5,
                    status: formData['pc-status'] || 'active',
                    project_description: formData['pc-project-description'],
                    contact_name: formData['pc-contact-name'],
                    contact_phone: formData['pc-contact-phone'],
                    contact_email: formData['pc-contact-email'],
                    postcode: formData['pc-postcode']
                };
                
                // Save using existing logic
                await window.savePC();
                
                // Clear draft on successful save
                localStorage.removeItem('pc-wizard-draft');
                
                // Show success and navigate
                toastManager.show({
                    type: 'success',
                    title: 'PC Number Created',
                    message: `${pcData.pc_number} has been created successfully.`,
                    actions: [
                        { 
                            label: 'Create Quote', 
                            style: 'primary', 
                            onclick: `window.createQuote('${pcData.pc_number}')` 
                        }
                    ],
                    duration: 6000
                });
                
            } catch (error) {
                toastManager.showError('pc-save', error);
            } finally {
                const saveButton = document.getElementById('step-3-save');
                loadingManager.setButtonLoading(saveButton, false);
            }
        }
    }
    
    // Global wizard instance
    const pcWizard = new FormWizardManager();
    
    // Global functions for wizard navigation
    window.nextWizardStep = () => pcWizard.nextStep();
    window.prevWizardStep = () => pcWizard.prevStep();
    window.cancelWizard = () => pcWizard.cancel();
    window.saveWizardPC = () => pcWizard.savePC();
    window.saveDraft = () => pcWizard.saveDraft();
    
    console.log('âœ… Progressive form wizard initialized');
    console.log('ðŸ“ 3-step PC Number creation with live validation, auto-save, and draft restoration');
    
    // ========================================
    // GLOBAL SEARCH SYSTEM
    // ========================================
    
    // Global Search Manager
    class GlobalSearchManager {
        constructor() {
            this.searchIndex = new Map();
            this.recentSearches = JSON.parse(localStorage.getItem('globalSearchHistory') || '[]');
            this.maxRecentSearches = 5;
            this.currentQuery = '';
            this.isOpen = false;
            this.initializeSearch();
        }
        
        initializeSearch() {
            this.setupEventListeners();
            this.buildSearchIndex();
            this.showRecentSearches();
        }
        
        setupEventListeners() {
            const searchInput = document.getElementById('global-search-input');
            const searchResults = document.getElementById('search-results');
            const searchClear = document.getElementById('search-clear');
            
            if (!searchInput) return;
            
            let searchTimeout;
            
            // Input handling with debouncing
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                this.currentQuery = query;
                
                // Show/hide clear button
                searchClear.hidden = !query;
                
                if (!query) {
                    this.showRecentSearches();
                } else if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        this.performSearch(query);
                    }, 300);
                }
            });
            
            // Focus handling
            searchInput.addEventListener('focus', () => {
                this.openSearch();
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeSearch();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    this.performSearch(this.currentQuery);
                } else if (['ArrowDown', 'ArrowUp'].includes(e.key)) {
                    e.preventDefault();
                    this.handleArrowNavigation(e.key);
                }
            });
            
            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!searchInput.closest('.global-search').contains(e.target)) {
                    this.closeSearch();
                }
            });
            
            // Clear search
            searchClear.addEventListener('click', () => {
                this.clearSearch();
            });
        }
        
        openSearch() {
            if (this.isOpen) return;
            
            this.isOpen = true;
            const searchResults = document.getElementById('search-results');
            const searchInput = document.getElementById('global-search-input');
            
            searchResults.hidden = false;
            searchInput.setAttribute('aria-expanded', 'true');
            
            if (!this.currentQuery) {
                this.showRecentSearches();
            }
        }
        
        closeSearch() {
            if (!this.isOpen) return;
            
            this.isOpen = false;
            const searchResults = document.getElementById('search-results');
            const searchInput = document.getElementById('global-search-input');
            
            searchResults.hidden = true;
            searchInput.setAttribute('aria-expanded', 'false');
        }
        
        clearSearch() {
            const searchInput = document.getElementById('global-search-input');
            const searchClear = document.getElementById('search-clear');
            
            searchInput.value = '';
            this.currentQuery = '';
            searchClear.hidden = true;
            
            this.showRecentSearches();
            searchInput.focus();
        }
        
        buildSearchIndex() {
            this.searchIndex.clear();
            
            // Index PC Numbers
            if (db.pcs) {
                db.pcs.forEach(pc => {
                    this.indexItem('pc', pc.id, {
                        title: pc.pc_number,
                        subtitle: pc.company_name,
                        description: `${pc.project_name} â€¢ ${pc.status}`,
                        content: `${pc.project_name} ${pc.account_manager} ${pc.client_industry} ${pc.contact_name}`,
                        data: pc,
                        icon: 'ðŸ“‹'
                    });
                });
            }
            
            // Index Quotes
            if (db.quotes) {
                db.quotes.forEach(quote => {
                    const pc = db.pcs?.find(p => p.id === quote.pc_id);
                    const value = quote.total_inc_vat ? `Â£${quote.total_inc_vat.toLocaleString()}` : 'No value';
                    
                    this.indexItem('quote', quote.id, {
                        title: `Quote ${quote.quote_number || 'Draft'}`,
                        subtitle: pc?.company_name || 'Unknown Company',
                        description: `${value} â€¢ ${quote.status || 'draft'}`,
                        content: `${quote.title} ${quote.description} ${pc?.pc_number} ${pc?.project_name}`,
                        data: quote,
                        icon: 'ðŸ’°'
                    });
                });
            }
            
            // Index Activities
            if (db.activities) {
                db.activities.forEach(activity => {
                    const pc = db.pcs?.find(p => p.id === activity.pc_id);
                    const date = activity.start_date ? new Date(activity.start_date).toLocaleDateString() : 'No date';
                    
                    this.indexItem('activity', activity.id, {
                        title: activity.title,
                        subtitle: `${pc?.pc_number || 'No PC'} â€¢ ${activity.type}`,
                        description: `${date} â€¢ ${activity.status}`,
                        content: `${activity.description} ${activity.notes} ${pc?.company_name} ${activity.team_member}`,
                        data: activity,
                        icon: 'ðŸ“…'
                    });
                });
            }
            
            // Index Resources
            if (db.resources) {
                db.resources.forEach(resource => {
                    const rate = resource.daily_rate ? `Â£${resource.daily_rate}/day` : 'No rate';
                    
                    this.indexItem('resource', resource.id, {
                        title: resource.name,
                        subtitle: resource.category,
                        description: `${rate} â€¢ ${resource.status}`,
                        content: `${resource.description} ${resource.location} ${resource.specifications}`,
                        data: resource,
                        icon: 'ðŸ› ï¸'
                    });
                });
            }
        }
        
        indexItem(type, id, item) {
            const searchableText = `${item.title} ${item.subtitle} ${item.content}`.toLowerCase();
            this.searchIndex.set(`${type}-${id}`, {
                type,
                id,
                searchableText,
                ...item
            });
        }
        
        performSearch(query) {
            if (!query || query.length < 2) {
                this.showRecentSearches();
                return;
            }
            
            this.showLoading();
            
            // Simulate search delay for better UX
            setTimeout(() => {
                const results = this.searchItems(query);
                this.displayResults(results, query);
                this.addToRecentSearches(query);
            }, 150);
        }
        
        searchItems(query) {
            const normalizedQuery = query.toLowerCase();
            const results = new Map();
            
            // Search through index
            this.searchIndex.forEach((item, key) => {
                if (item.searchableText.includes(normalizedQuery)) {
                    if (!results.has(item.type)) {
                        results.set(item.type, []);
                    }
                    
                    // Calculate relevance score
                    const relevance = this.calculateRelevance(item, normalizedQuery);
                    results.get(item.type).push({ ...item, relevance });
                }
            });
            
            // Sort results by relevance within each category
            results.forEach((items, type) => {
                items.sort((a, b) => b.relevance - a.relevance);
            });
            
            return results;
        }
        
        calculateRelevance(item, query) {
            let score = 0;
            const title = item.title.toLowerCase();
            const subtitle = item.subtitle.toLowerCase();
            
            // Exact title match gets highest score
            if (title === query) score += 100;
            else if (title.startsWith(query)) score += 50;
            else if (title.includes(query)) score += 25;
            
            // Subtitle matches
            if (subtitle.includes(query)) score += 15;
            
            // Word boundary matches
            const words = query.split(' ');
            words.forEach(word => {
                if (word.length > 2) {
                    const regex = new RegExp(`\\b${word}`, 'gi');
                    const titleMatches = title.match(regex);
                    if (titleMatches) score += titleMatches.length * 10;
                    
                    const contentMatches = item.searchableText.match(regex);
                    if (contentMatches) score += contentMatches.length * 2;
                }
            });
            
            return score;
        }
        
        showLoading() {
            const container = document.getElementById('search-results-container');
            const recentSection = document.getElementById('recent-section');
            const tipsSection = document.getElementById('tips-section');
            const emptySection = document.getElementById('search-empty');
            
            // Hide other sections
            recentSection.hidden = true;
            tipsSection.hidden = true;
            emptySection.hidden = true;
            container.hidden = false;
            
            container.innerHTML = `
                <div class="search-loading">
                    <div class="search-loading-dots">
                        <div class="search-loading-dot"></div>
                        <div class="search-loading-dot"></div>
                        <div class="search-loading-dot"></div>
                    </div>
                    Searching...
                </div>
            `;
        }
        
        displayResults(results, query) {
            const container = document.getElementById('search-results-container');
            const recentSection = document.getElementById('recent-section');
            const tipsSection = document.getElementById('tips-section');
            const emptySection = document.getElementById('search-empty');
            
            // Hide loading and other sections
            recentSection.hidden = true;
            tipsSection.hidden = true;
            container.hidden = false;
            
            if (results.size === 0) {
                this.showNoResults(query);
                return;
            }
            
            emptySection.hidden = true;
            
            const typeLabels = {
                pc: 'PC Numbers',
                quote: 'Quotes',
                activity: 'Activities',
                resource: 'Resources'
            };
            
            container.innerHTML = Array.from(results.entries()).map(([type, items]) => `
                <div class="search-category">
                    <div class="search-category-title">
                        <span>${typeLabels[type]}</span>
                        <span class="search-category-count">${items.length}</span>
                    </div>
                    <ul class="search-items">
                        ${items.slice(0, 5).map(item => `
                            <li class="search-item" 
                                role="option" 
                                tabindex="0"
                                onclick="selectSearchResult('${type}', '${item.id}')"
                                onkeydown="handleSearchItemKeydown(event, '${type}', '${item.id}')">
                                <div class="search-item-icon">
                                    ${item.icon}
                                </div>
                                <div class="search-item-content">
                                    <div class="search-item-title">${this.highlightQuery(item.title, query)}</div>
                                    <div class="search-item-subtitle">${this.highlightQuery(item.subtitle, query)}</div>
                                    <div class="search-item-description">${item.description}</div>
                                </div>
                                <div class="search-item-meta">
                                    ${typeLabels[type]}
                                </div>
                            </li>
                        `).join('')}
                        ${items.length > 5 ? `
                            <li class="search-item" onclick="showAllResults('${type}', '${query}')">
                                <div class="search-item-content">
                                    <div class="search-item-title">View all ${items.length} ${typeLabels[type]}</div>
                                </div>
                            </li>
                        ` : ''}
                    </ul>
                </div>
            `).join('');
        }
        
        showNoResults(query) {
            const container = document.getElementById('search-results-container');
            const emptySection = document.getElementById('search-empty');
            const emptyMessage = document.getElementById('empty-message');
            
            container.hidden = true;
            emptySection.hidden = false;
            emptyMessage.textContent = `No results found for "${query}"`;
        }
        
        highlightQuery(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
        showRecentSearches() {
            const container = document.getElementById('search-results-container');
            const recentSection = document.getElementById('recent-section');
            const tipsSection = document.getElementById('tips-section');
            const emptySection = document.getElementById('search-empty');
            const recentList = document.getElementById('recent-searches-list');
            
            // Show initial sections
            container.hidden = true;
            emptySection.hidden = true;
            recentSection.hidden = false;
            tipsSection.hidden = false;
            
            if (this.recentSearches.length === 0) {
                recentSection.hidden = true;
            } else {
                recentList.innerHTML = this.recentSearches.map(search => `
                    <li class="recent-search-item" 
                        role="option"
                        tabindex="0"
                        onclick="performSearchFromRecent('${search}')"
                        onkeydown="handleRecentSearchKeydown(event, '${search}')">
                        <span class="recent-search-icon">ðŸ”</span>
                        ${search}
                    </li>
                `).join('');
            }
        }
        
        addToRecentSearches(query) {
            // Remove if already exists
            this.recentSearches = this.recentSearches.filter(s => s !== query);
            
            // Add to beginning
            this.recentSearches.unshift(query);
            
            // Limit to max
            this.recentSearches = this.recentSearches.slice(0, this.maxRecentSearches);
            
            // Save to localStorage
            localStorage.setItem('globalSearchHistory', JSON.stringify(this.recentSearches));
        }
        
        handleArrowNavigation(direction) {
            const items = document.querySelectorAll('.search-item[tabindex="0"], .recent-search-item[tabindex="0"]');
            const currentIndex = Array.from(items).findIndex(item => item === document.activeElement);
            
            let nextIndex;
            if (direction === 'ArrowDown') {
                nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
            } else {
                nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
            }
            
            if (items[nextIndex]) {
                items[nextIndex].focus();
            }
        }
    }
    
    // Global search instance
    const globalSearch = new GlobalSearchManager();
    
    // Global functions for search interaction
    window.performGlobalSearch = () => {
        const query = document.getElementById('global-search-input').value.trim();
        if (query) {
            globalSearch.performSearch(query);
        }
    };
    
    window.clearGlobalSearch = () => {
        globalSearch.clearSearch();
    };
    
    window.selectSearchResult = (type, id) => {
        const actions = {
            pc: () => {
                globalSearch.closeSearch();
                showPage('pcnumbers');
                setTimeout(() => viewPC(id), 100);
            },
            quote: () => {
                globalSearch.closeSearch();
                showPage('quotes');
                setTimeout(() => viewQuote(id), 100);
            },
            activity: () => {
                globalSearch.closeSearch();
                showPage('activities');
                setTimeout(() => viewActivity(id), 100);
            },
            resource: () => {
                globalSearch.closeSearch();
                showPage('resources');
                setTimeout(() => viewResource(id), 100);
            }
        };
        
        if (actions[type]) {
            actions[type]();
        }
    };
    
    window.performSearchFromRecent = (query) => {
        const searchInput = document.getElementById('global-search-input');
        searchInput.value = query;
        globalSearch.currentQuery = query;
        globalSearch.performSearch(query);
    };
    
    window.handleSearchItemKeydown = (event, type, id) => {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            selectSearchResult(type, id);
        }
    };
    
    window.handleRecentSearchKeydown = (event, query) => {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            performSearchFromRecent(query);
        }
    };
    
    // Rebuild search index when data changes
    CRM.EventBus.on('data:fully-loaded', () => {
        globalSearch.buildSearchIndex();
    });
    
    // Update search index on entity changes
    ['pc:created', 'pc:updated', 'quote:created', 'quote:updated', 'activity:created', 'activity:updated', 'resource:created', 'resource:updated'].forEach(event => {
        CRM.EventBus.on(event, () => {
            // Debounced rebuild
            clearTimeout(globalSearch.rebuildTimeout);
            globalSearch.rebuildTimeout = setTimeout(() => {
                globalSearch.buildSearchIndex();
            }, 500);
        });
    });
    
    console.log('âœ… Global search system initialized');
    console.log('ðŸ” Search across PC Numbers, Quotes, Activities, and Resources with real-time results');
    
    // ========================================
    // ACCESSIBILITY & MOBILE UX ENHANCEMENTS
    // ========================================
    
    // Mobile Navigation Toggle
    function initializeMobileNavigation() {
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('main-navigation');
        
        // Initialize navigation accessibility state
        if (navMenu) {
            // For desktop, navigation should always be accessible
            navMenu.removeAttribute('inert');
            
            // Force remove inert if we're currently on desktop
            if (window.innerWidth >= 768) {
                navMenu.removeAttribute('inert');
            }
            
            // Reset navigation state on window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    // Desktop mode - ensure navigation is accessible
                    navMenu.removeAttribute('inert');
                    navMenu.classList.remove('active');
                    if (mobileToggle) {
                        mobileToggle.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        }
        
        if (mobileToggle && navMenu) {
            mobileToggle.addEventListener('click', () => {
                const isExpanded = mobileToggle.getAttribute('aria-expanded') === 'true';
                const newState = !isExpanded;
                
                mobileToggle.setAttribute('aria-expanded', newState);
                
                if (newState) {
                    navMenu.classList.add('active');
                    navMenu.removeAttribute('inert');
                    // Focus first menu item
                    const firstMenuItem = navMenu.querySelector('.nav-btn');
                    if (firstMenuItem) {
                        setTimeout(() => firstMenuItem.focus(), 100);
                    }
                } else {
                    navMenu.classList.remove('active');
                    // Only set inert on mobile devices
                    if (window.innerWidth < 768) {
                        navMenu.setAttribute('inert', '');
                    }
                }
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileToggle.contains(e.target) && !navMenu.contains(e.target)) {
                    mobileToggle.setAttribute('aria-expanded', 'false');
                    navMenu.classList.remove('active');
                    // Only set inert on mobile devices
                    if (window.innerWidth < 768) {
                        navMenu.setAttribute('inert', '');
                    }
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && navMenu.classList.contains('active')) {
                    mobileToggle.setAttribute('aria-expanded', 'false');
                    navMenu.classList.remove('active');
                    // Only set inert on mobile devices
                    if (window.innerWidth < 768) {
                        navMenu.setAttribute('inert', '');
                    }
                    mobileToggle.focus();
                }
            });
        }
    }
    
    // Enhanced Navigation with ARIA states
    function updateNavigationState(activePageId) {
        const navButtons = document.querySelectorAll('.nav-btn');
        navButtons.forEach(btn => {
            const isActive = btn.onclick && btn.onclick.toString().includes(activePageId);
            btn.setAttribute('aria-pressed', isActive);
            if (isActive) {
                btn.classList.add('active');
                btn.setAttribute('aria-current', 'page');
            } else {
                btn.classList.remove('active');
                btn.removeAttribute('aria-current');
            }
        });
    }
    
    // Enhanced showPage function with accessibility
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        // Call original function
        originalShowPage(pageId);
        
        // Update ARIA states (hierarchical navigation)
        updateHierarchicalNavigationState(pageId);
        
        // Update document title for screen readers
        const pageTitles = {
            'dashboard': 'Dashboard - CRM Demo',
            'pcnumbers': 'PC Numbers - CRM Demo',
            'quotes': 'Quotes - CRM Demo',
            'templates': 'Quote Templates - CRM Demo',
            'activities': 'Activities - CRM Demo',
            'activity-templates': 'Activity Templates - CRM Demo',
            'resources': 'Resources - CRM Demo',
            'resource-allocation': 'Resource Allocation - CRM Demo',
            'analytics': 'Analytics - CRM Demo',
            'pricelists': 'Price Lists - CRM Demo'
        };
        
        document.title = pageTitles[pageId] || 'CRM Demo';
        
        // Announce page change to screen readers
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.focus();
            
            // Create announcement for screen readers
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = `Navigated to ${pageTitles[pageId] || pageId} page`;
            document.body.appendChild(announcement);
            
            // Remove announcement after it's been read
            setTimeout(() => {
                if (announcement.parentNode) {
                    announcement.parentNode.removeChild(announcement);
                }
            }, 1000);
        }
        
        // Close mobile menu if open
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('main-navigation');
        if (mobileToggle && navMenu && navMenu.classList.contains('active')) {
            mobileToggle.setAttribute('aria-expanded', 'false');
            navMenu.classList.remove('active');
            // Only set inert on mobile devices
            if (window.innerWidth < 768) {
                navMenu.setAttribute('inert', '');
            }
        }
    };
    
    // Keyboard Navigation Enhancement
    function initializeKeyboardNavigation() {
        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Skip if user is typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            // Alt + number for page navigation
            if (e.altKey && e.key >= '1' && e.key <= '9') {
                e.preventDefault();
                const pageMap = {
                    '1': 'dashboard',
                    '2': 'pcnumbers', 
                    '3': 'quotes',
                    '4': 'activities',
                    '5': 'resources',
                    '6': 'analytics'
                };
                const pageId = pageMap[e.key];
                if (pageId) {
                    showPage(pageId);
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    const closeButton = activeModal.querySelector('.close, [onclick*="close"]');
                    if (closeButton) {
                        closeButton.click();
                    }
                }
            }
            
            // Tab navigation improvements
            if (e.key === 'Tab') {
                // Ensure focus stays within modals
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    const focusableElements = activeModal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];
                    
                    if (e.shiftKey && document.activeElement === firstElement) {
                        e.preventDefault();
                        lastElement.focus();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        e.preventDefault();
                        firstElement.focus();
                    }
                }
            }
        });
        
        // Improve form navigation
        const forms = document.querySelectorAll('form, .form-like');
        forms.forEach(form => {
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && input.type !== 'textarea') {
                        e.preventDefault();
                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            // Focus submit button if it exists
                            const submitBtn = form.querySelector('button[type="submit"], button[onclick*="save"]');
                            if (submitBtn) {
                                submitBtn.focus();
                            }
                        }
                    }
                });
            });
        });
    }
    
    // Initialize accessibility features
    initializeMobileNavigation();
    initializeKeyboardNavigation();
    
    console.log('âœ… Accessibility and mobile navigation initialized');
    console.log('ðŸ“± Mobile menu: Tap hamburger button');
    console.log('âŒ¨ï¸ Keyboard shortcuts: Alt+1-6 for page navigation, Tab for form navigation, Esc to close modals');

    // Enhanced initialization with loading states
    async function initializeApplicationWithProgress() {
        try {
            // Show loading overlay
            loadingManager.show('app-init', 'Initializing CRM System', 'Setting up database connection...');
            
            // Initialize database
            await initializeIndexedDB();
            loadingManager.updateProgress('app-init', 15, 'Database ready, loading data...');
            
            // Load core data
            console.log('âœ… IndexedDB initialized, loading data...');
            await loadDataFromIndexedDB();
            loadingManager.updateProgress('app-init', 35, 'Data loaded, initializing team management...');
            
            // Initialize systems progressively
            console.log('âœ… Data loaded, loading team members and initializing systems...');
            loadTeamMembersFromStorage();
            loadingManager.updateProgress('app-init', 45, 'Initializing team management...');
            
            initializeTeamManagement();
            loadingManager.updateProgress('app-init', 55, 'Setting up notifications...');
            
            initializeNotificationSystem();
            loadingManager.updateProgress('app-init', 65, 'Configuring resource allocation...');
            
            initializeResourceAllocationSystem();
            loadingManager.updateProgress('app-init', 75, 'Setting up workflow system...');
            
            initializeWorkflowSystem();
            loadingManager.updateProgress('app-init', 85, 'Initializing analytics...');
            
            initializeAnalyticsSystem();
            loadingManager.updateProgress('app-init', 95, 'Finalizing dashboard...');
            
            console.log('âœ… All systems initialized, showing dashboard...');
            console.log('ðŸ“Š Current db state:', {
                pcs: db.pcs?.length || 0,
                quotes: db.quotes?.length || 0,
                activities: db.activities?.length || 0,
                resources: db.resources?.length || 0,
                priceLists: db.priceLists?.length || 0,
                templates: db.templates?.length || 0,
                activityTemplates: db.activityTemplates?.length || 0
            });
            
            loadingManager.updateProgress('app-init', 100, 'Ready!');
            
            // Small delay to show completion
            await new Promise(resolve => setTimeout(resolve, 500));
            
            showPage('dashboard');
            loadingManager.hide('app-init');
            
            // Show welcome notification
            toastManager.show({
                type: 'success',
                title: 'Welcome to CRM Demo',
                message: 'All systems loaded successfully. You can now manage your projects, quotes, and activities.',
                duration: 4000
            });
            
            console.log('ðŸŽ‰ Application initialization complete with enhanced UX!');

// ========================================
// PHASE 2 STEP 1: Minimal global namespace wrapper
// Creates window.app as single entry-point without removing existing globals yet.
// This allows future migration away from scattered window.* references.
(function() {
    'use strict';
    window.app = {
        showPage:         window.showPage,
        toggleDropdown:   window.toggleDropdown,
        addLineItem:      window.addLineItem,
        updateLineQty:    window.updateLineQty,
        removeLine:       window.removeLine,
        savePC:           window.savePC,
        saveQuote:        window.saveQuote,
        saveResource:     window.saveResource,
        saveActivity:     window.saveActivity
    };
})();
            
        } catch (error) {
            loadingManager.hide('app-init');
            console.error('âŒ Failed to initialize application:', error);
            console.error('âŒ Error details:', error.stack);
            
            // Show enhanced error with recovery options
            toastManager.showError('data-load', error, {
                title: 'Failed to Initialize Application',
                persistent: true
            });
        }
    }
    
    // Enhanced save operations with loading states
    function enhanceSaveOperations() {
        // Enhanced PC saving
        const originalSavePC = window.savePC;
        window.savePC = async function() {
            const saveButton = document.querySelector('button[onclick*="savePC"]');
            if (saveButton) {
                loadingManager.setButtonLoading(saveButton, true);
            }
            
            try {
                await originalSavePC();
                
                toastManager.show({
                    type: 'success',
                    title: 'PC Number Saved',
                    message: 'Your PC Number has been saved successfully.',
                    duration: 3000
                });
                
            } catch (error) {
                toastManager.showError('pc-save', error);
            } finally {
                if (saveButton) {
                    loadingManager.setButtonLoading(saveButton, false);
                }
            }
        };
        
        // Enhanced quote calculation
        const originalCalculateTotal = window.calculateTotal;
        window.calculateTotal = function() {
            try {
                originalCalculateTotal();
            } catch (error) {
                toastManager.showError('quote-calculate', error);
            }
        };
    }
    
    // Initialize enhanced operations
    enhanceSaveOperations();
    
    // CRITICAL FIX: Initialize dropdown navigation after DOM is loaded
    const dropdownNavigation = new DropdownNavigationManager();
    
    // Global function for dropdown toggles
    window.toggleDropdown = function(dropdownId) {
        dropdownNavigation.toggleDropdown(dropdownId);
    };
    
    console.log('âœ… Dropdown navigation initialized');
    
    // Start application initialization with progress
    console.log('ðŸš€ Starting enhanced application initialization...');
    initializeApplicationWithProgress();
});

</script>

</body>
</html>